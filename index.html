<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩÔ∏è Analizador de Probabilidades de Goles (JSON) - B√∫squeda Parcial</title>
    <style>
        /* (CSS Styles remain the same) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #eef2f7; }
        .container { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input[type="text"], input[type="file"], button { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; 
            border: 1px solid #dcdfe6; box-sizing: border-box; font-size: 16px;
        }
        input[type="file"] { background-color: #f7f9fb; }
        button { 
            background-color: #007bff; /* Azul primario */
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        .result-box { 
            margin-top: 25px; padding: 20px; border: 3px solid #333; 
            border-radius: 8px; background-color: #fff;
        }
        .analysis { 
            background: #fff8e1; /* Amarillo claro */
            padding: 15px; border-left: 5px solid #ffc107; /* Amarillo oscuro */
            margin-top: 20px; border-radius: 4px;
        }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        p strong { color: #333; }
    </style>
</head>
<body>

    <div class="container">
        <h2>‚öΩÔ∏è An√°lisis Predictivo de Goles</h2>

        <label for="jsonFile">**1. Cargar Historial de Partidos (JSON):**</label>
        <input type="file" id="jsonFile" accept=".json">
        <p style="font-size: 0.9em; color: #6c757d; margin-top: -5px;">El JSON debe ser un array de objetos con las claves: `local`, `visitante`, `golesLocal`, `golesVisitante`.</p>

        <hr>

        <label for="localTeam">**2. Equipo Local:**</label>
        <input type="text" id="localTeam" placeholder="Ej: Poner 'Madrid' buscar√° 'Real Madrid'">

        <label for="visitorTeam">**3. Equipo Visitante:**</label>
        <input type="text" id="visitorTeam" placeholder="Ej: Poner 'Barca' buscar√° 'Barcelona'">

        <button onclick="analyzeData()">Analizar Probabilidades</button>

        <hr>

        <div id="results" class="result-box" style="display: none;">
            <h3>üìä Resultados del An√°lisis</h3>
            <p><strong>Probabilidad de M√°s de 2.5 Goles:</strong> <span id="prob25"></span></p>
            <p><strong>Probabilidad de Ambos Anotan (BTTS):</strong> <span id="probBTTS"></span></p>

            <div class="analysis">
                <h4>üß† Deducci√≥n y An√°lisis Personalizado:</h4>
                <p id="personalAnalysis"></p>
            </div>
        </div>

    </div>

    <script>
        // --- L√≥gica JavaScript CORREGIDA con Coincidencia Parcial ---
        
        let matchHistory = [];

        function cleanAndMapData(data) {
            return data.map(match => ({
                local: match.local ? match.local.trim() : '',
                visitante: match.visitante ? match.visitante.trim() : '',
                golesLocal: parseInt(match.golesLocal) || 0,
                golesVisitante: parseInt(match.golesVisitante) || 0,
            }));
        }

        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const rawData = JSON.parse(e.target.result);
                        matchHistory = cleanAndMapData(rawData);
                        
                        console.log("Datos cargados correctamente:", matchHistory.length, "partidos.");
                        if (matchHistory.length === 0) {
                             alert("‚ö†Ô∏è Archivo JSON cargado, pero no se encontraron partidos v√°lidos.");
                        } else {
                            alert(`‚úÖ ¬°Archivo cargado! ${matchHistory.length} partidos listos para analizar.`);
                        }
                    } catch (error) {
                        alert("‚ùå Error al parsear el archivo JSON. Aseg√∫rate de que el formato sea un array de objetos v√°lido.");
                        console.error("Error de parseo JSON:", error);
                        matchHistory = []; 
                    }
                };
                reader.readAsText(file);
            }
        });


        function analyzeData() {
            const localTeam = document.getElementById('localTeam').value.trim();
            const visitorTeam = document.getElementById('visitorTeam').value.trim();
            
            console.log(`Analizando: ${localTeam} vs ${visitorTeam}`);

            // 1. Validaciones
            if (!matchHistory.length) {
                alert("Primero debes cargar el archivo JSON con el historial de partidos.");
                return;
            }
            if (!localTeam || !visitorTeam) {
                alert("Por favor, ingresa el nombre del equipo Local y Visitante.");
                return;
            }

            // 2. Filtrar partidos relevantes
            // *** ESTA ES LA SECCI√ìN CORREGIDA ***
            const relevantMatches = matchHistory.filter(match => {
                const teamLocalLC = localTeam.toLowerCase();
                const teamVisitorLC = visitorTeam.toLowerCase();
                const matchLocalLC = match.local.toLowerCase();
                const matchVisitorLC = match.visitante.toLowerCase();

                // Coincidencia para el equipo local (el nombre en el JSON incluye lo ingresado)
                const isLocalMatch = matchLocalLC.includes(teamLocalLC) || matchVisitorLC.includes(teamLocalLC);
                // Coincidencia para el equipo visitante
                const isVisitorMatch = matchLocalLC.includes(teamVisitorLC) || matchVisitorLC.includes(teamVisitorLC);

                return isLocalMatch || isVisitorMatch;
            });
            // *** FIN DE SECCI√ìN CORREGIDA ***

            if (relevantMatches.length === 0) {
                document.getElementById('prob25').textContent = "0%";
                document.getElementById('probBTTS').textContent = "0%";
                document.getElementById('personalAnalysis').innerHTML = "No se encontraron partidos en el historial para los equipos ingresados. **Aseg√∫rate de usar al menos una parte clave del nombre**.";
                document.getElementById('results').style.display = 'block';
                return;
            }
            
            console.log(`Partidos relevantes encontrados: ${relevantMatches.length}`);

            // --- 3. Inicializaci√≥n y Conteo de M√©tricas ---
            let countOver25 = 0;
            let countBTTS = 0;
            let totalMatchesForAnalysis = relevantMatches.length;

            let localScored = 0;
            let visitorScored = 0;
            let localConceded = 0;
            let visitorConceded = 0;
            let totalGoals = 0;

            relevantMatches.forEach(match => {
                const G_local = match.golesLocal; 
                const G_visitor = match.golesVisitante;

                // a) M√°s de 2.5 Goles
                const totalGoles = G_local + G_visitor;
                if (totalGoles > 2.5) {
                    countOver25++;
                }
                totalGoals += totalGoles;

                // b) Ambos Anotan (BTTS: Both Teams To Score)
                if (G_local > 0 && G_visitor > 0) {
                    countBTTS++;
                }

                // c) Conteo de Goles y Concedidos
                
                // Si el partido involucra al equipo LOCAL del an√°lisis
                if (match.local.toLowerCase().includes(localTeam.toLowerCase()) || match.visitante.toLowerCase().includes(localTeam.toLowerCase())) {
                    if (match.local.toLowerCase().includes(localTeam.toLowerCase())) {
                        localScored += G_local;
                        localConceded += G_visitor;
                    } else if (match.visitante.toLowerCase().includes(localTeam.toLowerCase())) {
                        localScored += G_visitor;
                        localConceded += G_local;
                    }
                }

                // Si el partido involucra al equipo VISITANTE del an√°lisis
                if (match.local.toLowerCase().includes(visitorTeam.toLowerCase()) || match.visitante.toLowerCase().includes(visitorTeam.toLowerCase())) {
                    if (match.local.toLowerCase().includes(visitorTeam.toLowerCase())) {
                        visitorScored += G_local;
                        visitorConceded += G_visitor;
                    } else if (match.visitante.toLowerCase().includes(visitorTeam.toLowerCase())) {
                        visitorScored += G_visitor;
                        visitorConceded += G_local;
                    }
                }
            });

            // Calcular promedios e √≠ndices
            const probOver25 = (countOver25 / totalMatchesForAnalysis) * 100;
            const probBTTS = (countBTTS / totalMatchesForAnalysis) * 100;
            
            const avgGoals = (totalGoals / totalMatchesForAnalysis).toFixed(2);
            
            // √çndices de ataque/defensa (goles promedio por partido relevante)
            const localAttackIndex = (localScored / totalMatchesForAnalysis).toFixed(2);
            const visitorAttackIndex = (visitorScored / totalMatchesForAnalysis).toFixed(2);
            const localDefenseIndex = (localConceded / totalMatchesForAnalysis).toFixed(2);
            const visitorDefenseIndex = (visitorConceded / totalMatchesForAnalysis).toFixed(2);


            // --- 4. Mostrar Resultados ---
            document.getElementById('prob25').textContent = `${probOver25.toFixed(2)}% (${countOver25} de ${totalMatchesForAnalysis} partidos)`;
            document.getElementById('probBTTS').textContent = `${probBTTS.toFixed(2)}% (${countBTTS} de ${totalMatchesForAnalysis} partidos)`;
            document.getElementById('results').style.display = 'block';

            // --- 5. An√°lisis Personalizado (Deducci√≥n) ---
            const analysisText = generatePersonalAnalysis(localTeam, visitorTeam, probOver25, probBTTS, avgGoals, localAttackIndex, visitorAttackIndex, localDefenseIndex, visitorDefenseIndex);
            document.getElementById('personalAnalysis').innerHTML = analysisText;
        }

        /**
         * Genera un an√°lisis y deducci√≥n personalizada. (Sin cambios en la l√≥gica de an√°lisis)
         */
        function generatePersonalAnalysis(localTeam, visitorTeam, p25, pBTTS, avgG, laI, vaI, ldI, vdI) {
            let analysis = "";

            analysis += `**üéØ Sobre el Total de Goles (M√°s de 2.5):**<br>`;
            if (p25 >= 70) {
                analysis += `Dado que la probabilidad hist√≥rica de un M√°s de 2.5 es alta (**${p25.toFixed(0)}%**), y el promedio de goles por partido analizado es de **${avgG}**, todo indica que ser√° un partido con un **marcador abultado**.<br><br>`;
            } else if (p25 >= 50) {
                analysis += `La probabilidad de M√°s de 2.5 Goles est√° en un rango moderado (**${p25.toFixed(0)}%**). Es un 50/50, pero el promedio de **${avgG}** goles es prometedor.<br><br>`;
            } else {
                analysis += `La probabilidad de M√°s de 2.5 Goles es baja (**${p25.toFixed(0)}%**). La tendencia es clara al **Menos de 2.5 Goles**, sugiriendo un partido con pocas anotaciones.<br><br>`;
            }

            analysis += `**ü§ù Sobre Ambos Anotan (BTTS):**<br>`;
            if (pBTTS >= 70) {
                analysis += `Una probabilidad tan alta (**${pBTTS.toFixed(0)}%**) de BTTS sugiere que **ambos equipos son muy propensos a marcar**. El historial indica que tanto **${localTeam}** (Ataque: ${laI}) como **${visitorTeam}** (Ataque: ${vaI}) encontrar√°n la red.<br><br>`;
            } else if (pBTTS >= 50) {
                analysis += `La probabilidad moderada de BTTS (**${pBTTS.toFixed(0)}%**) indica que, aunque tienen potencial ofensivo, uno de los dos equipos suele ser efectivo defensivamente. Hay un riesgo de que uno se quede sin marcar.<br><br>`;
            } else {
                analysis += `La baja probabilidad de BTTS (**${pBTTS.toFixed(0)}%**) sugiere que la defensa (${vdI} y ${ldI}) o el portero de al menos un equipo es excepcionalmente s√≥lido. La tendencia es que **solo un equipo (o ninguno) marque**.<br><br>`;
            }

            analysis += `**üí° Deducci√≥n Final del Analista:**<br>`;
            if (p25 >= 60 && pBTTS >= 60) {
                analysis += `**¬°Recomendaci√≥n Ofensiva!** La combinaci√≥n de alta probabilidad en ambas m√©tricas apunta a un **espect√°culo de goles** donde ambos equipos marcar√°n (Ej: 2-1, 2-2, 3-1). **Es el escenario m√°s optimista para goles.**<br>`;
            } else if (p25 < 50 && pBTTS < 50) {
                analysis += `**¬°Recomendaci√≥n Defensiva!** Ambas probabilidades son bajas. Sugiere un partido muy cerrado y t√°ctico. Es muy probable un **Menos de 2.5 Goles** y un resultado apretado (Ej: 1-0 o 1-1).<br>`;
            } else if (p25 >= 60 && pBTTS < 50) {
                analysis += `**¬°Cuidado con la Paliza!** Una alta probabilidad de M√°s de 2.5 y una baja de BTTS es la se√±al cl√°sica de una **goleada unilateral** (Ej: 3-0, 4-0). El equipo superior probablemente dominar√° el marcador.<br>`;
            } else {
                analysis += `**¬°Partido Incierto!** Las probabilidades est√°n divididas, con una m√©trica alta y otra baja. Se necesita considerar la **forma actual** de los equipos y las **motivaciones** (copa, liga) para tomar una decisi√≥n final.<br>`;
            }
            
            return analysis;
        }

    </script>
</body>
</html>

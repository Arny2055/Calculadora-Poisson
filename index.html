<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson Ponderada de Fútbol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilos específicos para la tabla de Poisson */
        .poisson-table th, .poisson-table td {
            padding: 4px;
            text-align: center;
            font-size: 0.75rem; /* Pequeño para móvil */
        }
        .poisson-table th {
            background-color: #1e3a8a; 
            color: white;
            font-weight: 600;
        }
        .poisson-table tbody tr:nth-child(even) {
            background-color: #f7fafc;
        }
        /* Resalta las probabilidades más altas */
        .highlight-cell {
            background-color: #fcd34d !important; /* Amarillo más intenso */
            font-weight: 700;
            color: #333;
        }
        /* Estilo para el contenedor de la tabla en móvil */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800">Calculadora Poisson Ponderada</h1>
            <p class="text-gray-600 mt-2">Análisis de Fuerza de Ataque y Defensa (Basado en datos de fútbol)</p>
        </header>

        <!-- Sección de Entrada de Datos -->
        <section class="bg-blue-50 p-5 rounded-xl mb-8 border border-blue-200">
            <h2 class="text-xl font-bold text-blue-700 mb-4">1. Datos de Partidos (Formato CSV)</h2>
            <p class="text-sm text-gray-700 mb-4">
                **Requerido:** El archivo CSV debe contener las columnas: <code class="font-mono bg-yellow-200 px-1 rounded">HomeTeam</code>, <code class="font-mono bg-yellow-200 px-1 rounded">AwayTeam</code>, <code class="font-mono bg-yellow-200 px-1 rounded">FTHG</code> (Goles Local), y <code class="font-mono bg-yellow-200 px-1 rounded">FTAG</code> (Goles Visitante).
            </p>

            <!-- URL Input -->
            <div class="mb-4">
                <label for="urlInput" class="block text-sm font-medium text-gray-700 mb-1">URL del Archivo CSV (ej. football-data.co.uk):</label>
                <input type="text" id="urlInput" placeholder="https://www.football-data.co.uk/mmz4281/2324/E0.csv" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="text-center text-gray-500 font-semibold my-2">-- O --</div>

            <!-- File Input -->
            <div class="mb-4">
                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Cargar Archivo Local (.csv):</label>
                <input type="file" id="fileInput" accept=".csv" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
            </div>

            <!-- Botón de Carga -->
            <button onclick="handleDataInput()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                Cargar y Procesar Datos
            </button>
            <p id="loadStatus" class="text-sm mt-2 text-center h-4"></p>
        </section>

        <!-- Sección de Predicción (Oculta inicialmente) -->
        <section id="predictionSection" class="hidden bg-yellow-50 p-5 rounded-xl mb-8 border border-yellow-200">
            <h2 class="text-xl font-bold text-yellow-700 mb-4">2. Configuración de Predicción</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="homeTeamSelect" class="block text-sm font-medium text-gray-700 mb-1">Equipo Local (Home Team):</label>
                    <select id="homeTeamSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione Equipo Local</option>
                    </select>
                </div>
                <div>
                    <label for="awayTeamSelect" class="block text-sm font-medium text-gray-700 mb-1">Equipo Visitante (Away Team):</label>
                    <select id="awayTeamSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione Equipo Visitante</option>
                    </select>
                </div>
            </div>

            <button onclick="runCalculations()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                Calcular Predicción Poisson
            </button>
        </section>

        <!-- Sección de Resultados (Oculta inicialmente) -->
        <section id="resultsSection" class="hidden">
            <h2 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">3. Resultados del Modelo</h2>

            <!-- Resumen de Goles Esperados y Fuerzas -->
            <div id="summaryResults" class="bg-gray-50 p-4 rounded-lg mb-6 shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Goles Esperados (Expected Goals - xG)</h3>
                <!-- Contenido dinámico aquí -->
            </div>

            <!-- Matriz de Probabilidades Poisson -->
            <div id="poissonMatrixContainer">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Matriz de Probabilidades Poisson (0-10 Goles)</h3>
                <div class="table-container bg-white rounded-xl shadow-lg border border-gray-200 p-2">
                    <div id="poissonMatrix">
                        <!-- Tabla generada aquí -->
                    </div>
                </div>
            </div>

             <!-- Pronósticos Detallados -->
            <div id="detailedForecast" class="mt-6 p-4 bg-indigo-50 rounded-lg shadow-md border border-indigo-200">
                <h3 class="text-xl font-semibold text-indigo-800 mb-3">Pronósticos Detallados</h3>
                <!-- Contenido dinámico aquí -->
            </div>
        </section>

        <!-- Modal para Mensajes/Errores -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" onclick="closeModal()">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="modalTitle" class="text-xl font-bold mb-3 text-red-600">Error</h3>
                <p id="modalContent" class="text-gray-700 mb-4">Mensaje de error.</p>
                <button onclick="closeModal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        // Variables globales para almacenar los datos y cálculos
        let allMatches = [];
        let teamStrengths = {};
        let leagueAverages = {};
        const MAX_GOALS = 10;
        const HOME_GOALS_COL = 'FTHG';
        const AWAY_GOALS_COL = 'FTAG';
        const HOME_TEAM_COL = 'HomeTeam';
        const AWAY_TEAM_COL = 'AwayTeam';

        /**
         * Muestra un modal de mensaje o error.
         * @param {string} title Título del modal.
         * @param {string} content Contenido del mensaje.
         * @param {string} type Tipo: 'error' o 'info'.
         */
        function showModal(title, content, type = 'error') {
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const button = modal.querySelector('button');

            modalTitle.textContent = title;
            document.getElementById('modalContent').textContent = content;

            if (type === 'error') {
                modalTitle.className = 'text-xl font-bold mb-3 text-red-600';
                button.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150';
            } else {
                modalTitle.className = 'text-xl font-bold mb-3 text-blue-600';
                button.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150';
            }

            modal.classList.remove('hidden');
        }

        /** Cierra el modal de mensaje. */
        function closeModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }

        /**
         * Analiza una cadena CSV y la convierte en un array de objetos de partidos.
         * @param {string} csvText La cadena de texto CSV.
         * @returns {Array} Un array de objetos de partidos.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) throw new Error("Datos CSV insuficientes. Se requiere al menos una cabecera y una fila de datos.");

            // Limpia las cabeceras (quita comillas si las hay)
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

            // Verifica que las columnas requeridas existan
            const requiredCols = [HOME_TEAM_COL, AWAY_TEAM_COL, HOME_GOALS_COL, AWAY_GOALS_COL];
            const missingCols = requiredCols.filter(col => !headers.includes(col));

            if (missingCols.length > 0) {
                throw new Error(`Columnas CSV faltantes: ${missingCols.join(', ')}. Asegúrate de que las cabeceras sean correctas.`);
            }

            const homeTeamIndex = headers.indexOf(HOME_TEAM_COL);
            const awayTeamIndex = headers.indexOf(AWAY_TEAM_COL);
            const fthgIndex = headers.indexOf(HOME_GOALS_COL);
            const ftagIndex = headers.indexOf(AWAY_GOALS_COL);

            const matches = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(',');
                // Ignora líneas incompletas o vacías
                if (currentLine.length < headers.length || lines[i].trim() === '') continue;

                const match = {};
                // Usamos indices seguros, pero envolvemos en un try/catch por si acaso
                try {
                    match[HOME_TEAM_COL] = currentLine[homeTeamIndex].trim().replace(/"/g, '');
                    match[AWAY_TEAM_COL] = currentLine[awayTeamIndex].trim().replace(/"/g, '');
                    match[HOME_GOALS_COL] = parseInt(currentLine[fthgIndex].trim().replace(/"/g, ''), 10);
                    match[AWAY_GOALS_COL] = parseInt(currentLine[ftagIndex].trim().replace(/"/g, ''), 10);
                } catch (e) {
                    console.error("Error parsing match line:", lines[i], e);
                    continue; // Skip malformed line
                }


                if (!isNaN(match[HOME_GOALS_COL]) && !isNaN(match[AWAY_GOALS_COL]) && match[HOME_TEAM_COL] && match[AWAY_TEAM_COL]) {
                    matches.push(match);
                }
            }

            if (matches.length === 0) {
                throw new Error("No se pudieron extraer datos de partidos válidos. Verifica el formato del CSV.");
            }

            return matches;
        }

        /**
         * Maneja la entrada de datos (URL o archivo).
         */
        async function handleDataInput() {
            const url = document.getElementById('urlInput').value.trim();
            const file = document.getElementById('fileInput').files[0];
            const statusElement = document.getElementById('loadStatus');
            statusElement.className = 'text-sm mt-2 text-center text-gray-500 h-4';
            statusElement.textContent = 'Cargando datos...';
            
            try {
                let csvText = '';

                if (url) {
                    // Fetch data from URL
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Error al obtener la URL: ${response.statusText}`);
                    }
                    csvText = await response.text();
                } else if (file) {
                    // Read data from local file
                    csvText = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(new Error('Error al leer el archivo.'));
                        reader.readAsText(file);
                    });
                } else {
                    throw new Error("Por favor, introduce una URL o selecciona un archivo CSV.");
                }

                allMatches = parseCSV(csvText);
                calculateAllStrengths();
                populateTeamDropdowns();

                document.getElementById('predictionSection').classList.remove('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                statusElement.className = 'text-sm mt-2 text-center text-green-600 font-semibold h-4';
                statusElement.textContent = `¡Datos de ${allMatches.length} partidos cargados exitosamente!`;

            } catch (error) {
                statusElement.className = 'text-sm mt-2 text-center text-red-600 font-semibold h-4';
                statusElement.textContent = `Error: ${error.message}`;
                showModal("Error de Carga de Datos", error.message);
                document.getElementById('predictionSection').classList.add('hidden');
            }
        }

        /**
         * Calcula los promedios de la liga (goles en casa y fuera).
         */
        function calculateAverages() {
            let totalMatches = allMatches.length;
            let totalHomeGoals = allMatches.reduce((sum, match) => sum + match[HOME_GOALS_COL], 0);
            let totalAwayGoals = allMatches.reduce((sum, match) => sum + match[AWAY_GOALS_COL], 0);

            leagueAverages = {
                avgHomeGoals: totalHomeGoals / totalMatches,
                avgAwayGoals: totalAwayGoals / totalMatches,
                totalMatches: totalMatches
            };
        }

        /**
         * Calcula las fuerzas de ataque y defensa para todos los equipos.
         */
        function calculateAllStrengths() {
            calculateAverages();
            const teams = [...new Set([...allMatches.map(m => m[HOME_TEAM_COL]), ...allMatches.map(m => m[AWAY_TEAM_COL])])];
            teamStrengths = {};

            teams.forEach(team => {
                let homeMatches = allMatches.filter(m => m[HOME_TEAM_COL] === team);
                let awayMatches = allMatches.filter(m => m[AWAY_TEAM_COL] === team);
                
                let numHome = homeMatches.length;
                let numAway = awayMatches.length;

                // Goles Marcados
                let goalsScoredHome = homeMatches.reduce((sum, m) => sum + m[HOME_GOALS_COL], 0);
                let goalsScoredAway = awayMatches.reduce((sum, m) => sum + m[AWAY_GOALS_COL], 0);
                
                // Goles Concedidos
                let goalsConcededHome = homeMatches.reduce((sum, m) => sum + m[AWAY_GOALS_COL], 0);
                let goalsConcededAway = awayMatches.reduce((sum, m) => sum + m[HOME_GOALS_COL], 0);

                // Promedios de Equipo
                let teamAvgHomeScored = numHome > 0 ? goalsScoredHome / numHome : 0;
                let teamAvgAwayScored = numAway > 0 ? goalsScoredAway / numAway : 0;
                let teamAvgHomeConceded = numHome > 0 ? goalsConcededHome / numHome : 0;
                let teamAvgAwayConceded = numAway > 0 ? goalsConcededAway / numAway : 0;

                // Fuerza de Ataque (Attack Strength - AS)
                // AS Home = (Avg Goles Marcados en Casa) / (Avg Goles Local de Liga)
                let AS_Home = (leagueAverages.avgHomeGoals > 0) ? (teamAvgHomeScored / leagueAverages.avgHomeGoals) : 0;
                // AS Away = (Avg Goles Marcados Fuera) / (Avg Goles Visitante de Liga)
                let AS_Away = (leagueAverages.avgAwayGoals > 0) ? (teamAvgAwayScored / leagueAverages.avgAwayGoals) : 0;

                // Fuerza de Defensa (Defense Strength - DS)
                // DS Home = (Avg Goles Concedidos en Casa) / (Avg Goles Visitante de Liga)
                let DS_Home = (leagueAverages.avgAwayGoals > 0) ? (teamAvgHomeConceded / leagueAverages.avgAwayGoals) : 0;
                // DS Away = (Avg Goles Concedidos Fuera) / (Avg Goles Local de Liga)
                let DS_Away = (leagueAverages.avgHomeGoals > 0) ? (teamAvgAwayConceded / leagueAverages.avgHomeGoals) : 0;

                teamStrengths[team] = {
                    AS_Home: AS_Home,
                    DS_Home: DS_Home,
                    AS_Away: AS_Away,
                    DS_Away: DS_Away
                };
            });
        }

        /**
         * Rellena los dropdowns con los nombres de los equipos.
         */
        function populateTeamDropdowns() {
            const teams = Object.keys(teamStrengths).sort();
            const homeSelect = document.getElementById('homeTeamSelect');
            const awaySelect = document.getElementById('awayTeamSelect');

            // Limpiar opciones previas
            homeSelect.innerHTML = '<option value="">Seleccione Equipo Local</option>';
            awaySelect.innerHTML = '<option value="">Seleccione Equipo Visitante</option>';

            teams.forEach(team => {
                const optionHome = document.createElement('option');
                optionHome.value = team;
                optionHome.textContent = team;
                homeSelect.appendChild(optionHome);

                const optionAway = document.createElement('option');
                optionAway.value = team;
                optionAway.textContent = team;
                awaySelect.appendChild(optionAway);
            });
        }

        /**
         * Calcula los Goles Esperados (Expected Goals - xG).
         * @param {string} homeTeam Equipo local.
         * @param {string} awayTeam Equipo visitante.
         * @returns {object} {xG_Home, xG_Away}
         */
        function calculateExpectedGoals(homeTeam, awayTeam) {
            const homeStrengths = teamStrengths[homeTeam];
            const awayStrengths = teamStrengths[awayTeam];
            const avg = leagueAverages;

            // xG Local = AS_Local (Casa) * DS_Visitante (Fuera) * Avg Goles Local
            const xG_Home = homeStrengths.AS_Home * awayStrengths.DS_Away * avg.avgHomeGoals;

            // xG Visitante = AS_Visitante (Fuera) * DS_Local (Casa) * Avg Goles Visitante
            const xG_Away = awayStrengths.AS_Away * homeStrengths.DS_Home * avg.avgAwayGoals;

            return { xG_Home, xG_Away };
        }

        /**
         * Calcula la probabilidad de Poisson P(X=k) dado lambda (la media).
         * @param {number} lambda La tasa media (xG).
         * @param {number} k El número de goles.
         * @returns {number} La probabilidad.
         */
        function poissonProbability(lambda, k) {
            if (k < 0) return 0;
            if (lambda < 0) lambda = 0; // Manejar xG negativo (aunque no debería ocurrir)

            const factorial = (n) => {
                let res = 1;
                for (let i = 2; i <= n; i++) res *= i;
                return res;
            };

            // P(k; λ) = (e^-λ * λ^k) / k!
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
        }

        /**
         * Genera la matriz de probabilidades de Poisson.
         * @param {object} expectedGoals {xG_Home, xG_Away}
         */
        function generatePoissonMatrix(expectedGoals, homeTeam, awayTeam) {
            const { xG_Home, xG_Away } = expectedGoals;
            const matrixDiv = document.getElementById('poissonMatrix');

            // Calcular probabilidades individuales
            const homeProbs = Array(MAX_GOALS + 1).fill(0).map((_, k) => poissonProbability(xG_Home, k));
            const awayProbs = Array(MAX_GOALS + 1).fill(0).map((_, k) => poissonProbability(xG_Away, k));

            // Matriz de resultados
            let matrixHTML = `<table class="poisson-table w-full border-collapse">`;
            
            // Cabecera de la tabla (Goles Visitante)
            matrixHTML += `<thead><tr><th class="rounded-tl-lg bg-blue-900">${homeTeam} / ${awayTeam}</th>`;
            for (let j = 0; j <= MAX_GOALS; j++) {
                matrixHTML += `<th class="bg-blue-900">${j}</th>`;
            }
            matrixHTML += `</tr></thead>`;
            
            // Cuerpo de la tabla (Goles Local)
            matrixHTML += `<tbody>`;
            let homeWinProb = 0;
            let awayWinProb = 0;
            let drawProb = 0;
            let maxProb = 0;

            for (let i = 0; i <= MAX_GOALS; i++) { // Goles Local (i)
                matrixHTML += `<tr><th class="font-bold text-gray-800 bg-gray-200">${i}</th>`; // Fila de goles local
                for (let j = 0; j <= MAX_GOALS; j++) { // Goles Visitante (j)
                    // P(Score i-j) = P(Home=i) * P(Away=j)
                    const prob = homeProbs[i] * awayProbs[j];
                    const probPercent = (prob * 100).toFixed(2);
                    
                    if (prob > maxProb) maxProb = prob;

                    // Acumular probabilidades
                    if (i > j) {
                        homeWinProb += prob;
                    } else if (j > i) {
                        awayWinProb += prob;
                    } else {
                        drawProb += prob;
                    }

                    // Celda de la matriz
                    matrixHTML += `<td data-prob="${prob.toFixed(4)}" class="${probPercent > 0.01 ? 'text-gray-800' : 'text-gray-400'}">${probPercent}%</td>`;
                }
                matrixHTML += `</tr>`;
            }
            matrixHTML += `</tbody></table>`;
            matrixDiv.innerHTML = matrixHTML;

            // Resaltar la probabilidad máxima después de generar el HTML
            const cells = matrixDiv.querySelectorAll('td');
            cells.forEach(cell => {
                const prob = parseFloat(cell.getAttribute('data-prob'));
                if (Math.abs(prob - maxProb) < 0.000001 && maxProb > 0.005) { // Si es la máxima y es significativa
                    cell.classList.add('highlight-cell');
                }
            });
            
            return { homeWinProb, awayWinProb, drawProb, homeProbs, awayProbs };
        }
        
        /**
         * Muestra los pronósticos detallados (probabilidades individuales y más).
         */
        function displayDetailedForecast(homeTeam, awayTeam, results, xg) {
            const { homeWinProb, awayWinProb, drawProb, homeProbs, awayProbs } = results;
            const detailedDiv = document.getElementById('detailedForecast');
            
            const totalProb = homeWinProb + awayWinProb + drawProb;

            let html = `
                <div class="grid grid-cols-3 gap-4 text-center mb-6">
                    <div class="p-3 bg-white rounded-lg shadow-sm border border-indigo-300">
                        <p class="text-sm font-medium text-indigo-600">${homeTeam} Gana (1)</p>
                        <p class="text-2xl font-bold text-indigo-800">${(homeWinProb * 100).toFixed(2)}%</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg shadow-sm border border-indigo-300">
                        <p class="text-sm font-medium text-indigo-600">Empate (X)</p>
                        <p class="text-2xl font-bold text-indigo-800">${(drawProb * 100).toFixed(2)}%</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg shadow-sm border border-indigo-300">
                        <p class="text-sm font-medium text-indigo-600">${awayTeam} Gana (2)</p>
                        <p class="text-2xl font-bold text-indigo-800">${(awayWinProb * 100).toFixed(2)}%</p>
                    </div>
                </div>
                
                <p class="text-sm text-gray-600 mb-4">La suma de estas probabilidades es ${(totalProb * 100).toFixed(2)}%. La probabilidad restante (por goles > 10) es pequeña.</p>
                
                <h4 class="font-semibold text-lg text-indigo-700 mb-2">Probabilidades de Goles Individuales</h4>
                <div class="flex flex-wrap justify-start gap-3">
            `;
            
            // Mostrar probabilidades individuales de 0 a 3 goles
            for (let i = 0; i <= 3; i++) {
                html += `
                    <div class="p-2 bg-white rounded-lg text-center shadow-sm w-24">
                        <p class="text-xs font-semibold text-indigo-500">Goles ${i}</p>
                        <p class="text-sm font-bold text-gray-800">${homeTeam}: ${(homeProbs[i] * 100).toFixed(2)}%</p>
                        <p class="text-sm font-bold text-gray-800">${awayTeam}: ${(awayProbs[i] * 100).toFixed(2)}%</p>
                    </div>
                `;
            }

            html += `</div>`;
            detailedDiv.innerHTML = html;
        }

        /**
         * Muestra los resultados de las fuerzas y goles esperados.
         */
        function displaySummary(homeTeam, awayTeam, xg) {
            const { xG_Home, xG_Away } = xg;
            const homeStrengths = teamStrengths[homeTeam];
            const awayStrengths = teamStrengths[awayTeam];
            const summaryDiv = document.getElementById('summaryResults');
            
            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Home Team Summary -->
                    <div class="p-4 bg-white rounded-lg shadow border border-blue-100">
                        <h4 class="text-xl font-bold text-blue-700 mb-2">${homeTeam} (Local)</h4>
                        <p class="mb-1"><span class="font-semibold">Fuerza de Ataque (AS):</span> <span class="text-green-600">${homeStrengths.AS_Home.toFixed(3)}</span></p>
                        <p class="mb-1"><span class="font-semibold">Fuerza de Defensa (DS):</span> <span class="text-red-600">${homeStrengths.DS_Home.toFixed(3)}</span></p>
                        <p class="mt-3 text-lg font-extrabold text-blue-800">Goles Esperados (xG): <span class="text-3xl">${xG_Home.toFixed(2)}</span></p>
                    </div>
                    
                    <!-- Away Team Summary -->
                    <div class="p-4 bg-white rounded-lg shadow border border-red-100">
                        <h4 class="text-xl font-bold text-red-700 mb-2">${awayTeam} (Visitante)</h4>
                        <p class="mb-1"><span class="font-semibold">Fuerza de Ataque (AS):</span> <span class="text-green-600">${awayStrengths.AS_Away.toFixed(3)}</span></p>
                        <p class="mb-1"><span class="font-semibold">Fuerza de Defensa (DS):</span> <span class="text-red-600">${awayStrengths.DS_Away.toFixed(3)}</span></p>
                        <p class="mt-3 text-lg font-extrabold text-red-800">Goles Esperados (xG): <span class="text-3xl">${xG_Away.toFixed(2)}</span></p>
                    </div>
                </div>
                
                <p class="text-xs text-gray-500 mt-4 italic">
                    <span class="font-bold">Nota:</span> AS > 1.0 indica ataque por encima del promedio de la liga. DS < 1.0 indica defensa por encima del promedio de la liga.
                </p>
            `;
            summaryDiv.innerHTML = html;
        }

        /**
         * Función principal para ejecutar todos los cálculos y mostrar los resultados.
         */
        function runCalculations() {
            const homeTeam = document.getElementById('homeTeamSelect').value;
            const awayTeam = document.getElementById('awayTeamSelect').value;
            
            if (!homeTeam || !awayTeam) {
                showModal("Selección Incompleta", "Por favor, selecciona un equipo local y uno visitante.");
                return;
            }

            if (homeTeam === awayTeam) {
                showModal("Error de Selección", "El equipo local y el visitante no pueden ser el mismo.");
                return;
            }

            try {
                // 1. Calcular Goles Esperados (xG)
                const expectedGoals = calculateExpectedGoals(homeTeam, awayTeam);

                // 2. Mostrar Resumen de Fuerzas y xG
                displaySummary(homeTeam, awayTeam, expectedGoals);

                // 3. Generar Matriz Poisson
                const results = generatePoissonMatrix(expectedGoals, homeTeam, awayTeam);
                
                // 4. Mostrar Pronósticos Detallados
                displayDetailedForecast(homeTeam, awayTeam, results, expectedGoals);

                // Mostrar la sección de resultados
                document.getElementById('resultsSection').classList.remove('hidden');

            } catch (error) {
                showModal("Error en el Cálculo", `No se pudieron calcular las predicciones. Razón: ${error.message}`);
            }
        }
    </script>
</body>
</html>


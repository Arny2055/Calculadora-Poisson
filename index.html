<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Calculadora Poisson de F√∫tbol con Sugerencias</title>
    <style>
        /* Estilos para el Modo Oscuro */
        body { 
            font-family: 'Arial', sans-serif; 
            margin: 20px; 
            background-color: #1a1a1a; 
            color: #f0f0f0; 
        }
        .container { 
            max-width: 900px; 
            margin: auto; 
            background: #242424; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7); 
        }
        h1 { 
            color: #00e0ff; /* Azul cian */
            text-align: center; 
            margin-bottom: 25px;
        }
        h2 {
            color: #a0a0a0;
            border-bottom: 1px solid #3a3a3a;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .input-group, .results-table, .suggestions-box { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 8px; 
            background-color: #2c2c2c; 
        }
        .suggestions-box {
            border: 2px solid #ffcc00; /* Borde para resaltar las sugerencias */
            background-color: #383838;
        }
        label { 
            display: block; 
            margin-top: 10px; 
            font-weight: bold; 
            color: #ccc; 
        }
        input[type="number"] { 
            width: 100%; 
            padding: 10px; 
            margin-top: 5px; 
            border: 1px solid #555; 
            border-radius: 4px; 
            box-sizing: border-box; 
            background-color: #3e3e42; 
            color: #ffffff; 
        }
        button { 
            background-color: #4CAF50; 
            color: white; 
            padding: 12px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 15px; 
            width: 100%; 
            transition: background-color 0.3s;
        }
        button:hover { 
            background-color: #45a049; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        }
        th, td { 
            border: 1px solid #3a3a3a; 
            padding: 10px; 
            text-align: left; 
        }
        th { 
            background-color: #333; 
            color: #00e0ff;
        }
        td {
            background-color: #2c2c2c;
        }
        .resultado { 
            font-weight: bold; 
            color: #ffcc00; /* Amarillo/Dorado para resultados */
            font-size: 1.1em;
        }
        .score-list {
            list-style: none;
            padding: 0;
        }
        .score-list li {
            background-color: #3a3a3a;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 4px;
        }
        #suggested_markets p {
            font-size: 1.1em;
            margin: 5px 0;
            padding: 5px;
            background-color: #555;
            border-radius: 3px;
        }
        #suggested_markets .market-item {
            color: #ffcc00;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üî¢ Mega Calculadora Poisson de Goles</h1>

    <div class="input-group">
        <h2>üìä Promedios de Goles (Liga y Equipos)</h2>
        
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h3>Promedios de la Liga</h3>
                <label for="gl_l">Goles Promedio Local Liga ($\text{GL}_{\text{L}}$):</label>
                <input type="number" id="gl_l" value="1.5" step="0.01">
                <label for="gl_v">Goles Promedio Visitante Liga ($\text{GL}_{\text{V}}$):</label>
                <input type="number" id="gl_v" value="1.2" step="0.01">
            </div>
            
            <div style="flex: 1;">
                <h3>Equipo Local (Home)</h3>
                <label for="gf_l">Goles a Favor Local (en casa):</label>
                <input type="number" id="gf_l" value="1.8" step="0.01">
                <label for="gc_l">Goles En Contra Local (en casa):</label>
                <input type="number" id="gc_l" value="0.9" step="0.01">
            </div>
            
            <div style="flex: 1;">
                <h3>Equipo Visitante (Away)</h3>
                <label for="gf_v">Goles a Favor Visitante (fuera):</label>
                <input type="number" id="gf_v" value="1.4" step="0.01">
                <label for="gc_v">Goles En Contra Visitante (fuera):</label>
                <input type="number" id="gc_v" value="1.3" step="0.01">
            </div>
        </div>
    </div>

    <button onclick="calcularPoisson()">Calcular TODAS las Probabilidades</button>

    <div id="resultados" class="results-table" style="display:none;">
        
        <div class="suggestions-box">
            <h2 style="color: #ffcc00; border-bottom: 1px solid #555;">üí° SUGERENCIA DE MERCADO (Cuota 1.60 - 1.99)</h2>
            <div id="suggested_markets">
                <p>Calculando sugerencias...</p>
            </div>
        </div>

        <h2 style="margin-top: 20px;">üéØ Goles Esperados ($\lambda$)</h2>
        <p>Local ($\lambda_{\text{L}}$): <span id="lambda_l" class="resultado"></span></p>
        <p>Visitante ($\lambda_{\text{V}}$): <span id="lambda_v" class="resultado"></span></p>

        <div style="display: flex; gap: 20px;">
            
            <div style="flex: 1;">
                <h2>üèÜ Mercados Principales</h2>
                <table>
                    <thead><tr><th>Mercado</th><th>Prob.</th><th>Cuota Impl√≠cita</th></tr></thead>
                    <tbody>
                        <tr><td>**1X2** - Local (1)</td><td id="p_1" class="resultado"></td><td id="q_1" class="resultado"></td></tr>
                        <tr><td>**1X2** - Empate (X)</td><td id="p_x" class="resultado"></td><td id="q_x" class="resultado"></td></tr>
                        <tr><td>**1X2** - Visitante (2)</td><td id="p_2" class="resultado"></td><td id="q_2" class="resultado"></td></tr>
                        <tr><td>**Doble Opci√≥n** - 1X</td><td id="p_1x" class="resultado"></td><td id="q_1x" class="resultado"></td></tr>
                        <tr><td>**Doble Opci√≥n** - X2</td><td id="p_x2" class="resultado"></td><td id="q_x2" class="resultado"></td></tr>
                        <tr><td>**Doble Opci√≥n** - 12</td><td id="p_12" class="resultado"></td><td id="q_12" class="resultado"></td></tr>
                        <tr><td>**Ambos Anotan** (S√≠)</td><td id="p_btts_yes" class="resultado"></td><td id="q_btts_yes" class="resultado"></td></tr>
                        <tr><td>**Ambos Anotan** (No)</td><td id="p_btts_no" class="resultado"></td><td id="q_btts_no" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>

            <div style="flex: 1;">
                <h2>‚öΩ Goles Totales (Over/Under)</h2>
                <table>
                    <thead><tr><th>Mercado</th><th>Prob.</th><th>Cuota Impl√≠cita</th></tr></thead>
                    <tbody>
                        <tr><td>**Over 1.5**</td><td id="p_over15" class="resultado"></td><td id="q_over15" class="resultado"></td></tr>
                        <tr><td>**Under 1.5**</td><td id="p_under15" class="resultado"></td><td id="q_under15" class="resultado"></td></tr>
                        <tr><td>**Over 2.5**</td><td id="p_over25" class="resultado"></td><td id="q_over25" class="resultado"></td></tr>
                        <tr><td>**Under 2.5**</td><td id="p_under25" class="resultado"></td><td id="q_under25" class="resultado"></td></tr>
                        <tr><td>**Over 3.5**</td><td id="p_over35" class="resultado"></td><td id="q_over35" class="resultado"></td></tr>
                        <tr><td>**Under 3.5**</td><td id="p_under35" class="resultado"></td><td id="q_under35" class="resultado"></td></tr>
                        <tr><td>**Over 4.5**</td><td id="p_over45" class="resultado"></td><td id="q_over45" class="resultado"></td></tr>
                        <tr><td>**Under 4.5**</td><td id="p_under45" class="resultado"></td><td id="q_under45" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <h2 style="margin-top: 30px;">ü•á Top 5 Resultados Exactos M√°s Probables</h2>
        <ul id="top_scores" class="score-list">
            </ul>
    </div>
</div>

<script>
    // --- L√≥gica Matem√°tica y de C√°lculo ---

    // Rango de Cuotas Deseado
    const MIN_ODD = 1.60;
    const MAX_ODD = 1.99;

    // Funci√≥n Factorial
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }

    // Distribuci√≥n de Poisson
    function poisson(k, lambda) {
        if (lambda <= 0) return 0;
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }
    
    // Funci√≥n para formatear las probabilidades a porcentaje
    const formatP = (p) => isNaN(p) ? '0.00%' : (p * 100).toFixed(2) + '%';
    
    // Funci√≥n para calcular la Cuota Impl√≠cita (1 / Probabilidad)
    const calculateOdd = (p) => p > 0 ? (1 / p).toFixed(2) : 'N/A';
    
    // Funci√≥n principal de c√°lculo
    function calcularPoisson() {
        // 1. Obtener datos de entrada
        const GL_L = parseFloat(document.getElementById('gl_l').value); 
        const GL_V = parseFloat(document.getElementById('gl_v').value); 
        const GF_L = parseFloat(document.getElementById('gf_l').value); 
        const GC_L = parseFloat(document.getElementById('gc_l').value); 
        const GF_V = parseFloat(document.getElementById('gf_v').value); 
        const GC_V = parseFloat(document.getElementById('gc_v').value); 

        if (GL_L <= 0 || GL_V <= 0) {
            alert("Los promedios de goles de la liga deben ser mayores a 0 para calcular.");
            return;
        }

        // 2. Calcular Goles Esperados (Lambda)
        const FA_L = GF_L / GL_L; 
        const PD_V = GC_V / GL_L; 
        const FA_V = GF_V / GL_V; 
        const PD_L = GC_L / GL_V; 

        const lambda_L = FA_L * PD_V * GL_L;
        const lambda_V = FA_V * PD_L * GL_V;

        document.getElementById('lambda_l').textContent = lambda_L.toFixed(3);
        document.getElementById('lambda_v').textContent = lambda_V.toFixed(3);

        // 3. Crear la Matriz de Probabilidades (hasta 6 goles)
        const MAX_GOALS = 6; 
        let p_1 = 0, p_x = 0, p_2 = 0; // 1X2
        let p_total_goles = {}; 
        let top_scores_list = []; 
        let p_local_0 = poisson(0, lambda_L);
        let p_visitante_0 = poisson(0, lambda_V);
        let p_local_under = [p_local_0];
        let p_visitante_under = [p_visitante_0];

        for (let i = 0; i <= MAX_GOALS; i++) { // Goles Local (gL)
            let p_gL = poisson(i, lambda_L);
            if (i > 0) p_local_under.push((p_local_under[i-1] || 0) + p_gL);
            
            for (let j = 0; j <= MAX_GOALS; j++) { // Goles Visitante (gV)
                let p_gV = poisson(j, lambda_V);
                if (i === 0 && j > 0) p_visitante_under.push((p_visitante_under[j-1] || 0) + p_gV);

                let p_score = p_gL * p_gV;
                top_scores_list.push({ score: `${i}-${j}`, prob: p_score });

                // Sumar para 1X2
                if (i > j) {
                    p_1 += p_score;
                } else if (i === j) {
                    p_x += p_score;
                } else {
                    p_2 += p_score;
                }

                // Sumar para Goles Totales
                const total = i + j;
                p_total_goles[total] = (p_total_goles[total] || 0) + p_score;
            }
        }

        // 4. Ajustar 1X2 para que sume 100% (manejo de la "cola")
        const p_total_scores = p_1 + p_x + p_2;
        if (p_total_scores > 0) {
            const ratio = 1 / p_total_scores;
            p_1 *= ratio;
            p_x *= ratio;
            p_2 *= ratio;
        }

        // 5. Acumular y Calcular Mercados
        
        // Mercados 1X2 y Doble Oportunidad
        const p_1x = p_1 + p_x;
        const p_x2 = p_x + p_2;
        const p_12 = p_1 + p_2;
        
        // Ambos Anotan (BTTS)
        const p_0_0 = poisson(0, lambda_L) * poisson(0, lambda_V);
        const p_btts_no = poisson(0, lambda_L) + poisson(0, lambda_V) - p_0_0;
        const p_btts_yes = 1 - p_btts_no;

        // Goles Totales (Over/Under)
        let cumulativo_total = 0;
        const p_under_total = {};
        for(let t = 0; t <= 5; t++) {
            cumulativo_total += (p_total_goles[t] || 0);
            p_under_total[t + 0.5] = cumulativo_total;
        }

        // Almacenar todos los resultados para la sugerencia
        const all_market_probs = [
            // 1X2 y DO
            { name: "1 (Victoria Local)", prob: p_1, id_p: 'p_1', id_q: 'q_1' },
            { name: "X (Empate)", prob: p_x, id_p: 'p_x', id_q: 'q_x' },
            { name: "2 (Victoria Visitante)", prob: p_2, id_p: 'p_2', id_q: 'q_2' },
            { name: "Doble Opci√≥n 1X", prob: p_1x, id_p: 'p_1x', id_q: 'q_1x' },
            { name: "Doble Opci√≥n X2", prob: p_x2, id_p: 'p_x2', id_q: 'q_x2' },
            { name: "Doble Opci√≥n 12", prob: p_12, id_p: 'p_12', id_q: 'q_12' },
            // BTTS
            { name: "Ambos Anotan (S√≠)", prob: p_btts_yes, id_p: 'p_btts_yes', id_q: 'q_btts_yes' },
            { name: "Ambos Anotan (No)", prob: p_btts_no, id_p: 'p_btts_no', id_q: 'q_btts_no' },
            // Over/Under
            { name: "Over 1.5 Goles", prob: 1 - p_under_total[1.5], id_p: 'p_over15', id_q: 'q_over15' },
            { name: "Under 1.5 Goles", prob: p_under_total[1.5], id_p: 'p_under15', id_q: 'q_under15' },
            { name: "Over 2.5 Goles", prob: 1 - p_under_total[2.5], id_p: 'p_over25', id_q: 'q_over25' },
            { name: "Under 2.5 Goles", prob: p_under_total[2.5], id_p: 'p_under25', id_q: 'q_under25' },
            { name: "Over 3.5 Goles", prob: 1 - p_under_total[3.5], id_p: 'p_over35', id_q: 'q_over35' },
            { name: "Under 3.5 Goles", prob: p_under_total[3.5], id_p: 'p_under35', id_q: 'q_under35' },
            { name: "Over 4.5 Goles", prob: 1 - p_under_total[4.5], id_p: 'p_over45', id_q: 'q_over45' },
            { name: "Under 4.5 Goles", prob: p_under_total[4.5], id_p: 'p_under45', id_q: 'q_under45' },
            // Goles por equipo (solo los O/U 1.5 y 2.5 tienen cuota potencial en el rango)
            { name: "Local Over 0.5", prob: 1 - p_local_under[0], id_p: 'p_l_over05', id_q: 'q_l_over05' },
            { name: "Local Under 0.5", prob: p_local_under[0], id_p: 'p_l_under05', id_q: 'q_l_under05' },
            { name: "Visitante Over 0.5", prob: 1 - p_visitante_under[0], id_p: 'p_v_over05', id_q: 'q_v_over05' },
            { name: "Visitante Under 0.5", prob: p_visitante_under[0], id_p: 'p_v_under05', id_q: 'q_v_under05' },

            { name: "Local Over 1.5", prob: 1 - p_local_under[1], id_p: 'p_l_over15', id_q: 'q_l_over15' },
            { name: "Local Under 1.5", prob: p_local_under[1], id_p: 'p_l_under15', id_q: 'q_l_under15' },
            { name: "Visitante Over 1.5", prob: 1 - p_visitante_under[1], id_p: 'p_v_over15', id_q: 'q_v_over15' },
            { name: "Visitante Under 1.5", prob: p_visitante_under[1], id_p: 'p_v_under15', id_q: 'q_v_under15' },
        ];


        // 6. Generar Sugerencias de Mercado
        const suggested_markets = [];

        all_market_probs.forEach(market => {
            const odd = parseFloat(calculateOdd(market.prob));
            
            // Llenar la tabla de resultados (Probabilidad y Cuota)
            if (document.getElementById(market.id_p)) {
                document.getElementById(market.id_p).textContent = formatP(market.prob);
            }
            if (document.getElementById(market.id_q)) {
                document.getElementById(market.id_q).textContent = odd.toFixed(2);
            }
            
            // Comprobar si la cuota cae en el rango deseado (1.60 a 1.99)
            if (odd >= MIN_ODD && odd <= MAX_ODD) {
                suggested_markets.push({
                    name: market.name,
                    odd: odd,
                    prob: market.prob
                });
            }
        });

        // Mostrar las sugerencias
        const suggestions_div = document.getElementById('suggested_markets');
        if (suggested_markets.length > 0) {
            suggestions_div.innerHTML = '';
            // Ordenar por probabilidad (mayor probabilidad primero)
            suggested_markets.sort((a, b) => b.prob - a.prob);

            suggested_markets.forEach(s => {
                const p = document.createElement('p');
                p.innerHTML = `<span class="market-item">${s.name}</span>: Cuota Impl√≠cita ‚âà **${s.odd.toFixed(2)}** (${formatP(s.prob)})`;
                suggestions_div.appendChild(p);
            });
        } else {
            suggestions_div.innerHTML = '<p style="color: red;">No se encontraron mercados con una Cuota Impl√≠cita entre 1.60 y 1.99.</p>';
        }


        // 7. Top 5 Resultados Exactos (Igual que antes)
        top_scores_list.sort((a, b) => b.prob - a.prob);
        const top_5 = top_scores_list.slice(0, 5);
        
        const top_scores_ul = document.getElementById('top_scores');
        top_scores_ul.innerHTML = ''; 
        top_5.forEach(item => {
            const li = document.createElement('li');
            const odd = calculateOdd(item.prob);
            li.innerHTML = `**${item.score}** - Probabilidad: <span class="resultado">${formatP(item.prob)}</span> (Cuota Impl√≠cita: ${odd})`;
            top_scores_ul.appendChild(li);
        });

        document.getElementById('resultados').style.display = 'block';
    }
</script>

</body>
</html>

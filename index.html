<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BetTracking Mejorado — Historial + Filtros + Diseño</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #0f1724;
    --card: #0b1220;
    --muted: #9aa6b2;
    --accent: #10b981;
    --danger: #ef4444;
    --warning: #fbbf24;
    --glass: rgba(255, 255, 255, 0.03);
    --win-bg: rgba(16, 185, 129, 0.15);
    --loss-bg: rgba(239, 68, 68, 0.15);
    --pending-bg: rgba(255, 255, 255, 0.07);
    color-scheme: dark;
  }
  * {
    box-sizing: border-box;
  }
  body {
    font-family: Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    background: linear-gradient(180deg, #071024 0%, #071227 60%);
    color: #e6eef6;
    padding: 20px 14px 30px 14px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  h1, h2, h3, h4 {
    margin: 0 0 8px 0;
  }
  h1 {
    font-weight: 700;
    font-size: 22px;
  }
  h2 {
    font-weight: 600;
    font-size: 18px;
  }
  h3 {
    font-weight: 600;
    font-size: 16px;
  }
  h4 {
    font-weight: 600;
    font-size: 14px;
  }
  .sub {
    font-size: 13px;
    color: var(--muted);
  }
  .layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 16px;
    flex: 1 1 auto;
  }
  @media (max-width: 850px) {
    .layout {
      grid-template-columns: 1fr;
    }
  }
  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 5px 15px rgba(2, 6, 23, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.04);
  }
  label {
    font-size: 13px;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
  }
  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    background: transparent;
    color: inherit;
    font-size: 14px;
    margin-bottom: 12px;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  select:focus {
    border-color: var(--accent);
    outline: none;
  }
  button {
    background: var(--accent);
    color: #04201a;
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #05976d;
  }
  button.ghost {
    background: transparent;
    border: 1.5px solid rgba(255, 255, 255, 0.1);
    color: var(--muted);
    font-weight: 600;
  }
  button.ghost:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .bankroll-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 350px;
    overflow-y: auto;
  }
  .bankroll-btn {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    border-radius: 10px;
    background: var(--glass);
    border: 1px solid rgba(255, 255, 255, 0.02);
    cursor: pointer;
    transition: border-color 0.3s ease;
  }
  .bankroll-btn.active {
    border-color: var(--accent);
    box-shadow: 0 0 8px var(--accent);
  }
  .bankroll-btn:hover:not(.active) {
    border-color: var(--muted);
  }
  .small-muted {
    font-size: 12px;
    color: var(--muted);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 14px;
  }
  th,
  td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.07);
    text-align: left;
    vertical-align: middle;
  }
  th.right,
  td.right {
    text-align: right;
  }
  .pill {
    padding: 4px 10px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
    user-select: none;
    min-width: 56px;
    text-align: center;
  }
  .pill.win {
    background: var(--win-bg);
    color: var(--accent);
  }
  .pill.loss {
    background: var(--loss-bg);
    color: var(--danger);
  }
  .pill.pending {
    background: var(--pending-bg);
    color: var(--muted);
  }
  .summary {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .summary .stat {
    background: rgba(255, 255, 255, 0.05);
    padding: 12px 16px;
    border-radius: 12px;
    min-width: 160px;
    flex: 1 1 140px;
  }
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .col {
    flex: 1 1 auto;
    min-width: 180px;
  }
  .filters {
    margin-top: 14px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  .filters label {
    margin-right: 6px;
  }
  @media (max-width: 600px) {
    .row,
    .filters {
      flex-direction: column;
      gap: 8px;
    }
    .bankroll-btn {
      flex-direction: column;
      align-items: flex-start;
    }
  }
  footer {
    margin-top: 30px;
    font-size: 12px;
    color: var(--muted);
    text-align: center;
  }
</style>
</head>
<body>

<header>
  <h1>BetTracking Mejorado</h1>
  <div class="sub">Multi-bankroll, apuestas guardadas con historial y filtros, stake sugerido y usado, diseño responsivo.</div>
</header>

<div class="layout">

  <!-- Bankrolls -->
  <aside class="card" aria-label="Panel de bankrolls">
    <h2>Bankrolls (máx 5)</h2>
    <div class="bankroll-list" id="bankrollList" tabindex="0" aria-live="polite" aria-relevant="additions removals"></div>

    <form id="bankrollForm" style="margin-top:12px;" onsubmit="return false;">
      <label for="newName">Nombre bankroll</label>
      <input id="newName" type="text" maxlength="30" placeholder="Ej: Fondo A" autocomplete="off" aria-required="true" required />
      <label for="newBal">Balance inicial (MXN)</label>
      <input id="newBal" type="number" min="0" step="0.01" placeholder="1000" autocomplete="off" aria-required="true" required />
      <div class="row" style="justify-content: space-between;">
        <button id="addBankrollBtn" type="submit" aria-label="Agregar bankroll">Añadir bankroll</button>
        <button id="resetBtn" class="ghost" type="button" aria-label="Resetear todos los datos">Resetear todo</button>
      </div>
    </form>
  </aside>

  <!-- Main content -->
  <main class="card" aria-label="Panel principal de apuestas y controles">
    <section aria-labelledby="activeBankrollTitle">
      <h2 id="activeBankrollTitle">Bankroll activo</h2>
      <div style="font-weight:700; font-size: 18px;" id="activeBankrollName">— Selecciona un bankroll —</div>
      <div class="small-muted" id="activeBalance">Balance: —</div>
    </section>

    <section aria-labelledby="kellyTitle" style="margin-top:16px;">
      <h3 id="kellyTitle">Parámetros Kelly</h3>
      <div class="row" style="align-items:center; gap:12px; flex-wrap: wrap;">
        <label for="kellyFrac" style="min-width: 130px;">Fracción Kelly (%)</label>
        <input id="kellyFrac" type="number" min="0" max="100" step="1" value="25" aria-describedby="kellyHelp" />
        <select id="useKelly" aria-label="Modo de uso Kelly">
          <option value="suggest">Solo sugerir (no stake automático)</option>
          <option value="auto">Calcular stake automático</option>
        </select>
      </div>
      <div id="kellyHelp" class="small-muted" style="margin-top:6px;">
        f* = (p·D − 1) / (D − 1). Si f* ≤ 0 → no apostar. Stake sugerido = balance × f* × (Fracción Kelly).
      </div>
    </section>

    <section aria-labelledby="betFormTitle" style="margin-top:22px;">
      <h2 id="betFormTitle">Agregar apuesta</h2>
      <form id="betForm" onsubmit="return false;" style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label for="betDesc">Descripción</label>
          <input id="betDesc" type="text" maxlength="80" placeholder="Ej: América vs Pumas — Over 2.5" autocomplete="off" required />
          <label for="betP">Probabilidad (p) — decimal (0 < p < 1)</label>
          <input id="betP" type="number" step="0.0001" min="0.0001" max="0.9999" placeholder="0.589" required />
          <label for="betD">Cuota decimal (D) &gt; 1</label>
          <input id="betD" type="number" step="0.01" min="1.01" placeholder="2.00" required />
        </div>

        <div>
          <label for="betStake">Stake (opcional) — si vacío usa Kelly o 1% bankroll</label>
          <input id="betStake" type="number" step="0.01" min="0" placeholder="Ej: 50" autocomplete="off" />
          <label for="betType">Tipo resultado</label>
          <select id="betType" aria-label="Tipo de apuesta">
            <option value="normal">Normal (stake*(D-1))</option>
            <option value="back">Back (mismo cálculo)</option>
            <option value="lay" disabled title="Lay no soportado">Lay (no soportado)</option>
          </select>
          <div class="row" style="margin-top:12px;">
            <button id="addBetBtn" type="submit" aria-label="Agregar apuesta">Añadir apuesta</button>
            <button id="clearForm" class="ghost" type="button" aria-label="Limpiar formulario">Limpiar</button>
          </div>
        </div>
      </form>
    </section>

    <section aria-labelledby="filterTitle" style="margin-top: 28px;">
      <h2 id="filterTitle">Historial y filtros</h2>
      <div class="filters" role="group" aria-label="Filtros de apuestas">
        <label for="filterStatus">Estado:</label>
        <select id="filterStatus" aria-controls="betsTable" aria-live="polite">
          <option value="all">Todas</option>
          <option value="pending">Pendientes</option>
          <option value="win">Ganadas</option>
          <option value="loss">Perdidas</option>
        </select>

        <label for="filterSearch" style="margin-left: 10px;">Buscar descripción:</label>
        <input id="filterSearch" type="search" placeholder="Texto en la descripción" autocomplete="off" aria-controls="betsTable" />
      </div>

      <table aria-describedby="betTableDesc" id="betsTable" style="margin-top:10px;">
        <caption id="betTableDesc" class="small-muted" style="text-align:left; margin-bottom:6px;">Lista de apuestas filtradas por estado y búsqueda</caption>
        <thead>
          <tr>
            <th>Descripción</th>
            <th>P</th>
            <th>D</th>
            <th>Kelly %</th>
            <th>Stake sugerido</th>
            <th>Stake usado</th>
            <th>Estado</th>
            <th>Ganancia/Pérdida</th>
            <th class="right" style="width:100px;">Acciones</th>
          </tr>
        </thead>
        <tbody id="betsBody">
          <tr><td colspan="9" class="small-muted" style="text-align:center;">No hay apuestas</td></tr>
        </tbody>
      </table>

      <div class="summary" id="summary"></div>
    </section>
  </main>

</div>

<footer>
  <div class="small-muted">Datos guardados localmente en este navegador. Sin conexión.</div>
</footer>

<script>
  // Utilidad
  function $(id) { return document.getElementById(id); }
  function money(x) {
    if (typeof x !== 'number') x = Number(x);
    if (!isFinite(x)) return '0.00';
    return x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
  }

  // Storage key y estado
  const STORAGE_KEY = 'bettracking_v2_fullhist';
  let state = { bankRolls: [], active: null };

  // Carga estado de localStorage
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) state = JSON.parse(raw);
    } catch (e) {
      console.warn('Error cargando estado:', e);
    }
    if (!state.bankRolls) state = { bankRolls: [], active: null };
  }

  // Guarda estado a localStorage
  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // Render lista de bankrolls
  function renderBankrolls() {
    const list = $('bankrollList');
    list.innerHTML = '';
    if (state.bankRolls.length === 0) {
      list.innerHTML = '<div class="small-muted" style="text-align:center;">No tienes bankrolls. Crea uno.</div>';
      updateActiveInfo();
      return;
    }
    state.bankRolls.forEach((b, i) => {
      const div = document.createElement('div');
      div.className = 'bankroll-btn' + (state.active === i ? ' active' : '');
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      div.setAttribute('aria-pressed', (state.active === i).toString());
      div.setAttribute('aria-label', `Bankroll ${b.name} con saldo ${money(b.balance)} pesos, ${b.bets.length} apuestas`);
      div.innerHTML = `<div>
        <div style="font-weight:700">${escapeHtml(b.name)}</div>
        <div class="small-muted">Saldo: ${money(b.balance)}</div>
        <div class="small-muted">Apuestas: ${b.bets.length}</div>
      </div>
      <div style="display:flex;flex-direction:column; gap:4px; text-align:right;">
        <button class="ghost" aria-label="Editar bankroll ${escapeHtml(b.name)}" onclick="editBankroll(${i})">Editar</button>
        <button aria-label="Seleccionar bankroll ${escapeHtml(b.name)}" onclick="selectBankroll(${i})">Abrir</button>
      </div>`;
      div.onclick = () => selectBankroll(i);
      list.appendChild(div);
    });
    if (state.bankRolls.length < 10) {
      const hint = document.createElement('div');
      hint.className = 'bankroll-btn';
      hint.style.justifyContent = 'center';
      hint.style.color = 'var(--muted)';
      hint.style.userSelect = 'none';
      hint.textContent = '➕ Crea hasta 5 bankrolls';
      list.appendChild(hint);
    }
  }

  // Actualizar info activo
  function updateActiveInfo() {
    const nameEl = $('activeBankrollName');
    const balEl = $('activeBalance');
    if (state.active === null || !state.bankRolls[state.active]) {
      nameEl.textContent = '— Selecciona un bankroll —';
      balEl.textContent = 'Balance: —';
      clearBetsTable();
      return;
    }
    const b = state.bankRolls[state.active];
    nameEl.textContent = b.name;
    balEl.textContent = 'Balance: $' + money(b.balance);
    renderBetsTable();
  }

  // Seleccionar bankroll activo
  function selectBankroll(idx) {
    if (state.active === idx) return;
    state.active = idx;
    saveState();
    renderBankrolls();
    updateActiveInfo();
    clearForm();
  }

  // Añadir bankroll nuevo
  function addBankroll(name, balance) {
    if (state.bankRolls.length >= 10) {
      alert('Solo puedes tener hasta 10 bankrolls.');
      return false;
    }
    if (!name || !balance || isNaN(balance) || balance < 0) {
      alert('Nombre y balance válido son requeridos.');
      return false;
    }
    state.bankRolls.push({ name, balance: +balance, bets: [] });
    state.active = state.bankRolls.length - 1;
    saveState();
    renderBankrolls();
    updateActiveInfo();
    clearForm();
    return true;
  }

  // Editar bankroll - para simplicidad solo cambio nombre y reset balance
  function editBankroll(idx) {
    const b = state.bankRolls[idx];
    const newName = prompt('Editar nombre bankroll:', b.name);
    if (newName === null) return;
    if (newName.trim() === '') {
      alert('El nombre no puede quedar vacío.');
      return;
    }
    const newBalanceStr = prompt('Editar balance bankroll (actual: ' + money(b.balance) + '):', money(b.balance));
    if (newBalanceStr === null) return;
    let newBalance = parseFloat(newBalanceStr);
    if (isNaN(newBalance) || newBalance < 0) {
      alert('Balance inválido.');
      return;
    }
    b.name = newName.trim();
    b.balance = newBalance;
    saveState();
    renderBankrolls();
    updateActiveInfo();
  }

  // Limpiar formulario de apuesta
  function clearForm() {
    $('betDesc').value = '';
    $('betP').value = '';
    $('betD').value = '';
    $('betStake').value = '';
    $('betType').value = 'normal';
  }

  // Calcula fracción Kelly recomendada (0 a 1)
  function kellyFraction(p, D) {
    if (p <= 0 || p >= 1 || D <= 1) return 0;
    const f = (p * (D - 1) - (1 - p)) / (D - 1);
    return f > 0 ? f : 0;
  }

  // Añadir apuesta nuevo
  function addBet(desc, p, D, stakeInput, type) {
    if (state.active === null) {
      alert('Selecciona un bankroll primero.');
      return false;
    }
    const bankroll = state.bankRolls[state.active];
    if (!desc.trim()) {
      alert('La descripción es requerida.');
      return false;
    }
    p = parseFloat(p);
    D = parseFloat(D);
    if (isNaN(p) || p <= 0 || p >= 1) {
      alert('Probabilidad debe ser decimal entre 0 y 1.');
      return false;
    }
    if (isNaN(D) || D <= 1) {
      alert('Cuota debe ser mayor que 1.');
      return false;
    }
    let fKelly = kellyFraction(p, D);
    let kellyFracInput = parseInt($('kellyFrac').value, 10);
    if (isNaN(kellyFracInput) || kellyFracInput < 0 || kellyFracInput > 100) kellyFracInput = 25;
    const fractionUsed = kellyFracInput / 100;
    const useKellyMode = $('useKelly').value;

    // Si Kelly da valor positivo, se usa fKelly * fracción,
    // si no, stake sugerido es 1% del bankroll
    let stakeSuggested = 0;
    if (fKelly > 0) {
      stakeSuggested = bankroll.balance * fKelly * fractionUsed;
    } else {
      stakeSuggested = bankroll.balance * 0.01;
    }
    stakeSuggested = Math.min(stakeSuggested, bankroll.balance);
    stakeSuggested = Math.max(0, stakeSuggested);

    let stake = 0;
    if (stakeInput !== '' && !isNaN(stakeInput)) {
      stake = Math.min(parseFloat(stakeInput), bankroll.balance);
      if (stake < 0) stake = 0;
    } else if (useKellyMode === 'auto') {
      stake = stakeSuggested;
    } else {
      stake = 0;
    }

    // Crear objeto apuesta con estado pendiente
    const bet = {
      id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2),
      desc: desc.trim(),
      p, D, stake,
      stakeSuggested,
      type,
      status: 'pending',
      profit: 0,
      timestamp: Date.now()
    };

    bankroll.bets.push(bet);
    saveState();
    renderBetsTable();
    updateActiveInfo();
    clearForm();
    return true;
  }

  // Cambiar estado apuesta y calcular impacto balance
  function resolveBet(bankrollIdx, betId, won) {
    const bankroll = state.bankRolls[bankrollIdx];
    const bet = bankroll.bets.find(b => b.id === betId);
    if (!bet) return;
    if (bet.status !== 'pending') {
      alert('Esta apuesta ya fue resuelta.');
      return;
    }

    // Calcular profit o pérdida
    let profit = 0;
    if (won) {
      // Ganancia: stake * (D - 1)
      profit = bet.stake * (bet.D - 1);
    } else {
      // Pérdida: -stake
      profit = -bet.stake;
    }

    bet.status = won ? 'win' : 'loss';
    bet.profit = profit;
    bankroll.balance += profit;

    saveState();
    renderBetsTable();
    updateActiveInfo();
  }

  // Eliminar apuesta
  function deleteBet(bankrollIdx, betId) {
    if (!confirm('¿Eliminar esta apuesta? Esta acción no se puede deshacer.')) return;
    const bankroll = state.bankRolls[bankrollIdx];
    const idx = bankroll.bets.findIndex(b => b.id === betId);
    if (idx === -1) return;
    // Si estaba resuelta, revertimos impacto en balance
    const bet = bankroll.bets[idx];
    if (bet.status === 'win' || bet.status === 'loss') {
      bankroll.balance -= bet.profit;
    }
    bankroll.bets.splice(idx, 1);
    saveState();
    renderBetsTable();
    updateActiveInfo();
  }

  // Limpiar tabla apuestas
  function clearBetsTable() {
    const tbody = $('betsBody');
    tbody.innerHTML = '<tr><td colspan="9" class="small-muted" style="text-align:center;">No hay apuestas</td></tr>';
    $('summary').innerHTML = '';
  }

  // Render tabla apuestas con filtros
  function renderBetsTable() {
    if (state.active === null) {
      clearBetsTable();
      return;
    }
    const bankroll = state.bankRolls[state.active];
    const bets = bankroll.bets;

    const filterStatus = $('filterStatus').value;
    const filterSearch = $('filterSearch').value.trim().toLowerCase();

    let filtered = bets.filter(b => {
      let matchesStatus = (filterStatus === 'all') || (b.status === filterStatus);
      let matchesSearch = b.desc.toLowerCase().includes(filterSearch);
      return matchesStatus && matchesSearch;
    });

    const tbody = $('betsBody');
    tbody.innerHTML = '';

    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="small-muted" style="text-align:center;">No hay apuestas</td></tr>';
      $('summary').innerHTML = '';
      return;
    }

    // Ordenamos por fecha descendente
    filtered.sort((a,b) => b.timestamp - a.timestamp);

    filtered.forEach(bet => {
      const tr = document.createElement('tr');
      tr.style.backgroundColor = bet.status === 'win' ? 'var(--win-bg)' : (bet.status === 'loss' ? 'var(--loss-bg)' : 'transparent');
      tr.innerHTML = `
        <td title="${escapeHtml(bet.desc)}">${escapeHtml(bet.desc).slice(0,40)}${bet.desc.length>40?'…':''}</td>
        <td>${bet.p.toFixed(3)}</td>
        <td>${bet.D.toFixed(2)}</td>
        <td>${(kellyFraction(bet.p, bet.D)*100).toFixed(2)}%</td>
        <td>${money(bet.stakeSuggested)}</td>
        <td>${money(bet.stake)}</td>
        <td><span class="pill ${bet.status}">${bet.status.charAt(0).toUpperCase() + bet.status.slice(1)}</span></td>
        <td>${bet.status === 'pending' ? '-' : (bet.profit >= 0 ? '+$' : '-$') + money(Math.abs(bet.profit))}</td>
        <td class="right">
          ${bet.status === 'pending' ? `
          <button aria-label="Marcar ganada" onclick="resolveBet(${state.active}, '${bet.id}', true)">✔️</button>
          <button aria-label="Marcar perdida" onclick="resolveBet(${state.active}, '${bet.id}', false)">❌</button>
          ` : ''}
          <button aria-label="Eliminar apuesta" onclick="deleteBet(${state.active}, '${bet.id}')">🗑️</button>
        </td>`;
      tbody.appendChild(tr);
    });

    renderSummary(filtered);
  }

  // Render resumen simple
  function renderSummary(filteredBets) {
    const totalBets = filteredBets.length;
    const wins = filteredBets.filter(b => b.status === 'win');
    const losses = filteredBets.filter(b => b.status === 'loss');
    const pending = filteredBets.filter(b => b.status === 'pending');

    const sumProfit = filteredBets.reduce((a,b) => a + (b.profit || 0), 0);

    const avgKelly = filteredBets.length === 0 ? 0 : filteredBets.reduce((a,b) => a + kellyFraction(b.p,b.D), 0) / filteredBets.length * 100;

    $('summary').innerHTML = `
      <div class="stat"><strong>Total apuestas:</strong> ${totalBets}</div>
      <div class="stat"><strong>Ganadas:</strong> ${wins.length}</div>
      <div class="stat"><strong>Perdidas:</strong> ${losses.length}</div>
      <div class="stat"><strong>Pendientes:</strong> ${pending.length}</div>
      <div class="stat"><strong>Ganancia neta (filtrada):</strong> $${money(sumProfit)}</div>
      <div class="stat"><strong>Kelly promedio:</strong> ${avgKelly.toFixed(2)}%</div>
    `;
  }

  // Eventos
  window.onload = () => {
    loadState();
    renderBankrolls();
    updateActiveInfo();

    $('bankrollForm').onsubmit = e => {
      e.preventDefault();
      const name = $('newName').value.trim();
      const bal = parseFloat($('newBal').value);
      if (addBankroll(name, bal)) {
        $('newName').value = '';
        $('newBal').value = '';
        $('newName').focus();
      }
    };

    $('resetBtn').onclick = () => {
      if (confirm('¿Seguro quieres borrar todos los datos? No se podrá recuperar.')) {
        localStorage.removeItem(STORAGE_KEY);
        state = { bankRolls: [], active: null };
        renderBankrolls();
        updateActiveInfo();
        clearForm();
      }
    };

    $('addBetBtn').onclick = () => {
      addBet(
        $('betDesc').value,
        $('betP').value,
        $('betD').value,
        $('betStake').value,
        $('betType').value
      );
    };

    $('clearForm').onclick = clearForm;

    $('filterStatus').onchange = renderBetsTable;
    $('filterSearch').oninput = renderBetsTable;

    $('kellyFrac').onchange = renderBetsTable;
    $('useKelly').onchange = renderBetsTable;
  };
</script>

</body>
</html>
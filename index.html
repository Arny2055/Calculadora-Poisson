<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Pro: Tiempos y Rangos (15')</title>
    <style>
        :root { --primary: #001e54; --dark: #0f172a; --accent: #3b82f6; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--dark); padding: 20px; line-height: 1.5; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 11px; font-family: monospace; box-sizing: border-box; }
        button { width: 100%; margin: 20px 0; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #1e40af; }
        
        /* Resultados */
        .results-main { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .range-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .card-header { background: var(--primary); color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 13px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .prob-val { font-weight: bold; color: var(--accent); }
        .high-val { background: #dcfce7; color: #166534; }
        .title-sec { margin: 30px 0 15px; padding-left: 10px; border-left: 5px solid var(--accent); font-weight: bold; color: var(--primary); text-transform: uppercase; }
        #resultsDisplay { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color: var(--primary);">Calculadora Poisson Multi-Rango</h1>
    
    <div class="grid-inputs">
        <div>
            <label><b>Datos LOCAL (Home):</b></label>
            <textarea id="homeData" placeholder="Pega el bloque completo de stats aquí..."></textarea>
        </div>
        <div>
            <label><b>Datos VISITANTE (Away):</b></label>
            <textarea id="awayData" placeholder="Pega el bloque completo de stats aquí..."></textarea>
        </div>
    </div>

    <button onclick="processData()">ANALIZAR PARTIDO</button>

    <div id="resultsDisplay">
        <div class="title-sec">Resultados Generales (FT, HT, 2ndH)</div>
        <div class="results-main" id="mainTables"></div>

        <div class="title-sec">Probabilidad de GOL por Rangos (15 Minutos)</div>
        <div class="range-grid" id="rangeTables"></div>
    </div>
</div>

<script>
function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

function extractIntervals(text) {
    // Busca los valores GF y GA por cada tramo de 15 minutos
    const intervals = ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"];
    let stats = {};
    
    intervals.forEach(range => {
        const regex = new RegExp(range + "\\s+GF\\s+(\\d+)\\s+GA\\s+(\\d+)");
        const match = text.match(regex);
        stats[range] = {
            gf: match ? parseInt(match[1]) : 0,
            ga: match ? parseInt(match[2]) : 0
        };
    });
    return stats;
}

function processData() {
    const hRaw = document.getElementById('homeData').value;
    const aRaw = document.getElementById('awayData').value;

    const hStats = extractIntervals(hRaw);
    const aStats = extractIntervals(aRaw);

    // Totales para Lambdas FT
    const hTotalGF = Object.values(hStats).reduce((a, b) => a + b.gf, 0);
    const hTotalGA = Object.values(hStats).reduce((a, b) => a + b.ga, 0);
    const aTotalGF = Object.values(aStats).reduce((a, b) => a + b.gf, 0);
    const aTotalGA = Object.values(aStats).reduce((a, b) => a + b.ga, 0);

    const lambdaFT = ((hTotalGF + aTotalGA) / 2 + (aTotalGF + hTotalGA) / 2);

    // Renderizar tablas principales
    const mainDiv = document.getElementById('mainTables');
    mainDiv.innerHTML = '';
    
    // FT, HT (45%), 2H (55%)
    renderTable(mainDiv, "PARTIDO COMPLETO (FT)", lambdaFT, [0.5, 1.5, 2.5, 3.5]);
    renderTable(mainDiv, "PRIMERA MITAD (HT)", lambdaFT * 0.45, [0.5, 1.5]);
    renderTable(mainDiv, "SEGUNDA MITAD (2ndH)", lambdaFT * 0.55, [0.5, 1.5]);

    // Renderizar Rangos de 15'
    const rangeDiv = document.getElementById('rangeTables');
    rangeDiv.innerHTML = '';
    
    const intervals = ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"];
    intervals.forEach(range => {
        // Lambda específico para el tramo: (Ataque Local en ese tramo + Defensa Visita en ese tramo) / 2 ...
        const lH = (hStats[range].gf + aStats[range].ga) / 2;
        const lA = (aStats[range].gf + hStats[range].ga) / 2;
        const lambdaRange = (lH + lA) / 9; // Dividimos por 9 asumiendo que el dato es acumulado de temporada

        // Nota: SoccerStats da totales de temporada por rango, por lo que calculamos la 
        // probabilidad de que ocurra AL MENOS UN GOL en ese tramo específico hoy.
        const probAlMenosUno = 1 - poisson(0, (lambdaRange));
        
        const card = document.createElement('div');
        card.className = 'card';
        const pct = (probAlMenosUno * 100).toFixed(1);
        const cuota = (1 / probAlMenosUno).toFixed(2);
        
        card.innerHTML = `
            <div class="card-header">MINUTOS ${range}'</div>
            <div style="padding:15px; text-align:center;">
                <div style="font-size:11px; color:#666;">Prob. de Gol en este tramo</div>
                <div class="prob-val" style="font-size:20px;">${pct}%</div>
                <div style="font-size:12px; margin-top:5px;">Cuota Justa: <b>${cuota}</b></div>
            </div>
        `;
        rangeDiv.appendChild(card);
    });

    document.getElementById('resultsDisplay').style.display = 'block';
}

function renderTable(container, title, lambda, lines) {
    const card = document.createElement('div');
    card.className = 'card';
    let rows = '';
    
    lines.forEach(line => {
        let pU = 0;
        for(let i=0; i<line; i++) pU += poisson(i, lambda);
        let pO = 1 - pU;
        rows += `
            <tr><td>Over ${line}</td><td class="${pO > 0.6 ? 'high-val' : ''}">${(pO*100).toFixed(1)}%</td><td>${(1/pO).toFixed(2)}</td></tr>
            <tr><td>Under ${line}</td><td class="${pU > 0.6 ? 'high-val' : ''}">${(pU*100).toFixed(1)}%</td><td>${(1/pU).toFixed(2)}</td></tr>
        `;
    });

    card.innerHTML = `
        <div class="card-header">${title}</div>
        <table>
            <thead><tr><th>Línea</th><th>Prob.</th><th>Cuota</th></tr></thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    container.appendChild(card);
}
</script>

</body>
</html>

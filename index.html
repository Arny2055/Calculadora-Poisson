<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Backtesting ROI ‚Äî Dashboard Completo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --accent:#0b6ed0; --muted:#6b7280;
    --good:#16a34a; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:18px;color:#0f1724}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  header h1{margin:0;font-size:20px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(12,20,30,0.06);margin-bottom:12px}
  .controls{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media(max-width:900px){.controls{grid-template-columns:repeat(1,1fr)}}
  label{display:block;font-weight:600;margin-bottom:6px}
  input[type=file], select, input[type=text], input[type=number]{width:100%;padding:8px;border:1px solid #e6e9ee;border-radius:8px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#334155}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{padding:8px;border:1px solid #e6e9ee;text-align:left}
  th{background:#0f1724;color:white}
  tr:nth-child(even){background:#fbfdff}
  .good{color:var(--good);font-weight:700}
  .bad{color:var(--bad);font-weight:700}
  pre#log{background:#0b1220;color:#dbe9ff;padding:8px;border-radius:6px;height:120px;overflow:auto;font-size:12px}
  .flex{display:flex;gap:12px;align-items:center}
  .chip{background:#eef2ff;padding:6px 10px;border-radius:999px;font-weight:600}
  .kpi{display:flex;gap:12px;flex-wrap:wrap}
  .kpi .item{background:#fff;padding:8px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
  .muted{color:var(--muted)}
  .chart-wrap{height:320px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Backtesting ROI ‚Äî Dashboard Completo</h1>
      <div class="small">Bank referencia 100u ¬∑ stake por defecto 1u ¬∑ compatibilidad Safari/Chrome/Firefox</div>
    </div>

    <div class="flex">
      <button id="saveIndexed">üíæ Guardar</button>
      <button id="loadIndexed" class="secondary">üìÇ Cargar</button>
      <button id="clearIndexed" style="background:#ef4444">üóë Borrar</button>
    </div>
  </header>

  <!-- CONTROLES -->
  <section class="card">
    <div class="controls">
      <div>
        <label>Subir HISTORIAL (JSON)</label>
        <input id="histInput" type="file" accept=".json">
        <div class="small">Array JSON o registros sueltos. Guardados en memoria al subir.</div>
      </div>

      <div>
        <label>Subir PARTIDOS FUTUROS (JSON)</label>
        <input id="futInput" type="file" accept=".json">
      </div>

      <div>
        <label>Filtro: Liga</label>
        <select id="leagueFilter"><option value="all">Todas</option></select>
      </div>

      <div>
        <label>Filtro: Equipo (texto)</label>
        <input id="teamFilter" type="text" placeholder="buscar por parte del nombre">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="width:130px">
        <label>Stake por apuesta</label>
        <input id="stakeInput" type="number" min="0.01" step="0.01" value="1">
      </div>
      <div style="width:120px">
        <label>Bank</label>
        <input id="bankInput" type="number" min="1" step="1" value="100">
      </div>
      <div style="flex:1">
        <label>&nbsp;</label>
        <div class="row">
          <button id="runBtn">üîç Ejecutar Backtesting</button>
          <button id="exportCsv" class="secondary">‚¨á Exportar CSV</button>
          <button id="clearBtn" style="background:#ef4444">Limpiar</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="flex:1">
        <label>Logs</label>
        <pre id="log"></pre>
      </div>
      <div style="width:320px">
        <label>Resumen r√°pido</label>
        <div id="summary" class="card small" style="height:120px;overflow:auto;padding:10px">Sin procesar</div>
      </div>
    </div>
  </section>

  <!-- KPI / tablas -->
  <section class="card">
    <h3 style="margin:0 0 8px 0">Resultados por equipo (incluye Local / Visitante y Kelly)</h3>
    <div class="small">Click en encabezados para ordenar (no implementado como JS table sort, pero la tabla ya viene ordenada por ROI por defecto).</div>
    <div style="overflow:auto;margin-top:10px">
      <table id="teamTable">
        <thead>
          <tr>
            <th>Equipo</th>
            <th>Matches</th>
            <th>Wins</th>
            <th>Losses</th>
            <th>Profit</th>
            <th>AvgProfit</th>
            <th>ROI %</th>
            <th>ROI Local %</th>
            <th>ROI Visit. %</th>
            <th>Avg Odd</th>
            <th>WinRate</th>
            <th>Kelly %</th>
            <th>Kelly stake (u)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px 0">Resultados por partido (detalle hist√≥rico usado)</h3>
    <div style="overflow:auto;margin-top:10px">
      <table id="matchTable">
        <thead>
          <tr><th>Equipo</th><th>Partido</th><th>Liga</th><th>Fecha</th><th>Odd</th><th>Result</th><th>ROI</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h3 style="margin:0">Gr√°fica ‚Äî ROI por equipo (top 30)</h3>
        <div class="chart-wrap"><canvas id="roiChart"></canvas></div>
      </div>
      <div style="width:360px">
        <h3 style="margin:0">Gr√°fica ‚Äî ROI por liga</h3>
        <div class="chart-wrap"><canvas id="leagueChart"></canvas></div>
      </div>
    </div>
  </section>

</div>

<script>
/* ---------------- Estado en memoria ---------------- */
let historialUploaded = null;   // array de objetos
let futurosUploaded = null;
let resultsByTeam = [];         // resultados actuales
let matchDetails = [];          // detalles por partido
let chartTeams = null;
let chartLeagues = null;

/* ---------------- Helpers ---------------- */
const $ = id => document.getElementById(id);
const logEl = $('log');
function log(msg){ const t=new Date().toLocaleTimeString(); logEl.textContent=`[${t}] ${msg}\n` + logEl.textContent; }
function safeParseJSON(content){
  content = String(content||'').trim();
  if(!content) throw new Error('archivo vac√≠o');
  try{ const p=JSON.parse(content); return Array.isArray(p)?p:[p]; }catch(e){}
  try{ const w='['+content.replace(/,\s*$/,'')+']'; const p=JSON.parse(w); return Array.isArray(p)?p:[p]; }catch(e){}
  const lines = content.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(lines.length>1){
    const out=[];
    for(let ln of lines){ if(ln.endsWith(',')) ln=ln.slice(0,-1); try{ out.push(JSON.parse(ln)); }catch(e){} }
    if(out.length) return out;
  }
  const objs=[]; const re=/{[^}]*}/g; let m;
  while((m=re.exec(content))!==null){ try{ objs.push(JSON.parse(m[0])); }catch(e){} }
  if(objs.length) return objs;
  throw new Error('No se pudo parsear JSON. Asegura formato v√°lido.');
}
function normalize(s){ if(!s && s!==0) return ''; let x=String(s).trim().toLowerCase(); x=x.normalize('NFD').replace(/\p{Diacritic}/gu,''); x=x.replace(/[^a-z0-9\- ]/g,' '); x=x.replace(/\s+/g,' ').trim(); return x; }
function mean(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : NaN; }

/* ---------------- Read file inputs (store in memory) ---------------- */
$('histInput').addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const parsed = safeParseJSON(txt);
    historialUploaded = parsed;
    log(`Historial cargado: ${parsed.length} registros (${f.name})`);
    buildLeagueOptions();
  }catch(err){ log('ERROR parse historial: '+(err.message||err)); alert('Error parseando historial: '+(err.message||err)); }
});
$('futInput').addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const parsed = safeParseJSON(txt);
    futurosUploaded = parsed;
    log(`Futuros cargados: ${parsed.length} registros (${f.name})`);
    buildLeagueOptions();
  }catch(err){ log('ERROR parse futuros: '+(err.message||err)); alert('Error parseando futuros: '+(err.message||err)); }
});

/* ---------------- Build league select ---------------- */
function buildLeagueOptions(){
  const s = new Set();
  if(Array.isArray(historialUploaded)) historialUploaded.forEach(x=>{ if(x.League) s.add(String(x.League)); });
  if(Array.isArray(futurosUploaded)) futurosUploaded.forEach(x=>{ if(x.League) s.add(String(x.League)); });
  const sel = $('leagueFilter');
  const prev = sel.value || 'all';
  sel.innerHTML = '<option value="all">Todas</option>';
  Array.from(s).sort().forEach(l => { const o = document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); });
  sel.value = prev;
}

/* ---------------- Core: run backtesting ---------------- */
$('runBtn').addEventListener('click', ()=>{
  try{
    if(!historialUploaded || !futurosUploaded){ alert('Carga HISTORIAL y FUTUROS antes'); return; }

    const stake = parseFloat($('stakeInput').value) || 1;
    const bank = parseFloat($('bankInput').value) || 100;
    const leagueSel = $('leagueFilter').value;
    const teamQuery = ($('teamFilter').value||'').trim().toLowerCase();

    // gather teams from futuros respecting league and team filter
    const teamsSet = new Set();
    futurosUploaded.forEach(f=>{
      if(!f.Match) return;
      if(leagueSel!=='all' && f.League !== leagueSel) return;
      const p = String(f.Match).split(' - ').map(s=> (s||'').trim());
      const home = p[0] || ''; const away = p[1] || '';
      if(home && (!teamQuery || home.toLowerCase().includes(teamQuery))) teamsSet.add(home);
      if(away && (!teamQuery || away.toLowerCase().includes(teamQuery))) teamsSet.add(away);
    });

    if(teamsSet.size===0){ alert('No se encontraron equipos a analizar con esos filtros'); return; }
    log(`Analizando ${teamsSet.size} equipos extra√≠dos de futuros`);

    // initialize stats structure
    const stats = {}; // norm -> object
    Array.from(teamsSet).forEach(name=>{
      stats[normalize(name)] = {
        display: name,
        matches:0, wins:0, losses:0, profit:0, odds:[], 
        matchesHome:0, winsHome:0, lossesHome:0, profitHome:0, oddsHome:[],
        matchesAway:0, winsAway:0, lossesAway:0, profitAway:0, oddsAway:[]
      };
    });

    // iterate historial once
    historialUploaded.forEach(h=>{
      if(!h.Match) return;
      const parts = String(h.Match).split(' - ').map(s=> (s||'').trim());
      const home = parts[0]||''; const away = parts[1]||'';
      const homeNorm = normalize(home); const awayNorm = normalize(away);
      const odd = parseFloat(h.Odd);
      const result = String(h.Result||'').toLowerCase();
      const isWin = /win|won|winning|ganad|gano|victoria/.test(result);

      // helper to register stats for one team (home/away)
      function registerTeam(teamNorm, teamSide){
        if(!stats[teamNorm]) return;
        const s = stats[teamNorm];
        s.matches++;
        if(isWin) s.wins++; else s.losses++;
        let gain = 0;
        if(!isNaN(odd)){
          gain = isWin ? ((odd - 1) * stake) : (-stake);
          s.odds.push(odd);
        } else {
          gain = isWin ? 0 : -stake;
        }
        s.profit += gain;
        // home/away specific
        if(teamSide==='home'){
          s.matchesHome++; if(isWin) s.winsHome++; else s.lossesHome++;
          s.profitHome += gain; if(!isNaN(odd)) s.oddsHome.push(odd);
        } else if(teamSide==='away'){
          s.matchesAway++; if(isWin) s.winsAway++; else s.lossesAway++;
          s.profitAway += gain; if(!isNaN(odd)) s.oddsAway.push(odd);
        }
        // store match detail for output
        matchDetails.push({
          equipo: s.display,
          partido: h.Match,
          liga: h.League || '',
          fecha: h.Date || '',
          odd: isNaN(odd)?'':odd,
          result: h.Result || '',
          roi: gain
        });
      }

      // register for home team
      if(stats[homeNorm]) registerTeam(homeNorm, 'home');
      if(stats[awayNorm]) registerTeam(awayNorm, 'away');
    });

    // compute derived metrics per team
    const results = [];
    Object.keys(stats).forEach(k=>{
      const s = stats[k];
      if(s.matches === 0) return;
      const avgProfit = s.profit / s.matches;
      const roiPct = (s.profit / (s.matches * stake)) * 100;
      const roiHome = s.matchesHome ? (s.profitHome / (s.matchesHome*stake))*100 : NaN;
      const roiAway = s.matchesAway ? (s.profitAway / (s.matchesAway*stake))*100 : NaN;
      const winRate = s.wins / s.matches;
      const avgOdd = mean(s.odds.filter(Boolean));
      // Kelly calculation
      let kellyFrac = NaN, kellyStake = NaN;
      if(!isNaN(avgOdd) && avgOdd>1){
        const b = avgOdd - 1;
        const p = winRate;
        const q = 1 - p;
        const frac = ((b * p) - q) / b;
        kellyFrac = Math.max(-1, Math.min(1, frac));
        if(!isNaN(kellyFrac)) kellyStake = Math.max(0, kellyFrac * bankInputValue());
      }
      results.push({
        display: s.display,
        matches: s.matches,
        wins: s.wins,
        losses: s.losses,
        profit: s.profit,
        avgProfit,
        roiPct,
        roiHome,
        roiAway,
        winRate,
        avgOdd: isNaN(avgOdd)?null:avgOdd,
        kellyFrac,
        kellyStake
      });
    });

    // sort by ROI desc
    results.sort((a,b) => (b.roiPct - a.roiPct));
    resultsByTeam = results;
    matchDetails = matchDetails.sort((a,b) => b.roi - a.roi);

    renderTeamTable(results);
    renderMatchTable(matchDetails);
    renderTeamChart(results.slice(0,30));
    renderLeagueChart(aggregateByLeague(results));
    updateSummary(results);
    log(`Backtesting terminado. Equipos procesados: ${results.length}`);
  }catch(err){
    log('ERROR: '+(err && err.message ? err.message : err));
    alert('Error durante backtesting: ' + (err && err.message ? err.message : err));
  }
});

/* ---------------- Helpers to get bank input ---------------- */
function bankInputValue(){ return parseFloat($('bankInput').value) || 100; }

/* ---------------- Render functions ---------------- */
function renderTeamTable(data){
  const tbody = document.querySelector('#teamTable tbody');
  tbody.innerHTML = '';
  data.forEach(r=>{
    const tr = document.createElement('tr');
    if(r.roiPct > 0) tr.classList.add('positivo');
    tr.innerHTML = `<td>${r.display}</td>
      <td>${r.matches}</td>
      <td>${r.wins}</td>
      <td>${r.losses}</td>
      <td>${r.profit.toFixed(3)}</td>
      <td>${r.avgProfit.toFixed(3)}</td>
      <td class="${r.roiPct>=0?'good':'bad'}">${r.roiPct.toFixed(2)}%</td>
      <td>${isNaN(r.roiHome)?'N/A':r.roiHome.toFixed(2)+'%'}</td>
      <td>${isNaN(r.roiAway)?'N/A':r.roiAway.toFixed(2)+'%'}</td>
      <td>${r.avgOdd?r.avgOdd.toFixed(3):'N/A'}</td>
      <td>${(r.winRate*100).toFixed(2)}%</td>
      <td>${isNaN(r.kellyFrac)?'N/A':(r.kellyFrac*100).toFixed(2)+'%'}</td>
      <td>${isNaN(r.kellyStake)?'N/A':r.kellyStake.toFixed(3)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderMatchTable(data){
  const tbody = document.querySelector('#matchTable tbody');
  tbody.innerHTML = '';
  data.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.equipo}</td>
      <td>${r.partido}</td>
      <td>${r.liga}</td>
      <td>${r.fecha}</td>
      <td>${r.odd}</td>
      <td>${r.result}</td>
      <td>${r.roi.toFixed(3)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------------- Charts ---------------- */
function renderTeamChart(data){
  const ctx = document.getElementById('roiChart').getContext('2d');
  if(chartTeams) chartTeams.destroy();
  chartTeams = new Chart(ctx, {
    type:'bar',
    data:{ labels:data.map(d=>d.display), datasets:[{ label:'ROI %', data:data.map(d=>d.roiPct), backgroundColor:data.map(d=> d.roiPct>0? 'rgba(16,185,129,0.8)':'rgba(239,68,68,0.8)') }] },
    options:{ responsive:true, scales:{ y:{ beginAtZero:true }} }
  });
}

function aggregateByLeague(teamResults){
  // We'll aggregate profits & matches by league by scanning matchDetails
  const map = {};
  matchDetails.forEach(m=>{
    const lg = m.liga || 'Sin liga';
    if(!map[lg]) map[lg] = {profit:0,matches:0};
    map[lg].profit += parseFloat(m.roi) || 0;
    map[lg].matches++;
  });
  const out = Object.keys(map).map(k=>({league:k,profit:map[k].profit, matches:map[k].matches, roiPct: (map[k].profit / (map[k].matches || 1))*100}));
  out.sort((a,b)=>b.roiPct - a.roiPct);
  return out;
}

function renderLeagueChart(data){
  const ctx = document.getElementById('leagueChart').getContext('2d');
  if(chartLeagues) chartLeagues.destroy();
  chartLeagues = new Chart(ctx, {
    type:'bar',
    data:{ labels:data.map(d=>d.league), datasets:[{ label:'ROI % por liga', data:data.map(d=>d.roiPct) }]},
    options:{ responsive:true, scales:{ y:{ beginAtZero:true }}}
  });
}

/* ---------------- Update summary ---------------- */
function updateSummary(results){
  const pos = results.filter(r=> r.roiPct>0).length;
  $('summary').innerHTML = `<div><b>Equipos analizados:</b> ${results.length}</div>
    <div><b>Con ROI positivo:</b> ${pos}</div>
    <div class="small">Kelly stake muestra recomendaci√≥n (clamp ‚â• 0)</div>`;
}

/* ---------------- Export CSV ---------------- */
$('exportCsv').addEventListener('click', ()=>{
  const rows = resultsByTeam || [];
  if(!rows.length){ alert('No hay resultados para exportar.'); return; }
  let csv = 'Equipo,Matches,Wins,Losses,Profit,AvgProfit,ROI%,ROI_Local%,ROI_Away%,AvgOdd,WinRate%,KellyFrac,KellyStake\n';
  rows.forEach(r=>{
    csv += `"${r.display.replace(/"/g,'""')}",${r.matches},${r.wins},${r.losses},${r.profit.toFixed(3)},${r.avgProfit.toFixed(3)},${r.roiPct.toFixed(3)},${isNaN(r.roiHome)?'':r.roiHome.toFixed(3)},${isNaN(r.roiAway)?'':r.roiAway.toFixed(3)},${r.avgOdd?r.avgOdd.toFixed(3):''},${(r.winRate*100).toFixed(2)},${isNaN(r.kellyFrac)?'':r.kellyFrac.toFixed(4)},${isNaN(r.kellyStake)?'':r.kellyStake.toFixed(3)}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'backtesting_team_results.csv'; a.click(); URL.revokeObjectURL(url);
  log('CSV exportado.');
});

/* ---------------- Clear memory ---------------- */
$('clearBtn').addEventListener('click', ()=>{
  historialUploaded = null; futurosUploaded = null; resultsByTeam = []; matchDetails=[]; $('teamTable').querySelector('tbody').innerHTML=''; $('matchTable').querySelector('tbody').innerHTML=''; if(chartTeams) chartTeams.destroy(); if(chartLeagues) chartLeagues.destroy();
  log('Memoria limpiada.');
});

/* ---------------- IndexedDB simple storage ---------------- */
const DB='bt-db-v1', STORE='data';
function openDb(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB,1); r.onupgradeneeded = e => e.target.result.createObjectStore(STORE); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function idbPut(k,v){ const db = await openDb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(v,k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
async function idbGet(k){ const db = await openDb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const rq=tx.objectStore(STORE).get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error); }); }
async function idbClear(){ const db = await openDb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).clear(); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }

$('saveIndexed').addEventListener('click', async ()=>{ try{ await idbPut('hist', historialUploaded||[]); await idbPut('fut', futurosUploaded||[]); log('Datos guardados en IndexedDB.'); }catch(err){ log('ERR save IndexedDB: '+err); }});
$('loadIndexed').addEventListener('click', async ()=>{ try{ const h=await idbGet('hist'); const f=await idbGet('fut'); if(h){ historialUploaded=h; log('Hist cargado desde IndexedDB: '+h.length); } if(f){ futurosUploaded=f; log('Fut cargado desde IndexedDB: '+f.length); } buildLeagueOptions(); }catch(err){ log('ERR load IndexedDB: '+err); }});
$('clearIndexed').addEventListener('click', async ()=>{ try{ await idbClear(); log('IndexedDB limpiada.'); }catch(err){ log('ERR clear IndexedDB: '+err); }});

/* ---------------- init ---------------- */
log('Interfaz lista. Sube HISTORIAL y FUTUROS para empezar.');
</script>
</body>
</html>
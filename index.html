<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Backtesting Robusto ‚Äî Detecta patrones y valida resultados</title>
<style>
  :root{--bg:#071225;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4}
  body{background:linear-gradient(180deg,var(--bg),#04101a);color:#e6eef6;font-family:Inter,system-ui,Arial;margin:0;padding:18px}
  h1{font-size:1.1rem;margin:0 0 12px 0}
  .card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
  input,textarea,select,button{font:inherit}
  input[type=file]{color:transparent}
  textarea{width:100%;min-height:90px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:inherit}
  .row{display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(90deg,var(--accent),#26d0ce);border:none;color:#021522;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  progress{width:100%;height:14px;border-radius:8px;overflow:hidden}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  th{color:var(--muted);font-weight:600;font-size:12px}
  .green{color:#8ee99b}
  .red{color:#ff8b8b}
  .small{font-size:13px;color:var(--muted)}
  pre{white-space:pre-wrap;font-size:13px}
  .warning{color:#ffd166}
</style>
</head>
<body>

<h1>Backtesting robusto ‚Äî calcula desde tu JSON y valida resultados</h1>

<div class="card">
  <div class="row" style="margin-bottom:10px">
    <input id="fileInput" type="file" />
    <button id="btnPaste" class="btn">Pegar JSON manual</button>
  </div>

  <textarea id="pasteArea" placeholder='Pega aqu√≠ tu JSON (array o NDJSON - una l√≠nea por objeto)'></textarea>

  <div style="margin-top:8px" class="row">
    <button id="btnStart" class="btn">Procesar Backtest</button>
    <div style="margin-left:auto" class="small">Stake fijo = <strong>1</strong></div>
  </div>

  <progress id="progress" value="0" max="100" style="display:none;margin-top:8px"></progress>
  <div id="status" class="small" style="margin-top:8px"></div>
</div>

<div id="output" style="display:none">
  <div class="card">
    <h3>Resumen</h3>
    <div id="metrics" class="small"></div>
  </div>

  <div class="card">
    <h3>Top ligas (ordenado por profit)</h3>
    <div id="byLeague"></div>
  </div>

  <div class="card">
    <h3>Top equipos (ordenado por profit)</h3>
    <div id="byTeam"></div>
  </div>

  <div class="card">
    <h3>Por rango de cuotas</h3>
    <div id="byOdds"></div>
  </div>

  <div class="card">
    <h3>Problemas / registros no decididos (muestra algunos)</h3>
    <div id="undetermined" class="small"></div>
  </div>

  <!-- NUEVO: Informe de puntos fuertes/d√©biles -->
  <div class="card">
    <h3>Informe de puntos fuertes y d√©biles</h3>
    <div id="insights" class="small"></div>
  </div>

  <div class="card">
    <button id="btnExportCSV" class="btn">Exportar resultados (CSV)</button>
  </div>
</div>

<script>
/* =========== Worker code (string) =========== */
const workerCode = `

function normalizeKey(k){ return k ? k.toString().trim().toLowerCase().replace(/\\s+/g,' ') : ''; }
function tryNum(v){
  if(v===null||v===undefined) return NaN;
  if(typeof v==='number') return v;
  let s=String(v).trim().replace(/['"]/g,'').replace(/,/g,'.');
  const m=s.match(/-?\\d+(\\.\\d+)?/);
  if(m) return Number(m[0]);
  return NaN;
}
function parseScore(s){
  if(!s) return null;
  const m=String(s).match(/(\\d+)\\s*[-:\\u2013]\\s*(\\d+)/);
  if(m) return {home:parseInt(m[1],10),away:parseInt(m[2],10)};
  return null;
}
function evaluateDesired(desired, market, score){
  if(!desired && !market) return null;
  const d=(desired||'').toString().toLowerCase();
  const mkt=(market||'').toString().toLowerCase();

  if(/gg|both teams to score|btts|yes/i.test(d)||/btts/.test(mkt)){if(score) return (score.home>0 && score.away>0);return null;}
  if(/no goal|no|nogoal|both no/i.test(d)||/(no|nogoal)/.test(mkt)){if(score) return !(score.home>0 && score.away>0);return null;}

  const overM=d.match(/over\\s*([0-9]+(?:\\.[0-9]+)?)/i)||mkt.match(/over\\s*([0-9]+(?:\\.[0-9]+)?)/i);
  if(overM && score){return (score.home+score.away)>parseFloat(overM[1]);}
  const underM=d.match(/under\\s*([0-9]+(?:\\.[0-9]+)?)/i)||mkt.match(/under\\s*([0-9]+(?:\\.[0-9]+)?)/i);
  if(underM && score){return (score.home+score.away)<=parseFloat(underM[1]);}

  if(/^\\s*1\\s*$/.test(d)||/(^|\\s)home(\\s|$)/i.test(d)){if(score) return (score.home>score.away);}
  if(/^\\s*2\\s*$/.test(d)||/(^|\\s)away(\\s|$)/i.test(d)){if(score) return (score.away>score.home);}
  if(/^\\s*x\\s*$/.test(d)||/^\\s*draw\\s*$/i.test(d)||/(^|\\s)tie(\\s|$)/i.test(d)){if(score) return (score.home===score.away);}

  if(/^\\s*\\d+\\s*[-:]\\s*\\d+\\s*$/.test(d)&&score){const m=d.match(/(\\d+)\\s*[-:]\\s*(\\d+)/);return (parseInt(m[1],10)===score.home && parseInt(m[2],10)===score.away);}
  return null;
}

function getValue(obj, candidates){
  const map={};
  for(const k in obj){ map[normalizeKey(k)]=obj[k]; }
  for(const c of candidates){ const norm=normalizeKey(c); if(map[norm]!==undefined) return map[norm]; }
  for(const normKey in map){ for(const c of candidates){ const q=normalizeKey(c); if(normKey.includes(q)||q.includes(normKey)) return map[normKey]; } }
  return undefined;
}
function oddsBucket(o){
  if(isNaN(o)) return 'unknown';
  if(o<1.5) return '1.01 - 1.49';
  if(o<2) return '1.50 - 1.99';
  if(o<3) return '2.00 - 2.99';
  if(o<5) return '3.00 - 4.99';
  return '5.00+';
}

self.onmessage=function(e){
  try{
    const text=e.data.text;
    let records=[];
    try{ records=JSON.parse(text); if(!Array.isArray(records)) records=[records]; }
    catch(err){
      const lines=text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      for(const line of lines){ try{records.push(JSON.parse(line);}catch(errLine){}}}
    }

    const stake=1;
    let total=0, profit=0, ganado=0, perdido=0;
    let leagues={}, teams={}, oddsBuckets={}, undetermined=[];
    let insights={home:{profit:0,count:0},away:{profit:0,count:0},cuotas:{}};

    for(const r of records){
      total++;
      const rawOdds=getValue(r,['odd','odds',' odd ','odd prematch']);
      const rawProfit=getValue(r,['profit','profit ','profit (u)']);
      const rawResult=getValue(r,['result',' result ','status']);
      const rawResultFT=getValue(r,['result ft','result_ft','result full']);
      const rawDesired=getValue(r,['desired outcome','desired',' name ','name','selection','bet','market selection']);
      const rawLeague=getValue(r,['league',' competition ','league ']);
      const rawMatch=getValue(r,['match',' match ','game','fixture']);

      const odds=tryNum(rawOdds);
      let p=tryNum(rawProfit);
      if(isNaN(p)){
        const rstr=rawResult?String(rawResult).toLowerCase():'';
        if(rstr.match(/win|won|winning/)) p=(odds>0?odds-1:0)*stake;
        else if(rstr.match(/lose|lost|losing/)) p=-stake;
      }
      if(isNaN(p)){
        let score=parseScore(rawResultFT)||parseScore(rawResult);
        const outcome=evaluateDesired(rawDesired,getValue(r,['market','market name','market ']),score);
        if(outcome===true) p=(odds>0?odds-1:0)*stake;
        else if(outcome===false) p=-stake;
      }
      if(isNaN(p)){ undetermined.push({sample:r}); continue; }

      profit+=p;
      if(p>0) ganado+=p; else perdido+=Math.abs(p);

      const leagueKey=rawLeague?String(rawLeague):'Desconocida';
      if(!leagues[leagueKey]) leagues[leagueKey]={count:0,profit:0,ganado:0,perdido:0};
      leagues[leagueKey].count++; leagues[leagueKey].profit+=p; if(p>0) leagues[leagueKey].ganado+=p; else leagues[leagueKey].perdido+=Math.abs(p);

      const matchStr=rawMatch?String(rawMatch):'';
      let home='', away='';
      const sep=matchStr.includes('-')?'-':(matchStr.toLowerCase().includes(' vs ')?' vs ':(matchStr.includes('@')?'@':(matchStr.includes(' v ')?' v ':null)));
      if(sep){ const parts=matchStr.split(sep).map(s=>s.trim()).filter(Boolean); if(parts.length>=2){home=parts[0];away=parts[1];} }

      if(home){ if(!teams[home]) teams[home]={count:0,profit:0,ganado:0,perdido:0}; teams[home].count++; teams[home].profit+=p; if(p>0) teams[home].ganado+=p; else teams[home].perdido+=Math.abs(p); insights.home.profit+=p; insights.home.count++; }
      if(away){ if(!teams[away]) teams[away]={count:0,profit:0,ganado:0,perdido:0}; teams[away].count++; teams[away].profit+=p; if(p>0) teams[away].ganado+=p; else teams[away].perdido+=Math.abs(p); insights.away.profit+=p; insights.away.count++; }

      const bucket=oddsBucket(odds);
      if(!oddsBuckets[bucket]) oddsBuckets[bucket]={count:0,profit:0,ganado:0,perdido:0};
      oddsBuckets[bucket].count++; oddsBuckets[bucket].profit+=p; if(p>0) oddsBuckets[bucket].ganado+=p; else oddsBuckets[bucket].perdido+=Math.abs(p);
      // insights por cuotas
      if(!insights.cuotas[bucket]) insights.cuotas[bucket]={profit:0,count:0};
      insights.cuotas[bucket].profit+=p; insights.cuotas[bucket].count++;
    }

    const roi=total?(profit/total*100):0;

    // ANALISIS PUNTOS FUERTES/D√âBILES
    let report=[];
    if(insights.home.count>0) report.push('üè† Local promedio profit: '+(insights.home.profit/insights.home.count).toFixed(2));
    if(insights.away.count>0) report.push('üõ´ Visitante promedio profit: '+(insights.away.profit/insights.away.count).toFixed(2));
    const cuotasArr=Object.entries(insights.cuotas).map(([k,v])=>({bucket:k,profit:v.profit,avg:v.profit/v.count}));
    if(cuotasArr.length>0){
      cuotasArr.sort((a,b)=>b.avg-a.avg);
      report.push('üí∞ Cuotas m√°s rentables: '+cuotasArr[0].bucket+' (avg profit: '+cuotasArr[0].avg.toFixed(2)+')');
      report.push('‚ö†Ô∏è Cuotas menos rentables: '+cuotasArr[cuotasArr.length-1].bucket+' (avg profit: '+cuotasArr[cuotasArr.length-1].avg.toFixed(2)+')');
    }

    self.postMessage({ok:true, metrics:{total,profit,ganado,perdido,roi,undetermined:undetermined.length}, leagues, teams, oddsBuckets, undetermined:undetermined.slice(0,20), insightsReport:report});
  }catch(err){
    self.postMessage({ok:false,error:err.message});
  }
};
`;

/* =========== main thread =========== */
const blob = new Blob([workerCode], { type: "application/javascript" });
const worker = new Worker(URL.createObjectURL(blob));
const progress = document.getElementById('progress');
const status = document.getElementById('status');

worker.onmessage = e => {
  progress.style.display = 'none';
  status.textContent = '';
  if(!e.data.ok){ alert('Error en worker: ' + e.data.error); return; }

  const m = e.data.metrics;
  document.getElementById('metrics').innerHTML = `
    <div>Apuestas procesadas: <strong>${m.total}</strong></div>
    <div>‚úÖ Ganado: <strong class="green">${m.ganado.toFixed(2)}</strong></div>
    <div>‚ùå Perdido: <strong class="red">${m.perdido.toFixed(2)}</strong></div>
    <div>Beneficio neto: <strong>${m.profit.toFixed(2)}</strong></div>
    <div>ROI (por apuesta): <strong>${m.roi.toFixed(2)}%</strong></div>
    <div class="small">Registros no decididos: <strong class="warning">${m.undetermined}</strong> (se muestran algunos abajo)</div>
  `;

  renderGroupTable(e.data.leagues, 'byLeague', 'Liga');
  renderGroupTable(e.data.teams, 'byTeam', 'Equipo');
  renderGroupTable(e.data.oddsBuckets, 'byOdds', 'Rango cuota');

  const und = e.data.undetermined || [];
  const undDiv = document.getElementById('undetermined');
  if(und.length === 0) undDiv.innerHTML = '<div class="small">Ninguno ‚Äî todos los registros fueron decididos.</div>';
  else {
    let html = '<div class="small">Mostrando hasta 20 registros no decididos:</div><pre>';
    und.forEach((u)=>{ html += JSON.stringify(u.sample, null, 2) + '\\n---\\n'; });
    html += '</pre>';
    undDiv.innerHTML = html;
  }

  // NUEVO: mostrar insights
  const insightsDiv = document.getElementById('insights');
  if(e.data.insightsReport && e.data.insightsReport.length>0){
    insightsDiv.innerHTML = '<ul>'+e.data.insightsReport.map(r=>'<li>'+r+'</li>').join('')+'</ul>';
  } else { insightsDiv.innerHTML = '<div class="small">No se detectaron patrones claros.</div>'; }

  document.getElementById('output').style.display = '';
  window._lastWorkerResult = e.data;
};

function renderGroupTable(mapObj, containerId, label){
  const arr=Object.keys(mapObj).map(k=>({key:k,count:mapObj[k].count,profit: mapObj[k].profit||0,ganado:mapObj[k].ganado||0,perdido:mapObj[k].perdido||0})).sort((a,b)=>b.profit-a.profit);
  if(arr.length===0){ document.getElementById(containerId).innerHTML='<div class="small">Sin datos</div>'; return; }
  let html='<table><thead><tr><th>'+label+'</th><th>#</th><th>Profit</th><th>Ganado</th><th>Perdido</th></tr></thead><tbody>';
  arr.forEach(r=>{ html+='<tr><td>'+r.key+'</td><td>'+r.count+'</td><td>'+r.profit.toFixed(2)+'</td><td>'+r.ganado.toFixed(2)+'</td><td>'+r.perdido.toFixed(2)+'</td></tr>'; });
  html+='</tbody></table>';
  document.getElementById(containerId).innerHTML=html;
}

document.getElementById('btnStart').onclick=function(){
  const text = document.getElementById('pasteArea').value;
  if(!text) { alert('No hay datos'); return; }
  progress.style.display = 'block';
  progress.value=0; status.textContent='Procesando...';
  worker.postMessage({text});
};

document.getElementById('btnPaste').onclick=function(){
  navigator.clipboard.readText().then(t=>{ document.getElementById('pasteArea').value=t; });
};

document.getElementById('fileInput').onchange=function(e){
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload=function(evt){ document.getElementById('pasteArea').value=evt.target.result; };
  reader.readAsText(f);
};

document.getElementById('btnExportCSV').onclick=function(){
  const data = window._lastWorkerResult;
  if(!data){ alert('No hay datos para exportar'); return; }
  let csv='Grupo,Nombre,#,Profit,Ganado,Perdido\\n';
  const combine = {...data.leagues,...data.teams,...data.oddsBuckets};
  for(const k in combine){
    const v=combine[k];
    csv+=`${k},${k},${v.count},${v.profit||0},${v.ganado||0},${v.perdido||0}\\n`;
  }
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='backtest.csv'; a.click();
};
</script>
</body>
</html>
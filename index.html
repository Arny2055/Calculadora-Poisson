<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Value Hacker v16.2 (Filtro Inteligente de Yield)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- VARIABLES GLOBALES --- */
        :root {
            --bg-dark: #1f2937; /* Gris Oscuro */
            --bg-medium: #374151; /* Gris Medio */
            --bg-light: #4b5563; /* Gris Claro */
            --text-primary: #f3f4f6; /* Blanco/Gris Muy Claro */
            --text-secondary: #9ca3af; /* Gris de Texto */
            --accent: #f59e0b; /* Naranja Brillante */
            --success: #10b981; /* Verde */
            --danger: #ef4444; /* Rojo */
            --info: #3b82f6; /* Azul */
            --stats-accent: #22c55e; /* Verde m√°s brillante */
            --kpi-border: #4ade80; /* Borde de KPI */
            --kpi-bg: #153229; /* Fondo de KPI */
            --market-H: #a78bfa; /* Morado para Local */
            --market-D: #94a3b8; /* Gris azulado para Empate */
            --market-A: #f87171; /* Rojo claro para Visita */
            --market-O25: #22c55e; /* Verde para Over */
            --market-U25: #3b82f6; /* Azul para Under */
        }

        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        h1, h2, h3 { color: var(--text-primary); }
        hr.separator { border-color: var(--bg-light); margin: 20px 0; }
        
        /* --- LAYOUT PRINCIPAL (Contenedores) --- */
        #sidebar {
            width: 300px;
            background-color: var(--bg-medium);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease-in-out;
            flex-shrink: 0;
            overflow-y: auto;
        }

        #mainContent {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* --- Responsive / Mobile Menu --- */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 1024px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                z-index: 999;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            .menu-toggle {
                display: block;
            }
            #mainContent {
                padding-top: 60px; /* Espacio para el bot√≥n de men√∫ */
            }
        }
        
        /* --- FORMULARIO Y ENTRADAS --- */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        input[type="text"], input[type="number"], select, .file-input-wrapper {
            width: 100%;
            padding: 8px;
            margin-top: 3px;
            border: 1px solid var(--bg-light);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: var(--bg-light);
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .file-input-wrapper {
            display: flex;
            align-items: center;
            padding: 0;
            border: 2px dashed var(--accent);
            background-color: var(--bg-medium);
            cursor: pointer;
        }
        
        .file-input-wrapper input[type="file"] {
            display: none;
        }
        
        .file-input-wrapper label {
            flex-grow: 1;
            padding: 8px;
            margin: 0;
            cursor: pointer;
            color: var(--accent);
            text-align: center;
        }
        
        .file-list-item {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
            background-color: var(--bg-light);
            padding: 5px 8px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* --- BOTONES --- */
        .btn {
            display: inline-block;
            padding: 10px 15px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--bg-dark);
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-primary);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: var(--text-primary);
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        /* --- TABS --- */
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab-button {
            flex-grow: 1;
            padding: 10px;
            cursor: pointer;
            background-color: var(--bg-light);
            color: var(--text-secondary);
            border: none;
            border-bottom: 3px solid var(--bg-light);
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-button.active {
            background-color: var(--bg-dark);
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
        }

        .tab-content {
            padding: 10px 0;
        }
        
        /* --- KPI CARDS --- */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background-color: var(--bg-medium);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--kpi-border);
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .kpi-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1.2;
        }
        
        .kpi-small {
            font-size: 1.2rem;
        }
        
        /* --- COLORES DE ESTADO/TEXTO --- */
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-blue { color: var(--info); }
        .text-orange { color: var(--accent); }
        .text-warning { color: #facc15; }

        /* --- TABLAS --- */
        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        table thead th {
            background-color: var(--bg-light);
            color: var(--text-primary);
            padding: 10px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table tbody td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--bg-medium);
            text-align: center;
            color: var(--text-primary);
        }

        table tbody tr:nth-child(even) {
            background-color: var(--bg-medium);
        }
        
        table tbody tr:hover {
             background-color: #3f4e61;
        }

        /* Styling for Value Bets Table */
        .market-H { background-color: rgba(167, 139, 250, 0.1); }
        .market-D { background-color: rgba(148, 163, 184, 0.1); }
        .market-A { background-color: rgba(248, 113, 113, 0.1); }
        .market-O25 { background-color: rgba(34, 197, 94, 0.1); }
        .market-U25 { background-color: rgba(59, 130, 246, 0.1); }

        /* --- REGISTRO DE APUESTAS (Placed Bets) --- */
        .status-pending { background-color: var(--info); color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 0.75rem;}
        .status-win { background-color: var(--success); color: var(--bg-dark); padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 0.75rem;}
        .status-lose { background-color: var(--danger); color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 0.75rem;}
        .status-push { background-color: var(--accent); color: var(--bg-dark); padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 0.75rem;}
        
        .btn-status {
            font-size: 0.65rem;
            padding: 1px 4px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-win { background-color: var(--success); }
        .btn-lose { background-color: var(--danger); color: white; }
        .btn-push { background-color: var(--accent); }
        
        /* --- GR√ÅFICOS --- */
        .chart-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
            min-height: 300px;
        }
        
        .chart-box {
            background-color: var(--bg-medium);
            padding: 15px;
            border-radius: 8px;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10000;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <div id="loadingMessage">Cargando...</div>
    </div>
    
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <aside id="sidebar">
        <h2><i class="fas fa-cog"></i> Configuraci√≥n del Modelo</h2>
        
        <div class="tabs">
            <button class="tab-button active" id="tabConfigBtn" onclick="switchTab('config')">Configuraci√≥n</button>
            <button class="tab-button" id="tabEstadisticasBtn" onclick="switchTab('estadisticas')">Estad√≠sticas</button>
        </div>
        
        <div id="tabConfig" class="tab-content" style="display: block;">
            
            <h3 style="margin-top: 0;"><i class="fas fa-database"></i> Carga de Datos</h3>

            <div class="form-group">
                <label for="historicalFile">Archivos de Historial (Goles y Cuotas)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="historicalFile" accept=".csv" multiple onchange="loadHistoricalFiles(event)">
                    <label for="historicalFile">Seleccionar Archivos CSV</label>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                     Archivos: <span id="histFileCount">0</span> | Partidos: <span id="histMatchCount">0</span>
                </div>
                <div id="historicalFileList" style="max-height: 80px; overflow-y: auto; margin-top: 5px; padding-right: 5px;">
                     No hay archivos de historial cargados.
                </div>
            </div>

            <div class="form-group">
                <label for="futureFile">Partidos a Analizar (Cuotas)</label>
                <div class="file-input-wrapper" style="border-color: var(--success);">
                    <input type="file" id="futureFile" accept=".csv" onchange="loadFutureFile(event)">
                    <label for="futureFile">Seleccionar Archivo CSV Futuro</label>
                </div>
                <input type="text" id="urlInputFuture" value="" readonly style="margin-top: 5px; font-size: 0.8rem; border-color: var(--success);">
            </div>

            <hr class="separator">

            <h3><i class="fas fa-sliders-h"></i> Filtros de EV+</h3>
            
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex:1;">
                    <label for="minEV">EV M√≠nimo (%)</label>
                    <input type="number" id="minEV" value="5.0" min="0.1" step="0.1">
                </div>
                <div style="flex:1;">
                    <label for="marketSelect">Mercado a Filtrar</label>
                    <select id="marketSelect">
                        <option value="all">TODOS</option>
                        <option value="H">1X2 (Local)</option>
                        <option value="D">1X2 (Empate)</option>
                        <option value="A">1X2 (Visita)</option>
                        <option value="O25">Goles (+2.5)</option>
                        <option value="U25">Goles (-2.5)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex:1;">
                    <label for="minOdds">Cuota M√≠nima</label>
                    <input type="number" id="minOdds" value="1.50" min="1.01" step="0.01">
                </div>
                <div style="flex:1;">
                    <label for="maxOdds">Cuota M√°xima</label>
                    <input type="number" id="maxOdds" value="5.00" min="1.01" step="0.01">
                </div>
            </div>
            
            <div class="form-group">
                 <label for="leagueSelect">Ligas a Analizar</label>
                 <select id="leagueSelect">
                     <option value="all">Todas</option>
                 </select>
            </div>

            <div class="form-group">
                <input type="checkbox" id="useFrequencyValue" checked>
                <label for="useFrequencyValue" style="display:inline; margin-left: 5px;">Aplicar solo si EV+ &gt; M√≠nimo</label>
            </div>
            
            <div class="form-group">
                <input type="checkbox" id="useProfitFilter" checked>
                <label for="useProfitFilter" style="display:inline; margin-left: 5px; color: var(--stats-accent); font-weight:bold;">
                    Aplicar Filtro Inteligente (Solo mercados rentables)
                </label>
            </div>

            <hr class="separator">

            <h3><i class="fas fa-hand-holding-usd"></i> Gesti√≥n de Banca y Stake</h3>
            
            <div class="form-group">
                <label for="initialBank">Banca Inicial</label>
                <input type="number" id="initialBank" value="1000.00" min="100" step="10">
            </div>

            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex:1;">
                    <label for="stakeType">Tipo de Stake</label>
                    <select id="stakeType">
                        <option value="kelly">Kelly Fraccional</option>
                        <option value="flat">Plano (Fijo)</option>
                        <option value="percent">Porcentaje de Banca</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label for="stakeValue">Valor (K, %, Fijo)</label>
                    <input type="number" id="stakeValue" value="33" min="0.1" step="1">
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%;" onclick="runAnalysis()">
                <i class="fas fa-rocket"></i> Ejecutar An√°lisis y Backtest
            </button>
        </div>
        
        <div id="tabEstadisticas" class="tab-content" style="display: none;">
            
            <h3 style="margin-top: 0;"><i class="fas fa-chart-line"></i> Factor de Local√≠a (HAD)</h3>
            <div class="table-scroll" style="max-height: 200px;">
                <table id="hadTable">
                    <thead>
                        <tr>
                            <th style="text-align:left;">Liga</th>
                            <th>Partidos</th>
                            <th>Factor</th>
                            <th>Correcci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="hadTableBody">
                        <tr><td colspan="4" style="text-align:center;">Cargue archivos de Historial para calcular el factor HAD.</td></tr>
                    </tbody>
                </table>
            </div>

            <hr class="separator">

            <h3><i class="fas fa-calculator"></i> An√°lisis Manual</h3>
            <div class="form-group">
                 <label for="teamHomeSelect">Equipo Local</label>
                 <select id="teamHomeSelect"><option value="">Seleccionar</option></select>
            </div>
            <div class="form-group">
                 <label for="teamAwaySelect">Equipo Visitante</label>
                 <select id="teamAwaySelect"><option value="">Seleccionar</option></select>
            </div>
            
            <button class="btn btn-secondary" style="width: 100%;" onclick="analyzeMatchup()">
                <i class="fas fa-search"></i> Calcular Matchup
            </button>

            <div id="statsCard" class="kpi-card" style="margin-top: 15px; text-align: left; border-left: 5px solid var(--accent); display:none;">
                <h3 style="color:var(--stats-accent); margin-top:0;">Coeficientes de Poder</h3>
                </div>

        </div>

    </aside>

    <main id="mainContent">
        <h1>üìä Value Hacker (An√°lisis EV+ y Backtest)</h1>
        
        <div class="kpi-container">
            <div class="kpi-card" style="border-color:var(--info);">
                <div class="kpi-title">Banca Actual</div>
                <div id="currentBankValue" class="kpi-value">0.00</div>
            </div>
            <div class="kpi-card" style="border-color:var(--success);">
                <div class="kpi-title">Profit Neto</div>
                <div id="totalProfitValue" class="kpi-value text-blue">0.00</div>
            </div>
            <div class="kpi-card" style="border-color:var(--accent);">
                <div class="kpi-title">Yield (%) Real</div>
                <div id="avgYieldValue" class="kpi-value text-orange">0.00%</div>
            </div>
            <div class="kpi-card" style="border-color:var(--danger);">
                <div class="kpi-title">Apuestas Registradas</div>
                <div id="resolvedBetsCount" class="kpi-value text-small">0</div>
            </div>
        </div>

        <section id="valueBetsSection" style="margin-top: 30px; display: none;">
            <h2>‚≠ê Oportunidades de Valor Esperado (EV+)</h2>
            <div class="kpi-container" style="grid-template-columns: repeat(3, 1fr);">
                <div class="kpi-card" style="border-left: 5px solid var(--info);">
                    <div class="kpi-title">Partidos Analizados</div>
                    <div id="valBets" class="kpi-value kpi-small">0</div>
                </div>
                <div class="kpi-card" style="border-left: 5px solid var(--success);">
                    <div class="kpi-title">Apuestas EV+ Encontradas</div>
                    <div id="valEVPlus" class="kpi-value kpi-small">0</div>
                </div>
                 <div class="kpi-card" style="border-left: 5px solid var(--accent);">
                    <div class="kpi-title">EV M√°ximo</div>
                    <div id="valMaxEV" class="kpi-value kpi-small">0.00%</div>
                </div>
            </div>

            <div class="table-scroll">
                <table id="valueBetsTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Partido</th>
                            <th>Mercado</th>
                            <th>Cuota</th>
                            <th>Cuota Justa</th>
                            <th>EV %</th>
                            <th>Stake</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="valueBetsTableBody">
                        </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-start;">
                <button class="btn btn-secondary" onclick="downloadValueBets()">
                    <i class="fas fa-download"></i> Descargar CSV
                </button>
            </div>
        </section>

        <hr class="separator">

        <section id="historicalAnalysis" style="margin-top: 30px; display: none;">
            <h2>üìà An√°lisis de Rendimiento Hist√≥rico (Backtest)</h2>
            <p style="color:var(--text-secondary);">Simulaci√≥n de la estrategia usando un filtro de EV+ &gt; 5% y stake Kelly fraccional (K=33) en todo el historial cargado.</p>
            
            <div class="chart-container">
                 <div class="chart-box"><canvas id="equityChart"></canvas></div>
                 <div class="chart-box"><canvas id="drawdownChart"></canvas></div>
                 <div class="chart-box"><canvas id="leagueChart"></canvas></div>
            </div>
            
            <div id="statsCardBacktest" class="kpi-card" style="margin-top: 20px; text-align: left; border-left: 5px solid var(--accent); min-width:auto; background-color: var(--bg-medium);">
                </div>
        </section>

        <hr class="separator">

        <section id="placedBetsSection" style="margin-top: 30px;">
            <h2>üí∞ Registro de Apuestas (Banca: <span id="bankLabel" class="text-green">0.00</span>)</h2>
            <div class="table-scroll" style="max-height: 350px;">
                <table id="placedBetsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Partido (Mercado)</th>
                            <th>Cuota (EV)</th>
                            <th>Stake</th>
                            <th>Profit</th>
                            <th>Resultado/Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="placedBetsTableBody">
                        <tr><td colspan="7" style="text-align:center;">No hay apuestas registradas.</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                 <button class="btn btn-danger" onclick="clearPlacedBets()">
                    <i class="fas fa-trash-alt"></i> Borrar Historial de Apuestas
                </button>
            </div>
        </section>

    </main>

<script>
    // *** COMIENZO DE LA L√ìGICA JAVASCRIPT - VALUE HACKER v16.2 (FILTRO INTELIGENTE) ***
    let historicalData = []; 
    let futureData = []; 
    let currentStats = null; 
    let leagueHADFactors = {}; 
    let valueBetsResults = []; 
    let placedBets = []; 
    
    let chartEq=null, chartLg=null, chartDD=null; 
    let historicalFileNames = []; 

    // *** NUEVA VARIABLE GLOBAL PARA ALMACENAR LOS MERCADOS RENTABLES ***
    let profitableMarkets = new Set(); 

    // --- L√≥gica de Barra Lateral M√≥vil ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // --- Tabs Logic ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

        const content = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
        if (content) content.style.display = 'block';

        document.getElementById('tabConfigBtn').classList.remove('active');
        document.getElementById('tabEstadisticasBtn').classList.remove('active');
        
        const btnId = tabId === 'estadisticas' ? 'tabEstadisticasBtn' : 'tabConfigBtn';
        if (document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
        
        if (tabId === 'estadisticas') {
             updateHADTable(leagueHADFactors);
        }
    }
    
    // --- FUNCIONES MATEM√ÅTICAS ---
    function calculateKellyStake(p, o, denominator) {
        const b = o - 1;
        const q = 1 - p;
        let f = ((b * p) - q) / b;
        f = f / denominator;
        return Math.max(0.005, f);
    }

    const factorialCache = [1];
    function factorial(n) {
        if (n < factorialCache.length) return factorialCache[n];
        if (n === 0 || n === 1) return 1;
        for (let i = factorialCache.length; i <= n; i++) {
            if (factorialCache[i - 1] * i > Number.MAX_SAFE_INTEGER) {
                factorialCache[i] = Number.MAX_SAFE_INTEGER;
            } else {
                factorialCache[i] = factorialCache[i - 1] * i;
            }
        }
        return factorialCache[n];
    }

    function poisson(lambda, k) {
        const limitedLambda = Math.min(20, lambda); 
        if (limitedLambda < 0 || k < 0) return 0;
        return (Math.exp(-limitedLambda) * Math.pow(limitedLambda, k)) / factorial(k);
    }
    
    // --- CARGA Y PROCESAMIENTO DE DATOS ---
    function parseCSVFile(file) {
         return new Promise((resolve, reject) => {
            Papa.parse(file, {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: (results) => {
                    const validData = results.data.filter(r => Object.keys(r).length > 0 && r.HomeTeam);
                    resolve({ data: validData, name: file.name });
                },
                error: (error, file) => { reject(`Error de parsing en el archivo ${file.name}. Mensaje: ${error.message}`); }
            });
        });
    }
    
    async function loadHistoricalFiles(e) {
        const files = e.target.files;
        if (files.length === 0) return;
        if (files.length > 30) {
             alert("L√≠mite de 30 archivos de historial excedido. Por favor, selecciona 30 o menos.");
             e.target.value = '';
             return;
        }
        document.getElementById('loadingMessage').innerText = `Cargando ${files.length} archivos de historial...`;
        document.getElementById('loadingOverlay').style.display = 'flex';
        historicalData = []; historicalFileNames = [];
        try {
            const filePromises = Array.from(files).map(file => parseCSVFile(file));
            const results = await Promise.all(filePromises);
            results.forEach(res => { historicalData.push(...res.data); historicalFileNames.push(res.name); });
            processAllData();
        } catch (error) {
            console.error("Error al cargar archivos de historial:", error);
            alert(`‚ùå Error cargando archivos de historial:\n\n${error}`);
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }
    
    async function loadFutureFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('loadingMessage').innerText = `Cargando partidos a analizar: ${file.name}...`;
        document.getElementById('loadingOverlay').style.display = 'flex';
        futureData = [];
        document.getElementById('urlInputFuture').value = '';
        try {
            const result = await parseCSVFile(file);
            futureData = result.data;
            document.getElementById('urlInputFuture').value = result.name;
            processAllData();
        } catch (error) {
            console.error("Error al cargar archivo futuro:", error);
            alert(`‚ùå Error cargando archivo futuro:\n\n${error}`);
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }
    
    function normalizeData(data, isFuture) {
        const parseNum = (val) => { if (typeof val === 'number') return val; if (typeof val === 'string') return parseFloat(val); return null; };
        const getOdds = (key1, key2) => {
            let val1 = parseNum(key1); let val2 = parseNum(key2);
            let val = (val1 && val1 > 1.01) ? val1 : val2;
            return (val && val > 1.01) ? val : 1.01;
        };
        const getGoal = (key) => { let val = parseNum(key); return (val !== null && !isNaN(val) && val >= 0) ? Math.floor(val) : null; }
        
        return data.map(r => {
            if(!r.Date || !r.HomeTeam) return null;
            let d = r.Date; 
            if(typeof d === 'string') {
                if (d.includes('/')) {
                    const p = d.split('/');
                    if (p.length === 3) { let year = p[2]; if (year.length === 2) year = (parseInt(year) > 70 ? '19' : '20') + year; d = `${year}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
                } else if (d.includes('.')) {
                    const p = d.split('.');
                    if (p.length === 3) d = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                }
            }
            const oddsH = getOdds(r.CLH, r.B365H);
            const oddsD = getOdds(r.CLD, r.B365D);
            const oddsA = getOdds(r.CLA, r.B365A);
            const oddsO25 = getOdds(r['CL>2.5'], r['B365>2.5']);
            const oddsU25 = getOdds(r['CL<2.5'], r['B365<2.5']);

            return {
                date:d, league:r.Div || 'N/A', home:r.HomeTeam, away:r.AwayTeam, 
                res:isFuture ? null : r.FTR, 
                goalsH:isFuture ? null : getGoal(r.FTHG), 
                goalsA:isFuture ? null : getGoal(r.FTAG),
                oddsH, oddsD, oddsA, oddsO25, oddsU25,
                isFuture: isFuture 
            };
        }).filter(x=>x && x.oddsH > 1.01); 
    }

    function processAllData() {
        document.getElementById('loadingMessage').innerText = "Procesando y Calculando Coeficientes...";

        const normalizedHistorical = normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null);
        normalizedHistorical.sort((a, b) => a.date.localeCompare(b.date));
        
        updateHistoricalFileList(normalizedHistorical.length);

        leagueHADFactors = calculateLeagueHAD(normalizedHistorical);
        updateHADTable(leagueHADFactors);

        currentStats = calculateCurrentSeasonStats(normalizedHistorical);
        
        const normalizedFuture = normalizeData(futureData, true);
        normalizedFuture.sort((a, b) => a.date.localeCompare(b.date));

        if(currentStats) {
            const teams = Object.keys(currentStats.teamCoeffs).sort();
            const populate = (id) => {
                const s = document.getElementById(id); const currentVal = s.value; s.innerHTML='<option value="">Seleccionar</option>';
                teams.forEach(t => s.add(new Option(t,t))); if (teams.includes(currentVal)) s.value = currentVal; 
            };
            populate('teamHomeSelect'); populate('teamAwaySelect');
        }
        
        const allLeagues = [...new Set([...normalizedHistorical.map(x=>x.league), ...normalizedFuture.map(x=>x.league)])].sort();
        const lgSel = document.getElementById('leagueSelect'); lgSel.innerHTML='<option value="all">Todas</option>';
        allLeagues.forEach(l=>lgSel.add(new Option(l,l)));

        document.getElementById('historicalAnalysis').style.display = normalizedHistorical.length > 0 ? 'block' : 'none';

        document.getElementById('loadingOverlay').style.display='none';
        
        if (normalizedFuture.length > 0 && currentStats) {
            futureData = normalizedFuture; 
            runAnalysis();
        } else if (normalizedHistorical.length > 0) {
            runHistoricalBacktest(normalizedHistorical);
            updateGlobalUI(0, 0, 0, []); 
        }
    }
    
    function updateHistoricalFileList(matchCount) {
        const listEl = document.getElementById('historicalFileList');
        const fileCountEl = document.getElementById('histFileCount');
        const matchCountEl = document.getElementById('histMatchCount');
        
        fileCountEl.innerText = historicalFileNames.length;
        matchCountEl.innerText = matchCount;

        if (historicalFileNames.length === 0) {
            listEl.innerHTML = 'No hay archivos de historial cargados.';
            return;
        }
        listEl.innerHTML = historicalFileNames.map(name => 
            `<div class="file-list-item"><i class="fas fa-check-circle" style="color:var(--success);"></i> ${name}</div>`
        ).join('');
    }
    
    function calculateLeagueHAD(data) {
         const leagueTotals = {};
        const minMatches = 15; 
        let globalHomeGoals = 0;
        let globalMatches = 0;

        data.forEach(r => {
            const league = r.league;
            if (!leagueTotals[league]) {
                leagueTotals[league] = { totalMatches: 0, totalHomeGoals: 0, expectedHomeGoals: 0, leagueGames: [] };
            }
            leagueTotals[league].leagueGames.push(r);
            globalHomeGoals += r.goalsH;
            globalMatches++;
        });
        
        if (globalMatches === 0) return {};
        const initialGlobalStats = calculateCurrentSeasonStats(data, 1.0); 
        if (!initialGlobalStats) return {};

        for (const league in leagueTotals) {
            const games = leagueTotals[league].leagueGames;
            let sumExpectedGoals = 0;

            games.forEach(r => {
                const homeCoeffs = initialGlobalStats.teamCoeffs[r.home];
                const awayCoeffs = initialGlobalStats.teamCoeffs[r.away];

                if (homeCoeffs && awayCoeffs) {
                    const lambdaH_initial = homeCoeffs.attH_factor * awayCoeffs.defA_factor * initialGlobalStats.globalAverages.avgGoalsHome;
                    sumExpectedGoals += lambdaH_initial;
                }
                leagueTotals[league].totalMatches++;
                leagueTotals[league].totalHomeGoals += r.goalsH;
            });
            
            leagueTotals[league].expectedHomeGoals = sumExpectedGoals;

            if (leagueTotals[league].totalMatches >= minMatches && sumExpectedGoals > 0) {
                const actualHomeAvg = leagueTotals[league].totalHomeGoals / leagueTotals[league].totalMatches;
                const expectedHomeAvg = leagueTotals[league].expectedHomeGoals / leagueTotals[league].totalMatches;
                
                let hadFactor = actualHomeAvg / expectedHomeAvg;
                hadFactor = Math.max(0.8, Math.min(1.5, hadFactor)); 

                leagueHADFactors[league] = {
                    factor: hadFactor, matches: leagueTotals[league].totalMatches, correction: `x${hadFactor.toFixed(3)}`
                };
            }
        }

        const globalActualHomeAvg = globalHomeGoals / globalMatches;
        const globalExpectedHomeAvg = Object.values(leagueTotals).reduce((sum, l) => sum + l.expectedHomeGoals, 0) / globalMatches;
        let globalHADFactor = (globalExpectedHomeAvg > 0) ? (globalActualHomeAvg / globalExpectedHomeAvg) : 1.0;
        globalHADFactor = Math.max(0.8, Math.min(1.5, globalHADFactor)); 

        leagueHADFactors['GLOBAL'] = {
            factor: globalHADFactor, matches: globalMatches, correction: `x${globalHADFactor.toFixed(3)}`
        };
        
        return leagueHADFactors;
    }

    function calculateCurrentSeasonStats(data, decayOverride = null) {
        const teamStats = {};
        let totalMatchesWeighted = 0;
        let totalHomeGoalsWeighted = 0;
        let totalAwayGoalsWeighted = 0;
        const numMatches = data.length;

        data.forEach((r, index) => {
            if(r.goalsH >= 0 && r.goalsA >= 0) {
                const decayFactor = decayOverride !== null ? decayOverride : (0.75 + (index / numMatches) * 0.25); 

                totalMatchesWeighted += decayFactor;
                totalHomeGoalsWeighted += r.goalsH * decayFactor;
                totalAwayGoalsWeighted += r.goalsA * decayFactor;

                const updateStats = (team, goalsScored, goalsConceded, isHome) => {
                    if (!teamStats[team]) { teamStats[team] = { playedH: 0, scoredH: 0, concededH: 0, playedA: 0, scoredA: 0, concededA: 0, gd: 0, weightH: 0, weightA: 0 };}
                    teamStats[team].gd += goalsScored - goalsConceded;
                    
                    if (isHome) {
                        teamStats[team].playedH++; teamStats[team].scoredH += goalsScored * decayFactor;
                        teamStats[team].concededH += goalsConceded * decayFactor; teamStats[team].weightH += decayFactor;
                    } else {
                        teamStats[team].playedA++; teamStats[team].scoredA += goalsScored * decayFactor;
                        teamStats[team].concededA += goalsConceded * decayFactor; teamStats[team].weightA += decayFactor;
                    }
                };
                updateStats(r.home, r.goalsH, r.goalsA, true);
                updateStats(r.away, r.goalsA, r.goalsH, false);
            }
        });
        
        if (totalMatchesWeighted === 0) return null;

        const avgGoalsHome = totalHomeGoalsWeighted / totalMatchesWeighted;
        const avgGoalsAway = totalAwayGoalsWeighted / totalMatchesWeighted;

        const teamCoeffs = {};
        for (const team in teamStats) {
            const stats = teamStats[team];
            
            const calculateFactor = (weightedGoals, totalWeight, avgGlobalGoals) => {
                if (totalWeight < 1 || avgGlobalGoals <= 0.001) return 1.0; 
                return (weightedGoals / totalWeight) / avgGlobalGoals;
            };

            const attH_factor = calculateFactor(stats.scoredH, stats.weightH, avgGoalsHome);
            const defH_factor = calculateFactor(stats.concededH, stats.weightH, avgGoalsAway);
            const attA_factor = calculateFactor(stats.scoredA, stats.weightA, avgGoalsAway);
            const defA_factor = calculateFactor(stats.concededA, stats.weightA, avgGoalsHome); 

            let powerFactor = 1.0;
            if (stats.playedH + stats.playedA >= 5) {
                const gdPower = stats.gd / (stats.playedH + stats.playedA);
                powerFactor = 1 + (gdPower * 0.05); 
            }
            
            teamCoeffs[team] = { 
                attH_factor, defH_factor, attA_factor, defA_factor,
                playedH: stats.playedH, playedA: stats.playedA,
                powerFactor: Math.max(0.5, Math.min(1.5, powerFactor)) 
            };
        }

        return {
            globalAverages: { avgGoalsHome, avgGoalsAway, totalMatches: totalMatchesWeighted }, 
            teamCoeffs: teamCoeffs
        };
    }
    
    function calculateHybridProbabilities(homeTeam, awayTeam, league, stats, hadFactors) {
        if (!stats) return null;
        const { globalAverages, teamCoeffs } = stats;
        const homeCoeffs = teamCoeffs[homeTeam];
        const awayCoeffs = teamCoeffs[awayTeam];
        
        if (!homeCoeffs || !awayCoeffs) return null;

        let hadFactor = 1.0;
        if (hadFactors[league] && hadFactors[league].matches >= 15) {
            hadFactor = hadFactors[league].factor;
        } else if (hadFactors['GLOBAL']) {
            hadFactor = hadFactors['GLOBAL'].factor;
        }

        const lambdaH = homeCoeffs.attH_factor * awayCoeffs.defA_factor * globalAverages.avgGoalsHome * hadFactor;
        const lambdaA = awayCoeffs.attA_factor * homeCoeffs.defH_factor * globalAverages.avgGoalsAway;

        const maxGoals = 5; 
        let pHomeRaw = 0, pDrawRaw = 0, pAwayRaw = 0;
        
        for (let h = 0; h <= maxGoals; h++) {
            for (let a = 0; a <= maxGoals; a++) {
                const p = poisson(lambdaH, h) * poisson(lambdaA, a);
                if (h > a) pHomeRaw += p;
                else if (h < a) pAwayRaw += p;
                else pDrawRaw += p;
            }
        }
        const sumRaw = pHomeRaw + pDrawRaw + pAwayRaw;
        
        let pHome = pHomeRaw / sumRaw;
        let pDraw = pDrawRaw / sumRaw;
        let pAway = pAwayRaw / sumRaw;
        
        const powerH = homeCoeffs.powerFactor || 1.0;
        const powerA = awayCoeffs.powerFactor || 1.0;
        
        pHome *= powerH; pAway *= powerA;
        
        let sum1X2 = pHome + pDraw + pAway;
        if (sum1X2 === 0) sum1X2 = 1; 

        pHome /= sum1X2; pDraw /= sum1X2; pAway /= sum1X2;
        
        let pUnder25 = 0;
        for (let h = 0; h <= 2; h++) {
            for (let a = 0; a <= 2; a++) {
                if (h + a < 3) { pUnder25 += poisson(lambdaH, h) * poisson(lambdaA, a); }
            }
        }
        const pOver25 = 1 - pUnder25;
        
        return {
            pHome, pDraw, pAway, pOver25, pUnder25,
            lambdaH, lambdaA, hadFactor: hadFactor
        };
    }
    
    // --- FUNCI√ìN PRINCIPAL DE FILTRADO DE VALOR (EV+) ---
    function runAnalysis() {
        document.getElementById('sidebar').classList.remove('open');
        
        if(!futureData.length || !currentStats) {
            document.getElementById('statsCard').style.display = 'block';
            const histData = normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null);
            
            if (histData.length === 0) { document.getElementById('statsCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">Cargue la **estad√≠stica pasada** (con goles) para calcular el modelo.</h3>`; } 
            else if (futureData.length === 0) { document.getElementById('statsCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">Cargue los **partidos a analizar** (con cuotas).</h3>`; }
            
            if(histData.length > 0) runHistoricalBacktest(histData);
            return;
        }
        
        document.getElementById('loadingMessage').innerText = "Filtrando Oportunidades de Valor Esperado (EV+) y Calculando Stake...";
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        const mktFilter = document.getElementById('marketSelect').value;
        const useValueFilter = document.getElementById('useFrequencyValue').checked; 
        const useProfitFilter = document.getElementById('useProfitFilter').checked; // NUEVO
        const stT = document.getElementById('stakeType').value;
        const stV = parseFloat(document.getElementById('stakeValue').value);
        const bank0 = getBankValue(); 
        const minO = parseFloat(document.getElementById('minOdds').value);
        const maxO = parseFloat(document.getElementById('maxOdds').value); 
        const minEV = parseFloat(document.getElementById('minEV').value) / 100; 
        const lg = document.getElementById('leagueSelect').value;
        
        valueBetsResults = []; 
        let totalAnalyzed = 0;
        let maxEV = 0;

        // EJECUTAR BACKTEST PRIMERO PARA OBTENER LOS MERCADOS RENTABLES
        if (historicalData.length > 0) {
            runHistoricalBacktest(normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null));
        }

        const filteredFutureData = futureData.filter(r => lg==='all' || r.league===lg);
        const marketsToAnalyze = mktFilter === 'all' ? ['H', 'D', 'A', 'O25', 'U25'] : [mktFilter];

        filteredFutureData.forEach(r => {
            totalAnalyzed++;
            
            const hybridRes = calculateHybridProbabilities(r.home, r.away, r.league, currentStats, leagueHADFactors);
            if (!hybridRes) return; 

            marketsToAnalyze.forEach(mkt => {
                let pModel, oddsH, label;
                if(mkt==='H') { pModel=hybridRes.pHome; oddsH=r.oddsH; label='Local (1)'; }
                else if(mkt==='D') { pModel=hybridRes.pDraw; oddsH=r.oddsD; label='Empate (X)'; }
                else if(mkt==='A') { pModel=hybridRes.pAway; oddsH=r.oddsA; label='Visita (2)'; }
                else if(mkt==='O25') { pModel=hybridRes.pOver25; oddsH=r.oddsO25; label='Over 2.5'; }
                else if(mkt==='U25') { pModel=hybridRes.pUnder25; oddsH=r.oddsU25; label='Under 2.5'; }
                else return;

                const oddsFair = pModel > 0 ? (1 / pModel) : 0;
                
                if (oddsH < minO || oddsH > maxO || oddsFair === 0) return; 
                if (oddsH <= oddsFair) return; 

                const edge = (pModel * oddsH) - 1; 
                const EV_percent = edge * 100;
                const isValueBet = edge > minEV;
                
                if (useValueFilter && !isValueBet) return;
                
                // *************************************************************************
                // ** NUEVA REGLA: SOLO INCLUIR SI EL MERCADO FUE RENTABLE EN EL BACKTEST **
                // *************************************************************************
                if (useProfitFilter && profitableMarkets.size > 0 && !profitableMarkets.has(mkt)) {
                    return; 
                }
                // *************************************************************************

                if (EV_percent > maxEV) maxEV = EV_percent;

                let actualStake = 0;
                if (stT === 'flat') {
                    actualStake = stV;
                } else if (stT === 'percent') {
                    actualStake = bank0 * (stV / 100);
                } else if (stT === 'kelly') {
                    const kellyDenominator = stV;
                    let kellyFraction = calculateKellyStake(pModel, oddsH, kellyDenominator);
                    kellyFraction = Math.min(kellyFraction, 0.10); 
                    actualStake = bank0 * kellyFraction;
                }

                actualStake = Math.max(0.01, actualStake); 
                actualStake = parseFloat(actualStake.toFixed(2));
                
                // Comprobaci√≥n para evitar duplicados en la lista de resultados de valor
                const isAlreadyPlaced = placedBets.some(b => 
                    b.match === `${r.home} vs ${r.away}` && 
                    b.market === mkt && 
                    b.date === r.date
                );

                valueBetsResults.push({
                    date: r.date,
                    league: r.league, 
                    match: `${r.home} vs ${r.away}`,
                    market: mkt,
                    marketLabel: label,
                    odds: oddsH,
                    oddsFair: oddsFair,
                    EV: EV_percent,
                    stake: actualStake,
                    isPlaced: isAlreadyPlaced 
                });
            });
        });

        updateGlobalUI(totalAnalyzed, valueBetsResults.length, maxEV, valueBetsResults);
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    // --- L√ìGICA DE REGISTRO PERSISTENTE (localStorage) ---
    
    function getBankValue() {
         const bankInput = parseFloat(document.getElementById('initialBank').value);
         const resolvedProfit = placedBets.filter(b => b.result !== 'PENDIENTE').reduce((sum, b) => sum + b.profit, 0);
         return bankInput + resolvedProfit;
    }

    function loadPlacedBets() {
        try {
            const storedBets = localStorage.getItem('placedBets');
            placedBets = storedBets ? JSON.parse(storedBets) : [];
            updatePlacedBetsUI();
        } catch (e) {
            console.error("Error cargando apuestas de localStorage", e);
            placedBets = [];
        }
    }

    function savePlacedBets() {
        try {
            localStorage.setItem('placedBets', JSON.stringify(placedBets));
            updatePlacedBetsUI();
        } catch (e) {
            console.error("Error guardando apuestas en localStorage", e);
            alert("No se pudieron guardar los datos. El almacenamiento local puede estar lleno.");
        }
    }

    function generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
    }

    function addBetToRegistry(betData) {
        const exists = placedBets.some(b => 
            b.match === betData.match && 
            b.market === betData.market && 
            b.date === betData.date
        );

        if (exists) {
            alert(`La apuesta ${betData.marketLabel} en ${betData.match} ya est√° registrada.`);
            return;
        }

        const newBet = {
            id: generateUniqueId(),
            ...betData,
            result: 'PENDIENTE', 
            profit: 0.00
        };
        
        placedBets.push(newBet);
        savePlacedBets();
        
        // Refrescar la tabla de ValueBets para mostrar 'Registrada'
        const index = valueBetsResults.findIndex(b => 
            b.match === betData.match && 
            b.market === betData.market
        );
        if(index !== -1) {
            valueBetsResults[index].isPlaced = true;
            updateGlobalUI(valueBetsResults.length, valueBetsResults.length, parseFloat(document.getElementById('valMaxEV').innerText), valueBetsResults);
        }
    }

    function updateBetResult(id, result) {
        const index = placedBets.findIndex(b => b.id === id);
        if (index === -1) return;

        const bet = placedBets[index];
        const stake = bet.stake;
        const odds = bet.odds;
        let profit = 0;

        if (result === 'WIN') {
            profit = stake * odds - stake; 
        } else if (result === 'LOSE') {
            profit = -stake; 
        } else if (result === 'PUSH') {
            profit = 0; 
        } else {
            result = 'PENDIENTE';
            profit = 0;
        }
        
        bet.result = result;
        bet.profit = parseFloat(profit.toFixed(2));
        
        savePlacedBets();
    }

    function updatePlacedBetsUI() {
        const tbody = document.getElementById('placedBetsTableBody');
        tbody.innerHTML = '';
        
        placedBets.sort((a, b) => a.date.localeCompare(b.date));

        let totalWagered = 0;
        let totalProfit = 0;
        let resolvedCount = 0;

        placedBets.forEach(b => {
            const statusClass = b.result === 'WIN' ? 'status-win' : (b.result === 'LOSE' ? 'status-lose' : (b.result === 'PUSH' ? 'status-push' : 'status-pending'));
            const profitClass = b.profit > 0 ? 'text-green' : (b.profit < 0 ? 'text-red' : 'text-secondary');
            
            if (b.result !== 'PENDIENTE') {
                totalWagered += b.stake;
                totalProfit += b.profit;
                resolvedCount++;
            }

            tbody.innerHTML += `
                <tr>
                    <td>${b.id.substring(4,8)}</td>
                    <td>${b.date.substring(5)}</td>
                    <td>${b.match} (${b.marketLabel})</td>
                    <td>${b.odds.toFixed(2)} (${b.EV.toFixed(2)}%)</td>
                    <td>${b.stake.toFixed(2)}</td>
                    <td class="${profitClass}">${b.profit.toFixed(2)}</td>
                    <td>
                        <span class="${statusClass}">${b.result}</span>
                        <div style="display:flex; gap:3px; margin-top:3px; justify-content:flex-start;">
                            <button class="btn-status btn-win" onclick="updateBetResult('${b.id}', 'WIN')">W</button>
                            <button class="btn-status btn-lose" onclick="updateBetResult('${b.id}', 'LOSE')">L</button>
                            <button class="btn-status btn-push" onclick="updateBetResult('${b.id}', 'PUSH')">P</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        // Actualizar KPIs de Banca y Profit
        const currentBank = getBankValue();
        const avgYield = totalWagered > 0 ? (totalProfit / totalWagered) * 100 : 0;

        document.getElementById('currentBankValue').innerText = currentBank.toFixed(2);
        document.getElementById('currentBankValue').className = `kpi-value ${currentBank > getInitialBank() ? 'text-green' : 'text-red'}`;
        
        document.getElementById('totalProfitValue').innerText = totalProfit.toFixed(2);
        document.getElementById('totalProfitValue').className = `kpi-value ${totalProfit > 0 ? 'text-green' : (totalProfit < 0 ? 'text-red' : 'text-blue')}`;

        document.getElementById('avgYieldValue').innerText = avgYield.toFixed(2) + '%';
        document.getElementById('avgYieldValue').className = `kpi-value ${avgYield > 0 ? 'text-green' : (avgYield < 0 ? 'text-red' : 'text-orange')}`;
        
        document.getElementById('resolvedBetsCount').innerText = resolvedCount;
        document.getElementById('bankLabel').innerText = currentBank.toFixed(2);
    }

    function clearPlacedBets() {
        if (confirm("¬øEst√°s seguro de que quieres borrar **TODO** el historial de apuestas registradas? Esto no se puede deshacer.")) {
            localStorage.removeItem('placedBets');
            placedBets = [];
            updatePlacedBetsUI();
            // Si el an√°lisis de futuros estaba corriendo, refrescar la UI
            if(futureData.length > 0) runAnalysis();
        }
    }
    
    function getInitialBank() {
        return parseFloat(document.getElementById('initialBank').value);
    }

    // --- FUNCIONES DE DESCARGA y UI ---
    function downloadValueBets() {
        if (valueBetsResults.length === 0) {
            alert("No hay oportunidades de valor (EV+) para descargar.");
            return;
        }

        const csvData = valueBetsResults.map(b => ({
            Fecha: b.date, Liga: b.league, Partido: b.match, Mercado: b.marketLabel,
            'Cuota_Tomada': b.odds.toFixed(2),
            'Cuota_Justa_(Modelo)': b.oddsFair.toFixed(2),
            'EV_Porcentaje': `+${b.EV.toFixed(2)}%`,
            'Stake_Monto': b.stake.toFixed(2)
        }));
        
        const csv = Papa.unparse(csvData, { header: true, delimiter: "," });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const today = new Date().toISOString().slice(0, 10).replace(/-/g, ''); 
        a.setAttribute('href', url);
        a.setAttribute('download', `ValueBets_${today}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function updateGlobalUI(totalAnalyzed, evPlusCount, maxEV, results) { 
        document.getElementById('valBets').innerText = totalAnalyzed;
        document.getElementById('valEVPlus').innerText = evPlusCount;
        document.getElementById('valMaxEV').innerText = maxEV.toFixed(2) + '%'; 

        document.getElementById('valMaxEV').className = `kpi-value ${maxEV>=5?'text-green':'text-blue'}`;

        const tbVB = document.getElementById('valueBetsTableBody'); tbVB.innerHTML='';
        
        document.getElementById('valueBetsSection').style.display = (results.length > 0) ? 'block' : 'none';

        results.sort((a, b) => {
            if (a.date < b.date) return -1;
            if (a.date > b.date) return 1;
            return b.EV - a.EV;
        });

        results.forEach(b => {
            const evClass = b.EV >= 5.0 ? 'text-green' : (b.EV >= 0.01 ? 'text-warning' : 'text-secondary');
            const marketClass = `market-${b.market.replace(/[^HD A OU]/g, '')}`; 
            const dateDisplay = b.date ? b.date.substring(5) : 'N/A'; 
            
            // Sanitizar y serializar el objeto para pasarlo a la funci√≥n JS en el HTML
            const betDataString = JSON.stringify(b).replace(/'/g, "\\'").replace(/"/g, "'");

            const actionButton = b.isPlaced ? 
                `<button class="btn btn-secondary" style="background:var(--success); color:black; padding: 4px 8px; font-size: 0.75rem; white-space:nowrap;" disabled><i class="fas fa-check"></i> Registrada</button>` :
                `<button class="btn btn-secondary" style="background:var(--accent); color:black; padding: 4px 8px; font-size: 0.75rem; white-space:nowrap;" onclick="addBetToRegistry(${betDataString})"><i class="fas fa-plus"></i> Registrar Apuesta</button>`;
            
            tbVB.innerHTML += `
                <tr class="${marketClass}">
                    <td style="font-weight:bold;">${dateDisplay}</td>
                    <td style="text-align:left;">${b.match}</td>
                    <td style="font-weight:bold;">${b.marketLabel}</td>
                    <td>${b.odds.toFixed(2)}</td>
                    <td>${b.oddsFair.toFixed(2)}</td> 
                    <td class="${evClass}" style="font-weight:bold;">+${b.EV.toFixed(2)}%</td>
                    <td>${b.stake.toFixed(2)}</td>
                    <td>${actionButton}</td>
                </tr>
            `;
        });
    }
    
    function updateHADTable(hadFactors) {
        const tbHAD = document.getElementById('hadTableBody'); tbHAD.innerHTML='';
        Object.entries(hadFactors)
            .sort(([, a], [, b]) => b.matches - a.matches)
            .forEach(([league, data]) => {
            
            const factorClass = data.factor > 1.05 ? 'text-green' : (data.factor < 0.95 ? 'text-red' : 'text-secondary');
            
            tbHAD.innerHTML += `
                <tr>
                    <td style="text-align:left; font-weight:bold; color:white;">${league}</td>
                    <td>${data.matches}</td>
                    <td class="${factorClass}">${data.factor.toFixed(3)}</td>
                    <td>${data.correction}</td>
                </tr>
            `;
        });
    }

    // --- Funciones de An√°lisis Manual y Backtest (ACTUALIZADAS) ---
    
    function analyzeMatchup() {
        const homeTeam = document.getElementById('teamHomeSelect').value;
        const awayTeam = document.getElementById('teamAwaySelect').value;
        const league = document.getElementById('leagueSelect').value;
        const statsCard = document.getElementById('statsCard');
        statsCard.style.display = 'block';

        if (!currentStats || !homeTeam || !awayTeam) {
            statsCard.innerHTML = `<h3 style="color:var(--danger); margin:0;">Selecciona ambos equipos y aseg√∫rate de que el Historial est√° cargado.</h3>`;
            return;
        }
        
        const teamStats = currentStats.teamCoeffs;
        if (!teamStats[homeTeam] || !teamStats[awayTeam]) {
            statsCard.innerHTML = `<h3 style="color:var(--danger); margin:0;">Datos insuficientes: No se encontraron estad√≠sticas para uno o ambos equipos.</h3>`;
            return;
        }

        const coeffsH = teamStats[homeTeam];
        const coeffsA = teamStats[awayTeam];
        
        const hybridRes = calculateHybridProbabilities(homeTeam, awayTeam, league, currentStats, leagueHADFactors);

        if (!hybridRes) {
             statsCard.innerHTML = `<h3 style="color:var(--danger); margin:0;">No se pudo calcular el modelo Poisson h√≠brido.</h3>`;
             return;
        }

        const { pHome, pDraw, pAway, pOver25, pUnder25, lambdaH, lambdaA, hadFactor } = hybridRes;
        const sumProbs = pHome + pDraw + pAway;

        statsCard.innerHTML = `
            <h3 style="color:var(--stats-accent); margin-top:0;">Edge y Coeficientes para ${homeTeam} vs ${awayTeam}</h3>
            <div style="display:flex; justify-content:space-around; gap:10px;">
                <div style="flex:1;">
                    <h4 style="margin:0; font-size:1rem; color:var(--text-secondary);">Coeficientes de Poder</h4>
                    <p style="margin:5px 0 0 0; font-weight:bold;">${homeTeam} (Local):</p>
                    <ul style="list-style:none; padding-left:15px; font-size:0.9em; margin-top:3px;">
                        <li>Ataque: ${coeffsH.attH_factor.toFixed(3)}</li>
                        <li>Defensa: ${coeffsH.defH_factor.toFixed(3)}</li>
                        <li>Ajuste HAD: x${hadFactor.toFixed(3)}</li>
                    </ul>
                    <p style="margin:5px 0 0 0; font-weight:bold;">${awayTeam} (Visita):</p>
                    <ul style="list-style:none; padding-left:15px; font-size:0.9em; margin-top:3px;">
                        <li>Ataque: ${coeffsA.attA_factor.toFixed(3)}</li>
                        <li>Defensa: ${coeffsA.defA_factor.toFixed(3)}</li>
                    </ul>
                </div>
                <div style="flex:1;">
                     <h4 style="margin:0; font-size:1rem; color:var(--text-secondary);">Goles Esperados $(\\lambda)$</h4>
                     <p style="margin:5px 0 0 0; font-weight:bold;">Goles Locales: <span style="color:var(--accent);">${lambdaH.toFixed(2)}</span></p>
                     <p style="margin:5px 0 0 0; font-weight:bold;">Goles Visita: <span style="color:var(--accent);">${lambdaA.toFixed(2)}</span></p>
                </div>
                <div style="flex:1;">
                    <h4 style="margin:0; font-size:1rem; color:var(--text-secondary);">Probabilidades (Modelo)</h4>
                    <p style="margin:5px 0 0 0; font-weight:bold;">1 (Local): <span style="color:var(--success);">${(pHome*100).toFixed(2)}%</span> / Cuota Justa: <span style="color:var(--accent);">${(1/pHome).toFixed(2)}</span></p>
                    <p style="margin:5px 0 0 0; font-weight:bold;">X (Empate): <span style="color:var(--success);">${(pDraw*100).toFixed(2)}%</span> / Cuota Justa: <span style="color:var(--accent);">${(1/pDraw).toFixed(2)}</span></p>
                    <p style="margin:5px 0 0 0; font-weight:bold;">2 (Visita): <span style="color:var(--success);">${(pAway*100).toFixed(2)}%</span> / Cuota Justa: <span style="color:var(--accent);">${(1/pAway).toFixed(2)}</span></p>
                    <p style="margin:5px 0 0 0; font-weight:bold;">Over 2.5: <span style="color:var(--success);">${(pOver25*100).toFixed(2)}%</span></p>
                    <p style="margin:5px 0 0 0; font-weight:bold;">Under 2.5: <span style="color:var(--success);">${(pUnder25*100).toFixed(2)}%</span></p>
                </div>
            </div>
        `;
    }

    function runHistoricalBacktest(data) {
        const bank0 = getInitialBank();
        const minEV = 0.05; // M√≠nimo 5% de EV para apostar
        const kellyFactor = 33; // K=33 (1/3 de Kelly)
        
        let bank = bank0;
        let maxBank = bank0;
        let profit = 0;
        let totalWagered = 0;
        let resolvedBets = 0;
        
        const equityHistory = [{x: 'Inicio', y: bank0}];
        let maxDrawdown = 0;
        const drawdownHistory = [{x: 'Inicio', y: 0}];
        const leagueProfit = {};
        
        // --- INICIALIZACI√ìN DE ESTAD√çSTICAS POR MERCADO ---
        const marketStats = {
            'H': { marketLabel: 'Local (1)', profit: 0, wagered: 0, count: 0, evSum: 0, mkt: 'H' },
            'D': { marketLabel: 'Empate (X)', profit: 0, wagered: 0, count: 0, evSum: 0, mkt: 'D' },
            'A': { marketLabel: 'Visita (2)', profit: 0, wagered: 0, count: 0, evSum: 0, mkt: 'A' },
            'O25': { marketLabel: 'Over 2.5', profit: 0, wagered: 0, count: 0, evSum: 0, mkt: 'O25' },
            'U25': { marketLabel: 'Under 2.5', profit: 0, wagered: 0, count: 0, evSum: 0, mkt: 'U25' }
        };

        data.forEach((r, index) => {
            // Recalcular stats cada 100 partidos para simular un modelo din√°mico
            if (index % 100 === 0) { 
                currentStats = calculateCurrentSeasonStats(data.slice(0, index + 1));
                if (!currentStats) return;
            }
            
            if (!currentStats || !r.oddsH || r.oddsH < 1.01) return;

            const hybridRes = calculateHybridProbabilities(r.home, r.away, r.league, currentStats, leagueHADFactors);
            if (!hybridRes) return;

            const markets = [
                {mkt: 'H', odds: r.oddsH, pModel: hybridRes.pHome, result: r.goalsH > r.goalsA},
                {mkt: 'D', odds: r.oddsD, pModel: hybridRes.pDraw, result: r.goalsH === r.goalsA},
                {mkt: 'A', odds: r.oddsA, pModel: hybridRes.pAway, result: r.goalsH < r.goalsA},
                {mkt: 'O25', odds: r.oddsO25, pModel: hybridRes.pOver25, result: (r.goalsH + r.goalsA) > 2},
                {mkt: 'U25', odds: r.oddsU25, pModel: hybridRes.pUnder25, result: (r.goalsH + r.goalsA) < 3}
            ].filter(m => m.odds > 1.01 && m.pModel > 0);

            markets.forEach(m => {
                const edge = (m.pModel * m.odds) - 1;
                if (edge > minEV) {
                    const kellyFraction = calculateKellyStake(m.pModel, m.odds, kellyFactor);
                    const stake = bank * kellyFraction;
                    
                    if (stake > 0.01) {
                        resolvedBets++;
                        totalWagered += stake;
                        let betProfit = 0;

                        if (m.result) {
                            betProfit = stake * m.odds - stake;
                        } else {
                            betProfit = -stake;
                        }
                        
                        bank += betProfit;
                        profit += betProfit;

                        if (!leagueProfit[r.league]) leagueProfit[r.league] = 0;
                        leagueProfit[r.league] += betProfit;
                        
                        // --- ACUMULAR ESTAD√çSTICAS POR MERCADO ---
                        marketStats[m.mkt].profit += betProfit;
                        marketStats[m.mkt].wagered += stake;
                        marketStats[m.mkt].count++;
                        marketStats[m.mkt].evSum += edge;

                        maxBank = Math.max(maxBank, bank);
                    }
                }
            });

            if (resolvedBets > 0 && index % 10 === 0) { 
                const drawdown = (maxBank - bank) / maxBank;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
                equityHistory.push({x: r.date, y: bank.toFixed(2)});
                drawdownHistory.push({x: r.date, y: (drawdown * 100).toFixed(2)});
            }
        });
        
        // --- L√ìGICA DE FILTRO INTELIGENTE (ACTUALIZADA) ---
        profitableMarkets.clear();
        Object.values(marketStats).forEach(stats => {
            const yieldVal = stats.wagered > 0 ? (stats.profit / stats.wagered) * 100 : 0;
            // Criterio: Al menos 20 apuestas y Yield positivo
            if (stats.count >= 20 && yieldVal > 0.0) {
                // Usamos el mkt (H, D, A, O25, U25) para el Set
                profitableMarkets.add(stats.mkt); 
            }
        });
        // Fin de L√≥gica de Filtro Inteligente

        // Stats para la tarjeta de resumen
        const totalReturn = profit;
        const totalYield = totalWagered > 0 ? (totalReturn / totalWagered) * 100 : 0;
        const finalBank = bank;

        const profitableMarketsText = profitableMarkets.size > 0 
            ? `<span class="text-green" style="font-weight:bold;">${Array.from(profitableMarkets).join(', ')}</span>`
            : '<span class="text-red" style="font-weight:bold;">Ninguno (Se requiere m√°s historial).</span>';

        const finalStatsHTML = `
            <h3 style="color:var(--stats-accent); margin-top:0;">Resultados del Backtest Hist√≥rico (${resolvedBets} Apuestas EV+ Simuladas)</h3>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
                <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                    <div class="kpi-title">Banca Final</div>
                    <div class="kpi-value ${finalBank > bank0 ? 'text-green' : 'text-red'}">${finalBank.toFixed(2)}</div>
                </div>
                <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                    <div class="kpi-title">Profit Total</div>
                    <div class="kpi-value ${totalReturn > 0 ? 'text-green' : 'text-red'}">${totalReturn.toFixed(2)}</div>
                </div>
                <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                    <div class="kpi-title">Yield Promedio</div>
                    <div class="kpi-value ${totalYield > 0 ? 'text-green' : 'text-red'}">${totalYield.toFixed(2)}%</div>
                </div>
                <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                    <div class="kpi-title">Drawdown M√°x.</div>
                    <div class="kpi-value ${maxDrawdown <= 0.2 ? 'text-green' : (maxDrawdown < 0.35 ? 'text-orange' : 'text-red')}">${(maxDrawdown * 100).toFixed(2)}%</div>
                </div>
            </div>
            
            <p style="margin-top:10px; color:var(--text-primary); font-size:0.9rem;">
                <i class="fas fa-filter" style="color:var(--info);"></i> 
                Mercados Rentables (Yield > 0% con >= 20 apuestas): ${profitableMarketsText}
            </p>

            <hr class="separator">

            <h3 style="color:var(--accent); margin-top:10px;"><i class="fas fa-hand-point-right"></i> Rendimiento Desglosado por Mercado (EV > 5%)</h3>
            <div class="table-scroll" style="max-height: 250px; margin-top: 10px;">
                <table id="marketAnalysisTable">
                    <thead>
                        <tr>
                            <th>Mercado</th>
                            <th>Apuestas</th>
                            <th>Profit Total</th>
                            <th>Yield (%)</th>
                            <th>EV Prom. (Modelo)</th>
                        </tr>
                    </thead>
                    <tbody id="marketAnalysisTableBody"></tbody>
                </table>
            </div>
        `;
        document.getElementById('statsCardBacktest').style.display = 'block';
        document.getElementById('statsCardBacktest').innerHTML = finalStatsHTML;
        
        updateMarketAnalysisTable(marketStats);
        renderCharts(equityHistory, drawdownHistory, leagueProfit);
    }
    
    function updateMarketAnalysisTable(marketStats) {
        const tbody = document.getElementById('marketAnalysisTableBody');
        tbody.innerHTML = '';
        
        // Convertir el objeto a un array, ordenar por Yield de mayor a menor y luego por n√∫mero de apuestas
        const sortedMarkets = Object.values(marketStats)
            .filter(stats => stats.count > 0)
            .map(stats => {
                const yieldVal = stats.wagered > 0 ? (stats.profit / stats.wagered) * 100 : 0;
                return { 
                    ...stats, 
                    yield: yieldVal, 
                    avgEV: stats.count > 0 ? (stats.evSum / stats.count) * 100 : 0
                };
            })
            .sort((a, b) => {
                if (b.yield !== a.yield) return b.yield - a.yield;
                return b.count - a.count;
            });

        sortedMarkets.forEach(stats => {
            
            const profitClass = stats.profit > 0 ? 'text-green' : (stats.profit < 0 ? 'text-red' : 'text-secondary');
            const yieldClass = stats.yield > 0 ? 'text-green' : (stats.yield < 0 ? 'text-red' : 'text-secondary');
            
            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold; color:var(--accent);">${stats.marketLabel}</td>
                    <td>${stats.count}</td>
                    <td class="${profitClass}">${stats.profit.toFixed(2)}</td>
                    <td class="${yieldClass}">${stats.yield.toFixed(2)}%</td>
                    <td>${stats.avgEV.toFixed(2)}%</td>
                </tr>
            `;
        });
    }

    // --- Funciones de Gr√°ficos ---

    function getChartOptions(title, yMin=undefined, color='var(--accent)', bgColor='rgba(245, 158, 11, 0.1)') {
        return {
            responsive:true, maintainAspectRatio:false, 
            plugins:{legend:{display:false}, title:{display:true, text:title, color:'white', font:{size:14, weight:'600'}}}, 
            scales:{x:{display:false},y:{min:yMin, grid:{color:'#334155'}, ticks:{color:'white'}}},
            elements: { line: { borderColor: color, borderWidth: 2 }, point: { radius: 0 } },
            datasets: { line: { fill: true, backgroundColor: bgColor } }
        };
    }

    function renderCharts(hist, drawdownHist, lgData) {
        const ctxEq = document.getElementById('equityChart').getContext('2d');
        if(chartEq) chartEq.destroy();
        const pts = hist.length>800 ? hist.filter((_,i)=>i%5===0) : hist;
        chartEq = new Chart(ctxEq, { type:'line', data:{labels:pts.map(p=>p.x), datasets:[{label:'Banca', data:pts.map(p=>p.y)}]}, 
            options: getChartOptions('Evoluci√≥n de Banca (Backtest)')
        });

        const ctxDD = document.getElementById('drawdownChart').getContext('2d');
        if(chartDD) chartDD.destroy();
        const ddPts = drawdownHist.length>800 ? drawdownHist.filter((_,i)=>i%5===0) : drawdownHist;
        chartDD = new Chart(ctxDD, { type:'line', data:{labels:ddPts.map(p=>p.x), datasets:[{label:'Drawdown (%)', data:ddPts.map(p=>p.y)}]}, 
            options: getChartOptions('Drawdown M√°ximo (%)', 0, 'var(--danger)', 'rgba(239, 68, 68, 0.2)')
        });

        const ctxLg = document.getElementById('leagueChart').getContext('2d');
        if(chartLg) chartLg.destroy();
        const lgArr = Object.entries(lgData).sort((a,b)=>b[1]-a[1]).slice(0, 10);
            
        chartLg = new Chart(ctxLg, { 
            type:'bar', 
            data:{
                labels:lgArr.map(x=>x[0]), 
                datasets:[{
                    data:lgArr.map(x=>x[1]), 
                    backgroundColor:lgArr.map(x=>x[1]>=0?'var(--success)':'var(--danger)')
                }]
            }, 
            options:{
                responsive:true, maintainAspectRatio:false, indexAxis:'y', 
                plugins:{legend:{display:false}, title:{display:true, text:'Profit por Liga (Backtest Top 10)', color:'white', font:{size:14, weight:'600'}}}, 
                scales:{x:{grid:{color:'#334155'}, ticks:{color:'white'}}, y:{ticks:{color:'white'}}}
            }
        });
    }
    
    // Inicializar la interfaz al cargar
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loadingOverlay').style.display = 'none';
        loadPlacedBets(); // Cargar el historial al iniciar
        document.getElementById('tabConfigBtn').click(); // Abrir la pesta√±a de configuraci√≥n
    });
    
</script>

</body>
</html>

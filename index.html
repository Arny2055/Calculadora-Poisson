<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Poisson + CV (μ_home/μ_away, 1X2, DNB, OU, BTTS)</title>
<style>
:root{--bg:#0f1115;--panel:#171a21;--text:#e8ecf3;--muted:#9aa3b2;--accent:#7aa2ff;--border:#2a3140}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{padding:16px 20px;border-bottom:1px solid var(--border);background:#0c0e13} h1{font-size:18px;margin:0}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
label{font-size:13px;color:var(--muted);display:block;margin:10px 0 4px}
input,output{width:100%} input[type=number],input[type=range]{padding:10px;border:1px solid var(--border);border-radius:10px;background:#12151c;color:var(--text)}
.btn{margin-top:14px;background:var(--accent);border:0;border-radius:10px;padding:12px 14px;color:#0b0f18;font-weight:700;cursor:pointer;width:100%}
table{width:100%;border-collapse:collapse;margin-top:12px} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right} th:first-child,td:first-child{text-align:left}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;font-size:13px}
.pill{padding:6px 10px;border-radius:999px;background:#12151c;border:1px solid var(--border);color:var(--muted)}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace} small{color:var(--muted)}
.warn{color:#ffb84d}
</style>
</head>
<body>
<header><h1>Calculadora Poisson con CV (μ_home/μ_away)</h1></header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Entradas por sede (medias por partido)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>GF Local</label><input id="gfH" type="number" step="0.01" min="0" value="1.40">
          <label>CV GF Local</label><input id="cvGFH" type="number" step="0.01" min="0" value="0.77">
          <label>GC Local</label><input id="gcH" type="number" step="0.01" min="0" value="0.80">
          <label>CV GC Local</label><input id="cvGCH" type="number" step="0.01" min="0" value="0.50">
        </div>
        <div>
          <label>GF Visitante</label><input id="gfA" type="number" step="0.01" min="0" value="1.60">
          <label>CV GF Visitante</label><input id="cvGFA" type="number" step="0.01" min="0" value="0.60">
          <label>GC Visitante</label><input id="gcA" type="number" step="0.01" min="0" value="1.60">
          <label>CV GC Visitante</label><input id="cvGCA" type="number" step="0.01" min="0" value="0.55">
        </div>
      </div>

      <h3>Parámetros del modelo</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>μ_home (liga, goles por equipo en casa)</label>
          <input id="muH" type="number" step="0.01" min="0.5" value="1.45">
        </div>
        <div>
          <label>μ_away (liga, goles por equipo fuera)</label>
          <input id="muA" type="number" step="0.01" min="0.5" value="1.25">
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center">
        <div>
          <label>HFA (ventaja local, p.ej. 1.08)</label>
          <input id="hfa" type="number" step="0.01" min="0.7" max="1.4" value="1.08">
        </div>
        <div>
          <label>α (fuerza del encogimiento por CV): <span id="alphaLbl">0.50</span></label>
          <input id="alpha" type="range" min="0" max="1.2" step="0.02" value="0.50" oninput="alphaLbl.textContent=this.value">
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Máx. goles por lado (sumatoria de marcadores)</label>
          <input id="maxGoals" type="number" step="1" min="8" max="20" value="12">
        </div>
        <div>
          <label>Modo validación</label>
          <small>Se mostrarán checks básicos de consistencia.</small>
        </div>
      </div>

      <button class="btn" id="calc">Calcular mercados</button>
      <div class="kpi" id="kpi"></div>
      <div class="kpi" id="checks"></div>
    </div>

    <div class="card">
      <h3>Resultados</h3>
      <table id="tbl1"><thead><tr><th>Mercado</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead><tbody></tbody></table>
      <table id="tbl2"><thead><tr><th>Over/Under</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead><tbody></tbody></table>
      <table id="tbl3"><thead><tr><th>BTTS</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const fact=[1];
  function factorial(n){for(let i=fact.length;i<=n;i++)fact[i]=fact[i-1]*i;return fact[n]}
  function logFactorial(n){if(n<100)return Math.log(factorial(n));const x=n;return x*Math.log(x)-x+0.5*Math.log(2*Math.PI*x)}
  function poisPMF(k,lambda){
    if(lambda<=0)return (k===0)?1:0;
    if(k<100){return Math.exp(-lambda)*Math.pow(lambda,k)/factorial(k)}
    return Math.exp(-lambda + k*Math.log(lambda) - logFactorial(k));
  }
  function poisCDF(k,lambda){let s=0;for(let i=0;i<=k;i++)s+=poisPMF(i,lambda);return s}
  function toOdds(p){return (p<=0)?Infinity:(1/p)}
  function fmtP(p){return (100*p).toFixed(2)+'%'}
  function fmtO(o){return (o===Infinity)?'—':o.toFixed(2)}
  function clamp(x,lo,hi){return Math.max(lo,Math.min(hi,x))}
  function shrink(x,cv,a){return x*(1/(1+(Math.max(0,a))*Math.max(0,cv)))}

  function lambdas(p){
    const GFH=shrink(Math.max(0,p.gfh),Math.max(0,p.cvGFH),p.alpha);
    const GCH=shrink(Math.max(0,p.gch),Math.max(0,p.cvGCH),p.alpha);
    const GFA=shrink(Math.max(0,p.gfa),Math.max(0,p.cvGFA),p.alpha);
    const GCA=shrink(Math.max(0,p.gca),Math.max(0,p.cvGCA),p.alpha);
    const MUH=Math.max(0.3,p.muH), MUA=Math.max(0.3,p.muA);
    const HFA=clamp(p.hfa,0.7,1.4);
    // Fórmulas corregidas con μ_home/μ_away separados:
    const lamH = HFA * GFH * (GCA / MUA);
    const lamA = (1/HFA) * GFA * (GCH / MUH);
    return {lamH,lamA,GFH,GCH,GFA,GCA,MUH,MUA,HFA};
  }

  function probs1X2(lH,lA,maxGoals){
    const maxG=Math.max(8,Math.min(20,Math.floor(maxGoals)||12));
    let p1=0,px=0,p2=0;
    for(let i=0;i<=maxG;i++){
      const pHi=poisPMF(i,lH);
      for(let j=0;j<=maxG;j++){
        const pAj=poisPMF(j,lA);
        const pij=pHi*pAj;
        if(i>j)p1+=pij; else if(i===j)px+=pij; else p2+=pij;
      }
    }
    const s=p1+px+p2; if(s>0){p1/=s;px/=s;p2/=s}
    return {p1,px,p2,maxG};
  }

  function calc(){
    const params={
      gfh:+$('#gfH').value, cvGFH:+$('#cvGFH').value,
      gch:+$('#gcH').value, cvGCH:+$('#cvGCH').value,
      gfa:+$('#gfA').value, cvGFA:+$('#cvGFA').value,
      gca:+$('#gcA').value, cvGCA:+$('#cvGCA').value,
      alpha:+$('#alpha').value, muH:+$('#muH').value, muA:+$('#muA').value,
      hfa:+$('#hfa').value
    };
    const maxGoals=+$('#maxGoals').value;

    const {lamH,lamA,GFH,GCH,GFA,GCA,MUH,MUA,HFA}=lambdas(params);
    const lamT=lamH+lamA;

    const m=probs1X2(lamH,lamA,maxGoals);
    const p1=m.p1, px=m.px, p2=m.p2;

    const pNotDraw=1-px; const dnb1=toOdds(p1/(pNotDraw>0?pNotDraw:1)); const dnb2=toOdds(p2/(pNotDraw>0?pNotDraw:1));

    const over15=1-poisCDF(1,lamT), over25=1-poisCDF(2,lamT), over35=1-poisCDF(3,lamT);
    const pBTTS=1-Math.exp(-lamH)-Math.exp(-lamA)+Math.exp(-lamT), pNo=1-pBTTS;

    // KPIs
    $('#kpi').innerHTML=`
      <span class="pill">λ<sub>H</sub>=<b class="mono">${lamH.toFixed(3)}</b></span>
      <span class="pill">λ<sub>A</sub>=<b class="mono">${lamA.toFixed(3)}</b></span>
      <span class="pill">λ<sub>T</sub>=<b class="mono">${lamT.toFixed(3)}</b></span>
      <span class="pill">μ<sub>H</sub>=<b class="mono">${MUH.toFixed(2)}</b> μ<sub>A</sub>=<b class="mono">${MUA.toFixed(2)}</b></span>
      <span class="pill">HFA=<b class="mono">${HFA.toFixed(2)}</b></span>
      <span class="pill">P(X)=<b class="mono">${(100*px).toFixed(2)}%</b></span>
    `;

    // Checks de sanidad
    const checks=[];
    const s1x2=p1+px+p2;
    if(Math.abs(1-s1x2)>0.002) checks.push(`<span class="warn">⚠ 1X2 no suma 1 (${s1x2.toFixed(4)})</span>`);
    if(!(over15>=over25 && over25>=over35)) checks.push(`<span class="warn">⚠ Over no es monótono</span>`);
    if(lamH<0.2 || lamA<0.2) checks.push(`<span class="warn">⚠ λ muy bajos (ver α, CV, μ, HFA)</span>`);
    if(lamH>3.5 || lamA>3.5) checks.push(`<span class="warn">⚠ λ muy altos (revisar entradas)</span>`);
    if(maxGoals<10 && lamT>2.8) checks.push(`<span class="warn">⚠ Aumenta maxGoals a ≥14 con λ_T alto</span>`);
    $('#checks').innerHTML = checks.length? checks.join(' '): '<small>Checks OK ✅</small>';

    // Tablas
    $('#tbl1 tbody').innerHTML=`
      <tr><td>1 (Local)</td><td class="mono">${fmtP(p1)}</td><td class="mono">${fmtO(toOdds(p1))}</td></tr>
      <tr><td>X (Empate)</td><td class="mono">${fmtP(px)}</td><td class="mono">${fmtO(toOdds(px))}</td></tr>
      <tr><td>2 (Visita)</td><td class="mono">${fmtP(p2)}</td><td class="mono">${fmtO(toOdds(p2))}</td></tr>
      <tr><td>1 DNB</td><td class="mono"><small>—</small></td><td class="mono">${fmtO(dnb1)}</td></tr>
      <tr><td>2 DNB</td><td class="mono"><small>—</small></td><td class="mono">${fmtO(dnb2)}</td></tr>
    `;
    $('#tbl2 tbody').innerHTML=`
      <tr><td>Over 1.5</td><td class="mono">${fmtP(over15)}</td><td class="mono">${fmtO(toOdds(over15))}</td></tr>
      <tr><td>Under 1.5</td><td class="mono">${fmtP(1-over15)}</td><td class="mono">${fmtO(toOdds(1-over15))}</td></tr>
      <tr><td>Over 2.5</td><td class="mono">${fmtP(over25)}</td><td class="mono">${fmtO(toOdds(over25))}</td></tr>
      <tr><td>Under 2.5</td><td class="mono">${fmtP(1-over25)}</td><td class="mono">${fmtO(toOdds(1-over25))}</td></tr>
      <tr><td>Over 3.5</td><td class="mono">${fmtP(over35)}</td><td class="mono">${fmtO(toOdds(over35))}</td></tr>
      <tr><td>Under 3.5</td><td class="mono">${fmtP(1-over35)}</td><td class="mono">${fmtO(toOdds(1-over35))}</td></tr>
    `;
    $('#tbl3 tbody').innerHTML=`
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTS)}</td><td class="mono">${fmtO(toOdds(pBTTS))}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pNo)}</td><td class="mono">${fmtO(toOdds(pNo))}</td></tr>
    `;
  }

  $('#calc').addEventListener('click', calc);
  calc(); // inicial
})();
</script>
</body>
</html>
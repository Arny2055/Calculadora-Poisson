<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Backtesting F√∫tbol ‚Äî ROI & Patrones Avanzados</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
      --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;}
    *{box-sizing:border-box;font-family:'Inter',sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);}
    header{padding:1rem;background:var(--panel);border-bottom:1px solid var(--border);}
    h1{font-size:1.2rem;margin:0;}
    main{display:grid;grid-template-columns:1fr 3fr;gap:1rem;padding:1rem;}
    section{background:var(--panel2);padding:1rem;border-radius:8px;overflow:auto;}
    table{width:100%;border-collapse:collapse;font-size:.8rem;}
    th,td{padding:.4rem;border:1px solid var(--border);text-align:center;}
    th{background:var(--panel);}
    select,input,button{width:100%;padding:.4rem;margin-top:.4rem;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:4px;}
    button{cursor:pointer;background:var(--accent);}
    .dropzone{border:2px dashed var(--accent);border-radius:6px;padding:1rem;text-align:center;color:var(--muted);margin-top:.5rem;}
    .dropzone.dragover{background:rgba(122,162,255,0.1);}
    canvas{width:100%!important;height:250px!important;}
  </style>
</head>
<body>
<header><h1>‚öΩ Backtesting F√∫tbol ‚Äî ROI & Patrones Avanzados</h1></header>
<main>
  <section>
    <h2>‚öôÔ∏è Configuraci√≥n</h2>
    <input type="file" id="fileInput" accept=".json"/>
    <div id="dropzone" class="dropzone">Arrastra tu JSON aqu√≠</div>
    <label>Liga:</label><select id="leagueSelect"></select>
    <label>Equipo Local:</label><select id="homeSelect"></select>
    <label>Equipo Visitante:</label><select id="awaySelect"></select>
    <label>N (forma reciente):</label><input type="number" id="nForm" value="5" min="1" max="20"/>
    <button onclick="exportCSV()">Exportar CSV</button>
  </section>
  <section>
    <h2>üìä Resultados</h2>
    <div id="metrics"></div>
    <canvas id="equityChart"></canvas>
    <canvas id="confusionChart"></canvas>
    <h3>Top Reglas/Patrones</h3><table id="rulesTable"></table>
    <h3>Partidos Evaluados</h3><table id="matchesTable"></table>
  </section>
</main>

<script>
// ---------- Datos demo ----------
let data = [
  {"Date":"2024-08-01 18:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"Banfield - Boca","Desired Outcome":"GG","Odd":2.25,"Result":"Winning","Result FT":"2-1","Home Attacks at FT":90,"Away Attacks at FT":85},
  {"Date":"2024-08-05 20:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"River - Racing","Desired Outcome":"GG","Odd":1.90,"Result":"Losing","Result FT":"1-0","Home Attacks at FT":70,"Away Attacks at FT":68},
  {"Date":"2024-08-09 19:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"Independiente - San Lorenzo","Desired Outcome":"GG","Odd":2.10,"Result":"Winning","Result FT":"1-1","Home Attacks at FT":95,"Away Attacks at FT":90},
  {"Date":"2024-08-13 17:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"Banfield - Tigre","Desired Outcome":"GG","Odd":2.05,"Result":"Winning","Result FT":"2-2","Home Attacks at FT":80,"Away Attacks at FT":75},
  {"Date":"2024-08-17 16:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"River - Boca","Desired Outcome":"GG","Odd":1.95,"Result":"Losing","Result FT":"1-0","Home Attacks at FT":60,"Away Attacks at FT":70}
];

// ---------- Parsing ----------
function parseJson(txt){ try{return JSON.parse(txt);}catch(e){alert("Error JSON");return [];} }

// ---------- Split temporal ----------
function splitTemporal(ds){
  ds.sort((a,b)=>new Date(a.Date)-new Date(b.Date));
  const s=Math.floor(ds.length*0.7);
  return {train:ds.slice(0,s),test:ds.slice(s)};
}

// ---------- Features ----------
function buildFeatures(ds){
  return ds.map(m=>{
    const [home,away]=m.Match.split(" - ");
    return {
      ...m,
      home,away,
      target:m.Result=="Winning"?1:0,
      diffAttacks:(+m["Home Attacks at FT"]||0) - (+m["Away Attacks at FT"]||0),
      odd:+m.Odd||2.0
    };
  });
}

// ---------- Logistic regression ----------
function logisticTrain(train,feats,iters=500,lr=0.01){
  let w={}; feats.forEach(f=>w[f]=0);
  for(let i=0;i<iters;i++){
    train.forEach(m=>{
      let z=0; feats.forEach(f=>{z+=w[f]*(+m[f]||0);});
      const pred=1/(1+Math.exp(-z));
      const err=m.target-pred;
      feats.forEach(f=>{ w[f]+=lr*err*(+m[f]||0); });
    });
  }
  return w;
}
function logisticPredict(m,w,feats){
  let z=0; feats.forEach(f=>{z+=w[f]*(+m[f]||0);});
  return 1/(1+Math.exp(-z));
}

// ---------- Reglas simples ----------
function discoverRules(test){
  let rules=[];
  const conds=[
    {desc:"diffAttacks>10",fn:m=>m.diffAttacks>10},
    {desc:"odd>2.0",fn:m=>m.odd>2.0},
    {desc:"odd<2.0",fn:m=>m.odd<2.0}
  ];
  conds.forEach(c=>{
    const subset=test.filter(c.fn);
    if(subset.length>1){
      let wins=subset.filter(m=>m.target==1).length;
      let roi=(wins* (subset[0].odd-1) - (subset.length-wins))/subset.length;
      rules.push({cond:c.desc,roi:roi.toFixed(2),n:subset.length});
    }
  });
  return rules.sort((a,b)=>b.roi-a.roi).slice(0,5);
}

// ---------- Evaluaci√≥n ----------
function evaluate(test,preds){
  let tp=0,fp=0,fn=0,tn=0;
  let equity=[0];
  test.forEach((m,i)=>{
    const p=preds[i]>0.5?1:0;
    if(p==1&&m.target==1)tp++;
    if(p==1&&m.target==0)fp++;
    if(p==0&&m.target==1)fn++;
    if(p==0&&m.target==0)tn++;
    // ROI stake 1
    let gain=0;
    if(p==1){ gain=m.target==1?(m.odd-1): -1; }
    equity.push(equity[equity.length-1]+gain);
  });
  const acc=((tp+tn)/test.length).toFixed(2);
  const roi=(equity[equity.length-1]/test.length).toFixed(2);
  return {tp,fp,fn,tn,acc,roi,equity};
}

// ---------- Render ----------
function render(ds){
  ds=buildFeatures(ds);
  const {train,test}=splitTemporal(ds);
  const feats=["diffAttacks","odd"];
  const w=logisticTrain(train,feats);
  const preds=test.map(m=>logisticPredict(m,w,feats));
  const ev=evaluate(test,preds);
  document.getElementById("metrics").innerHTML=
    `<p>Train: ${train.length} | Test: ${test.length}<br>
     Acc: ${ev.acc} | ROI: ${ev.roi}</p>`;
  // Equity chart
  new Chart(document.getElementById("equityChart"),{
    type:"line",
    data:{labels:test.map(m=>m.Date),datasets:[{label:"Equity",data:ev.equity}]}
  });
  // Confusion
  new Chart(document.getElementById("confusionChart"),{
    type:"bar",
    data:{labels:["TP","FP","FN","TN"],datasets:[{label:"Confusi√≥n",data:[ev.tp,ev.fp,ev.fn,ev.tn]}]}
  });
  // Reglas
  let r=discoverRules(test);
  let rt="<tr><th>Condici√≥n</th><th>ROI</th><th>n</th></tr>";
  r.forEach(x=>{rt+=`<tr><td>${x.cond}</td><td>${x.roi}</td><td>${x.n}</td></tr>`;});
  document.getElementById("rulesTable").innerHTML=rt;
  // Matches
  let mt="<tr><th>Fecha</th><th>Partido</th><th>Odd</th><th>Pred Prob</th><th>Real</th></tr>";
  test.forEach((m,i)=>{mt+=`<tr><td>${m.Date}</td><td>${m.Match}</td><td>${m.odd}</td><td>${preds[i].toFixed(2)}</td><td>${m.target}</td></tr>`;});
  document.getElementById("matchesTable").innerHTML=mt;
  // Selects
  fillSelect("leagueSelect",[...new Set(ds.map(x=>x.League))]);
  fillSelect("homeSelect",[...new Set(ds.map(x=>x.home))]);
  fillSelect("awaySelect",[...new Set(ds.map(x=>x.away))]);
}
function fillSelect(id,arr){let s=document.getElementById(id);s.innerHTML="<option>Todos</option>";arr.forEach(v=>s.innerHTML+=`<option>${v}</option>`);}

// ---------- Export ----------
function exportCSV(){
  let rows=[["Fecha","Partido","Odd","Resultado"]];
  data.forEach(m=>rows.push([m.Date,m.Match,m.Odd,m.Result]));
  let csv=rows.map(r=>r.join(",")).join("\n");
  let a=document.createElement("a");a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));a.download="backtesting.csv";a.click();
}

// ---------- File / Drop ----------
const drop=document.getElementById("dropzone");
drop.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("dragover");});
drop.addEventListener("dragleave",()=>drop.classList.remove("dragover"));
drop.addEventListener("drop",e=>{e.preventDefault();drop.classList.remove("dragover");handleFile(e.dataTransfer.files[0]);});
document.getElementById("fileInput").addEventListener("change",e=>handleFile(e.target.files[0]));
function handleFile(file){let r=new FileReader();r.onload=e=>{data=parseJson(e.target.result);render(data);};r.readAsText(file);}

// Inicial demo
render(data);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting de Valor (Value Betting)</title>
    <style>
        /* Estilos */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        #csvFile { margin-bottom: 20px; }
        #results { 
            margin-top: 30px; 
            padding: 15px; 
            border: 1px solid #ddd; 
            background-color: #e9e9f9; 
            font-size: 16px;
        }
        .profit { color: green; font-weight: bold; }
        .loss { color: red; font-weight: bold; }
        .neutral { color: orange; font-weight: bold; }
        .config-box { 
            background-color: #fff3e0; 
            padding: 15px; 
            border: 1px dashed #ff9800; 
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>游눯 Backtesting Avanzado: Detecci칩n de Valor (Over 2.5)</h2>

        <div class="config-box">
            <h3>丘뙖잺 Configuraci칩n de Estrategia de Valor</h3>
            
            <label for="minOdd">1. Cuota M칤nima de Over 2.5 para Considerar Valor (ej. 2.00):</label>
            <input type="number" id="minOdd" value="2.00" step="0.05" min="1.5" style="width: 150px; padding: 5px; border: 1px solid #ccc;">
            <p style="font-size: 0.9em; margin-top: 5px;">*Apostar solo si la cuota es igual o mayor a este valor (buscamos un riesgo asumido por la casa).</p>

            <label for="minCombinedAttack">2. Umbral M칤nimo de Ataque Combinado (Attack + Danger):</label>
            <input type="number" id="minCombinedAttack" value="250" min="100" style="width: 150px; padding: 5px; border: 1px solid #ccc;">
            <p style="font-size: 0.9em; margin-top: 5px;">*La suma de Home Attack/Danger + Away Attack/Danger debe ser mayor a este n칰mero (buscamos un partido muy abierto).</p>
        </div>

        <form id="csvForm">
            <label for="csvFile">Cargar Archivo CSV de Historial de BetMines:</label>
            <input type="file" id="csvFile" name="historialCSV" accept=".csv" required>
        </form>
        
        <div id="results">
            Ajusta los par치metros de Valor, carga tu archivo CSV y ejecuta la prueba.
        </div>
    </div>

    <script>
        const csvFile = document.getElementById('csvFile');
        const resultsDiv = document.getElementById('results');
        const minOddInput = document.getElementById('minOdd');
        const minCombinedAttackInput = document.getElementById('minCombinedAttack');

        // Escuchar cambios en la configuraci칩n y en la carga del archivo
        [csvFile, minOddInput, minCombinedAttackInput].forEach(element => {
            element.addEventListener('change', () => {
                if (csvFile.files.length > 0) {
                     const reader = new FileReader();
                     reader.onload = (e) => runBacktest(e.target.result);
                     reader.readAsText(csvFile.files[0]);
                }
            });
        });
        
        // -----------------------------------------------------------------------------------
        // **CONSTANTES DE 칈NDICE (Basadas en tu imagen de CSV)**
        // -----------------------------------------------------------------------------------
        const DESIRED_ODD_INDEX = 1;      // 'Desired Odd' (Cuota Over 2.5)
        const HOME_ATTACK_INDEX = 3;      // 'Home Attack'
        const AWAY_ATTACK_INDEX = 6;      // 'Away Attack'
        const HOME_DANGER_INDEX = 5;      // 'Home Danger'
        const AWAY_DANGER_INDEX = 7;      // 'Away Danger'
        const TOTAL_SCORE_INDEX = 14;     // 'Total Score' (Resultado final de goles)
        const STAKE_SIZE = 1;             // Apuesta fija por partido (1 unidad)
        // -----------------------------------------------------------------------------------
        
        function runBacktest(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) {
                resultsDiv.innerHTML = "El archivo CSV est치 vac칤o o solo contiene encabezados.";
                return;
            }

            // 1. Obtener par치metros de la estrategia del usuario
            const MIN_ODD_THRESHOLD = parseFloat(minOddInput.value);
            const MIN_ATTACK_THRESHOLD = parseFloat(minCombinedAttackInput.value);
            
            let totalApuestas = 0;
            let saldoFinal = 0;
            let aciertos = 0;

            // 2. Procesar cada partido
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');

                // Validaci칩n de fila incompleta
                if (values.length < TOTAL_SCORE_INDEX + 1) continue; 

                // Obtener y Parsear datos clave
                const desiredOdd = parseFloat(values[DESIRED_ODD_INDEX]);
                const homeAttack = parseFloat(values[HOME_ATTACK_INDEX]);
                const awayAttack = parseFloat(values[AWAY_ATTACK_INDEX]);
                const homeDanger = parseFloat(values[HOME_DANGER_INDEX]);
                const awayDanger = parseFloat(values[AWAY_DANGER_INDEX]);
                const totalScore = parseFloat(values[TOTAL_SCORE_INDEX]);

                // 3. Crear el Indicador de Valor (el coraz칩n de la estrategia)
                const combinedAttackIndex = homeAttack + awayAttack + homeDanger + awayDanger;

                // ----------------------------------------------------------------
                // 游 CONDICIONES DE VALUE BETTING (OVER 2.5)
                // ----------------------------------------------------------------
                
                // CONDICI칍N 1: La cuota tiene valor percibido (la casa subestima el riesgo)
                const isHighOdd = desiredOdd >= MIN_ODD_THRESHOLD;

                // CONDICI칍N 2: Las m칠tricas fundamentales justifican la apuesta (el partido es un "tiro al aire")
                const isHighAttack = combinedAttackIndex >= MIN_ATTACK_THRESHOLD;
                
                // Si ambas condiciones se cumplen, 춰APOSTAMOS!
                if (isHighOdd && isHighAttack) {
                    
                    totalApuestas++;
                    let ganancia = -STAKE_SIZE; // Perdedora

                    const IS_WINNER = (totalScore >= 3); 

                    if (IS_WINNER) { 
                        // Ganancia = (Cuota - 1) * Stake
                        ganancia = (desiredOdd - 1) * STAKE_SIZE;
                        aciertos++;
                    }
                    
                    saldoFinal += ganancia;
                }
            }

            // 4. Mostrar Resultados Finales
            const totalInvested = totalApuestas * STAKE_SIZE;
            const profitabilityClass = (saldoFinal > 0) ? 'profit' : (saldoFinal < 0 ? 'loss' : 'neutral');
            const totalReturn = (totalInvested > 0) ? (saldoFinal / totalInvested) * 100 : 0;
            const winRate = (totalApuestas > 0) ? (aciertos / totalApuestas) * 100 : 0;


            let htmlOutput = `
                <h3>Resultados del Value Backtesting</h3>
                <p><strong>Estrategia aplicada:</strong> Apostar a **Over 2.5 Goles** si:</p>
                <ul>
                    <li>Cuota $\\ge$ **${MIN_ODD_THRESHOLD.toFixed(2)}** (Buscando Valor)</li>
                    <li>Suma de (Attack + Danger) $\\ge$ **${MIN_ATTACK_THRESHOLD}** (Justificaci칩n Estad칤stica)</li>
                </ul>
                <hr>
                <p>俱뫮잺 Total de apuestas realizadas: **${totalApuestas}**</p>
                <p>俱뫮잺 Tasa de acierto (Win Rate): **${winRate.toFixed(2)}%** (${aciertos} de ${totalApuestas})</p>
                <p>俱뫮잺 Cuota promedio ganadora: **${(totalInvested / aciertos).toFixed(2)}**</p> 
                <hr>
                <h4>Balance Final (Unidades)</h4>
                <p>G / P Netas (unidades): <span class="${profitabilityClass}">${saldoFinal.toFixed(2)} unidades</span></p>
                <p>Retorno de Inversi칩n (ROI): <span class="${profitabilityClass}">${totalReturn.toFixed(2)}%</span></p>
            `;

            resultsDiv.innerHTML = htmlOutput;
        }

    </script>

</body>
</html>

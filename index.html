<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BetMines Lite — Calculadora 1X2 / Over / BTTS</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --good:#10b981; --bad:#ef4444;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e6eef6;background:linear-gradient(180deg,#071021 0%, #041025 100%);}
    .container{max-width:1100px;margin:28px auto;padding:20px;}
    h1{margin:0 0 10px;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef6}
    .row{display:flex;gap:8px}
    .small{font-size:13px;color:var(--muted)}
    button{cursor:pointer;padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#042029;font-weight:600}
    .muted{color:var(--muted)}
    .bars{display:flex;gap:8px;align-items:flex-end;height:120px;margin-top:10px}
    .bar{flex:1;background:var(--glass);border-radius:6px;padding:6px;text-align:center;display:flex;flex-direction:column;justify-content:flex-end}
    .barFill{height:20%;border-radius:4px;background:linear-gradient(180deg, rgba(6,182,212,0.9), rgba(2,132,199,0.9));}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px;color:#e6eef6}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}
    .good{color:var(--good);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .alert{padding:10px;border-radius:8px;margin-top:10px;background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.12);color:var(--good)}
  </style>
</head>
<body>
  <div class="container">
    <div class="flex-between">
      <h1>Predictor 1X2, Over/Under 2.5, BTTS</h1>
      <div class="small muted">Versión ligera — Poisson + forma + MonteCarlo</div>
    </div>

    <div class="grid" style="margin-top:12px">
      <!-- LEFT: Inputs y configuración -->
      <div class="card">
        <label>Equipo Local</label>
        <input id="homeName" value="Equipo A" />
        <label>Equipo Visitante</label>
        <input id="awayName" value="Equipo B" />

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
          <div>
            <label>Atq local (rating)</label>
            <input id="atkHome" type="number" step="0.01" value="1.20" />
            <label>Def local (rating)</label>
            <input id="defHome" type="number" step="0.01" value="0.95" />
          </div>
          <div>
            <label>Atq visitante</label>
            <input id="atkAway" type="number" step="0.01" value="0.98" />
            <label>Def visitante</label>
            <input id="defAway" type="number" step="0.01" value="1.05" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Media liga goles Home</label>
            <input id="leagueHome" type="number" step="0.01" value="1.45" />
          </div>
          <div style="flex:1">
            <label>Media liga goles Away</label>
            <input id="leagueAway" type="number" step="0.01" value="1.15" />
          </div>
        </div>

        <label style="margin-top:12px">Forma reciente (últimos 6 partidos) — pon 1=victoria, 0=empate, -1=derrota (ej: 1,1,0,-1,1,0)</label>
        <input id="formHome" placeholder="1,1,0,-1,1,0" value="1,1,0,1,0,1"/>
        <input id="formAway" placeholder="1,0,-1,1,0,-1" value="0,1,-1,0,0,-1" style="margin-top:8px"/>

        <div class="row" style="margin-top:10px;gap:10px">
          <div style="flex:1">
            <label>Ventaja local (factor)</label>
            <input id="homeAdv" type="number" step="0.01" value="1.08" />
          </div>
          <div style="flex:1">
            <label>Penalización lesiones (0..1, 1=sano)</label>
            <input id="injuryFactor" type="number" step="0.01" value="1.00" />
          </div>
        </div>

        <label style="margin-top:12px">Cuotas Bookmaker (decimales) — 1X2</label>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
          <input id="oddsHome" type="number" step="0.01" value="2.30" />
          <input id="oddsDraw" type="number" step="0.01" value="3.30" />
          <input id="oddsAway" type="number" step="0.01" value="3.10" />
        </div>

        <label style="margin-top:12px">Cuotas Bookmaker (decimales) — Over 2.5 y BTTS Sí</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="oddsOver25" type="number" step="0.01" value="1.85" placeholder="Cuota Over 2.5" />
          <input id="oddsBTTS" type="number" step="0.01" value="1.90" placeholder="Cuota BTTS Sí" />
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Bankroll</label>
            <input id="bankroll" type="number" step="1" value="1000" />
          </div>
          <div style="flex:1">
            <label>Cap Kelly (%)</label>
            <input id="capKelly" type="number" step="0.1" value="20" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button onclick="calculateAll()">Calcular</button>
          <button onclick="runMonteCarlo(8000)">Simular MonteCarlo (8k)</button>
          <button onclick="resetToSample()">Reset Ejemplo</button>
        </div>

        <div style="margin-top:12px" class="small muted"></div>
      </div>

      <!-- RIGHT: Resultados -->
      <div class="card">
        <div class="flex-between">
          <div>
            <div class="tag" id="matchLabel">Equipo A vs Equipo B</div>
            <div class="small muted" id="lambdaLabel">λ home: - , λ away: -</div>
          </div>
          <div class="small muted">
            <div>EV threshold <input id="evThreshold" type="number" step="0.1" value="5" style="width:64px;text-align:center" />%</div>
          </div>
        </div>

        <!-- barras de prob -->
        <div style="margin-top:12px">
          <div class="bars" id="probBars" aria-hidden="true">
            <div class="bar"><div id="barHomeFill" class="barFill" style="height:10%"></div><div style="margin-top:8px">Local<br><span id="barHomePct" class="small muted">-</span></div></div>
            <div class="bar"><div id="barDrawFill" class="barFill" style="height:10%"></div><div style="margin-top:8px">Empate<br><span id="barDrawPct" class="small muted">-</span></div></div>
            <div class="bar"><div id="barAwayFill" class="barFill" style="height:10%"></div><div style="margin-top:8px">Visita<br><span id="barAwayPct" class="small muted">-</span></div></div>
          </div>
        </div>

        <table id="resultsTable">
          <thead>
            <tr><th>Mercado</th><th>Modelo</th><th>Book (sin vig)</th><th>Cuota</th><th>EV%</th><th>Kelly%</th><th>Stake</th></tr>
          </thead>
          <tbody id="resultsBody">
            <!-- llenado por JS -->
          </tbody>
        </table>

        <div id="alerts"></div>

        <div style="margin-top:10px" class="small muted">
          Sobre el ajuste: las probabilidades modelo vienen de Poisson con lambdas escaladas por ratings, forma y ventaja de local. La simulación MC da una estimación robusta.
        </div>
      </div>
    </div>

    <footer></footer>
  </div>

<script>
/* --------------------------
   Helpers matemáticos
   -------------------------- */
function factorial(n){
  if(n<=1) return 1;
  let r=1;
  for(let i=2;i<=n;i++) r*=i;
  return r;
}
function poisson(k, lambda){
  // calcula P(X=k) con Poisson
  return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k);
}
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

/* --------------------------
   Lectura de inputs
   -------------------------- */
function readInputs(){
  return {
    homeName: document.getElementById('homeName').value || 'Home',
    awayName: document.getElementById('awayName').value || 'Away',
    atkH: parseFloat(document.getElementById('atkHome').value) || 1.0,
    defH: parseFloat(document.getElementById('defHome').value) || 1.0,
    atkA: parseFloat(document.getElementById('atkAway').value) || 1.0,
    defA: parseFloat(document.getElementById('defAway').value) || 1.0,
    leagueHome: parseFloat(document.getElementById('leagueHome').value) || 1.3,
    leagueAway: parseFloat(document.getElementById('leagueAway').value) || 1.0,
    formHome: document.getElementById('formHome').value || '',
    formAway: document.getElementById('formAway').value || '',
    homeAdv: parseFloat(document.getElementById('homeAdv').value) || 1.0,
    injury: parseFloat(document.getElementById('injuryFactor').value) || 1.0,
    odds: [
      parseFloat(document.getElementById('oddsHome').value) || 0,
      parseFloat(document.getElementById('oddsDraw').value) || 0,
      parseFloat(document.getElementById('oddsAway').value) || 0
    ],
    oddsOver25: parseFloat(document.getElementById('oddsOver25').value) || 0,  // *** NUEVO ***
    oddsBTTS: parseFloat(document.getElementById('oddsBTTS').value) || 0,      // *** NUEVO ***
    bankroll: parseFloat(document.getElementById('bankroll').value) || 0,
    capKelly: parseFloat(document.getElementById('capKelly').value) || 100,
    evThreshold: parseFloat(document.getElementById('evThreshold').value) || 5
  };
}

/* --------------------------
   Forma -> factor (pondera la fuerza)
   - convierte resultados pasados en un multiplicador [0.8 .. 1.15]
   - más victorias -> mayor ataque estimado (simple proxy)
   -------------------------- */
function formFactor(formStr){
  if(!formStr) return 1.0;
  const tokens = formStr.split(',').map(x=>x.trim()).filter(x=>x!=='').map(Number);
  if(tokens.length===0) return 1.0;
  // asigna puntos: victoria=1, empate=0, derrota=-1
  const score = tokens.reduce((s,v)=>s + (isNaN(v)?0:v),0);
  // normaliza por cantidad de partidos
  const avg = score / tokens.length; // en [-1,1]
  // mapear a factor multiplicativo:
  // avg -1 => 0.85 ; 0 => 1.0 ; +1 => 1.12 (ajustable)
  const factor = 1 + (avg * 0.14);
  return clamp(factor, 0.7, 1.3);
}

/* --------------------------
   Construir lambdas Poisson
   - Modelo multiplicativo: lambda_home = atkH * defA * leagueHome * homeAdv * formAdjustment * injuries
   - Similar para away (sin homeAdv)
   -------------------------- */
function computeLambdas(inputs){
  const fH = formFactor(inputs.formHome);
  const fA = formFactor(inputs.formAway);

  // base multiplicativa
  let lambdaHome = inputs.atkH * inputs.defA * inputs.leagueHome * inputs.homeAdv * fH * inputs.injury;
  let lambdaAway = inputs.atkA * inputs.defH * inputs.leagueAway * (1.0) * fA * inputs.injury;

  // escala razonable (limita)
  lambdaHome = clamp(lambdaHome, 0.03, 4.5);
  lambdaAway = clamp(lambdaAway, 0.03, 4.5);

  return {home: lambdaHome, away: lambdaAway, fH:fH, fA:fA};
}

/* --------------------------
   Matriz de probabilidades (0..maxGoals)
   -------------------------- */
function matrixProb(homeLambda, awayLambda, maxGoals=6){
  const mat = [];
  for(let i=0;i<=maxGoals;i++){
    mat[i]=[];
    for(let j=0;j<=maxGoals;j++){
      mat[i][j] = poisson(i, homeLambda) * poisson(j, awayLambda);
    }
  }
  // cola restante al último casillero
  let sum = 0;
  for(let i=0;i<=maxGoals;i++) for(let j=0;j<=maxGoals;j++) sum += mat[i][j];
  const tail = Math.max(0, 1 - sum);
  mat[maxGoals][maxGoals] += tail;
  return mat;
}

/* --------------------------
   Probabilidades de mercados principales
   -------------------------- */
function probsFromMatrix(mat){
  let ph=0, pd=0, pa=0;
  let over25 = 0, btts = 0;
  for(let i=0;i<mat.length;i++){
    for(let j=0;j<mat.length;j++){
      const p = mat[i][j];
      if(i>j) ph+=p;
      else if(i===j) pd+=p;
      else pa+=p;
      const totalGoals = i+j;
      if(totalGoals > 2) over25 += p;
      if(i>0 && j>0) btts += p;
    }
  }
  const sum = ph+pd+pa;
  return {
    home: ph/sum,
    draw: pd/sum,
    away: pa/sum,
    over25: over25,
    btts: btts
  };
}

/* --------------------------
   Remove vig (normalizar implied probs)
   -------------------------- */
function removeVig(odds){
  // odds: array [home,draw,away] (decimales)
  const imps = odds.map(o=>o>0?1/o:0);
  const s = imps.reduce((a,b)=>a+b,0);
  if(s <= 0) return imps;
  return imps.map(i=>i/s);
}

/* --------------------------
   EV y Kelly
   EV = probModelo * cuota - 1
   Kelly = (p*o - 1) / (o-1)
   -------------------------- */
function evPercent(pModel, odd){
  if(!odd || odd <= 1) return null;
  return (pModel * odd -1)*100;
}
function kellyFraction(pModel, odd){
  if(!odd || odd <= 1) return 0;
  const k = (pModel * (odd - 1) - (1 - pModel)) / (odd -1);
  return k > 0 ? k : 0;
}

/* --------------------------
   Función principal: calcula y muestra
   -------------------------- */
function calculateAll(){
  const inputs = readInputs();

  // mostrar nombres equipos
  document.getElementById('matchLabel').textContent = `${inputs.homeName} vs ${inputs.awayName}`;

  // lambdas
  const lambdas = computeLambdas(inputs);
  document.getElementById('lambdaLabel').textContent = `λ local: ${lambdas.home.toFixed(2)} — λ visita: ${lambdas.away.toFixed(2)}`;

  // matriz Poisson
  const mat = matrixProb(lambdas.home, lambdas.away);

  // probabilidades modelos
  const probs = probsFromMatrix(mat);

  // mostrar barras de prob
  updateProbBars(probs);

  // cuotas sin vig para 1X2
  const bookImps = removeVig(inputs.odds);

  // armado mercados con cálculo EV y Kelly para 1X2, Over 2.5 y BTTS
  const markets = [];

  // 1X2 mercados
  ['Local','Empate','Visita'].forEach((name,i)=>{
    const modelP = probs[['home','draw','away'][i]];
    const odd = inputs.odds[i];
    const bookP = bookImps[i];
    const ev = evPercent(modelP, odd);
    let kelly = kellyFraction(modelP, odd) * 100;
    if(kelly > inputs.capKelly) kelly = inputs.capKelly;
    const stake = (kelly/100) * inputs.bankroll;
    markets.push({name, modelP, bookP, odd, ev, kelly, stake});
  });

  // Over 2.5
  {
    const modelP = probs.over25;
    const odd = inputs.oddsOver25 || 0;
    const bookP = odd > 0 ? 1/odd : 0;
    const ev = odd > 0 ? evPercent(modelP, odd) : null;
    let kelly = odd > 0 ? kellyFraction(modelP, odd) * 100 : null;
    if(kelly !== null && kelly > inputs.capKelly) kelly = inputs.capKelly;
    const stake = (kelly !== null) ? (kelly/100) * inputs.bankroll : null;

    markets.push({
      name: 'Over 2.5',
      modelP,
      bookP,
      odd,
      ev,
      kelly,
      stake
    });
  }

  // BTTS (Sí)
  {
    const modelP = probs.btts;
    const odd = inputs.oddsBTTS || 0;
    const bookP = odd > 0 ? 1/odd : 0;
    const ev = odd > 0 ? evPercent(modelP, odd) : null;
    let kelly = odd > 0 ? kellyFraction(modelP, odd) * 100 : null;
    if(kelly !== null && kelly > inputs.capKelly) kelly = inputs.capKelly;
    const stake = (kelly !== null) ? (kelly/100) * inputs.bankroll : null;

    markets.push({
      name: 'BTTS (Sí)',
      modelP,
      bookP,
      odd,
      ev,
      kelly,
      stake
    });
  }

  // pintar tabla resultados
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';
  markets.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${m.name}</td>
      <td>${pct(m.modelP)}</td>
      <td>${m.bookP ? pct(m.bookP) : '-'}</td>
      <td>${m.odd ? m.odd.toFixed(2) : '-'}</td>
      <td class="${m.ev !== null && m.ev > 0 ? 'good' : 'bad'}">${m.ev !== null ? n2(m.ev)+'%' : '-'}</td>
      <td>${m.kelly !== null ? n2(m.kelly)+'%' : '-'}</td>
      <td>${m.stake !== null ? '$'+n2(m.stake) : '-'}</td>
    `;
    tbody.appendChild(tr);
  });

  // alertas Value Bets (ev > threshold)
  const alertsEl = document.getElementById('alerts');
  alertsEl.innerHTML = '';
  let found = false;
  markets.forEach(m=>{
    if(m.ev !== null && m.ev > inputs.evThreshold){
      found = true;
      const div = document.createElement('div');
      div.className = 'alert';
      div.innerHTML = `Value Bet detectada: <strong>${m.name}</strong> — EV ${n2(m.ev)}% — Prob Modelo ${pct(m.modelP)} — Cuota ${m.odd.toFixed(2)}`;
      alertsEl.appendChild(div);
    }
  });
  if(!found){
    alertsEl.innerHTML = '<div class="small muted">No se detectaron Value Bets con EV por encima del umbral.</div>';
  }
}

/* --------------------------
   Actualiza barras de probabilidad 1X2
   -------------------------- */
function updateProbBars(probs){
  const toPct = x=> (x*100).toFixed(1) + '%';
  document.getElementById('barHomeFill').style.height = `${probs.home*100}%`;
  document.getElementById('barDrawFill').style.height = `${probs.draw*100}%`;
  document.getElementById('barAwayFill').style.height = `${probs.away*100}%`;
  document.getElementById('barHomePct').textContent = toPct(probs.home);
  document.getElementById('barDrawPct').textContent = toPct(probs.draw);
  document.getElementById('barAwayPct').textContent = toPct(probs.away);
}

/* --------------------------
   Formateo % con 2 decimales
   -------------------------- */
function n2(x){ return Number(x).toFixed(2); }
function pct(x){ return x!==null ? (x*100).toFixed(1)+'%' : '-'; }

/* --------------------------
   Resetear inputs a ejemplo base
   -------------------------- */
function resetToSample(){
  document.getElementById('homeName').value = "Equipo A";
  document.getElementById('awayName').value = "Equipo B";
  document.getElementById('atkHome').value = "1.20";
  document.getElementById('defHome').value = "0.95";
  document.getElementById('atkAway').value = "0.98";
  document.getElementById('defAway').value = "1.05";
  document.getElementById('leagueHome').value = "1.45";
  document.getElementById('leagueAway').value = "1.15";
  document.getElementById('formHome').value = "1,1,0,1,0,1";
  document.getElementById('formAway').value = "0,1,-1,0,0,-1";
  document.getElementById('homeAdv').value = "1.08";
  document.getElementById('injuryFactor').value = "1.00";
  document.getElementById('oddsHome').value = "2.30";
  document.getElementById('oddsDraw').value = "3.30";
  document.getElementById('oddsAway').value = "3.10";
  document.getElementById('oddsOver25').value = "1.85";
  document.getElementById('oddsBTTS').value = "1.90";
  document.getElementById('bankroll').value = "1000";
  document.getElementById('capKelly').value = "20";
  document.getElementById('evThreshold').value = "5";
  calculateAll();
}

/* --------------------------
   MonteCarlo básico (opcional)
   -------------------------- */
function runMonteCarlo(simCount=8000){
  const inputs = readInputs();
  const lambdas = computeLambdas(inputs);
  let homeWins=0, draws=0, awayWins=0;
  let over25Count=0, bttsCount=0;
  for(let i=0;i<simCount;i++){
    const goalsH = poissonSample(lambdas.home);
    const goalsA = poissonSample(lambdas.away);
    if(goalsH > goalsA) homeWins++;
    else if(goalsH === goalsA) draws++;
    else awayWins++;
    if((goalsH+goalsA) > 2) over25Count++;
    if(goalsH>0 && goalsA>0) bttsCount++;
  }
  const total = simCount;
  alert(`Simulación MonteCarlo (${simCount} iteraciones):\n` +
        `Local: ${(homeWins/total*100).toFixed(1)}%\n` +
        `Empate: ${(draws/total*100).toFixed(1)}%\n` +
        `Visita: ${(awayWins/total*100).toFixed(1)}%\n` +
        `Over 2.5: ${(over25Count/total*100).toFixed(1)}%\n` +
        `BTTS Sí: ${(bttsCount/total*100).toFixed(1)}%`);
}

function poissonSample(lambda){
  // Método de generación con función inversa (para lambda pequeño)
  let L = Math.exp(-lambda);
  let p = 1.0;
  let k = 0;
  do {
    k++;
    p *= Math.random();
  } while (p > L);
  return k -1;
}

// Init
resetToSample();
</script>
</body>
</html>
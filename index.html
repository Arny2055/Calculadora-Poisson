<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Backtesting ROI ‚Äî √öltimos 15 partidos por posici√≥n</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS (XLSX export) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{--bg:#f6f8fb;--card:#fff;--accent:#0b6ed0;--muted:#6b7280;--good:#16a34a;--bad:#dc2626}
body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:18px;color:#0f1724}
.wrap{max-width:1200px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:20px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(12,20,30,0.06);margin-top:12px}
.controls{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:900px){.controls{grid-template-columns:repeat(1,1fr)}}
label{font-weight:600;margin-bottom:6px;display:block}
input[type=file], select, input[type=text], input[type=number]{width:100%;padding:8px;border:1px solid #e6e9ee;border-radius:8px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
button.secondary{background:#334155}
.small{font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{padding:8px;border:1px solid #e6e9ee;text-align:left}
th{background:#0f1724;color:white}
tr:nth-child(even){background:#fbfdff}
.good{color:var(--good);font-weight:700}
.bad{color:var(--bad);font-weight:700}
pre#log{background:#0b1220;color:#dbe9ff;padding:8px;border-radius:6px;height:120px;overflow:auto;font-size:12px}
.canvas-wrap{height:260px;padding:6px}
.badge{display:inline-block;background:#eef2ff;padding:4px 8px;border-radius:999px;font-weight:700;margin-left:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>Backtesting ROI ‚Äî √∫ltimos 15 partidos por posici√≥n</h1>
      <div class="small">Local‚Üílocal, Visitante‚Üívisitante. ROI usa odd del historial. Se usan hasta 15 partidos m√°s recientes por posici√≥n.</div>
    </div>
    <div class="row">
      <button id="clearBtn" style="background:#ef4444">Limpiar</button>
    </div>
  </div>

  <section class="card">
    <div class="controls">
      <div>
        <label>1) Archivo HISTORIAL (JSON)</label>
        <input id="histFile" type="file" accept=".json">
      </div>
      <div>
        <label>2) Archivo PARTIDOS FUTUROS (JSON)</label>
        <input id="futFile" type="file" accept=".json">
      </div>
      <div>
        <label>Filtro: Liga</label>
        <select id="leagueFilter"><option value="all">Todas</option></select>
      </div>
      <div>
        <label>Filtro: Buscar equipo</label>
        <input id="teamFilter" type="text" placeholder="texto para buscar equipos (opcional)">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="width:120px">
        <label>Stake por apuesta</label>
        <input id="stakeInput" type="number" min="0.01" step="0.01" value="1">
      </div>
      <div style="width:120px">
        <label>Bank (referencia)</label>
        <input id="bankInput" type="number" min="1" step="1" value="100">
      </div>
      <div style="flex:1">
        <label>&nbsp;</label>
        <div class="row">
          <button id="runBtn">üîç Hacer Backtesting</button>
          <button id="exportAllCsv" class="secondary">‚¨á CSV todo</button>
          <button id="exportAllXlsx" class="secondary">‚¨á XLSX todo</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="flex:1">
        <label>Logs</label>
        <pre id="log"></pre>
      </div>
      <div style="width:320px">
        <label>Resumen</label>
        <div id="summary" class="small" style="background:#fff;padding:10px;border-radius:8px;height:120px;overflow:auto"></div>
      </div>
    </div>
  </section>

  <!-- Matches table -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Partidos futuros ‚Äî resultados (ordenado por ROI total)</h3>
      <div class="row">
        <button id="exportMatchesCsv" class="secondary">Exportar Matches CSV</button>
        <button id="exportMatchesXlsx" class="secondary">Exportar Matches XLSX</button>
      </div>
    </div>
    <div class="small">ROI Local/Vst calculado usando hasta 15 partidos recientes por posici√≥n (fecha en campo Date).</div>
    <table id="matchesTable">
      <thead><tr><th>#</th><th>Partido</th><th>Liga</th><th>ROI Local</th><th>ROI Visitante</th><th>ROI Total</th><th># Local</th><th># Visitante</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Teams table -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Resumen por EQUIPO (basado en los √∫ltimos 15 por posici√≥n)</h3>
      <div class="row">
        <button id="exportTeamsCsv" class="secondary">Exportar Teams CSV</button>
        <button id="exportTeamsXlsx" class="secondary">Exportar Teams XLSX</button>
      </div>
    </div>
    <table id="teamsTable">
      <thead><tr><th>Equipo</th><th>Matches</th><th>Wins</th><th>Losses</th><th>Profit</th><th>AvgProfit</th><th>ROI %</th><th>ROI Local %</th><th>ROI Visit. %</th><th>Avg Odd</th><th>WinRate</th><th>Kelly %</th><th>Kelly stake (u)</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Leagues table -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Resumen por LIGA</h3>
      <div class="row">
        <button id="exportLeaguesCsv" class="secondary">Exportar Ligas CSV</button>
        <button id="exportLeaguesXlsx" class="secondary">Exportar Ligas XLSX</button>
      </div>
    </div>
    <table id="leaguesTable">
      <thead><tr><th>Liga</th><th>Matches</th><th>Profit</th><th>ROI %</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Charts -->
  <section class="card">
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <h3 style="margin:0">Gr√°fica: ROI por Equipo (Top 30)</h3>
        <div class="canvas-wrap"><canvas id="chartTeams"></canvas></div>
      </div>
      <div style="width:420px">
        <h3 style="margin:0">Gr√°fica: ROI por Liga</h3>
        <div class="canvas-wrap"><canvas id="chartLeagues"></canvas></div>
      </div>
    </div>
  </section>

</div>

<script>
/* ================= State ================= */
let historial = [];
let futuros = [];
let matchesResult = [];
let teamsResult = [];
let leaguesResult = [];
let chartTeams=null, chartLeagues=null;

/* ================= Helpers ================= */
const logEl = document.getElementById('log');
function log(msg){ const t=new Date().toLocaleTimeString(); logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent; }
function safeParseJSON(text){
  text = String(text||'').trim();
  if(!text) throw new Error('archivo vac√≠o');
  try{ const p = JSON.parse(text); return Array.isArray(p)?p:[p]; }catch(e){}
  try{ const p = JSON.parse('['+text.replace(/,\s*$/,'')+']'); return Array.isArray(p)?p:[p]; }catch(e){}
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(lines.length>1){
    const out=[]; for(let ln of lines){ if(ln.endsWith(',')) ln = ln.slice(0,-1); try{ out.push(JSON.parse(ln)); }catch(e){} }
    if(out.length) return out;
  }
  const objs=[]; const re=/{[^}]*}/g; let m;
  while((m=re.exec(text))!==null){ try{ objs.push(JSON.parse(m[0])); }catch(e){} }
  if(objs.length) return objs;
  throw new Error('No se pudo parsear JSON.');
}
function normalize(s){ if(!s && s!==0) return ''; let x=String(s).trim().toLowerCase(); x = x.normalize('NFD').replace(/\p{Diacritic}/gu,''); x = x.replace(/[^a-z0-9\- ]/g,' '); x = x.replace(/\s+/g,' ').trim(); return x; }
function mean(arr){ return arr && arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : NaN; }

/* ---------------- Spanish date parser ----------------
   Examples to handle:
   "vie., 31 may. 2024 18:00"
   "jue., 23 nov. 2023 18:30"
   "31/05/2024 18:00"
   "2024-05-31 18:00"
------------------------------------------------------*/
const MONTHS = {
  'ene':0,'enero':0,
  'feb':1,'febrero':1,
  'mar':2,'marzo':2,
  'abr':3,'abril':3,
  'may':4,'mayo':4,
  'jun':5,'junio':5,
  'jul':6,'julio':6,
  'ago':7,'agosto':7,
  'sep':8,'sept':8,'septiembre':8,
  'oct':9,'octubre':9,
  'nov':10,'noviembre':10,
  'dic':11,'diciembre':11
};

function parseDateSpanish(text){
  if(!text) return null;
  text = String(text).trim();

  // Try ISO-ish:
  const iso = Date.parse(text);
  if(!isNaN(iso)) return new Date(iso);

  // Try dd/mm/yyyy or dd-mm-yyyy
  const m1 = text.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
  if(m1){
    const day = parseInt(m1[1],10), mon = parseInt(m1[2],10)-1, year=parseInt(m1[3],10);
    const hh = m1[4]?parseInt(m1[4],10):0, mm = m1[5]?parseInt(m1[5],10):0;
    return new Date(year,mon,day,hh,mm);
  }

  // Try "31 may. 2024 18:00" or "vie., 31 may. 2024 18:00"
  const m2 = text.match(/(\d{1,2})\s+([^\s,.]+)\.?,?\s+(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/i);
  if(m2){
    const day = parseInt(m2[1],10);
    let monStr = m2[2].toLowerCase().replace(/\./g,'');
    const mon = MONTHS[monStr] !== undefined ? MONTHS[monStr] : NaN;
    const year = parseInt(m2[3],10);
    const hh = m2[4]?parseInt(m2[4],10):0, mm = m2[5]?parseInt(m2[5],10):0;
    if(!isNaN(mon)) return new Date(year, mon, day, hh, mm);
  }

  // fallback: attempt extract numbers sequence yyyy mm dd
  const m3 = text.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})(?:\D+(\d{1,2}):(\d{2}))?/);
  if(m3){
    const year = parseInt(m3[1],10), mon=parseInt(m3[2],10)-1, day=parseInt(m3[3],10);
    const hh = m3[4]?parseInt(m3[4],10):0, mm = m3[5]?parseInt(m3[5],10):0;
    return new Date(year,mon,day,hh,mm);
  }

  return null;
}

/* ---------------- File inputs ---------------- */
document.getElementById('histFile').addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    historial = safeParseJSON(txt);
    log(`Historial cargado: ${historial.length} registros (${f.name})`);
    buildLeagueFilter();
  }catch(err){ log('ERROR parse historial: '+err.message); alert('Error parse historial: '+err.message); }
});
document.getElementById('futFile').addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    futuros = safeParseJSON(txt);
    log(`Futuros cargados: ${futuros.length} registros (${f.name})`);
    buildLeagueFilter();
  }catch(err){ log('ERROR parse futuros: '+err.message); alert('Error parse futuros: '+err.message); }
});

/* ---------------- Build league select ---------------- */
function buildLeagueFilter(){
  const s = new Set();
  (historial||[]).forEach(x=>{ if(x.League) s.add(String(x.League)); });
  (futuros||[]).forEach(x=>{ if(x.League) s.add(String(x.League)); });
  const sel = document.getElementById('leagueFilter');
  const prev = sel.value || 'all';
  sel.innerHTML = '<option value="all">Todas</option>';
  Array.from(s).sort().forEach(l => { const o=document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); });
  sel.value = prev;
}

/* ---------------- Core: run backtesting using last 15 per position ---------------- */
document.getElementById('runBtn').addEventListener('click', ()=>{
  try{
    if(!historial.length || !futuros.length){ alert('Carga HISTORIAL y FUTUROS antes'); return; }

    const stake = parseFloat(document.getElementById('stakeInput').value) || 1;
    const bank = parseFloat(document.getElementById('bankInput').value) || 100;
    const leagueSel = document.getElementById('leagueFilter').value;
    const teamQuery = (document.getElementById('teamFilter').value||'').trim().toLowerCase();

    matchesResult = [];
    const teamAcc = {}; // normalized -> accum
    const leagueAcc = {};

    // Preprocess historial: add parsed date and normalized home/away
    const histProcessed = historial.map(h=>{
      const obj = Object.assign({}, h);
      obj._date = parseDateSpanish(h.Date) || new Date(0); // fallback very old
      // split match
      const parts = String(h.Match||'').split(' - ').map(s=> (s||'').trim());
      obj._home = parts[0]||'';
      obj._away = parts[1]||'';
      obj._homeNorm = normalize(obj._home);
      obj._awayNorm = normalize(obj._away);
      return obj;
    });

    // Index historial by normalized team & position for faster access
    const indexHome = {}; const indexAway = {};
    histProcessed.forEach(h=>{
      if(h._homeNorm){
        indexHome[h._homeNorm] = indexHome[h._homeNorm] || [];
        indexHome[h._homeNorm].push(h);
      }
      if(h._awayNorm){
        indexAway[h._awayNorm] = indexAway[h._awayNorm] || [];
        indexAway[h._awayNorm].push(h);
      }
    });
    // sort each list by date desc
    Object.keys(indexHome).forEach(k => indexHome[k].sort((a,b)=> b._date - a._date));
    Object.keys(indexAway).forEach(k => indexAway[k].sort((a,b)=> b._date - a._date));

    // For each future match:
    futuros.forEach(fut=>{
      if(!fut.Match) return;
      if(leagueSel !== 'all' && fut.League !== leagueSel) return;

      const parts = String(fut.Match).split(' - ').map(s=> (s||'').trim());
      const localFut = parts[0]||'';
      const visitaFut = parts[1]||'';
      if(!localFut || !visitaFut) return;

      if(teamQuery){
        if(!localFut.toLowerCase().includes(teamQuery) && !visitaFut.toLowerCase().includes(teamQuery)) return;
      }

      const localNorm = normalize(localFut);
      const visitaNorm = normalize(visitaFut);

      // get up to 15 most recent where team was local (from indexHome)
      const localHistList = (indexHome[localNorm] || []).slice(0,15);
      const visitaHistList = (indexAway[visitaNorm] || []).slice(0,15);

      // compute roi sums
      let roiLocal = 0, cntLocal = localHistList.length;
      for(const h of localHistList){
        const odd = parseFloat(h.Odd);
        const res = String(h.Result||'').toLowerCase();
        const win = /win|won|winning|ganad|gano|victoria/.test(res);
        roiLocal += win ? (isNaN(odd)?0:(odd - 1)) : -1;

        // accumulate teamAcc (for team-level summary)
        const tn = localNorm;
        teamAcc[tn] = teamAcc[tn] || {display:localFut,matches:0,wins:0,losses:0,profit:0,odds:[], matchesHome:0,winsHome:0,lossesHome:0,profitHome:0,oddsHome:[]};
        teamAcc[tn].matches++; teamAcc[tn].matchesHome++;
        if(win){ teamAcc[tn].wins++; teamAcc[tn].winsHome++; } else { teamAcc[tn].losses++; teamAcc[tn].lossesHome++; }
        const gain = win ? ((isNaN(odd)?0:(odd-1))) : -1;
        teamAcc[tn].profit += gain;
        if(!isNaN(odd)){ teamAcc[tn].odds.push(odd); teamAcc[tn].oddsHome.push(odd); }
        // league acc
        const lg = fut.League || 'Sin liga'; leagueAcc[lg] = leagueAcc[lg] || {profit:0,matches:0}; leagueAcc[lg].profit += gain; leagueAcc[lg].matches++;
      }

      // visitante
      let roiVisita = 0, cntVisita = visitaHistList.length;
      for(const h of visitaHistList){
        const odd = parseFloat(h.Odd);
        const res = String(h.Result||'').toLowerCase();
        const win = /win|won|winning|ganad|gano|victoria/.test(res);
        roiVisita += win ? (isNaN(odd)?0:(odd - 1)) : -1;

        // accumulate teamAcc for away
        const tn = visitaNorm;
        teamAcc[tn] = teamAcc[tn] || {display:visitaFut,matches:0,wins:0,losses:0,profit:0,odds:[], matchesAway:0,winsAway:0,lossesAway:0,profitAway:0,oddsAway:[]};
        teamAcc[tn].matches++; teamAcc[tn].matchesAway = (teamAcc[tn].matchesAway||0)+1;
        if(win){ teamAcc[tn].wins++; teamAcc[tn].winsAway = (teamAcc[tn].winsAway||0)+1; } else { teamAcc[tn].losses++; teamAcc[tn].lossesAway = (teamAcc[tn].lossesAway||0)+1; }
        const gain = win ? ((isNaN(odd)?0:(odd-1))) : -1;
        teamAcc[tn].profit += gain;
        if(!isNaN(odd)){ teamAcc[tn].odds.push(odd); teamAcc[tn].oddsAway = (teamAcc[tn].oddsAway||[]).concat([odd]); }
        // league acc
        const lg = fut.League || 'Sin liga'; leagueAcc[lg] = leagueAcc[lg] || {profit:0,matches:0}; leagueAcc[lg].profit += gain; leagueAcc[lg].matches++;
      }

      const roiTotal = roiLocal + roiVisita;
      matchesResult.push({
        partido: fut.Match,
        league: fut.League || '',
        roiLocal: roiLocal,
        roiVisitante: roiVisita,
        roiTotal: roiTotal,
        cntLocal: cntLocal,
        cntVisitante: cntVisita
      });
    }); // end futuros loop

    // sort matches by roiTotal desc
    matchesResult.sort((a,b)=> b.roiTotal - a.roiTotal);

    // build teamsResult
    teamsResult = [];
    Object.keys(teamAcc).forEach(k=>{
      const s = teamAcc[k];
      const avgProfit = s.matches ? s.profit / s.matches : 0;
      const stakeVal = parseFloat(document.getElementById('stakeInput').value) || 1;
      const roiPct = s.matches ? (s.profit / (s.matches * stakeVal)) * 100 : 0;
      const roiLocal = s.matchesHome ? (s.profitHome / (s.matchesHome * stakeVal)) * 100 : NaN;
      const roiAway = s.matchesAway ? (s.profitAway / (s.matchesAway * stakeVal)) * 100 : NaN;
      const avgOdd = mean((s.odds||[]).filter(Boolean));
      const winRate = s.matches ? (s.wins / s.matches) : 0;
      // Kelly
      let kellyFrac = NaN, kellyStake = NaN;
      if(!isNaN(avgOdd) && avgOdd > 1){
        const b = avgOdd - 1; const p = winRate; const q = 1 - p;
        const frac = ((b * p) - q) / b;
        kellyFrac = Math.max(-1, Math.min(1, frac));
        if(!isNaN(kellyFrac)) kellyStake = Math.max(0, kellyFrac * (parseFloat(document.getElementById('bankInput').value)||100));
      }
      teamsResult.push({
        team: s.display,
        matches: s.matches, wins: s.wins, losses: s.losses,
        profit: s.profit, avgProfit: avgProfit, roiPct: roiPct,
        roiLocal: roiLocal, roiAway: roiAway, avgOdd: avgOdd,
        winRate: winRate, kellyFrac: kellyFrac, kellyStake: kellyStake
      });
    });

    teamsResult.sort((a,b)=> b.roiPct - a.roiPct);

    // build leaguesResult array
    leaguesResult = [];
    Object.keys(leagueAcc).forEach(lg=>{
      const m = leagueAcc[lg].matches || 0;
      const p = leagueAcc[lg].profit || 0;
      const stakeVal = parseFloat(document.getElementById('stakeInput').value) || 1;
      const roiPct = m ? (p / (m * stakeVal)) * 100 : 0;
      leaguesResult.push({league: lg, matches: m, profit: p, roiPct: roiPct});
    });
    leaguesResult.sort((a,b)=> b.roiPct - a.roiPct);

    // render everything
    renderMatchesTable();
    renderTeamsTable();
    renderLeaguesTable();
    renderCharts();

    document.getElementById('summary').innerHTML = `<div><b>Partidos futuros analizados:</b> ${matchesResult.length}</div>
      <div><b>Equipos con historial analizado:</b> ${teamsResult.length}</div>
      <div><b>Ligas:</b> ${leaguesResult.length}</div>`;

    log('Backtesting finalizado: partidos='+matchesResult.length+', equipos='+teamsResult.length+', ligas='+leaguesResult.length);
  }catch(err){
    log('ERROR: '+(err && err.message ? err.message : err));
    alert('Error en procesamiento: ' + (err && err.message ? err.message : err));
  }
}); // end runBtn

/* ---------------- Render functions ---------------- */
function renderMatchesTable(){
  const tbody = document.querySelector('#matchesTable tbody'); tbody.innerHTML = '';
  matchesResult.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${r.partido}</td>
      <td>${r.league}</td>
      <td class="${r.roiLocal>=0?'good':'bad'}">${r.roiLocal.toFixed(3)}</td>
      <td class="${r.roiVisitante>=0?'good':'bad'}">${r.roiVisitante.toFixed(3)}</td>
      <td><b>${r.roiTotal.toFixed(3)}</b></td>
      <td>${r.cntLocal}</td>
      <td>${r.cntVisitante}</td>`;
    tbody.appendChild(tr);
  });
}
function renderTeamsTable(){
  const tbody = document.querySelector('#teamsTable tbody'); tbody.innerHTML = '';
  teamsResult.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.team}</td>
      <td>${r.matches}</td>
      <td>${r.wins}</td>
      <td>${r.losses}</td>
      <td>${r.profit.toFixed(3)}</td>
      <td>${r.avgProfit.toFixed(3)}</td>
      <td class="${r.roiPct>=0?'good':'bad'}">${r.roiPct.toFixed(2)}%</td>
      <td>${isNaN(r.roiLocal)?'N/A':r.roiLocal.toFixed(2)+'%'}</td>
      <td>${isNaN(r.roiAway)?'N/A':r.roiAway.toFixed(2)+'%'}</td>
      <td>${r.avgOdd? r.avgOdd.toFixed(3) : 'N/A'}</td>
      <td>${(r.winRate*100).toFixed(2)}%</td>
      <td>${isNaN(r.kellyFrac)?'N/A':(r.kellyFrac*100).toFixed(2)+'%'}</td>
      <td>${isNaN(r.kellyStake)?'N/A':r.kellyStake.toFixed(3)}</td>`;
    tbody.appendChild(tr);
  });
}
function renderLeaguesTable(){
  const tbody = document.querySelector('#leaguesTable tbody'); tbody.innerHTML = '';
  leaguesResult.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.league}</td><td>${r.matches}</td><td>${r.profit.toFixed(3)}</td><td class="${r.roiPct>=0?'good':'bad'}">${r.roiPct.toFixed(2)}%</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------------- Charts ---------------- */
function renderCharts(){
  // Teams chart top 30
  const top = teamsResult.slice(0,30);
  const ctxT = document.getElementById('chartTeams').getContext('2d');
  if(chartTeams) chartTeams.destroy();
  chartTeams = new Chart(ctxT, {
    type:'bar',
    data:{ labels: top.map(t=>t.team), datasets:[{ label:'ROI %', data: top.map(t=>t.roiPct), backgroundColor: top.map(t=> t.roiPct>0 ? 'rgba(16,185,129,0.8)' : 'rgba(239,68,68,0.8)')} ]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  const ctxL = document.getElementById('chartLeagues').getContext('2d');
  if(chartLeagues) chartLeagues.destroy();
  chartLeagues = new Chart(ctxL, {
    type:'bar',
    data:{ labels: leaguesResult.map(l=>l.league), datasets:[{ label:'ROI %', data: leaguesResult.map(l=>l.roiPct) }]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
}

/* ---------------- Exports CSV & XLSX ---------------- */
function exportToCSV(rows, headers, filename){
  const arr = [headers].concat(rows.map(r=> headers.map(h => r[h] !== undefined ? r[h] : '')));
  const csv = arr.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); downloadBlob(blob, filename); log('CSV exportado: '+filename);
}
function exportToXLSX(dataArray, sheetName, filename){
  const ws = XLSX.utils.json_to_sheet(dataArray);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, sheetName);
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  downloadBlob(new Blob([wbout],{type:'application/octet-stream'}), filename); log('XLSX exportado: '+filename);
}
function downloadBlob(blob, filename){ const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

/* Matches export */
document.getElementById('exportMatchesCsv').addEventListener('click', ()=>{
  if(!matchesResult.length){ alert('No hay matches'); return; }
  exportToCSV(matchesResult.map(m=>({partido:m.partido, league:m.league, roiLocal:m.roiLocal, roiVisitante:m.roiVisitante, roiTotal:m.roiTotal, cntLocal:m.cntLocal, cntVisitante:m.cntVisitante})), ['partido','league','roiLocal','roiVisitante','roiTotal','cntLocal','cntVisitante'], 'matches.csv');
});
document.getElementById('exportMatchesXlsx').addEventListener('click', ()=>{
  if(!matchesResult.length){ alert('No hay matches'); return; }
  exportToXLSX(matchesResult, 'matches', 'matches.xlsx');
});

/* Teams export */
document.getElementById('exportTeamsCsv').addEventListener('click', ()=>{
  if(!teamsResult.length){ alert('No hay teams'); return; }
  exportToCSV(teamsResult.map(t=>({team:t.team,matches:t.matches,wins:t.wins,losses:t.losses,profit:t.profit,avgProfit:t.avgProfit,roiPct:t.roiPct,roiLocal:t.roiLocal,roiAway:t.roiAway,avgOdd:t.avgOdd,winRate:t.winRate,kellyFrac:t.kellyFrac,kellyStake:t.kellyStake})), ['team','matches','wins','losses','profit','avgProfit','roiPct','roiLocal','roiAway','avgOdd','winRate','kellyFrac','kellyStake'], 'teams.csv');
});
document.getElementById('exportTeamsXlsx').addEventListener('click', ()=>{
  if(!teamsResult.length){ alert('No hay teams'); return; }
  exportToXLSX(teamsResult, 'teams', 'teams.xlsx');
});

/* Leagues export */
document.getElementById('exportLeaguesCsv').addEventListener('click', ()=>{
  if(!leaguesResult.length){ alert('No hay ligas'); return; }
  exportToCSV(leaguesResult, ['league','matches','profit','roiPct'], 'leagues.csv');
});
document.getElementById('exportLeaguesXlsx').addEventListener('click', ()=>{
  if(!leaguesResult.length){ alert('No hay ligas'); return; }
  exportToXLSX(leaguesResult, 'leagues', 'leagues.xlsx');
});

/* Export all */
document.getElementById('exportAllCsv').addEventListener('click', ()=>{
  if(matchesResult.length) exportToCSV(matchesResult, ['partido','league','roiLocal','roiVisitante','roiTotal','cntLocal','cntVisitante'], 'matches_all.csv');
  if(teamsResult.length) exportToCSV(teamsResult.map(t=>({team:t.team,matches:t.matches,wins:t.wins,losses:t.losses,profit:t.profit,avgProfit:t.avgProfit,roiPct:t.roiPct})), ['team','matches','wins','losses','profit','avgProfit','roiPct'], 'teams_all.csv');
  if(leaguesResult.length) exportToCSV(leaguesResult, ['league','matches','profit','roiPct'], 'leagues_all.csv');
});
document.getElementById('exportAllXlsx').addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new();
  if(matchesResult.length){ const ws = XLSX.utils.json_to_sheet(matchesResult); XLSX.utils.book_append_sheet(wb, ws, 'matches'); }
  if(teamsResult.length){ const ws2 = XLSX.utils.json_to_sheet(teamsResult); XLSX.utils.book_append_sheet(wb, ws2, 'teams'); }
  if(leaguesResult.length){ const ws3 = XLSX.utils.json_to_sheet(leaguesResult); XLSX.utils.book_append_sheet(wb, ws3, 'leagues'); }
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'}); downloadBlob(new Blob([wbout], {type:'application/octet-stream'}), 'backtesting_all.xlsx');
  log('XLSX all exportado.');
});

/* Clear */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  historial=[]; futuros=[]; matchesResult=[]; teamsResult=[]; leaguesResult=[]; document.querySelectorAll('table tbody').forEach(tb=>tb.innerHTML=''); if(chartTeams) chartTeams.destroy(); if(chartLeagues) chartLeagues.destroy(); document.getElementById('summary').innerHTML=''; log('Memoria limpiada.');
});

log('Interfaz lista ‚Äî sube HISTORIAL y PARTIDOS FUTUROS para ejecutar.');
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Football Backtester v2.0</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* --- ESTILOS (MODO OSCURO PRO) --- */
        :root {
            --bg-main: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --border: #334155;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER SUPERIOR */
        header {
            background-color: var(--bg-panel);
            padding: 0 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            gap: 20px;
        }

        .brand { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; min-width: 200px; }
        .brand i { color: var(--accent); }
        .tag { font-size:0.7em; background:var(--accent); padding:2px 6px; border-radius:4px; color:white; }

        /* Barra de URL */
        .url-bar {
            display: flex;
            flex-grow: 1;
            max-width: 800px;
            gap: 10px;
        }
        .url-input {
            background: var(--bg-main);
            border: 1px solid var(--border);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            font-family: monospace;
        }
        .url-input:focus { border-color: var(--accent); }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); }
        .btn-secondary:hover { background: #475569; }
        .btn-run { background: var(--success); color: white; width: 100%; justify-content: center; padding: 12px; margin-top: auto; }
        .btn-run:hover { background: #059669; }

        input[type="file"] { display: none; }

        /* LAYOUT PRINCIPAL */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        /* SIDEBAR (CONTROLES) */
        .sidebar {
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .sidebar h3 { margin: 0 0 10px 0; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary); }
        
        select, input[type="number"], input[type="date"] {
            width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: white;
        }

        .range-display { display: flex; justify-content: space-between; color: var(--accent); font-size: 0.8rem; margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); }

        /* MAIN CONTENT */
        .main {
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* KPIS */
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .kpi-card { background: var(--bg-panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .kpi-title { font-size: 0.8rem; color: var(--text-secondary); }
        .kpi-value { font-size: 1.4rem; font-weight: 700; margin-top: 5px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* GRÁFICOS */
        .charts-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 300px; }
        .chart-box { background: var(--bg-panel); padding: 10px; border-radius: 8px; border: 1px solid var(--border); position: relative; }

        /* TABLA */
        .table-wrapper { flex-grow: 1; background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .table-scroll { overflow-y: auto; height: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 10px; background: #252f45; position: sticky; top: 0; color: var(--text-secondary); }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(255,255,255,0.03); }

        /* ESTADOS DE CARGA */
        #loadingOverlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 999; text-align: center; padding-top: 20%;
        }
        .spinner { font-size: 3rem; color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #emptyState { text-align: center; color: var(--text-secondary); margin-top: 50px; }
        #emptyState i { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }

    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-circle-notch spinner"></i>
        <h3 style="margin-top: 20px;">Procesando Datos...</h3>
    </div>

    <header>
        <div class="brand">
            <i class="fas fa-chart-line"></i> Backtester <span class="tag">ULTIMATE</span>
        </div>

        <div class="url-bar">
            <input type="text" id="urlInput" class="url-input" placeholder="Pega URL .csv (Ej: football-data.co.uk/mmz4281/2324/E0.csv)">
            <button onclick="loadFromUrl()" class="btn btn-primary">
                <i class="fas fa-cloud-download-alt"></i> Cargar URL
            </button>
        </div>

        <div>
            <label for="fileInput" class="btn btn-secondary">
                <i class="fas fa-folder-open"></i> Archivo Local
            </label>
            <input type="file" id="fileInput" accept=".csv">
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h3>1. Estrategia</h3>
            <div class="control-group">
                <label>Mercado</label>
                <select id="marketSelect">
                    <option value="H">Ganador Local (1)</option>
                    <option value="D">Empate (X)</option>
                    <option value="A">Ganador Visitante (2)</option>
                    <option value="O25">Más de 2.5 Goles</option>
                    <option value="U25">Menos de 2.5 Goles</option>
                </select>
            </div>

            <h3>2. Banca</h3>
            <div class="control-group">
                <label>Gestión de Stake</label>
                <select id="stakeType">
                    <option value="flat">Stake Plano (Fijo)</option>
                    <option value="percent">% del Banco (Compuesto)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Valor (Unidades o %)</label>
                <input type="number" id="stakeValue" value="1" step="0.1">
            </div>
            <div class="control-group">
                <label>Banca Inicial</label>
                <input type="number" id="initialBank" value="1000">
            </div>

            <h3>3. Filtros</h3>
            <div class="control-group">
                <div class="range-display">
                    <span>Cuota Min: <b id="lblMin">1.20</b></span>
                </div>
                <input type="range" id="minOdds" min="1.01" max="10" step="0.01" value="1.20">
            </div>
            <div class="control-group">
                <div class="range-display">
                    <span>Cuota Max: <b id="lblMax">3.00</b></span>
                </div>
                <input type="range" id="maxOdds" min="1.01" max="20" step="0.01" value="3.00">
            </div>

            <div class="control-group">
                <label>Filtrar Liga</label>
                <select id="leagueSelect">
                    <option value="all">Todas las Ligas</option>
                </select>
            </div>
            <div class="control-group">
                <label>Desde la fecha</label>
                <input type="date" id="dateStart">
            </div>

            <button class="btn btn-run" onclick="runBacktest()">
                <i class="fas fa-play"></i> EJECUTAR BACKTEST
            </button>
        </aside>

        <main class="main">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">Total Apuestas</div>
                    <div class="kpi-value" id="valBets">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Win Rate</div>
                    <div class="kpi-value" id="valWinRate">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Profit / Loss</div>
                    <div class="kpi-value" id="valProfit">0.00</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">ROI (Yield)</div>
                    <div class="kpi-value" id="valYield">0%</div>
                </div>
                <div class="kpi-card" style="border-color: var(--danger);">
                    <div class="kpi-title" style="color:#ef4444;">Max Drawdown</div>
                    <div class="kpi-value text-red" id="valDrawdown">0%</div>
                </div>
            </div>

            <div class="charts-wrapper">
                <div class="chart-box">
                    <canvas id="equityChart"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="leagueChart"></canvas>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="table-scroll">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Liga</th>
                                <th>Partido</th>
                                <th>Res</th>
                                <th>Sel</th>
                                <th>Cuota</th>
                                <th>P/L</th>
                                <th>Banca</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                    <div id="emptyState">
                        <i class="fas fa-file-csv"></i>
                        <h3>Esperando datos...</h3>
                        <p>Carga un archivo o pega una URL para comenzar.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Variables Globales
        let rawData = [];
        let chartEqInstance = null;
        let chartLgInstance = null;

        // --- 1. FUNCIONES DE IMPORTACIÓN ---

        // A. Importar archivo local
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            showLoading(true);
            Papa.parse(file, {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: function(res) { processData(res.data); }
            });
        });

        // B. Importar desde URL (Con Proxy CORS)
        async function loadFromUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return alert("Pega una URL válida.");
            
            showLoading(true);
            // Usamos 'allorigins' como proxy gratuito para saltar bloqueo CORS
            const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);

            try {
                const resp = await fetch(proxy);
                if (!resp.ok) throw new Error("Error de red");
                const csvText = await resp.text();
                
                Papa.parse(csvText, {
                    header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: function(res) { processData(res.data); }
                });
            } catch (err) {
                alert("Error al cargar URL. Verifica que el enlace sea directo a un .csv");
                showLoading(false);
            }
        }

        // --- 2. PROCESAMIENTO DE DATOS ---
        function processData(data) {
            // Normalizar datos de Football-Data.co.uk
            rawData = data.map(row => {
                if (!row.Date || !row.HomeTeam) return null;

                // Arreglar Fechas (DD/MM/YY -> YYYY-MM-DD)
                let isoDate = row.Date;
                if (row.Date.includes('/')) {
                    const parts = row.Date.split('/');
                    if (parts.length === 3) {
                        const y = parts[2].length === 2 ? '20'+parts[2] : parts[2];
                        isoDate = `${y}-${parts[1]}-${parts[0]}`;
                    }
                }

                return {
                    date: isoDate,
                    league: row.Div,
                    home: row.HomeTeam,
                    away: row.AwayTeam,
                    res: row.FTR, // H, D, A
                    goalsH: row.FTHG,
                    goalsA: row.FTAG,
                    // Prioridad de cuotas: Bet365 > Pinnacle > Average
                    oddsH: row.B365H || row.PSH || row.AvgH,
                    oddsD: row.B365D || row.PSD || row.AvgD,
                    oddsA: row.B365A || row.PSA || row.AvgA,
                    // Over/Under 2.5 (A veces Avg>2.5 o B365>2.5)
                    oddsO25: row['B365>2.5'] || row.B36525 || row.Avg25 || 0,
                    oddsU25: row['B365<2.5'] || row.B36525_1 || row.Avg25_1 || 0
                };
            }).filter(x => x && x.oddsH); // Quitar nulos

            // Llenar Select de Ligas
            const leagues = [...new Set(rawData.map(d => d.league))].sort();
            const sel = document.getElementById('leagueSelect');
            sel.innerHTML = '<option value="all">Todas las Ligas</option>';
            leagues.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l; opt.text = l; sel.add(opt);
            });

            document.getElementById('emptyState').style.display = 'none';
            showLoading(false);
            runBacktest(); // Ejecutar automáticamente
        }

        // --- 3. MOTOR DE BACKTEST ---
        function runBacktest() {
            if (rawData.length === 0) return;

            // Inputs
            const market = document.getElementById('marketSelect').value;
            const stakeType = document.getElementById('stakeType').value;
            const stakeVal = parseFloat(document.getElementById('stakeValue').value);
            const initBank = parseFloat(document.getElementById('initialBank').value);
            const minO = parseFloat(document.getElementById('minOdds').value);
            const maxO = parseFloat(document.getElementById('maxOdds').value);
            const lg = document.getElementById('leagueSelect').value;
            const dateStart = document.getElementById('dateStart').value;

            // Variables de cálculo
            let bank = initBank;
            let peak = initBank;
            let maxDD = 0;
            let wins = 0;
            let history = [{x: 'Inicio', y: initBank}];
            let tableRows = [];
            let leagueProfits = {};

            const filtered = rawData.filter(m => {
                if (lg !== 'all' && m.league !== lg) return false;
                if (dateStart && m.date < dateStart) return false;
                return true;
            });

            filtered.forEach(m => {
                let odds = 0;
                let won = false;
                let selTxt = "";

                // Lógica Mercados
                if (market === 'H') { odds = m.oddsH; won = m.res === 'H'; selTxt = "Local"; }
                else if (market === 'D') { odds = m.oddsD; won = m.res === 'D'; selTxt = "Empate"; }
                else if (market === 'A') { odds = m.oddsA; won = m.res === 'A'; selTxt = "Visita"; }
                else if (market === 'O25') { odds = m.oddsO25; won = (m.goalsH+m.goalsA) > 2.5; selTxt = ">2.5"; }
                else if (market === 'U25') { odds = m.oddsU25 || 1.9; won = (m.goalsH+m.goalsA) < 2.5; selTxt = "<2.5"; }

                // Filtro Cuotas
                if (odds < minO || odds > maxO || odds === 0) return;

                // Stake
                let stake = (stakeType === 'flat') ? stakeVal : (bank * (stakeVal/100));
                
                // P/L
                let pnl = won ? (stake * odds - stake) : -stake;
                bank += pnl;
                if (won) wins++;

                // Drawdown
                if (bank > peak) peak = bank;
                let dd = ((peak - bank) / peak) * 100;
                if (dd > maxDD) maxDD = dd;

                // Datos Gráfico
                history.push({x: m.date, y: bank});

                // Datos Liga
                if (!leagueProfits[m.league]) leagueProfits[m.league] = 0;
                leagueProfits[m.league] += pnl;

                // Datos Tabla
                tableRows.push({
                    date: m.date, league: m.league, match: `${m.home} vs ${m.away}`,
                    res: `${m.goalsH}-${m.goalsA}`, sel: selTxt, odds: odds, pnl: pnl, bank: bank
                });
            });

            updateUI(history, tableRows, wins, initBank, bank, maxDD, leagueProfits);
        }

        // --- 4. UI Y GRÁFICOS ---
        function updateUI(history, rows, wins, start, end, dd, lgData) {
            const total = rows.length;
            const profit = end - start;
            const yieldVal = total > 0 ? (profit / total).toFixed(2) : 0; // Yield simplificado a unidades promedio

            // KPIs
            document.getElementById('valBets').innerText = total;
            document.getElementById('valWinRate').innerText = total ? ((wins/total)*100).toFixed(1) + "%" : "0%";
            
            const pEl = document.getElementById('valProfit');
            pEl.innerText = profit.toFixed(2);
            pEl.className = "kpi-value " + (profit >= 0 ? "text-green" : "text-red");

            document.getElementById('valYield').innerText = yieldVal + "u/bet";
            document.getElementById('valDrawdown').innerText = "-" + dd.toFixed(2) + "%";

            // Tabla (Últimos 50)
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            rows.slice(-50).reverse().forEach(r => {
                const tr = `<tr>
                    <td>${r.date}</td><td>${r.league}</td><td>${r.match}</td>
                    <td>${r.res}</td><td>${r.sel}</td><td>${r.odds.toFixed(2)}</td>
                    <td class="${r.pnl>=0?'text-green':'text-red'}">${r.pnl.toFixed(2)}</td>
                    <td>${r.bank.toFixed(0)}</td>
                </tr>`;
                tbody.innerHTML += tr;
            });

            renderCharts(history, lgData);
        }

        function renderCharts(history, lgData) {
            // 1. Line Chart
            const ctxEq = document.getElementById('equityChart').getContext('2d');
            if (chartEqInstance) chartEqInstance.destroy();
            
            // Optimizar puntos si son muchos
            const chartData = history.length > 500 ? history.filter((_,i) => i%5 === 0) : history;

            chartEqInstance = new Chart(ctxEq, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.x),
                    datasets: [{
                        label: 'Banca', data: chartData.map(d => d.y),
                        borderColor: '#3b82f6', borderWidth: 2, radius: 0, fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display:false}, title: {display:true, text:'Curva de Equidad'} },
                    scales: { x: {display:false}, y: {grid:{color:'#334155'}} }
                }
            });

            // 2. Bar Chart (Ligas)
            const ctxLg = document.getElementById('leagueChart').getContext('2d');
            if (chartLgInstance) chartLgInstance.destroy();
            const sorted = Object.entries(lgData).sort((a,b) => b[1] - a[1]);

            chartLgInstance = new Chart(ctxLg, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: sorted.map(s => s[1]>=0 ? '#10b981':'#ef4444')
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: {display:false}, title: {display:true, text:'Por Ligas'} },
                    scales: { x: {grid:{color:'#334155'}} }
                }
            });
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'block' : 'none';
        }

        // Listeners Inputs
        document.getElementById('minOdds').addEventListener('input', e => {
            document.getElementById('lblMin').innerText = parseFloat(e.target.value).toFixed(2);
        });
        document.getElementById('maxOdds').addEventListener('input', e => {
            document.getElementById('lblMax').innerText = parseFloat(e.target.value).toFixed(2);
        });

    </script>
</body>
</html>

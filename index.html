<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Backtesting Fútbol — Over/Under, BTTS, 1X2, Corners, Tarjetas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6;
    --border:#2a3140;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  header{padding:20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#121620,#0f1115)}
  h1{margin:0; font-size:20px}
  .wrap{max-width:1200px; margin:0 auto; padding:20px}
  .grid{display:grid; gap:16px}
  .g2{grid-template-columns: repeat(2, minmax(0,1fr))}
  .g3{grid-template-columns: repeat(3, minmax(0,1fr))}
  @media (max-width:980px){ .g2,.g3{grid-template-columns:1fr}}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px}
  .card h2{margin:0 0 10px; font-size:16px}
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
  select,input,textarea,button{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    background:var(--panel2); color:var(--text); font-size:14px; outline:none;
  }
  textarea{min-height:120px; resize:vertical}
  button{background:var(--accent); border:none; font-weight:600; cursor:pointer}
  button.secondary{background:transparent; border:1px solid var(--border)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}
  .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--panel2); color:var(--muted)}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--border); background:var(--panel2); border-radius:10px}
  .flex{display:flex; gap:12px; flex-wrap:wrap}
  .foot{margin-top:6px; color:var(--muted); font-size:12px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th, td{padding:10px; border-bottom:1px solid var(--border); text-align:left}
  th{color:var(--muted); font-weight:600}
  .stat{font-weight:700}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Backtesting Fútbol — Over/Under, BTTS, 1X2, Corners, Tarjetas</h1>
    <div class="foot">Señal: promedio por equipo de L5 ≥ 70% y L10 ≥ 60%. Split sobre <u>señales</u> (70/30).</div>
  </div>
</header>

<main class="wrap grid g2">

  <!-- 1) Carga -->
  <section class="card">
    <h2>1) Cargar datos</h2>
    <div class="grid g2">
      <div>
        <label>Archivo JSON (.json) — array u objeto</label>
        <input type="file" id="fileInput" accept=".json,application/json">
      </div>
      <div>
        <label>Pegar JSON (opcional)</label>
        <textarea id="jsonTextarea" placeholder='Pegue aquí su JSON...'></textarea>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnLoad">Cargar</button>
      <button class="secondary" id="btnDemo">Cargar Demo</button>
    </div>
    <div id="loadStatus" class="foot"></div>
  </section>

  <!-- 2) Selección -->
  <section class="card">
    <h2>2) Selección de Liga y Equipos</h2>
    <div class="grid g3">
      <div>
        <label>Liga</label>
        <select id="leagueSelect"><option value="">—</option></select>
      </div>
      <div>
        <label>Equipo Local</label>
        <select id="homeSelect"><option value="">—</option></select>
      </div>
      <div>
        <label>Equipo Visitante</label>
        <select id="awaySelect"><option value="">—</option></select>
      </div>
    </div>
    <div class="foot">Los equipos se basan en los partidos detectados de la liga seleccionada.</div>
  </section>

  <!-- 3) Señales -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>3) Condiciones de Señal</h2>
      <span class="badge">Promedio por equipo (misma liga)</span>
    </div>
    <div class="grid g3">
      <div>
        <label>Últimos 5 — mínimo %</label>
        <input id="th5" type="number" min="0" max="100" step="1" value="70">
      </div>
      <div>
        <label>Últimos 10 — mínimo %</label>
        <input id="th10" type="number" min="0" max="100" step="1" value="60">
      </div>
      <div>
        <label>Ámbito Rolling</label>
        <select id="rollingScope">
          <option value="league" selected>Misma liga</option>
          <option value="all">Todas las ligas</option>
        </select>
      </div>
    </div>
    <div class="foot">Para cada partido objetivo se promedia el % del mercado de cada equipo en sus últimos N previos.</div>
  </section>

  <!-- 4) Mercados -->
  <section class="card">
    <h2>4) Parámetros de Mercados</h2>
    <div class="grid g3">
      <div>
        <label>Over/Under Goles — Línea</label>
        <select id="ouGoalsLine">
          <option>1.5</option><option selected>2.5</option><option>3.5</option><option>4.5</option>
        </select>
      </div>
      <div>
        <label>ODD por defecto Over/Under Goles</label>
        <input id="ouGoalsOdd" type="number" step="0.01" value="1.90">
      </div>
      <div>
        <label>Dirección Goles</label>
        <select id="ouGoalsDir">
          <option value="over" selected>Over</option>
          <option value="under">Under</option>
        </select>
      </div>

      <div>
        <label>BTTS (Ambos marcan) — ODD por defecto</label>
        <input id="bttsOdd" type="number" step="0.01" value="2.00">
      </div>
      <div>
        <label>1X2 — Selección</label>
        <select id="w12Pick">
          <option value="1" selected>1 (Local)</option>
          <option value="X">X (Empate)</option>
          <option value="2">2 (Visita)</option>
        </select>
      </div>
      <div>
        <label>1X2 — ODD por defecto</label>
        <input id="w12Odd" type="number" step="0.01" value="2.10">
      </div>

      <div>
        <label>Over/Under Corners — Línea</label>
        <select id="ouCornersLine">
          <option>7.5</option><option selected>8.5</option><option>9.5</option><option>10.5</option>
        </select>
      </div>
      <div>
        <label>ODD por defecto Corners</label>
        <input id="ouCornersOdd" type="number" step="0.01" value="1.90">
      </div>
      <div>
        <label>Dirección Corners</label>
        <select id="ouCornersDir">
          <option value="over" selected>Over</option>
          <option value="under">Under</option>
        </select>
      </div>

      <div>
        <label>Over/Under Tarjetas — Línea</label>
        <select id="ouCardsLine">
          <option>3.5</option><option selected>4.5</option><option>5.5</option><option>6.5</option>
        </select>
      </div>
      <div>
        <label>ODD por defecto Tarjetas</label>
        <input id="ouCardsOdd" type="number" step="0.01" value="1.85">
      </div>
      <div>
        <label>Dirección Tarjetas</label>
        <select id="ouCardsDir">
          <option value="over" selected>Over</option>
          <option value="under">Under</option>
        </select>
      </div>
    </div>
  </section>

  <!-- 5) Ejecutar -->
  <section class="card">
    <h2>5) Ejecutar Backtest</h2>
    <div class="row">
      <button id="btnRun">Calcular Backtesting</button>
      <span class="pill"><strong>Split:</strong> 70% Train • 30% Test (sobre señales)</span>
      <span class="pill"><strong>Stake:</strong> 1 por apuesta</span>
    </div>
    <div id="runStatus" class="foot"></div>
  </section>

  <!-- Resultados -->
  <section class="card" style="grid-column:1/-1">
    <h2>Resultados</h2>
    <div id="summary"></div>
    <div style="margin-top:12px" id="tables"></div>
  </section>

</main>

<script>
(() => {
  // ========= Utilidades =========
  const months = {
    'ene':'01','feb':'02','mar':'03','abr':'04','may':'05','jun':'06',
    'jul':'07','ago':'08','sep':'09','sept':'09','oct':'10','nov':'11','dic':'12'
  };

  function parseSpanishDate(s){
    if(!s || typeof s !== 'string') return null;
    let t = s.toLowerCase().replaceAll('\\u00a0',' ').trim();
    t = t.replace(/^[a-záéíóúüñ]{2,4}\\.,?\\s*/i,''); // quita "dom.,"
    const m = t.match(/(\\d{1,2})\\s+([a-záéíóúüñ\\.]{3,5})\\.?\\s+(\\d{4})(?:\\s+(\\d{1,2}):(\\d{2}))?/i);
    if(!m) return new Date(t);
    const dd = m[1].padStart(2,'0');
    const monKey = m[2].replace('.', '').slice(0,4).replace('sépt','sept').replace('set','sep');
    const mm = months[monKey] || months[monKey.slice(0,3)] || '01';
    const yyyy = m[3];
    const HH = (m[4]||'00').padStart(2,'0');
    const MM = (m[5]||'00').padStart(2,'0');
    return new Date(`${yyyy}-${mm}-${dd}T${HH}:${MM}:00`);
  }

  function toNumber(x){
    if (x === null || x === undefined) return null;
    const n = Number(String(x).toString().replace(',', '.').replace(/[^\\d\\.\\-]/g,''));
    return Number.isFinite(n) ? n : null;
  }

  function cleanStr(s){
    if(!s) return '';
    return String(s).replace(/�/g,'ú').trim();
  }

  function deriveFields(rec){
    const out = {...rec};
    out.League = cleanStr(rec.League);
    out.Match = cleanStr(rec.Match);

    // Equipos desde "Match": "Banfield - Instituto"
    let homeName = null, awayName = null;
    if (out.Match && out.Match.includes('-')){
      const [h,a] = out.Match.split('-');
      homeName = cleanStr(h);
      awayName = cleanStr(a);
    }
    out.HomeTeam = homeName || cleanStr(rec.HomeTeam) || '';
    out.AwayTeam = awayName || cleanStr(rec.AwayTeam) || '';
    out._date = parseSpanishDate(rec.Date);

    // Marcador FT "x-y"
    const ft = cleanStr(rec['Result FT'] || rec['FT'] || '');
    let gh=null, ga=null;
    if (/\\d+\\s*-\\s*\\d+/.test(ft)){
      const [h,a] = ft.split('-').map(v=>toNumber(v));
      gh = h; ga = a;
    }
    out.GoalsHome = gh;
    out.GoalsAway = ga;
    out._totalGoals = (gh ?? 0) + (ga ?? 0);

    // Corners / Tarjetas
    const hc = toNumber(rec['Home Corners at FT']);
    const ac = toNumber(rec['Away Corners at FT']);
    const hy = toNumber(rec['Home YellowCards at FT']);
    const ay = toNumber(rec['Away YellowCards at FT']);
    const hr = toNumber(rec['Home RedCards at FT']);
    const ar = toNumber(rec['Away RedCards at FT']);
    out.CornersTotal = (hc ?? 0) + (ac ?? 0);
    // Si prefieres roja=2, cambia a: (hy??0)+(ay??0)+2*((hr??0)+(ar??0))
    out.CardsTotal = (hy ?? 0) + (ay ?? 0) + (hr ?? 0) + (ar ?? 0);

    // BTTS
    out.BTTS = (Number.isFinite(gh) && Number.isFinite(ga)) ? (gh>0 && ga>0) : null;

    // 1X2
    out.W12 = (Number.isFinite(gh) && Number.isFinite(ga))
      ? (gh>ga ? '1' : (gh<ga ? '2' : 'X')) : null;

    // Odds conocidas
    out.Odd1 = toNumber(rec['Odd 1 PreMatch']);
    out.OddX = toNumber(rec['Odd X PreMatch']);
    out.Odd2 = toNumber(rec['Odd 2 PreMatch']);
    out.OddGeneric = toNumber(rec['Odd']);

    out._valid = !!(out.League && out.HomeTeam && out.AwayTeam && out._date instanceof Date && !isNaN(out._date));
    return out;
  }

  function ensureArray(data){
    if (Array.isArray(data)) return data;
    if (typeof data === 'object' && data) return [data];
    return [];
  }

  function byDateAsc(a,b){ return a._date - b._date; }

  // ========= Estado =========
  let RAW = [];
  let DATA = [];
  let filteredLeague = '';
  let selectedHome = '';
  let selectedAway = '';

  // ========= DOM =========
  const fileInput = document.getElementById('fileInput');
  const jsonTextarea = document.getElementById('jsonTextarea');
  const btnLoad = document.getElementById('btnLoad');
  const btnDemo = document.getElementById('btnDemo');
  const loadStatus = document.getElementById('loadStatus');

  const leagueSelect = document.getElementById('leagueSelect');
  const homeSelect = document.getElementById('homeSelect');
  const awaySelect = document.getElementById('awaySelect');

  const th5 = document.getElementById('th5');
  const th10 = document.getElementById('th10');
  const rollingScope = document.getElementById('rollingScope');

  const ouGoalsLine = document.getElementById('ouGoalsLine');
  const ouGoalsOdd  = document.getElementById('ouGoalsOdd');
  const ouGoalsDir  = document.getElementById('ouGoalsDir');

  const bttsOdd = document.getElementById('bttsOdd');

  const w12Pick = document.getElementById('w12Pick');
  const w12Odd  = document.getElementById('w12Odd');

  const ouCornersLine = document.getElementById('ouCornersLine');
  const ouCornersOdd  = document.getElementById('ouCornersOdd');
  const ouCornersDir  = document.getElementById('ouCornersDir');

  const ouCardsLine = document.getElementById('ouCardsLine');
  const ouCardsOdd  = document.getElementById('ouCardsOdd');
  const ouCardsDir  = document.getElementById('ouCardsDir');

  const btnRun = document.getElementById('btnRun');
  const runStatus = document.getElementById('runStatus');
  const summary = document.getElementById('summary');
  const tables = document.getElementById('tables');

  // ========= Carga =========
  btnDemo.addEventListener('click', () => {
    const demo = [{
      "Name":"12 Meses","Desired Outcome":"GG","Odd":"2.25","Date":"dom., 01 sept. 2024 18:00",
      "League":"Argentina Liga Profesional de Fútbol","Match":"Banfield - Instituto",
      "Home Attacks at FT":"98","Away Attacks at FT":"94","Home Dangerous Attacks at FT":"62","Away Dangerous Attacks at FT":"59",
      "Home OnGoal Shots at FT":"5","Away OnGoal Shots at FT":"8","Home Total Shots at FT":"15","Away Total Shots at FT":"22",
      "Home Ball Possession at FT":"49","Away Ball Possession at FT":"51","Home Corners at FT":"7","Away Corners at FT":"8",
      "Home RedCards at FT":"0","Away RedCards at FT":"0","Home YellowCards at FT":"3","Away YellowCards at FT":"5",
      "Result HT":"0-1","Result FT":"1-2","Odd 1 PreMatch":"3.00","Odd X PreMatch":"2.80","Odd 2 PreMatch":"2.75",
      "Home Position":"25","Away Position":"7","Result":"Winning","Success Rate":"","Overall ROI":""
    }];
    jsonTextarea.value = JSON.stringify(demo, null, 2);
  });

  btnLoad.addEventListener('click', async () => {
    try{
      let text = jsonTextarea.value.trim();
      if (!text && fileInput.files && fileInput.files[0]){
        text = await fileInput.files[0].text();
      }
      if (!text){ loadStatus.textContent = '❗ Proporciona un archivo o pega JSON.'; return; }

      const parsed = JSON.parse(text);
      RAW = ensureArray(parsed).filter(Boolean);
      if (!RAW.length){ loadStatus.textContent = '❗ JSON vacío.'; return; }

      DATA = RAW.map(deriveFields).filter(r=>r._valid).sort(byDateAsc);

      const leagues = [...new Set(DATA.map(d=>d.League).filter(Boolean))].sort();
      leagueSelect.innerHTML = '<option value="">—</option>' + leagues.map(l=>`<option>${l}</option>`).join('');
      homeSelect.innerHTML = '<option value="">—</option>';
      awaySelect.innerHTML = '<option value="">—</option>';

      loadStatus.textContent = `✅ Registros cargados: ${DATA.length}. Ligas detectadas: ${leagues.length}.`;
    }catch(err){
      console.error(err);
      loadStatus.textContent = '❗ Error al leer/parsear JSON.';
    }
  });

  leagueSelect.addEventListener('change', () => {
    filteredLeague = leagueSelect.value || '';
    const teams = new Set();
    DATA.filter(d => !filteredLeague || d.League === filteredLeague)
        .forEach(d => { teams.add(d.HomeTeam); teams.add(d.AwayTeam); });
    const options = '<option value="">—</option>' + [...teams].filter(Boolean).sort().map(t=>`<option>${t}</option>`).join('');
    homeSelect.innerHTML = options;
    awaySelect.innerHTML = options;
  });

  homeSelect.addEventListener('change', () => selectedHome = homeSelect.value || '');
  awaySelect.addEventListener('change', () => selectedAway = awaySelect.value || '');

  // ========= Lógica de mercados =========
  function isOver(total, line){ return total > line; }
  function isUnder(total, line){ return total < line; }

  function marketEval(rec, cfg){
    switch(cfg.type){
      case 'OU_GOALS': {
        const line = parseFloat(cfg.line);
        if (!Number.isFinite(rec._totalGoals)) return null;
        return (cfg.dir === 'over') ? isOver(rec._totalGoals, line) : isUnder(rec._totalGoals, line);
      }
      case 'BTTS': {
        return rec.BTTS === true ? true : (rec.BTTS === false ? false : null);
      }
      case 'W12': {
        if (!rec.W12) return null;
        return rec.W12 === cfg.pick;
      }
      case 'OU_CORNERS': {
        if (!Number.isFinite(rec.CornersTotal)) return null;
        const line = parseFloat(cfg.line);
        return (cfg.dir === 'over') ? isOver(rec.CornersTotal, line) : isUnder(rec.CornersTotal, line);
      }
      case 'OU_CARDS': {
        if (!Number.isFinite(rec.CardsTotal)) return null;
        const line = parseFloat(cfg.line);
        return (cfg.dir === 'over') ? isOver(rec.CardsTotal, line) : isUnder(rec.CardsTotal, line);
      }
      default: return null;
    }
  }

  function getOdd(rec, cfg){
    switch(cfg.type){
      case 'OU_GOALS': return toNumber(rec.OddOUGoals) || cfg.oddDefault;
      case 'BTTS': return toNumber(rec.OddBTTS) || rec.OddGeneric || cfg.oddDefault;
      case 'W12':
        if (cfg.pick==='1') return rec.Odd1 || cfg.oddDefault;
        if (cfg.pick==='X') return rec.OddX || cfg.oddDefault;
        if (cfg.pick==='2') return rec.Odd2 || cfg.oddDefault;
        return cfg.oddDefault;
      case 'OU_CORNERS': return toNumber(rec.OddOUCorners) || cfg.oddDefault;
      case 'OU_CARDS': return toNumber(rec.OddOUCards) || cfg.oddDefault;
      default: return cfg.oddDefault;
    }
  }

  // últimos previos de un equipo (estrictamente antes del partido objetivo)
  function lastMatchesForTeam(all, team, untilDate, scope, league){
    return all.filter(r=>{
      if (!(r._date instanceof Date)) return false;
      if (r._date >= untilDate) return false;
      if (scope === 'league' && league && r.League !== league) return false;
      return (r.HomeTeam === team || r.AwayTeam === team);
    }).sort(byDateAsc);
  }

  // % en últimos N de un equipo
  function teamPct(prevArr, cfg, N){
    const last = prevArr.slice(-N);
    const evals = last.map(r => marketEval(r, cfg)).filter(v => v !== null);
    if (!evals.length) return null;
    const hits = evals.filter(Boolean).length;
    return 100 * hits / evals.length;
  }

  // Promedio por equipo L5/L10
  function rollingPctTeamAvg(all, home, away, untilDate, scope, league, cfg){
    const prevH = lastMatchesForTeam(all, home, untilDate, scope, league);
    const prevA = lastMatchesForTeam(all, away, untilDate, scope, league);

    const p5h  = teamPct(prevH, cfg, 5);
    const p5a  = teamPct(prevA, cfg, 5);
    const p10h = teamPct(prevH, cfg, 10);
    const p10a = teamPct(prevA, cfg, 10);

    const p5  = (p5h  !== null && p5a  !== null) ? (p5h  + p5a ) / 2 : null;
    const p10 = (p10h !== null && p10a !== null) ? (p10h + p10a) / 2 : null;

    return { p5, p10, details: { p5h, p5a, p10h, p10a } };
  }

  function qualifiesSignalAvg(sig, th5, th10){
    return (sig && sig.p5  !== null && sig.p5  >= th5) &&
           (sig && sig.p10 !== null && sig.p10 >= th10);
  }

  // ROI
  function roiFromBets(bets){
    if (!bets.length) return {bets:0, wins:0, hit:null, pnl:0, roi:null};
    let pnl = 0, wins = 0;
    for (const b of bets){
      if (b.win){ pnl += (b.odd - 1); wins++; }
      else { pnl -= 1; }
    }
    const hit = 100 * wins / bets.length;
    const roi = 100 * pnl / bets.length;
    return {bets:bets.length, wins, hit, pnl, roi};
  }

  function formatPct(x){ return (x===null || x===undefined) ? '—' : x.toFixed(1)+'%'; }
  function formatNum(x, d=2){ return (x===null || x===undefined) ? '—' : x.toFixed(d); }

  // Reporte por mercado con split sobre señales
  function marketReport(allMatchesBetween, allUniverse, home, away, league, cfg, th5, th10, scope){
    const events = allMatchesBetween
      .filter(r => r._date instanceof Date)
      .sort(byDateAsc)
      .map(rec => {
        const sig = rollingPctTeamAvg(allUniverse, home, away, rec._date, scope, league, cfg);
        const qualifies = qualifiesSignalAvg(sig, th5, th10);
        const win = marketEval(rec, cfg);
        const odd = getOdd(rec, cfg);
        return { rec, sig, qualifies, win, odd };
      });

    const signals = events.filter(e =>
      e.qualifies && e.win !== null && Number.isFinite(e.odd) && e.odd > 1
    );

    const cut = Math.max(1, Math.floor(signals.length * 0.7));
    const trainSignals = signals.slice(0, cut);
    const testSignals  = signals.slice(cut);

    const aggTrain = roiFromBets(trainSignals.map(s => ({ win: s.win, odd: s.odd })));
    const aggTest  = roiFromBets(testSignals.map(s  => ({ win: s.win, odd: s.odd })));

    aggTrain.sample = trainSignals.length;
    aggTest.sample  = testSignals.length;

    const evalsAll = allMatchesBetween.map(r => marketEval(r, cfg)).filter(v => v !== null);
    const hitAll = evalsAll.length ? (100 * evalsAll.filter(Boolean).length / evalsAll.length) : null;

    return { aggTrain, aggTest, hitAll, nAll: allMatchesBetween.length };
  }

  function buildTableRow(name, res){
    return `
      <tr>
        <td>${name}</td>
        <td>${res.nAll}</td>
        <td class="stat">${formatPct(res.hitAll)}</td>
        <td>${res.aggTrain.sample}</td>
        <td>${res.aggTrain.bets}</td>
        <td>${formatPct(res.aggTrain.hit)}</td>
        <td>${formatNum(res.aggTrain.pnl)}</td>
        <td class="stat">${formatPct(res.aggTrain.roi)}</td>
        <td>${res.aggTest.sample}</td>
        <td>${res.aggTest.bets}</td>
        <td>${formatPct(res.aggTest.hit)}</td>
        <td>${formatNum(res.aggTest.pnl)}</td>
        <td class="stat">${formatPct(res.aggTest.roi)}</td>
      </tr>
    `;
  }

  function renderResults(ctx){
    const { league, home, away, th5, th10, scope, cfgs, between, universe } = ctx;
    document.getElementById('summary').innerHTML = `
      <div class="flex">
        <span class="pill"><strong>Liga:</strong> ${league || '—'}</span>
        <span class="pill"><strong>Local:</strong> ${home || '—'}</span>
        <span class="pill"><strong>Visita:</strong> ${away || '—'}</span>
        <span class="pill"><strong>Señal:</strong> L5 ≥ ${th5}% • L10 ≥ ${th10}% (promedio por equipo)</span>
        <span class="pill"><strong>H2H:</strong> ${between.length}</span>
      </div>
      <div class="foot" style="margin-top:6px">
        Las señales se generan con el promedio del % del mercado en los últimos N de cada equipo (previos al partido).
        El backtest divide por la serie temporal de <u>señales</u>: 70% Train y 30% Test.
      </div>
    `;

    let html = `
      <table>
        <thead>
          <tr>
            <th>Mercado</th>
            <th>H2H N</th>
            <th>Hit% Global</th>
            <th colspan="5">TRAIN (70% señales)</th>
            <th colspan="5">TEST (30% señales)</th>
          </tr>
          <tr>
            <th></th><th></th><th></th>
            <th>Señales</th><th>Bets</th><th>Hit%</th><th>PNL</th><th>ROI</th>
            <th>Señales</th><th>Bets</th><th>Hit%</th><th>PNL</th><th>ROI</th>
          </tr>
        </thead>
        <tbody>
    `;
    cfgs.forEach(cfg=>{
      const rep = marketReport(between, universe, home, away, league, cfg, th5, th10, scope);
      html += buildTableRow(cfg._label, rep);
    });
    html += `</tbody></table>`;
    document.getElementById('tables').innerHTML = html;
  }

  // ========= Ejecutar =========
  document.getElementById('btnRun').addEventListener('click', () => {
    document.getElementById('tables').innerHTML = '';
    document.getElementById('summary').innerHTML = '';
    document.getElementById('runStatus').textContent = '';

    const league = leagueSelect.value || '';
    const home = homeSelect.value || '';
    const away = awaySelect.value || '';
    if (!DATA.length){ runStatus.textContent = '❗ Carga datos primero.'; return; }
    if (!league || !home || !away){ runStatus.textContent = '❗ Selecciona liga, local y visita.'; return; }
    if (home === away){ runStatus.textContent = '❗ Local y visita no pueden ser iguales.'; return; }

    const scope = rollingScope.value;
    const th_5 = Number(th5.value)||70;
    const th_10 = Number(th10.value)||60;

    const universe = DATA;

    // H2H dentro de la liga seleccionada
    const between = DATA.filter(r=>{
      if (r.League !== league) return false;
      if (!(r._date instanceof Date)) return false;
      const h2h = (r.HomeTeam===home && r.AwayTeam===away) || (r.HomeTeam===away && r.AwayTeam===home);
      return h2h;
    }).sort(byDateAsc);

    const cfgs = [
      { type:'OU_GOALS', line: parseFloat(ouGoalsLine.value), dir: ouGoalsDir.value, oddDefault: parseFloat(ouGoalsOdd.value), _label:`Over/Under Goles ${ouGoalsDir.value.toUpperCase()} ${ouGoalsLine.value}` },
      { type:'BTTS', oddDefault: parseFloat(bttsOdd.value), _label:'BTTS (Ambos marcan)' },
      { type:'W12', pick: w12Pick.value, oddDefault: parseFloat(w12Odd.value), _label:`1X2 — Pick ${w12Pick.value}` },
      { type:'OU_CORNERS', line: parseFloat(ouCornersLine.value), dir: ouCornersDir.value, oddDefault: parseFloat(ouCornersOdd.value), _label:`Over/Under Corners ${ouCornersDir.value.toUpperCase()} ${ouCornersLine.value}` },
      { type:'OU_CARDS', line: parseFloat(ouCardsLine.value), dir: ouCardsDir.value, oddDefault: parseFloat(ouCardsOdd.value), _label:`Over/Under Tarjetas ${ouCardsDir.value.toUpperCase()} ${ouCardsLine.value}` },
    ];

    renderResults({ league, home, away, th5:th_5, th10:th_10, scope, cfgs, between, universe });

    runStatus.textContent = between.length
      ? `✅ Calculado sobre ${between.length} partidos H2H.`
      : `⚠️ No hay partidos H2H en la liga seleccionada para ${home} vs ${away}.`;
  });

})();
</script>
</body>
</html>
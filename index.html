<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora estilo OddAlerts — EV & Kelly</title>
  <style>
    :root{
      --bg:#071026; --card:#0f1b2b; --muted:#94a3b8; --accent:#06b6d4;
      --glass: rgba(255,255,255,0.03); --success:#10b981; --danger:#ef4444;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#031024);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:980px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0ea5a7);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021423}
    h1{font-size:18px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.03)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
    .row{display:flex;gap:10px}
    .small{flex:1}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#021423;font-weight:600;cursor:pointer}
    .out{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .metric{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .metric h3{margin:0;font-size:13px;color:var(--muted)}
    .metric p{margin:6px 0 0;font-size:18px;font-weight:700}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    .good{color:var(--success);font-weight:700}
    .bad{color:var(--danger);font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
      .out{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">OA</div>
      <div>
        <h1>Calculadora estilo OddAlerts — EV & Kelly</h1>
        <div style="font-size:13px;color:var(--muted)">Introduce tu probabilidad (modelo) y la cuota del book — detecta valor y stake sugerido.</div>
      </div>
    </header>

    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <label>Partido / Mercado (opcional)</label>
        <input id="match" type="text" placeholder="Ej: Team A vs Team B — BTTS / Over 2.5">

        <div style="height:10px"></div>

        <label>Probabilidad de tu modelo (p) <span class="hint">Introduce en porcentaje o decimal</span></label>
        <div class="row">
          <input id="probPercent" class="small" type="number" min="0" max="100" step="0.01" placeholder="58.5 (en %)">
          <input id="probDecimal" class="small" type="number" min="0" max="1" step="0.0001" placeholder="0.585 (en decimal)">
        </div>

        <div style="height:10px"></div>

        <label>Cuota del bookmaker (decimal)</label>
        <input id="oddsDecimal" type="number" min="1" step="0.001" placeholder="Ej: 2.05">

        <div style="height:10px"></div>

        <label>Bankroll (moneda local)</label>
        <input id="bankroll" type="number" min="0" step="0.01" placeholder="Ej: 1000">

        <div style="height:10px"></div>

        <label>Opciones Kelly</label>
        <div class="row">
          <select id="kellyMode" class="small">
            <option value="full">Kelly completo</option>
            <option value="half">1/2 Kelly</option>
            <option value="quarter">1/4 Kelly</option>
          </select>
          <select id="stakeMode" class="small">
            <option value="currency">Mostrar stake en moneda</option>
            <option value="percent">Mostrar stake en % bankroll</option>
          </select>
        </div>

        <div style="height:12px"></div>

        <div class="controls">
          <button id="calcBtn">Calcular</button>
          <button id="resetBtn" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)">Limpiar</button>
        </div>

        <div class="hint">Consejo: tu "probabilidad de modelo" debe reflejar tu estimación previa al partido (Poisson, ELO, histórico, etc.).</div>
      </div>

      <!-- Outputs -->
      <div class="card">
        <div class="out">
          <div class="metric">
            <h3>Implied probability (book)</h3>
            <p id="impliedProb">—</p>
          </div>
          <div class="metric">
            <h3>Cuota justa (fair odds)</h3>
            <p id="fairOdds">—</p>
          </div>

          <div class="metric">
            <h3>Edge / Value</h3>
            <p id="edge">—</p>
          </div>
          <div class="metric">
            <h3>Expected Value (EV)</h3>
            <p id="ev">—</p>
          </div>

          <div class="metric">
            <h3>Kelly (fracción)</h3>
            <p id="kelly">—</p>
          </div>
          <div class="metric">
            <h3>Stake sugerido</h3>
            <p id="stake">—</p>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card" style="background:transparent;padding:10px;border:none">
          <div style="font-size:13px;color:var(--muted)"><strong>Conversor de cuotas</strong></div>
          <div style="height:8px"></div>
          <div class="row">
            <input id="convertOdds" type="number" min="1" step="0.001" placeholder="Decimal (ej. 2.15)">
            <button id="convBtn" style="padding:8px">Convertir</button>
          </div>
          <div style="height:8px"></div>
          <div style="display:flex;gap:10px">
            <div style="flex:1">
              <div style="font-size:12px;color:var(--muted)">Fraccional</div>
              <div id="convFraction" style="font-weight:700;margin-top:4px">—</div>
            </div>
            <div style="flex:1">
              <div style="font-size:12px;color:var(--muted)">Americana</div>
              <div id="convAmerican" style="font-weight:700;margin-top:4px">—</div>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="hint">¿Quieres que esto haga backtest o que ejecute simulaciones Poisson+MC? Puedo integrarlo.</div>
      </div>
    </div>

    <footer>Hecho para integración con motores de predicción. Puedo añadir: import CSV, Poisson+Monte Carlo, reglas de filtro (min odds, ligas), y conexión a API.</footer>
  </div>

  <script>
    // Utilities
    function toNumber(v){ const n = parseFloat(v); return isNaN(n)?null:n; }
    function pct(x){ return (x*100).toFixed(2) + '%'; }
    function f(x, d=4){ if (x===null || x===undefined || isNaN(x)) return '—'; return Number(x).toFixed(d).replace(/\.?0+$/,''); }

    // DOM
    const probPercent = document.getElementById('probPercent');
    const probDecimal = document.getElementById('probDecimal');
    const oddsDecimal = document.getElementById('oddsDecimal');
    const bankroll = document.getElementById('bankroll');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');

    const impliedProbOut = document.getElementById('impliedProb');
    const fairOddsOut = document.getElementById('fairOdds');
    const edgeOut = document.getElementById('edge');
    const evOut = document.getElementById('ev');
    const kellyOut = document.getElementById('kelly');
    const stakeOut = document.getElementById('stake');

    const kellyMode = document.getElementById('kellyMode');
    const stakeMode = document.getElementById('stakeMode');

    // Sync percent/decimal fields
    probPercent.addEventListener('input', ()=> {
      const p = toNumber(probPercent.value);
      if (p===null) { probDecimal.value=''; return; }
      probDecimal.value = (p/100).toFixed(4);
    });
    probDecimal.addEventListener('input', ()=> {
      const p = toNumber(probDecimal.value);
      if (p===null) { probPercent.value=''; return; }
      probPercent.value = (p*100).toFixed(2);
    });

    calcBtn.addEventListener('click', calculate);
    resetBtn.addEventListener('click', ()=> {
      document.querySelectorAll('input').forEach(i=>i.value='');
      impliedProbOut.textContent='—'; fairOddsOut.textContent='—'; edgeOut.textContent='—';
      evOut.textContent='—'; kellyOut.textContent='—'; stakeOut.textContent='—';
      document.getElementById('convFraction').textContent='—';
      document.getElementById('convAmerican').textContent='—';
    });

    function calculate(){
      // read inputs
      let p = toNumber(probDecimal.value);
      if (p===null){
        const pcent = toNumber(probPercent.value);
        if (pcent!==null) p = pcent/100;
      }
      const odds = toNumber(oddsDecimal.value);
      const bank = toNumber(bankroll.value) || 0;

      // validate
      if (p===null || p<=0 || p>1 || !odds || odds<=1){
        alert('Introduce una probabilidad válida (0-100% o 0-1) y una cuota decimal > 1.');
        return;
      }

      // implied probability book
      const implied = 1 / odds; // simple implied probability (no vig removal)
      // fair odds from model p
      const fairOdds = 1 / p;

      // edge measure: relative value (%)
      // edgeDecimal = (book_odds - fair_odds) / fair_odds
      const edgeAbs = odds - fairOdds;
      const edgeRel = (odds * p - 1); // this is expected return per unit (decimal - 1)*p + ... simplified -> odds*p -1
      // expected value per unit stake: EV = p * (odds - 1) - (1 - p) * 1 = odds*p -1
      const evPerUnit = edgeRel;

      // Kelly: standard formula for positive-expectation bets:
      // b = odds - 1; p = prob; q = 1-p
      const b = odds - 1;
      const q = 1 - p;
      let kelly = (b * p - q) / b; // may be negative
      // numeric safety
      if (!isFinite(kelly)) kelly = 0;

      // apply fraction
      const mode = kellyMode.value; // full, half, quarter
      let fraction = 1;
      if (mode === 'half') fraction = 0.5;
      if (mode === 'quarter') fraction = 0.25;
      const kellyAdj = Math.max(0, kelly) * fraction; // don't suggest negative stake

      // stake suggested
      const stakeModeVal = stakeMode.value;
      const stakeCurrency = bank * kellyAdj;
      const stakePercent = kellyAdj * 100;

      // Display formatting
      impliedProbOut.textContent = pct(implied);
      fairOddsOut.textContent = f(fairOdds,4);
      // Edge: indicate if value bet
      const isValue = odds > fairOdds;
      edgeOut.innerHTML = `${isValue ? '<span class="good">Value</span>' : '<span class="bad">No value</span>'} — ${isValue?'+':''}${f(edgeAbs,3)} (abs) / ${ (edgeRel*100).toFixed(2) }% (EV%)`;
      evOut.textContent = `${(evPerUnit*100).toFixed(3)}% por unidad`;

      kellyOut.textContent = kelly >= 0 ? `${(kelly*100).toFixed(3)}% (raw) → ${(kellyAdj*100).toFixed(3)}% aplic.` : `Negativo (${(kelly*100).toFixed(3)}%)`;

      stakeOut.textContent = stakeModeVal === 'currency'
        ? (bank>0 ? `${f(stakeCurrency,2)} ( ${stakePercent.toFixed(3)}% del bankroll )` : `${stakePercent.toFixed(3)}% del bankroll — especifica bankroll para ver valor monetario`)
        : `${stakePercent.toFixed(3)}% del bankroll (≈ ${bank>0 ? f(stakeCurrency,2) : '—'})`;

      // Accessibility: set title attributes (copy)
      stakeOut.title = `Kelly raw: ${(kelly*100).toFixed(3)}%. Ajustado: ${(kellyAdj*100).toFixed(3)}%. Bankroll: ${bank}. Stake: ${f(stakeCurrency,2)}`;

      // extra: console log for dev
      console.log({p,odds,implied,fairOdds,edgeAbs,edgeRel,evPerUnit,kelly,kellyAdj,stakeCurrency,stakePercent});
    }

    // Converter
    const convBtn = document.getElementById('convBtn');
    const convertOdds = document.getElementById('convertOdds');
    const convFraction = document.getElementById('convFraction');
    const convAmerican = document.getElementById('convAmerican');

    convBtn.addEventListener('click', ()=> {
      const d = toNumber(convertOdds.value);
      if (!d || d <= 1){ alert('Introduce una cuota decimal válida (>1).'); return; }

      // fractional simplest representation
      // compute (d-1) as fraction
      function toFraction(x, maxDen=1000){
        const tolerance = 1e-8;
        let best = {num:1,den:1,err:Math.abs(x-1)};
        for (let q=1;q<=maxDen;q++){
          const p = Math.round(x*q);
          const err = Math.abs(x - p/q);
          if (err < best.err - tolerance){
            best = {num:p,den:q,err:err};
            if (err < tolerance) break;
          }
        }
        // reduce
        const g = gcd(best.num,best.den);
        return `${(best.num/g)}/${(best.den/g)}`;
      }
      function gcd(a,b){ return b ? gcd(b, a%b) : a; }

      const frac = toFraction(d - 1, 200);
      convFraction.textContent = frac;

      // american
      let american;
      if (d >= 2) {
        american = `+${Math.round((d-1)*100)}`;
      } else {
        american = `-${Math.round(100 / (d - 1))}`;
      }
      convAmerican.textContent = american;
    });

    // Allow Enter key to calculate
    document.addEventListener('keydown', (e)=> {
      if (e.key === 'Enter'){ calculate(); }
    });
  </script>
</body>
</html>
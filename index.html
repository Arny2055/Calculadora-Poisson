<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poisson ‚Ä¢ Probabilidad y Cuota Impl√≠cita (Persistencia de Datos)</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#0f1115 0%,#121622 100%); color:var(--text)}
  header{padding:20px 16px; border-bottom:1px solid var(--border); background:#10141d; position:sticky; top:0; z-index:5}
  h1{margin:0; font-size:18px; letter-spacing:.3px}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .grid{display:grid; gap:16px}
  @media(min-width:900px){ .grid-cols-2{grid-template-columns:1fr 1fr} .grid-cols-3{grid-template-columns:1.1fr 1fr 1fr}}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px}
  .card h2{margin:.2rem 0 .8rem; font-size:16px}
  label{font-size:12px; color:var(--muted); display:block; margin:.25rem 0 .35rem}
  input[type="text"],input[type="number"],select,textarea{
    width:100%; background:var(--panel2); color:var(--text); border:1px solid var(--border); border-radius:10px;
    padding:10px 12px; outline:none; font-size:14px;
  }
  .btn{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:#111827; color:var(--text);
       padding:10px 12px; border-radius:10px; cursor:pointer; text-decoration:none; font-size:14px; user-select:none}
  .btn.primary{background:linear-gradient(90deg,#2647ff,#1fa37e); border-color:transparent}
  .btn.danger{background:var(--danger); border-color:transparent}
  .btn.ghost{background:transparent}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .muted{color:var(--muted)}
  .kpi{display:flex; gap:12px; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03); display:inline-flex; flex-direction:column; align-items:flex-start;}
  .pill.ok{border-color:#234d3b; background:rgba(121,226,166,.08); color:var(--accent2)}
  .pill span.value{font-size:15px; font-weight:bold; color:var(--text)}
  .sep{height:1px; background:var(--border); margin:12px 0}
  .hint{font-size:12px; color:var(--muted)}
  .success{color:var(--accent2)}
  .danger-text{color:var(--danger)}
  .tiny{font-size:11px}
  table{width:100%; border-collapse:separate; border-spacing:0}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; font-size:14px}
  th{color:var(--muted); font-weight:600; font-size:12px}
  .right{text-align:right}
  @media(max-width:768px){ .grid-cols-2{grid-template-columns:1fr !important;} .grid-cols-3{grid-template-columns:1fr !important;} }
  @media(max-width:430px){
    .wrap{padding:8px}
    h1{font-size:16px}
    .card h2{font-size:14px}
    input,select,textarea{padding:8px 10px; font-size:14px}
  }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <h1>Poisson ‚Ä¢ Probabilidad y Cuota Impl√≠cita (Persistencia de Datos)</h1>
      </div>
    </div>
  </header>

  <div class="wrap grid grid-cols-2">
    <section class="card" aria-labelledby="cargar-datos">
      <h2 id="cargar-datos">1) Cargar datos</h2>
      <div class="grid">
        <div>
          <label for="file">Archivo JSON (array / objeto / NDJSON)</label>
          <input type="file" id="file" accept=".json,application/json,.txt" />
        </div>
      </div>
      <div class="flex" style="margin-top:10px; justify-content:space-between">
          <div id="ingestStatus" class="hint"></div>
          <button class="btn danger" id="clearDataBtn">üóëÔ∏è Borrar Datos Guardados</button>
      </div>
      <div class="hint tiny" style="margin-top:8px">
        El archivo cargado se guarda autom√°ticamente en tu navegador (`localStorage`) para persistencia.
      </div>
    </section>

    <section class="card" aria-labelledby="seleccion">
      <h2 id="seleccion">2) Selecci√≥n (Liga y Equipos)</h2>
      <div class="grid">
        <div>
          <label for="selLeague">Liga</label>
          <select id="selLeague"></select>
        </div>
        <div class="grid grid-cols-2">
          <div>
            <label for="selHome">Equipo Local</label>
            <select id="selHome"></select>
          </div>
          <div>
            <label for="selAway">Equipo Visitante</label>
            <select id="selAway"></select>
          </div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid grid-cols-3">
        <div>
          <label for="ouLine">L√≠nea OU (ej. 2.5)</label>
          <input type="number" id="ouLine" step="0.5" value="2.5" />
          <div class="hint tiny">Probabilidad de OU > L√≠nea (ej. > 2.5).</div>
        </div>
        <div style="display:none;">
          <input type="number" id="bankroll" value="1000" />
        </div>
        <div>
          <label for="maxGoals">M√°x. goles sumados (Poisson)</label>
          <input type="number" id="maxGoals" step="1" min="6" value="10" />
          <div class="hint tiny">Tope de suma para las convoluciones de goles.</div>
        </div>
      </div>
      <div class="hint tiny" style="margin-top:10px">
        El modelo se calcula <b>autom√°ticamente</b> al escoger liga y equipos.
      </div>
    </section>

    <section class="card" aria-labelledby="resultados-lambda">
      <h2 id="resultados-lambda">3) Par√°metros del Modelo y Muestras</h2>
      <div id="modelBox" class="kpi">
        <span class="pill">Œª Home: <span class="value" id="lamH">‚Äî</span></span>
        <span class="pill">Œª Away: <span class="value" id="lamA">‚Äî</span></span>
      </div>
      <div class="sep"></div>
      <div class="kpi">
        <span class="pill">Muestras (H/A): <span class="value" id="nHA">‚Äî</span></span>
      </div>
      <div class="hint tiny" style="margin-top:6px">
        F√≥rmula $\lambda$s: 0.6¬∑(promedio GF) + 0.4¬∑(promedio GC rival).
      </div>
    </section>
    
    <section class="card" aria-labelledby="cuotas-implicitas">
      <h2 id="cuotas-implicitas">4) Probabilidad y Cuota Impl√≠cita del Modelo</h2>
      <table>
        <thead>
          <tr>
            <th>Mercado</th>
            <th>Detalle</th>
            <th class="right">Prob. Modelo</th>
            <th class="right">Cuota Impl√≠cita (1/P)</th>
          </tr>
        </thead>
        <tbody id="probTable">
          </tbody>
      </table>
      <div class="hint tiny" style="margin-top:6px">
        La cuota impl√≠cita es el precio que deber√≠a tener el mercado seg√∫n la probabilidad calculada por el modelo de Poisson.
      </div>
    </section>

    <div style="display:none;">
        <input type="number" id="oddOver" step="0.01" value="0" />
        <input type="number" id="oddUnder" step="0.01" value="0" />
        <input type="number" id="oddBTTSY" step="0.01" value="0" />
        <input type="number" id="oddBTTSN" step="0.01" value="0" />
        <button id="btnOdds"></button>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const STORAGE_KEY = 'poisson_data_matches';
  let DATA = [];
  let CURRENT = { league:null, home:null, away:null, lambdas:null, probs:null, samples:{nH:0,nA:0} };

  const $ = sel => document.querySelector(sel);
  const setText = (id, txt) => { const el = typeof id==="string" ? document.getElementById(id) : id; if(el) el.textContent = txt; };

  // --- Funciones Matem√°ticas ---
  const factorialCache = [1];
  const fact = (n) => { for(let i=factorialCache.length;i<=n;i++) factorialCache[i] = factorialCache[i-1]*i; return factorialCache[n]; };
  const pois = (lambda,k)=> Math.exp(-lambda)*Math.pow(lambda,k)/fact(k);
  const mean = arr => arr.length ? arr.reduce((s,x)=>s+x,0)/arr.length : 0;

  function pTotalLE(lambdaH, lambdaA, kMax, thr){
    let p = 0;
    const pH = Array.from({length:kMax+1}, (_,h)=>pois(lambdaH,h));
    const pA = Array.from({length:kMax+1}, (_,a)=>pois(lambdaA,a));
    for(let h=0; h<=kMax; h++){
      const maxA = Math.min(kMax, thr - h);
      for(let a=0; a<=maxA; a++){
        p += pH[h]*pA[a];
      }
    }
    return Math.min(Math.max(p,0),1);
  }

  function btss(lambdaH, lambdaA){
    const pH0 = Math.exp(-lambdaH); 
    const pA0 = Math.exp(-lambdaA); 
    const pNo = pH0 + pA0 - pH0 * pA0;
    return {yes:1-pNo, no:pNo};
  }

  // --- Funciones de Utilidad y Normalizaci√≥n ---
  const parseFT = (ft) => {
    if(!ft || typeof ft!=="string") return {h:0,a:0,ok:false};
    const m = ft.match(/(-?\d+)\s*[-:]\s*(-?\d+)/);
    if(!m) return {h:0,a:0,ok:false};
    return {h: Number(m[1]), a: Number(m[2]), ok:true};
  };
  const splitTeams = (matchStr) => {
    if(!matchStr) return {home:null, away:null};
    const parts = String(matchStr).split(" - ");
    return {home: (parts[0]||"").trim(), away: (parts[1]||"").trim()};
  };
  function normalize(obj){
    const {League, Match, "Result FT":RFT, Date, "Home Team":HTX, "Away Team":ATX} = obj;
    const mTeams = splitTeams(Match || "");
    const ft = parseFT(RFT);
    return {
      League: League || obj.LeagueName || obj.Div || "‚Äî",
      Match: Match || (HTX && ATX ? `${HTX} - ${ATX}` : ""),
      Home: mTeams.home, Away: mTeams.away,
      FTHG: ft.h, FTAG: ft.a,
      Date: Date || obj.Date || "",
      raw: obj
    };
  }

  function readFlexJSON(text){
    text = text.trim();
    if(!text) return [];
    try{
      const parsed = JSON.parse(text);
      return Array.isArray(parsed) ? parsed : [parsed];
    }catch(e){
      const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const arr = [];
      for(const line of lines){
        try{ arr.push(JSON.parse(line)); }catch(_){}}
      return arr;
    }
  }

  function fillSelect(sel, items, placeholder){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = placeholder || "‚Äî";
    sel.appendChild(opt0);
    for(const it of items){
      const o = document.createElement("option");
      o.value = it; o.textContent = it;
      sel.appendChild(o);
    }
  }

  function getLeagueTeams(league){
    const set = new Set();
    for(const r of DATA) if(r.League===league){ set.add(r.Home); set.add(r.Away); }
    set.delete(null); set.delete("");
    return [...set].sort((a,b)=>a.localeCompare(b));
  }

  // --- Funciones de Persistencia y Carga ---
  function saveJSONToStorage(dataArray){
      try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(dataArray));
      } catch(e) {
          console.error("Error guardando datos en localStorage:", e);
          alert("Error: No se pudieron guardar los datos del archivo en el navegador.");
      }
  }

  function loadJSONFromStorage(){
      const status = $("#ingestStatus");
      try{
          const storedData = localStorage.getItem(STORAGE_KEY);
          if (storedData) {
              const parsedData = JSON.parse(storedData);
              if (parsedData.length) {
                  DATA = parsedData;
                  processLoadedData(DATA);
                  status.innerHTML = `<span class="success">OK:</span> ${DATA.length} partidos cargados (Guardados en navegador).`;
                  return true;
              }
          }
      } catch(e) {
          console.error("Error cargando o parseando datos guardados:", e);
      }
      status.textContent = "No hay datos guardados. Selecciona un archivo JSON.";
      return false;
  }
  
  function processLoadedData(dataToProcess){
    const leagues = [...new Set(dataToProcess.map(r=>r.League))].sort((a,b)=>a.localeCompare(b));
    fillSelect($("#selLeague"), leagues, "‚Äî Selecciona liga ‚Äî");
    fillSelect($("#selHome"), [], "‚Äî Local ‚Äî");
    fillSelect($("#selAway"), [], "‚Äî Visitante ‚Äî");

    if(leagues.length===1){
      $("#selLeague").value = leagues[0];
      CURRENT.league = leagues[0];
      const teams = getLeagueTeams(leagues[0]);
      fillSelect($("#selHome"), teams, "‚Äî Local ‚Äî");
      fillSelect($("#selAway"), teams, "‚Äî Visitante ‚Äî");
      if(teams.length>=2){
        $("#selHome").value = teams[0];
        $("#selAway").value = teams[1];
        CURRENT.home = teams[0];
        CURRENT.away = teams[1];
        autoCalcPoisson();
      }
    }
    renderModel(); 
  }

  async function parseInput(){
    const file = $("#file").files[0];
    const status = $("#ingestStatus");
    status.textContent = "Procesando...";

    if(!file){
      status.innerHTML = '<span class="danger-text">Selecciona un archivo para procesar.</span>';
      return;
    }

    let rows = [];
    try{
        const content = await file.text();
        rows = rows.concat(readFlexJSON(content));
    }catch(e){
        status.innerHTML = '<span class="danger-text">Error leyendo archivo.</span>';
        return;
    }

    if(!rows.length){
        status.innerHTML = '<span class="danger-text">No se detect√≥ JSON v√°lido.</span>';
        return;
    }

    const normalizedData = rows.map(normalize).filter(r=>r.Match && (r.Home||"") && (r.Away||""));

    if(!normalizedData.length){
        status.innerHTML = '<span class="danger-text">No se pudieron normalizar partidos.</span>';
        return;
    }

    DATA = normalizedData;
    saveJSONToStorage(DATA); // GUARDAR EN LOCAL STORAGE
    processLoadedData(DATA);

    const leagues = [...new Set(DATA.map(r=>r.League))];
    status.innerHTML = `<span class="success">OK:</span> ${DATA.length} partidos cargados ¬∑ ${leagues.length} ligas. Datos **guardados** en navegador.`;
    
    $("#file").value = ""; 
  }
  
  function clearSavedData(){
      if(confirm("¬øEst√°s seguro de que quieres borrar el JSON guardado de tu navegador? Necesitar√°s recargar el archivo despu√©s.")){
          localStorage.removeItem(STORAGE_KEY);
          DATA = [];
          CURRENT = { league:null, home:null, away:null, lambdas:null, probs:null, samples:{nH:0,nA:0} };
          $("#selLeague").innerHTML = "";
          $("#selHome").innerHTML = "";
          $("#selAway").innerHTML = "";
          $("#probTable").innerHTML = "";
          setText("lamH", "‚Äî"); setText("lamA", "‚Äî"); 
          setText("nHA", "‚Äî");
          $("#ingestStatus").innerHTML = '<span class="danger-text">Datos borrados. Recarga la p√°gina o carga un nuevo archivo JSON.</span>';
      }
  }


  // --- Funciones de C√°lculo de Poisson ---
  function lastMatchesTeam(league, team, side, limit=10){
    const arr = [];
    for(const r of DATA){
      if(r.League!==league) continue;
      if(side==="home" && r.Home===team) arr.push(r);
      if(side==="away" && r.Away===team) arr.push(r);
    }
    arr.sort((a,b)=> new Date(a.Date||0) - new Date(b.Date||0));
    return arr.slice(-limit);
  }

  function goalsStats(league, team){
    const lastH = lastMatchesTeam(league, team, "home", 10);
    const lastA = lastMatchesTeam(league, team, "away", 10);

    const gfH = lastH.map(m=>m.FTHG);
    const gcH = lastH.map(m=>m.FTAG);
    const gfA = lastA.map(m=>m.FTAG);
    const gcA = lastA.map(m=>m.FTHG);

    return {
      nH: lastH.length, nA: lastA.length,
      avgGF_H: mean(gfH), avgGC_H: mean(gcH),
      avgGF_A: mean(gfA), avgGC_A: mean(gcA)
    };
  }

  function computeLambdas(league, home, away){
    const H = goalsStats(league, home);
    const A = goalsStats(league, away);

    const lamH = 0.6*(H.avgGF_H||0) + 0.4*(A.avgGC_A||0);
    const lamA = 0.6*(A.avgGF_A||0) + 0.4*(H.avgGC_H||0);

    CURRENT.samples = {nH:H.nH, nA:A.nA};
    return { lamH, lamA };
  }

  function computeAllProbs(lambdaH, lambdaA, ouLine, kMax){
    const thr = Math.floor(ouLine);
    const pLE = pTotalLE(lambdaH, lambdaA, kMax, thr);
    
    const pOver = 1 - pLE;
    const pUnder = pLE;

    const b = btss(lambdaH, lambdaA);
    
    return { ou:{over:pOver, under:pUnder}, btts:{yes:b.yes, no:b.no} };
  }

  // --- Funciones de Formato y Renderizado ---
  function fmtPct(x){ return isFinite(x) ? (100*x).toFixed(2)+"%" : "‚Äî"; }
  function fmtDec(x){ return isFinite(x) ? x.toFixed(3) : "‚Äî"; }
  function fmtOdd(p){ return (p && isFinite(p) && p > 0) ? (1/p).toFixed(3) : "‚Äî"; }

  function renderModel(){
    const { lambdas, probs, samples } = CURRENT;
    
    if(!lambdas || !probs){ 
        setText("lamH", "‚Äî"); setText("lamA", "‚Äî"); 
        setText("nHA", "‚Äî");
        $("#probTable").innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--muted)">Selecciona liga y equipos.</td></tr>`;
        return; 
    }
    
    const line = Number($("#ouLine").value || 2.5);
    setText("lamH", fmtDec(lambdas.lamH));
    setText("lamA", fmtDec(lambdas.lamA));
    setText("nHA", `${samples.nH}/${samples.nA}`);

    const data = [
      { group: "Over/Under", label: `Over ${line}`, prob: probs.ou.over },
      { group: "Over/Under", label: `Under ${line}`, prob: probs.ou.under },
      { group: "BTTS", label: "BTTS S√≠", prob: probs.btts.yes },
      { group: "BTTS", label: "BTTS No", prob: probs.btts.no },
    ];

    const tbody = $("#probTable");
    tbody.innerHTML = "";
    
    for(const item of data){
      const oddImplied = fmtOdd(item.prob);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.group}</td>
        <td>${item.label}</td>
        <td class="right">${fmtPct(item.prob)}</td>
        <td class="right"><b>${oddImplied}</b></td>
      `;
      tbody.appendChild(tr);
    }
  }

  // --- L√≥gica Principal de C√°lculo ---
  function autoCalcPoisson(){
    const league = $("#selLeague").value;
    const home = $("#selHome").value;
    const away = $("#selAway").value;
    
    if(!league || !home || !away || home===away) { 
        CURRENT.lambdas = null; 
        CURRENT.probs = null;
        renderModel(); 
        return; 
    }
    
    const { lamH, lamA } = computeLambdas(league, home, away);
    const line = Number($("#ouLine").value || 2.5);
    const kMax = Math.max(6, Number($("#maxGoals").value || 10));
    
    const probs = computeAllProbs(lamH, lamA, line, kMax);
    
    CURRENT.lambdas = {lamH, lamA};
    CURRENT.probs = probs;
    renderModel();
  }

  // --- Eventos UI ---
  $("#file").addEventListener("change", parseInput);
  $("#clearDataBtn").addEventListener("click", clearSavedData);

  $("#selLeague").addEventListener("change", (e)=>{
    const lg = e.target.value;
    CURRENT.league = lg || null;
    if(!lg){
      fillSelect($("#selHome"), [], "‚Äî Local ‚Äî");
      fillSelect($("#selAway"), [], "‚Äî Visitante ‚Äî");
      autoCalcPoisson();
      return;
    }
    const teams = getLeagueTeams(lg);
    fillSelect($("#selHome"), teams, "‚Äî Local ‚Äî");
    fillSelect($("#selAway"), teams, "‚Äî Visitante ‚Äî");
    
    if(teams.length>=2){
      const homeVal = teams[0];
      const awayVal = (teams.length > 1) ? teams[1] : "";
      
      $("#selHome").value = homeVal;
      $("#selAway").value = awayVal;
      CURRENT.home = homeVal;
      CURRENT.away = awayVal;
    } else {
        CURRENT.home = null;
        CURRENT.away = null;
    }
    autoCalcPoisson();
  });

  $("#selHome").addEventListener("change", (e)=>{ CURRENT.home = e.target.value || null; autoCalcPoisson(); });
  $("#selAway").addEventListener("change", (e)=>{ CURRENT.away = e.target.value || null; autoCalcPoisson(); });

  $("#ouLine").addEventListener("input", autoCalcPoisson);
  $("#maxGoals").addEventListener("input", autoCalcPoisson);

  // --- SOLUCI√ìN: Cargar datos al iniciar el script ---
  // Esta llamada asegura que el DOM y el script est√°n cargados antes de intentar obtener los datos.
  loadJSONFromStorage();

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poisson â€¢ OU + BTTS + 1X2 â€” EV, Overround, Kelly 1/4 + Historial</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#0f1115 0%,#121622 100%); color:var(--text)}
  header{padding:20px 16px; border-bottom:1px solid var(--border); background:#10141d; position:sticky; top:0; z-index:5}
  h1{margin:0; font-size:18px; letter-spacing:.3px}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .grid{display:grid; gap:16px}
  @media(min-width:900px){ .grid-cols-2{grid-template-columns:1fr 1fr} .grid-cols-3{grid-template-columns:1.1fr 1fr 1fr}}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px}
  .card h2{margin:.2rem 0 .8rem; font-size:16px}
  label{font-size:12px; color:var(--muted); display:block; margin:.25rem 0 .35rem}
  input[type="text"],input[type="number"],select,textarea{
    width:100%; background:var(--panel2); color:var(--text); border:1px solid var(--border); border-radius:10px;
    padding:10px 12px; outline:none;
  }
  textarea{min-height:84px; resize:vertical}
  .row{display:grid; gap:10px; grid-template-columns:repeat(12,1fr); align-items:end}
  .btn{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:#111827; color:var(--text);
       padding:10px 12px; border-radius:10px; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#2647ff,#1fa37e); border-color:transparent}
  .btn.ghost{background:transparent}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .muted{color:var(--muted)}
  .kpi{display:flex; gap:12px; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03)}
  .pill.ok{border-color:#234d3b; background:rgba(121,226,166,.08); color:var(--accent2)}
  .pill.warn{border-color:#554224; background:rgba(255,184,77,.1); color:var(--warn)}
  .pill.bad{border-color:#5a2b2b; background:rgba(255,107,107,.1); color:var(--danger)}
  table{width:100%; border-collapse:separate; border-spacing:0}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
  th{color:var(--muted); font-weight:600; font-size:12px}
  td small{color:var(--muted)}
  .right{text-align:right}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .sep{height:1px; background:var(--border); margin:12px 0}
  .hint{font-size:12px; color:var(--muted)}
  .success{color:var(--accent2)}
  .danger{color:var(--danger)}
  .center{display:flex; align-items:center; justify-content:center}
  .tiny{font-size:11px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Poisson â€¢ OU + BTTS + 1X2 â€” EV, Overround y Kelly 1/4 (con historial)</h1>
    </div>
  </header>

  <div class="wrap grid grid-cols-2">
    <!-- Ingesta -->
    <section class="card">
      <h2>1) Cargar datos</h2>
      <div class="grid">
        <div>
          <label>Archivo JSON (array / objeto / NDJSON)</label>
          <input type="file" id="file" accept=".json,application/json,.txt" />
        </div>
        <div>
          <label>O pegar JSON aquÃ­</label>
          <textarea id="jsonText" placeholder='[ { "League":"...", "Match":"Home - Away", "Result FT":"1-2", ... }, ... ]'></textarea>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnSample">Cargar ejemplo rÃ¡pido</button>
        <button class="btn primary" id="btnParse">Procesar data</button>
        <span class="hint">Tras procesar, elige liga y equipos ðŸ‘‰</span>
      </div>
      <div id="ingestStatus" class="hint" style="margin-top:8px"></div>
    </section>

    <!-- SelecciÃ³n -->
    <section class="card">
      <h2>2) SelecciÃ³n (Liga y Equipos)</h2>
      <div class="grid">
        <div>
          <label>Liga</label>
          <select id="selLeague"></select>
        </div>
        <div class="grid grid-cols-2">
          <div>
            <label>Equipo Local</label>
            <select id="selHome"></select>
          </div>
          <div>
            <label>Equipo Visitante</label>
            <select id="selAway"></select>
          </div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid grid-cols-3">
        <div>
          <label>LÃ­nea OU (ej. 2.5)</label>
          <input type="number" id="ouLine" step="0.5" value="2.5" />
          <div class="hint tiny">Si pones entero (p.ej. 2.0) se interpreta como mercado europeo (sin push).</div>
        </div>
        <div>
          <label>Bankroll</label>
          <input type="number" id="bankroll" step="1" value="1000" />
          <div class="hint tiny">Para sugerir staking con Kelly 1/4.</div>
        </div>
        <div>
          <label>MÃ¡x. goles sumados (Poisson)</label>
          <input type="number" id="maxGoals" step="1" min="6" value="10" />
          <div class="hint tiny">Tope de suma para las convoluciones de goles.</div>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" id="btnCalc">Calcular Poisson</button>
        <span id="calcMsg" class="hint"></span>
      </div>
    </section>

    <!-- Cuotas -->
    <section class="card">
      <h2>3) Cuotas (introduce para Overround, EV y Kelly 1/4)</h2>
      <div class="grid">
        <div class="grid grid-cols-3">
          <div>
            <label>Over (OU)</label>
            <input type="number" id="oddOver" step="0.01" placeholder="ej. 1.95" />
          </div>
          <div>
            <label>Under (OU)</label>
            <input type="number" id="oddUnder" step="0.01" placeholder="ej. 1.85" />
          </div>
          <div class="center"><span class="muted tiny">Mercado: Over/Under</span></div>
        </div>
        <div class="grid grid-cols-3">
          <div>
            <label>BTTS SÃ­</label>
            <input type="number" id="oddBTTSY" step="0.01" placeholder="ej. 1.95" />
          </div>
          <div>
            <label>BTTS No</label>
            <input type="number" id="oddBTTSN" step="0.01" placeholder="ej. 1.85" />
          </div>
          <div class="center"><span class="muted tiny">Mercado: BTTS</span></div>
        </div>
        <div class="grid grid-cols-3">
          <div>
            <label>1 (Local)</label>
            <input type="number" id="odd1" step="0.01" placeholder="ej. 1.80" />
          </div>
          <div>
            <label>X (Empate)</label>
            <input type="number" id="oddX" step="0.01" placeholder="ej. 3.60" />
          </div>
          <div>
            <label>2 (Visita)</label>
            <input type="number" id="odd2" step="0.01" placeholder="ej. 4.80" />
          </div>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnOdds">Calcular EV / Kelly</button>
        <span class="hint">Primero ejecuta Poisson (secciÃ³n 2).</span>
      </div>
    </section>

    <!-- Resultados Poisson -->
    <section class="card">
      <h2>4) Resultados del modelo</h2>
      <div id="modelBox" class="kpi">
        <span class="pill">Î» Home: <b id="lamH">â€”</b></span>
        <span class="pill">Î» Away: <b id="lamA">â€”</b></span>
        <span class="pill">OU &gt; <b id="ouLbl">2.5</b>: <b id="pOver">â€”</b></span>
        <span class="pill">OU &lt;= <b id="ouLbl2">2.5</b>: <b id="pUnder">â€”</b></span>
        <span class="pill">BTTS SÃ­: <b id="pBTTSY">â€”</b></span>
        <span class="pill">BTTS No: <b id="pBTTSN">â€”</b></span>
        <span class="pill">P(1): <b id="p1">â€”</b></span>
        <span class="pill">P(X): <b id="pX">â€”</b></span>
        <span class="pill">P(2): <b id="p2">â€”</b></span>
      </div>
      <div class="sep"></div>
      <div class="kpi">
        <span class="pill" id="cvPill">Â· CV total: <b id="cvTxt">â€”</b></span>
        <span class="pill" id="nHAPill">Muestras (H/A): <b id="nHA">â€”</b></span>
      </div>
      <div class="hint tiny" style="margin-top:6px">
        Î»H = 0.6Â·(promedio GF del local en casa) + 0.4Â·(promedio GC del visitante fuera) Â·Â·
        Î»A = 0.6Â·(promedio GF del visitante fuera) + 0.4Â·(promedio GC del local en casa).
      </div>
    </section>

    <!-- EV / Kelly y Guardado -->
    <section class="card">
      <h2>5) Valor esperado, Kelly 1/4 y Guardado</h2>
      <table>
        <thead>
          <tr>
            <th>Mercado</th>
            <th>Detalle</th>
            <th class="right">Prob. Modelo</th>
            <th class="right">Cuota</th>
            <th class="right">Overround</th>
            <th class="right">EV</th>
            <th class="right">Stake Kelly 1/4</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="evTable">
          <!-- filas dinÃ¡micas -->
        </tbody>
      </table>
      <div class="hint tiny" style="margin-top:6px">
        EV = pÂ·odd âˆ’ 1. Kelly fraccional 1/4 = max(0, ((pÂ·odd âˆ’ 1)/(odd âˆ’ 1)) / 4). Overround = Î£(1/odd) âˆ’ 1.
      </div>
    </section>
  </div>

<script>
(() => {
  "use strict";

  // ====== Estado ======
  let DATA = []; // array de objetos normalizados
  let CURRENT = { league:null, home:null, away:null, lambdas:null, probs:null, samples:{nH:0,nA:0} };

  // ====== Utilidades ======
  const $ = sel => document.querySelector(sel);
  const setText = (id, txt) => { const el = typeof id==="string" ? document.getElementById(id) : id; if(el) el.textContent = txt; };
  const parseFT = (ft) => {
    if(!ft || typeof ft!=="string") return {h:0,a:0,ok:false};
    const m = ft.match(/(-?\d+)\s*[-:]\s*(-?\d+)/);
    if(!m) return {h:0,a:0,ok:false};
    return {h: Number(m[1]), a: Number(m[2]), ok:true};
  };
  const splitTeams = (matchStr) => {
    if(!matchStr) return {home:null, away:null};
    const parts = String(matchStr).split(" - ");
    return {home: (parts[0]||"").trim(), away: (parts[1]||"").trim()};
  };
  const mean = arr => arr.length ? arr.reduce((s,x)=>s+x,0)/arr.length : 0;

  // Poisson PMF
  const factorialCache = [1];
  const fact = (n) => {
    for(let i=factorialCache.length;i<=n;i++) factorialCache[i] = factorialCache[i-1]*i;
    return factorialCache[n];
  };
  const pois = (lambda, k) => Math.exp(-lambda)*Math.pow(lambda,k)/fact(k);

  // ConvoluciÃ³n total de goles
  function pTotalLE(lambdaH, lambdaA, kMax, thr){ // P( H+A <= thr )
    let p = 0;
    for(let h=0; h<=kMax; h++){
      const pH = pois(lambdaH,h);
      for(let a=0; a<=Math.min(kMax-h, thr-h); a++){
        if(h+a<=thr) p += pH * pois(lambdaA,a);
      }
    }
    return Math.min(Math.max(p,0),1);
  }

  function cdf1X2(lambdaH, lambdaA, kMax){
    // P(1) = Î£_{h>a} P(h)*P(a) ; P(X) = Î£_{h=a}; P(2) = Î£_{h<a}
    let p1=0, px=0, p2=0;
    const pH = Array.from({length:kMax+1}, (_,h)=>pois(lambdaH,h));
    const pA = Array.from({length:kMax+1}, (_,a)=>pois(lambdaA,a));
    for(let h=0; h<=kMax; h++){
      for(let a=0; a<=kMax; a++){
        const p = pH[h]*pA[a];
        if(h>a) p1+=p; else if(h===a) px+=p; else p2+=p;
      }
    }
    return {p1,px,p2};
  }

  function btss(lambdaH, lambdaA){
    const pH0 = Math.exp(-lambdaH);
    const pA0 = Math.exp(-lambdaA);
    const pYY = 1 - pH0 - pA0 + pH0*pA0; // ambos marcan
    return {yes:pYY, no:1-pYY};
  }

  function overroundFromOdds(arrOdds){
    const sumInv = arrOdds.filter(o=>o>1.001).reduce((s,o)=>s+1/o,0);
    if(!arrOdds.length) return 0;
    return Math.max(0, sumInv - 1);
  }

  function ev(p, odd){
    if(!odd || odd<=1) return NaN;
    return p*odd - 1;
  }

  function kellyQuarter(p, odd){
    if(!odd || odd<=1) return 0;
    const f = (p*odd - 1) / (odd - 1);
    return Math.max(0, f / 4);
  }

  function coefVariacion(lambdaH, lambdaA){
    const lambdaTot = Math.max(lambdaH + lambdaA, 1e-9);
    const CV = 1 / Math.sqrt(lambdaTot);
    return CV;
  }

  // ====== Ingesta ======
  function normalize(obj){
    // Nos quedamos con campos clave; tolera variantes
    const {League, Match, "Result FT":RFT, Date, "Home Team":HTX, "Away Team":ATX} = obj;
    const mTeams = splitTeams(Match || "");
    const ft = parseFT(RFT);
    return {
      League: League || obj.LeagueName || obj.Div || "â€”",
      Match: Match || (HTX && ATX ? `${HTX} - ${ATX}` : ""),
      Home: mTeams.home, Away: mTeams.away,
      FTHG: ft.h, FTAG: ft.a,
      Date: Date || obj.Date || "",
      raw: obj
    };
  }

  async function parseInput(){
    const status = $("#ingestStatus");
    status.textContent = "Procesando...";
    const txt = $("#jsonText").value.trim();

    let rows = [];
    // 1) Archivo
    const file = $("#file").files[0];
    if(file){
      const content = await file.text();
      rows = rows.concat(readFlexJSON(content));
    }
    // 2) Textarea
    if(txt){
      rows = rows.concat(readFlexJSON(txt));
    }

    if(!rows.length){
      status.innerHTML = '<span class="danger">No se detectÃ³ JSON vÃ¡lido.</span>';
      return;
    }

    // Normalizar
    DATA = rows.map(normalize).filter(r=>r.Match && (r.Home||"") && (r.Away||""));

    if(!DATA.length){
      status.innerHTML = '<span class="danger">No se pudieron normalizar partidos.</span>';
      return;
    }

    // Poblar ligas
    const leagues = [...new Set(DATA.map(r=>r.League))].sort((a,b)=>a.localeCompare(b));
    fillSelect($("#selLeague"), leagues, "â€” Selecciona liga â€”");
    fillSelect($("#selHome"), [], "â€” Local â€”");
    fillSelect($("#selAway"), [], "â€” Visitante â€”");

    status.innerHTML = `<span class="success">OK:</span> ${DATA.length} partidos cargados Â· ${leagues.length} ligas.`;
  }

  function readFlexJSON(text){
    // Admite: JSON array / JSON objeto / NDJSON
    text = text.trim();
    if(!text) return [];
    try{
      const parsed = JSON.parse(text);
      if(Array.isArray(parsed)) return parsed;
      return [parsed];
    }catch(e){
      // Intento NDJSON
      const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const arr = [];
      for(const line of lines){
        try{ arr.push(JSON.parse(line)); }catch(_){}
      }
      return arr;
    }
  }

  function fillSelect(sel, items, placeholder){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = placeholder || "â€”";
    sel.appendChild(opt0);
    for(const it of items){
      const o = document.createElement("option");
      o.value = it; o.textContent = it;
      sel.appendChild(o);
    }
  }

  // ====== Filtrado y stats ======
  function getLeagueTeams(league){
    const set = new Set();
    for(const r of DATA) if(r.League===league){ set.add(r.Home); set.add(r.Away); }
    set.delete(null); set.delete("");
    return [...set].sort((a,b)=>a.localeCompare(b));
  }

  function lastMatchesTeam(league, team, side, limit=10){
    // side: "home" => partidos del team como local en esa liga
    //       "away" => partidos del team como visitante en esa liga
    const arr = [];
    for(const r of DATA){
      if(r.League!==league) continue;
      if(side==="home" && r.Home===team) arr.push(r);
      if(side==="away" && r.Away===team) arr.push(r);
    }
    // Orden temporal si la fecha viene ordenable, de lo contrario dejamos como estÃ¡
    // (No confiamos en formato, pero si hay, intentamos ordenar)
    arr.sort((a,b)=> new Date(a.Date||0) - new Date(b.Date||0));
    return arr.slice(-limit); // Ãºltimos N
  }

  function goalsStats(league, team){
    const lastH = lastMatchesTeam(league, team, "home", 10);
    const lastA = lastMatchesTeam(league, team, "away", 10);

    const gfH = lastH.map(m=>m.FTHG);
    const gcH = lastH.map(m=>m.FTAG);
    const gfA = lastA.map(m=>m.FTAG);
    const gcA = lastA.map(m=>m.FTHG);

    return {
      nH: lastH.length, nA: lastA.length,
      avgGF_H: mean(gfH), avgGC_H: mean(gcH),
      avgGF_A: mean(gfA), avgGC_A: mean(gcA)
    };
  }

  // ====== CÃ¡lculo Î» y probabilidades ======
  function computeLambdas(league, home, away){
    const H = goalsStats(league, home);
    const A = goalsStats(league, away);

    // Blending 60% ataque propio + 40% defensa rival
    const lamH = 0.6*(H.avgGF_H||0) + 0.4*(A.avgGC_A||0);
    const lamA = 0.6*(A.avgGF_A||0) + 0.4*(H.avgGC_H||0);

    CURRENT.samples = {nH:H.nH, nA:A.nA};
    return { lamH, lamA, H, A };
  }

  function computeAllProbs(lambdaH, lambdaA, ouLine, kMax){
    const thr = Math.floor(ouLine); // umbral entero para <=
    const pLE = pTotalLE(lambdaH, lambdaA, kMax, thr);
    const isHalf = Math.abs(ouLine - thr) > 1e-9;
    let pOver, pUnder;
    if(isHalf){
      // tÃ­pica lÃ­nea X.5
      pOver = 1 - pLE;         // P(total > thr)
      pUnder = pLE;            // P(total <= thr)
    }else{
      // lÃ­nea entera => mercado europeo (sin push)
      // tomamos "Over N.0" como > N, y "Under N.0" como <= N
      pOver = 1 - pLE;
      pUnder = pLE;
    }

    const b = btss(lambdaH, lambdaA);
    const ones = cdf1X2(lambdaH, lambdaA, kMax);

    return {
      ou:{over:pOver, under:pUnder},
      btts:{yes:b.yes, no:b.no},
      oneXtwo: ones
    };
  }

  // ====== UI de resultados / EV ======
  function fmtPct(x){ return isFinite(x) ? (100*x).toFixed(1)+"%" : "â€”"; }
  function fmtDec(x){ return isFinite(x) ? x.toFixed(3) : "â€”"; }
  function fmtMoney(x){ return isFinite(x) ? x.toFixed(2) : "â€”"; }

  function renderModel(){
    const { lambdas, probs, samples } = CURRENT;
    if(!lambdas || !probs){ return; }
    const line = Number($("#ouLine").value || 2.5);
    setText("lamH", fmtDec(lambdas.lamH));
    setText("lamA", fmtDec(lambdas.lamA));
    setText("ouLbl", line);
    setText("ouLbl2", line);
    setText("pOver", fmtPct(probs.ou.over));
    setText("pUnder", fmtPct(probs.ou.under));
    setText("pBTTSY", fmtPct(probs.btts.yes));
    setText("pBTTSN", fmtPct(probs.btts.no));
    setText("p1", fmtPct(probs.oneXtwo.p1));
    setText("pX", fmtPct(probs.oneXtwo.px));
    setText("p2", fmtPct(probs.oneXtwo.p2));

    const CV = coefVariacion(lambdas.lamH, lambdas.lamA);
    setText("cvTxt", `${CV.toFixed(2)} (${CV<0.5?'Bajo':(CV<=0.8?'Medio':'Alto')})`);
    setText("nHA", `${samples.nH}/${samples.nA}`);
  }

  function calcOdds(){
    if(!CURRENT.probs){ alert("Primero calcula Poisson."); return; }
    const bk = Number($("#bankroll").value || 0);
    const line = Number($("#ouLine").value || 2.5);

    const odds = {
      over: Number($("#oddOver").value || 0),
      under: Number($("#oddUnder").value || 0),
      bttsy: Number($("#oddBTTSY").value || 0),
      bttsn: Number($("#oddBTTSN").value || 0),
      o1: Number($("#odd1").value || 0),
      ox: Number($("#oddX").value || 0),
      o2: Number($("#odd2").value || 0)
    };

    const rows = [];

    // OU
    const orOU = overroundFromOdds([odds.over, odds.under]);
    rows.push(buildRow(
      "Over/Under",
      `Over ${line}`,
      CURRENT.probs.ou.over,
      odds.over,
      orOU,
      bk,
      {market:"OU_OVER", meta:{line}}
    ));
    rows.push(buildRow(
      "Over/Under",
      `Under ${line}`,
      CURRENT.probs.ou.under,
      odds.under,
      orOU,
      bk,
      {market:"OU_UNDER", meta:{line}}
    ));

    // BTTS
    const orBT = overroundFromOdds([odds.bttsy, odds.bttsn]);
    rows.push(buildRow(
      "BTTS",
      "BTTS SÃ­",
      CURRENT.probs.btts.yes,
      odds.bttsy,
      orBT,
      bk,
      {market:"BTTS_YES"}
    ));
    rows.push(buildRow(
      "BTTS",
      "BTTS No",
      CURRENT.probs.btts.no,
      odds.bttsn,
      orBT,
      bk,
      {market:"BTTS_NO"}
    ));

    // 1X2
    const or1X2 = overroundFromOdds([odds.o1, odds.ox, odds.o2]);
    rows.push(buildRow("1X2", "1 (Local)", CURRENT.probs.oneXtwo.p1, odds.o1, or1X2, bk, {market:"1"}));
    rows.push(buildRow("1X2", "X (Empate)", CURRENT.probs.oneXtwo.px, odds.ox, or1X2, bk, {market:"X"}));
    rows.push(buildRow("1X2", "2 (Visita)", CURRENT.probs.oneXtwo.p2, odds.o2, or1X2, bk, {market:"2"}));

    const tbody = $("#evTable");
    tbody.innerHTML = "";
    for(const tr of rows) tbody.appendChild(tr);
  }

  function buildRow(grupo, label, p, odd, overround, bankroll, meta){
    const tr = document.createElement("tr");

    const tdG = document.createElement("td"); tdG.textContent = grupo; tr.appendChild(tdG);
    const tdL = document.createElement("td"); tdL.textContent = label; tr.appendChild(tdL);

    const tdP = document.createElement("td"); tdP.className="right"; tdP.textContent = fmtPct(p); tr.appendChild(tdP);

    const tdO = document.createElement("td"); tdO.className="right"; tdO.textContent = odd>1? odd.toFixed(2) : "â€”"; tr.appendChild(tdO);

    const tdR = document.createElement("td"); tdR.className="right";
    tdR.innerHTML = `<span class="${overround>0.06?'bad':(overround>0.03?'warn':'success')}">${(100*overround).toFixed(2)}%</span>`;
    tr.appendChild(tdR);

    const evv = ev(p, odd);
    const tdEV = document.createElement("td"); tdEV.className="right";
    if(isFinite(evv)) tdEV.innerHTML = `<b class="${evv>=0?'success':'danger'}">${(100*evv).toFixed(2)}%</b>`;
    else tdEV.textContent = "â€”";
    tr.appendChild(tdEV);

    const kq = kellyQuarter(p, odd);
    const stake = isFinite(kq) ? bankroll * kq : 0;
    const tdK = document.createElement("td"); tdK.className="right";
    tdK.innerHTML = isFinite(kq) ? `${(100*kq).toFixed(2)}% Â· $${fmtMoney(stake)}` : "â€”";
    tr.appendChild(tdK);

    const tdBtn = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "btn " + (evv>0 && odd>1 ? "primary" : "ghost");
    btn.textContent = "Guardar Pick";
    btn.disabled = !(evv>0 && odd>1);
    btn.onclick = () => savePick({
      league: CURRENT.league,
      home: CURRENT.home,
      away: CURRENT.away,
      lambdaH: CURRENT.lambdas.lamH,
      lambdaA: CURRENT.lambdas.lamA,
      line: (meta.meta && meta.meta.line) ? meta.meta.line : null,
      market: meta.market,
      label,
      prob: p,
      odd,
      overround,
      ev: evv,
      kelly_q: kq,
      bankroll: bankroll,
      timestamp: new Date().toISOString()
    });
    tdBtn.appendChild(btn);
    tr.appendChild(tdBtn);

    return tr;
  }

  function savePick(pick){
    try{
      const key = "picks";
      const arr = JSON.parse(localStorage.getItem(key)||"[]");
      arr.push(pick);
      localStorage.setItem(key, JSON.stringify(arr));
      alert("Pick guardado en historial.");
      // Redirigir
      location.href = "historial.html";
    }catch(e){
      alert("No se pudo guardar el pick: " + e.message);
    }
  }

  // ====== Eventos UI ======
  $("#btnParse").addEventListener("click", parseInput);

  $("#btnSample").addEventListener("click", () => {
    // Cargamos un mini ejemplo (incluye tu partido mostrado y algunos mock extra para que haya Ãºltimos 10)
    const sample = [
      {"League":"Ecuador Liga Pro","Match":"Emelec - Mushuc Runa","Result FT":"0-0","Date":"2024-03-08"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - Aucas","Result FT":"2-1","Date":"2024-02-20"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - Liga de Quito","Result FT":"1-0","Date":"2024-01-15"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - DelfÃ­n","Result FT":"3-2","Date":"2023-12-05"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - Orense","Result FT":"2-0","Date":"2023-11-21"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - Barcelona SC","Result FT":"1-1","Date":"2023-10-02"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - CumbayÃ¡","Result FT":"0-1","Date":"2023-09-12"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - TÃ©cnico Universitario","Result FT":"2-2","Date":"2023-08-18"},
      {"League":"Ecuador Liga Pro","Match":"Emelec - MacarÃ¡","Result FT":"1-0","Date":"2023-07-30"},
      {"League":"Ecuador Liga Pro","Match":"Mushuc Runa - Emelec","Result FT":"1-2","Date":"2023-06-01"},
      {"League":"Ecuador Liga Pro","Match":"Mushuc Runa - Aucas","Result FT":"2-2","Date":"2024-02-26"},
      {"League":"Ecuador Liga Pro","Match":"Mushuc Runa - Orense","Result FT":"0-1","Date":"2024-01-05"},
      {"League":"Ecuador Liga Pro","Match":"Mushuc Runa - DelfÃ­n","Result FT":"1-0","Date":"2023-12-12"},
      {"League":"Ecuador Liga Pro","Match":"Mushuc Runa - CumbayÃ¡","Result FT":"0-0","Date":"2023-11-15"},
      {"League":"Ecuador Liga Pro","Match":"Mushuc Runa - Barcelona SC","Result FT":"1-3","Date":"2023-10-07"},
      {"League":"Ecuador Liga Pro","Match":"Mushuc Runa - Liga de Quito","Result FT":"2-2","Date":"2023-09-03"},
      {"League":"Ecuador Liga Pro","Match":"Barcelona SC - Emelec","Result FT":"0-0","Date":"2023-05-21"},
      {"League":"Argentina Liga Profesional de FÃºtbol","Match":"Banfield - Instituto","Result FT":"1-2","Date":"2024-09-01"}
    ];
    $("#jsonText").value = JSON.stringify(sample, null, 2);
  });

  $("#selLeague").addEventListener("change", (e)=>{
    const lg = e.target.value;
    CURRENT.league = lg || null;
    if(!lg){ fillSelect($("#selHome"), [], "â€” Local â€”"); fillSelect($("#selAway"), [], "â€” Visitante â€”"); return; }
    const teams = getLeagueTeams(lg);
    fillSelect($("#selHome"), teams, "â€” Local â€”");
    fillSelect($("#selAway"), teams, "â€” Visitante â€”");
  });

  $("#selHome").addEventListener("change", (e)=>{ CURRENT.home = e.target.value || null; });
  $("#selAway").addEventListener("change", (e)=>{ CURRENT.away = e.target.value || null; });

  $("#btnCalc").addEventListener("click", ()=>{
    const league = $("#selLeague").value;
    const home = $("#selHome").value;
    const away = $("#selAway").value;
    if(!league || !home || !away){ $("#calcMsg").textContent = "Selecciona liga y ambos equipos."; return; }
    if(home===away){ $("#calcMsg").textContent = "El local y el visitante no pueden ser el mismo."; return; }
    const { lamH, lamA } = computeLambdas(league, home, away);
    const line = Number($("#ouLine").value || 2.5);
    const kMax = Math.max(6, Number($("#maxGoals").value || 10));
    const probs = computeAllProbs(lamH, lamA, line, kMax);

    CURRENT.lambdas = {lamH, lamA};
    CURRENT.probs = probs;

    renderModel();
    $("#calcMsg").textContent = "OK: Poisson calculado.";
  });

  $("#btnOdds").addEventListener("click", calcOdds);

})();
</script>
</body>
</html>
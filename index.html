<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BetTracking — Multi-Bankroll & Kelly</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa6b2;
      --accent:#10b981;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      margin:0;
      background: linear-gradient(180deg,#071024 0%, #071227 60%);
      color:#e6eef6;
      padding:24px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .layout{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:18px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:14px;
      border-radius:10px;
      box-shadow: 0 4px 18px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type="text"], input[type="number"], select{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:transparent;
      color:inherit;
      margin-bottom:10px;
      font-size:14px;
    }
    .bankroll-list{display:flex;flex-direction:column;gap:8px}
    .bankroll-btn{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;padding:10px;border-radius:8px;cursor:pointer;
      background:var(--glass);border:1px solid rgba(255,255,255,0.02);
    }
    .bankroll-btn.active{outline:2px solid rgba(16,185,129,0.12);border-color:rgba(16,185,129,0.18)}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px}
    button{
      background:var(--accent);color:#04201a;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;
    }
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .bets-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    .bets-table th,.bets-table td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.win{background:rgba(16,185,129,0.12);color:var(--accent)}
    .pill.loss{background:rgba(239,68,68,0.08);color:var(--danger)}
    .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .summary .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;min-width:150px}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .row{display:flex;gap:8px}
    .col{flex:1}
    .right{text-align:right}
    .danger{color:var(--danger)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .small-muted{font-size:12px;color:var(--muted)}
    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>BetTracking — Multi-Bankroll & Kelly</h1>
      <div class="sub">Hasta 5 bankrolls · Kelly (fórmula decimal) · Guardado en localStorage</div>
    </div>
    <div class="small-muted">Sugerencia: introduce probabilidades como decimal (ej. 0.589 para 58.9%)</div>
  </header>

  <div class="layout">
    <aside class="card">
      <h3 style="margin:0 0 8px 0">Bankrolls (máx 5)</h3>
      <div class="bankroll-list" id="bankrollList"></div>

      <div style="margin-top:12px">
        <label for="newName">Nombre bankroll</label>
        <input id="newName" type="text" placeholder="Ej: Fondo A" maxlength="30"/>
        <label for="newBal">Balance inicial (MXN)</label>
        <input id="newBal" type="number" step="0.01" placeholder="1000" />
        <div class="row">
          <button id="addBankrollBtn">Añadir</button>
          <button id="resetBtn" class="ghost">Reset</button>
        </div>
        <div class="note">Puedes crear hasta 5 bankrolls. Se guardan en tu navegador (localStorage).</div>
      </div>
    </aside>

    <main class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div>
          <label class="small">Bankroll activo</label>
          <div id="activeBankrollName" style="font-weight:700;font-size:16px">— Selecciona uno —</div>
          <div class="small-muted" id="activeBalance">Balance: —</div>
        </div>

        <div style="min-width:260px">
          <label for="kellyFrac">Fracción Kelly (%)</label>
          <div class="row">
            <input id="kellyFrac" type="number" min="0" max="100" step="1" value="25" />
            <div style="flex:1">
              <label class="small">Usar Kelly como:</label>
              <select id="useKelly">
                <option value="suggest">Solo sugerir (no stake automático)</option>
                <option value="auto">Calcular stake automático</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">

      <h3 style="margin-top:0">Agregar apuesta</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Descripción</label>
          <input id="betDesc" type="text" placeholder="Ej: América vs Pumas — Over 2.5"/>
          <label>Probabilidad (p) — formato decimal</label>
          <input id="betP" type="number" step="0.0001" min="0" max="1" placeholder="0.589" />
          <label>Cuota decimal (D)</label>
          <input id="betD" type="number" step="0.01" min="1.01" placeholder="2.00" />
        </div>

        <div>
          <label>Stake (opcional) — si vacío se usará Kelly)</label>
          <input id="betStake" type="number" step="0.01" min="0" placeholder="Ej: 50" />
          <label>Tipo resultado</label>
          <select id="betType">
            <option value="normal">Normal (ganancia = stake*(D-1))</option>
            <option value="back">Back (mismo cálculo)</option>
            <option value="lay">Lay (no soportado completo — use normal)</option>
          </select>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addBetBtn">Añadir apuesta</button>
            <button id="clearForm" class="ghost">Limpiar</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:4px 0">Bets del bankroll</h4>
        <table class="bets-table" id="betsTable">
          <thead>
            <tr><th>Desc</th><th>P</th><th>D</th><th>Kelly%</th><th>Stake</th><th>Estado</th><th class="right">Acciones</th></tr>
          </thead>
          <tbody id="betsBody">
            <tr><td colspan="7" class="muted">No hay apuestas</td></tr>
          </tbody>
        </table>

        <div class="summary" id="summary">
          <!-- stats injected here -->
        </div>
      </div>

      <div style="margin-top:14px">
        <h4>Cómo se calcula Kelly (decimal odds)</h4>
        <div class="small-muted">f* = (p·D − 1) / (D − 1). Si f* ≤ 0 → no apostar. La apuesta sugerida = balance × f* × (Fracción Kelly).</div>
      </div>

      <footer>
        <div class="small-muted">Archivo local — tus bankrolls y apuestas se guardan solo en este navegador.</div>
      </footer>
    </main>
  </div>

<script>
/* Utility helpers */
function $(id){ return document.getElementById(id); }
function money(x){ return Number(x).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) }

/* Storage keys & state */
const STORAGE_KEY = 'bettrack_v1';
let state = { bankRolls: [], active: null };

/* Load and save */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){ console.warn('load err',e) }
  if(!state.bankRolls) state = { bankRolls: [], active: null };
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* Bootstrap UI */
function renderBankrolls(){
  const list = $('bankrollList');
  list.innerHTML = '';
  state.bankRolls.forEach((b,i)=>{
    const btn = document.createElement('div');
    btn.className = 'bankroll-btn' + (state.active===i ? ' active':'');
    btn.innerHTML = `<div>
        <div style="font-weight:700">${escapeHtml(b.name)}</div>
        <div class="small-muted">Saldo: ${money(b.balance)}</div>
      </div>
      <div style="text-align:right">
        <div class="small-muted">Bets: ${b.bets.length}</div>
        <div style="margin-top:6px" class="controls">
          <button class="ghost" onclick="editBankroll(${i})">Editar</button>
          <button onclick="selectBankroll(${i})">Abrir</button>
        </div>
      </div>`;
    list.appendChild(btn);
  });
  if(state.bankRolls.length < 5){
    const hint = document.createElement('div');
    hint.className = 'bankroll-btn';
    hint.style.justifyContent='center';
    hint.innerHTML = '<div class="small-muted">➕ Crea otro bankroll</div>';
    list.appendChild(hint);
  }
  updateActiveInfo();
}

function updateActiveInfo(){
  const nameEl = $('activeBankrollName');
  const balEl = $('activeBalance');
  if(state.active === null || !state.bankRolls[state.active]){
    nameEl.textContent = '— Selecciona uno —';
    balEl.textContent = 'Balance: —';
  } else {
    const b = state.bankRolls[state.active];
    nameEl.textContent = b.name;
    balEl.textContent = 'Balance: ' + money(b.balance);
  }
  renderBets();
}

/* Bankroll actions */
function addBankroll(){
  const name = $('newName').value.trim() || `Bankroll ${state.bankRolls.length+1}`;
  const bal = parseFloat($('newBal').value) || 0;
  if(state.bankRolls.length >= 5){ alert('Máximo 5 bankrolls'); return; }
  state.bankRolls.push({ name, balance: Number(bal), bets: [] });
  state.active = state.bankRolls.length -1;
  saveState(); renderBankrolls();
  $('newName').value=''; $('newBal').value='';
}
function selectBankroll(i){
  state.active = i; saveState(); renderBankrolls();
}
function editBankroll(i){
  const b = state.bankRolls[i];
  const newName = prompt('Nuevo nombre', b.name);
  if(newName!==null) b.name = newName.trim()||b.name;
  const newBal = prompt('Nuevo balance (numérico)', b.balance);
  const nb = parseFloat(newBal);
  if(!isNaN(nb)) b.balance = nb;
  saveState(); renderBankrolls();
}
function resetAll(){
  if(!confirm('Eliminar todos los datos guardados en este navegador?')) return;
  state = { bankRolls: [], active: null };
  saveState(); renderBankrolls();
}

/* Bets */
function renderBets(){
  const tbody = $('betsBody');
  tbody.innerHTML = '';
  if(state.active===null || !state.bankRolls[state.active]){
    tbody.innerHTML = '<tr><td colspan="7" class="muted">No hay apuestas — selecciona un bankroll</td></tr>';
    $('summary').innerHTML = '';
    return;
  }
  const b = state.bankRolls[state.active];
  if(b.bets.length===0){
    tbody.innerHTML = '<tr><td colspan="7" class="muted">No hay apuestas</td></tr>';
    $('summary').innerHTML = '';
    return;
  }
  let totalStaked=0, totalPL=0, wins=0, losses=0;
  b.bets.forEach((bet,idx)=>{
    const tr = document.createElement('tr');
    const kelly = computeKellyFraction(bet.p, bet.d);
    const kellyPct = (kelly>0 && isFinite(kelly)) ? (kelly*100).toFixed(2)+'%' : '—';
    const stake = bet.stake !== null ? Number(bet.stake) : (kelly>0 ? getSuggestedStake(b.balance, kelly) : 0);
    totalStaked += Number(stake);
    // P/L if resolved
    let pl = 0;
    let stateLabel = '<span class="pill">Pendiente</span>';
    if(bet.status==='win'){ pl = stake*(bet.d-1); stateLabel = `<span class="pill win">Ganada</span>`; wins++; }
    if(bet.status==='loss'){ pl = -stake; stateLabel = `<span class="pill loss">Perdida</span>`; losses++; }
    totalPL += pl;
    tr.innerHTML = `<td>${escapeHtml(bet.desc||'—')}</td>
      <td class="muted">${Number(bet.p).toFixed(4)}</td>
      <td class="muted">${Number(bet.d).toFixed(2)}</td>
      <td class="muted">${kellyPct}</td>
      <td>${money(stake)}</td>
      <td>${stateLabel}</td>
      <td class="right">
        ${bet.status!=='win' ? `<button onclick="resolveBet(${idx},'win')">Win</button>` : ''}
        ${bet.status!=='loss' ? `<button class="ghost" onclick="resolveBet(${idx},'loss')">Loss</button>` : ''}
        <button class="ghost" onclick="removeBet(${idx})">Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // summary
  const summary = $('summary');
  summary.innerHTML = `
    <div class="stat"><div class="small-muted">Staked total</div><div style="font-weight:700">${money(totalStaked)}</div></div>
    <div class="stat"><div class="small-muted">Profit/Loss</div><div style="font-weight:700">${money(totalPL)}</div></div>
    <div class="stat"><div class="small-muted">Wins / Losses</div><div style="font-weight:700">${wins} / ${losses}</div></div>
    <div class="stat"><div class="small-muted">Bankroll actual</div><div style="font-weight:700">${money(b.balance)}</div></div>
  `;
}

/* Kelly math */
function computeKellyFraction(p, d){
  p = Number(p); d = Number(d);
  if(!isFinite(p) || !isFinite(d) || d <= 1) return -Infinity;
  // f* = (p*D - 1) / (D - 1)
  const f = (p * d - 1) / (d - 1);
  return f;
}
function getSuggestedStake(balance, f){
  const fracPercent = Number($('kellyFrac').value) || 0;
  const useFrac = Math.max(0, Math.min(100, fracPercent)) / 100;
  if(f <= 0) return 0;
  const stake = balance * f * useFrac;
  return Math.max(0, stake);
}

/* Actions: add bet, resolve, remove */
function addBet(){
  if(state.active===null){ alert('Selecciona un bankroll primero'); return; }
  const desc = $('betDesc').value.trim();
  const p = parseFloat($('betP').value);
  const d = parseFloat($('betD').value);
  if(isNaN(p) || p<=0 || p>=1){ alert('Introduce una probabilidad válida entre 0 y 1 (p)'); return; }
  if(isNaN(d) || d<=1){ alert('Introduce una cuota decimal válida (>1)'); return; }
  let stake = parseFloat($('betStake').value);
  if(isNaN(stake)) stake = null;
  const bet = { desc, p, d, stake, status: 'pending', created: Date.now() };
  state.bankRolls[state.active].bets.push(bet);
  saveState();
  renderBets();
  $('betDesc').value=''; $('betP').value=''; $('betD').value=''; $('betStake').value='';
}

function resolveBet(idx, result){
  const b = state.bankRolls[state.active];
  const bet = b.bets[idx];
  if(!bet) return;
  // Determine stake to use
  const k = computeKellyFraction(bet.p, bet.d);
  const stake = bet.stake !== null ? Number(bet.stake) : (k>0 ? getSuggestedStake(b.balance, k) : 0);
  if(result === 'win'){
    const profit = stake * (bet.d - 1);
    b.balance = Number((b.balance + profit).toFixed(2));
    bet.status = 'win';
  } else {
    b.balance = Number((b.balance - stake).toFixed(2));
    bet.status = 'loss';
  }
  saveState();
  renderBankrolls();
}

function removeBet(idx){
  if(!confirm('Eliminar esta apuesta?')) return;
  const b = state.bankRolls[state.active];
  b.bets.splice(idx,1);
  saveState();
  renderBets();
}

/* Helpers */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m] })}

/* Wire up UI */
document.getElementById('addBankrollBtn').addEventListener('click', addBankroll);
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('addBetBtn').addEventListener('click', addBet);
document.getElementById('clearForm').addEventListener('click', ()=>{ $('betDesc').value=''; $('betP').value=''; $('betD').value=''; $('betStake').value=''; });

/* Init */
loadState();
renderBankrolls();

</script>
</body>
</html>
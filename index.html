<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Modelo BTTS (GG): logística + prior de mercado</title>
<style>
  :root{--bg:#0f1115;--card:#171a21;--bd:#2a3140;--fg:#e6eaf2;--mut:#9aa3b2;--btn:#7aa2ff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--bd)} .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:18px} .card{background:#171a21;border:1px solid var(--bd);border-radius:12px;padding:14px;margin:12px 0}
  label{display:block;margin:6px 0 4px} input,select,button,textarea{width:100%;background:#1e2430;color:var(--fg);border:1px solid var(--bd);border-radius:8px;padding:8px}
  button{background:var(--btn);color:#0b1020;font-weight:700;cursor:pointer}
  .grid{display:grid;gap:12px} @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .pill{display:inline-block;background:#1e2430;border:1px solid var(--bd);border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;font-size:12px;color:var(--mut)}
  .out{font-size:15px;margin-top:8px}
  table{width:100%;border-collapse:collapse;margin-top:8px} th,td{border-bottom:1px solid var(--bd);padding:6px;text-align:left}
</style>
</head>
<body>
<header class="wrap"><h1>BTTS (GG) — Modelo logístico con features de partido + prior (1/Odd GG)</h1></header>

<div class="wrap">
  <div class="card">
    <div class="grid">
      <div>
        <label>Importar JSON (histórico, array de objetos)</label>
        <input id="file" type="file" accept=".json"/>
        <label style="margin-top:10px">o pegar JSON (array de partidos)</label>
        <button id="btnPaste">Pegar desde portapapeles</button>
        <div class="pill" id="status">Sin datos</div>
      </div>
      <div>
        <label>Partido a predecir</label>
        <select id="rowSel"><option value="">—</option></select>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>EV mínimo (sugerencia)</label>
            <input id="evMin" type="number" step="0.01" value="0.03"/>
          </div>
          <div>
            <label>Iteraciones (entreno)</label>
            <input id="iters" type="number" step="100" value="1500"/>
          </div>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>LR (learning rate)</label>
            <input id="lr" type="number" step="0.01" value="0.05"/>
          </div>
          <div>
            <label>L2 (regularización)</label>
            <input id="l2" type="number" step="0.0001" value="0.001"/>
          </div>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:8px">
          <button id="train">Entrenar</button>
          <button id="predict">Predecir BTTS (GG)</button>
        </div>
      </div>
    </div>
    <div class="out" id="out">—</div>
  </div>

  <div class="card">
    <details>
      <summary>Ver últimas predicciones / depuración</summary>
      <table id="tbl"><thead><tr><th>Fecha</th><th>Liga</th><th>Partido</th><th>Odd GG</th><th>p̂ BTTS</th><th>EV</th><th>Sugerencia</th></tr></thead><tbody></tbody></table>
    </details>
  </div>
</div>

<script>
// ===== Utilidades
const el=id=>document.getElementById(id);
const clamp01 = p => Math.min(0.999, Math.max(0.001, p));
const sigmoid = z => 1/(1+Math.exp(-z));
const logit   = p => Math.log(p/(1-p));
const dot=(a,b)=>{let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s;};
const pct = x => isFinite(x) ? (x*100).toFixed(1)+'%' : '—';
const fmt = x => isFinite(x) ? (+x).toFixed(3) : '—';

// ===== Dataset y modelo
let DATA = [];           // array de objetos (tu formato)
let SCALER = null;       // {mu,sd,keys}
let MODEL  = null;       // {w,b}

// ===== Lectura de datos
el('file').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const txt=await f.text(); loadJSON(txt); }catch(err){ alert('Error JSON: '+err); }
});
el('btnPaste').addEventListener('click', async ()=>{
  try{ const txt=await navigator.clipboard.readText(); loadJSON(txt); }catch(err){ alert('Portapapeles: '+err); }
});

function loadJSON(txt){
  let arr;
  try{
    arr = JSON.parse(txt);
  }catch(e){
    // NDJSON fallback
    arr = txt.split(/\r?\n/).map(t=>t.trim()).filter(Boolean).map(JSON.parse);
  }
  if(!Array.isArray(arr)) throw new Error('El JSON debe ser un array de partidos.');
  DATA = arr;
  // poblar selector
  const opts = ['<option value="">—</option>']
    .concat(arr.map((r,i)=>`<option value="${i}">${(r.Date||'').slice(0,10)} — ${r.League||''} — ${r.Match||''}</option>`));
  el('rowSel').innerHTML = opts.join('');
  el('status').textContent = `Cargados ${arr.length} partidos.`;
  el('out').textContent = 'Lista la carga. Entrena y luego predice.';
}

// ===== Labels / features
function labelBTTS(row){
  const m = String(row["Result FT"]||row.Result||"").match(/(-?\d+)\s*[-:]\s*(-?\d+)/);
  if(!m) return null;
  const h=+m[1], a=+m[2];
  return (h>0 && a>0) ? 1 : 0;
}
function pFromOddGG(row){
  const o = parseFloat(row.Odd);
  return Number.isFinite(o) && o>1 ? clamp01(1/o) : 0.5;
}
function buildFeatures(row){
  const f = {};
  f.att_home = +row["Home Attacks at FT"] || 0;
  f.att_away = +row["Away Attacks at FT"] || 0;
  f.datt_home= +row["Home Dangerous Attacks at FT"] || 0;
  f.datt_away= +row["Away Dangerous Attacks at FT"] || 0;
  f.ong_home = +row["Home OnGoal Shots at FT"] || 0;
  f.ong_away = +row["Away OnGoal Shots at FT"] || 0;
  f.sh_home  = +row["Home Total Shots at FT"] || 0;
  f.sh_away  = +row["Away Total Shots at FT"] || 0;
  f.pos_home = (+row["Home Ball Possession at FT"] || 0)/100;
  f.pos_away = (+row["Away Ball Possession at FT"] || 0)/100;
  f.cor_home = +row["Home Corners at FT"] || 0;
  f.cor_away = +row["Away Corners at FT"] || 0;
  f.rc_home  = +row["Home RedCards at FT"] || 0;
  f.rc_away  = +row["Away RedCards at FT"] || 0;
  f.yc_home  = +row["Home YellowCards at FT"] || 0;
  f.yc_away  = +row["Away YellowCards at FT"] || 0;
  f.posH     = +row["Home Position"] || 999;
  f.posA     = +row["Away Position"] || 999;
  f.homeFlag = 1;
  const o1=+row["Odd 1 PreMatch"]||NaN, ox=+row["Odd X PreMatch"]||NaN, o2=+row["Odd 2 PreMatch"]||NaN;
  f.p1 = Number.isFinite(o1)&&o1>1 ? 1/o1 : 0.0;
  f.px = Number.isFinite(ox)&&ox>1 ? 1/ox : 0.0;
  f.p2 = Number.isFinite(o2)&&o2>1 ? 1/o2 : 0.0;
  f.d_att  = f.att_home  - f.att_away;
  f.d_datt = f.datt_home - f.datt_away;
  f.d_ong  = f.ong_home  - f.ong_away;
  f.d_sh   = f.sh_home   - f.sh_away;
  f.d_pos  = f.pos_home  - f.pos_away;
  f.d_cor  = f.cor_home  - f.cor_away;
  f.d_cards= (f.rc_home*3+f.yc_home) - (f.rc_away*3+f.yc_away);
  f.d_rank = (isFinite(f.posH)?f.posH:999) - (isFinite(f.posA)?f.posA:999);
  return f;
}
const FEAT_ORDER = [
  'att_home','att_away','datt_home','datt_away','ong_home','ong_away','sh_home','sh_away',
  'pos_home','pos_away','cor_home','cor_away','rc_home','rc_away','yc_home','yc_away',
  'p1','px','p2','d_att','d_datt','d_ong','d_sh','d_pos','d_cor','d_cards','d_rank','homeFlag'
];
function fitScaler(feats){
  const keys = FEAT_ORDER.slice();
  const mu={}, sd={};
  for(const k of keys){
    const vals = feats.map(r=>+r[k]||0);
    const m = vals.reduce((s,x)=>s+x,0)/Math.max(1,vals.length);
    const v = vals.reduce((s,x)=>s+(x-m)*(x-m),0)/Math.max(1,vals.length);
    mu[k]=m; sd[k]=Math.sqrt(v)||1;
  }
  return {mu,sd,keys};
}
function toVectorZ(f,scaler){
  return FEAT_ORDER.map(k=>(((+f[k]||0)-scaler.mu[k])/scaler.sd[k]));
}

// ===== Entrenamiento logística L2
function trainLogistic(X, y, priorP, {lr=0.05, l2=1e-3, iters=1500}={}){
  const n = X.length, d = X[0].length;
  let w = new Array(d).fill(0);
  let b = logit(clamp01(priorP));
  for(let t=0;t<iters;t++){
    let gb = 0; const gw = new Array(d).fill(0);
    for(let i=0;i<n;i++){
      const z = b + dot(w,X[i]);
      const p = sigmoid(z);
      const e = (p - y[i]);
      gb += e;
      for(let j=0;j<d;j++) gw[j] += e*X[i][j];
    }
    for(let j=0;j<d;j++) gw[j] += l2*w[j];
    b -= lr * gb/n;
    for(let j=0;j<d;j++) w[j] -= lr * gw[j]/n;
  }
  return {w,b};
}
function predictProba(x, model){ return sigmoid(model.b + dot(model.w, x)); }

// ===== Botones
el('train').addEventListener('click', ()=>{
  if(!DATA.length){ alert('Carga un JSON con histórico.'); return; }

  // Dataset etiquetado: exige marcador FT válido
  const rowsLabeled = DATA.filter(r => labelBTTS(r)===0 || labelBTTS(r)===1);
  if(rowsLabeled.length<30){ alert('Se requieren ≥30 partidos con Result FT para entrenar decentemente.'); return; }

  const feats = rowsLabeled.map(buildFeatures);
  SCALER = fitScaler(feats);
  const X = feats.map(f=>toVectorZ(f,SCALER));
  const y = rowsLabeled.map(labelBTTS);

  // prior promedio desde Odd(GG)
  const priors = rowsLabeled.map(pFromOddGG).filter(Number.isFinite);
  const priorP = priors.length ? (priors.reduce((s,x)=>s+x,0)/priors.length) : 0.5;

  const iters = +el('iters').value||1500, lr=+el('lr').value||0.05, l2=+el('l2').value||0.001;
  MODEL = trainLogistic(X,y,priorP,{lr,l2,iters});

  el('out').textContent = `Modelo entrenado con ${rowsLabeled.length} partidos. Prior mkt=${fmt(priorP)}.`;
});

el('predict').addEventListener('click', ()=>{
  const idx = +el('rowSel').value;
  if(!(idx>=0)){ alert('Elige un partido del selector.'); return; }
  const row = DATA[idx];
  const oddGG = parseFloat(row.Odd);
  const evMin = +el('evMin').value || 0.03;

  // Si no hay modelo pero sí cuota, damos prior
  let p = NaN, mode='prior';
  if(MODEL && SCALER){
    const f = buildFeatures(row);
    const x = toVectorZ(f, SCALER);
    p = predictProba(x, MODEL);
    mode='modelo';
  }else{
    p = pFromOddGG(row);
  }

  const ev = (Number.isFinite(oddGG)&&oddGG>1) ? (p*(oddGG-1)-(1-p)) : NaN;
  const sug = Number.isFinite(ev) && ev>=evMin ? 'APOSTAR' : 'NO APOSTAR';

  el('out').innerHTML = `
    <div><b>${(row.Date||'').slice(0,10)}</b> — ${row.League||''} — ${row.Match||''}</div>
    <div class="pill">Modo: ${mode}</div>
    <div class="pill">Odd GG: ${Number.isFinite(oddGG)?oddGG.toFixed(2):'—'}</div>
    <div class="pill">p̂ BTTS: <b>${fmt(p)}</b></div>
    <div class="pill">EV: <b>${fmt(ev)}</b></div>
    <div class="pill">Sugerencia (${fmt(evMin)} EV min): <b>${sug}</b></div>
  `;

  const tb = document.querySelector('#tbl tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${(row.Date||'').slice(0,10)}</td><td>${row.League||''}</td><td>${row.Match||''}</td>
                  <td>${Number.isFinite(oddGG)?oddGG.toFixed(2):'—'}</td><td>${fmt(p)}</td><td>${fmt(ev)}</td><td>${sug}</td>`;
  tb.prepend(tr);
});
</script>
</body>
</html>
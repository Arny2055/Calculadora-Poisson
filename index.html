<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Football Value-Hacker v16.0 (Registro Persistente)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* Estilos CSS Base */
        :root {
            --bg-main: #0c1524;
            --bg-panel: #1a2434;
            --bg-card: #222e40;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #f59e0b; 
            --accent-hover: #d97706;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --stats-bg: #1e3a8a;
            --stats-accent: #60a5fa;
            --win: #10b981;
            --lose: #ef4444;
            --push: #94a3b8;
        }
        * { box-sizing: border-box; outline: none; min-width: 0; }
        /* CORRECCI√ìN: Evitar desbordamiento horizontal y permitir que el texto escale el layout */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; font-size: 14px; }
        
        .separator { border: 0; height: 1px; background: var(--border); margin: 15px 0; }
        
        /* Header y Botones */
        header { background-color: var(--bg-panel); padding: 10px 15px; height: auto; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .brand { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; color: var(--accent);}
        .tag { font-size:0.6em; background:var(--success); padding:2px 6px; border-radius:8px; color:white; font-weight: normal; }
        .btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; display: flex; align-items: center; gap: 6px; color:white; font-size: 0.8rem; transition: background-color 0.2s; white-space: nowrap;}
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #05925a; }
        .mobile-toggle { display: none; }
        
        /* Contenedor Principal (Desktop Grid) */
        .container { display: grid; grid-template-columns: 250px 1fr; height: calc(100vh - 50px); overflow: hidden; }
        
        /* Sidebar (Barra Lateral) */
        .sidebar { background-color: var(--bg-panel); border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
        .sidebar h3 { margin: 0; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; padding-bottom: 5px; }
        .control-group label { display: block; margin-bottom: 2px; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;}
        select, input[type="number"], input[type="text"] { width: 100%; padding: 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: white; font-size: 0.8rem;}
        .btn-run { background: var(--success); width: 100%; justify-content: center; padding: 10px; margin-top: 10px; font-size: 0.9rem; }
        
        /* Contenido Principal */
        .main { padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* KPI Cards */
        .kpi-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .kpi-grid { display: inline-flex; gap: 10px; }
        .kpi-card { min-width: 140px; background: var(--bg-card); padding: 10px; border-radius: 6px; border: 1px solid var(--border); flex-shrink: 0;}
        .kpi-title { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
        .kpi-value { font-size: 1.3rem; font-weight: 700; margin-top: 2px; }
        
        /* Colores de Texto */
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-blue { color: var(--stats-accent); }
        .text-orange { color: var(--warning); }
        
        /* Tablas */
        .stats-card { background: var(--bg-card); padding: 15px; border-radius: 6px; border: 1px solid var(--stats-accent); flex-shrink: 0; display:none;}
        .table-scroll { overflow-x: auto; overflow-y: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; table-layout: fixed; } 
        th { padding: 8px 10px; text-align: left; background: var(--border); }
        td { padding: 6px 10px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Estilos de tabla de Value Bets */
        .market-H { background-color: rgba(255, 204, 0, 0.05); }
        .market-D { background-color: rgba(0, 191, 255, 0.05); }
        .market-A { background-color: rgba(100, 149, 237, 0.05); }
        .market-O25, .market-U25 { background-color: rgba(169, 169, 169, 0.05); }
        .file-list { font-size: 0.75rem; color: var(--text-secondary); max-height: 80px; overflow-y: auto; padding: 5px; border: 1px solid var(--border); border-radius: 4px;}
        
        /* Estilos para el Historial de Apuestas (Placing Bets) */
        .placed-bets-panel { margin-top: 15px; padding: 15px; background: var(--bg-card); border-radius: 6px; border: 1px solid var(--success); }
        .status-win { background: var(--win); color: black; font-weight: bold; border-radius: 4px; padding: 2px 5px; font-size: 0.7rem; }
        .status-lose { background: var(--lose); color: white; font-weight: bold; border-radius: 4px; padding: 2px 5px; font-size: 0.7rem; }
        .status-push { background: var(--push); color: black; font-weight: bold; border-radius: 4px; padding: 2px 5px; font-size: 0.7rem; }
        .status-pending { background: var(--border); color: white; border-radius: 4px; padding: 2px 5px; font-size: 0.7rem; }

        .btn-status { padding: 2px 4px; border-radius: 4px; cursor: pointer; border: none; font-size: 0.7rem; font-weight: 600; line-height: 1; } /* CORRECCI√ìN: Menor padding y line-height */
        .btn-win { background: var(--win); color: black; }
        .btn-lose { background: var(--lose); color: white; }
        .btn-push { background: var(--push); color: black; }

        /* Ajustes para m√≥viles */
        @media (max-width: 768px) {
            body { font-size: 12px; }
            header { height: auto; flex-direction: column; padding: 5px 10px; gap: 5px; }
            .container { grid-template-columns: 1fr; height: calc(100vh - 70px); }
            .sidebar { position: fixed; transform: translateX(-100%); width: 85%; z-index: 50; padding-top: 50px; }
            .sidebar.open { transform: translateX(0); }
            .mobile-toggle { display: block; }
            .main { padding: 10px; }
            
            /* CORRECCI√ìN: Forzar el apilamiento de KPIs y que ocupen todo el ancho */
            .kpi-wrapper { overflow-x: visible; }
            .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; white-space: normal; }
            .kpi-card { min-width: 100%; padding: 8px; }
            .placed-bets-panel .kpi-grid { grid-template-columns: repeat(2, 1fr); }


            /* CORRECCI√ìN TABLA DE APUESTAS REGISTRADAS (Ajustar ancho de columnas) */
            #placedBetsTable th, #placedBetsTable td { font-size: 0.65rem; padding: 4px; white-space: normal; }
            #placedBetsTable { table-layout: auto; }
            #placedBetsTable th:nth-child(1), #placedBetsTable td:nth-child(1) { width: 10%; } /* ID */
            #placedBetsTable th:nth-child(2), #placedBetsTable td:nth-child(2) { width: 12%; } /* Fecha */
            #placedBetsTable th:nth-child(3), #placedBetsTable td:nth-child(3) { width: 35%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } /* Partido */
            #placedBetsTable th:nth-child(4), #placedBetsTable td:nth-child(4) { width: 15%; } /* Cuota/EV */
            #placedBetsTable th:nth-child(5), #placedBetsTable td:nth-child(5) { width: 10%; } /* Stake */
            #placedBetsTable th:nth-child(6), #placedBetsTable td:nth-child(6) { display: none; } /* Ocultar Profit en la tabla principal (ya est√° en KPI) */
            #placedBetsTable th:nth-child(7), #placedBetsTable td:nth-child(7) { width: 18%; } /* Estado */
            
            /* CORRECCI√ìN TABLA DE VALOR (Ajustar ancho de columnas) */
            #valueBetsTable th, #valueBetsTable td { font-size: 0.7rem; padding: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            #valueBetsTable th:nth-child(1), #valueBetsTable td:nth-child(1) { width: 10%; } /* Fecha */
            #valueBetsTable th:nth-child(2), #valueBetsTable td:nth-child(2) { width: 25%; } /* Partido */
            #valueBetsTable th:nth-child(5), #valueBetsTable td:nth-child(5) { display: none; } /* Ocultar Cuota Justa */
            #valueBetsTable th:nth-child(8), #valueBetsTable td:nth-child(8) { width: 15%; } /* Acci√≥n */
            
            .btn-status { margin-right: 2px; } /* Menor espacio entre botones de estado */
            
            .stats-card div { flex-direction: column; } /* Asegurar que la tarjeta de an√°lisis se apile */
        }
    </style>
</head>
<body>

    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 2rem;">
        <i class="fas fa-hammer spinner" style="animation: spin 1.5s linear infinite;"></i>
        <h3 id="loadingMessage" style="margin-top:20px; color:#ccc;">Cargando archivos...</h3>
    </div>

    <header>
        <div class="brand">
            <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <i class="fas fa-hammer"></i> Value-Hacker <span class="tag">v16.0 Persistente</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="file" id="fileInputHistorical" accept=".csv" multiple style="display:none;" onchange="loadHistoricalFiles(event)">
            <label for="fileInputHistorical" class="btn btn-success"><i class="fas fa-database"></i> Historial</label>
            
            <input type="file" id="fileInputFuture" accept=".csv" style="display:none;" onchange="loadFutureFile(event)">
            <label for="fileInputFuture" class="btn btn-secondary"><i class="fas fa-calendar-alt"></i> Futuros</label>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            
            <div style="padding:10px; border-radius:6px; background:var(--bg-card); border:1px solid var(--accent);">
                <div class="file-stats" style="display:flex; justify-content:space-between; font-weight:600; margin-bottom:5px; color:var(--text-primary);">
                    <span>Historial: <span id="histFileCount">0</span> archivos</span>
                    <span>Total: <span id="histMatchCount">0</span> partidos</span>
                </div>
                <div id="historicalFileList" class="file-list">No hay archivos de historial cargados.</div>
            </div>
            
            <div class="control-group">
                <label style="color:var(--accent);">Partidos a Analizar (Futuros)</label>
                <input type="text" id="urlInputFuture" placeholder="Archivo a analizar cargado" disabled>
            </div>

            <hr class="separator">

            <div class="tab-controls" style="display:flex; gap:5px; margin-bottom:10px;">
                <button id="tabConfigBtn" class="btn btn-secondary" style="flex-grow:1; background:var(--bg-panel); border:none;" onclick="switchTab('config')"><i class="fas fa-sliders-h"></i> Configuraci√≥n</button>
                <button id="tabEstadisticasBtn" class="btn btn-secondary" style="flex-grow:1; background:var(--bg-panel); border:none;" onclick="switchTab('estadisticas')"><i class="fas fa-chart-line"></i> An√°lisis</button>
            </div>

            <div id="tabConfig" class="tab-content active">
                <h3>üí∞ Gesti√≥n de Banca y Stake</h3>
                <div class="control-group">
                    <label>Mercados a Analizar</label>
                    <select id="marketSelect">
                        <option value="all" selected>TODOS los mercados</option>
                        <option value="H">Local (1)</option>
                        <option value="D">Empate (X)</option>
                        <option value="A">Visita (2)</option>
                        <option value="O25">Over 2.5 Goles</option>
                        <option value="U25">Under 2.5 Goles</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label style="color:var(--accent); font-weight:bold;">
                        <input type="checkbox" id="useFrequencyValue" style="width:auto; margin-right:5px; transform:scale(1.2);" checked> Aplicar Filtro EV > M√≠nimo
                    </label>
                </div>

                <div class="control-group">
                    <label>Estrategia de Stake (Solo para calcular el monto)</label>
                    <div style="display:flex; gap:5px;">
                        <select id="stakeType" style="width:60%;">
                            <option value="flat">Plano (Fijo)</option>
                            <option value="percent">% Banca</option>
                            <option value="kelly" selected>Criterio de Kelly</option>
                        </select>
                        <input type="number" id="stakeValue" value="33" step="1" style="width:40%;" placeholder="Factor/Porc.">
                    </div>
                    <label style="margin-top:5px;">Banca Inicial/Actual: <span id="bankLabel" style="font-weight:bold; color:var(--success);">1000.00</span></label>
                    <input type="number" id="initialBank" value="1000" style="margin-top:2px;" placeholder="Banca Inicial" onchange="document.getElementById('bankLabel').innerText=parseFloat(this.value).toFixed(2);">
                </div>
                
                <hr class="separator">

                <h3>üõ°Ô∏è Filtros de Riesgo / Volatilidad</h3>
                <div class="control-group">
                    <label>Rango de Cuota M√çNIMO y M√ÅXIMO</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="minOdds" value="1.50" step="0.01" min="1.01" style="width:50%;" placeholder="Min Odd">
                        <input type="number" id="maxOdds" value="2.00" step="0.01" min="1.01" style="width:50%;" placeholder="Max Odd">
                    </div>
                </div>
                
                <div class="control-group">
                    <label>M√≠nimo de Valor Esperado (EV%) **M√çNIMO 5%**</label>
                    <input type="number" id="minEV" value="5.00" step="0.01" min="0.01" placeholder="Ej: 5.00 (5%)">
                </div>

                <div class="control-group">
                    <label>Liga</label>
                    <select id="leagueSelect"><option value="all">Todas</option></select>
                </div>
            </div>

            <div id="tabEstadisticas" class="tab-content" style="display:none;">
                <div class="matchup-selectors">
                    <h3 style="border:none; margin-bottom:5px; color:white; font-size:0.9rem;">Selecci√≥n de Partido (An√°lisis de Edge)</h3>
                    <div class="control-group"><label>Equipo Local</label><select id="teamHomeSelect"><option value="">Sel. Local</option></select></div>
                    <div class="vs-badge" style="text-align:center; font-weight:bold; color:var(--accent);">VS</div>
                    <div class="control-group"><label>Equipo Visitante</label><select id="teamAwaySelect"><option value="">Sel. Visita</option></select></div>
                    <button class="btn" style="background:var(--accent); color:black; width:100%; justify-content:center; margin-top:5px;" onclick="analyzeMatchup()">
                        <i class="fas fa-chart-bar"></i> Calcular Edge & EV (Manual)
                    </button>
                </div>
                
                <hr class="separator">

                <h3 style="border:none; margin-bottom:10px; color:white; font-size:0.9rem;">üìà Ventaja Local Din√°mica (HAD)</h3>
                <div class="table-scroll" style="max-height: 250px;">
                    <table id="hadTable">
                        <thead><tr><th>Liga</th><th>Partidos</th><th>HAD Factor</th><th>Ajuste $\lambda_H$</th></tr></thead>
                        <tbody id="hadTableBody"></tbody>
                    </table>
                </div>

            </div>
            
            <button class="btn btn-run" onclick="runAnalysis()"><i class="fas fa-search-dollar"></i> FILTRAR PARTIDOS CON VALOR</button>
            
        </aside>

        <main class="main">
            
            <div id="statsCard" class="stats-card"></div> 

            <div class="kpi-wrapper">
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">Partidos Analizados</div><div class="kpi-value" id="valBets">0</div></div>
                    <div class="kpi-card"><div class="kpi-title">Oportunidades EV+</div><div class="kpi-value text-green" id="valEVPlus">0</div></div>
                    <div class="kpi-card"><div class="kpi-title">Valor Esperado M√°x. (EV)</div><div class="kpi-value text-blue" id="valMaxEV">0.00%</div></div> 
                </div>
            </div>
            
            <div id="placedBetsSection" class="placed-bets-panel">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color:var(--success);"><i class="fas fa-clipboard-list"></i> Historial de Apuestas Registradas</h3>
                    <button class="btn btn-secondary" onclick="clearPlacedBets()" style="padding: 5px 10px; background:var(--danger);"><i class="fas fa-trash-alt"></i> Borrar Historial</button>
                </div>
                <div style="display:flex; gap:10px; margin: 8px 0;" class="kpi-wrapper">
                    <div class="kpi-grid">
                        <div class="kpi-card" style="flex:1;"><div class="kpi-title">Banca Actual</div><div class="kpi-value text-green" id="currentBankValue">0.00</div></div>
                        <div class="kpi-card" style="flex:1;"><div class="kpi-title">Profit Total</div><div class="kpi-value text-blue" id="totalProfitValue">0.00</div></div>
                        <div class="kpi-card" style="flex:1;"><div class="kpi-title">Yield Promedio</div><div class="kpi-value text-orange" id="avgYieldValue">0.00%</div></div>
                        <div class="kpi-card" style="flex:1;"><div class="kpi-title">Apuestas Resueltas</div><div class="kpi-value" id="resolvedBetsCount">0</div></div>
                    </div>
                </div>
                <div class="table-scroll" style="max-height: 25vh;">
                    <table id="placedBetsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Partido (Mercado)</th>
                                <th>Cuota (EV%)</th>
                                <th>Stake</th>
                                <th>Profit</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="placedBetsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="valueBetsSection" class="panel-box" style="width:100%; display:none;">
                <div class="panel-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="panel-title" style="color:var(--accent);"><i class="fas fa-filter"></i> OPORTUNIDADES DE VALOR DETECTADAS (EV+)</span>
                    <button class="btn btn-secondary" onclick="downloadValueBets()" style="padding: 5px 10px;"><i class="fas fa-download"></i> Descargar</button>
                </div>
                <p style="font-size:0.8rem; color:var(--text-secondary);">Presiona **"Registrar Apuesta"** para a√±adirla al Historial y hacer seguimiento.</p>
                <div class="table-scroll" style="max-height: 35vh;">
                    <table id="valueBetsTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Partido</th>
                                <th>Mercado</th>
                                <th>Cuota</th>
                                <th>Cuota Justa</th>
                                <th>**EV %**</th>
                                <th>Stake</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="valueBetsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="historicalAnalysis" style="display:none; margin-top:20px; border-top: 1px dashed var(--border); padding-top:15px;">
                <h3 style="color:var(--stats-accent);"><i class="fas fa-history"></i> An√°lisis de Rendimiento Hist√≥rico (Backtest)</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="panel-box" style="flex: 2 1 60%;"> <div class="chart-box-full"><canvas id="equityChart"></canvas></div></div>
                    <div class="panel-box" style="flex: 1 1 30%;"> <div class="panel-header"><span class="panel-title"><i class="fas fa-chart-area"></i> Drawdown de Banca</span></div> <div style="height: 150px;"><canvas id="drawdownChart"></canvas></div> </div>
                </div>
                <div class="panel-box" style="width:100%; margin-top: 15px;">
                    <div class="panel-header"><span class="panel-title"><i class="fas fa-chart-line"></i> Profit por Liga (Top 10)</span></div>
                    <div style="height: 250px;"><canvas id="leagueChart"></canvas></div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // *** COMIENZO DE LA L√ìGICA JAVASCRIPT - VALUE HACKER v16.0 (LOCAL STORAGE) ***
        let historicalData = []; 
        let futureData = []; 
        let currentStats = null; 
        let leagueHADFactors = {}; 
        let valueBetsResults = []; 
        let placedBets = []; 
        
        let chartEq=null, chartLg=null, chartDD=null; 
        let historicalFileNames = []; 

        // --- L√≥gica de Barra Lateral M√≥vil ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // --- Tabs Logic ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            const content = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
            if (content) content.style.display = 'block';

            document.getElementById('tabConfigBtn').classList.remove('active');
            document.getElementById('tabEstadisticasBtn').classList.remove('active');
            
            const btnId = tabId === 'estadisticas' ? 'tabEstadisticasBtn' : 'tabConfigBtn';
            if (document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
            
            if (tabId === 'estadisticas') {
                 updateHADTable(leagueHADFactors);
            }
        }
        
        // --- FUNCIONES MATEM√ÅTICAS ---
        function calculateKellyStake(p, o, denominator) {
            const b = o - 1;
            const q = 1 - p;
            let f = ((b * p) - q) / b;
            f = f / denominator;
            return Math.max(0.005, f);
        }

        const factorialCache = [1];
        function factorial(n) {
            if (n < factorialCache.length) return factorialCache[n];
            if (n === 0 || n === 1) return 1;
            for (let i = factorialCache.length; i <= n; i++) {
                if (factorialCache[i - 1] * i > Number.MAX_SAFE_INTEGER) {
                    factorialCache[i] = Number.MAX_SAFE_INTEGER;
                } else {
                    factorialCache[i] = factorialCache[i - 1] * i;
                }
            }
            return factorialCache[n];
        }

        function poisson(lambda, k) {
            const limitedLambda = Math.min(20, lambda); 
            if (limitedLambda < 0 || k < 0) return 0;
            return (Math.exp(-limitedLambda) * Math.pow(limitedLambda, k)) / factorial(k);
        }
        
        // --- CARGA Y PROCESAMIENTO DE DATOS ---
        function parseCSVFile(file) {
             return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: (results) => {
                        const validData = results.data.filter(r => Object.keys(r).length > 0 && r.HomeTeam);
                        resolve({ data: validData, name: file.name });
                    },
                    error: (error, file) => { reject(`Error de parsing en el archivo ${file.name}. Mensaje: ${error.message}`); }
                });
            });
        }
        
        async function loadHistoricalFiles(e) {
            const files = e.target.files;
            if (files.length === 0) return;
            if (files.length > 30) {
                 alert("L√≠mite de 30 archivos de historial excedido. Por favor, selecciona 30 o menos.");
                 e.target.value = '';
                 return;
            }
            document.getElementById('loadingMessage').innerText = `Cargando ${files.length} archivos de historial...`;
            document.getElementById('loadingOverlay').style.display = 'flex';
            historicalData = []; historicalFileNames = [];
            try {
                const filePromises = Array.from(files).map(file => parseCSVFile(file));
                const results = await Promise.all(filePromises);
                results.forEach(res => { historicalData.push(...res.data); historicalFileNames.push(res.name); });
                processAllData();
            } catch (error) {
                console.error("Error al cargar archivos de historial:", error);
                alert(`‚ùå Error cargando archivos de historial:\n\n${error}`);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        async function loadFutureFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('loadingMessage').innerText = `Cargando partidos a analizar: ${file.name}...`;
            document.getElementById('loadingOverlay').style.display = 'flex';
            futureData = [];
            document.getElementById('urlInputFuture').value = '';
            try {
                const result = await parseCSVFile(file);
                futureData = result.data;
                document.getElementById('urlInputFuture').value = result.name;
                processAllData();
            } catch (error) {
                console.error("Error al cargar archivo futuro:", error);
                alert(`‚ùå Error cargando archivo futuro:\n\n${error}`);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        function normalizeData(data, isFuture) {
            const parseNum = (val) => { if (typeof val === 'number') return val; if (typeof val === 'string') return parseFloat(val); return null; };
            const getOdds = (key1, key2) => {
                let val1 = parseNum(key1); let val2 = parseNum(key2);
                let val = (val1 && val1 > 1.01) ? val1 : val2;
                return (val && val > 1.01) ? val : 1.01;
            };
            const getGoal = (key) => { let val = parseNum(key); return (val !== null && !isNaN(val) && val >= 0) ? Math.floor(val) : null; }
            
            return data.map(r => {
                if(!r.Date || !r.HomeTeam) return null;
                let d = r.Date; 
                if(typeof d === 'string') {
                    if (d.includes('/')) {
                        const p = d.split('/');
                        if (p.length === 3) { let year = p[2]; if (year.length === 2) year = (parseInt(year) > 70 ? '19' : '20') + year; d = `${year}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
                    } else if (d.includes('.')) {
                        const p = d.split('.');
                        if (p.length === 3) d = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                    }
                }
                const oddsH = getOdds(r.CLH, r.B365H);
                const oddsD = getOdds(r.CLD, r.B365D);
                const oddsA = getOdds(r.CLA, r.B365A);
                const oddsO25 = getOdds(r['CL>2.5'], r['B365>2.5']);
                const oddsU25 = getOdds(r['CL<2.5'], r['B365<2.5']);

                return {
                    date:d, league:r.Div || 'N/A', home:r.HomeTeam, away:r.AwayTeam, 
                    res:isFuture ? null : r.FTR, 
                    goalsH:isFuture ? null : getGoal(r.FTHG), 
                    goalsA:isFuture ? null : getGoal(r.FTAG),
                    oddsH, oddsD, oddsA, oddsO25, oddsU25,
                    isFuture: isFuture 
                };
            }).filter(x=>x && x.oddsH > 1.01); 
        }

        function processAllData() {
            document.getElementById('loadingMessage').innerText = "Procesando y Calculando Coeficientes...";

            const normalizedHistorical = normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null);
            normalizedHistorical.sort((a, b) => a.date.localeCompare(b.date));
            
            updateHistoricalFileList(normalizedHistorical.length);

            leagueHADFactors = calculateLeagueHAD(normalizedHistorical);
            updateHADTable(leagueHADFactors);

            currentStats = calculateCurrentSeasonStats(normalizedHistorical);
            
            const normalizedFuture = normalizeData(futureData, true);
            normalizedFuture.sort((a, b) => a.date.localeCompare(b.date));

            if(currentStats) {
                const teams = Object.keys(currentStats.teamCoeffs).sort();
                const populate = (id) => {
                    const s = document.getElementById(id); const currentVal = s.value; s.innerHTML='<option value="">Seleccionar</option>';
                    teams.forEach(t => s.add(new Option(t,t))); if (teams.includes(currentVal)) s.value = currentVal; 
                };
                populate('teamHomeSelect'); populate('teamAwaySelect');
            }
            
            const allLeagues = [...new Set([...normalizedHistorical.map(x=>x.league), ...normalizedFuture.map(x=>x.league)])].sort();
            const lgSel = document.getElementById('leagueSelect'); lgSel.innerHTML='<option value="all">Todas</option>';
            allLeagues.forEach(l=>lgSel.add(new Option(l,l)));

            document.getElementById('historicalAnalysis').style.display = normalizedHistorical.length > 0 ? 'block' : 'none';

            document.getElementById('loadingOverlay').style.display='none';
            
            if (normalizedFuture.length > 0 && currentStats) {
                futureData = normalizedFuture; 
                runAnalysis();
            } else if (normalizedHistorical.length > 0) {
                runHistoricalBacktest(normalizedHistorical);
                updateGlobalUI(0, 0, 0, []); 
            }
        }
        
        function updateHistoricalFileList(matchCount) {
            const listEl = document.getElementById('historicalFileList');
            const fileCountEl = document.getElementById('histFileCount');
            const matchCountEl = document.getElementById('histMatchCount');
            
            fileCountEl.innerText = historicalFileNames.length;
            matchCountEl.innerText = matchCount;

            if (historicalFileNames.length === 0) {
                listEl.innerHTML = 'No hay archivos de historial cargados.';
                return;
            }
            listEl.innerHTML = historicalFileNames.map(name => 
                `<div class="file-list-item"><i class="fas fa-check-circle" style="color:var(--success);"></i> ${name}</div>`
            ).join('');
        }
        
        function calculateLeagueHAD(data) {
             const leagueTotals = {};
            const minMatches = 15; 
            let globalHomeGoals = 0;
            let globalMatches = 0;

            data.forEach(r => {
                const league = r.league;
                if (!leagueTotals[league]) {
                    leagueTotals[league] = { totalMatches: 0, totalHomeGoals: 0, expectedHomeGoals: 0, leagueGames: [] };
                }
                leagueTotals[league].leagueGames.push(r);
                globalHomeGoals += r.goalsH;
                globalMatches++;
            });
            
            if (globalMatches === 0) return {};
            const initialGlobalStats = calculateCurrentSeasonStats(data, 1.0); 
            if (!initialGlobalStats) return {};

            for (const league in leagueTotals) {
                const games = leagueTotals[league].leagueGames;
                let sumExpectedGoals = 0;

                games.forEach(r => {
                    const homeCoeffs = initialGlobalStats.teamCoeffs[r.home];
                    const awayCoeffs = initialGlobalStats.teamCoeffs[r.away];

                    if (homeCoeffs && awayCoeffs) {
                        const lambdaH_initial = homeCoeffs.attH_factor * awayCoeffs.defA_factor * initialGlobalStats.globalAverages.avgGoalsHome;
                        sumExpectedGoals += lambdaH_initial;
                    }
                    leagueTotals[league].totalMatches++;
                    leagueTotals[league].totalHomeGoals += r.goalsH;
                });
                
                leagueTotals[league].expectedHomeGoals = sumExpectedGoals;

                if (leagueTotals[league].totalMatches >= minMatches && sumExpectedGoals > 0) {
                    const actualHomeAvg = leagueTotals[league].totalHomeGoals / leagueTotals[league].totalMatches;
                    const expectedHomeAvg = leagueTotals[league].expectedHomeGoals / leagueTotals[league].totalMatches;
                    
                    let hadFactor = actualHomeAvg / expectedHomeAvg;
                    hadFactor = Math.max(0.8, Math.min(1.5, hadFactor)); 

                    leagueHADFactors[league] = {
                        factor: hadFactor, matches: leagueTotals[league].totalMatches, correction: `x${hadFactor.toFixed(3)}`
                    };
                }
            }

            const globalActualHomeAvg = globalHomeGoals / globalMatches;
            const globalExpectedHomeAvg = Object.values(leagueTotals).reduce((sum, l) => sum + l.expectedHomeGoals, 0) / globalMatches;
            let globalHADFactor = (globalExpectedHomeAvg > 0) ? (globalActualHomeAvg / globalExpectedHomeAvg) : 1.0;
            globalHADFactor = Math.max(0.8, Math.min(1.5, globalHADFactor)); 

            leagueHADFactors['GLOBAL'] = {
                factor: globalHADFactor, matches: globalMatches, correction: `x${globalHADFactor.toFixed(3)}`
            };
            
            return leagueHADFactors;
        }

        function calculateCurrentSeasonStats(data, decayOverride = null) {
            const teamStats = {};
            let totalMatchesWeighted = 0;
            let totalHomeGoalsWeighted = 0;
            let totalAwayGoalsWeighted = 0;
            const numMatches = data.length;

            data.forEach((r, index) => {
                if(r.goalsH >= 0 && r.goalsA >= 0) {
                    const decayFactor = decayOverride !== null ? decayOverride : (0.75 + (index / numMatches) * 0.25); 

                    totalMatchesWeighted += decayFactor;
                    totalHomeGoalsWeighted += r.goalsH * decayFactor;
                    totalAwayGoalsWeighted += r.goalsA * decayFactor;

                    const updateStats = (team, goalsScored, goalsConceded, isHome) => {
                        if (!teamStats[team]) { teamStats[team] = { playedH: 0, scoredH: 0, concededH: 0, playedA: 0, scoredA: 0, concededA: 0, gd: 0, weightH: 0, weightA: 0 };}
                        teamStats[team].gd += goalsScored - goalsConceded;
                        
                        if (isHome) {
                            teamStats[team].playedH++; teamStats[team].scoredH += goalsScored * decayFactor;
                            teamStats[team].concededH += goalsConceded * decayFactor; teamStats[team].weightH += decayFactor;
                        } else {
                            teamStats[team].playedA++; teamStats[team].scoredA += goalsScored * decayFactor;
                            teamStats[team].concededA += goalsConceded * decayFactor; teamStats[team].weightA += decayFactor;
                        }
                    };
                    updateStats(r.home, r.goalsH, r.goalsA, true);
                    updateStats(r.away, r.goalsA, r.goalsH, false);
                }
            });
            
            if (totalMatchesWeighted === 0) return null;

            const avgGoalsHome = totalHomeGoalsWeighted / totalMatchesWeighted;
            const avgGoalsAway = totalAwayGoalsWeighted / totalMatchesWeighted;

            const teamCoeffs = {};
            for (const team in teamStats) {
                const stats = teamStats[team];
                
                const calculateFactor = (weightedGoals, totalWeight, avgGlobalGoals) => {
                    if (totalWeight < 1 || avgGlobalGoals <= 0.001) return 1.0; 
                    return (weightedGoals / totalWeight) / avgGlobalGoals;
                };

                const attH_factor = calculateFactor(stats.scoredH, stats.weightH, avgGoalsHome);
                const defH_factor = calculateFactor(stats.concededH, stats.weightH, avgGoalsAway);
                const attA_factor = calculateFactor(stats.scoredA, stats.weightA, avgGoalsAway);
                const defA_factor = calculateFactor(stats.concededA, stats.weightA, avgGoalsHome); 

                let powerFactor = 1.0;
                if (stats.playedH + stats.playedA >= 5) {
                    const gdPower = stats.gd / (stats.playedH + stats.playedA);
                    powerFactor = 1 + (gdPower * 0.05); 
                }
                
                teamCoeffs[team] = { 
                    attH_factor, defH_factor, attA_factor, defA_factor,
                    playedH: stats.playedH, playedA: stats.playedA,
                    powerFactor: Math.max(0.5, Math.min(1.5, powerFactor)) 
                };
            }

            return {
                globalAverages: { avgGoalsHome, avgGoalsAway, totalMatches: totalMatchesWeighted }, 
                teamCoeffs: teamCoeffs
            };
        }
        
        function calculateHybridProbabilities(homeTeam, awayTeam, league, stats, hadFactors) {
            if (!stats) return null;
            const { globalAverages, teamCoeffs } = stats;
            const homeCoeffs = teamCoeffs[homeTeam];
            const awayCoeffs = teamCoeffs[awayTeam];
            
            if (!homeCoeffs || !awayCoeffs) return null;

            let hadFactor = 1.0;
            if (hadFactors[league] && hadFactors[league].matches >= 15) {
                hadFactor = hadFactors[league].factor;
            } else if (hadFactors['GLOBAL']) {
                hadFactor = hadFactors['GLOBAL'].factor;
            }

            const lambdaH = homeCoeffs.attH_factor * awayCoeffs.defA_factor * globalAverages.avgGoalsHome * hadFactor;
            const lambdaA = awayCoeffs.attA_factor * homeCoeffs.defH_factor * globalAverages.avgGoalsAway;

            const maxGoals = 5; 
            let pHomeRaw = 0, pDrawRaw = 0, pAwayRaw = 0;
            
            for (let h = 0; h <= maxGoals; h++) {
                for (let a = 0; a <= maxGoals; a++) {
                    const p = poisson(lambdaH, h) * poisson(lambdaA, a);
                    if (h > a) pHomeRaw += p;
                    else if (h < a) pAwayRaw += p;
                    else pDrawRaw += p;
                }
            }
            const sumRaw = pHomeRaw + pDrawRaw + pAwayRaw;
            
            let pHome = pHomeRaw / sumRaw;
            let pDraw = pDrawRaw / sumRaw;
            let pAway = pAwayRaw / sumRaw;
            
            const powerH = homeCoeffs.powerFactor || 1.0;
            const powerA = awayCoeffs.powerFactor || 1.0;
            
            pHome *= powerH; pAway *= powerA;
            
            let sum1X2 = pHome + pDraw + pAway;
            if (sum1X2 === 0) sum1X2 = 1; 

            pHome /= sum1X2; pDraw /= sum1X2; pAway /= sum1X2;
            
            let pUnder25 = 0;
            for (let h = 0; h <= 2; h++) {
                for (let a = 0; a <= 2; a++) {
                    if (h + a < 3) { pUnder25 += poisson(lambdaH, h) * poisson(lambdaA, a); }
                }
            }
            const pOver25 = 1 - pUnder25;
            
            return {
                pHome, pDraw, pAway, pOver25, pUnder25,
                lambdaH, lambdaA, hadFactor: hadFactor
            };
        }
        
        // --- FUNCI√ìN PRINCIPAL DE FILTRADO DE VALOR (EV+) ---
        function runAnalysis() {
            document.getElementById('sidebar').classList.remove('open');
            
            if(!futureData.length || !currentStats) {
                document.getElementById('statsCard').style.display = 'block';
                const histData = normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null);
                
                if (histData.length === 0) { document.getElementById('statsCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">Cargue la **estad√≠stica pasada** (con goles) para calcular el modelo.</h3>`; } 
                else if (futureData.length === 0) { document.getElementById('statsCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">Cargue los **partidos a analizar** (con cuotas).</h3>`; }
                
                if(histData.length > 0) runHistoricalBacktest(histData);
                return;
            }
            
            document.getElementById('loadingMessage').innerText = "Filtrando Oportunidades de Valor Esperado (EV+) y Calculando Stake...";
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            const mktFilter = document.getElementById('marketSelect').value;
            const useValueFilter = document.getElementById('useFrequencyValue').checked; 
            const stT = document.getElementById('stakeType').value;
            const stV = parseFloat(document.getElementById('stakeValue').value);
            const bank0 = getBankValue(); // Usar la banca actual
            const minO = parseFloat(document.getElementById('minOdds').value);
            const maxO = parseFloat(document.getElementById('maxOdds').value); 
            const minEV = parseFloat(document.getElementById('minEV').value) / 100; 
            const lg = document.getElementById('leagueSelect').value;
            
            valueBetsResults = []; 
            let totalAnalyzed = 0;
            let maxEV = 0;

            const filteredFutureData = futureData.filter(r => lg==='all' || r.league===lg);
            const marketsToAnalyze = mktFilter === 'all' ? ['H', 'D', 'A', 'O25', 'U25'] : [mktFilter];

            filteredFutureData.forEach(r => {
                totalAnalyzed++;
                
                const hybridRes = calculateHybridProbabilities(r.home, r.away, r.league, currentStats, leagueHADFactors);
                if (!hybridRes) return; 

                marketsToAnalyze.forEach(mkt => {
                    let pModel, oddsH, label;
                    if(mkt==='H') { pModel=hybridRes.pHome; oddsH=r.oddsH; label='Local (1)'; }
                    else if(mkt==='D') { pModel=hybridRes.pDraw; oddsH=r.oddsD; label='Empate (X)'; }
                    else if(mkt==='A') { pModel=hybridRes.pAway; oddsH=r.oddsA; label='Visita (2)'; }
                    else if(mkt==='O25') { pModel=hybridRes.pOver25; oddsH=r.oddsO25; label='Over 2.5'; }
                    else if(mkt==='U25') { pModel=hybridRes.pUnder25; oddsH=r.oddsU25; label='Under 2.5'; }
                    else return;

                    const oddsFair = pModel > 0 ? (1 / pModel) : 0;
                    
                    if (oddsH < minO || oddsH > maxO || oddsFair === 0) return; 
                    if (oddsH <= oddsFair) return; 

                    const edge = (pModel * oddsH) - 1; 
                    const EV_percent = edge * 100;
                    const isValueBet = edge > minEV;
                    
                    if (useValueFilter && !isValueBet) return;
                    
                    if (EV_percent > maxEV) maxEV = EV_percent;

                    let actualStake = 0;
                    if (stT === 'flat') {
                        actualStake = stV;
                    } else if (stT === 'percent') {
                        actualStake = bank0 * (stV / 100);
                    } else if (stT === 'kelly') {
                        const kellyDenominator = stV;
                        let kellyFraction = calculateKellyStake(pModel, oddsH, kellyDenominator);
                        kellyFraction = Math.min(kellyFraction, 0.10); 
                        actualStake = bank0 * kellyFraction;
                    }

                    actualStake = Math.max(0.01, actualStake); 
                    actualStake = parseFloat(actualStake.toFixed(2));
                    
                    // Comprobaci√≥n para evitar duplicados en la lista de resultados de valor (aunque no es estrictamente necesario, previene errores)
                    const isAlreadyPlaced = placedBets.some(b => 
                        b.match === `${r.home} vs ${r.away}` && 
                        b.market === mkt && 
                        b.date === r.date
                    );

                    valueBetsResults.push({
                        date: r.date,
                        league: r.league, 
                        match: `${r.home} vs ${r.away}`,
                        market: mkt,
                        marketLabel: label,
                        odds: oddsH,
                        oddsFair: oddsFair,
                        EV: EV_percent,
                        stake: actualStake,
                        isPlaced: isAlreadyPlaced 
                    });
                });
            });

            if (historicalData.length > 0) {
                runHistoricalBacktest(normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null));
            }
            
            updateGlobalUI(totalAnalyzed, valueBetsResults.length, maxEV, valueBetsResults);
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // --- L√ìGICA DE REGISTRO PERSISTENTE (localStorage) ---
        
        function getBankValue() {
             const bankInput = parseFloat(document.getElementById('initialBank').value);
             const resolvedProfit = placedBets.filter(b => b.result !== 'PENDIENTE').reduce((sum, b) => sum + b.profit, 0);
             return bankInput + resolvedProfit;
        }

        function loadPlacedBets() {
            try {
                const storedBets = localStorage.getItem('placedBets');
                placedBets = storedBets ? JSON.parse(storedBets) : [];
                updatePlacedBetsUI();
            } catch (e) {
                console.error("Error cargando apuestas de localStorage", e);
                placedBets = [];
            }
        }

        function savePlacedBets() {
            try {
                localStorage.setItem('placedBets', JSON.stringify(placedBets));
                updatePlacedBetsUI();
            } catch (e) {
                console.error("Error guardando apuestas en localStorage", e);
                alert("No se pudieron guardar los datos. El almacenamiento local puede estar lleno.");
            }
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }

        function addBetToRegistry(betData) {
            const exists = placedBets.some(b => 
                b.match === betData.match && 
                b.market === betData.market && 
                b.date === betData.date
            );

            if (exists) {
                alert(`La apuesta ${betData.marketLabel} en ${betData.match} ya est√° registrada.`);
                return;
            }

            const newBet = {
                id: generateUniqueId(),
                ...betData,
                result: 'PENDIENTE', 
                profit: 0.00
            };
            
            placedBets.push(newBet);
            savePlacedBets();
            
            // Refrescar la tabla de ValueBets para mostrar 'Registrada'
            const index = valueBetsResults.findIndex(b => 
                b.match === betData.match && 
                b.market === betData.market
            );
            if(index !== -1) {
                valueBetsResults[index].isPlaced = true;
                updateGlobalUI(valueBetsResults.length, valueBetsResults.length, parseFloat(document.getElementById('valMaxEV').innerText), valueBetsResults);
            }
        }

        function updateBetResult(id, result) {
            const index = placedBets.findIndex(b => b.id === id);
            if (index === -1) return;

            const bet = placedBets[index];
            const stake = bet.stake;
            const odds = bet.odds;
            let profit = 0;

            if (result === 'WIN') {
                profit = stake * odds - stake; 
            } else if (result === 'LOSE') {
                profit = -stake; 
            } else if (result === 'PUSH') {
                profit = 0; 
            } else {
                result = 'PENDIENTE';
                profit = 0;
            }
            
            bet.result = result;
            bet.profit = parseFloat(profit.toFixed(2));
            
            savePlacedBets();
        }

        function updatePlacedBetsUI() {
            const tbody = document.getElementById('placedBetsTableBody');
            tbody.innerHTML = '';
            
            placedBets.sort((a, b) => a.date.localeCompare(b.date));

            let totalWagered = 0;
            let totalProfit = 0;
            let resolvedCount = 0;

            placedBets.forEach(b => {
                const statusClass = b.result === 'WIN' ? 'status-win' : (b.result === 'LOSE' ? 'status-lose' : (b.result === 'PUSH' ? 'status-push' : 'status-pending'));
                const profitClass = b.profit > 0 ? 'text-green' : (b.profit < 0 ? 'text-red' : 'text-secondary');
                
                if (b.result !== 'PENDIENTE') {
                    totalWagered += b.stake;
                    totalProfit += b.profit;
                    resolvedCount++;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${b.id.substring(4,8)}</td>
                        <td>${b.date.substring(5)}</td>
                        <td>${b.match} (${b.marketLabel})</td>
                        <td>${b.odds.toFixed(2)} (${b.EV.toFixed(2)}%)</td>
                        <td>${b.stake.toFixed(2)}</td>
                        <td class="${profitClass}">${b.profit.toFixed(2)}</td>
                        <td>
                            <span class="${statusClass}">${b.result}</span>
                            <div style="display:flex; gap:3px; margin-top:3px; justify-content:flex-start;">
                                <button class="btn-status btn-win" onclick="updateBetResult('${b.id}', 'WIN')">W</button>
                                <button class="btn-status btn-lose" onclick="updateBetResult('${b.id}', 'LOSE')">L</button>
                                <button class="btn-status btn-push" onclick="updateBetResult('${b.id}', 'PUSH')">P</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            // Actualizar KPIs de Banca y Profit
            const currentBank = getBankValue();
            const avgYield = totalWagered > 0 ? (totalProfit / totalWagered) * 100 : 0;

            document.getElementById('currentBankValue').innerText = currentBank.toFixed(2);
            document.getElementById('currentBankValue').className = `kpi-value ${currentBank > getInitialBank() ? 'text-green' : 'text-red'}`;
            
            document.getElementById('totalProfitValue').innerText = totalProfit.toFixed(2);
            document.getElementById('totalProfitValue').className = `kpi-value ${totalProfit > 0 ? 'text-green' : (totalProfit < 0 ? 'text-red' : 'text-blue')}`;

            document.getElementById('avgYieldValue').innerText = avgYield.toFixed(2) + '%';
            document.getElementById('avgYieldValue').className = `kpi-value ${avgYield > 0 ? 'text-green' : (avgYield < 0 ? 'text-red' : 'text-orange')}`;
            
            document.getElementById('resolvedBetsCount').innerText = resolvedCount;
            document.getElementById('bankLabel').innerText = currentBank.toFixed(2);
        }

        function clearPlacedBets() {
            if (confirm("¬øEst√°s seguro de que quieres borrar **TODO** el historial de apuestas registradas? Esto no se puede deshacer.")) {
                localStorage.removeItem('placedBets');
                placedBets = [];
                updatePlacedBetsUI();
                // Si el an√°lisis de futuros estaba corriendo, refrescar la UI
                if(futureData.length > 0) runAnalysis();
            }
        }
        
        function getInitialBank() {
            return parseFloat(document.getElementById('initialBank').value);
        }

        // --- FUNCIONES DE DESCARGA y UI ---
        function downloadValueBets() {
            if (valueBetsResults.length === 0) {
                alert("No hay oportunidades de valor (EV+) para descargar.");
                return;
            }

            const csvData = valueBetsResults.map(b => ({
                Fecha: b.date, Liga: b.league, Partido: b.match, Mercado: b.marketLabel,
                'Cuota_Tomada': b.odds.toFixed(2),
                'Cuota_Justa_(Modelo)': b.oddsFair.toFixed(2),
                'EV_Porcentaje': `+${b.EV.toFixed(2)}%`,
                'Stake_Monto': b.stake.toFixed(2)
            }));
            
            const csv = Papa.unparse(csvData, { header: true, delimiter: "," });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, ''); 
            a.setAttribute('href', url);
            a.setAttribute('download', `ValueBets_${today}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function updateGlobalUI(totalAnalyzed, evPlusCount, maxEV, results) { 
            document.getElementById('valBets').innerText = totalAnalyzed;
            document.getElementById('valEVPlus').innerText = evPlusCount;
            document.getElementById('valMaxEV').innerText = maxEV.toFixed(2) + '%'; 

            document.getElementById('valMaxEV').className = `kpi-value ${maxEV>=5?'text-green':'text-blue'}`;

            const tbVB = document.getElementById('valueBetsTableBody'); tbVB.innerHTML='';
            
            document.getElementById('valueBetsSection').style.display = (results.length > 0) ? 'block' : 'none';

            results.sort((a, b) => {
                if (a.date < b.date) return -1;
                if (a.date > b.date) return 1;
                return b.EV - a.EV;
            });

            results.forEach(b => {
                const evClass = b.EV >= 5.0 ? 'text-green' : (b.EV >= 0.01 ? 'text-warning' : 'text-secondary');
                const marketClass = `market-${b.market.replace(/[^HD A OU]/g, '')}`; 
                const dateDisplay = b.date ? b.date.substring(5) : 'N/A'; 
                
                // Sanitizar y serializar el objeto para pasarlo a la funci√≥n JS en el HTML
                const betDataString = JSON.stringify(b).replace(/"/g, "'");

                const actionButton = b.isPlaced ? 
                    `<button class="btn btn-secondary" style="background:var(--success); color:black; padding: 4px 8px; font-size: 0.75rem; white-space:nowrap;" disabled><i class="fas fa-check"></i> Registrada</button>` :
                    `<button class="btn btn-secondary" style="background:var(--accent); color:black; padding: 4px 8px; font-size: 0.75rem; white-space:nowrap;" onclick="addBetToRegistry(${betDataString})"><i class="fas fa-plus"></i> Registrar Apuesta</button>`;
                
                tbVB.innerHTML += `
                    <tr class="${marketClass}">
                        <td style="font-weight:bold;">${dateDisplay}</td>
                        <td style="text-align:left;">${b.match}</td>
                        <td style="font-weight:bold;">${b.marketLabel}</td>
                        <td>${b.odds.toFixed(2)}</td>
                        <td>${b.oddsFair.toFixed(2)}</td> 
                        <td class="${evClass}" style="font-weight:bold;">+${b.EV.toFixed(2)}%</td>
                        <td>${b.stake.toFixed(2)}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
            });
        }
        
        function updateHADTable(hadFactors) {
            const tbHAD = document.getElementById('hadTableBody'); tbHAD.innerHTML='';
            Object.entries(hadFactors)
                .sort(([, a], [, b]) => b.matches - a.matches)
                .forEach(([league, data]) => {
                
                const factorClass = data.factor > 1.05 ? 'text-green' : (data.factor < 0.95 ? 'text-red' : 'text-secondary');
                
                tbHAD.innerHTML += `
                    <tr>
                        <td style="text-align:left; font-weight:bold; color:white;">${league}</td>
                        <td>${data.matches}</td>
                        <td class="${factorClass}">${data.factor.toFixed(3)}</td>
                        <td>${data.correction}</td>
                    </tr>
                `;
            });
        }

        // --- Funciones de An√°lisis Manual y Backtest (COMPLETAS) ---
        
        function analyzeMatchup() {
            const homeTeam = document.getElementById('teamHomeSelect').value;
            const awayTeam = document.getElementById('teamAwaySelect').value;
            const league = document.getElementById('leagueSelect').value;
            const statsCard = document.getElementById('statsCard');
            statsCard.style.display = 'block';

            if (!currentStats || !homeTeam || !awayTeam) {
                statsCard.innerHTML = `<h3 style="color:var(--danger); margin:0;">Selecciona ambos equipos y aseg√∫rate de que el Historial est√° cargado.</h3>`;
                return;
            }
            
            const teamStats = currentStats.teamCoeffs;
            if (!teamStats[homeTeam] || !teamStats[awayTeam]) {
                statsCard.innerHTML = `<h3 style="color:var(--danger); margin:0;">Datos insuficientes: No se encontraron estad√≠sticas para uno o ambos equipos.</h3>`;
                return;
            }

            const coeffsH = teamStats[homeTeam];
            const coeffsA = teamStats[awayTeam];
            
            const hybridRes = calculateHybridProbabilities(homeTeam, awayTeam, league, currentStats, leagueHADFactors);

            if (!hybridRes) {
                 statsCard.innerHTML = `<h3 style="color:var(--danger); margin:0;">No se pudo calcular el modelo Poisson h√≠brido.</h3>`;
                 return;
            }

            const { pHome, pDraw, pAway, pOver25, pUnder25, lambdaH, lambdaA, hadFactor } = hybridRes;
            const sumProbs = pHome + pDraw + pAway;

            statsCard.innerHTML = `
                <h3 style="color:var(--stats-accent); margin-top:0;">Edge y Coeficientes para ${homeTeam} vs ${awayTeam}</h3>
                <div style="display:flex; justify-content:space-around; gap:10px;">
                    <div style="flex:1;">
                        <h4 style="margin:0; font-size:1rem; color:var(--text-secondary);">Coeficientes de Poder</h4>
                        <p style="margin:5px 0 0 0; font-weight:bold;">${homeTeam} (Local):</p>
                        <ul style="list-style:none; padding-left:15px; font-size:0.9em; margin-top:3px;">
                            <li>Ataque: ${coeffsH.attH_factor.toFixed(3)}</li>
                            <li>Defensa: ${coeffsH.defH_factor.toFixed(3)}</li>
                            <li>Ajuste HAD: x${hadFactor.toFixed(3)}</li>
                        </ul>
                        <p style="margin:5px 0 0 0; font-weight:bold;">${awayTeam} (Visita):</p>
                        <ul style="list-style:none; padding-left:15px; font-size:0.9em; margin-top:3px;">
                            <li>Ataque: ${coeffsA.attA_factor.toFixed(3)}</li>
                            <li>Defensa: ${coeffsA.defA_factor.toFixed(3)}</li>
                        </ul>
                    </div>
                    <div style="flex:1;">
                         <h4 style="margin:0; font-size:1rem; color:var(--text-secondary);">Goles Esperados $(\\lambda)$</h4>
                         <p style="margin:5px 0 0 0; font-weight:bold;">Goles Locales: <span style="color:var(--accent);">${lambdaH.toFixed(2)}</span></p>
                         <p style="margin:5px 0 0 0; font-weight:bold;">Goles Visita: <span style="color:var(--accent);">${lambdaA.toFixed(2)}</span></p>
                    </div>
                    <div style="flex:1;">
                        <h4 style="margin:0; font-size:1rem; color:var(--text-secondary);">Probabilidades (Modelo)</h4>
                        <p style="margin:5px 0 0 0; font-weight:bold;">1 (Local): <span style="color:var(--success);">${(pHome*100).toFixed(2)}%</span> / Cuota Justa: <span style="color:var(--accent);">${(1/pHome).toFixed(2)}</span></p>
                        <p style="margin:5px 0 0 0; font-weight:bold;">X (Empate): <span style="color:var(--success);">${(pDraw*100).toFixed(2)}%</span> / Cuota Justa: <span style="color:var(--accent);">${(1/pDraw).toFixed(2)}</span></p>
                        <p style="margin:5px 0 0 0; font-weight:bold;">2 (Visita): <span style="color:var(--success);">${(pAway*100).toFixed(2)}%</span> / Cuota Justa: <span style="color:var(--accent);">${(1/pAway).toFixed(2)}</span></p>
                        <p style="margin:5px 0 0 0; font-weight:bold;">Over 2.5: <span style="color:var(--success);">${(pOver25*100).toFixed(2)}%</span></p>
                        <p style="margin:5px 0 0 0; font-weight:bold;">Under 2.5: <span style="color:var(--success);">${(pUnder25*100).toFixed(2)}%</span></p>
                    </div>
                </div>
            `;
        }

        function runHistoricalBacktest(data) {
            const bank0 = getInitialBank();
            const minEV = 0.05; // M√≠nimo 5% de EV para apostar
            const kellyFactor = 33; // K=33 (1/3 de Kelly)
            
            let bank = bank0;
            let maxBank = bank0;
            let profit = 0;
            let totalWagered = 0;
            let resolvedBets = 0;
            
            const equityHistory = [{x: 'Inicio', y: bank0}];
            const drawdownHistory = [{x: 'Inicio', y: 0}];
            const leagueProfit = {};

            data.forEach((r, index) => {
                if (index % 100 === 0) { 
                    currentStats = calculateCurrentSeasonStats(data.slice(0, index + 1));
                    if (!currentStats) return;
                }
                
                if (!currentStats || !r.oddsH || r.oddsH < 1.01) return;

                const hybridRes = calculateHybridProbabilities(r.home, r.away, r.league, currentStats, leagueHADFactors);
                if (!hybridRes) return;

                const markets = [
                    {mkt: 'H', odds: r.oddsH, pModel: hybridRes.pHome, result: r.goalsH > r.goalsA},
                    {mkt: 'D', odds: r.oddsD, pModel: hybridRes.pDraw, result: r.goalsH === r.goalsA},
                    {mkt: 'A', odds: r.oddsA, pModel: hybridRes.pAway, result: r.goalsH < r.goalsA},
                    {mkt: 'O25', odds: r.oddsO25, pModel: hybridRes.pOver25, result: (r.goalsH + r.goalsA) > 2},
                    {mkt: 'U25', odds: r.oddsU25, pModel: hybridRes.pUnder25, result: (r.goalsH + r.goalsA) < 3}
                ].filter(m => m.odds > 1.01 && m.pModel > 0);

                markets.forEach(m => {
                    const edge = (m.pModel * m.odds) - 1;
                    if (edge > minEV) {
                        const kellyFraction = calculateKellyStake(m.pModel, m.odds, kellyFactor);
                        const stake = bank * kellyFraction;
                        
                        if (stake > 0.01) {
                            resolvedBets++;
                            totalWagered += stake;
                            let betProfit = 0;

                            if (m.result) {
                                betProfit = stake * m.odds - stake;
                            } else {
                                betProfit = -stake;
                            }
                            
                            bank += betProfit;
                            profit += betProfit;

                            if (!leagueProfit[r.league]) leagueProfit[r.league] = 0;
                            leagueProfit[r.league] += betProfit;

                            maxBank = Math.max(maxBank, bank);
                        }
                    }
                });

                if (resolvedBets > 0 && index % 10 === 0) { 
                    const drawdown = (maxBank - bank) / maxBank;
                    equityHistory.push({x: r.date, y: bank.toFixed(2)});
                    drawdownHistory.push({x: r.date, y: (drawdown * 100).toFixed(2)});
                }
            });
            
            // Stats para la tarjeta de resumen
            const totalReturn = profit;
            const totalYield = totalWagered > 0 ? (totalReturn / totalWagered) * 100 : 0;
            const finalBank = bank;

            const finalStatsHTML = `
                <h3 style="color:var(--stats-accent); margin-top:0;">Resultados del Backtest Hist√≥rico (${resolvedBets} Apuestas EV+ Simuladas)</h3>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
                    <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                        <div class="kpi-title">Banca Final</div>
                        <div class="kpi-value ${finalBank > bank0 ? 'text-green' : 'text-red'}">${finalBank.toFixed(2)}</div>
                    </div>
                    <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                        <div class="kpi-title">Profit Total</div>
                        <div class="kpi-value ${totalReturn > 0 ? 'text-green' : 'text-red'}">${totalReturn.toFixed(2)}</div>
                    </div>
                    <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                        <div class="kpi-title">Yield Promedio</div>
                        <div class="kpi-value ${totalYield > 0 ? 'text-green' : 'text-red'}">${totalYield.toFixed(2)}%</div>
                    </div>
                    <div class="kpi-card" style="border-color:var(--accent); min-width:auto;">
                        <div class="kpi-title">Apuestas Resueltas</div>
                        <div class="kpi-value">${resolvedBets}</div>
                    </div>
                </div>
            `;
            document.getElementById('statsCard').style.display = 'block';
            document.getElementById('statsCard').innerHTML = finalStatsHTML;
            
            renderCharts(equityHistory, drawdownHistory, leagueProfit);
        }

        // --- Funciones de Gr√°ficos ---

        function getChartOptions(title, yMin=undefined, color='var(--accent)', bgColor='rgba(245, 158, 11, 0.1)') {
            return {
                responsive:true, maintainAspectRatio:false, 
                plugins:{legend:{display:false}, title:{display:true, text:title, color:'white', font:{size:14, weight:'600'}}}, 
                scales:{x:{display:false},y:{min:yMin, grid:{color:'#334155'}, ticks:{color:'white'}}},
                elements: { line: { borderColor: color, borderWidth: 2 }, point: { radius: 0 } },
                datasets: { line: { fill: true, backgroundColor: bgColor } }
            };
        }

        function renderCharts(hist, drawdownHist, lgData) {
            const ctxEq = document.getElementById('equityChart').getContext('2d');
            if(chartEq) chartEq.destroy();
            const pts = hist.length>800 ? hist.filter((_,i)=>i%5===0) : hist;
            chartEq = new Chart(ctxEq, { type:'line', data:{labels:pts.map(p=>p.x), datasets:[{label:'Banca', data:pts.map(p=>p.y)}]}, 
                options: getChartOptions('Evoluci√≥n de Banca (Backtest)')
            });

            const ctxDD = document.getElementById('drawdownChart').getContext('2d');
            if(chartDD) chartDD.destroy();
            const ddPts = drawdownHist.length>800 ? drawdownHist.filter((_,i)=>i%5===0) : drawdownHist;
            chartDD = new Chart(ctxDD, { type:'line', data:{labels:ddPts.map(p=>p.x), datasets:[{label:'Drawdown (%)', data:ddPts.map(p=>p.y)}]}, 
                options: getChartOptions('Drawdown M√°ximo (%)', 0, 'var(--danger)', 'rgba(239, 68, 68, 0.2)')
            });

            const ctxLg = document.getElementById('leagueChart').getContext('2d');
            if(chartLg) chartLg.destroy();
            const lgArr = Object.entries(lgData).sort((a,b)=>b[1]-a[1]).slice(0, 10);
                
            chartLg = new Chart(ctxLg, { 
                type:'bar', 
                data:{
                    labels:lgArr.map(x=>x[0]), 
                    datasets:[{
                        data:lgArr.map(x=>x[1]), 
                        backgroundColor:lgArr.map(x=>x[1]>=0?'var(--success)':'var(--danger)')
                    }]
                }, 
                options:{
                    responsive:true, maintainAspectRatio:false, indexAxis:'y', 
                    plugins:{legend:{display:false}, title:{display:true, text:'Profit por Liga (Backtest Top 10)', color:'white', font:{size:14, weight:'600'}}}, 
                    scales:{x:{grid:{color:'#334155'}, ticks:{color:'white'}}, y:{ticks:{color:'white'}}}
                }
            });
        }
        
        // Inicializar la interfaz al cargar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loadingOverlay').style.display = 'none';
            loadPlacedBets(); // Cargar el historial al iniciar
            document.getElementById('tabConfigBtn').click(); // Abrir la pesta√±a de configuraci√≥n
        });
        
    </script>
</body>
</html>

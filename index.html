<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Poisson xG Pro + Visual Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --text: #334155; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: var(--text); padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        textarea { width: 100%; height: 100px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 11px; resize: none; }
        .stats-bar { background: #f1f5f9; padding: 15px; border-radius: 8px; margin: 20px 0; display: flex; justify-content: space-around; font-weight: bold; font-size: 0.85rem; }
        select, button { padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; width: 100%; font-size: 1rem; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: 700; margin-top: 10px; }
        button:hover { background: #2563eb; }
        .result-box { margin-top: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; display: none; }
        .metric-val { font-size: 1.8rem; font-weight: 800; color: var(--accent); }
        .chart-container { margin-top: 20px; height: 300px; }
        h3 { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Análisis Poisson HT con Goles Esperados (xG)</h2>
    
    <div class="grid">
        <div>
            <label><b>1. Tabla Local (HOME)</b></label>
            <textarea id="rawHome" placeholder="Pega aquí la tabla AT HOME..."></textarea>
        </div>
        <div>
            <label><b>2. Tabla Visitante (AWAY)</b></label>
            <textarea id="rawAway" placeholder="Pega aquí la tabla AWAY..."></textarea>
        </div>
    </div>

    <button onclick="processLeague()" style="background: #64748b;">Analizar Tablas y Calcular Promedios Liga</button>

    <div id="leagueStats" class="stats-bar" style="display:none;">
        <span>Promedio Gol Local: <span id="avgG_H"></span></span>
        <span>Promedio Gol Visita: <span id="avgG_A"></span></span>
    </div>

    <div class="grid" style="margin: 20px 0;">
        <div>
            <label>Equipo Local</label>
            <select id="selHome"></select>
        </div>
        <div>
            <label>Equipo Visitante</label>
            <select id="selAway"></select>
        </div>
    </div>

    <button onclick="calculateXG()">Calcular xG y Probabilidades</button>

    <div id="results" class="result-box">
        <h3>Resultados para el 1er Tiempo (45 min)</h3>
        <div class="grid" style="text-align: center;">
            <div><div>Prob. Over 0.5 HT</div><div id="p05" class="metric-val"></div></div>
            <div><div>Prob. Over 1.5 HT</div><div id="p15" class="metric-val"></div></div>
        </div>

        <div class="chart-container">
            <canvas id="xgChart"></canvas>
        </div>
    </div>
</div>

<script>
let dbH = {}, dbA = {}, avgHomeG = 0, avgAwayG = 0, myChart = null;

function processData(text) {
    const teams = {};
    let totalG = 0, totalP = 0;
    text.split('\n').forEach(line => {
        const m = line.match(/([a-zA-Z\s.-]+?)\t?(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)/);
        if (m) {
            const name = m[1].trim();
            const gp = parseInt(m[2]), gf = parseInt(m[6]), ga = parseInt(m[7]);
            teams[name] = { gp, gf, ga, att: gf/gp, def: ga/gp };
            totalG += gf; totalP += gp;
        }
    });
    return { teams, avg: totalG / totalP };
}

function processLeague() {
    const resH = processData(document.getElementById('rawHome').value);
    const resA = processData(document.getElementById('rawAway').value);
    if(Object.keys(resH.teams).length === 0) return alert("Pega las tablas correctamente");
    
    dbH = resH.teams; dbA = resA.teams;
    avgHomeG = resH.avg; avgAwayG = resA.avg;

    document.getElementById('avgG_H').innerText = avgHomeG.toFixed(3);
    document.getElementById('avgG_A').innerText = avgAwayG.toFixed(3);
    document.getElementById('leagueStats').style.display = 'flex';

    fillSelect('selHome', dbH); fillSelect('selAway', dbA);
}

function fillSelect(id, data) {
    const s = document.getElementById(id); s.innerHTML = "";
    Object.keys(data).sort().forEach(t => s.innerHTML += `<option value="${t}">${t}</option>`);
}

function calculateXG() {
    const nameH = document.getElementById('selHome').value;
    const nameA = document.getElementById('selAway').value;
    const tH = dbH[nameH];
    const tA = dbA[nameA];

    // CÁLCULO DE FUERZA RELATIVA Y xG
    const xgH = (tH.att / avgHomeG) * (tA.def / avgAwayG) * avgHomeG;
    const xgA = (tA.att / avgAwayG) * (tH.def / avgHomeG) * avgAwayG;

    // POISSON PARA PROBABILIDADES
    const p0H = Math.exp(-xgH), p0A = Math.exp(-xgA);
    const p1H = xgH * Math.exp(-xgH), p1A = xgA * Math.exp(-xgA);

    const over05 = (1 - (p0H * p0A)) * 100;
    const over15 = (1 - ((p0H * p0A) + (p1H * p0A) + (p0H * p1A))) * 100;

    document.getElementById('results').style.display = 'block';
    document.getElementById('p05').innerText = over05.toFixed(1) + "%";
    document.getElementById('p15').innerText = over15.toFixed(1) + "%";

    updateChart(nameH, nameA, xgH, xgA);
}

function updateChart(h, a, vH, vA) {
    const ctx = document.getElementById('xgChart').getContext('2d');
    if (myChart) myChart.destroy();
    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [h, a],
            datasets: [{
                label: 'Goles Esperados (xG) HT',
                data: [vH.toFixed(2), vA.toFixed(2)],
                backgroundColor: ['#3b82f6', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, max: 2.5 } }
        }
    });
}
</script>
</body>
</html>

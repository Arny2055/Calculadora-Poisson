<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mantenimiento Automotriz ‚Äî Diagn√≥stico + Contramedidas Definitivas (CAPA / FMEA)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140; --focus:#b9ccff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(15,17,21,.95), rgba(15,17,21,.65));border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{margin:0 0 4px;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  button,.btn{background:var(--panel2);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  button:hover{border-color:var(--accent)}
  .btn-accent{background:var(--accent);color:#0b1020;border-color:transparent}
  .btn-ok{background:var(--ok);color:#0b1020;border-color:transparent}
  .btn-warn{background:var(--warn);color:#0b1020;border-color:transparent}
  .btn-danger{background:var(--danger);color:#0b1020;border-color:transparent}

  .layout{display:grid;grid-template-columns:310px 1fr;gap:16px;padding:16px}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}}

  aside,section.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  h2{margin:0 0 8px;font-size:18px}
  h3{margin:12px 0 6px;font-size:16px}
  .grid{display:grid;gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .grid.three{grid-template-columns:repeat(3,1fr)}
  @media (max-width:980px){.grid.two,.grid.three{grid-template-columns:1fr}}

  /* ===== FORM STYLES (arreglos) ===== */
  /* Aplica ancho 100% solo a inputs de texto/num/fecha, NO a checkboxes/radios/files */
  input:not([type="checkbox"]):not([type="radio"]):not([type="file"]),
  select, textarea{
    width:100%; padding:10px 12px; background:#0c0f18; color:var(--text);
    border:1px solid var(--border); border-radius:10px; outline:none;
  }
  /* Checkboxes y radios: tama√±o auto + foco visible */
  input[type="checkbox"], input[type="radio"]{
    width:auto; height:18px; min-width:18px; accent-color:var(--accent);
  }
  label{font-size:12px;color:var(--muted)}

  /* Contenedor de opciones tipo checklist (S√≠ntomas/Contexto) */
  .options{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (max-width:980px){.options{grid-template-columns:1fr}}
  .opt{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0c0f18}
  .opt span{color:var(--text);font-size:14px;line-height:1.2}
  .opt:hover{border-color:var(--focus)}
  /* √Årea t√°ctil mayor en m√≥vil */
  @media (hover:none){ .opt{padding:12px} input[type="checkbox"]{height:22px;min-width:22px} }

  .pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#101521;border:1px solid var(--border);color:var(--muted);font-size:12px}
  .badge{font-weight:800;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
  .ok{background:#102017;color:#b7ffcc} .warn{background:#261c09;color:#ffddaa} .danger{background:#281214;color:#ffbdbd}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;font-size:14px}
  th{background:#131824;color:var(--muted)}
  .row-actions{display:flex;gap:6px}
  footer{color:var(--muted);font-size:12px;padding:10px 16px 30px}
  .hint{color:var(--muted);font-size:12px}
  @media print{header,.toolbar,.no-print{display:none!important} body{background:#fff;color:#000}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Mantenimiento Automotriz ‚Äî Diagn√≥stico & Contramedidas Definitivas</h1>
    <div class="sub">Selecciona equipo ‚Üí s√≠ntomas ‚Üí motor de reglas propone acciones inmediatas, correctivas y definitivas + FMEA + CAPA/A3</div>
    <div class="toolbar">
      <button id="btnSave" class="btn-accent">üíæ Guardar local</button>
      <button id="btnLoad">üì• Cargar local</button>
      <button id="btnExport">‚¨áÔ∏è Exportar JSON</button>
      <label class="btn no-print" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
        üì§ Importar JSON
        <input id="fileImport" type="file" accept="application/json" style="display:none">
      </label>
      <button id="btnPrint" class="btn-warn">üñ®Ô∏è PDF</button>
      <button id="btnNew" class="btn-danger">üßπ Nuevo</button>
    </div>
  </div>
</header>

<div class="layout wrap">
  <aside>
    <h2>Configuraci√≥n del caso</h2>
    <div class="grid two">
      <div><label>T√≠tulo</label><input id="title" placeholder="Ej: Falsos en sensor robot spot #3"></div>
      <div><label>L√≠nea/Equipo</label><input id="area" placeholder="Body Shop / Robot R3"></div>
      <div><label>Fecha</label><input id="date" type="date"></div>
      <div><label>Turno</label><select id="shift"><option>D√≠a</option><option>Noche</option></select></div>
      <div><label>Impacto (min, scrap, riesgo)</label><input id="impact" placeholder="Paro 28 min, retrabajo 6 pzs"></div>
      <div><label>Responsable</label><input id="owner" placeholder="Jefe de Mantenimiento"></div>
    </div>

    <h3 style="margin-top:10px">Tipo de equipo</h3>
    <select id="asset">
      <option value="robot_soldadura">Robot soldadura por puntos</option>
      <option value="prensa_mecanica">Prensa mec√°nica/hidr√°ulica</option>
      <option value="soldadura_mig">Soldadura MIG/MAG</option>
      <option value="transportador">Transportador/Conveyor</option>
      <option value="vfd_plc">VFD / PLC / I/O</option>
      <option value="inyeccion">Inyecci√≥n pl√°stica</option>
      <option value="cnc">CNC / Mecanizado</option>
      <option value="compresor">Compresor de aire</option>
      <option value="hvac">HVAC/Horno</option>
      <option value="vision">Visi√≥n/sensores</option>
    </select>

    <h3 style="margin-top:10px">S√≠ntomas</h3>
    <div id="symptoms" class="options"></div>

    <h3 style="margin-top:10px">Contexto</h3>
    <div id="context" class="options"></div>

    <div style="margin-top:8px">
      <label>Descripci√≥n breve</label>
      <textarea id="desc" placeholder="¬øQu√© pas√≥? ¬øD√≥nde? ¬øCon qu√© frecuencia? Cambios recientes, clima, proveedor, setup, etc."></textarea>
    </div>
  </aside>

  <main>
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2>Motor de recomendaciones</h2>
        <div class="toolbar">
          <button id="btnSuggest" class="btn-ok">üß† Generar contramedidas</button>
        </div>
      </div>

      <div class="grid three" style="margin-top:6px">
        <div>
          <h3>Acciones inmediatas (contenci√≥n)</h3>
          <ul id="actInmediatas"></ul>
        </div>
        <div>
          <h3>Acciones correctivas (causa ra√≠z)</h3>
          <ul id="actCorrectivas"></ul>
        </div>
        <div>
          <h3>Contramedidas definitivas (permanentes)</h3>
          <ul id="actDefinitivas"></ul>
        </div>
      </div>

      <h3 style="margin-top:10px">Checklist de ejecuci√≥n</h3>
      <table id="checkTable">
        <thead><tr><th>Tarea</th><th>Responsable</th><th>Fecha</th><th>Estatus</th><th>Acc.</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="justify-content:flex-end;margin-top:6px">
        <button id="addCheck">‚ûï Agregar tarea</button>
        <button id="clearCheck">üßπ Limpiar</button>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Mini-FMEA (riesgo y acciones para bajar RPN)</h2>
      <div class="grid three">
        <div>
          <label>Modo de falla</label>
          <input id="fmeaMode" placeholder="Ej: Electrodo no cierra / falsos en sensor pieza">
        </div>
        <div>
          <label>Efecto</label>
          <input id="fmeaEffect" placeholder="Paro, retrabajo, calidad, seguridad">
        </div>
        <div>
          <label>Causa</label>
          <input id="fmeaCause" placeholder="Desalineo / EMI / desgaste / fuga">
        </div>
      </div>
      <div class="grid three" style="margin-top:6px">
        <div><label>Severidad (S 1‚Äì10)</label><input id="fmeaS" type="number" min="1" max="10" value="7"></div>
        <div><label>Ocurrencia (O 1‚Äì10)</label><input id="fmeaO" type="number" min="1" max="10" value="6"></div>
        <div><label>Detecci√≥n (D 1‚Äì10)</label><input id="fmeaD" type="number" min="1" max="10" value="6"></div>
      </div>
      <div style="margin-top:8px">
        <span id="rpnBadge" class="badge">RPN: ‚Äî</span>
      </div>
      <div class="grid two" style="margin-top:8px">
        <div>
          <h3>Sugerencias para bajar RPN</h3>
          <ul id="fmeaTips"></ul>
        </div>
        <div>
          <label>Acciones FMEA</label>
          <textarea id="fmeaActions" placeholder="Acciones para reducir S (dise√±o), O (proceso), D (detecci√≥n)‚Ä¶"></textarea>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Resultados r√°pidos (MTTR/MTBF)</h2>
      <div class="grid three">
        <div><label>Fallos en el periodo</label><input id="nFails" type="number" min="0" value="1"></div>
        <div><label>Horas de operaci√≥n</label><input id="opHours" type="number" min="0" value="160"></div>
        <div><label>Minutos totales de paro</label><input id="downMins" type="number" min="0" value="45"></div>
      </div>
      <div style="margin-top:8px">
        <span id="mttrBadge" class="badge">MTTR: ‚Äî</span>
        <span id="mtbfBadge" class="badge">MTBF: ‚Äî</span>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2>Resumen CAPA / A3</h2>
        <button id="btnResumen" class="btn">üìù Generar resumen</button>
      </div>
      <textarea id="resumen" style="min-height:240px" placeholder="Aqu√≠ ver√°s el resumen generado listo para tu sistema CAPA/A3"></textarea>
    </section>
  </main>
</div>

<footer class="wrap">
  Hecho para Mantenimiento (Automotriz). A√±ade tus equipos/reglas f√°cilmente en la secci√≥n de constantes del JS.
</footer>

<script>
  // ====== Datos base ======
  const stateKey='auto_maint_helper_v1';

  const SYMPTOMS = [
    {id:'no_detecta', label:'No detecta / sin se√±al'},
    {id:'intermitente', label:'Intermitente / falsos'},
    {id:'fuerza_baja', label:'Fuerza insuficiente (cilindro/prensa)'},
    {id:'carrera_incompleta', label:'Carrera incompleta / atoro'},
    {id:'fuga', label:'Fuga (aire/aceite)'},
    {id:'sobretemp', label:'Sobretemperatura'},
    {id:'sobreconsumo', label:'Sobrecorriente / sobreconsumo'},
    {id:'vibracion', label:'Vibraci√≥n / ruido anormal'},
    {id:'desalineo', label:'Desalineo / holgura'},
    {id:'fallo_io', label:'Fallo I/O PLC / comunicaci√≥n'},
    {id:'emi', label:'EMI / ruido el√©ctrico'},
    {id:'contaminacion', label:'Contaminaci√≥n (rebaba/aceite/agua)'},
    {id:'desgaste', label:'Desgaste consumible (electrodos/boquillas)'},
  ];

  const CONTEXT = [
    {id:'cambio_reciente', label:'Cambio reciente de componente/ajuste'},
    {id:'mantenimiento_reciente', label:'Mantenimiento reciente'},
    {id:'proveedor_nuevo', label:'Proveedor/material nuevo'},
    {id:'ambiente_humedo', label:'H√∫medo/lavado'},
    {id:'alta_temp', label:'Alta temperatura'},
    {id:'alta_vibracion', label:'Alta vibraci√≥n/golpes'},
    {id:'cables_potencia', label:'Cables potencia cercanos/VFD'},
    {id:'turno_noche', label:'Solo ocurre en noche'},
    {id:'post_setup', label:'Inmediatamente tras setup'},
  ];

  const RULES = [
    {
      asset:'robot_soldadura',
      ifAny:['intermitente','emi','fallo_io'],
      ctxAny:['cables_potencia','alta_vibracion','post_setup'],
      defScore:5,
      acciones:{
        inmediata:[
          'Revisar apriete y continuidad en pinzas/retorno; prueba de ciclo vac√≠o.',
          'Separar f√≠sicamente cable de se√±al del mazo de potencia; revisar conectores M12.',
        ],
        correctiva:[
          'A√±adir ferritas/filtros EMI en l√≠neas de se√±al; tierra √∫nica de celda.',
          'Actualizar par√°metros de debounce/antirrebote en PLC/robot.',
        ],
        definitiva:[
          'Re-ruteo de mazos: canaletas segregadas, cruces a 90¬∞, blindaje integral; ECR liberado.',
          'Implementar doble canal de verificaci√≥n de pieza (redundancia + validaci√≥n temporal).',
          'Estandarizar checklist EMC y torque de conectores; plan de auditor√≠a mensual.'
        ]
      }
    },
    {
      asset:'robot_soldadura',
      ifAny:['desgaste','fuerza_baja','carrera_incompleta'],
      ctxAny:['mantenimiento_reciente','post_setup'],
      defScore:4,
      acciones:{
        inmediata:[
          'Re-dress de cables y revisi√≥n de enfriamiento de brazos.',
          'Cambio de electrodos / ajuste de presi√≥n.',
        ],
        correctiva:[
          'Ajuste de servo/presi√≥n y recalibraci√≥n de cierre.',
          'Reemplazo de mangueras r√≠gidas por flexibles en zonas de giro.',
        ],
        definitiva:[
          'Estandarizar ciclo de re-dress y vida de consumibles (contador por piezas).',
          'Poka-yoke de montaje de electrodos (plantillas) y BOM con codificaci√≥n √∫nica.'
        ]
      }
    },
    {
      asset:'prensa_mecanica',
      ifAny:['fuga','fuerza_baja','vibracion'],
      ctxAny:['alta_vibracion'],
      defScore:5,
      acciones:{
        inmediata:[
          'Verificar niveles y fugas; apretar conexiones; paro seguro si hay riesgo.',
          'Medir presi√≥n/caudal; inspecci√≥n de v√°lvulas.',
        ],
        correctiva:[
          'Reemplazo de sellos/valvuler√≠a; limpieza de filtros; alineaci√≥n de gu√≠as.',
        ],
        definitiva:[
          'Upgrade de sellos (FKM/NBR) y filtraci√≥n fina; monitoreo de condici√≥n (presi√≥n/temp).',
          'Bloqueo de par√°metros cr√≠ticos y control de cambios mec√°nicos con plan de recalibraci√≥n.'
        ]
      }
    },
    {
      asset:'transportador',
      ifAny:['carrera_incompleta','sobreconsumo','vibracion'],
      ctxAny:['contaminacion','post_setup'],
      defScore:4,
      acciones:{
        inmediata:[
          'Limpiar y tensar banda/cadena; verificar poleas y seguridad.',
          'Medir corriente de motor y fricci√≥n anormal.',
        ],
        correctiva:[
          'Alineaci√≥n de cama/poleas; sustituci√≥n de rodillos da√±ados.',
        ],
        definitiva:[
          'Cambio a cojinetes sellados/auto-alineables; protector anti-rebaba debajo de retorno.',
          'Estandarizar tensi√≥n con dinam√≥metro y checklist por lote.'
        ]
      }
    },
    {
      asset:'vfd_plc',
      ifAny:['fallo_io','emi','intermitente','sobreconsumo'],
      ctxAny:['cables_potencia','post_setup','alta_vibracion'],
      defScore:5,
      acciones:{
        inmediata:[
          'Revisar tierra/PE y pantallas; separar rutas se√±al/potencia.',
          'Verificar par√°metros VFD (rampa, carrier) y filtros activos.',
        ],
        correctiva:[
          'Instalar filtros EMC (linea y motor), ferritas y reactores; revisar earthing √∫nico.',
        ],
        definitiva:[
          'Arquitectura de cableado segregada por norma + ductos dedicados; especificaci√≥n est√°ndar de EMC para compras.',
          'Implementar diagn√≥stico predictivo en PLC (contadores de fallas, alarmas de ruido) con dashboard.'
        ]
      }
    },
    {
      asset:'inyeccion',
      ifAny:['sobretemp','fuga','intermitente'],
      ctxAny:['ambiente_humedo','alta_temp'],
      defScore:4,
      acciones:{
        inmediata:[
          'Revisar enfriamiento, termopares y presiones; asegurar conexiones.',
        ],
        correctiva:[
          'Reemplazar sellos/termopares; balancear circuitos de agua.',
        ],
        definitiva:[
          'Est√°ndar de control t√©rmico (mapa de setpoints) + sensores redundantes cr√≠ticos.',
          'Mejora de sellado IP y deflectores contra spray.'
        ]
      }
    },
    {
      asset:'cnc',
      ifAny:['contaminacion','desalineo','vibracion'],
      ctxAny:['post_setup','alta_vibracion'],
      defScore:4,
      acciones:{
        inmediata:[
          'Limpieza de viruta/gu√≠as; comprobaci√≥n de referencias; aprietes.',
        ],
        correctiva:[
          'Realinear husillos/gu√≠as; cambiar topes; recalibraci√≥n metrol√≥gica.',
        ],
        definitiva:[
          'Deflectores anti-viruta y mejoras de extracci√≥n; estandarizar verificaci√≥n diaria de geometr√≠a.',
          'Actualizaci√≥n de plantillas de alineaci√≥n y torque con control de cambios.'
        ]
      }
    },
    {
      asset:'compresor',
      ifAny:['fuga','sobretemp','vibracion'],
      ctxAny:['ambiente_humedo','alta_temp'],
      defScore:4,
      acciones:{
        inmediata:[
          'Revisar filtros/aceite; purgar drenajes; verificar correas/acoples.',
        ],
        correctiva:[
          'Cambiar filtros/aceite; balanceo de ventilaci√≥n; alineaci√≥n acople.',
        ],
        definitiva:[
          'Filtraci√≥n escalonada + secador dimensionado; monitoreo de condici√≥n (presi√≥n, dew point).',
          'Plan de fugas con detector ultras√≥nico y KPI de % fuga.'
        ]
      }
    },
    {
      asset:'hvac',
      ifAny:['sobretemp','intermitente','falla_io'],
      ctxAny:['ambiente_humedo','alta_temp'],
      defScore:3,
      acciones:{
        inmediata:[
          'Comprobar sensores/limit switches; limpiar filtros.',
        ],
        correctiva:[
          'Calibrar sensores; revisar motores/ventiladores y flujos.',
        ],
        definitiva:[
          'Redundancia de sensores cr√≠ticos con votaci√≥n; PM basado en condici√≥n; registro autom√°tico de tendencias.'
        ]
      }
    },
    {
      asset:'vision',
      ifAny:['no_detecta','intermitente','contaminacion','emi'],
      ctxAny:['cables_potencia','ambiente_humedo','post_setup'],
      defScore:5,
      acciones:{
        inmediata:[
          'Limpieza de √≥pticas; revisar enfoque/ganancia; verificar conectores.',
        ],
        correctiva:[
          'Agregar filtros √≥pticos, capuchones IP y ferritas; separar rutas de cable.',
        ],
        definitiva:[
          'Redise√±o de fixture para iluminaci√≥n controlada; housing IP69K; fuente aislada; pruebas GR&R peri√≥dicas.'
        ]
      }
    },
  ];

  // ====== Utilidades ======
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',background:'#111725',color:'#e6eaf2',padding:'10px 12px',border:'1px solid var(--border)',borderRadius:'10px',zIndex:9999});
    document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
  }
  function renderOptions(){
    const sBox = $('#symptoms'); sBox.innerHTML='';
    SYMPTOMS.forEach(s=>{
      const div=document.createElement('div'); div.className='opt';
      div.innerHTML=`<input type="checkbox" value="${s.id}" id="sym_${s.id}"><label for="sym_${s.id}" style="margin:0"><span>${s.label}</span></label>`;
      sBox.appendChild(div);
    });
    const cBox = $('#context'); cBox.innerHTML='';
    CONTEXT.forEach(c=>{
      const div=document.createElement('div'); div.className='opt';
      div.innerHTML=`<input type="checkbox" value="${c.id}" id="ctx_${c.id}"><label for="ctx_${c.id}" style="margin:0"><span>${c.label}</span></label>`;
      cBox.appendChild(div);
    });
  }
  function getSelected(container){ return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value); }

  // ====== Motor de reglas ======
  function runEngine(){
    const asset = $('#asset').value;
    const sSel = getSelected($('#symptoms'));
    const cSel = getSelected($('#context'));
    const matched = RULES.filter(r=> r.asset===asset && r.ifAny.some(id=>sSel.includes(id)) && (r.ctxAny? r.ctxAny.some(id=>cSel.includes(id)) : true))
                         .sort((a,b)=> (b.defScore||0)-(a.defScore||0));

    const out = {inmediatas:[],correctivas:[],definitivas:[]};
    matched.forEach(m=>{
      out.inmediatas.push(...m.acciones.inmediata);
      out.correctivas.push(...m.acciones.correctiva);
      out.definitivas.push(...m.acciones.definitiva);
    });

    const universalDef = suggestUniversalDefs(asset, sSel, cSel);
    out.definitivas.push(...universalDef);

    const uniq = arr => [...new Set(arr)];
    renderList('#actInmediatas', uniq(out.inmediatas));
    renderList('#actCorrectivas', uniq(out.correctivas));
    renderList('#actDefinitivas', uniq(out.definitivas));

    $('#checkTable tbody').innerHTML='';
    uniq(out.inmediatas).slice(0,3).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));
    uniq(out.correctivas).slice(0,3).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));
    uniq(out.definitivas).slice(0,2).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));

    toast('Contramedidas generadas');
  }
  function suggestUniversalDefs(asset, sSel, cSel){
    const defs = [];
    defs.push('Poka-yoke/guardado permanente para impedir reposicionamiento indebido.');
    defs.push('Estandarizar instalaci√≥n (torques, rutas, plantillas) + control de cambios (ECR/ECO).');
    defs.push('Actualizar BOM con componente de especificaci√≥n superior (IP/EMC/temperatura) y vida √∫til definida.');
    defs.push('Monitoreo de condici√≥n (vibraci√≥n/temp/corriente) con alarmas y umbrales.');
    defs.push('Capacitaci√≥n y certificaci√≥n de montaje/ajuste para personal de turno.');
    if(['vision','robot_soldadura','vfd_plc','hvac'].includes(asset)){
      defs.push('Redundancia en sensores cr√≠ticos y validaci√≥n por l√≥gica (2oo2).');
    }
    if(sSel.includes('emi') || cSel.includes('cables_potencia')){
      defs.push('Arquitectura EMC definitiva: rutas segregadas, blindajes continuos, puesta a tierra √∫nica, filtros normalizados.');
    }
    if(sSel.includes('contaminacion') || cSel.includes('ambiente_humedo')){
      defs.push('Carcasas IP67/68/69K, deflectores y sellado mejorado; normas de limpieza por turno.');
    }
    if(sSel.includes('desalineo') || sSel.includes('vibracion')){
      defs.push('Tope/gu√≠a r√≠gida + aislaci√≥n de vibraci√≥n; plantillas de alineaci√≥n permanentes.');
    }
    return defs;
  }
  function renderList(sel, items){
    const ul=$(sel); ul.innerHTML='';
    if(!items.length){ ul.innerHTML='<li><span class="pill">Sin coincidencias; ajusta s√≠ntomas/contexto</span></li>'; return; }
    items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
  }

  // ====== Checklist ======
  function addCheckRow(row={tarea:'',resp:'',fecha:'',status:'Pendiente'}){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input placeholder="Tarea" value="${row.tarea||''}"></td>
      <td><input placeholder="Responsable" value="${row.resp||''}"></td>
      <td><input type="date" value="${row.fecha||''}"></td>
      <td>
        <select>
          <option ${row.status==='Pendiente'?'selected':''}>Pendiente</option>
          <option ${row.status==='En curso'?'selected':''}>En curso</option>
          <option ${row.status==='Hecha'?'selected':''}>Hecha</option>
          <option ${row.status==='Bloqueada'?'selected':''}>Bloqueada</option>
        </select>
      </td>
      <td class="row-actions">
        <button class="btn" onclick="moveRow(this,-1)">‚¨Ü</button>
        <button class="btn" onclick="moveRow(this,1)">‚¨á</button>
        <button class="btn" onclick="this.closest('tr').remove()">‚úñ</button>
      </td>`;
    $('#checkTable tbody').appendChild(tr);
  }
  function moveRow(btn,dir){
    const tr=btn.closest('tr'); const tb=tr.parentElement;
    const idx=[...tb.children].indexOf(tr); const target=idx+dir;
    if(target<0 || target>=tb.children.length)return;
    tb.insertBefore(tr, tb.children[target+(dir>0?1:0)]);
  }
  function getChecklist(){
    return $$('#checkTable tbody tr').map(tr=>({
      tarea: tr.children[0].querySelector('input').value.trim(),
      resp: tr.children[1].querySelector('input').value.trim(),
      fecha: tr.children[2].querySelector('input').value,
      status: tr.children[3].querySelector('select').value,
    })).filter(r=>r.tarea||r.resp||r.fecha);
  }

  // ====== Mini-FMEA ======
  function updateRPN(){
    const S = clamp(parseInt($('#fmeaS').value||'0'),1,10);
    const O = clamp(parseInt($('#fmeaO').value||'0'),1,10);
    const D = clamp(parseInt($('#fmeaD').value||'0'),1,10);
    const RPN = S*O*D;
    const badge=$('#rpnBadge');
    badge.textContent = `RPN: ${RPN} (S:${S} O:${O} D:${D})`;
    badge.className = 'badge ' + (RPN>=200?'danger': RPN>=120?'warn':'ok');
    const tips = [];
    if(S>=8){ tips.push('Agregar protecciones f√≠sicas, enclavamientos y l√≠mites de software para eliminar riesgos de lesi√≥n/da√±o grave.'); }
    if(O>=7){ tips.push('Mejorar especificaci√≥n de componentes (IP/temperatura/EMC) y robustez; control de proceso y PM basado en condici√≥n.'); }
    if(D>=7){ tips.push('A√±adir sensores redundantes y pruebas de diagn√≥stico en cada ciclo; alarmas tempranas y autoverificaci√≥n.'); }
    const asset=$('#asset').value;
    if(asset==='vfd_plc'){ tips.push('Implementar diagn√≥sticos en PLC (contadores de fallas, watchdog, CRC) y bit√°cora autom√°tica.'); }
    if(asset==='robot_soldadura'){ tips.push('Validaci√≥n 2oo2 de presencia de pieza y verificaci√≥n de cierre con curva de firma.'); }
    const ul=$('#fmeaTips'); ul.innerHTML=''; tips.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  // ====== MTTR / MTBF ======
  function updateKPIs(){
    const n = parseFloat($('#nFails').value||'0');
    const h = parseFloat($('#opHours').value||'0');
    const d = parseFloat($('#downMins').value||'0');
    const mttr = n>0? d/n : 0; // minutos por falla
    const mtbf = n>0? (h/n) : 0; // horas entre fallas
    $('#mttrBadge').textContent = `MTTR: ${mttr.toFixed(1)} min/falla`;
    $('#mtbfBadge').textContent = `MTBF: ${mtbf.toFixed(1)} h`;
    $('#mttrBadge').className='badge ' + (mttr<=30?'ok': mttr<=60?'warn':'danger');
    $('#mtbfBadge').className='badge ' + (mtbf>=80?'ok': mtbf>=40?'warn':'danger');
  }

  // ====== Resumen CAPA / A3 ======
  function buildResumen(){
    const s = getState();
    const sSel = getSelected($('#symptoms')).map(id=> SYMPTOMS.find(x=>x.id===id)?.label).filter(Boolean);
    const cSel = getSelected($('#context')).map(id=> CONTEXT.find(x=>x.id===id)?.label).filter(Boolean);
    const chk = getChecklist().map(r=>`| ${r.tarea} | ${r.resp||'-'} | ${r.fecha||'-'} | ${r.status} |`).join('\n');
    const defTop = (s.actDefinitivas||[]).slice(0,5).map(x=>`- ${x}`).join('\n') || '-';

    const md = `# A3/CAPA ‚Äî ${s.title||'Sin t√≠tulo'}
**L√≠nea/Equipo:** ${s.area||'-'}  
**Fecha/Turno/Resp:** ${s.date||'-'} / ${s.shift||'-'} / ${s.owner||'-'}  
**Impacto:** ${s.impact||'-'}

## Problema
${s.desc||'-'}

## S√≠ntomas / Contexto
- S√≠ntomas: ${sSel.join(', ')||'-'}
- Contexto: ${cSel.join(', ')||'-'}

## Acciones
### Inmediatas
${listText(s.actInmediatas)}
### Correctivas
${listText(s.actCorrectivas)}
### Contramedidas definitivas (Permanentes)
${defTop}

## FMEA
- Modo: ${$('#fmeaMode').value||'-'}
- Efecto: ${$('#fmeaEffect').value||'-'}
- Causa: ${$('#fmeaCause').value||'-'}
- **RPN:** ${($('#fmeaS').value||'?')}√ó${($('#fmeaO').value||'?')}√ó${($('#fmeaD').value||'?')} = ${($('#fmeaS').value&&$('#fmeaO').value&&$('#fmeaD').value)? ($('#fmeaS').value*$('#fmeaO').value*$('#fmeaD').value) : '?'}
- Acciones FMEA:  
${($('#fmeaActions').value||'-')}

## KPIs
- MTTR: ${$('#mttrBadge').textContent.replace('MTTR: ','')}
- MTBF: ${$('#mtbfBadge').textContent.replace('MTBF: ','')}

## Checklist
| Tarea | Responsable | Fecha | Estatus |
|---|---|---|---|
${chk || '| ‚Äî | ‚Äî | ‚Äî | ‚Äî |'}
`;
    $('#resumen').value = md.trim();
    toast('Resumen generado');
  }
  function listText(arr){ return (arr&&arr.length)? arr.map(x=>`- ${x}`).join('\n') : '-'; }

  // ====== Estado / Guardado ======
  function getState(){
    return {
      title:$('#title').value, area:$('#area').value, date:$('#date').value, shift:$('#shift').value, impact:$('#impact').value, owner:$('#owner').value,
      asset:$('#asset').value, desc:$('#desc').value,
      symptoms: getSelected($('#symptoms')), context: getSelected($('#context')),
      actInmediatas: Array.from($('#actInmediatas').children).map(li=>li.textContent),
      actCorrectivas: Array.from($('#actCorrectivas').children).map(li=>li.textContent),
      actDefinitivas: Array.from($('#actDefinitivas').children).map(li=>li.textContent),
      checklist: getChecklist(),
      fmea:{ mode:$('#fmeaMode').value, effect:$('#fmeaEffect').value, cause:$('#fmeaCause').value, S:$('#fmeaS').value, O:$('#fmeaO').value, D:$('#fmeaD').value, actions:$('#fmeaActions').value },
      kpis:{ nFails:$('#nFails').value, opHours:$('#opHours').value, downMins:$('#downMins').value },
      resumen:$('#resumen').value
    };
  }
  function setState(s){
    $('#title').value=s.title||''; $('#area').value=s.area||''; $('#date').value=s.date||''; $('#shift').value=s.shift||'D√≠a'; $('#impact').value=s.impact||''; $('#owner').value=s.owner||'';
    $('#asset').value=s.asset||'robot_soldadura'; $('#desc').value=s.desc||'';
    $$('#symptoms input[type="checkbox"]').forEach(cb=> cb.checked = (s.symptoms||[]).includes(cb.value));
    $$('#context input[type="checkbox"]').forEach(cb=> cb.checked = (s.context||[]).includes(cb.value));
    renderList('#actInmediatas', s.actInmediatas||[]);
    renderList('#actCorrectivas', s.actCorrectivas||[]);
    renderList('#actDefinitivas', s.actDefinitivas||[]);
    $('#checkTable tbody').innerHTML=''; (s.checklist&&s.checklist.length?s.checklist:[{status:'Pendiente'}]).forEach(r=>addCheckRow(r));
    $('#fmeaMode').value=s.fmea?.mode||''; $('#fmeaEffect').value=s.fmea?.effect||''; $('#fmeaCause').value=s.fmea?.cause||'';
    $('#fmeaS').value=s.fmea?.S||7; $('#fmeaO').value=s.fmea?.O||6; $('#fmeaD').value=s.fmea?.D||6; $('#fmeaActions').value=s.fmea?.actions||'';
    updateRPN();
    $('#nFails').value=s.kpis?.nFails||1; $('#opHours').value=s.kpis?.opHours||160; $('#downMins').value=s.kpis?.downMins||45;
    updateKPIs();
    $('#resumen').value=s.resumen||'';
  }
  function saveLocal(){ localStorage.setItem(stateKey, JSON.stringify(getState())); toast('Guardado local'); }
  function loadLocal(){
    const raw=localStorage.getItem(stateKey); if(!raw) return toast('No hay guardado local');
    try{ setState(JSON.parse(raw)); toast('Cargado'); }catch(e){ alert('Error: '+e.message); }
  }
  function exportJSON(){
    const blob=new Blob([JSON.stringify(getState(),null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(($('#title').value.trim())||'mantto')+'.json'; a.click(); URL.revokeObjectURL(a.href);
  }
  function importJSON(file){
    const rdr=new FileReader();
    rdr.onload=()=>{ try{ setState(JSON.parse(rdr.result)); toast('Importado'); }catch(e){ alert('JSON inv√°lido: '+e.message); } };
    rdr.readAsText(file);
  }

  // ====== Eventos ======
  document.getElementById('btnSuggest').onclick=runEngine;
  document.getElementById('addCheck').onclick=()=>addCheckRow();
  document.getElementById('clearCheck').onclick=()=>{ $('#checkTable tbody').innerHTML=''; addCheckRow(); };

  document.getElementById('fmeaS').addEventListener('input',updateRPN);
  document.getElementById('fmeaO').addEventListener('input',updateRPN);
  document.getElementById('fmeaD').addEventListener('input',updateRPN);

  document.getElementById('nFails').addEventListener('input',updateKPIs);
  document.getElementById('opHours').addEventListener('input',updateKPIs);
  document.getElementById('downMins').addEventListener('input',updateKPIs);

  document.getElementById('btnResumen').onclick=buildResumen;

  document.getElementById('btnSave').onclick=saveLocal;
  document.getElementById('btnLoad').onclick=loadLocal;
  document.getElementById('btnExport').onclick=exportJSON;
  document.getElementById('fileImport').addEventListener('change',e=>{ const f=e.target.files[0]; if(f) importJSON(f); });
  document.getElementById('btnPrint').onclick=()=>window.print();
  document.getElementById('btnNew').onclick=()=>{ if(confirm('¬øLimpiar todo?')){ localStorage.removeItem(stateKey); location.reload(); } };

  // ====== Init ======
  function init(){ renderOptions(); addCheckRow(); updateRPN(); updateKPIs(); }
  init();
</script>
</body>
</html>
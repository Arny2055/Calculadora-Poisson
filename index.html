<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CALCULADORA WGRB • MOTOR GÉMINIS 2.0</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Fugaz+One&display=swap" rel="stylesheet" />

<style>
  :root{
    --paper:#141317; --paper2:#1a191f;
    --ink:#ece7de; --muted:#b5afa6;
    --line:#3c3842; --edge:#4a4552; --shadow:0 10px 28px rgba(0,0,0,.35);
    --teal:#2ab3a4; --crimson:#e15c6a; --mustard:#e1c36e; --brown:#b58b64;
    --ok:#4fd4a7; --warn:#e3b34c; --danger:#ff6d7a;
    --radius:14px; --glass:rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: 'Libre Baskerville', Georgia, 'Times New Roman', serif;
    background:
      radial-gradient(900px 600px at 10% -10%, rgba(225,179,76,.07), transparent 60%),
      radial-gradient(800px 500px at 90% 0%, rgba(225,92,106,.06), transparent 60%),
      radial-gradient(1000px 800px at 50% 120%, rgba(42,179,164,.06), transparent 60%),
      var(--paper);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  .grain{position:fixed; inset:0; pointer-events:none; opacity:.22; mix-blend-mode:soft-light;
    background-image:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="180" height="180" viewBox="0 0 180 180">\
        <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter>\
        <rect width="100%" height="100%" filter="url(#n)" opacity="0.12" fill="black"/>\
      </svg>');
  }
  header{max-width:900px; margin:28px auto 10px; padding:0 16px}
  .mast{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap}
  h1{
    margin:0; line-height:1.08; letter-spacing:.2px;
    font-family:'Fugaz One', system-ui, sans-serif; font-weight:400;
    font-size:clamp(22px, 2.8vw, 40px); color:var(--ink);
    text-shadow:0 1px 0 rgba(0,0,0,.25);
  }
  .tagline{margin:.35rem 0 0; color:var(--muted); font-size:13px}
  .frame{
    background:linear-gradient(180deg, var(--paper2), #17161c);
    border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow:var(--shadow);
  }

  main{max-width:900px; margin:12px auto 100px; padding:0 16px; display:grid; gap:14px; grid-template-columns:1fr}

  .card{
    background:linear-gradient(180deg, #1f1e25 0%, #18171d 100%);
    border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    backdrop-filter:saturate(110%) blur(2px);
  }
  .card h2{margin:0; padding:14px 16px 0; font-size:17px; letter-spacing:.2px; font-weight:700}
  .card .content{padding:12px 16px 16px}

  .grid{display:grid; gap:12px; grid-template-columns:repeat(2,1fr)}
  .grid-1{display:grid; gap:12px; grid-template-columns:1fr}
  .grid-3{display:grid; gap:12px; grid-template-columns:repeat(3,1fr)}
  @media (max-width:720px){.grid{grid-template-columns:1fr}}

  label{display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted); margin:0 0 6px}
  .inp{
    width:100%; padding:11px 12px; border-radius:10px; border:1px solid var(--edge);
    background:#141319; color:var(--ink); outline:none; transition:border .2s, box-shadow .2s;
    font-variant-numeric: tabular-nums; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }
  .inp::placeholder{color:#8b869c}
  .inp:focus{border-color:var(--teal); box-shadow:0 0 0 4px rgba(42,179,164,.18)}
  .inp:focus-visible{outline:2px solid rgba(42,179,164,.18); outline-offset:2px}

  .help{font-size:11px; color:#9c97a7}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .badge{
    display:inline-flex; align-items:center; gap:8px; font-size:11px; padding:6px 10px; border-radius:999px;
    border:1px solid var(--edge); color:#eadfcd; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  }
  .dot{width:7px; height:7px; border-radius:50%; background:var(--teal); box-shadow:0 0 8px rgba(42,179,164,.6)}

  .slider{appearance:none; width:100%; height:8px; border-radius:999px; background:#25242c; outline:none; border:1px solid var(--edge)}
  .slider::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:22px; height:22px; border-radius:50%; cursor:pointer;
    border:2px solid #5f556a; background:radial-gradient(10px 10px at 50% 50%, #2e2b36 0, #3b3743 60%, #4e4754 100%);
    box-shadow:0 6px 14px rgba(0,0,0,.45);
  }
  .slider::-moz-range-thumb{width:22px; height:22px; border-radius:50%; border:2px solid #5f556a; background:#3b3743}

  .btns{display:flex; gap:10px; flex-wrap:wrap}
  button{
    appearance:none; border:none; border-radius:12px; padding:11px 14px; font-weight:700; cursor:pointer;
    background:linear-gradient(180deg, var(--teal), #1f7e73); color:#08110f; letter-spacing:.3px;
    box-shadow:0 10px 20px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.15);
    transition:transform .06s ease, filter .2s ease, box-shadow .2s ease;
  }
  button:hover{filter:brightness(1.07)}
  button:active{transform:translateY(1px)}
  button.secondary{
    background:linear-gradient(180deg,#2b2a33,#23222b); color:var(--ink);
    border:1px solid var(--edge); box-shadow:0 10px 20px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05)
  }

  .kpi{
    display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px;
    border:1px solid var(--edge); background:linear-gradient(180deg, #1b1a21, #17161c)
  }
  .kpi .lbl{font-size:12px; color:var(--muted)} .kpi .val{font-weight:700; letter-spacing:.2px}

  table{width:100%; border-collapse:collapse; margin-top:4px}
  thead th{position:sticky; top:0; background:#1d1c24; border-bottom:2px solid var(--edge)}
  th,td{padding:11px 8px; border-bottom:1px dashed var(--edge); text-align:right; font-variant-numeric: tabular-nums}
  th:first-child, td:first-child{text-align:left}
  th{color:#d8d1c6; font-weight:700; font-size:12px; letter-spacing:.25px}
  tbody tr:hover{background:#201f27}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
  .note{color:#9c97a7; font-size:12px; margin-top:8px}

  .section-title{display:flex; align-items:center; gap:8px}
  .section-title::after{content:""; height:1px; flex:1; background:repeating-linear-gradient(90deg, var(--edge), var(--edge) 8px, transparent 8px, transparent 16px); opacity:.7}

  .toggle{display:inline-flex; align-items:center; gap:10px; padding:6px 10px; border-radius:999px; border:1px solid var(--edge); background:var(--glass)}
  .switch{position:relative; width:48px; height:26px; border-radius:999px; background:#26232c; border:1px solid var(--edge); cursor:pointer}
  .switch input{appearance:none; width:0; height:0; opacity:0}
  .knob{position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%; background:#2f2a37; border:2px solid #5f556a; transition:left .18s ease}
  .switch input:checked + .knob{ left:23px }

  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--edge); font-size:12px}
  .chip.ok{background:rgba(79,212,167,.1); color:var(--ok)}
  .chip.warn{background:rgba(227,179,76,.08); color:var(--warn)}
  .chip.danger{background:rgba(255,109,122,.08); color:var(--danger)}

  /* Matriz de Correlación */
  .prob-matrix table{margin-top:10px; border-radius:8px; overflow:hidden}
  .prob-matrix th, .prob-matrix td{padding:5px 6px; font-size:12px; border-bottom:1px solid var(--edge); border-right:1px solid var(--edge)}
  .prob-matrix th{text-align:center; font-weight:700}
  .prob-matrix td{text-align:center}
  .prob-matrix th:first-child, .prob-matrix td:first-child{border-left:none}
  .prob-matrix th:last-child, .prob-matrix td:last-child{border-right:none}
  .prob-matrix thead th{background:#23212b; border-bottom:2px solid var(--edge)}
  .prob-matrix tbody tr:hover{background:none}

  .res-grid{display:grid; gap:14px; grid-template-columns:1fr 1fr}
  @media (max-width:720px){.res-grid{grid-template-columns:1fr}}

  .sticky-bar{position:fixed; left:0; right:0; bottom:12px; display:none; z-index:20; padding:0 12px}
  .sticky-inner{display:flex; gap:10px; justify-content:space-between; align-items:center; background:#201e26; border:1px solid var(--edge); box-shadow:var(--shadow); border-radius:14px; padding:8px 10px}
  .sticky-inner .buttons{display:flex; gap:10px}
  @media (max-width:390px){
    body{font-size:16px}
    h1{font-size:22px}
    .tagline{font-size:12.5px}
    .card h2{font-size:16px}
    label{font-size:12.5px}
    .inp{padding:12px 12px; font-size:16px}
    th,td{padding:10px 8px}
    .sticky-bar{display:block}
    main{margin-bottom:110px}
    .btns{display:none}
  }

</style>
</head>
<body>
  <div class="grain" aria-hidden="true"></div>

  <header>
    <div class="frame">
      <div class="mast">
        <div>
          <h1>Calculadora WGRB — <span style="color:var(--teal)">Motor Géminis 2.0</span></h1>
        <p class="tagline">Modelo Original: Tasa de Goles Ponderada Bayesiana (Weighted Goal Rate Bayesian).</p>
        </div>
        <div class="row">
          <div class="badge" role="status" aria-live="polite"><span class="dot" aria-hidden="true"></span> Nuevo Paradigma (No-Poisson)</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="card" aria-label="Entradas">
      <h2 class="section-title">Parámetros de Entrada & Calibración</h2>
      <div class="content">
        <div class="grid-1" style="margin-bottom:12px;">
            <label for="leagueAvg">Tasa de Goles Promedio de la LIGA (Media) <span class="help">Obligatorio para la Calibración Bayesiana. ej. 2.75</span></label>
            <input id="leagueAvg" type="text" inputmode="decimal" class="inp" placeholder="2.75" autocomplete="off" aria-label="Media de Goles de la Liga">
        </div>

        <div class="grid">
          <div>
            <div class="kpi" style="margin-bottom:10px">
              <div class="lbl">Tasa de Gol (Local)</div>
              <div class="badge" style="background:rgba(42,179,164,.12); color:var(--teal)">Rendimiento Ponderado</div>
            </div>
            <div class="grid">
              <div>
                <label for="attH">GF Local (media) <span class="help">Tasa de Ataque: ej. 1.60</span></label>
                <input id="attH" type="text" inputmode="decimal" class="inp" placeholder="1.60" autocomplete="off" aria-label="GF Local">
              </div>
              <div>
                <label for="xgH">xGF Local (media) <span class="help">Tasa xG de Ataque: ej. 1.85</span></label>
                <input id="xgH" type="text" inputmode="decimal" class="inp" placeholder="1.85" autocomplete="off" aria-label="xG Local">
              </div>
            </div>
            <div class="grid">
              <div>
                <label for="defH">GC Local (concede) <span class="help">Tasa de Defensa: ej. 1.20</span></label>
                <input id="defH" type="text" inputmode="decimal" class="inp" placeholder="1.20" autocomplete="off" aria-label="GC Local">
              </div>
              <div>
                <label for="xgcH">xGC Local (concede) <span class="help">Tasa xG de Defensa: ej. 1.35</span></label>
                <input id="xgcH" type="text" inputmode="decimal" class="inp" placeholder="1.35" autocomplete="off" aria-label="xGC Local">
              </div>
            </div>
          </div>

          <div>
            <div class="kpi" style="margin-bottom:10px">
              <div class="lbl">Tasa de Gol (Visitante)</div>
              <div class="badge" style="background:rgba(42,179,164,.12); color:var(--teal)">Rendimiento Ponderado</div>
            </div>
            <div class="grid">
              <div>
                <label for="attA">GF Visitante (media) <span class="help">Tasa de Ataque: ej. 1.10</span></label>
                <input id="attA" type="text" inputmode="decimal" class="inp" placeholder="1.10" autocomplete="off" aria-label="GF Visitante">
              </div>
              <div>
                <label for="xgA">xGF Visitante (media) <span class="help">Tasa xG de Ataque: ej. 1.25</span></label>
                <input id="xgA" type="text" inputmode="decimal" class="inp" placeholder="1.25" autocomplete="off" aria-label="xG Visitante">
              </div>
            </div>
            <div class="grid">
              <div>
                <label for="defA">GC Visitante (concede) <span class="help">Tasa de Defensa: ej. 1.15</span></label>
                <input id="defA" type="text" inputmode="decimal" class="inp" placeholder="1.15" autocomplete="off" aria-label="GC Visitante">
              </div>
              <div>
                <label for="xgcA">xGC Visitante (concede) <span class="help">Tasa xG de Defensa: ej. 1.40</span></label>
                <input id="xgcA" type="text" inputmode="decimal" class="inp" placeholder="1.40" autocomplete="off" aria-label="xGC Visitante">
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2 class="section-title" style="padding:0 16px 0">Ajustes del Motor WGRB ($\mathbf{\alpha, \gamma, K}$)</h2>
          <div class="content">
            <div class="grid-3">
              <div>
                <label for="alpha">Peso del xG ($\mathbf{\alpha}$) <span class="help">0 = solo GF/GC • 1 = solo xG/xGC</span>
                  <span class="badge"><strong id="alphaVal">0.70</strong></span>
                </label>
                <input id="alpha" type="range" min="0" max="1" step="0.01" value="0.70" class="slider" aria-label="Peso del xG">
              </div>
              <div>
                <label for="gamma">Ventaja Localía ($\mathbf{\gamma}$) <span class="help">ajusta $R_L$ y $R_V$</span>
                  <span class="badge"><strong id="gammaVal">0.06</strong></span>
                </label>
                <input id="gamma" type="range" min="0" max="0.20" step="0.005" value="0.06" class="slider" aria-label="Localía">
              </div>
              <div>
                <label for="k_shrink">Factor de Encogimiento ($\mathbf{K}$) <span class="help">Suavizado Bayesiano de la Tasa</span>
                  <span class="badge"><strong id="k_shrinkVal">10</strong></span>
                </label>
                <input id="k_shrink" type="range" min="0" max="25" step="1" value="10" class="slider" aria-label="Factor K Shrinkage">
              </div>
            </div>
            <p class="note" style="margin-top:10px">El Motor 2.0 no usa el Factor Z₀₀. El cálculo de Marcador Correcto (CS) es una **Simulación de Montecarlo Rápida (SMC)**.</p>
          </div>
        </div>

        <div class="row" style="justify-content:space-between; align-items:flex-end; margin-top:12px">
          <div class="btns" role="group" aria-label="Acciones principales">
            <button id="calcBtn" type="button" title="Calcular" aria-label="Calcular">Calcular (SMC)</button>
            <button id="resetBtn" type="button" class="secondary" title="Limpiar todo" aria-label="Limpiar">Limpiar</button>
          </div>
        </div>

        <div class="grid" style="margin-top:14px">
          <div class="kpi" role="status" aria-live="polite">
            <div class="lbl">Tasa de Gol (Local $\mathbf{R_L}$) • (Visitante $\mathbf{R_V}$)</div>
            <div class="val" id="rates">—</div>
          </div>
          <div class="kpi" role="status" aria-live="polite">
            <div class="lbl">$\mathbf{R_{Total}}$ (Media de Goles de la Simulación)</div>
            <div class="val" id="rateTot">—</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Resultados">
      <h2 class="section-title">Resultados de Simulación (SMC 10,000)</h2>
      <div class="content">

        <div class="res-grid">
          <div>
            <table>
              <thead><tr><th>1X2</th><th>Prob.</th><th>Cuota justa</th></tr></thead>
              <tbody>
                <tr><td>Local (1)</td><td id="pH1">—</td><td id="oH1">—</td></tr>
                <tr><td>Empate (X)</td><td id="pD">—</td><td id="oD">—</td></tr>
                <tr><td>Visitante (2)</td><td id="pA2">—</td><td id="oA2">—</td></tr>
              </tbody>
            </table>
          </div>

          <div>
            <table>
              <thead><tr><th>Mercado</th><th>Prob.</th><th>Cuota justa</th></tr></thead>
              <tbody>
                <tr><td>Over 2.5</td><td id="pO25">—</td><td id="oO25">—</td></tr>
                <tr><td>Under 2.5</td><td id="pU25">—</td><td id="oU25">—</td></tr>
                <tr><td>BTTS — Sí</td><td id="pBYes">—</td><td id="oBYes">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="prob-matrix" style="margin-top:14px">
          <h3 style="margin:0 0 4px;font-size:14px;color:var(--ink)">Matriz Prob. (Goles Local vs Goles Visitante)</h3>
          <table id="matrixTable">
            <thead><tr><th>L/V</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4+</th></tr></thead>
            <tbody><tr><td colspan="6" style="text-align:center;color:#9c97a7">—</td></tr></tbody>
          </table>
        </div>
        
        <div style="margin-top:14px">
          <p class="note">Ranking de los 5 Marcadores Correctos más probables:</p>
          <table>
            <thead><tr><th>Marcador</th><th>Prob.</th><th>Cuota justa</th></tr></thead>
            <tbody id="csTable">
              <tr><td colspan="3" style="text-align:center;color:#9c97a7">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="sticky-bar" aria-hidden="true">
    <div class="sticky-inner">
      <div class="badge" style="font-weight:700">Acciones</div>
      <div class="buttons">
        <button id="calcBtnSticky" type="button" aria-label="Calcular (sticky)">Calcular (SMC)</button>
        <button id="resetBtnSticky" type="button" class="secondary" aria-label="Limpiar (sticky)">Limpiar</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const NUM_SIMULATIONS = 10000;
  const MAX_GOALS = 5; // Límite para la matriz y CS

  // ===== Normalización y Utilidades =====
  function parseDec(str){
    if (str==null) return NaN;
    if (typeof str !== 'string') str = String(str);
    const cleaned = str.trim().replace(/\s+/g,'').replace(',', '.');
    const match = cleaned.match(/[+\-]?\d*\.?\d+(e[+\-]?\d+)?/i);
    if (!match) return NaN;
    const n = Number(match[0]);
    return isFinite(n) ? n : NaN;
  }
  function getNum(id){ const el = document.getElementById(id); return el ? parseDec(el.value ?? '') : NaN; }

  const fmtPct = x => isFinite(x) ? (x*100).toFixed(1) + '%' : '—';
  const fmtOdd = x => (isFinite(x) && x>0) ? x.toFixed(2) : '—';
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
  const inv = p => (p>0 && isFinite(p)) ? (1/p) : NaN;

  const E = {
    attH: $('#attH'), xgH: $('#xgH'), attA: $('#attA'), xgA: $('#xgA'), defH: $('#defH'), xgcH: $('#xgcH'), defA: $('#defA'), xgcA: $('#xgcA'),
    leagueAvg: $('#leagueAvg'),
    alpha: $('#alpha'), alphaVal: $('#alphaVal'), gamma: $('#gamma'), gammaVal: $('#gammaVal'), k_shrink: $('#k_shrink'), k_shrinkVal: $('#k_shrinkVal'),
    rates: $('#rates'), rateTot: $('#rateTot'),

    pH1: $('#pH1'), oH1: $('#oH1'), pD:  $('#pD'),  oD:  $('#oD'), pA2: $('#pA2'), oA2: $('#oA2'),
    pO25: $('#pO25'), oO25: $('#oO25'), pU25: $('#pU25'), oU25: $('#oU25'),
    pBYes: $('#pBYes'), oBYes: $('#oBYes'),
    csTable: $('#csTable'), matrixTable: $('#matrixTable'),

    calcBtn: $('#calcBtn'), resetBtn: $('#resetBtn'), calcBtnSticky: $('#calcBtnSticky'), resetBtnSticky: $('#resetBtnSticky'),
  };

  function colorClass(p){ return (p>=0.6)?'ok':(p>=0.4?'warn':'danger'); }
  function writeRow(cellP, cellO, p){
    if (!cellP || !cellO) return;
    const odd = inv(p);
    cellP.textContent = isFinite(p) ? (p>=0 ? fmtPct(p) : '—') : '—';
    cellO.textContent = isFinite(odd) ? fmtOdd(odd) : '—';
    cellP.className = isFinite(p) ? colorClass(p) : '';
  }
  function renderDashes(){
    [
      E.pH1,E.oH1,E.pD,E.oD,E.pA2,E.oA2,
      E.pO25,E.oO25, E.pU25,E.oU25, E.pBYes,E.oBYes
    ].forEach(el=>{ if(el){ el.textContent='—'; el.className=''; } });
    if (E.csTable){
      E.csTable.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#9c97a7">—</td></tr>';
    }
    if (E.matrixTable) {
        E.matrixTable.innerHTML = '<thead><tr><th>L/V</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4+</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center;color:#9c97a7">—</td></tr></tbody>';
    }
  }

  // Generador de Goles basado en Tasa (Poisson Inversa)
  function generateGoalCount(rate) {
    if (rate <= 0) return 0;
    let count = 0;
    let p = 1;
    let L = Math.exp(-rate);
    
    // Simulación de Poisson: Si N es el número de eventos en un intervalo, P(N=k) = (lambda^k * e^-lambda) / k!
    // Esto es equivalente a sumar exponenciales hasta que excedan el tiempo total (1)
    // El método rápido (L - Uniforme):
    let u = Math.random();
    while (u > L) {
      count++;
      u *= Math.random();
    }
    return count;
  }

  // ===== Motor de Cálculo WGRB (Weighted Goal Rate Bayesian) =====
  function calcWGRB(){
    // Entradas
    const attH = Math.max(0, getNum('attH')), xgH = Math.max(0, getNum('xgH'));
    const defH = Math.max(0, getNum('defH')), xgcH = Math.max(0, getNum('xgcH'));
    const attA = Math.max(0, getNum('attA')), xgA = Math.max(0, getNum('xgA'));
    const defA = Math.max(0, getNum('defA')), xgcA = Math.max(0, getNum('xgcA'));
    const leagueAvg = Math.max(0.01, getNum('leagueAvg')); 

    if (!isFinite(leagueAvg) || leagueAvg <= 0) {
        alert('ADVERTENCIA: Debes ingresar la Tasa de Goles Promedio de la Liga.');
        renderDashes();
        return null;
    }

    // Parámetros
    const alpha = clamp(Number(E.alpha?.value ?? 0.7), 0, 1);
    const gamma = clamp(Number(E.gamma?.value ?? 0.06), 0, 0.20);
    const K = clamp(Number(E.k_shrink?.value ?? 10), 0, 25);
    
    // 1. Tasa de Rendimiento Ponderada (GF/GC + xG/xGC)
    const rateAttH_W = (1-alpha)*attH + alpha*xgH;
    const rateDefH_W = (1-alpha)*defH + alpha*xgcH;
    const rateAttA_W = (1-alpha)*attA + alpha*xgA;
    const rateDefA_W = (1-alpha)*defA + alpha*xgcA;
    
    // 2. Tasa de Goles Bruta (Rendimiento Propio * Tasa Concedida del rival / Tasa Total de Liga)
    // Usamos (leagueAvg/2) como la tasa promedio de ATAQUE y DEFENSA por equipo
    const leagueHalf = leagueAvg/2; 
    
    let rateH_base = (rateAttH_W / leagueHalf) * (rateDefA_W / leagueHalf) * leagueHalf;
    let rateA_base = (rateAttA_W / leagueHalf) * (rateDefH_W / leagueHalf) * leagueHalf;

    // 3. Encogimiento (Shrinkage) Bayesiano a la Tasa (K)
    // K actúa como el número de "partidos nulos" (con tasa de goles igual a la media de la liga)
    // R_ajustada = (N*R_base + K*R_Liga) / (N+K) donde N=1
    // Simplificado a: R_ajustada = (R_base + K*R_Liga) / (1+K)
    
    const rateLeagueH = leagueAvg * (1+gamma)/2; // Media de gol Local/Visitante de la Liga
    const rateLeagueA = leagueAvg * (1-gamma)/2;

    let rateH_shrink = (rateH_base + K * rateLeagueH) / (1 + K);
    let rateA_shrink = (rateA_base + K * rateLeagueA) / (1 + K);

    // 4. Aplicación de la Ventaja de Localía
    let rateH_final = rateH_shrink * (1 + gamma);
    let rateA_final = rateA_shrink * (1 - gamma);

    // Mantenemos positivo y evitamos NaN
    rateH_final = Math.max(0.001, rateH_final);
    rateA_final = Math.max(0.001, rateA_final);

    const R_Total = rateH_final + rateA_final;

    E.rates.textContent   = `${rateH_final.toFixed(3)} • ${rateA_final.toFixed(3)}`;
    E.rateTot.textContent = R_Total.toFixed(3);

    return {rateH: rateH_final, rateA: rateA_final};
  }

  // ===== Simulación Montecarlo Rápida (SMC) =====
  function runSMC(rateH, rateA){
    const scores = new Map();
    let count1 = 0, countX = 0, count2 = 0;
    let countO25 = 0, countU25 = 0, countBYes = 0;
    
    // Simulación
    for(let i=0; i<NUM_SIMULATIONS; i++){
      const goalsH = generateGoalCount(rateH);
      const goalsA = generateGoalCount(rateA);
      
      const scoreKey = `${goalsH}-${goalsA}`;
      scores.set(scoreKey, (scores.get(scoreKey) || 0) + 1);

      // 1X2
      if (goalsH > goalsA) count1++;
      else if (goalsH === goalsA) countX++;
      else count2++;

      // Over/Under 2.5
      const totalG = goalsH + goalsA;
      if (totalG >= 3) countO25++;
      else countU25++;

      // BTTS (Ambos Marcan)
      if (goalsH > 0 && goalsA > 0) countBYes++;
    }

    // Resultados Finales
    const p1 = count1 / NUM_SIMULATIONS;
    const pX = countX / NUM_SIMULATIONS;
    const p2 = count2 / NUM_SIMULATIONS;
    const pO25 = countO25 / NUM_SIMULATIONS;
    const pU25 = countU25 / NUM_SIMULATIONS;
    const pBYes = countBYes / NUM_SIMULATIONS;

    // Marcador Correcto (CS)
    const csList = Array.from(scores.entries()).map(([key, count]) => {
      const [h, a] = key.split('-').map(Number);
      return {h, a, p: count / NUM_SIMULATIONS};
    }).sort((u,v)=>v.p - u.p).slice(0, 5);
    
    // Matriz de Probabilidad
    const matrix = Array(MAX_GOALS + 1).fill(0).map(() => Array(MAX_GOALS + 1).fill(0));
    scores.forEach((count, key) => {
        const [h, a] = key.split('-').map(Number);
        const r = Math.min(h, MAX_GOALS);
        const c = Math.min(a, MAX_GOALS);
        matrix[r][c] += count;
    });

    return {p1, pX, p2, pO25, pU25, pBYes, csList, matrix};
  }

  // ===== Renderizado de Resultados =====
  function fillCS(tableBody, items){
    if (!tableBody) return;
    if (!items || !items.length || items[0].p === 0){
      tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#9c97a7">—</td></tr>';
      return;
    }
    tableBody.innerHTML = items.map(({h,a,p})=>{
      const odd = (p>0)? (1/p) : NaN;
      const cls = colorClass(p);
      return `<tr>
        <td>${h} - ${a}</td>
        <td class="${cls}">${fmtPct(p)}</td>
        <td>${fmtOdd(odd)}</td>
      </tr>`;
    }).join('');
  }

  function fillMatrix(tableBody, matrix){
      const MAX_G_COL = MAX_GOALS; 
      let html = '<thead><tr><th>L/V</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4+</th></tr></thead><tbody>';
      for (let h = 0; h <= MAX_G_COL; h++) {
          html += `<tr><td>${h < MAX_G_COL ? h : '4+'}</td>`;
          for (let a = 0; a <= MAX_G_COL; a++) {
              const count = matrix[h][a];
              const p = count / NUM_SIMULATIONS;
              
              let cls = '';
              if (h > a) cls = 'ok';
              else if (h < a) cls = 'danger';
              else if (h === a) cls = 'warn';

              html += `<td class="${cls}">${fmtPct(p)}</td>`;
          }
          html += '</tr>';
      }
      html += '</tbody>';
      tableBody.innerHTML = html;
  }

  function runCalc(){
    const rates = calcWGRB();
    if (!rates) return;
    
    const results = runSMC(rates.rateH, rates.rateA);
    
    // Render 1X2
    writeRow(E.pH1, E.oH1, results.p1);
    writeRow(E.pD,  E.oD,  results.pX);
    writeRow(E.pA2, E.oA2, results.p2);

    // Render Totales
    writeRow(E.pO25, E.oO25, results.pO25);
    writeRow(E.pU25, E.oU25, results.pU25);
    writeRow(E.pBYes, E.oBYes, results.pBYes);

    // Render CS y Matriz
    fillCS(E.csTable, results.csList);
    fillMatrix(E.matrixTable, results.matrix);
  }

  function doReset(){
    ['attH','xgH','defH','xgcH','attA','xgA','defA','xgcA','leagueAvg'
    ].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.value='';
    });

    if (E.alpha){ E.alpha.value = 0.70; E.alphaVal.textContent = '0.70'; }
    if (E.gamma){ E.gamma.value = 0.06; E.gammaVal.textContent = '0.06'; }
    if (E.k_shrink){ E.k_shrink.value = 10; E.k_shrinkVal.textContent = '10'; }
    
    if (E.rateTot) E.rateTot.textContent = '—';
    if (E.rates) E.rates.textContent = '—';
    renderDashes();
  }

  // ===== UX (No modificar) =====
  ['attH','xgH','defH','xgcH','attA','xgA','defA','xgcA','leagueAvg'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('blur', ()=> {
      const n = getNum(id);
      if (isFinite(n)) el.value = String(Number(n).toFixed(2));
    });
    el.addEventListener('keyup', (e)=>{ if (e.key === 'Enter') runCalc(); });
  });

  const bindSlider = (slider, label, fmt=(v)=>Number(v).toFixed(2))=>{
    if (!slider || !label) return;
    const update = ()=>{ label.textContent = fmt(slider.value); };
    slider.addEventListener('input', update);
    update();
  };
  bindSlider(E.alpha, E.alphaVal, v=>Number(v).toFixed(2));
  bindSlider(E.gamma, E.gammaVal, v=>Number(v).toFixed(2));
  bindSlider(E.k_shrink, E.k_shrinkVal, v=>String(v));

  const wire = (el, fn)=>{
    if (!el) return;
    el.addEventListener('click', fn, {passive:true});
    el.addEventListener('pointerup', fn, {passive:true});
    el.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') fn(); });
  };

  wire(E.calcBtn, runCalc); wire(E.resetBtn, doReset);
  wire(E.calcBtnSticky, runCalc); wire(E.resetBtnSticky, doReset);

  document.body.addEventListener('keyup', (e)=>{
    if (e.key === 'c' && (e.target === document.body || e.target.tagName === 'DIV')) runCalc();
  });

  renderDashes();
})();
</script>
</body>
</html>

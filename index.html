<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS Pro - Calculadora de Poisson Doble Corregido</title>
    <style>
        /* ================================================= */
        /* == ESTILOS CSS: Variables y Configuraci√≥n Base == */
        /* ================================================= */
        :root {
            /* Modo Claro (Default) */
            --bg-page: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --accent-main: #007bff; /* Azul primario */
            --accent-alt: #17a2b8; /* Cyan para headers */
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Modo Oscuro */
        .dark-mode {
            --bg-page: #1e1e1e;
            --bg-card: #2c2c2c;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --accent-main: #66b2ff;
            --accent-alt: #4da6ff;
            --success-color: #40c463;
            --warning-color: #ffeb3b;
            --danger-color: #ff6b6b;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-page);
            color: var(--text-primary);
            transition: all 0.4s ease;
        }

        #calculator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 35px;
            background-color: var(--bg-card);
            box-shadow: var(--shadow);
            border-radius: 12px;
        }

        /* ================================================= */
        /* == TIPOGRAF√çA Y ESTRUCTURA                     == */
        /* ================================================= */
        header { text-align: center; margin-bottom: 30px; }
        header h1 {
            color: var(--accent-main);
            margin-bottom: 5px;
            font-size: 2.5em;
            font-weight: 700;
        }
        header h2 {
            font-size: 1.1em;
            color: var(--text-secondary);
            font-weight: 400;
        }

        h3 {
            color: var(--accent-alt);
            border-bottom: 2px solid var(--accent-alt);
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        h4 {
            color: var(--text-primary);
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        /* Contenedores Principales */
        .results-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ================================================= */
        /* == INPUTS Y CONTROLES                          == */
        /* ================================================= */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        @media (max-width: 600px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--text-primary);
        }

        input[type="number"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-page);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .correction-factor {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid var(--accent-main);
            border-radius: 8px;
            background-color: rgba(0, 123, 255, 0.05);
        }
        .dark-mode .correction-factor {
             background-color: rgba(102, 178, 255, 0.15);
        }

        button.calculate-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
        }
        button.calculate-btn:hover { background-color: #1e7e34; transform: translateY(-1px); }

        /* ================================================= */
        /* == TABLAS Y MATRIZ                             == */
        /* ================================================= */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            text-transform: uppercase;
        }
        .dark-mode th { background-color: #3a3a3a; }

        /* Colores Condicionales (1X2) */
        .highlight-win { background-color: rgba(40, 167, 69, 0.1); }
        .highlight-draw { background-color: rgba(255, 193, 7, 0.1); }
        .highlight-loss { background-color: rgba(220, 53, 69, 0.1); }
        .dark-mode .highlight-win { background-color: rgba(64, 196, 99, 0.2); }
        .dark-mode .highlight-draw { background-color: rgba(255, 235, 59, 0.2); }
        .dark-mode .highlight-loss { background-color: rgba(255, 107, 107, 0.2); }

        /* Matriz de Marcadores */
        #score-matrix thead th:not(:first-child),
        #score-matrix tbody tr th {
            background-color: var(--accent-main);
            color: white;
            font-weight: 700;
        }
        #score-matrix td { min-width: 60px; font-weight: 500; }
        .max-prob {
            background-color: var(--warning-color) !important;
            color: var(--text-primary);
            font-weight: 700 !important;
            border: 2px solid var(--danger-color) !important;
        }
        .dark-mode .max-prob { color: #212529; }


        /* ================================================= */
        /* == SUGERENCIAS DE VALOR                        == */
        /* ================================================= */
        #value-suggestions {
            min-height: 150px;
            padding: 15px;
            border: 2px solid var(--success-color);
            border-radius: 8px;
            background-color: rgba(40, 167, 69, 0.05);
            transition: all 0.3s ease;
        }
        .dark-mode #value-suggestions { background-color: rgba(64, 196, 99, 0.15); }

        .value-tip {
            background-color: var(--success-color);
            color: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .advice-text {
            font-style: italic;
            font-size: 0.9em;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 10px;
        }
        .no-value-msg {
            text-align: center;
            color: var(--text-secondary);
            padding-top: 20px;
            font-style: italic;
        }
        
        /* ================================================= */
        /* == FOOTER Y MODO TOGGLE                        == */
        /* ================================================= */
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        #mode-toggle {
            background-color: var(--text-secondary);
            width: 250px;
            font-size: 0.9em;
            padding: 10px 15px;
            font-weight: 500;
        }
        #mode-toggle:hover { background-color: #5a6268; }
    </style>
</head>
<body class="light-mode">

<div id="calculator-container">
    <header>
        <h1>BetAGS Pro üìà F√∫tbol Analytics</h1>
        <h2>Modelo de Poisson Doble Corregido y Ajuste Emp√≠rico de Correlaci√≥n</h2>
    </header>

    <main>
        <section id="input-section">
            <h3>Fuerzas Ofensivas y Defensivas ($\lambda$ Base)</h3>
            <p style="text-align: center; font-style: italic; color: var(--text-secondary);">Ingresa los par√°metros de fuerza de ataque (GF) y debilidad defensiva (GC) del Local (L) y el Visitante (V), relativos a la media de la liga (GL).</p>
            <div class="input-grid">
                <div class="input-group"><label for="gl_l">GL_L (Media Goles Liga Local):</label><input type="number" id="gl_l" value="1.50" step="0.01"></div>
                <div class="input-group"><label for="gl_v">GL_V (Media Goles Liga Visitante):</label><input type="number" id="gl_v" value="1.20" step="0.01"></div>
                <div class="input-group"><label for="gf_l">GF_L (Media Goles a Favor Local):</label><input type="number" id="gf_l" value="1.70" step="0.01"></div>
                <div class="input-group"><label for="gc_l">GC_L (Media Goles en Contra Local):</label><input type="number" id="gc_l" value="1.00" step="0.01"></div>
                <div class="input-group"><label for="gf_v">GF_V (Media Goles a Favor Visitante):</label><input type="number" id="gf_v" value="1.40" step="0.01"></div>
                <div class="input-group"><label for="gc_v">GC_V (Media Goles en Contra Visitante):</label><input type="number" id="gc_v" value="1.30" step="0.01"></div>
            </div>
            <div class="correction-factor">
                <label for="correlation_factor">Factor de Correlaci√≥n/Ajuste Emp√≠rico (Aumenta Probabilidad de 0-0 y 1-1):</label>
                <input type="number" id="correlation_factor" value="0.04" step="0.005">
            </div>
            <button class="calculate-btn" onclick="calculatePredictions()">üöÄ Calcular Predicciones</button>
        </section>

        <hr>

        <section id="output-section">
            <h3>An√°lisis y Opciones de Mercado</h3>
            
            <div class="results-grid">
                <div>
                    <h4>1) Probabilidades Clave y Cuotas Impl√≠citas</h4>
                    <table id="prob-odds-table">
                        <thead>
                            <tr><th>Mercado</th><th>P (%)</th><th>Cuota Impl√≠cita</th><th>Cuota M√≠nima Valor</th></tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                
                <div>
                    <h4>3) Panel de Sugerencias de Valor (Edge)</h4>
                    <p class="advice-text">Se asume valor si la cuota ofrecida por el mercado es mayor que la cuota impl√≠cita predicha m√°s un margen (ej. $1/P + 0.10$). **Ajusta la cuota simulada para evaluar.**</p>
                    <div id="value-suggestions">
                        <p class="no-value-msg">Calcula para ver sugerencias de apuestas.</p>
                    </div>
                </div>
            </div>

            <hr>

            <h3>2) Matriz de Probabilidades de Marcador Exacto (Corregido)</h3>
            <div class="score-matrix-container">
                <table id="score-matrix">
                    <thead>
                        <tr><th>Local \ Visitante</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4+</th></tr>
                    </thead>
                    <tbody>
                        <tr><th>0</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>1</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>2</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>3</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>4+</th><td></td><td></td><td></td><td></td><td></td></tr>
                    </tbody>
                </table>
                <p style="text-align: center; margin-top: 10px; font-size: 0.85em; color: var(--text-secondary);">El marcador con la m√°xima probabilidad est√° resaltado en amarillo. La suma de las celdas es el 100% de la probabilidad predicha.</p>
            </div>

        </section>
    </main>

    <footer>
        <button id="mode-toggle" onclick="toggleMode()">üåû Modo Oscuro / Claro üåô</button>
    </footer>
</div>

<script>
    // =================================================
    // == JAVASCRIPT: L√≥gica del Modelo               ==
    // =================================================

    const factorialCache = { 0: 1, 1: 1 };
    function factorial(n) {
        if (n in factorialCache) return factorialCache[n];
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return factorialCache[n] = result;
    }
    
    // Distribuci√≥n de Poisson: P(X=k | lambda)
    function poisson(k, lambda) {
        if (k < 0) return 0;
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function calculatePredictions() {
        // 1. OBTENER Y VALIDAR PAR√ÅMETROS
        const inputs = ['gl_l', 'gl_v', 'gf_l', 'gc_l', 'gf_v', 'gc_v', 'correlation_factor'];
        const params = {};
        for (const id of inputs) {
            params[id] = parseFloat(document.getElementById(id).value);
            if (isNaN(params[id]) || params[id] < 0) {
                alert('Error: Introduce valores num√©ricos no negativos v√°lidos en todos los campos.');
                return;
            }
        }
        const { gl_l, gl_v, gf_l, gc_l, gf_v, gc_v, correlation_factor: CORR_FACTOR } = params;

        // 2. CALCULAR TASAS ESPERADAS ($\lambda$)
        // $\lambda_{\text{Local}} = \text{Fuerza\_Ataque}_{\text{L}} \times \text{Debilidad\_Defensa}_{\text{V}} \times \text{Media\_Local}$
        const lambdaL = (gf_l / gl_l) * (gc_v / gl_v) * gl_l;
        const lambdaV = (gf_v / gl_v) * (gc_l / gl_l) * gl_v;

        // 3. GENERAR MATRIZ INICIAL (POISSON INDEPENDIENTE)
        const maxGoals = 4;
        let probMatrix = [];
        let totalProb = 0;

        // Funci√≥n auxiliar para calcular P(X >= maxGoals)
        const P_plus = (lambda) => 1 - Array.from({ length: maxGoals }, (_, k) => poisson(k, lambda)).reduce((a, b) => a + b, 0);

        for (let i = 0; i <= maxGoals; i++) {
            probMatrix[i] = [];
            for (let j = 0; j <= maxGoals; j++) {
                // C√°lculo de P(L=i) y P(V=j)
                const probL = (i < maxGoals) ? poisson(i, lambdaL) : P_plus(lambdaL);
                const probV = (j < maxGoals) ? poisson(j, lambdaV) : P_plus(lambdaV);
                
                probMatrix[i][j] = probL * probV;
                totalProb += probMatrix[i][j];
            }
        }
        
        // Normalizaci√≥n inicial
        let normalizedProbMatrix = probMatrix.map(row => row.map(p => p / totalProb));

        // 4. APLICAR CORRECCI√ìN EMP√çRICA (Correlated Double Poisson Simplificado)
        
        // Probabilidades de Empate antes de la correcci√≥n.
        const prob00_orig = normalizedProbMatrix[0][0];
        const prob11_orig = normalizedProbMatrix[1][1];
        
        // El factor total se aplica proporcionalmente a 0-0 y 1-1
        normalizedProbMatrix[0][0] += CORR_FACTOR / 2;
        normalizedProbMatrix[1][1] += CORR_FACTOR / 2;
        
        // Factor de reducci√≥n para el resto de los resultados (para que sumen 1.0)
        const sumNonDraws_Original = 1.0 - (prob00_orig + prob11_orig);
        const sumNonDraws_Required = 1.0 - (normalizedProbMatrix[0][0] + normalizedProbMatrix[1][1]);
        const reductionFactor = sumNonDraws_Required / sumNonDraws_Original;
        
        let finalProbMatrix = [];
        let finalTotalProb = 0;

        for (let i = 0; i <= maxGoals; i++) {
            finalProbMatrix[i] = [];
            for (let j = 0; j <= maxGoals; j++) {
                if (!((i === 0 && j === 0) || (i === 1 && j === 1))) {
                    // Reducir la probabilidad de todos los dem√°s marcadores
                    finalProbMatrix[i][j] = normalizedProbMatrix[i][j] * reductionFactor;
                } else {
                    // Mantener los valores corregidos para 0-0 y 1-1
                    finalProbMatrix[i][j] = normalizedProbMatrix[i][j];
                }
                finalTotalProb += finalProbMatrix[i][j];
            }
        }
        
        // Reajuste final por redondeo si finalTotalProb no es exactamente 1.0
        const FINAL_NORM = 1.0 / finalTotalProb;
        finalProbMatrix = finalProbMatrix.map(row => row.map(p => p * FINAL_NORM));


        // 5. CALCULAR MERCADOS FINALES
        let prob1 = 0, probX = 0, prob2 = 0;
        let probOU15 = 0, probOU25 = 0, probOU35 = 0;
        let probBTTS = 0;
        
        for (let i = 0; i <= maxGoals; i++) {
            for (let j = 0; j <= maxGoals; j++) {
                const P = finalProbMatrix[i][j];
                if (i > j) { prob1 += P; }
                else if (i === j) { probX += P; }
                else { prob2 += P; }
                
                const totalGoals = (i === maxGoals ? maxGoals : i) + (j === maxGoals ? maxGoals : j);
                
                if (totalGoals > 1.5) { probOU15 += P; }
                if (totalGoals > 2.5) { probOU25 += P; }
                if (totalGoals > 3.5) { probOU35 += P; }

                if (i >= 1 && j >= 1) { probBTTS += P; }
            }
        }
        
        // 6. MOSTRAR RESULTADOS
        
        const markets = [
            { name: '1 (Local Gana)', prob: prob1, type: 'win' },
            { name: 'X (Empate)', prob: probX, type: 'draw' },
            { name: '2 (Visitante Gana)', prob: prob2, type: 'loss' },
            { name: 'Over 1.5 Goles', prob: probOU15, type: 'over' },
            { name: 'Under 1.5 Goles', prob: 1 - probOU15, type: 'under' },
            { name: 'Over 2.5 Goles', prob: probOU25, type: 'over' },
            { name: 'Under 2.5 Goles', prob: 1 - probOU25, type: 'under' },
            { name: 'Over 3.5 Goles', prob: probOU35, type: 'over' },
            { name: 'Under 3.5 Goles', prob: 1 - probOU35, type: 'under' },
            { name: 'Ambos Anotan (S√≠)', prob: probBTTS, type: 'btts' },
            { name: 'Ambos Anotan (No)', prob: 1 - probBTTS, type: 'btts' }
        ];

        // 6.1 Tabla de Probabilidades y Cuotas
        const tableBody = document.querySelector('#prob-odds-table tbody');
        tableBody.innerHTML = '';
        
        let valueSuggestionsHTML = '';
        let hasValue = false;
        
        markets.forEach(m => {
            const probPercent = (m.prob * 100).toFixed(2);
            const impliedOdd = (1 / m.prob).toFixed(2);
            // Criterio de Valor: Edge Requerido de 0.10 (10%)
            const minOddValue = (1 / m.prob + 0.10).toFixed(2); 

            let rowClass = (m.type === 'win') ? 'highlight-win' : 
                           (m.type === 'draw') ? 'highlight-draw' : 
                           (m.type === 'loss') ? 'highlight-loss' : '';
            
            tableBody.innerHTML += `
                <tr class="${rowClass}">
                    <td>${m.name}</td>
                    <td>${probPercent}%</td>
                    <td>$${impliedOdd}</td>
                    <td>$${minOddValue}</td>
                </tr>
            `;
            
            // 6.3 Sugerencias de Valor (Simulaci√≥n de Edge)
            // Simulaci√≥n: Si la probabilidad es alta y la cuota es significativamente mejor que la impl√≠cita.
            let simulatedOdd = 0;
            if (m.prob >= 0.70) simulatedOdd = (impliedOdd + 0.15); // Edge en mercados muy probables
            else if (m.prob >= 0.50) simulatedOdd = (impliedOdd + 0.25); // Edge en mercados de valor 50/50

            if (simulatedOdd > 0 && simulatedOdd > parseFloat(minOddValue)) {
                valueSuggestionsHTML += `<p class="value-tip">ü§ë ¬°VALOR EN **${m.name}**! P: ${probPercent}% (Impl.: $${impliedOdd}). Si la casa ofrece **$${simulatedOdd.toFixed(2)}**, ¬°es **Edge**!</p>`;
                hasValue = true;
            }
        });
        
        document.getElementById('value-suggestions').innerHTML = hasValue ? valueSuggestionsHTML : `<p class="no-value-msg">No se encontraron sugerencias de valor significativas con el criterio actual. Ajusta los par√°metros de entrada o el factor de correlaci√≥n.</p>`;
        

        // 6.2 Matriz Visual de Marcadores
        const matrixTable = document.getElementById('score-matrix');
        let maxProbScore = { i: -1, j: -1, prob: -1 };
        
        for (let i = 0; i <= maxGoals; i++) {
            const row = matrixTable.rows[i + 1];
            for (let j = 0; j <= maxGoals; j++) {
                const cell = row.cells[j + 1];
                const P = finalProbMatrix[i][j];
                const probPercent = (P * 100).toFixed(2) + '%';
                
                cell.textContent = probPercent;
                cell.className = '';

                if (P > maxProbScore.prob) {
                    maxProbScore = { i: i, j: j, prob: P };
                }
            }
        }
        
        if (maxProbScore.i !== -1) {
            matrixTable.rows[maxProbScore.i + 1].cells[maxProbScore.j + 1].classList.add('max-prob');
        }
    }
    
    // Funci√≥n para alternar Modo Oscuro/Claro
    function toggleMode() {
        const body = document.body;
        const button = document.getElementById('mode-toggle');
        
        body.classList.toggle('dark-mode');
        body.classList.toggle('light-mode');
        
        const isDarkMode = body.classList.contains('dark-mode');
        button.innerHTML = isDarkMode ? 'üåû Modo Claro üåô' : 'üåû Modo Oscuro / Claro üåô';
    }
    
    document.addEventListener('DOMContentLoaded', calculatePredictions);
</script>

</body>
</html>

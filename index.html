<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Calculadora de Pronóstico de Fútbol (Poisson)</title>
    <style>
        /* Estilos Base */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: #1a1a2e;
            color: #e0e0e0; 
            min-height: 100vh; 
            width: 100vw;
            display: flex;
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center;
        }
        .container { 
            width: 98vw; 
            max-width: 850px; 
            padding: 40px 30px; 
            margin-top: 15px; 
            margin-bottom: 15px; 
            background-color: #2c2c54; 
            border-radius: 20px; 
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.7); 
        }
        h2 { 
            text-align: center; 
            color: #79d70f; /* Color principal de BP */
            margin-bottom: 5px; 
            font-size: 2.2em; 
        }
        small {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: #ccc;
        }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #f0f0f0;
            font-size: 1.2em; 
        }
        input[type="number"], input[type="text"], .result-select { 
            padding: 12px;
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 3px solid #4a4e69; 
            border-radius: 10px; 
            background-color: #3e3e6b; 
            color: #ffffff; 
            font-size: 1.1em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        button { 
            padding: 20px; 
            background-color: #79d70f; /* Color principal de BP */
            color: #1a1a2e; 
            border: none; 
            border-radius: 10px; 
            width: 100%; 
            cursor: pointer; 
            font-size: 1.4em; 
            font-weight: bold;
            transition: background-color 0.3s; 
            margin-top: 20px;
            margin-bottom: 15px;
        }
        button:hover {
            opacity: 0.9;
        }
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .section-title {
            color: #79d70f; /* Color principal de BP */
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.4em;
            text-align: center;
            border-bottom: 2px solid #3a3a5e;
            padding-bottom: 8px;
        }
        .resultado { 
            margin-top: 30px; 
            padding: 25px; 
            border: 4px dashed #79d70f; /* Color principal de BP */
            border-radius: 15px; 
            background-color: #3a3a5e;
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
        }
        .resultado p { 
            margin: 10px 0; 
            font-size: 1.4em; 
            display: flex;
            justify-content: space-between;
        }
        .resultado strong { 
            color: #92e62c; /* Tono de verde más claro */
            font-weight: bold;
        }
        .input-manual-data {
            border: 1px solid #79d70f; /* Color principal de BP */
            padding: 15px;
            border-radius: 10px;
        }
        .manual-data-title {
            color: #79d70f; /* Color principal de BP */
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        /* Estilos de Pestañas */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: 2px solid #4a4e69;
            border-bottom: none;
            background-color: #4a4e69;
            color: #f0f0f0;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
            transition: background-color 0.3s, color 0.3s;
            margin: 0 5px;
        }
        .tab-button.active {
            background-color: #79d70f;
            color: #1a1a2e;
            border-color: #79d70f;
        }
        .tab-content {
            padding: 20px;
            border: 2px solid #79d70f;
            border-radius: 0 0 10px 10px;
            background-color: #3a3a5e;
            display: none; /* Oculto por defecto */
        }
        .tab-content.active {
            display: block; /* Muestra activo */
        }
        
        /* Estilos de Valor, Stake */
        .selection-box {
            background-color: #4a4e69; 
            border: 2px solid #555; 
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 1.3em;
            text-align: center;
        }
        
        .stake-1 { background-color: #a83232; border-color: #ff8080; } 
        .stake-2 { background-color: #a88d32; border-color: #ffe180; } 
        .stake-3 { background-color: #32a83e; border-color: #80ff8c; } 
        .value-alert {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background-color: #f7a400; 
            color: #1a1a2e;
            font-weight: bold;
            font-size: 1em;
            text-align: center;
        }
        .kelly-suggestion {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            border: 2px solid;
            background-color: #3c096c; 
        }

        /* Estilos de la Guía de Correlación */
        .lambda3-guide details {
            background-color: #3e3e6b;
            border: 1px solid #79d70f;
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
        }
        .lambda3-guide summary {
            font-weight: bold;
            color: #79d70f;
            cursor: pointer;
            outline: none;
            padding: 5px;
            list-style: none;
        }
        .lambda3-guide summary::before {
            content: 'ⓘ ';
            margin-right: 5px;
        }
        .guide-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .guide-table th, .guide-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #4a4e69;
        }
        .guide-table th {
            background-color: #2c2c54;
            color: #79d70f;
        }
        .guide-table td:nth-child(3) {
            font-weight: bold;
            color: #92e62c;
        }

    </style>
</head>
<body>
    <div class="container">
        <h2>⚽ Calculadora de Pronóstico</h2>
        <small>Modelos: **Poisson Estándar (SP)** vs. **Poisson Bivariante (BP)**</small>
        
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('standard_poisson', 'SP', event)">Poisson Estándar (SP)</button>
            <button class="tab-button" onclick="openTab('bivariate_poisson', 'BP', event)">Poisson Bivariante (BP)</button>
        </div>
        
        <div id="standard_poisson" class="tab-content active" style="border-color:#79d70f;">
            <div class="section-title" style="color:#79d70f; border-color:#79d70f;">Parámetros del Modelo SP ($\lambda_L, \lambda_V$)</div>
            <div class="input-group">
                <div class="input-manual-data" style="border-color:#79d70f;">
                    <div class="manual-data-title" style="color:#79d70f;">Equipo Local ($\lambda_L$)</div>
                    <label for="lambda_L_SP">Goles Esperados Local:</label>
                    <input type="number" id="lambda_L_SP" placeholder="Ej: 1.75" step="0.01" min="0" value="1.75" onfocus="this.select()">
                </div>

                <div class="input-manual-data" style="border-color:#79d70f;">
                    <div class="manual-data-title" style="color:#79d70f;">Equipo Visitante ($\lambda_V$)</div>
                    <label for="lambda_V_SP">Goles Esperados Visitante:</label>
                    <input type="number" id="lambda_V_SP" placeholder="Ej: 0.95" step="0.01" min="0" value="0.95" onfocus="this.select()">
                </div>
            </div>
            <small style="color: #79d70f;">El modelo SP asume que los goles de ambos equipos son eventos independientes.</small>
        </div>

        <div id="bivariate_poisson" class="tab-content" style="border-color:#79d70f;">
            <div class="section-title" style="color:#79d70f; border-color:#79d70f;">Parámetros del Modelo BP ($\lambda_L, \lambda_V, \lambda_3$)</div>
            <div class="input-group">
                <div class="input-manual-data" style="border-color:#79d70f;">
                    <div class="manual-data-title" style="color:#79d70f;">Equipo Local ($\lambda_L$)</div>
                    <label for="lambda_L_BP">Goles Esperados Local:</label>
                    <input type="number" id="lambda_L_BP" placeholder="Ej: 1.75" step="0.01" min="0" value="1.75" onfocus="this.select()">
                </div>

                <div class="input-manual-data" style="border-color:#79d70f;">
                    <div class="manual-data-title" style="color:#79d70f;">Equipo Visitante ($\lambda_V$)</div>
                    <label for="lambda_V_BP">Goles Esperados Visitante:</label>
                    <input type="number" id="lambda_V_BP" placeholder="Ej: 0.95" step="0.01" min="0" value="0.95" onfocus="this.select()">
                </div>
            </div>
            
            <div class="input-group">
                <div style="grid-column: 1 / -1; margin-top: -10px;">
                    <label for="lambda_3">Correlación ($\lambda_3$):</label>
                    <input type="number" id="lambda_3" placeholder="Ej: 0.20" step="0.01" min="0" value="0.20" onfocus="this.select()">
                    <small>Se recomienda $\lambda_3 > 0$ para corregir la subestimación de empates.</small>
                    
                    <div class="lambda3-guide">
                        <details>
                            <summary>Guía Heurística para $\lambda_3$ (Según Promedio de Goles de Liga)</summary>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #ccc;">Use estos valores como punto de partida si no ha estimado $\lambda_3$ para su liga específica.</p>
                            <table class="guide-table">
                                <thead>
                                    <tr>
                                        <th>Rango GPP (Goles/Partido)</th>
                                        <th>Estilo de Liga Típico</th>
                                        <th>$\lambda_3$ Sugerida</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>**GPP $\ge 3.0$**</td>
                                        <td>Muy Ofensiva (ej. Bundesliga, Eredivisie)</td>
                                        <td>**0.15 a 0.20**</td>
                                    </tr>
                                    <tr>
                                        <td>**GPP $2.7 - 3.0$**</td>
                                        <td>Balance Ofensivo-Alto (ej. Premier League, Serie A)</td>
                                        <td>**0.10 a 0.15**</td>
                                    </tr>
                                    <tr>
                                        <td>**GPP $2.5 - 2.7$**</td>
                                        <td>Balance Estándar (ej. LaLiga, Ligue 1)</td>
                                        <td>**0.05 a 0.10**</td>
                                    </tr>
                                    <tr>
                                        <td>**GPP $< 2.5$**</td>
                                        <td>Defensiva/Baja Puntuación</td>
                                        <td>**$< 0.05$**</td>
                                    </tr>
                                </tbody>
                            </table>
                        </details>
                    </div>
                </div>
            </div>
        </div>
        
        <button onclick="calculateProbabilities()" style="background-color:#79d70f;">CALCULAR PROBABILIDADES</button>

        <div class="resultado" id="resultados_totales" style="border-color:#79d70f;">

            <div class="section-title" style="color:#79d70f; border-color:#79d70f;">Mercados de Goles (Tiempo Completo)</div>
            
            <p>Over 2.5 Goles: <strong id="over25Prob">...</strong></p>
            <p>Under 2.5 Goles: <strong id="under25Prob">...</strong></p>
            <div id="seleccionOverUnder" class="selection-box" style="display:none;"></div>
            
            <div class="section-title" style="color:#79d70f; border-color:#79d70f;">Ambos Anotan (Tiempo Completo)</div>
            <p>BTTS Yes: <strong id="bttsYesProb">...</strong></p>
            <p>BTTS No: <strong id="bttsNoProb">...</strong></p>
            <div id="seleccionBTTS" class="selection-box" style="display:none;"></div>
            
        </div>
        
        <div class="resultado" id="seleccionGlobal" style="margin-top: 20px; border-color: #79d70f; display:none;">
            <div class="section-title" style="color:#79d70f; border-color: #79d70f;">
                🎯 SELECCIÓN GLOBAL MÁS PROBABLE
            </div>
            <div id="globalBestSelection" class="selection-box" style="border-color: #79d70f; background-color: #1a1a2e; color: #79d70f; box-shadow: 0 0 10px rgba(121, 215, 15, 0.5);">
                </div>
        </div>

    </div>

    <script>
        const MAX_GOALS = 6; 
        const BANKROLL_SIZE = 100.00; // Banca total en unidades
        const KELLY_FRACTION = 0.25; // 1/4 de Kelly
        let activeModel = 'SP';

        // =======================================================
        // 1. FUNCIONES DE CÁLCULO
        // =======================================================
        
        function calculateOdds(probability) {
            if (probability <= 0) return '∞';
            return (1 / probability).toFixed(2);
        }

        const formatOutput = (prob) => {
            const percentage = (prob * 100).toFixed(2);
            const odds = calculateOdds(prob);
            return `${percentage}% (Cuota: ${odds})`; 
        };

        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function poisson_prob(k, lambda) {
            if (k < 0 || lambda < 0) return 0;
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }

        // --- POISSON ESTÁNDAR (SP) ---
        function calculateStandardPoissonProbabilities(L_FT, V_FT) {
            let p_total_0 = 0;
            let p_total_1 = 0;
            let p_total_2 = 0;
            let p_btts_ft = 0;
            let p_suma_total_ft = 0;

            for (let L = 0; L <= MAX_GOALS; L++) {
                for (let V = 0; V <= MAX_GOALS; V++) {
                    const P_LV = poisson_prob(L, L_FT) * poisson_prob(V, V_FT);
                    p_suma_total_ft += P_LV; 
                    
                    const total = L + V;
                    if (total === 0) p_total_0 += P_LV;
                    if (total === 1) p_total_1 += P_LV;
                    if (total === 2) p_total_2 += P_LV;
                    
                    if (L > 0 && V > 0) p_btts_ft += P_LV; 
                }
            }
            
            if (p_suma_total_ft === 0) throw new Error("Error de cálculo SP: La suma total de probabilidades es cero.");
            
            p_btts_ft /= p_suma_total_ft;
            
            const p_under_2_5_ft = (p_total_0 + p_total_1 + p_total_2) / p_suma_total_ft;
            
            return {
                p_under_2_5: p_under_2_5_ft, p_over_2_5: 1 - p_under_2_5_ft,
                p_btts_yes: p_btts_ft, p_btts_no: 1 - p_btts_ft,
                modelName: 'SP'
            };
        }
        
        // --- POISSON BIVARIANTE (BP) ---
        function bivariate_poisson_prob(x, y, lambda1, lambda2, lambda3) {
            x = Math.round(x);
            y = Math.round(y);
            
            if (lambda1 < 0 || lambda2 < 0 || lambda3 < 0) return 0; 

            const c = Math.exp(-(lambda1 + lambda2 + lambda3));
            const min_xy = Math.min(x, y);
            
            let sumatoria = 0;
            for (let i = 0; i <= min_xy; i++) {
                const term1 = Math.pow(lambda1, x - i) / factorial(x - i);
                const term2 = Math.pow(lambda2, y - i) / factorial(y - i);
                const term3 = Math.pow(lambda3, i) / factorial(i);
                sumatoria += term1 * term2 * term3;
            }
            
            return c * sumatoria;
        }

        function calculateBPProbabilities(L_FT, V_FT, L3_FT) {
            let p_total_0 = 0;
            let p_total_1 = 0;
            let p_total_2 = 0;
            let p_btts_ft = 0;
            let p_suma_total_ft = 0; 

            const lambda1 = L_FT - L3_FT;
            const lambda2 = V_FT - L3_FT;

            if (lambda1 < 0 || lambda2 < 0) {
                 throw new Error(`Error BP: Correlación ($\lambda_3$: ${L3_FT.toFixed(2)}) es demasiado alta. $\lambda_1$ o $\lambda_2$ son negativos.`);
            }

            for (let L = 0; L <= MAX_GOALS; L++) {
                for (let V = 0; V <= MAX_GOALS; V++) {
                    const P_LV = bivariate_poisson_prob(L, V, lambda1, lambda2, L3_FT);
                    p_suma_total_ft += P_LV; 
                    
                    const total = L + V;
                    if (total === 0) p_total_0 += P_LV;
                    if (total === 1) p_total_1 += P_LV;
                    if (total === 2) p_total_2 += P_LV;
                    
                    if (L > 0 && V > 0) p_btts_ft += P_LV; 
                }
            }
            
            if (p_suma_total_ft === 0) throw new Error("Error de cálculo BP: La suma total de probabilidades es cero.");
            
            p_btts_ft /= p_suma_total_ft;
            
            const p_under_2_5_ft = (p_total_0 + p_total_1 + p_total_2) / p_suma_total_ft;
            
            return {
                p_under_2_5: p_under_2_5_ft, p_over_2_5: 1 - p_under_2_5_ft,
                p_btts_yes: p_btts_ft, p_btts_no: 1 - p_btts_ft,
                modelName: 'BP'
            };
        }


        // =======================================================
        // 2. LÓGICA DE TABS
        // =======================================================
        function openTab(tabName, model, event) {
            let i, tabcontent, tablinks;
            
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }

            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            
            event.currentTarget.classList.add("active");
            
            activeModel = model;
            
            updateResultsDisplay(null);
        }

        // =======================================================
        // 3. LÓGICA DE STAKE (Kelly Fraccional 1/4)
        // =======================================================
        
        function calculateStakeByKelly(prob_model, odds_bookie) {
            if (prob_model <= 0 || odds_bookie <= 1.0) return { stake: 0, kelly_fraction: 0, amount: 0, value: 0 };
            
            const impliedProb = 1 / odds_bookie;
            // B = odds - 1
            const odds_minus_one = odds_bookie - 1;
            
            // Edge (Ventaja)
            const edge = prob_model - impliedProb;
            
            if (edge <= 0) return { stake: 0, kelly_fraction: 0, amount: 0, value: 0 };
            
            // Kelly Fraccional (f = (p * B - q) / B)
            // p = prob_model
            // q = 1 - p
            // B = odds_minus_one
            let kelly_full_fraction = (prob_model * odds_minus_one - (1 - prob_model)) / odds_minus_one;
            
            // Aseguramos que no se exceda el 100% de la banca si Kelly es muy grande
            kelly_full_fraction = Math.min(1.0, kelly_full_fraction);
            
            // Aplicamos la fracción de Kelly deseada (1/4 = 0.25)
            const kelly_final_fraction = kelly_full_fraction * KELLY_FRACTION;
            
            // Cálculo del monto a apostar en unidades
            const amount = BANKROLL_SIZE * kelly_final_fraction; 
            
            // Determinación del Stake 1, 2, 3 basado en la FRACCIÓN FINAL (para la representación visual)
            let stake;
            let percentage = kelly_final_fraction * 100;

            if (percentage >= 2.5) { // 2.5% de Banca (1/4 de 10%)
                stake = 3;
            } else if (percentage >= 1.0) { // 1.0% de Banca (1/4 de 4%)
                stake = 2;
            } else { 
                stake = 1; // Menos de 1%
            }

            return { 
                stake: stake, 
                percentage: percentage, 
                amount: amount, 
                value: edge * 100 // Margen de valor en porcentaje
            };
        }

        function checkValueAndKelly(inputElementId, selectionId) {
            const inputElement = document.getElementById(inputElementId);
            const bookieOdds = parseFloat(inputElement.value);
            const selectionBox = document.getElementById(selectionId);
            const marketId = selectionId.replace('seleccion', '');
            const calculatedProb = parseFloat(selectionBox.getAttribute('data-prob'));

            const valueAlert = document.getElementById(`value_alert_${marketId}`);
            const kellySuggestion = document.getElementById(`kelly_sug_${marketId}`);
            
            valueAlert.style.display = 'none';
            kellySuggestion.style.display = 'none';
            kellySuggestion.className = 'kelly-suggestion'; 

            if (isNaN(bookieOdds) || bookieOdds <= 1.0 || isNaN(calculatedProb) || calculatedProb <= 0) return;
            
            const stakeResult = calculateStakeByKelly(calculatedProb, bookieOdds);
            const stake = stakeResult.stake;
            const amount = stakeResult.amount;
            const valueDifference = stakeResult.value;
            const percentage = stakeResult.percentage;

            if (valueDifference > 0) {
                valueAlert.style.display = 'block';
                valueAlert.innerHTML = `⚠️ **¡VALOR ENCONTRADO!** Margen: ${valueDifference.toFixed(2)}%`;
            }

            // Solo mostramos la sugerencia si hay un stake asignado (es decir, kelly > 0)
            if (stake > 0 && amount > 0.01) { 
                kellySuggestion.style.display = 'block';
                kellySuggestion.innerHTML = `
                    Stake Sugerido: <span>${stake}/3</span>
                    (Apostar **${amount.toFixed(2)} Unidades**, ${percentage.toFixed(2)}% de Banca | ${KELLY_FRACTION * 100}% de Kelly)`;
                
                kellySuggestion.classList.remove('stake-1', 'stake-2', 'stake-3');
                if (stake === 1) kellySuggestion.classList.add('stake-1');
                else if (stake === 2) kellySuggestion.classList.add('stake-2');
                else if (stake === 3) kellySuggestion.classList.add('stake-3');
            }
        }

        function generateInputHtml(selectionId) {
            const marketId = selectionId.replace('seleccion', '');
            const inputId = `cuota_bookie_${marketId}`;
            const checkValueCall = `checkValueAndKelly('${inputId}', '${selectionId}')`;
            
            return `
                <div class="bookie-input-group">
                    <label for="${inputId}">Cuota de Casa de Apuestas:</label>
                    <input type="number" id="${inputId}" step="0.01" min="1.01" 
                           onchange="${checkValueCall}" onkeyup="${checkValueCall}">
                </div>
                <div id="value_alert_${marketId}" class="value-alert" style="display:none;"></div>
                <div id="kelly_sug_${marketId}" class="kelly-suggestion" style="display:none;"></div>
            `;
        }
        
        // =======================================================
        // 4. FUNCIÓN PRINCIPAL DE CÁLCULO (Controlador)
        // =======================================================
        
        function calculateProbabilities() {
            try {
                let results;
                
                if (activeModel === 'SP') {
                    const lambda_L = parseFloat(document.getElementById('lambda_L_SP').value);
                    const lambda_V = parseFloat(document.getElementById('lambda_V_SP').value);
                    
                    if (isNaN(lambda_L) || isNaN(lambda_V) || lambda_L < 0 || lambda_V < 0) {
                         throw new Error("Error SP: Por favor, ingresa valores numéricos válidos ($\lambda \\ge 0$).");
                    }
                    results = calculateStandardPoissonProbabilities(lambda_L, lambda_V);
                    
                } else if (activeModel === 'BP') {
                    const lambda_L = parseFloat(document.getElementById('lambda_L_BP').value);
                    const lambda_V = parseFloat(document.getElementById('lambda_V_BP').value);
                    const lambda_3 = parseFloat(document.getElementById('lambda_3').value);
                    
                    if (isNaN(lambda_L) || isNaN(lambda_V) || isNaN(lambda_3) || lambda_L < 0 || lambda_V < 0 || lambda_3 < 0) {
                         throw new Error("Error BP: Por favor, ingresa valores numéricos válidos ($\lambda \\ge 0$).");
                    }
                    results = calculateBPProbabilities(lambda_L, lambda_V, lambda_3);
                }
                
                updateResultsDisplay(results);

            } catch (error) {
                alert(error.message);
                updateResultsDisplay(null);
            }
        }
        
        function findBestSelectionInMarket(probabilities, labels) {
            let maxProb = 0;
            let bestLabel = "";

            for (let i = 0; i < probabilities.length; i++) {
                if (probabilities[i] > maxProb) {
                    maxProb = probabilities[i];
                    bestLabel = labels[i];
                }
            }
            let boxId = "";
            if (labels.includes("Over 2.5 Goles")) boxId = "seleccionOverUnder";
            else if (labels.includes("BTTS Yes (Sí)")) boxId = "seleccionBTTS";
            
            return { 
                label: bestLabel, 
                probability: maxProb, 
                odds: calculateOdds(maxProb),
                boxId: boxId,
            };
        }

        function displaySelection(selection, isGlobalBest) {
            const element = document.getElementById(selection.boxId);
            
            element.setAttribute('data-prob', selection.probability);

            let rankMarker = '⭐ Recomendación';
            let oddsDisplay = `(Cuota: ${selection.odds})`; 
            
            const color = '#79d70f'; 
            
            element.style.borderColor = color; 
            element.style.backgroundColor = '#4a4e69';
            
            if (isGlobalBest) {
                rankMarker = `<span style="color:${color};">🔥 Mejor Recomendación del Mercado (${activeModel})</span>`;
            } else {
                rankMarker = `⭐ Recomendación (${activeModel})`;
            }
            
            element.style.display = 'block';
            element.style.textAlign = 'left';

            let contentHTML = `
                <div style="text-align:center; font-weight:bold; margin-bottom:10px;">
                    ${rankMarker}
                </div>
                <div style="font-size: 1.5em; font-weight: bold; color: ${color}; text-align:center;">
                    <span>${selection.label}</span>
                </div>
                <div style="text-align:center; margin-top:5px; font-size:1em;">
                    Probabilidad: <strong>${(selection.probability * 100).toFixed(2)}%</strong> 
                    ${oddsDisplay} 
                </div>
                <hr style="border-top: 1px solid #555; margin: 15px 0;">
                ${generateInputHtml(selection.boxId)}
            `;

            element.innerHTML = contentHTML;
        }
        
        function displayGlobalBest(selection) {
            const element = document.getElementById('globalBestSelection');
            const container = document.getElementById('seleccionGlobal');
            
            container.style.display = 'block';
            
            const color = '#79d70f'; 

            element.innerHTML = `
                <span style="font-size: 1.5em; font-weight: bold; color: ${color};">${selection.label}</span>
                <br>
                Modelo Usado: **${activeModel}** | 
                Probabilidad: **${(selection.probability * 100).toFixed(2)}%** | 
                Cuota Implícita: **${selection.odds}**
            `;
            container.style.borderColor = color;
            element.style.borderColor = color;
            element.style.boxShadow = `0 0 10px ${color}80`; 
        }


        function updateResultsDisplay(results) {
            if (!results) {
                document.getElementById('over25Prob').textContent = '...';
                document.getElementById('under25Prob').textContent = '...';
                document.getElementById('bttsYesProb').textContent = '...';
                document.getElementById('bttsNoProb').textContent = '...';
                document.getElementById('seleccionOverUnder').style.display = 'none';
                document.getElementById('seleccionBTTS').style.display = 'none';
                document.getElementById('seleccionGlobal').style.display = 'none';
                return;
            }

            document.getElementById('over25Prob').textContent = formatOutput(results.p_over_2_5);
            document.getElementById('under25Prob').textContent = formatOutput(results.p_under_2_5);
            document.getElementById('bttsYesProb').textContent = formatOutput(results.p_btts_yes);
            document.getElementById('bttsNoProb').textContent = formatOutput(results.p_btts_no);
            
            
            const selectionOverUnder = findBestSelectionInMarket(
                [results.p_over_2_5, results.p_under_2_5],
                ["Over 2.5 Goles", "Under 2.5 Goles"]
            );
            
            const selectionBTTS = findBestSelectionInMarket(
                [results.p_btts_yes, results.p_btts_no],
                ["BTTS Yes (Sí)", "BTTS No (No)"]
            );
            
            const allOptions = [
                { label: 'Over 2.5 Goles', prob: results.p_over_2_5, boxId: 'seleccionOverUnder' },
                { label: 'Under 2.5 Goles', prob: results.p_under_2_5, boxId: 'seleccionOverUnder' },
                { label: 'BTTS Yes (Sí)', prob: results.p_btts_yes, boxId: 'seleccionBTTS' },
                { label: 'BTTS No (No)', prob: results.p_btts_no, boxId: 'seleccionBTTS' }
            ];
            
            allOptions.sort((a, b) => b.prob - a.prob);
            const globalBest = {
                label: allOptions[0].label,
                probability: allOptions[0].prob,
                odds: calculateOdds(allOptions[0].prob),
                boxId: allOptions[0].boxId
            };
            
            const isOUEqualsGlobal = selectionOverUnder.label === globalBest.label;
            displaySelection(selectionOverUnder, isOUEqualsGlobal);

            const isBTTSEqualsGlobal = selectionBTTS.label === globalBest.label;
            displaySelection(selectionBTTS, isBTTSEqualsGlobal);
            
            displayGlobalBest(globalBest);


            setTimeout(() => {
                const markets = ['OverUnder', 'BTTS'];
                markets.forEach(m => {
                    const inputId = `cuota_bookie_${m}`;
                    const selectionId = `seleccion${m}`;
                    const input = document.getElementById(inputId);
                    if (input && input.value) {
                         checkValueAndKelly(inputId, selectionId);
                    }
                });
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa mostrando la pestaña SP
            document.getElementById('standard_poisson').style.display = "block";
            activeModel = 'SP';
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Backtesting Robusto — Detecta patrones y valida resultados</title>
<style>
  :root{--bg:#071225;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4}
  body{background:linear-gradient(180deg,var(--bg),#000);color:white;font-family:sans-serif;margin:0;padding:2rem}
  h1{text-align:center;color:var(--accent)}
  .card{background:var(--card);padding:1rem;margin:1rem auto;max-width:1000px;border-radius:8px}
  table{width:100%;border-collapse:collapse;margin-top:1rem}
  th,td{padding:6px 10px;border-bottom:1px solid #333;text-align:center}
  th{color:var(--accent)}
  select,input[type=file]{margin:.5rem;padding:.4rem;background:#111;color:white;border:1px solid #333;border-radius:4px}
  #progress{display:none;margin:.5rem 0}
</style>
</head>
<body>
  <h1>Backtesting Robusto</h1>

  <div class="card">
    <input type="file" id="fileInput" />
    <select id="leagueFilter"></select>
    <select id="teamViewSelect">
      <option value="all">Todos</option>
      <option value="home">Solo local</option>
      <option value="away">Solo visitante</option>
    </select>
    <div id="progress">Procesando...</div>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>Métricas</h2>
    <p>Total: <span id="totalMatches">0</span></p>
    <p>Ganados: <span id="ganados">0</span></p>
    <p>Perdidos: <span id="perdidos">0</span></p>
    <p>Profit: <span id="profit">0</span></p>
    <p>ROI: <span id="roi">0%</span></p>
  </div>

  <div class="card">
    <h2>Por Liga</h2>
    <div id="byLeague"></div>
  </div>
  <div class="card">
    <h2>Por Cuota</h2>
    <div id="byOdds"></div>
  </div>
  <div class="card">
    <h2>Por Equipo</h2>
    <div id="byTeam"></div>
  </div>

<script>
// ==================== WORKER ====================
const worker = new Worker(URL.createObjectURL(new Blob([`
  function addTeamLeague(team, liga, obj){
    if(!obj[team]) obj[team] = {};
    if(!obj[team][liga]) obj[team][liga] = {matches:0, ganado:0, perdido:0, profit:0};
    return obj[team][liga];
  }

  onmessage = e=>{
    try{
      const lines = e.data.text.trim().split(/\\n+/);
      const leagues={}, teams={}, oddsBuckets={}, teamLeagues={};
      let total=0,ganado=0,perdido=0,profit=0;

      lines.forEach(line=>{
        const parts = line.split(',');
        if(parts.length<6) return;
        const [liga, local, visitante, outcome, oddStr, result] = parts;
        const odd = parseFloat(oddStr);
        total++;

        const st = {ganado:0,perdido:0,profit:0};
        if(result==="W"){
          st.ganado=1; st.profit=odd-1; ganado++;
          profit+=odd-1;
        }else{
          st.perdido=1; st.profit=-1; perdido++;
          profit-=1;
        }

        // liga
        if(!leagues[liga]) leagues[liga]={matches:0,ganado:0,perdido:0,profit:0};
        Object.assign(leagues[liga],{
          matches:leagues[liga].matches+1,
          ganado:leagues[liga].ganado+st.ganado,
          perdido:leagues[liga].perdido+st.perdido,
          profit:leagues[liga].profit+st.profit
        });

        // equipo local
        if(!teams[local]) teams[local]={matches:0,ganado:0,perdido:0,profit:0};
        Object.assign(teams[local],{
          matches:teams[local].matches+1,
          ganado:teams[local].ganado+st.ganado,
          perdido:teams[local].perdido+st.perdido,
          profit:teams[local].profit+st.profit
        });
        addTeamLeague(local, liga, teamLeagues);
        Object.assign(teamLeagues[local][liga],{
          matches:teamLeagues[local][liga].matches+1,
          ganado:teamLeagues[local][liga].ganado+st.ganado,
          perdido:teamLeagues[local][liga].perdido+st.perdido,
          profit:teamLeagues[local][liga].profit+st.profit
        });

        // equipo visitante
        if(!teams[visitante]) teams[visitante]={matches:0,ganado:0,perdido:0,profit:0};
        Object.assign(teams[visitante],{
          matches:teams[visitante].matches+1,
          ganado:teams[visitante].ganado+st.ganado,
          perdido:teams[visitante].perdido+st.perdido,
          profit:teams[visitante].profit+st.profit
        });
        addTeamLeague(visitante, liga, teamLeagues);
        Object.assign(teamLeagues[visitante][liga],{
          matches:teamLeagues[visitante][liga].matches+1,
          ganado:teamLeagues[visitante][liga].ganado+st.ganado,
          perdido:teamLeagues[visitante][liga].perdido+st.perdido,
          profit:teamLeagues[visitante][liga].profit+st.profit
        });

        // cuotas
        const bucket = Math.floor(odd*2)/2;
        if(!oddsBuckets[bucket]) oddsBuckets[bucket]={matches:0,ganado:0,perdido:0,profit:0};
        Object.assign(oddsBuckets[bucket],{
          matches:oddsBuckets[bucket].matches+1,
          ganado:oddsBuckets[bucket].ganado+st.ganado,
          perdido:oddsBuckets[bucket].perdido+st.perdido,
          profit:oddsBuckets[bucket].profit+st.profit
        });
      });

      postMessage({
        ok:true,
        metrics:{total,ganado,perdido,profit,roi:profit/total},
        leagues,teams,oddsBuckets,teamLeagues
      });
    }catch(err){
      postMessage({ok:false,error:err.message});
    }
  };
`], { type: 'application/javascript' })));

// ==================== MAIN SCRIPT ====================
const fileInput = document.getElementById('fileInput');
const progress = document.getElementById('progress');
const status = document.getElementById('status');

fileInput.addEventListener('change', handleFile);

function handleFile(evt){
  const file = evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    const text = e.target.result;
    progress.style.display = 'block';
    status.textContent = 'Procesando archivo...';
    worker.postMessage({text});
  };
  reader.readAsText(file);
}

worker.onmessage = e => {
  progress.style.display = 'none';
  status.textContent = '';
  if(!e.data.ok){
    alert('Error en worker: ' + e.data.error);
    return;
  }

  const m = e.data.metrics;

  // (2) poblar ligas dinámicamente
  const leagueSelect = document.getElementById('leagueFilter');
  leagueSelect.innerHTML = '<option value="all">Todas</option>';
  Object.keys(e.data.leagues).forEach(liga=>{
    const opt = document.createElement('option');
    opt.value = liga;
    opt.textContent = liga;
    leagueSelect.appendChild(opt);
  });
  // guardar resultados globales
  window._lastWorkerResult = e.data;

  // métricas
  document.getElementById('totalMatches').textContent = m.total;
  document.getElementById('ganados').textContent = m.ganado;
  document.getElementById('perdidos').textContent = m.perdido;
  document.getElementById('profit').textContent = m.profit.toFixed(2);
  document.getElementById('roi').textContent = (m.roi*100).toFixed(2)+"%";

  renderGroupTable(e.data.leagues, 'byLeague', 'Liga');
  renderOddsTable(e.data.oddsBuckets, 'byOdds', 'Rango cuota');
  renderTeamDetailed(e.data.teams, 'byTeam');
};

// cambio de vista equipos
document.getElementById('teamViewSelect').addEventListener('change', ()=>{
  if(window._lastWorkerResult && window._lastWorkerResult.teams){
    renderTeamDetailed(window._lastWorkerResult.teams, 'byTeam');
  }
});

// (3) cambio de liga
document.getElementById('leagueFilter').addEventListener('change', ()=>{
  if(window._lastWorkerResult && window._lastWorkerResult.teams){
    renderTeamDetailed(window._lastWorkerResult.teams, 'byTeam');
  }
});

// ==================== RENDER HELPERS ====================
function renderGroupTable(obj, containerId, label){
  const cont = document.getElementById(containerId);
  let html = "<table><tr><th>"+label+"</th><th>Partidos</th><th>Ganados</th><th>Perdidos</th><th>Profit</th></tr>";
  Object.entries(obj).forEach(([k,v])=>{
    html += "<tr><td>"+k+"</td><td>"+v.matches+"</td><td>"+v.ganado+"</td><td>"+v.perdido+"</td><td>"+v.profit.toFixed(2)+"</td></tr>";
  });
  html += "</table>";
  cont.innerHTML = html;
}

function renderOddsTable(obj, containerId, label){
  const cont = document.getElementById(containerId);
  let html = "<table><tr><th>"+label+"</th><th>Partidos</th><th>Ganados</th><th>Perdidos</th><th>Profit</th></tr>";
  Object.entries(obj).forEach(([k,v])=>{
    html += "<tr><td>"+k+"</td><td>"+v.matches+"</td><td>"+v.ganado+"</td><td>"+v.perdido+"</td><td>"+v.profit.toFixed(2)+"</td></tr>";
  });
  html += "</table>";
  cont.innerHTML = html;
}

function renderTeamDetailed(obj, containerId){
  const ligaSel = document.getElementById('leagueFilter').value;
  const viewSel = document.getElementById('teamViewSelect').value;
  const cont = document.getElementById(containerId);
  let html = "<table><tr><th>Equipo</th><th>Partidos</th><th>Ganados</th><th>Perdidos</th><th>Profit</th></tr>";

  Object.entries(obj).forEach(([team,v])=>{
    // si hay filtro por liga
    if(ligaSel!=="all" && window._lastWorkerResult.teamLeagues[team]){
      if(!window._lastWorkerResult.teamLeagues[team][ligaSel]) return;
      v = window._lastWorkerResult.teamLeagues[team][ligaSel];
    }

    html += "<tr><td>"+team+"</td><td>"+v.matches+"</td><td>"+v.ganado+"</td><td>"+v.perdido+"</td><td>"+v.profit.toFixed(2)+"</td></tr>";
  });

  html += "</table>";
  cont.innerHTML = html;
}
</script>
</body>
</html>
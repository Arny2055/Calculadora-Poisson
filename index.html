<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Registro de Apuestas PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS GENERALES Y VIEWS --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #E0E0E0;
            padding-bottom: 60px; 
            overflow-x: hidden; 
        }
        .container {
            max-width: 600px; 
            margin: auto;
            background: #1E1E1E;
            min-height: calc(100vh - 60px); 
            padding: 10px;
        }

        /* VISTA √öNICA: Oculta todas las vistas excepto la activa */
        .view {
            padding: 15px 5px;
            display: none; 
            width: 100%;
            box-sizing: border-box;
        }
        .active-view {
            display: block;
        }

        h2, h3 {
            text-align: center;
            color: #BB86FC;
            margin-bottom: 15px;
        }
        
        /* --- BARRA DE NAVEGACI√ìN (NAVBAR) --- */
        #navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: #2C2C2C;
            border-top: 1px solid #333333;
            height: 60px;
            z-index: 1000;
        }
        .nav-item {
            flex-grow: 1;
            text-align: center;
            color: #AAAAAA;
            padding: 5px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7em;
        }
        .nav-item i {
            font-size: 1.2em;
            margin-bottom: 3px;
        }
        .nav-item.active {
            color: #03DAC6; 
            background-color: #333333;
        }

        /* --- CONTROLES Y FORMS --- */
        .section-box {
            padding: 15px;
            border: 1px solid #333333; 
            border-radius: 4px;
            background-color: #2C2C2C;
            margin-bottom: 20px;
        }
        .match-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .match-row label {
            width: 70px;
            font-weight: bold;
            color: #E0E0E0;
            flex-shrink: 0;
        }
        input[type="number"], select, input[type="text"] {
            padding: 10px; 
            border: 1px solid #555555;
            border-radius: 4px;
            background-color: #121212; 
            color: #E0E0E0; 
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Colores de resultados */
        .positive { color: #00A800; font-weight: bold; }
        .negative { color: #CF6679; font-weight: bold; }
        .zero { color: #AAAAAA; font-weight: bold; }
        .pending-text { color: #BB86FC; font-weight: bold; }

        /* --- CALCULADORA DE ROI HIST√ìRICO (COMPLEJO) --- */
        #roi-calculator {
            background-color: #121212;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #BB86FC;
            margin-bottom: 15px;
        }
        #roi-calculator h3 {
            color: #03DAC6;
            margin-top: 0;
        }
        .history-team-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #333;
            border-radius: 4px;
        }
        .history-team-group h4 {
            margin: 0 0 10px 0;
            color: #E0E0E0;
            font-size: 1em;
            text-align: left;
        }
        .history-match-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            align-items: center;
            font-size: 0.8em;
        }
        .history-match-row span {
            width: 10%; 
            font-weight: bold;
            flex-shrink: 0;
            color: #AAAAAA;
        }
        .history-match-row select {
            width: 35%;
            padding: 5px;
            font-size: 0.8em;
            text-align: center;
        }
        .history-match-row input {
            width: 50%;
            padding: 5px;
            font-size: 0.8em;
            text-align: center;
        }
        
        #roi-analysis-results {
            margin-top: 15px;
            padding: 10px;
            border-top: 1px solid #333;
        }
        .roi-display-row {
            display: flex;
            justify-content: space-between;
            font-size: 1em;
            padding: 5px 0;
        }
        .roi-label {
            color: #AAAAAA;
        }
        .roi-value {
            font-weight: bold;
        }
        
        /* Input ROIs de registro (ahora son de solo lectura) */
        .roi-input-group {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        .roi-input-group > div {
            width: 50%;
        }
        .roi-input-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .roi-input-row label {
            width: 30px; 
            color: #03DAC6;
        }
        
        /* Otros Estilos (Historial, etc.) se mantienen igual */
        .history-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        #match-history-table { border-collapse: collapse; width: 100%; min-width: 800px; margin-top: 15px; }
        #match-history-table th, #match-history-table td { border: 1px solid #333333; background-color: #1E1E1E; color: #E0E0E0; padding: 8px 4px; font-size: 0.7em; text-align: center; }
        #match-history-table th { background-color: #333333; color: #BB86FC; border-bottom: 2px solid #BB86FC; }
        .action-cell { min-width: 130px; } 

    </style>
</head>
<body>

    <div class="container">
        <div id="register-view" class="view active-view">
            <section class="section-box">
                <h2 style="color: #6200EE;">üí∏ Registrar Apuesta</h2>
                
                <div id="roi-calculator">
                    <h3>üìä An√°lisis de ROI Hist√≥rico (√öltimos 5 Partidos)</h3>
                    
                    <div class="match-row">
                        <label for="reg-quota">Cuota Actual:</label>
                        <input type="number" id="reg-quota" step="0.01" min="1.01" placeholder="Cuota que vas a apostar" required>
                    </div>

                    <p style="margin: 15px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #E0E0E0; border-top: 1px solid #333; padding-top: 10px;">Resultados Hist√≥ricos (G/P + Cuota Apostada con 1U):</p>
                    
                    <div class="history-team-group">
                        <h4>Equipo Local</h4>
                        <script>
                            // Funci√≥n para generar las 5 filas
                            function generateHistoryRows(team) {
                                let html = '';
                                for(let i = 1; i <= 5; i++) {
                                    html += `
                                        <div class="history-match-row">
                                            <span>M${i}:</span>
                                            <select class="calc-${team}-result" onchange="calculateHistoricalROI()">
                                                <option value="1">Ganado (G)</option>
                                                <option value="0" selected>Perdido (P)</option>
                                            </select>
                                            <input type="number" class="calc-${team}-odd" step="0.01" min="1.01" oninput="calculateHistoricalROI()" placeholder="Cuota">
                                        </div>
                                    `;
                                }
                                return html;
                            }
                            document.write(generateHistoryRows('local'));
                        </script>
                    </div>

                    <div class="history-team-group">
                        <h4>Equipo Visitante</h4>
                        <script>
                            document.write(generateHistoryRows('visitor'));
                        </script>
                    </div>

                    
                    <div id="roi-analysis-results">
                        <p style="text-align: center; color: #BB86FC; font-weight: bold; margin-bottom: 10px;">ROI/Yield Hist√≥rico Calculado (basado en Stake 1U):</p>
                        <div class="roi-display-row">
                            <span class="roi-label">ROI Local (L.):</span>
                            <span id="calc-roi-local" class="roi-value zero">0.00%</span>
                        </div>
                        <div class="roi-display-row">
                            <span class="roi-label">ROI Visitante (V.):</span>
                            <span id="calc-roi-visitor" class="roi-value zero">0.00%</span>
                        </div>
                        <div class="roi-display-row" style="font-size: 1.1em; border-top: 1px dotted #333; padding-top: 10px;">
                            <span class="roi-label" style="color: #03DAC6;">ROI/Yield Promedio:</span>
                            <span id="calc-roi-general" class="roi-value zero">0.00%</span>
                        </div>
                    </div>
                </div>
                
                <p style="margin: 15px 0 5px 0; font-size: 1em; font-weight: bold; color: #BB86FC; border-top: 1px solid #333; padding-top: 10px;">Datos del Partido:</p>
                <div class="match-row">
                    <label for="reg-home">Local:</label>
                    <input type="text" id="reg-home" placeholder="Nombre Local" required>
                </div>
                <div class="match-row">
                    <label for="reg-away">Visitante:</label>
                    <input type="text" id="reg-away" placeholder="Nombre Visitante" required>
                </div>
                <div class="match-row">
                    <label for="reg-market">Mercado:</label>
                    <select id="reg-market">
                        <option value="OU">Over/Under</option>
                        <option value="BTTS">BTTS</option>
                    </select>
                </div>

                <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #03DAC6;">ROIs An√°lisis (Autom√°tico/Hist√≥rico):</p>
                <div class="roi-input-group">
                    <div class="roi-input-row">
                        <label>L.:</label>
                        <input type="text" id="reg-roi-local" readonly value="0.00">
                    </div>
                    <div class="roi-input-row">
                        <label>V.:</label>
                        <input type="text" id="reg-roi-visitor" readonly value="0.00">
                    </div>
                </div>

                <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #E0E0E0;">Datos de Apuesta Actual:</p>
                <div class="match-row">
                    <label for="reg-stake">Stake (U.):</label>
                    <input type="number" id="reg-stake" step="0.1" min="0.1" placeholder="Ej: 1.5 Unidades" required>
                </div>
                
                <div class="match-row">
                    <label for="reg-result">Resultado:</label>
                    <select id="reg-result" onchange="applyResultStyle(this)" class="result-default" required>
                        <option value="" selected disabled>-- Selecciona --</option>
                        <option value="1">Ganado</option>
                        <option value="0">Perdido</option>
                        <option value="-1">Pendiente</option> 
                    </select>
                </div>
                <button id="save-match-btn" onclick="saveMatchToHistory()">Guardar Apuesta</button>
            </section>
        </div>

        <div id="chart-view" class="view">
            <h2>üìà Progreso de Beneficio Acumulado</h2>
             <div id="historical-roi-summary" class="section-box" style="margin-bottom: 20px;">
                </div>
            <div style="background: #1e1e1e; padding: 15px; border-radius: 8px; height: 300px;">
                <canvas id="profitChart"></canvas>
            </div>
        </div>
        
        <div id="history-view" class="view">
            <h2>üìú Historial Detallado</h2>
            
            <div id="history-filters">
                <select id="filter-result" onchange="filterHistory()">
                    <option value="all">Resultado: Todos</option>
                    <option value="1">Ganado</option>
                    <option value="0">Perdido</option>
                    <option value="-1">Pendiente</option>
                </select>
                <select id="filter-market" onchange="filterHistory()">
                    <option value="all">Mercado: Todos</option>
                    <option value="OU">Over/Under</option>
                    <option value="BTTS">BTTS</option>
                </select>
            </div>

            <div class="history-container">
                <table id="match-history-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Partido</th>
                            <th>Mercado</th>
                            <th>ROI L.</th>
                            <th>ROI V.</th>
                            <th>Stake (U.)</th>
                            <th>Cuota</th>
                            <th>Estado</th>
                            <th>P&L (U.)</th>
                            <th>ROI Gral. (%)</th>
                            <th class="action-cell">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="match-history-body">
                        </tbody>
                </table>
            </div>
            
        </div>
        
        <div id="summary-config-view" class="view">
            <h2>‚öôÔ∏è Configuraci√≥n y Resumen</h2>
            
            <section id="unit-config" class="section-box">
                <h3>üíµ Valor de 1 Unidad (Stake 1)</h3>
                <div class="match-row">
                    <label for="unit-value">Valor (‚Ç¨/\$):</label>
                    <input type="number" id="unit-value" step="0.01" min="0.01" placeholder="Ej: 10.00" required>
                </div>
                <p style="font-size: 0.9em; color: #AAAAAA; text-align: center;">Actual: <span id="current-unit-value">1.00</span></p>
                <button id="save-unit-btn" onclick="saveUnitValue()">Guardar Valor de Unidad</button>
            </section>
            
            <section class="section-box">
                <h3>üìà Resumen Detallado por Mercado</h3>
                <div id="market-summary-container">
                    </div>
                
                <table id="summary-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead style="background-color: #333;">
                        <tr>
                            <th style="padding: 10px;">M√©trica</th>
                            <th style="padding: 10px;">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body">
                        </tbody>
                </table>
                <button id="delete-all-btn" onclick="confirmClearHistory()" style="background-color: #CF6679;">üóëÔ∏è Borrar Todo el Historial</button>
            </section>
        </div>

    </div>
    
    <nav id="navbar">
        <div class="nav-item active" onclick="showView('register-view', this)">
            <i class="fas fa-plus-circle"></i>
            <span>Registro</span>
        </div>
        <div class="nav-item" onclick="showView('chart-view', this)">
            <i class="fas fa-chart-line"></i>
            <span>Gr√°ficos</span>
        </div>
        <div class="nav-item" onclick="showView('history-view', this)">
            <i class="fas fa-list-alt"></i>
            <span>Historial</span>
        </div>
        <div class="nav-item" onclick="showView('summary-config-view', this)">
            <i class="fas fa-cog"></i>
            <span>Resumen</span>
        </div>
    </nav>
    
    <div id="editModal" class="modal" style="display:none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content" style="background-color: #2C2C2C; margin: 10% auto; padding: 20px; border: 1px solid #BB86FC; width: 90%; max-width: 400px; border-radius: 8px; position: relative;">
            <span class="close-btn" onclick="closeEditModal()" style="color: #AAAAAA; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            <h3>‚úèÔ∏è Editar Apuesta</h3>
            <input type="hidden" id="edit-id">

            <div class="match-row"><label for="edit-home">Local:</label><input type="text" id="edit-home" required></div>
            <div class="match-row"><label for="edit-away">Visitante:</label><input type="text" id="edit-away" required></div>
            <div class="match-row"><label for="edit-market">Mercado:</label><select id="edit-market"><option value="OU">Over/Under</option><option value="BTTS">BTTS</option></select></div>

            <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #03DAC6;">ROIs An√°lisis (Manual/Hist√≥rico):</p>
            <div class="roi-input-group">
                <div class="roi-input-row"><label for="edit-roi-local">L.:</label><input type="number" id="edit-roi-local" step="0.01"></div>
                <div class="roi-input-row"><label for="edit-roi-visitor">V.:</label><input type="number" id="edit-roi-visitor" step="0.01"></div>
            </div>

            <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #E0E0E0;">Datos de Apuesta:</p>
            <div class="match-row"><label for="edit-stake">Stake (U.):</label><input type="number" id="edit-stake" step="0.1" min="0.1"></div>
            <div class="match-row"><label for="edit-quota">Cuota:</label><input type="number" id="edit-quota" step="0.01" min="1.01"></div>
            <div class="match-row"><label for="edit-result">Resultado:</label><select id="edit-result" onchange="applyResultStyle(this)" class="result-default"><option value="1">Ganado</option><option value="0">Perdido</option><option value="-1">Pendiente</option> </select></div>
            
            <button id="save-edit-btn" onclick="saveEdit()">Guardar Cambios</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const MIN_ROI_THRESHOLD = 15; 
        const NUM_GAMES = 5; 

        let matchHistory = JSON.parse(localStorage.getItem('bettingHistory')) || []; 
        let UNIT_VALUE = parseFloat(localStorage.getItem('unitValue')) || 1.00;
        let myProfitChart; 
        let currentFilter = { result: 'all', market: 'all' };

        // --- FUNCIONES DE C√ÅLCULO DE ROI HIST√ìRICO (REVISADO) ---

        /** * Calcula el Yield/ROI hist√≥rico para un equipo basado en 5 resultados (G/P) y sus respectivas cuotas.
         * Asume un Stake de 1.
         * ROI = (Net Profit / Total Investment) * 100
         * @param {string} team - 'local' o 'visitor'.
         * @returns {number} El ROI hist√≥rico (Yield) en porcentaje.
         */
        function calculateTeamHistoricalROI(team) {
            const resultSelects = document.querySelectorAll(`.calc-${team}-result`);
            const oddInputs = document.querySelectorAll(`.calc-${team}-odd`);

            let totalInvestment = NUM_GAMES; // 5 partidos * Stake 1 = 5 U.
            let netProfit = 0;
            let missingData = false;

            for (let i = 0; i < NUM_GAMES; i++) {
                const result = parseInt(resultSelects[i].value); // 1 = Ganado, 0 = Perdido
                const odd = parseFloat(oddInputs[i].value);

                if (isNaN(odd) || odd < 1.01) {
                    missingData = true;
                    continue; // Saltar partidos sin cuota v√°lida
                }

                if (result === 1) {
                    // Ganado: Profit = Cuota - Stake(1)
                    netProfit += (odd - 1);
                } else if (result === 0) {
                    // Perdido: Loss = -Stake(1)
                    netProfit -= 1;
                }
            }

            // Si falta alg√∫n dato crucial (cuota), devolvemos 0 para evitar distorsiones
            if (missingData) {
                 // Si hay alg√∫n dato faltante, no calcular o calcular con los datos presentes
                 // Para simplicidad, si hay datos faltantes, devolver 0.
                 return 0;
            }
            
            // Si la inversi√≥n es 0 (ej. todos los datos faltantes), el ROI es 0
            if (totalInvestment === 0) return 0;

            const roi = (netProfit / totalInvestment) * 100;
            return roi;
        }
        
        /** Maneja la entrada de la calculadora y actualiza los displays de ROI. */
        window.calculateHistoricalROI = function() {
            const localROIDisplay = document.getElementById('calc-roi-local');
            const visitorROIDisplay = document.getElementById('calc-roi-visitor');
            const generalROIDisplay = document.getElementById('calc-roi-general');
            const regRoiLocalInput = document.getElementById('reg-roi-local');
            const regRoiVisitorInput = document.getElementById('reg-roi-visitor');

            // 1. Calcular ROI Local
            const roiLocal = calculateTeamHistoricalROI('local');
            
            // 2. Calcular ROI Visitante
            const roiVisitor = calculateTeamHistoricalROI('visitor');
            
            // 3. Calcular ROI General (Promedio Simple de los ROIs individuales)
            const roiGeneral = (roiLocal + roiVisitor) / 2;

            // Actualizar Displays de la Calculadora
            localROIDisplay.innerHTML = formatResultSimple(roiLocal);
            localROIDisplay.classList.remove('positive', 'negative', 'zero');
            localROIDisplay.classList.add(roiLocal >= 0.01 ? 'positive' : (roiLocal <= -0.01 ? 'negative' : 'zero'));
            regRoiLocalInput.value = roiLocal.toFixed(2);

            visitorROIDisplay.innerHTML = formatResultSimple(roiVisitor);
            visitorROIDisplay.classList.remove('positive', 'negative', 'zero');
            visitorROIDisplay.classList.add(roiVisitor >= 0.01 ? 'positive' : (roiVisitor <= -0.01 ? 'negative' : 'zero'));
            regRoiVisitorInput.value = roiVisitor.toFixed(2);
            
            generalROIDisplay.innerHTML = formatResultSimple(roiGeneral);
            generalROIDisplay.classList.remove('positive', 'negative', 'zero');
            generalROIDisplay.classList.add(roiGeneral >= 0.01 ? 'positive' : (roiGeneral <= -0.01 ? 'negative' : 'zero'));
        }

        // --- FUNCIONES DE VISTAS ---

        /** Muestra la vista seleccionada y actualiza la barra de navegaci√≥n */
        window.showView = function(viewId, element) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active-view');
            });
            document.getElementById(viewId).classList.add('active-view');

            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.classList.remove('active');
            });

            if (element) {
                element.classList.add('active');
            } else {
                document.querySelector(`#navbar .nav-item[onclick*="${viewId}"]`).classList.add('active');
            }
            
            // Forzar actualizaci√≥n de datos al cambiar de vista
            if (viewId === 'register-view') {
                 // calculateHistoricalROI(); // Ya no es necesario que recalcule al cambiar de vista, solo con el input
            } else if (viewId === 'history-view') {
                updateHistoryTable();
            } else if (viewId === 'chart-view') {
                updateHistoricalSummary();
                renderProfitChart();
            } else if (viewId === 'summary-config-view') {
                updateUnitDisplay();
                updateSummaryConfigView(); 
            }
        }
        
        // --- CONFIGURACI√ìN DE UNIDADES ---

        function saveUnitValue() {
            const input = document.getElementById('unit-value');
            const value = parseFloat(input.value);

            if (isNaN(value) || value <= 0) {
                alert('üö® ERROR: Ingresa un valor num√©rico v√°lido y positivo para 1 Unidad.');
                return;
            }

            UNIT_VALUE = value;
            localStorage.setItem('unitValue', UNIT_VALUE.toFixed(2));
            alert(`‚úÖ Valor de 1 Unidad guardado: ${UNIT_VALUE.toFixed(2)}`);
            updateUnitDisplay();
            updateHistoryTable(); 
        }

        function updateUnitDisplay() {
            document.getElementById('current-unit-value').textContent = `${UNIT_VALUE.toFixed(2)}`;
            document.getElementById('unit-value').value = UNIT_VALUE.toFixed(2);
        }

        // --- FUNCIONES DE REGISTRO Y C√ÅLCULO ---

        function calculateBetMetrics(stake, quota, isWon) {
            let netProfit = 0; 
            let roi = 0; 

            if (isWon === 1) {
                const grossReturn = quota * stake;
                netProfit = grossReturn - stake;
                roi = (netProfit / stake) * 100;
            } else if (isWon === 0) {
                netProfit = -stake;
                roi = -100;
            } else { 
                netProfit = 0;
                roi = 0;
            }
            return { netProfit, roi };
        }

        function saveMatchToHistory() {
            const home = document.getElementById('reg-home').value.trim();
            const away = document.getElementById('reg-away').value.trim();
            const market = document.getElementById('reg-market').value;
            const stakeInput = document.getElementById('reg-stake').value;
            const quotaInput = document.getElementById('reg-quota').value; // Cuota actual
            const resultSelect = document.getElementById('reg-result').value;
            const roiLocalCalculated = document.getElementById('reg-roi-local').value.trim();
            const roiVisitorCalculated = document.getElementById('reg-roi-visitor').value.trim();

            if (!home || !away || !stakeInput || !quotaInput || resultSelect === "") {
                alert('üö® ERROR: Completa los campos obligatorios de Apuesta.');
                return;
            }

            const stake = parseFloat(stakeInput);
            const quota = parseFloat(quotaInput);
            const isWon = parseInt(resultSelect);

            if (isNaN(stake) || stake <= 0.0) {
                alert('üö® ERROR: El Stake (U.) debe ser un n√∫mero positivo.');
                return;
            }
            if (isNaN(quota) || quota <= 1.0) {
                alert('üö® ERROR: La Cuota debe ser un n√∫mero > 1.01.');
                return;
            }
            
            const roiLocal = parseFloat(roiLocalCalculated);
            const roiVisitor = parseFloat(roiVisitorCalculated);

            const { netProfit, roi } = calculateBetMetrics(stake, quota, isWon);

            const match = {
                id: Date.now(), 
                home: home,
                away: away,
                market: market,
                roiLocal: roiLocal, 
                roiVisitor: roiVisitor, 
                stake: stake,
                quota: quota,
                result: isWon,
                netProfit: netProfit,
                roi: roi 
            };

            matchHistory.push(match);
            localStorage.setItem('bettingHistory', JSON.stringify(matchHistory));
            updateHistoryTable(); 

            // Limpiar campos de registro y enfocar a la siguiente acci√≥n
            document.getElementById('reg-home').value = '';
            document.getElementById('reg-away').value = '';
            document.getElementById('reg-stake').value = '';
            document.getElementById('reg-quota').value = '';
            
            // Resetear resultados hist√≥ricos y cuotas
            Array.from(document.querySelectorAll('.calc-local-result, .calc-visitor-result')).forEach(s => s.value = '0');
            Array.from(document.querySelectorAll('.calc-local-odd, .calc-visitor-odd')).forEach(input => input.value = '');
            calculateHistoricalROI(); // Resetear el display de la calculadora
            
            const regResult = document.getElementById('reg-result');
            regResult.value = '';
            applyResultStyle(regResult);
            
            alert(`‚úÖ Apuesta registrada: ${home} vs ${away}.`);
        }

        function confirmClearHistory() {
            if (matchHistory.length === 0) {
                 alert('El historial ya est√° vac√≠o.');
                 return;
            }
            if (confirm('üö® ¬°ADVERTENCIA! ¬øEst√°s seguro de que quieres borrar TODO el historial de apuestas?')) {
                matchHistory = [];
                localStorage.removeItem('bettingHistory');
                updateHistoryTable();
                updateSummaryConfigView();
                alert('Historial completamente borrado.');
            }
        }
        
        // --- FUNCIONES DE FILTRO Y VISTA DE TABLA ---

        window.filterHistory = function() {
            currentFilter.result = document.getElementById('filter-result').value;
            currentFilter.market = document.getElementById('filter-market').value;
            updateHistoryTable();
        }

        function updateHistoryTable() {
            const tableBody = document.getElementById('match-history-body');
            tableBody.innerHTML = ''; 

            const filteredHistory = matchHistory.filter(match => {
                const resultMatch = currentFilter.result === 'all' || match.result.toString() === currentFilter.result;
                const marketMatch = currentFilter.market === 'all' || match.market === currentFilter.market;
                return resultMatch && marketMatch;
            }).reverse();

            if (filteredHistory.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #BB86FC;">No hay apuestas para los filtros seleccionados.</td></tr>';
            }

            filteredHistory.forEach((match, index) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = filteredHistory.length - index; 
                row.insertCell().textContent = `${match.home} vs ${match.away}`;
                row.insertCell().textContent = match.market;

                // ROI Local (Calculado Hist√≥rico)
                const roiLocalCell = row.insertCell();
                if (match.roiLocal !== null) {
                    const isTarget = match.roiLocal >= MIN_ROI_THRESHOLD;
                    const indicator = isTarget ? '<span style="color: #00A800;">üü¢</span> ' : '';
                    roiLocalCell.innerHTML = indicator + formatResultSimple(match.roiLocal);
                } else {
                    roiLocalCell.textContent = '-';
                }

                // ROI Visitante (Calculado Hist√≥rico)
                const roiVisitorCell = row.insertCell();
                if (match.roiVisitor !== null) {
                    const isTarget = match.roiVisitor >= MIN_ROI_THRESHOLD;
                    const indicator = isTarget ? '<span style="color: #00A800;">üü¢</span> ' : '';
                    roiVisitorCell.innerHTML = indicator + formatResultSimple(match.roiVisitor);
                } else {
                    roiVisitorCell.textContent = '-';
                }

                row.insertCell().textContent = match.stake.toFixed(2);
                row.insertCell().textContent = match.quota.toFixed(2);
                
                const resultCell = row.insertCell();
                let statusText;
                if (match.result === 1) {
                    statusText = 'Ganado';
                    resultCell.classList.add('positive');
                } else if (match.result === 0) {
                    statusText = 'Perdido';
                    resultCell.classList.add('negative');
                } else {
                    statusText = 'Pendiente';
                    resultCell.classList.add('pending-text');
                }
                resultCell.textContent = statusText;
                
                const profitCell = row.insertCell();
                if (match.result === -1) {
                    profitCell.textContent = 'N/A';
                    profitCell.classList.add('zero');
                } else {
                    profitCell.textContent = match.netProfit.toFixed(2);
                    profitCell.classList.add(match.netProfit >= 0 ? 'positive' : 'negative');
                }

                const roiCell = row.insertCell();
                if (match.result === -1) {
                    roiCell.textContent = 'N/A';
                    roiCell.classList.add('zero');
                } else {
                    roiCell.innerHTML = formatResultSimple(match.roi); // ROI de la apuesta real
                }

                const actionCell = row.insertCell();
                actionCell.classList.add('action-cell');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editMatch(${match.id})">Edit</button>
                    <button class="btn-delete" onclick="deleteMatch(${match.id})">Del</button>
                `;
            });
        }

        function formatResultSimple(roi) {
            const roundedRoi = roi.toFixed(2);
            let className;
            let sign = roi >= 0 ? '+' : '';

            if (roi > 0) {
                className = 'positive';
            } else if (roi < 0) {
                className = 'negative';
                sign = ''; 
            } else {
                className = 'zero';
            }
            return `<span class="${className}">${sign}${roundedRoi}</span>%`;
        }

        // --- FUNCIONES DE RESUMEN Y ESTAD√çSTICAS ---
        
        function calculateSummaryMetrics() {
            const terminatedMatches = matchHistory.filter(match => match.result !== -1);
            
            let totalInvestment = 0; 
            let totalNetProfit = 0; 

            const marketMetrics = {
                OU: { investment: 0, profit: 0, count: 0 },
                BTTS: { investment: 0, profit: 0, count: 0 }
            };

            terminatedMatches.forEach(match => {
                totalInvestment += match.stake; 
                totalNetProfit += match.netProfit;

                const market = match.market;
                if (marketMetrics[market]) {
                    marketMetrics[market].investment += match.stake;
                    marketMetrics[market].profit += match.netProfit;
                    marketMetrics[market].count++;
                }
            });

            for (const market in marketMetrics) {
                const metrics = marketMetrics[market];
                metrics.roi = metrics.investment > 0 ? (metrics.profit / metrics.investment) * 100 : 0;
            }

            let totalROI = totalInvestment > 0 ? (totalNetProfit / totalInvestment) * 100 : 0;
            
            return { totalInvestment, totalNetProfit, totalROI, totalYield: totalROI, terminatedCount: terminatedMatches.length, marketMetrics };
        }

        function updateHistoricalSummary() {
            const historySummary = document.getElementById('historical-roi-summary');
            const summaryData = calculateSummaryMetrics(); 
            
            const totalStakes = summaryData.totalInvestment.toFixed(2); 
            
            const roiGeneralFormatted = formatResultSimple(summaryData.totalROI);
            
            historySummary.innerHTML = `
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; text-align: center;">
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        ROI General (${summaryData.terminatedCount} Ap. Terminadas): <span class="${summaryData.totalROI >= 0 ? 'positive' : 'negative'}">${roiGeneralFormatted}</span>
                    </div>
                    <div style="font-size: 0.9em; color: #BB86FC;">
                        Unidades Apostadas: <span class="zero">${totalStakes} U.</span>
                    </div>
                </div>
            `;
        }

        function renderMarketSummary(summaryData) {
            const container = document.getElementById('market-summary-container');
            container.innerHTML = '';
            
            for (const market in summaryData.marketMetrics) {
                const metrics = summaryData.marketMetrics[market];
                const marketName = market === 'OU' ? 'Over/Under' : 'BTTS';
                const profitText = metrics.profit.toFixed(2);
                const profitClass = metrics.profit >= 0 ? 'positive' : 'negative';

                container.innerHTML += `
                    <div class="section-box" style="margin-bottom: 15px;">
                        <h4 style="color: #03DAC6; margin: 0 0 10px 0;">${marketName} (${metrics.count} Apuestas)</h4>
                        <div style="display: flex; justify-content: space-around; font-size: 1.1em; flex-wrap: wrap;">
                            <div style="min-width: 150px; text-align: center; margin-bottom: 5px;">ROI/Yield: ${formatResultSimple(metrics.roi)}</div>
                            <div style="min-width: 150px; text-align: center;">P&L: <span class="${profitClass}">${profitText} U.</span></div>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateSummaryConfigView() {
            const summaryData = calculateSummaryMetrics();
            const tableBody = document.getElementById('summary-table-body');
            tableBody.innerHTML = ''; 

            renderMarketSummary(summaryData);

            if (summaryData.terminatedCount === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" style="text-align: center;" class="pending-text">No hay apuestas terminadas para el resumen.</td></tr>';
            } else {
                tableBody.innerHTML += `
                    <tr><td>ROI Total (Yield)</td><td>${formatResultSimple(summaryData.totalROI)}</td></tr>
                `;

                let netProfitCell = summaryData.totalNetProfit.toFixed(2);
                let profitClass = summaryData.totalNetProfit >= 0 ? 'positive' : 'negative';
                tableBody.innerHTML += `
                    <tr><td>Ganancia Neta Total</td><td class="${profitClass}">${netProfitCell} U.</td></tr>
                    <tr><td>Total Apostado (Stake)</td><td class="zero">${summaryData.totalInvestment.toFixed(2)} U.</td></tr>
                    <tr><td>Total Apuestas Terminadas</td><td class="zero">${summaryData.terminatedCount}</td></tr>
                `;
            }
        }

        // --- FUNCIONES DEL GR√ÅFICO ---
        
        function renderProfitChart() {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;

            let accumulatedProfitOU = 0;
            let accumulatedProfitBTTS = 0;
            const labels = ['Inicio'];
            const dataPointsOU = [0]; 
            const dataPointsBTTS = [0]; 

            matchHistory.forEach((match, index) => {
                if (match.result !== -1) { 
                    if (match.market === 'OU') {
                        accumulatedProfitOU += match.netProfit;
                    } else if (match.market === 'BTTS') {
                        accumulatedProfitBTTS += match.netProfit;
                    }
                }
                
                labels.push(`Apuesta ${index + 1}`);
                dataPointsOU.push(parseFloat(accumulatedProfitOU.toFixed(2))); 
                dataPointsBTTS.push(parseFloat(accumulatedProfitBTTS.toFixed(2))); 
            });
            
            if (window.myProfitChart) {
                window.myProfitChart.destroy();
            }

            window.myProfitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'P&L Acumulado (OU)', data: dataPointsOU, borderColor: '#03DAC6', backgroundColor: 'rgba(3, 218, 198, 0.1)', tension: 0.4, pointRadius: 3, pointBackgroundColor: '#03DAC6' },
                        { label: 'P&L Acumulado (BTTS)', data: dataPointsBTTS, borderColor: '#BB86FC', backgroundColor: 'rgba(187, 134, 252, 0.1)', tension: 0.4, pointRadius: 3, pointBackgroundColor: '#BB86FC' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Unidades (U.)', color: '#E0E0E0' }, grid: { color: '#333333' }, ticks: { color: '#E0E0E0' } },
                        x: { title: { display: true, text: 'Progresi√≥n de Apuestas', color: '#E0E0E0' }, grid: { color: '#333333' }, ticks: { color: '#E0E0E0' } }
                    },
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#E0E0E0' } } }
                }
            });
        }
        
        // --- FUNCIONES DE EDICI√ìN Y ESTILO ---
        
        window.deleteMatch = function(id) {
            if (confirm('¬øSeguro que deseas borrar esta apuesta individual?')) {
                matchHistory = matchHistory.filter(match => match.id !== id);
                localStorage.setItem('bettingHistory', JSON.stringify(matchHistory));
                updateHistoryTable();
                updateSummaryConfigView();
                updateHistoricalSummary();
                renderProfitChart(); 
                alert('Apuesta eliminada.');
            }
        }

        window.editMatch = function(id) {
            const match = matchHistory.find(m => m.id === id);
            if (!match) return;

            document.getElementById('edit-id').value = match.id;
            document.getElementById('edit-home').value = match.home;
            document.getElementById('edit-away').value = match.away;
            document.getElementById('edit-market').value = match.market;
            document.getElementById('edit-roi-local').value = match.roiLocal !== null ? match.roiLocal : '';
            document.getElementById('edit-roi-visitor').value = match.roiVisitor !== null ? match.roiVisitor : '';
            document.getElementById('edit-stake').value = match.stake.toFixed(2);
            document.getElementById('edit-quota').value = match.quota.toFixed(2);
            
            const editResultSelect = document.getElementById('edit-result');
            editResultSelect.value = match.result;
            applyResultStyle(editResultSelect); 

            document.getElementById('editModal').style.display = 'block';
        }

        window.saveEdit = function() {
            const id = parseInt(document.getElementById('edit-id').value);
            const index = matchHistory.findIndex(m => m.id === id);
            
            if (index === -1) { alert('Error: Apuesta no encontrada.'); return; }

            const home = document.getElementById('edit-home').value.trim();
            const away = document.getElementById('edit-away').value.trim();
            const market = document.getElementById('edit-market').value;
            const stakeInput = document.getElementById('edit-stake').value;
            const quotaInput = document.getElementById('edit-quota').value;
            const resultSelect = document.getElementById('edit-result').value;
            const roiLocalManual = document.getElementById('edit-roi-local').value.trim();
            const roiVisitorManual = document.getElementById('edit-roi-visitor').value.trim();

            if (!home || !away || !stakeInput || !quotaInput) { alert('üö® ERROR: Completa los campos obligatorios.'); return; }
            
            const stake = parseFloat(stakeInput);
            const quota = parseFloat(quotaInput);
            const isWon = parseInt(resultSelect);

            if (stake <= 0 || quota <= 1.0) { alert('üö® ERROR: Stake > 0 y Cuota > 1.0'); return; }
            
            const { netProfit, roi } = calculateBetMetrics(stake, quota, isWon);
            
            // Asume que en edici√≥n se usan los valores ingresados manualmente.
            const roiLocal = roiLocalManual !== '' && !isNaN(parseFloat(roiLocalManual)) ? parseFloat(roiLocalManual) : null;
            const roiVisitor = roiVisitorManual !== '' && !isNaN(parseFloat(roiVisitorManual)) ? parseFloat(roiVisitorManual) : null;

            matchHistory[index] = {
                ...matchHistory[index], home, away, market,
                roiLocal, roiVisitor, stake, quota, result: isWon, netProfit, roi
            };

            localStorage.setItem('bettingHistory', JSON.stringify(matchHistory));
            updateHistoryTable();
            updateSummaryConfigView();
            updateHistoricalSummary();
            renderProfitChart(); 
            closeEditModal();
            alert(`‚úÖ Apuesta actualizada con √©xito.`);
        }

        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
        }

        window.applyResultStyle = function(selectElement) {
            const value = selectElement.value;
            selectElement.classList.remove('result-won', 'result-lost', 'result-pending', 'result-default');
            if (value === '1') { selectElement.classList.add('result-won'); } 
            else if (value === '0') { selectElement.classList.add('result-lost'); } 
            else if (value === '-1') { selectElement.classList.add('result-pending'); } 
            else { selectElement.classList.add('result-default'); }
        }

        // --- INICIALIZACI√ìN ---
        window.onload = function() {
            // Inicializa la vista por defecto (Registro)
            showView('register-view');
            calculateHistoricalROI(); // Inicializa el c√°lculo del ROI a 0.00%
        };
    </script>

</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Poisson + Monte Carlo Mejorada</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;margin:0;padding:0;background:#0e0e0e;color:#f0f0f0;}
    .container{max-width:1100px;margin:auto;padding:30px;}
    .header{display:flex;align-items:center;justify-content:space-between;background:#1b1b1b;padding:15px 25px;border-radius:12px;margin-bottom:25px;box-shadow:0 0 25px rgba(0,255,20,0.4);}
    .header img{width:60px;filter:drop-shadow(0 0 6px #39FF14);}
    .header h2{margin:0;color:#39FF14;font-weight:600;letter-spacing:1.2px;}
    .header button{background-color:#2c2c2c;color:#f0f0f0;border:1px solid #39FF14;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:600;transition:0.3s;}
    .header button:hover{background-color:#39FF14;color:#000;}
    .inputs{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
    input,select,button{padding:8px;font-size:14px;background:#2c2c2c;color:#f0f0f0;border:1px solid #444;border-radius:6px;transition:0.3s;}
    input:focus,select:focus{border-color:#39FF14;outline:none;}
    button{background-color:#333;border:none;cursor:pointer;font-weight:600;}
    button:hover{background-color:#39FF14;color:#000;}
    .small-input{width:60px;text-align:center;}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:15px;}
    th,td{padding:8px;border:1px solid #333;text-align:center;}
    th{background:#1f1f1f;font-weight:600;}
    td{background:#151515;}
    tr.highlight td{background-color:rgba(57,255,20,0.15)!important;font-weight:600;}
    #notificacion{position:fixed;bottom:20px;right:20px;background:#39FF14;color:#000;padding:12px 20px;border-radius:8px;font-weight:600;opacity:0;transition:0.4s;pointer-events:none;}
    #notificacion.visible{opacity:1;}
    .live-section{margin-top:40px;padding:20px;background:#1b1b1b;border-radius:12px;box-shadow:0 0 20px rgba(0,255,20,0.2);}
    .live-section h3{color:#39FF14;margin-top:0;margin-bottom:15px;}
  </style>
</head>
<body>
<div class="container">

  <!-- CALCULADORA PREPARTIDO -->
  <div class="header">
    <div style="display:flex; align-items:center; gap:15px;">
      <img src="https://cdn-icons-png.flaticon.com/512/287/287221.png" alt="Logo" />
      <h2>Calculadora Poisson + Monte Carlo</h2>
    </div>
    <button onclick="window.location.href='historial.html'">ðŸ“œ Ver Historial</button>
  </div>

  <div class="inputs">
    <input type="text" id="nombreLocal" placeholder="Equipo Local" style="flex:1;" />
    <input type="number" id="golesLocal" placeholder="Promedio Local" step="0.01" />
    <input type="text" id="nombreVisita" placeholder="Equipo Visitante" style="flex:1;" />
    <input type="number" id="golesVisita" placeholder="Promedio Visita" step="0.01" />
    <input type="number" id="bankroll" placeholder="Bankroll ($)" step="0.01" value="100" />
    <input type="number" id="simulaciones" placeholder="Simulaciones" value="10000" />
    <button onclick="calcular()">Calcular</button>
  </div>

  <div class="inputs">
    <select id="equipoHandicap">
      <option value="local">HÃ¡ndicap Local</option>
      <option value="visita">HÃ¡ndicap Visitante</option>
    </select>
    <input type="number" id="lineaHandicap" placeholder="LÃ­nea AH (ej: -0.25)" step="0.25" />
  </div>

  <div class="inputs">
    <button onclick="agregarAlHistorial()">âž• Agregar al historial</button>
    <button onclick="exportarHistorial()">â¬‡ Exportar historial</button>
    <label style="display:flex;align-items:center;gap:5px;">
      <input type="checkbox" id="toggleEV" onchange="calcular()" /> Mostrar EV y Kelly
    </label>
    <select id="kellyFrac" onchange="calcular()">
      <option value="0.05">5%</option>
      <option value="0.10">10%</option>
      <option value="0.15">15%</option>
      <option value="0.20">20%</option>
      <option value="0.25" selected>25%</option>
      <option value="0.30">30%</option>
      <option value="0.40">40%</option>
    </select>
  </div>

  <div id="resultado"></div>

  <!-- CALCULADORA LIVE -->
  <div class="live-section">
    <h3>âš¡ Calculadora Live Poisson</h3>
    <div class="inputs">
      <input type="number" id="liveGolesLocal" placeholder="Goles Local" min="0" />
      <input type="number" id="liveGolesVisita" placeholder="Goles Visita" min="0" />
      <input type="number" id="liveMinuto" placeholder="Minuto Actual" min="0" max="120" />
    </div>
    <div class="inputs">
      <input type="number" id="tirosLocal" placeholder="Tiros Local" min="0">
      <input type="number" id="tirosPuertaLocal" placeholder="Tiros a Puerta Local" min="0">
      <input type="number" id="tirosVisita" placeholder="Tiros Visita" min="0">
      <input type="number" id="tirosPuertaVisita" placeholder="Tiros a Puerta Visita" min="0">
      <button onclick="calcularLive()">Calcular Live</button>
      <button onclick="agregarAlHistorialLive()">âž• Agregar al historial</button>
    </div>
    <div id="resultadoLive"></div>
  </div>
</div>

<div id="notificacion"></div>

<script>
/* -------- Funciones base -------- */
const factorial=n=>n<=1?1:n*factorial(n-1);
const poisson=(k,lambda)=>(Math.pow(lambda,k)*Math.exp(-lambda))/factorial(k);
const cuotaImplicita=p=>p>0?(1/p).toFixed(2):"-";
const valueBet=(p,cuota)=>((p*cuota)-1).toFixed(2);
const kelly=(p,cuota,f=1)=>Math.max(0,(((cuota-1)*p-(1-p))/(cuota-1))*f);
const samplePoisson=lambda=>{
  let L=Math.exp(-lambda),k=0,p=1;
  do{ k++; p*=Math.random(); }while(p>L);
  return k-1;
};

let cuotasGuardadas={}, exportData=[];

/* ------------ FUNCIÃ“N PREPARTIDO COMPLETA ------------ */
function calcular(){
  const nombreLocal=document.getElementById("nombreLocal").value.trim();
  const nombreVisita=document.getElementById("nombreVisita").value.trim();
  const lambdaL=parseFloat(document.getElementById("golesLocal").value);
  const lambdaV=parseFloat(document.getElementById("golesVisita").value);
  const bankroll=parseFloat(document.getElementById("bankroll").value);
  const sims=parseInt(document.getElementById("simulaciones").value);
  const showEV=document.getElementById("toggleEV").checked;
  const kellyFrac=parseFloat(document.getElementById("kellyFrac").value);

  if(!nombreLocal||!nombreVisita||isNaN(lambdaL)||isNaN(lambdaV)||isNaN(bankroll)||isNaN(sims)){
    return mostrarNotificacion("âš  Completa todos los campos correctamente");
  }

  const maxGoals=5;
  const pLocal=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaL));
  const pVisita=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaV));
  let winL=0,draw=0,winV=0,btts=0,bttsNo=0;
  const thresholds=[0.5,1.5,2.5,3.5], under={};
  thresholds.forEach(t=>under[t]=0);

  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const joint=pLocal[i]*pVisita[j];
      if(i>j) winL+=joint; else if(i===j) draw+=joint; else winV+=joint;
      if(i>0&&j>0) btts+=joint; else bttsNo+=joint;
      thresholds.forEach(th=>{ if(i+j<=th) under[th]+=joint; });
    }
  }
  const overs=thresholds.map(th=>1-under[th]);

  // Monte Carlo
  let mcWinL=0,mcDraw=0,mcWinV=0,mcBTTS=0,mcBTTSNo=0,mcOvers=[0,0,0,0];
  for(let s=0;s<sims;s++){
    const gL=samplePoisson(lambdaL),gV=samplePoisson(lambdaV);
    if(gL>gV) mcWinL++; else if(gL===gV) mcDraw++; else mcWinV++;
    if(gL>0&&gV>0) mcBTTS++; else mcBTTSNo++;
    thresholds.forEach((th,idx)=>{ if(gL+gV>th) mcOvers[idx]++; });
  }

  const probPoisson=[winL,draw,winV];
  const probMC=[mcWinL,mcDraw,mcWinV].map(x=>x/sims);
  const probOversPoisson=overs, probOversMC=mcOvers.map(x=>x/sims);

  const equipoAH=document.getElementById("equipoHandicap").value;
  const lineaAH=parseFloat(document.getElementById("lineaHandicap").value);
  let probAH=0;
  if(!isNaN(lineaAH)){
    for(let i=0;i<=maxGoals;i++){
      for(let j=0;j<=maxGoals;j++){
        const diff=(equipoAH==="local"?i-j:j-i);
        if(diff+lineaAH>0) probAH+=pLocal[i]*pVisita[j];
      }
    }
  }

  exportData=[];
  let html=`<table>
    <tr><th>Grupo</th><th>OpciÃ³n</th><th>Poisson %</th><th>MC %</th><th>Cuota ImplÃ­cita</th>
    ${showEV?`<th>Cuota Bookie</th><th>EV</th><th>Kelly (${kellyFrac*100}%)</th><th>Apostar $</th>`:""}</tr>`;

  const filas=[
    ["1X2 âš½",[nombreLocal,"Empate",nombreVisita],probPoisson,probMC],
    ["Over/Under ðŸŽ¯",thresholds.map(t=>`Over ${t}`),probOversPoisson,probOversMC],
    ["BTTS ðŸ””",["SÃ­","No"],[btts,bttsNo],[mcBTTS/sims, mcBTTSNo/sims]]
  ];

  filas.forEach(([grupo,labels,probs,probsMC],gi)=>{
    labels.forEach((label,idx)=>{
      const p=probs[idx],mc=probsMC[idx],id=`bookie_${gi}_${idx}`;
      const cuotaGuardada=cuotasGuardadas[id]||"";
      let row=`<tr><td>${grupo}</td><td>${label}</td>
               <td>${(p*100).toFixed(2)}</td><td>${(mc*100).toFixed(2)}</td>
               <td>${cuotaImplicita(p)}</td>`;
      if(showEV){
        row+=`<td><input type="text" class="small-input" id="${id}" value="${cuotaGuardada}"
                oninput="cuotasGuardadas['${id}']=this.value.replace(',','.');"
                onblur="calcular()" onkeydown="if(event.key==='Enter'){this.blur();}"></td>`;
        const cuotaBookie=parseFloat(cuotasGuardadas[id]);
        const ev=!isNaN(cuotaBookie)?valueBet(p,cuotaBookie):"-";
        const k=!isNaN(cuotaBookie)?kelly(p,cuotaBookie,kellyFrac):0;
        const apuesta=k>0?(bankroll*k).toFixed(2):"-";
        const highlight=(!isNaN(ev)&&ev>0)||(k>0)?"highlight":"";
        row+=`<td>${ev}</td><td>${(k*100).toFixed(1)}%</td><td>${apuesta}</td></tr>`;
        html+=row.replace("<tr>",`<tr class="${highlight}">`);
        if(!isNaN(cuotaBookie)) exportData.push([grupo,label,(p*100).toFixed(2),cuotaBookie,ev,(k*100).toFixed(1)+"%",apuesta,nombreLocal,nombreVisita]);
      }else html+=row+"</tr>";
    });
  });

  if(!isNaN(lineaAH)){
    const labelAH=`${equipoAH==="local"?nombreLocal:nombreVisita} AH ${lineaAH>0?"+":""}${lineaAH}`;
    const p=probAH;
    const mc=p;
    const id="bookie_AH";
    const cuotaGuardada=cuotasGuardadas[id]||"";
    let row=`<tr><td>HÃ¡ndicap AsiÃ¡tico ðŸ¥¢</td><td>${labelAH}</td>
             <td>${(p*100).toFixed(2)}</td><td>${(mc*100).toFixed(2)}</td>
             <td>${cuotaImplicita(p)}</td>`;
    if(showEV){
      row+=`<td><input type="text" class="small-input" id="${id}" value="${cuotaGuardada}"
              oninput="cuotasGuardadas['${id}']=this.value.replace(',','.');"
              onblur="calcular()" onkeydown="if(event.key==='Enter'){this.blur();}"></td>`;
      const cuotaBookie=parseFloat(cuotasGuardadas[id]);
      const ev=!isNaN(cuotaBookie)?valueBet(p,cuotaBookie):"-";
      const k=!isNaN(cuotaBookie)?kelly(p,cuotaBookie,kellyFrac):0;
      const apuesta=k>0?(bankroll*k).toFixed(2):"-";
      const highlight=(!isNaN(ev)&&ev>0)||(k>0)?"highlight":"";
      row+=`<td>${ev}</td><td>${(k*100).toFixed(1)}%</td><td>${apuesta}</td></tr>`;
      html+=row.replace("<tr>",`<tr class="${highlight}">`);
      if(!isNaN(cuotaBookie)) exportData.push(["HÃ¡ndicap AsiÃ¡tico",labelAH,(p*100).toFixed(2),cuotaBookie,ev,(k*100).toFixed(1)+"%",apuesta,nombreLocal,nombreVisita]);
    }else html+=row+"</tr>";
  }

  html+="</table>";
  document.getElementById("resultado").innerHTML=html;
}

/* ------------ HISTORIAL ------------ */
function agregarAlHistorial(){
  calcular();
  if(!exportData.length) return mostrarNotificacion("âš  No hay mercados con cuota de la bookie para agregar.");
  const historial=JSON.parse(localStorage.getItem("poissonHistorial"))||[];
  exportData.forEach(r=>historial.push(r));
  localStorage.setItem("poissonHistorial",JSON.stringify(historial));
  mostrarNotificacion("âœ… Mercados agregados al historial");
}
function exportarHistorial(){
  const historial=JSON.parse(localStorage.getItem("poissonHistorial"))||[];
  if(!historial.length) return mostrarNotificacion("âš  No hay historial para exportar");
  const csv="Grupo,OpciÃ³n,Prob %,Cuota Bookie,EV,Kelly %,Apostar $,Local,Visitante\n"+historial.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="historial_poisson.csv";
  a.click();
}

/* ------------ FUNCIÃ“N LIVE MEJORADA (con tiros) ------------ */
function calcularLive(){
  const gL=parseInt(document.getElementById("liveGolesLocal").value)||0;
  const gV=parseInt(document.getElementById("liveGolesVisita").value)||0;
  const min=parseInt(document.getElementById("liveMinuto").value)||0;
  const lambdaL=parseFloat(document.getElementById("golesLocal").value);
  const lambdaV=parseFloat(document.getElementById("golesVisita").value);
  const tirosL=parseInt(document.getElementById("tirosLocal").value)||0;
  const tirosPL=parseInt(document.getElementById("tirosPuertaLocal").value)||0;
  const tirosV=parseInt(document.getElementById("tirosVisita").value)||0;
  const tirosPV=parseInt(document.getElementById("tirosPuertaVisita").value)||0;

  if(isNaN(lambdaL)||isNaN(lambdaV)){
    return mostrarNotificacion("âš  Ingresa los promedios de goles en la calculadora prepartido primero.");
  }

  const showEV=document.getElementById("toggleEV").checked;
  const kellyFrac=parseFloat(document.getElementById("kellyFrac").value);
  const bankroll=parseFloat(document.getElementById("bankroll").value);

  const tiempoRestante=Math.max(0,90-min)/90;
  const expTiros=10, expTirosPuerta=3, pesoTiros=0.4, pesoPuerta=0.6;

  const factorLocal = (pesoTiros*(tirosL/expTiros) + pesoPuerta*(tirosPL/expTirosPuerta))/(pesoTiros+pesoPuerta);
  const factorVisita = (pesoTiros*(tirosV/expTiros) + pesoPuerta*(tirosPV/expTirosPuerta))/(pesoTiros+pesoPuerta);

  const lambdaLRest= lambdaL*tiempoRestante*factorLocal;
  const lambdaVRest= lambdaV*tiempoRestante*factorVisita;

  const maxGoals=5;
  const pLocal=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaLRest));
  const pVisita=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaVRest));

  let btts=0,bttsNo=0;
  const thresholds=[0.5,1.5,2.5,3.5], under={};
  thresholds.forEach(t=>under[t]=0);

  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const joint=pLocal[i]*pVisita[j];
      if(i>0&&j>0) btts+=joint; else bttsNo+=joint;
      thresholds.forEach(th=>{ if(gL+gV+i+j<=th) under[th]+=joint; });
    }
  }
  const overs=thresholds.map(th=>1-under[th]);

  let html=`<table>
    <tr><th>Grupo</th><th>OpciÃ³n</th><th>Prob %</th><th>Cuota ImplÃ­cita</th>
    ${showEV?`<th>Cuota Bookie</th><th>EV</th><th>Kelly ${kellyFrac*100}%</th><th>Apostar $</th>`:""}</tr>`;

  const filas=[
    ["Over/Under ðŸŽ¯",thresholds.map(t=>`Over ${t}`),overs],
    ["BTTS ðŸ””",["SÃ­","No"],[btts,bttsNo]]
  ];

  filas.forEach(([grupo,labels,probs],gi)=>{
    labels.forEach((label,idx)=>{
      const p=probs[idx], id=`live_${gi}_${idx}`;
      const cuotaGuardada=cuotasGuardadas[id]||"";
      let row=`<tr><td>${grupo}</td><td>${label}</td>
               <td>${(p*100).toFixed(2)}</td><td>${cuotaImplicita(p)}</td>`;
      if(showEV){
        row+=`<td><input type="text" class="small-input" id="${id}" value="${cuotaGuardada}"
                oninput="cuotasGuardadas['${id}']=this.value.replace(',','.');"
                onblur="calcularLive()" onkeydown="if(event.key==='Enter'){this.blur();}"></td>`;
        const cuotaBookie=parseFloat(cuotasGuardadas[id]);
        const ev=!isNaN(cuotaBookie)?valueBet(p,cuotaBookie):"-";
        const k=!isNaN(cuotaBookie)?kelly(p,cuotaBookie,kellyFrac):0;
        const apuesta=k>0?(bankroll*k).toFixed(2):"-";
        const highlight=(!isNaN(ev)&&ev>0)||(k>0)?"highlight":"";
        row+=`<td>${ev}</td><td>${(k*100).toFixed(1)}%</td><td>${apuesta}</td></tr>`;
        html+=row.replace("<tr>",`<tr class="${highlight}">`);
      }else html+=row+"</tr>";
    });
  });

  html+="</table>";
  document.getElementById("resultadoLive").innerHTML=html;
}

/* --- AGREGAR LIVE SOLO SI TIENE APOSTAR $ --- */
function agregarAlHistorialLive(){
  calcularLive();
  const filas=document.querySelectorAll("#resultadoLive table tr");
  if(filas.length<=1) return mostrarNotificacion("âš  Calcula Live antes de agregar al historial.");
  
  const historial=JSON.parse(localStorage.getItem("poissonHistorial"))||[];
  let agregadas=0;

  filas.forEach((tr,i)=>{
    if(i===0) return; 
    const tds=tr.querySelectorAll("td");
    if(tds.length<8) return;  
    const apuesta=tds[7]?.innerText || "-";
    if(apuesta==="-"||apuesta.trim()==="") return;

    const grupo=tds[0].innerText;
    const opcion=tds[1].innerText;
    const prob=tds[2].innerText;
    const cuotaBookie=tds[4]?tds[4].querySelector("input")?.value || "-" : "-";
    const ev=tds[5]?.innerText || "-";
    const kellyVal=tds[6]?.innerText || "-";
    const local=document.getElementById("nombreLocal").value;
    const visita=document.getElementById("nombreVisita").value;
    historial.push([grupo+" (Live)",opcion,prob,cuotaBookie,ev,kellyVal,apuesta,local,visita]);
    agregadas++;
  });

  if(agregadas>0){
    localStorage.setItem("poissonHistorial",JSON.stringify(historial));
    mostrarNotificacion(`âœ… ${agregadas} mercados Live agregados`);
  }else{
    mostrarNotificacion("âš  Ninguna fila tiene valor en Apostar $");
  }
}

/* -------- NotificaciÃ³n -------- */
function mostrarNotificacion(msg){
  const n=document.getElementById("notificacion");
  n.textContent=msg;
  n.classList.add("visible");
  setTimeout(()=>n.classList.remove("visible"),2500);
}
</script>
</body>
</html>

Instrucciones: 
Coloca el nombre del equipo local y el promedio de goles a favor.
Coloca el nombre del equipo visitante y el promedio de goles a favor.
Presiona calcular y el checkbox para colocar la cuota de tu casa de apuestas preferida.
Puedes usar AIscore para tomar los datos del promedio de goles.

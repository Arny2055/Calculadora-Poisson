<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Backtesting JSON Automático</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">

<style>
  body{font-family:Inter,system-ui;background:#0f1724;color:#e6eef6;margin:0;padding:20px}
  .card{background:#0b1220;padding:14px;border-radius:10px;margin-bottom:16px}
  .btn{padding:6px 12px;border:none;border-radius:6px;background:#06b6d4;color:#021522;font-weight:600;cursor:pointer}
  textarea,input{width:100%;margin:4px 0;padding:6px;border-radius:6px;border:1px solid #333;background:#111;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
  th,td{padding:6px;border-bottom:1px solid #222;text-align:left}
</style>
</head>
<body>

<h1>Backtesting JSON (Stake fijo = 1)</h1>

<div class="card">
  <label>Subir archivo JSON
    <input id="fileInput" type="file" accept=".json" />
  </label>
  <label>Pegar JSON</label>
  <textarea id="pasteJson" rows="6"></textarea>
  <button id="btnRun" class="btn">Ejecutar Backtest</button>
</div>

<div id="results" class="card" style="display:none">
  <h3>Métricas</h3>
  <div id="metrics"></div>
  <h3>Tabla</h3>
  <table>
    <thead><tr><th>#</th><th>Fecha</th><th>Selección</th><th>Cuota</th><th>Stake</th><th>Profit</th></tr></thead>
    <tbody id="tbodyBets"></tbody>
  </table>
</div>

<script>
let rawData=[], parsed=[];

function q(id){return document.getElementById(id);}
function safeNumber(v){let n=Number(v);return isFinite(n)?n:0;}

function parseRecords(records){
  return records.map((r,i)=>{
    const clean={};
    for(let k in r){ clean[k.trim().toLowerCase()] = r[k]; }

    const date=new Date(clean["date"]);
    const odds=safeNumber(clean["odd"]);
    const stake=1; // fijo
    let profit=0;

    if(clean["result"]){
      const val=clean["result"].toString().toLowerCase().trim();
      if(val.includes("win")) profit=(odds-1)*stake;
      else if(val.includes("lose")) profit=-stake;
      else profit=0;
    }

    return {
      i,date,
      selection: clean["desired outcome"] || clean["name"] || "-",
      odds,stake,profit
    };
  });
}

function computeMetrics(recs){
  const total=recs.length;
  const stake=recs.reduce((a,b)=>a+b.stake,0);
  const profit=recs.reduce((a,b)=>a+b.profit,0);
  const roi=stake? (profit/stake*100):0;
  return {total,stake,profit,roi};
}

function renderMetrics(m){
  q("metrics").innerHTML=`
    Apuestas: ${m.total}<br>
    Stake total: ${m.stake}<br>
    Beneficio neto: ${m.profit.toFixed(2)}<br>
    ROI: ${m.roi.toFixed(2)}%
  `;
}

function renderTable(recs){
  q("tbodyBets").innerHTML="";
  recs.forEach((r,idx)=>{
    q("tbodyBets").innerHTML+=`
      <tr>
        <td>${idx+1}</td>
        <td>${r.date.toLocaleString()}</td>
        <td>${r.selection}</td>
        <td>${r.odds}</td>
        <td>${r.stake}</td>
        <td style="color:${r.profit>=0?"lightgreen":"salmon"}">${r.profit.toFixed(2)}</td>
      </tr>`;
  });
}

function runBacktest(){
  try{
    rawData=JSON.parse(q("pasteJson").value);
    if(!Array.isArray(rawData)) rawData=[rawData];
    parsed=parseRecords(rawData);
    const m=computeMetrics(parsed);
    renderMetrics(m);
    renderTable(parsed);
    q("results").style.display="";
  }catch(err){alert("Error: "+err.message);}
}

q("btnRun").addEventListener("click",runBacktest);

q("fileInput").addEventListener("change",e=>{
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=ev=>{q("pasteJson").value=ev.target.result;runBacktest();};
  reader.readAsText(f);
});
</script>
</body>
</html>
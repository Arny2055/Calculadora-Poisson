<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Poisson • OU + BTTS — EV, Kelly, Overround, CLV + Registro</title>
<style>
  :root{--bg:#05070c;--bg2:#0a0f19;--panel:rgba(16,22,33,.65);--panel-solid:#121a29;
    --text:#eaf0ff;--muted:#9aa7ba;--border:#273246;--accent:#7fb3ff;--accent2:#67e3a1;
    --glow:#2b84ff;--shadow:0 20px 60px rgba(0,0,0,.45)}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.1px;
    background:radial-gradient(1200px 600px at 10% -10%, #1b2d52 0%, transparent 60%),
               radial-gradient(1000px 650px at 110% 10%, #113d2c 0%, transparent 55%),
               radial-gradient(800px 450px at 50% 110%, #1f183a 0%, transparent 55%),
               linear-gradient(180deg,var(--bg),var(--bg2))}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);
    background:linear-gradient(90deg,rgba(10,16,28,.6),rgba(10,16,28,.35));border-bottom:1px solid var(--border)}
  .head{max-width:1120px;margin:0 auto;padding:18px 20px;display:flex;align-items:center;gap:14px}
  .logo{width:44px;height:44px;border-radius:14px;overflow:hidden;
    background:radial-gradient(160% 120% at 30% 20%, #8fc2ff 0%, #2b84ff 35%, #2662ff00 70%),
               radial-gradient(140% 120% at 75% 60%, #67e3a1 0%, #29c17a 40%, #2bff5500 75%);
    box-shadow:0 0 0 1px #2b5aa3,0 10px 28px rgba(43,132,255,.45),inset 0 0 40px rgba(255,255,255,.06)}
  h1{margin:0;font-size:20px;font-weight:900;letter-spacing:.4px}.sub{font-size:12px;color:var(--muted)}
  main{max-width:1120px;margin:28px auto;padding:0 20px;display:grid;gap:22px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
  .card .bar{height:3px;background:linear-gradient(90deg,#2b84ff,#69e3a2,#9e7bff,#2b84ff);opacity:.9;background-size:200% 100%;animation:flow 8s linear infinite}
  @keyframes flow{0%{background-position:0 0}100%{background-position:200% 0}} .pad{padding:20px}
  h2{margin:0 0 12px 0;font-size:16px;letter-spacing:.2px;font-weight:800;color:#cfe1ff}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
  input[type="text"], input[type="number"]{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#0e1523;color:#eaf0ff;outline:none;font-size:14px;transition:border .15s,box-shadow .15s}
  input[type="number"]:focus, input[type="text"]:focus{border-color:#3168ff;box-shadow:0 0 0 5px rgba(49,104,255,.12)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#0e1523;color:#c9d6f3;font-size:12px;cursor:pointer;user-select:none;transition:all .15s}
  .chip.active{border-color:#3b66a8;background:#12223c}
  .range{display:flex;align-items:center;gap:12px}
  input[type="range"]{-webkit-appearance:none;width:100%;height:12px;border-radius:999px;background:linear-gradient(90deg,#1a3a66,#2b84ff);box-shadow:inset 0 0 0 1px #21304a}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#fff;border:3px solid #2b84ff;box-shadow:0 0 0 6px rgba(43,132,255,.18),0 10px 28px rgba(43,132,255,.35)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
  .btn-ghost{padding:10px 14px;border-radius:999px;border:1px solid #2a3a55;background:transparent;color:#cfe1ff;font-weight:700;font-size:13px;cursor:pointer}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:10px}
  .kpi{background:linear-gradient(180deg,rgba(20,28,44,.85),rgba(14,20,35,.85));border:1px solid var(--border);border-radius:14px;padding:14px}
  .k{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
  .v{font-size:20px;font-weight:900;margin-top:6px;font-family:ui-monospace,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:collapse;margin-top:14px;border-radius:14px;overflow:hidden}
  thead th{font-size:11px;color:#c5cee0;text-transform:uppercase;letter-spacing:.6px;background:#0f1726;border-bottom:1px solid var(--border);padding:12px;text-align:right}
  thead th:first-child{text-align:left} tbody td{padding:12px;border-bottom:1px solid var(--border);text-align:right;font-size:14px}
  tbody td:first-child{text-align:left} tbody tr:last-child td{border-bottom:none}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .pillbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #2b3a56;background:#0d1422;font-size:12px;color:#d7e4ff}
  .bestbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin:12px 0 6px}
  .best{position:relative;padding:14px 16px;border-radius:16px;border:1px solid #2a3d63;background:linear-gradient(180deg,rgba(22,30,46,.85),rgba(14,20,35,.9))}
  .best h3{margin:0 0 6px 0;font-size:12px;letter-spacing:.5px;text-transform:uppercase;color:#8fb6ff}
  .best .vbig{font-size:22px;font-weight:900}
  .tag{position:absolute;top:10px;right:10px;font-size:10px;letter-spacing:.4px;padding:4px 8px;border-radius:999px;border:1px solid #2b4b86;color:#cfe1ff;background:#0f1a2c}
  .best.over{border-color:#2b84ff}.best.under{border-color:#67e3a1}.best.btts{border-color:#9e7bff}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #2b3a56;background:#0d1422;color:#cfe1ff}
  .badge-good{border-color:#2f9e6d;background:rgba(47,158,109,.12)}
  .badge-warn{border-color:#d6a84a;background:rgba(214,168,74,.10)}
  .badge-bad{border-color:#d66262;background:rgba(214,98,98,.10)}
  .muted{font-size:12px;color:#9aa7ba;margin-top:10px}
  .note{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e1523;color:#cfe1ff}
  /* Coloración por CLV */
  tr.goodCLV td{ background:rgba(47,158,109,.08); }
  tr.badCLV  td{ background:rgba(214,98,98,.06); }
</style>
</head>
<body>
<header>
  <div class="head">
    <div class="logo"></div>
    <div><h1>Poisson — Over/Under (línea libre) + BTTS</h1><div class="sub">EV% · Kelly¼ · Overround · CLV · Registro</div></div>
  </div>
</header>

<main>
  <!-- Parámetros -->
  <section class="card">
    <div class="bar"></div>
    <div class="pad">
      <h2>Parámetros</h2>
      <div class="grid">
        <div><label>Equipo Local</label><input id="homeTeam" type="text" placeholder="Local" value="Local"/></div>
        <div><label>Equipo Visitante</label><input id="awayTeam" type="text" placeholder="Visita" value="Visita"/></div>

        <div><label>GF Local (λ<sub>H</sub>)</label><input id="gfH" type="number" step="0.01" value="1.40"/></div>
        <div><label>GF Visitante (λ<sub>A</sub>)</label><input id="gfA" type="number" step="0.01" value="1.60"/></div>

        <div>
          <label>Línea OU</label>
          <input id="line" type="number" step="0.25" value="2.50"/>
          <div class="chips" id="presets">
            <div class="chip">0.5</div><div class="chip">1.5</div><div class="chip active">2.5</div>
            <div class="chip">3.0</div><div class="chip">3.5</div><div class="chip">2.25</div><div class="chip">2.75</div>
          </div>
        </div>
        <div>
          <label>Ajuste rápido</label>
          <div class="range"><input id="lineRange" type="range" min="0" max="6" step="0.25" value="2.5"/>
            <span id="lineLbl" class="mono" style="opacity:.9">2.50</span></div>
        </div>
      </div>

      <h2 style="margin-top:18px">Cuotas (opcional) — EV% y Kelly¼</h2>
      <div class="grid">
        <div><label>Cuota Over</label><input id="oddsOver" type="number" step="0.01" min="1" placeholder="1.95"/></div>
        <div><label>Cuota Under</label><input id="oddsUnder" type="number" step="0.01" min="1" placeholder="1.95"/></div>
        <div><label>Cuota BTTS Sí</label><input id="oddsBTTSYes" type="number" step="0.01" min="1" placeholder="1.85"/></div>
        <div><label>Cuota BTTS No</label><input id="oddsBTTSNo" type="number" step="0.01" min="1" placeholder="1.95"/></div>
      </div>

      <div class="actions">
        <button id="calcBtn" class="btn-ghost"><span>Calcular</span></button>
      </div>

      <!-- KPIs λ -->
      <div class="kpis">
        <div class="kpi"><div class="k">λ<sub>H</sub></div><div class="v" id="kLamH">—</div></div>
        <div class="kpi"><div class="k">λ<sub>A</sub></div><div class="v" id="kLamA">—</div></div>
        <div class="kpi"><div class="k">λ<sub>T</sub></div><div class="v" id="kLamT">—</div></div>
      </div>

      <!-- Oculto pero presente -->
      <div class="muted" style="display:none">
        Modelo: X~Pois(λ<sub>H</sub>), Y~Pois(λ<sub>A</sub>), N=X+Y~Pois(λ<sub>T</sub>=λ<sub>H</sub>+λ<sub>A</sub>).
      </div>
    </div>
  </section>

  <!-- OU -->
  <section class="card">
    <div class="bar"></div>
    <div class="pad">
      <h2>Over/Under — Línea <span id="lineHead">—</span></h2>
      <div id="fixtureOU" class="muted" style="margin-top:-4px;margin-bottom:8px">—</div>

      <div id="bestBar" class="bestbar"></div>
      <div id="edgeBar" class="badges"></div>
      <div class="pillbar" id="summary"></div>

      <table>
        <thead><tr><th>Resultado</th><th>Over</th><th>Under</th></tr></thead>
        <tbody id="tbodyOU"><tr><td colspan="3" style="text-align:center;color:#9aa7ba;padding:18px">Pulsa <b>Calcular</b></td></tr></tbody>
      </table>

      <table style="margin-top:10px">
        <thead><tr><th>OU</th><th>p modelo</th><th>Cuota</th><th>EV%</th><th>Kelly¼ %</th></tr></thead>
        <tbody id="tbodyOUEV"></tbody>
      </table>
      <div id="ouBadges" class="badges"></div>

      <!-- Explorador de líneas -->
      <h2 style="margin-top:18px">Explorador de líneas (modelo)</h2>
      <table><thead><tr><th>OU</th><th>p Over</th><th>Fair Over</th><th>p Under</th><th>Fair Under</th></tr></thead>
      <tbody id="tbodySweep"></tbody></table>
    </div>
  </section>

  <!-- BTTS -->
  <section class="card">
    <div class="bar"></div>
    <div class="pad">
      <h2>BTTS</h2>
      <div id="fixtureBTTS" class="muted" style="margin-top:-4px;margin-bottom:8px">—</div>

      <div id="bestBTTS" class="bestbar"></div>

      <table>
        <thead><tr><th>Mercado</th><th>Prob.</th><th>Cuota</th></tr></thead>
        <tbody id="tbodyBTTS"><tr><td colspan="3" style="text-align:center;color:#9aa7ba;padding:18px">Pulsa <b>Calcular</b></td></tr></tbody>
      </table>

      <table style="margin-top:10px">
        <thead><tr><th>BTTS</th><th>p modelo</th><th>Cuota</th><th>EV%</th><th>Kelly¼ %</th></tr></thead>
        <tbody id="tbodyBTTSEV"></tbody>
      </table>
      <div id="bttsBadges" class="badges"></div>
    </div>
  </section>

  <!-- Checklist + Registro -->
  <section class="card">
    <div class="bar"></div>
    <div class="pad">
      <h2>Checklist & Registro</h2>

      <div class="grid">
        <div>
          <label>Seleccionar apuesta</label>
          <div id="pickOptions" class="chips">
            <div class="chip" data-pick="OU Over">OU Over</div>
            <div class="chip" data-pick="OU Under">OU Under</div>
            <div class="chip" data-pick="BTTS Sí">BTTS Sí</div>
            <div class="chip" data-pick="BTTS No">BTTS No</div>
          </div>
        </div>
        <div><label>Cuota tomada</label><input id="stakeOdds" type="number" step="0.01" min="1" placeholder="ej. 1.95"/></div>
        <div><label>Cuota de cierre (opcional)</label><input id="closingOdds" type="number" step="0.01" min="1" placeholder="para CLV"/></div>
        <div><label>Nota (opcional)</label><input id="note" class="note" placeholder="motivo, book, límites…"/></div>
      </div>

      <!-- Bankroll y sugerencia -->
      <div class="grid" style="margin-top:10px">
        <div><label>Bankroll</label><input id="bankroll" type="number" step="0.01" value="1000"/></div>
        <div><label>Stake máx. (cap %)</label><input id="capPct" type="number" step="0.5" value="2.5"/></div>
        <div><label>EV mínimo (%)</label><input id="minEdge" type="number" step="0.5" value="3"/></div>
      </div>
      <div id="stakeSugg" class="muted"></div>

      <div class="actions">
        <button id="addBtn" class="btn-ghost">Registrar apuesta</button>
        <button id="csvBtn" class="btn-ghost">Exportar CSV</button>
        <button id="jsonSave" class="btn-ghost">Guardar JSON</button>
        <button id="jsonLoad" class="btn-ghost">Cargar JSON</button>
        <button id="copyBtn" class="btn-ghost">Copiar pick</button>
      </div>

      <!-- KPIs del log -->
      <div class="kpis" id="kpisLog" style="margin-top:14px"></div>

      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Local</th><th>Visita</th><th>Mercado</th><th>Línea</th>
            <th>Selección</th><th>p modelo</th><th>Cuota</th><th>EV%</th><th>Kelly¼%</th>
            <th>Overround</th><th>Cierre</th><th>CLV</th><th>Nota</th>
          </tr>
        </thead>
        <tbody id="logBody"><tr><td colspan="14" style="text-align:center;color:#9aa7ba;padding:16px">Sin registros</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script>
(function(){
  const $=s=>document.querySelector(s);

  // ---------- Utils matemáticos Poisson ----------
  const fact=[1];
  function factorial(n){for(let i=fact.length;i<=n;i++)fact[i]=fact[i-1]*i;return fact[n]}
  function logFactorial(n){if(n<100)return Math.log(factorial(n));const x=n;return x*Math.log(x)-x+0.5*Math.log(2*Math.PI*x)}
  function pmf(k,l){if(l<=0)return (k===0)?1:0;if(k<100){return Math.exp(-l)*Math.pow(l,k)/factorial(k)}return Math.exp(-l + k*Math.log(l) - logFactorial(k))}
  function cdf(k,l){let s=0;for(let i=0;i<=k;i++)s+=pmf(i,l);return s}

  // ---------- Formatos ----------
  const fmtP=p=> (100*p).toFixed(2)+'%';
  const fmtO=o=> (o===Infinity)?'—':o.toFixed(2);
  const toOdds=p=> (p<=0)?Infinity:(1/p);
  const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
  const pct=x=> isFinite(x)?(100*x).toFixed(2)+'%':'—';

  // ---------- OU/Asian ----------
  function compOver(lamT,Lc){
    const k=Math.floor(Lc+1e-9), isHalf=Math.abs(Lc-(k+0.5))<1e-9;
    const Fk=cdf(k,lamT), Fk_1=cdf(k-1,lamT), pk=Fk-Fk_1;
    return isHalf ? {win:1-Fk, push:0,   loss:Fk}
                  : {win:1-Fk, push:pk,  loss:Fk_1};
  }
  function asianOver(lamT,L){
    const k=Math.floor(L), frac=+(L-k).toFixed(2);
    if(frac===0||frac===0.5) return compOver(lamT,L);
    if(frac===0.25){const a=compOver(lamT,k), b=compOver(lamT,k+0.5);
      return {win:0.5*(a.win+b.win), push:0.5*(a.push+b.push), loss:0.5*(a.loss+b.loss)}}
    if(frac===0.75){const a=compOver(lamT,k+0.5), b=compOver(lamT,k+1.0);
      return {win:0.5*(a.win+b.win), push:0.5*(a.push+b.push), loss:0.5*(a.loss+b.loss)}}
    const nearest=Math.abs(frac-0.5)<Math.abs(frac-0)?(k+0.5):k; return compOver(lamT,nearest);
  }
  function asianUnder(lamT,L){const o=asianOver(lamT,L); return {win:o.loss,push:o.push,loss:o.win}}

  // ---------- Kelly/EV ----------
  const KELLY_FRAC=0.25;
  const evDecimal=(p,odds)=> !odds||odds<=1||!isFinite(odds)?null:(p*odds-1);
  const kellyStake=(p,odds,frac=KELLY_FRAC)=>{if(!odds||odds<=1)return null;const b=odds-1;const EV=p*odds-1;const f=Math.max(0,EV/b);const fAdj=f*frac;return isFinite(fAdj)?fAdj:null};

  // ---------- Badges ----------
  function badgeEV(name, EV){
    if(EV==null) return '';
    const cls = EV>=0.08?'badge-good':(EV>=0.05?'badge-warn':'');
    return `<span class="badge ${cls}">${name} EV: <b class="mono">${pct(EV)}</b></span>`;
  }
  function badgeOverround(name, or){
    if(!isFinite(or)) return '';
    const cls = or<=0.04?'badge-good':(or<=0.07?'badge-warn':'badge-bad');
    return `<span class="badge ${cls}">${name} Overround: <b class="mono">${pct(or)}</b></span>`;
  }

  // ---------- Interfaz ----------
  function teamNames(){
    const h=($('#homeTeam').value||'Local').trim()||'Local';
    const a=($('#awayTeam').value||'Visita').trim()||'Visita';
    return {h,a, vs:`${h} vs ${a}`};
  }
  function safeOdd(x){ return (isFinite(x)&&x>1)?x:NaN; }

  // λT intervalo 68%
  function lambdaCI68(lamT){ const s=Math.sqrt(lamT); return [Math.max(0,lamT-s), lamT+s]; }

  // Explorador líneas
  function sweepLines(lamT){
    const lines=[]; for(let L=1.5; L<=4.0001; L+=0.25){
      const Lr=+L.toFixed(2);
      const over=asianOver(lamT, Lr);
      const under=asianUnder(lamT, Lr);
      const pO=over.win+0.5*over.push, pU=under.win+0.5*under.push;
      lines.push({L:Lr, pO, pU});
    } return lines;
  }

  // ---------- Cálculo principal ----------
  function calc(){
    const {h,a,vs} = teamNames();

    const lamH=Math.max(0,+$('#gfH').value||0);
    const lamA=Math.max(0,+$('#gfA').value||0);
    let L=+($('#line').value||0); L=clamp(L,0,15);
    const lamT=lamH+lamA;

    const oOver=safeOdd(parseFloat($('#oddsOver').value));
    const oUnder=safeOdd(parseFloat($('#oddsUnder').value));
    const oYes =safeOdd(parseFloat($('#oddsBTTSYes').value));
    const oNo  =safeOdd(parseFloat($('#oddsBTTSNo').value));

    $('#kLamH').textContent=lamH.toFixed(2);
    $('#kLamA').textContent=lamA.toFixed(2);
    $('#kLamT').textContent=lamT.toFixed(2);
    $('#lineHead').textContent=L.toFixed(2);
    $('#lineLbl').textContent=L.toFixed(2);
    $('#fixtureOU').textContent = vs;
    $('#fixtureBTTS').textContent = vs;
    document.querySelectorAll('.chip').forEach(ch=>{const v=parseFloat(ch.textContent); if(!isNaN(v)) ch.classList.toggle('active',Math.abs(v-L)<1e-9)});

    const over=asianOver(lamT,L), under=asianUnder(lamT,L);
    const pCashOver=over.win+0.5*over.push, pCashUnder=under.win+0.5*under.push;

    const ouIsOver=pCashOver>=pCashUnder, ouLabel=ouIsOver?'Over':'Under';
    const ouProb=ouIsOver?pCashOver:pCashUnder;
    const ouFair = 1/Math.max(1e-12,ouProb);
    $('#bestBar').innerHTML=`<div class="best ${ouIsOver?'over':'under'}"><span class="tag">Más probable</span><h3>${vs}</h3><div class="vbig mono">OU ${L.toFixed(2)} · ${ouLabel} · ${fmtP(ouProb)} · cuota ${fmtO(ouFair)}</div></div>`;

    // Intervalo 68% λT + confianza
    const [lo,hi] = lambdaCI68(lamT);
    const confGap = Math.abs(pCashOver - pCashUnder);
    const confLbl = confGap>0.20?'Alta':(confGap>0.10?'Media':'Baja');

    $('#summary').innerHTML=`
      <span class="pill">Over <b class="mono">${fmtP(pCashOver)}</b> · cuota ${fmtO(1/Math.max(1e-12,pCashOver))}</span>
      <span class="pill">Under <b class="mono">${fmtP(pCashUnder)}</b> · cuota ${fmtO(1/Math.max(1e-12,pCashUnder))}</span>
      <span class="pill">Push <b class="mono">${fmtP(over.push)}</b></span>
      <span class="pill">λT 68% ≈ <b class="mono">${lo.toFixed(2)}–${hi.toFixed(2)}</b></span>
      <span class="pill">Confianza: <b>${confLbl}</b></span>`;

    $('#tbodyOU').innerHTML=`
      <tr><td>Win</td><td class="mono">${fmtP(over.win)}</td><td class="mono">${fmtP(under.win)}</td></tr>
      <tr><td>Push</td><td class="mono">${fmtP(over.push)}</td><td class="mono">${fmtP(under.push)}</td></tr>
      <tr><td>Loss</td><td class="mono">${fmtP(over.loss)}</td><td class="mono">${fmtP(under.loss)}</td></tr>`;

    const EV_over=evDecimal(pCashOver,oOver), EV_under=evDecimal(pCashUnder,oUnder);
    const K_over=kellyStake(pCashOver,oOver), K_under=kellyStake(pCashUnder,oUnder);
    $('#tbodyOUEV').innerHTML=`
      <tr><td>Over ${L.toFixed(2)}</td><td class="mono">${fmtP(pCashOver)}</td><td class="mono">${isFinite(oOver)?oOver.toFixed(2):'—'}</td><td class="mono">${EV_over==null?'—':pct(EV_over)}</td><td class="mono">${K_over==null?'—':pct(K_over)}</td></tr>
      <tr><td>Under ${L.toFixed(2)}</td><td class="mono">${fmtP(pCashUnder)}</td><td class="mono">${isFinite(oUnder)?oUnder.toFixed(2):'—'}</td><td class="mono">${EV_under==null?'—':pct(EV_under)}</td><td class="mono">${K_under==null?'—':pct(K_under)}</td></tr>`;

    let ouBadges=[];
    if(isFinite(oOver)&&oOver>1&&isFinite(oUnder)&&oUnder>1){
      const overround=(1/oOver+1/oUnder)-1;
      ouBadges.push(badgeOverround('OU',overround));
    }else{
      ouBadges.push('<span class="badge badge-warn">Introduce cuotas OU para EV/Overround</span>');
    }
    if(EV_over!=null) ouBadges.push(badgeEV('Over',EV_over));
    if(EV_under!=null) ouBadges.push(badgeEV('Under',EV_under));
    $('#ouBadges').innerHTML=ouBadges.join(' ');

    // BTTS
    const pBTTS=1-Math.exp(-lamH)-Math.exp(-lamA)+Math.exp(-(lamT)), pNo=1-pBTTS;
    const bttsIsYes=pBTTS>=pNo, bttsLabel=bttsIsYes?'BTTS Sí':'BTTS No', bttsProb=bttsIsYes?pBTTS:pNo, bttsFair=1/Math.max(1e-12,bttsProb);
    $('#bestBTTS').innerHTML=`<div class="best btts"><span class="tag">Más probable</span><h3>${vs}</h3><div class="vbig mono">${bttsLabel} · ${fmtP(bttsProb)} · cuota ${fmtO(bttsFair)}</div></div>`;
    $('#tbodyBTTS').innerHTML=`
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTS)}</td><td class="mono">${fmtO(toOdds(pBTTS))}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pNo)}</td><td class="mono">${fmtO(toOdds(pNo))}</td></tr>`;
    const EV_yes=evDecimal(pBTTS,oYes), EV_no=evDecimal(pNo,oNo);
    const K_yes=kellyStake(pBTTS,oYes), K_no=kellyStake(pNo,oNo);
    $('#tbodyBTTSEV').innerHTML=`
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTS)}</td><td class="mono">${isFinite(oYes)?oYes.toFixed(2):'—'}</td><td class="mono">${EV_yes==null?'—':pct(EV_yes)}</td><td class="mono">${K_yes==null?'—':pct(K_yes)}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pNo)}</td><td class="mono">${isFinite(oNo)?oNo.toFixed(2):'—'}</td><td class="mono">${EV_no==null?'—':pct(EV_no)}</td><td class="mono">${K_no==null?'—':pct(K_no)}</td></tr>`;
    let bttsBadges=[];
    if(isFinite(oYes)&&oYes>1&&isFinite(oNo)&&oNo>1){
      const orBTTS=(1/oYes+1/oNo)-1;
      bttsBadges.push(badgeOverround('BTTS',orBTTS));
    }else{
      bttsBadges.push('<span class="badge badge-warn">Introduce cuotas BTTS para EV/Overround</span>');
    }
    if(EV_yes!=null) bttsBadges.push(badgeEV('BTTS Sí',EV_yes));
    if(EV_no!=null) bttsBadges.push(badgeEV('BTTS No',EV_no));
    $('#bttsBadges').innerHTML=bttsBadges.join(' ');

    // Resumen de edge
    const edgeItems=[];
    if(EV_over!=null) edgeItems.push(`<span class="badge ${EV_over>0?'badge-good':'badge-bad'}">OU Over · Edge ${pct(EV_over)}</span>`);
    if(EV_under!=null) edgeItems.push(`<span class="badge ${EV_under>0?'badge-good':'badge-bad'}">OU Under · Edge ${pct(EV_under)}</span>`);
    if(EV_yes!=null)   edgeItems.push(`<span class="badge ${EV_yes>0?'badge-good':'badge-bad'}">BTTS Sí · Edge ${pct(EV_yes)}</span>`);
    if(EV_no!=null)    edgeItems.push(`<span class="badge ${EV_no>0?'badge-good':'badge-bad'}">BTTS No · Edge ${pct(EV_no)}</span>`);
    $('#edgeBar').innerHTML = edgeItems.join(' ');

    // Explorador líneas
    const rows = sweepLines(lamT).map(r=>`
      <tr>
        <td class="mono">${r.L.toFixed(2)}</td>
        <td class="mono">${fmtP(r.pO)}</td>
        <td class="mono">${fmtO(1/Math.max(1e-12,r.pO))}</td>
        <td class="mono">${fmtP(r.pU)}</td>
        <td class="mono">${fmtO(1/Math.max(1e-12,r.pU))}</td>
      </tr>`).join('');
    $('#tbodySweep').innerHTML = rows;

    // Sugerencia de stake (Kelly¼ con cap y EV mínimo)
    const bk = parseFloat($('#bankroll').value)||0;
    const cap= parseFloat($('#capPct').value)||0;
    const minEdge = (parseFloat($('#minEdge').value)||0)/100;
    const evPairs = [
      {market:'OU', sel:'OU Over', line:L, p:pCashOver, odds:oOver, EV:EV_over, Kelly:K_over, overround: (isFinite(oOver)&&isFinite(oUnder)&&oOver>1&&oUnder>1)?(1/oOver+1/oUnder-1):null, wpl:over},
      {market:'OU', sel:'OU Under', line:L, p:pCashUnder, odds:oUnder, EV:EV_under, Kelly:K_under, overround: (isFinite(oOver)&&isFinite(oUnder)&&oOver>1&&oUnder>1)?(1/oOver+1/oUnder-1):null, wpl:under},
      {market:'BTTS', sel:'BTTS Sí', line:null, p:pBTTS, odds:oYes, EV:EV_yes, Kelly:K_yes, overround: (isFinite(oYes)&&isFinite(oNo)&&oYes>1&&oNo>1)?(1/oYes+1/oNo-1):null, wpl:null},
      {market:'BTTS', sel:'BTTS No', line:null, p:pNo, odds:oNo, EV:EV_no, Kelly:K_no, overround: (isFinite(oYes)&&isFinite(oNo)&&oYes>1&&oNo>1)?(1/oYes+1/oNo-1):null, wpl:null},
    ];
    evPairs.sort((a,b)=> (b.EV??-1)-(a.EV??-1));
    document.querySelectorAll('#pickOptions .chip').forEach(ch=> ch.classList.toggle('active', ch.dataset.pick===evPairs[0].sel));
    if(isFinite(evPairs[0].odds)) $('#stakeOdds').value = evPairs[0].odds || '';

    function stakeFromKelly(kFrac, bankroll, capPct){
      const capVal = (capPct/100)*bankroll;
      return Math.max(0, Math.min(bankroll*kFrac, capVal));
    }
    const best = evPairs.find(p=> (p.EV??-1) >= minEdge);
    if(best && isFinite(best.Kelly??0) && bk>0){
      const stake = stakeFromKelly(best.Kelly, bk, cap);
      $('#stakeSugg').innerHTML = `Sugerencia: <b>${best.sel}${best.line!=null?(' '+best.line.toFixed(2)):''
        }</b> · EV ${pct(best.EV)} · Kelly¼ ${pct(best.Kelly)} → <b>Stake: ${stake.toFixed(2)}</b>`;
    }else{
      $('#stakeSugg').textContent='Sin sugerencia (EV por debajo del umbral).';
    }

    // Guardar última evaluación p/registro y copiar pick
    window.__lastCalc = {pairs:evPairs, context:{home:h,away:a, lamT, L}};
  }

  // ---------- Registro con persistencia ----------
  const SAVEK="ou_btts_registro_v1";
  const saved = JSON.parse(localStorage.getItem(SAVEK)||"[]");
  const log = Array.isArray(saved)? saved: [];

  function addLog(){
    if(!window.__lastCalc){alert('Primero pulsa Calcular.');return;}
    const {home,away, lamT, L} = window.__lastCalc.context || {home:($('#homeTeam').value||'Local'), away:($('#awayTeam').value||'Visita'), lamT: null, L:null};
    const pickChip = document.querySelector('#pickOptions .chip.active');
    if(!pickChip){alert('Selecciona una apuesta.');return;}
    const selection = pickChip.dataset.pick;
    const oddsTaken = parseFloat($('#stakeOdds').value);
    if(!isFinite(oddsTaken)||oddsTaken<=1){alert('Ingresa la cuota tomada.');return;}
    const closing = parseFloat($('#closingOdds').value);
    const note = $('#note').value||'';

    const rowData = window.__lastCalc.pairs.find(p=>p.sel===selection);
    if(!rowData){alert('Recalcula primero.');return;}
    const CLV = (isFinite(closing)&&closing>0)? (oddsTaken/closing) : null;

    // win/push/loss si es OU (metadatos)
    let win=null,push=null,loss=null;
    if(rowData.market==='OU' && lamT!=null && L!=null){
      const wpl = selection.includes('Over') ? asianOver(lamT,L) : asianUnder(lamT,L);
      win = wpl.win; push=wpl.push; loss=wpl.loss;
    }

    const now = new Date();
    const item = {
      fecha: now.toISOString().replace('T',' ').slice(0,16),
      local: home, visita: away,
      mercado: rowData.market,
      linea: rowData.line,
      seleccion: selection,
      p: rowData.p,
      odds: oddsTaken,
      EV: (rowData.p*oddsTaken - 1),
      Kelly: kellyStake(rowData.p, oddsTaken) ?? null,
      overround: rowData.overround,
      cierre: isFinite(closing)?closing:null,
      clv: CLV,
      nota: note,
      win, push, loss
    };
    log.push(item);
    localStorage.setItem(SAVEK, JSON.stringify(log));
    renderLog();
    $('#closingOdds').value=''; $('#note').value='';
  }

  function renderLog(){
    const tb=$('#logBody');
    if(log.length===0){tb.innerHTML='<tr><td colspan="14" style="text-align:center;color:#9aa7ba;padding:16px">Sin registros</td></tr>'; renderKPIsLog(); return;}
    tb.innerHTML = log.map(it=>{
      const clv = (it.clv??1)-1;
      const cls = clv>0.02?'goodCLV':(clv<-0.02?'badCLV':'');
      return `<tr class="${cls}">
        <td>${it.fecha}</td>
        <td>${it.local}</td>
        <td>${it.visita}</td>
        <td>${it.mercado}</td>
        <td class="mono">${it.linea!==null&&it.linea!==undefined?Number(it.linea).toFixed(2):'—'}</td>
        <td>${it.seleccion}</td>
        <td class="mono">${fmtP(it.p)}</td>
        <td class="mono">${Number(it.odds).toFixed(2)}</td>
        <td class="mono">${pct(it.EV)}</td>
        <td class="mono">${it.Kelly==null?'—':pct(it.Kelly)}</td>
        <td class="mono">${it.overround==null?'—':pct(it.overround)}</td>
        <td class="mono">${it.cierre==null?'—':Number(it.cierre).toFixed(2)}</td>
        <td class="mono">${it.clv==null?'—':((it.clv-1)*100).toFixed(2)+'%'}</td>
        <td style="max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${it.nota||'—'}</td>
      </tr>`;
    }).join('');
    renderKPIsLog();
  }

  function exportCSV(){
    if(log.length===0){alert('No hay registros.');return;}
    const header = ['fecha','local','visita','mercado','linea','seleccion','p_modelo','cuota','EV','Kelly_1_4','overround','cierre','CLV','nota'];
    const rows = log.map(it=>[
      it.fecha,it.local,it.visita,it.mercado,(it.linea??''),it.seleccion,it.p,it.odds,it.EV,(it.Kelly??''),(it.overround??''),(it.cierre??''),(it.clv??''),(it.nota||'').replace(/[\n\r]+/g,' ')
    ]);
    const csv = [header].concat(rows).map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='registro_apuestas.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // KPIs del log
  function renderKPIsLog(){
    if(!log.length){ $('#kpisLog').innerHTML=''; return; }
    const n=log.length;
    const evAvg = log.reduce((a,b)=>a+(b.EV??0),0)/n;
    const kAvg  = log.reduce((a,b)=>a+(b.Kelly??0),0)/n;
    const clvAvg= log.reduce((a,b)=>a+((b.clv??1)-1),0)/n;
    const roi = log.reduce((a,b)=>a + ((b.p*b.odds)-1),0)/n;
    $('#kpisLog').innerHTML=`
      <div class="kpi"><div class="k">Bets</div><div class="v">${n}</div></div>
      <div class="kpi"><div class="k">EV medio</div><div class="v">${pct(evAvg)}</div></div>
      <div class="kpi"><div class="k">Kelly¼ medio</div><div class="v">${pct(kAvg)}</div></div>
      <div class="kpi"><div class="k">CLV medio</div><div class="v">${pct(clvAvg)}</div></div>
      <div class="kpi"><div class="k">ROI (modelo)</div><div class="v">${pct(roi)}</div></div>`;
  }

  // Guardar/Cargar JSON del registro
  $('#jsonSave').addEventListener('click', ()=>{
    if(!log.length){alert('No hay registros.');return;}
    const blob = new Blob([JSON.stringify(log,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='registro_apuestas.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#jsonLoad').addEventListener('click', ()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader();
      r.onload=()=>{ try{
        const arr=JSON.parse(r.result); if(!Array.isArray(arr)) throw 0;
        log.length=0; arr.forEach(x=>log.push(x));
        localStorage.setItem(SAVEK, JSON.stringify(log)); renderLog();
      }catch{ alert('JSON inválido'); } };
      r.readAsText(f);
    }; inp.click();
  });

  // Copiar mejor pick
  function copyBest(){
    const p=window.__lastCalc?.pairs?.[0]; if(!p) return;
    const {home,away}=window.__lastCalc.context||{};
    const text = `${home} vs ${away} | ${p.sel}${p.line!=null?(' '+p.line.toFixed(2)):''
     } | p=${(p.p*100).toFixed(1)}% | EV=${p.EV!=null?(p.EV*100).toFixed(1)+'%':'—'} | Kelly¼=${p.Kelly!=null?(p.Kelly*100).toFixed(1)+'%':'—'}`;
    navigator.clipboard.writeText(text);
  }

  // ---------- Eventos UI ----------
  $('#calcBtn').addEventListener('click', calc);
  $('#addBtn').addEventListener('click', addLog);
  $('#csvBtn').addEventListener('click', exportCSV);
  $('#copyBtn').addEventListener('click', copyBest);

  $('#presets').addEventListener('click', e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    const v=parseFloat(chip.textContent); if(isNaN(v)) return;
    $('#line').value=v; $('#lineRange').value=v; $('#lineLbl').textContent=v.toFixed(2);
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c===chip));
  });
  $('#lineRange').addEventListener('input', e=>{const v=parseFloat(e.target.value); $('#line').value=v; $('#lineLbl').textContent=v.toFixed(2)});
  $('#line').addEventListener('input', e=>{const v=parseFloat(e.target.value||0); $('#lineRange').value=v; $('#lineLbl').textContent=v.toFixed(2)});

  document.getElementById('pickOptions').addEventListener('click', e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    document.querySelectorAll('#pickOptions .chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
  });

  // Enter para recalcular rápido
  ['homeTeam','awayTeam','gfH','gfA','line','oddsOver','oddsUnder','oddsBTTSYes','oddsBTTSNo','stakeOdds','closingOdds','note','bankroll','capPct','minEdge']
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ calc(); }}); });

  // Atajos de teclado
  document.addEventListener('keydown', (e)=>{
    if(e.key==='c' && (e.ctrlKey||e.metaKey)){ calc(); }
    if(e.key==='s' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); exportCSV(); }
  });

  // Render inicial
  renderLog();
})();
</script>
</body>
</html>
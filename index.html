<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Poisson xG Pro - First Half</title>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --text: #334155; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: var(--text); padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        textarea { width: 100%; height: 120px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 12px; }
        .stats-bar { background: #f1f5f9; padding: 15px; border-radius: 8px; margin: 20px 0; display: flex; justify-content: space-around; font-weight: bold; font-size: 0.9rem; }
        select, button { padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; width: 100%; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; }
        button:hover { background: #2563eb; }
        .result-box { margin-top: 25px; padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; display: none; }
        .metric { text-align: center; }
        .metric-val { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <h2>Calculadora Poisson con xG (Fuerza Relativa)</h2>
    
    <div class="grid">
        <div>
            <label>Tabla Local (AT HOME)</label>
            <textarea id="rawHome" placeholder="Pega aquí la tabla local..."></textarea>
        </div>
        <div>
            <label>Tabla Visitante (AWAY)</label>
            <textarea id="rawAway" placeholder="Pega aquí la tabla visitante..."></textarea>
        </div>
    </div>

    <button onclick="processLeague()" style="background: #64748b; margin: 15px 0;">1. Analizar Liga y Promedios</button>

    <div id="leagueStats" class="stats-bar" style="display:none;">
        <span>Promedio Goles Local (Liga): <span id="avgG_H"></span></span>
        <span>Promedio Goles Visita (Liga): <span id="avgG_A"></span></span>
    </div>

    <div class="grid" style="margin-bottom: 20px;">
        <div>
            <label>Selecciona Local</label>
            <select id="selHome"></select>
        </div>
        <div>
            <label>Selecciona Visitante</label>
            <select id="selAway"></select>
        </div>
    </div>

    <button onclick="calculateXG()">2. Calcular xG y Probabilidades</button>

    <div id="results" class="result-box">
        <div class="grid">
            <div class="metric"><div>xG Local</div><div id="xgH" class="metric-val"></div></div>
            <div class="metric"><div>xG Visita</div><div id="xgA" class="metric-val"></div></div>
        </div>
        <hr style="margin: 20px 0; opacity: 0.2;">
        <div class="grid">
            <div class="metric"><div>Prob. Over 0.5 HT</div><div id="p05" class="metric-val"></div></div>
            <div class="metric"><div>Prob. Over 1.5 HT</div><div id="p15" class="metric-val"></div></div>
        </div>
    </div>
</div>

<script>
let dbH = {}, dbA = {}, avgHomeG = 0, avgAwayG = 0;

function processData(text) {
    const teams = {};
    let totalG = 0, totalP = 0;
    text.split('\n').forEach(line => {
        const m = line.match(/([a-zA-Z\s.-]+?)\t?(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)/);
        if (m) {
            const name = m[1].trim();
            const gp = parseInt(m[2]), gf = parseInt(m[6]), ga = parseInt(m[7]);
            teams[name] = { gp, gf, ga, att: gf/gp, def: ga/gp };
            totalG += gf; totalP += gp;
        }
    });
    return { teams, avg: totalG / totalP };
}

function processLeague() {
    const resH = processData(document.getElementById('rawHome').value);
    const resA = processData(document.getElementById('rawAway').value);
    dbH = resH.teams; dbA = resA.teams;
    avgHomeG = resH.avg; avgAwayG = resA.avg;

    document.getElementById('avgG_H').innerText = avgHomeG.toFixed(3);
    document.getElementById('avgG_A').innerText = avgAwayG.toFixed(3);
    document.getElementById('leagueStats').style.display = 'flex';

    fillSelect('selHome', dbH); fillSelect('selAway', dbA);
}

function fillSelect(id, data) {
    const s = document.getElementById(id); s.innerHTML = "";
    Object.keys(data).forEach(t => s.innerHTML += `<option value="${t}">${t}</option>`);
}

function calculateXG() {
    const tH = dbH[document.getElementById('selHome').value];
    const tA = dbA[document.getElementById('selAway').value];

    // FUERZA RELATIVA
    const attackH = tH.att / avgHomeG; 
    const defenseA = tA.def / avgAwayG;
    const xgH = attackH * defenseA * avgHomeG;

    const attackA = tA.att / avgAwayG;
    const defenseH = tH.def / avgHomeG;
    const xgA = attackA * defenseH * avgAwayG;

    // POISSON
    const p0H = Math.exp(-xgH), p0A = Math.exp(-xgA);
    const p1H = Math.exp(-xgH) * xgH, p1A = Math.exp(-xgA) * xgA;

    const prob00 = p0H * p0A;
    const over05 = (1 - prob00) * 100;
    const over15 = (1 - (prob00 + (p1H * p0A) + (p0H * p1A))) * 100;

    document.getElementById('results').style.display = 'block';
    document.getElementById('xgH').innerText = xgH.toFixed(2);
    document.getElementById('xgA').innerText = xgA.toFixed(2);
    document.getElementById('p05').innerText = over05.toFixed(2) + "%";
    document.getElementById('p15').innerText = over15.toFixed(2) + "%";
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Betting Intelligence Pro - Visual Dashboard</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; font-size: 14px; line-height: 1.4; margin: 0; }
        .container { max-width: 1600px; margin: auto; padding: 20px; }
        
        /* Layout Superior */
        .top-panel { display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin-bottom: 25px; }
        textarea { width: 100%; height: 100px; background: #334155; color: white; border: 1px solid #475569; border-radius: 12px; padding: 12px; font-family: monospace; resize: none; }
        
        /* Dashboard Stats */
        .stats-summary { background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%); padding: 20px; border-radius: 12px; border: 2px solid var(--gold); text-align: center; }
        .roi-huge { font-size: 32px; font-weight: 800; display: block; }
        .unit-badge { font-size: 18px; color: var(--success); font-weight: bold; }

        /* Grid de Equipos - SIEMPRE VISIBLE */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .team-card { background: var(--card); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent); position: relative; transition: transform 0.2s; }
        .team-card:hover { transform: translateY(-3px); background: #2d3a4f; }
        .team-card.high-value { border: 1px solid var(--gold); background: rgba(251, 191, 36, 0.05); }
        
        .team-name { font-size: 16px; font-weight: 700; color: var(--gold); margin-bottom: 8px; display: block; }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }
        
        /* Badges */
        .badge { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .pos { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .neg { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .odd-range { background: #334155; color: #fff; padding: 4px 8px; border-radius: 6px; font-family: monospace; font-size: 11px; margin-top: 8px; display: inline-block; }

        /* Secciones */
        h3 { border-bottom: 1px solid #334155; padding-bottom: 8px; margin-top: 30px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; width: 100%; }
        .filters { display: flex; gap: 10px; margin-bottom: 20px; background: #1e293b; padding: 15px; border-radius: 12px; overflow-x: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-panel">
        <div>
            <textarea id="dataInput" placeholder="Pega aquí los datos de Excel (Liga, Fecha, Partido, Resultado, Cuota)..."></textarea>
            <button class="btn" onclick="processData()">ANALIZAR EQUIPOS Y VALOR</button>
        </div>
        <div class="stats-summary">
            <span id="mainRoi" class="roi-huge">ROI: 0%</span>
            <span id="mainUnits" class="unit-badge">0.00 UDS</span>
            <div id="mainCount" style="font-size: 11px; opacity: 0.6; margin-top: 5px;">0 partidos analizados</div>
        </div>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="filters">
            <div style="min-width: 200px;">
                <strong>Filtro Rápido:</strong><br>
                <input type="text" id="teamSearch" placeholder="Buscar equipo..." onkeyup="filterTeams()" style="background:#0f172a; border:1px solid #475569; color:white; padding:5px; border-radius:4px; width:100%;">
            </div>
            <div id="quickStats"></div>
        </div>

        <div id="leaguesContainer">
            </div>
    </div>
</div>

<script>
let masterData = [];

function processData() {
    const input = document.getElementById('dataInput').value.trim();
    if (!input) return;

    const lines = input.split('\n');
    const headers = lines[0].toLowerCase().split('\t');
    
    // Mapeo dinámico de columnas
    const idx = {
        league: headers.findIndex(h => h.includes('liga') || h.includes('league')),
        match: headers.findIndex(h => h.includes('match') || h.includes('partido')),
        result: headers.lastIndexOf('result') !== -1 ? headers.lastIndexOf('result') : headers.findIndex(h => h.includes('res')),
        odd: headers.findIndex(h => h.includes('odd') || h.includes('cuota'))
    };

    let leagues = {};
    let totalS = 0, totalR = 0;

    lines.slice(1).forEach(line => {
        const col = line.split('\t');
        if (col.length < 4) return;

        const leagueName = col[idx.league] || "Otras";
        const match = col[idx.match] || "";
        const odd = parseFloat(col[idx.odd]?.replace(',', '.')) || 0;
        const isWin = col.some(c => c.toLowerCase() === 'winning' || c.toLowerCase() === 'ganada');
        
        if (odd > 0 && match.includes(' - ')) {
            const [hT, aT] = match.split(' - ');
            totalS++;
            if (isWin) totalR += odd;

            if (!leagues[leagueName]) leagues[leagueName] = {};
            
            [hT, aT].forEach(team => {
                if (!leagues[leagueName][team]) leagues[leagueName][team] = { s: 0, r: 0, w: 0, maxO: 0, minO: 999 };
                let t = leagues[leagueName][team];
                t.s++;
                if (isWin) {
                    t.r += odd;
                    t.w++;
                    t.maxO = Math.max(t.maxO, odd);
                    t.minO = Math.min(t.minO, odd);
                }
            });
        }
    });

    renderDashboard(leagues, totalS, totalR);
}

function renderDashboard(leagues, ts, tr) {
    const container = document.getElementById('leaguesContainer');
    container.innerHTML = "";
    
    // Global Stats
    const totalRoi = ((tr/ts - 1) * 100).toFixed(2);
    document.getElementById('mainRoi').innerText = `ROI: ${totalRoi}%`;
    document.getElementById('mainRoi').className = `roi-huge ${totalRoi >= 0 ? 'pos' : 'neg'}`;
    document.getElementById('mainUnits').innerText = `${(tr - ts).toFixed(2)} UNIDADES`;
    document.getElementById('mainCount').innerText = `${ts} partidos en la muestra`;

    // Render por Ligas
    Object.keys(leagues).sort().forEach(lName => {
        const leagueTitle = document.createElement('h3');
        leagueTitle.innerText = lName;
        container.appendChild(leagueTitle);

        const grid = document.createElement('div');
        grid.className = "team-grid";
        
        Object.entries(leagues[lName])
            .sort((a, b) => (b[1].r - b[1].s) - (a[1].r - a[1].s))
            .forEach(([tName, stats]) => {
                const roi = ((stats.r / stats.s - 1) * 100).toFixed(1);
                const profit = (stats.r - stats.s).toFixed(2);
                const hitRate = stats.w / stats.s;
                const fairOdd = hitRate > 0 ? (1 / hitRate).toFixed(2) : "N/A";
                
                const card = document.createElement('div');
                card.className = `team-card ${roi >= 20 ? 'high-value' : ''}`;
                card.innerHTML = `
                    <span class="team-name">${tName}</span>
                    <div class="metric-row">
                        <span>Rentabilidad:</span>
                        <span class="badge ${roi >= 0 ? 'pos' : 'neg'}">${roi}% ROI</span>
                    </div>
                    <div class="metric-row">
                        <span>Balance:</span>
                        <span style="color:${profit >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">${profit >= 0 ? '+' : ''}${profit} u.</span>
                    </div>
                    <div class="metric-row">
                        <span>Muestra:</span>
                        <span>${stats.s} partidos (${stats.w}V)</span>
                    </div>
                    <div class="odd-range">
                        Mín: @${fairOdd} | Máx Hist: @${stats.maxO.toFixed(2)}
                    </div>
                `;
                grid.appendChild(card);
            });
        
        container.appendChild(grid);
    });

    document.getElementById('dashboard').style.display = 'block';
}

function filterTeams() {
    const val = document.getElementById('teamSearch').value.toLowerCase();
    document.querySelectorAll('.team-card').forEach(card => {
        const name = card.querySelector('.team-name').innerText.toLowerCase();
        card.style.display = name.includes(val) ? 'block' : 'none';
    });
}
</script>

</body>
</html>

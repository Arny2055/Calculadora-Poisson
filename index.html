<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Backtesting JSON</title>
<style>
  body{font-family:sans-serif;background:#0f1724;color:#eee;padding:20px}
  .card{background:#1e293b;padding:14px;border-radius:8px;margin-bottom:16px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  td,th{border:1px solid #444;padding:4px;text-align:left}
  th{background:#334155}
</style>
</head>
<body>

<h1>Backtesting JSON (Patrones)</h1>
<input type="file" id="fileInput" accept=".json" />

<div id="output"></div>

<script>
function normalizeKey(obj, key){
  return obj[key] || obj[key.trim()] || null;
}

function addStat(map, key, profit){
  if(!map[key]) map[key] = {count:0,profit:0};
  map[key].count++;
  map[key].profit += profit;
}

function oddsRange(odd){
  if(odd<1.5) return "1.01 - 1.49";
  if(odd<2) return "1.50 - 1.99";
  if(odd<3) return "2.00 - 2.99";
  return "3.00+";
}

document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    try {
      let data = JSON.parse(ev.target.result);
      runBacktest(data);
    } catch(err){
      document.getElementById("output").innerHTML = 
        "<b>Error al leer JSON:</b> " + err.message;
    }
  };
  reader.readAsText(file);
});

function runBacktest(records){
  const stake = 1;
  let total=0, profit=0, ganado=0, perdido=0;
  let leagues={}, teams={}, oddsBuckets={};

  for(const r of records){
    let odd = Number(normalizeKey(r," Odd ")||normalizeKey(r,"Odd")||0);
    let res = (normalizeKey(r," Result ")||normalizeKey(r,"Result")||"").toLowerCase();
    let league = normalizeKey(r," League ")||normalizeKey(r,"League")||"Desconocida";
    let match = normalizeKey(r," Match ")||normalizeKey(r,"Match")||"";

    let p=0;
    if(res.includes("win")) p=(odd-1)*stake;
    else if(res.includes("lose")) p=-stake;

    profit+=p;
    if(p>0) ganado+=p; else if(p<0) perdido+=Math.abs(p);
    total++;

    addStat(leagues, league, p);

    if(match.includes("-")){
      let [home,away] = match.split("-").map(s=>s.trim());
      addStat(teams, home, p);
      addStat(teams, away, p);
    }

    if(odd>1){
      let bucket = oddsRange(odd);
      addStat(oddsBuckets, bucket, p);
    }
  }

  const roi = total? (profit/total*100):0;

  let html = `<div class="card">
  <h3>Resumen</h3>
  Apuestas: ${total}<br>
  ✅ Ganado: ${ganado.toFixed(2)}<br>
  ❌ Perdido: ${perdido.toFixed(2)}<br>
  Profit neto: ${profit.toFixed(2)}<br>
  ROI: ${roi.toFixed(2)}%</div>`;

  html += makeTable(leagues,"Ligas");
  html += makeTable(teams,"Equipos");
  html += makeTable(oddsBuckets,"Rangos de Cuotas");

  document.getElementById("output").innerHTML = html;
}

function makeTable(map,label){
  let rows = Object.entries(map).map(([k,v])=>
    `<tr><td>${k}</td><td>${v.count}</td><td>${v.profit.toFixed(2)}</td></tr>`
  ).sort((a,b)=> b.match(/-?\d+\.\d+/)-a.match(/-?\d+\.\d+/));
  return `<div class="card"><h3>${label}</h3><table>
    <tr><th>${label}</th><th>Apuestas</th><th>Profit</th></tr>
    ${rows.join("")}
  </table></div>`;
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analizador Pro - Control de Calidad Total</title>
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; 
            --success: #10b981; --gold: #fbbf24; --danger: #ef4444; --border: #334155; 
            --input-bg: #0f172a;
        }
        
        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; transition: all 0.2s ease; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px; 
            line-height: 1.5;
        }

        .container { max-width: 500px; margin: auto; }
        
        /* CABECERA */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .header h2 { margin: 0; font-size: 20px; letter-spacing: -0.5px; }
        .btn-nav { 
            background: var(--card); 
            border: 1px solid var(--border); 
            color: var(--text); 
            padding: 10px 18px; 
            border-radius: 10px; 
            text-decoration: none; 
            font-size: 11px; 
            font-weight: 800; 
            text-transform: uppercase;
        }

        /* PANEL DE FILTROS DE MANIPULACIÓN */
        .quality-filters { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            border: 1px solid var(--accent); 
            border-radius: 20px; 
            padding: 20px; 
            margin-bottom: 25px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .filter-title { 
            font-size: 10px; 
            font-weight: 900; 
            color: var(--accent); 
            text-transform: uppercase; 
            margin-bottom: 15px; 
            display: block; 
            letter-spacing: 1px;
            text-align: center;
        }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .f-group { display: flex; flex-direction: column; gap: 8px; }
        .f-group label { font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        .f-group input { 
            background: rgba(15, 23, 42, 0.7); 
            border: 1px solid var(--border); 
            color: var(--gold); 
            padding: 12px; 
            border-radius: 12px; 
            font-weight: 800; 
            text-align: center; 
            font-size: 15px;
        }

        /* TARJETA PRINCIPAL DE ANÁLISIS */
        .card { 
            background: var(--card); 
            border-radius: 20px; 
            padding: 25px; 
            border: 1px solid var(--border); 
            margin-bottom: 25px; 
        }
        .input-main-group { margin-bottom: 20px; }
        label { 
            display: block; 
            font-size: 10px; 
            font-weight: 800; 
            color: #64748b; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        input[type="text"], input[type="number"] { 
            width: 100%; 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            color: white; 
            padding: 14px; 
            border-radius: 12px; 
            font-size: 15px; 
            font-weight: 600;
            outline: none; 
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* BOX DE RESULTADOS */
        .result-box { 
            background: #0f172a; 
            border-radius: 15px; 
            padding: 20px; 
            text-align: center; 
            margin: 25px 0; 
            border: 1px solid var(--border);
            position: relative;
        }
        .res-val { font-size: 32px; font-weight: 900; color: var(--success); display: block; line-height: 1; margin-bottom: 5px; }
        .res-label { font-size: 9px; text-transform: uppercase; color: #475569; font-weight: 800; letter-spacing: 1.5px; }

        /* BOTÓN Y ERRORES */
        .btn-main { 
            width: 100%; 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 18px; 
            border-radius: 15px; 
            font-size: 14px; 
            font-weight: 900; 
            cursor: pointer; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-main:disabled { 
            background: #1e293b; 
            color: #475569; 
            cursor: not-allowed; 
            box-shadow: none;
            border: 1px solid var(--border);
        }
        
        #msg-error { 
            color: var(--danger); 
            font-size: 11px; 
            text-align: center; 
            margin-top: 15px; 
            font-weight: 700; 
            padding: 10px;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.1);
            display: none; 
        }

        .helper-text { font-size: 10px; color: #64748b; margin-top: -10px; margin-bottom: 15px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Analizador 360°</h2>
        <a href="estrategia.html" class="btn-nav">Portafolio</a>
    </div>

    <div class="quality-filters">
        <span class="filter-title">⚙️ Requisitos de Validación</span>
        <div class="filter-grid">
            <div class="f-group">
                <label>Partidos Mín.</label>
                <input type="number" id="minGames" value="10" oninput="calculate()">
            </div>
            <div class="f-group">
                <label>ROI Mínimo (%)</label>
                <input type="number" id="minRoi" value="5" oninput="calculate()">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="input-main-group">
            <label>Equipo o Liga de Análisis</label>
            <input type="text" id="equipo" placeholder="Ej: Premier League / Over 2.5">
        </div>

        <div class="filter-grid">
            <div class="f-group">
                <label>Partidos Totales</label>
                <input type="number" id="partidos" value="10" oninput="calculate()">
            </div>
            <div class="f-group">
                <label>Aciertos (Wins)</label>
                <input type="number" id="wins" value="7" oninput="calculate()">
            </div>
        </div>
        <br>
        
        <div class="input-main-group">
            <label>Cuota Promedio (Decimal)</label>
            <input type="number" id="cuota" value="1.80" step="0.01" oninput="calculate()">
            <span class="helper-text">La cuota a la que sueles apostar este mercado.</span>
        </div>

        <div class="result-box">
            <span id="roiVal" class="res-val">0.0%</span>
            <span class="res-label">Expectativa de Retorno (ROI)</span>
        </div>

        <button id="saveBtn" class="btn-main" onclick="saveData()">Guardar en Mi Portafolio</button>
        <div id="msg-error"></div>
    </div>
</div>

<script>
// Función de cálculo principal y validación de filtros
function calculate() {
    const p = parseFloat(document.getElementById('partidos').value) || 0;
    const w = parseFloat(document.getElementById('wins').value) || 0;
    const c = parseFloat(document.getElementById('cuota').value) || 0;
    
    // Captura de filtros dinámicos definidos por el usuario
    const minP = parseFloat(document.getElementById('minGames').value) || 0;
    const minR = parseFloat(document.getElementById('minRoi').value) || 0;

    if (p > 0) {
        const prob = (w / p);
        const roi = ((prob * c) - 1) * 100;
        const roiEl = document.getElementById('roiVal');
        
        // Actualización visual del ROI
        roiEl.innerText = (roi > 0 ? '+' : '') + roi.toFixed(1) + "%";
        roiEl.style.color = roi >= minR ? 'var(--success)' : (roi > 0 ? 'var(--gold)' : 'var(--danger)');

        // Lógica de validación para el botón de guardado
        const saveBtn = document.getElementById('saveBtn');
        const errorMsg = document.getElementById('msg-error');

        // Solo habilitar si cumple AMBOS criterios de calidad
        if (p >= minP && roi >= minR) {
            saveBtn.disabled = false;
            errorMsg.style.display = 'none';
            saveBtn.style.background = 'var(--accent)';
        } else {
            saveBtn.disabled = true;
            errorMsg.style.display = 'block';
            
            let razones = [];
            if (p < minP) razones.push(`faltan ${minP - p} partidos`);
            if (roi < minR) razones.push(`ROI bajo (${roi.toFixed(1)}% vs ${minR}%)`);
            
            errorMsg.innerText = "No cumple calidad: " + razones.join(" y ") + ".";
        }

        return { 
            roi: roi.toFixed(1), 
            prob: (prob * 100).toFixed(1),
            valid: (p >= minP && roi >= minR)
        };
    }
}

// Función para persistir los datos en localStorage
function saveData() {
    const equipo = document.getElementById('equipo').value || "Estrategia Sin Nombre";
    const p = document.getElementById('partidos').value;
    const w = document.getElementById('wins').value;
    const c = document.getElementById('cuota').value;
    const res = calculate();

    // Verificación de seguridad extra
    if (!res || !res.valid) {
        alert("La estrategia no cumple los requisitos mínimos de calidad.");
        return;
    }

    const nuevaEstrategia = {
        equipo: equipo,
        partidos: p,
        wins: w,
        cuota: c,
        roi: res.roi,
        prob: res.prob,
        // Unidades de valor calculadas como el 10% del ROI (Kelly abreviado)
        unidades: Math.max(0.1, (res.roi / 10)).toFixed(2),
        fecha: new Date().toLocaleDateString()
    };

    // Obtener datos previos
    let store = JSON.parse(localStorage.getItem('bettingStrategy') || "[]");
    
    // Evitar duplicados exactos en la misma sesión
    const existe = store.find(item => item.equipo === equipo && item.roi === res.roi);
    if (existe) {
        if (!confirm("Ya existe una estrategia idéntica. ¿Deseas guardarla de todos modos?")) return;
    }

    store.push(nuevaEstrategia);
    localStorage.setItem('bettingStrategy', JSON.stringify(store));

    // Feedback al usuario
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.innerText = "¡GUARDADO!";
    saveBtn.style.background = "var(--success)";
    
    setTimeout(() => {
        window.location.href = "estrategia.html";
    }, 800);
}

// Inicializar la calculadora al cargar la página
window.onload = () => {
    // Cargar últimos filtros usados si existen (opcional)
    const savedMinP = localStorage.getItem('cfg_minP');
    const savedMinR = localStorage.getItem('cfg_minR');
    if (savedMinP) document.getElementById('minGames').value = savedMinP;
    if (savedMinR) document.getElementById('minRoi').value = savedMinR;
    
    calculate();
};

// Guardar configuración de filtros automáticamente al cambiar
document.getElementById('minGames').addEventListener('change', (e) => localStorage.setItem('cfg_minP', e.target.value));
document.getElementById('minRoi').addEventListener('change', (e) => localStorage.setItem('cfg_minR', e.target.value));
</script>

</body>
</html>

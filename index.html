<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Backtesting ROI por Equipo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f2f2f2; padding:20px; }
.card { background:white; padding:20px; border-radius:12px; 
        box-shadow:0 2px 12px rgba(0,0,0,0.15); margin-bottom:25px; }
h2 { margin-bottom:15px; }
table { width:100%; border-collapse:collapse; }
th { background:#1f1f1f; color:white; padding:8px; }
td { padding:6px; border:1px solid #ddd; text-align:center; }
button {
    background:#007BFF; border:none; padding:12px 20px;
    color:white; border-radius:10px; font-size:16px; cursor:pointer;
}
.good { color:green; font-weight:bold; }
.bad { color:red; font-weight:bold; }
.msg { padding:10px; background:#e8e8e8; border-radius:8px; margin-bottom:15px; }
</style>
</head>
<body>

<h1>üìä Backtesting ROI por Equipo</h1>

<div id="message" class="msg">Cargue los archivos para comenzar.</div>

<div class="card">
    <h2>üìÅ Cargar Historial (backtesting)</h2>
    <input type="file" id="historialFile" accept=".json">
</div>

<div class="card">
    <h2>üìÅ Cargar Partidos Futuros</h2>
    <input type="file" id="futurosFile" accept=".json">
</div>

<div class="card">
    <button id="runBtn">üîç Hacer Backtesting</button>
</div>

<div class="card">
    <h2>Resultados del Backtesting (por partido futuro)</h2>
    <table id="predictTable">
        <thead>
            <tr>
                <th>Partido</th>
                <th>ROI Local</th>
                <th>ROI Visitante</th>
                <th># de Partidos Analizados</th>
                <th>Equipo M√°s Rentable</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
let historialData = [];
let futurosData = [];

const msg = m => document.getElementById("message").innerText = m;

// --- JSON flexible ---
function safeJSON(text) {
    try {
        // JSON sin corchetes ‚Üí lo convertimos a array
        if (!text.trim().startsWith("[")) {
            let fixed = "[" + text.trim();
            fixed = fixed.replace(/,\s*$/, "") + "]";
            return JSON.parse(fixed);
        }
        return JSON.parse(text);
    } catch {
        msg("‚ùå Error al leer el archivo JSON. Revise el formato.");
        return null;
    }
}

// --- CARGA DE ARCHIVOS ---
document.getElementById("historialFile").addEventListener("change", e => {
    let file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        let data = safeJSON(ev.target.result);
        if (data) {
            historialData = data;
            msg("‚úî Historial cargado correctamente.");
        }
    };
    reader.readAsText(file);
});

document.getElementById("futurosFile").addEventListener("change", e => {
    let file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        let data = safeJSON(ev.target.result);
        if (data) {
            futurosData = data;
            msg("‚úî Partidos futuros cargados.");
        }
    };
    reader.readAsText(file);
});

// --- BOT√ìN ---
document.getElementById("runBtn").addEventListener("click", () => {
    if (!historialData.length || !futurosData.length) {
        msg("‚ö† Debe cargar ambos archivos.");
        return;
    }

    msg("Procesando Backtesting...");
    runBacktesting();
    msg("‚úî Backtesting completado.");
});

// --- ROI Individual por equipo ---
function computeROI(team) {
    let matches = 0;
    let profit = 0;

    historialData.forEach(m => {
        if (!m.Match || !m.Odd || !m.Result) return;

        const [home, away] = m.Match.split(" - ").map(x => x.trim());
        if (team !== home && team !== away) return;

        matches++;

        let gain = (m.Result === "Winning")
            ? (parseFloat(m.Odd) - 1)
            : -1;

        profit += gain;
    });

    return {
        matches,
        roi: matches > 0 ? (profit / matches * 100) : 0,
        profit
    };
}

// --- BACKTESTING ---
function runBacktesting() {
    const tbody = document.querySelector("#predictTable tbody");
    tbody.innerHTML = "";

    futurosData.forEach(m => {
        const [home, away] = m.Match.split(" - ").map(x => x.trim());

        const homeROI = computeROI(home);
        const awayROI = computeROI(away);

        const best = 
            homeROI.roi > awayROI.roi ? home :
            awayROI.roi > homeROI.roi ? away :
            "Iguales";

        tbody.innerHTML += `
            <tr>
                <td>${m.Match}</td>
                <td class="${homeROI.roi >= 0 ? 'good' : 'bad'}">${homeROI.roi.toFixed(2)}%</td>
                <td class="${awayROI.roi >= 0 ? 'good' : 'bad'}">${awayROI.roi.toFixed(2)}%</td>
                <td>${homeROI.matches + awayROI.matches}</td>
                <td><b>${best}</b></td>
            </tr>
        `;
    });
}
</script>

</body>
</html>
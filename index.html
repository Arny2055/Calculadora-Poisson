<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo de Regresión de Poisson con Muestra Limitada para O2.5</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        h1 { color: #d9534f; text-align: center; margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        textarea { height: 200px; resize: vertical; }
        button { background-color: #d9534f; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; margin-top: 20px; width: 100%; transition: background-color 0.3s; }
        button:hover { background-color: #c9302c; }
        #resultados { margin-top: 30px; padding: 20px; border: 2px solid #d9534f; border-radius: 8px; background-color: #fff0f0; }
        #resultados h2 { color: #d9534f; border-bottom: 2px solid #d9534f; padding-bottom: 10px; margin-top: 0; }
        .result-item { margin-top: 10px; padding: 8px; border-left: 4px solid #d9534f; background-color: #fff; border-radius: 4px; }
        .alert-error { color: #dc3545; font-weight: bold; margin-top: 15px; }
        .simulacion-notice { color: #f0ad4e; background-color: #fcf8e3; padding: 10px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #f0ad4e; }
        .prediction { font-size: 1.5em; color: #1e7e34; font-weight: bold; }
        .data-summary { font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Modelo de Regresión de Poisson Simulado para Over 2.5</h1>
    <div class="simulacion-notice">
        **Muestra de Datos:** El script solo utilizará entre **8 y 10 partidos** de la lista histórica para calcular las medias de goles de cada equipo en su respectivo rol (Local o Visitante).
    </div>

    <form id="poissonForm">
        <label for="liga">Liga a Pronosticar:</label>
        <input type="text" id="liga" value="Brazil Serie B" required>

        <label for="local">Equipo Local:</label>
        <input type="text" id="local" value="ABC" required>

        <label for="visita">Equipo Visitante:</label>
        <input type="text" id="visita" value="Mirassol" required>

        <label for="jsonInput">Pega un **array de JSONs** (Partidos Históricos) aquí:</label>
        <textarea id="jsonInput" required>
[
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Mirassol", "GolesLocal": 1, "GolesVisita": 2},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Sport Recife", "GolesLocal": 0, "GolesVisita": 0},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Guarani", "GolesLocal": 2, "GolesVisita": 1},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Vasco", "GolesLocal": 1, "GolesVisita": 1},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Nautico", "GolesLocal": 2, "GolesVisita": 0},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Cruzeiro", "GolesLocal": 0, "GolesVisita": 2},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Ceara", "GolesLocal": 3, "GolesVisita": 0},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Santos", "GolesLocal": 1, "GolesVisita": 3},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Gremio", "GolesLocal": 2, "GolesVisita": 2},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Palmeiras", "GolesLocal": 1, "GolesVisita": 0},
  {"League": "Brazil Serie B", "Home": "ABC", "Away": "Corinthians", "GolesLocal": 0, "GolesVisita": 1},

  {"League": "Brazil Serie B", "Home": "Mirassol", "Away": "ABC", "GolesLocal": 1, "GolesVisita": 0},
  {"League": "Brazil Serie B", "Home": "Vitoria", "Away": "Mirassol", "GolesLocal": 1, "GolesVisita": 2},
  {"League": "Brazil Serie B", "Home": "Ceara", "Away": "Mirassol", "GolesLocal": 3, "GolesVisita": 1},
  {"League": "Brazil Serie B", "Home": "Bahia", "Away": "Mirassol", "GolesLocal": 0, "GolesVisita": 1},
  {"League": "Brazil Serie B", "Home": "Goias", "Away": "Mirassol", "GolesLocal": 2, "GolesVisita": 2},
  {"League": "Brazil Serie B", "Home": "Atletico GO", "Away": "Mirassol", "GolesLocal": 1, "GolesVisita": 0},
  {"League": "Brazil Serie B", "Home": "Botafogo", "Away": "Mirassol", "GolesLocal": 3, "GolesVisita": 2},
  {"League": "Brazil Serie B", "Home": "Cruzeiro", "Away": "Mirassol", "GolesLocal": 0, "GolesVisita": 3},
  {"League": "Brazil Serie B", "Home": "Santos", "Away": "Mirassol", "GolesLocal": 1, "GolesVisita": 1},
  {"League": "Brazil Serie B", "Home": "Fluminense", "Away": "Mirassol", "GolesLocal": 2, "GolesVisita": 0},
  {"League": "Brazil Serie B", "Home": "Internacional", "Away": "Mirassol", "GolesLocal": 1, "GolesVisita": 2}
]
        </textarea>
        
        <button type="submit">Calcular Probabilidad O2.5 con Poisson</button>
    </form>

    <div id="resultados">
        <h2>Predicción del Modelo de Poisson</h2>
        <p class="alert-error" id="errorMsg" style="display: none;"></p>
        <div id="modelOutput">
            <p>Ajusta el JSON con partidos históricos y ejecuta el modelo.</p>
        </div>
    </div>
</div>

<script>
    // Función para calcular la probabilidad de Poisson P(X=k | lambda)
    function poisson_prob(k, lambda) {
        if (k < 0) return 0;
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }

    // Función factorial
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }

    // Función para filtrar y limitar los datos
    function filterAndLimitData(history, team, role, maxCount = 10, minCount = 8) {
        const filtered = history
            // Solo tomamos partidos donde el equipo es el 'Home' o 'Away'
            .filter(match => (role === 'Home' ? match.Home === team : match.Away === team));
        
        // Tomamos solo los 'maxCount' partidos más recientes (asumiendo que los últimos están al final del array)
        const recentMatches = filtered.slice(Math.max(filtered.length - maxCount, 0));
        
        // Si hay menos del mínimo, lo indicamos (pero usamos todos los disponibles)
        const dataUsed = recentMatches.length;

        // Calculamos la suma de goles del equipo en su rol
        const goalsSum = recentMatches.reduce((sum, match) => {
            return sum + (role === 'Home' ? match.GolesLocal : match.GolesVisita);
        }, 0);

        // Si hay datos, calculamos el promedio. Si no, devolvemos 0.
        const avg = dataUsed > 0 ? goalsSum / dataUsed : 0;

        return { avg, dataUsed, goalsSum, hasMinData: dataUsed >= minCount };
    }


    document.getElementById('poissonForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const localTeam = document.getElementById('local').value;
        const awayTeam = document.getElementById('visita').value;
        const league = document.getElementById('liga').value;
        const jsonText = document.getElementById('jsonInput').value.trim();
        const errorMsg = document.getElementById('errorMsg');
        const outputDiv = document.getElementById('modelOutput');
        outputDiv.innerHTML = '';
        errorMsg.style.display = 'none';

        try {
            const history = JSON.parse(jsonText);
            if (!Array.isArray(history) || history.length < 10) {
                throw new Error("El JSON debe ser un array con suficientes partidos históricos (se recomienda al menos 20 para intentar capturar 10 por equipo).");
            }
            
            // --- 1. PROCESAMIENTO DE LA MUESTRA LIMITADA ---
            const localData = filterAndLimitData(history, localTeam, 'Home', 10, 8);
            const awayData = filterAndLimitData(history, awayTeam, 'Away', 10, 8);

            if (!localData.hasMinData || !awayData.hasMinData) {
                 const missing = [];
                 if (!localData.hasMinData) missing.push(`${localTeam} (Local)`);
                 if (!awayData.hasMinData) missing.push(`${awayTeam} (Visitante)`);
                 outputDiv.innerHTML += `<p class="simulacion-notice">
                    ⚠️ **Muestra Insuficiente:** Faltan datos para ${missing.join(' y ')}. Se usaron ${localData.dataUsed} y ${awayData.dataUsed} partidos respectivamente, pero se requiere un mínimo de 8. El cálculo puede ser menos fiable.
                 </p>`;
            }

            // --- 2. SIMULACIÓN DE LA REGRESIÓN DE POISSON (Cálculo de Lambdas) ---
            
            // En una regresión de Poisson real, el intercepto (Avg de la Liga) y los coeficientes de
            // ataque/defensa son la base. Aquí simplificamos usando el promedio observado.
            
            // Promedio simple de la liga (utilizado como base/intercepto en el modelo real)
            const totalGoals = history.reduce((sum, match) => sum + match.GolesLocal + match.GolesVisita, 0);
            const leagueAvgGoal = totalGoals / (history.length * 2);

            // Factores de Ataque/Defensa (Simplificación)
            // lambda = (Media Ataque Local) * (Media Defensa Visitante) * Intercepto Liga
            
            // Usamos las medias observadas como aproximación directa a los lambdas:
            // Para ser más realista: lambda = promedio de goles del equipo atacante * promedio de goles en contra del equipo defensor
            
            // Simplificación: lambda = (Avg Goles a Favor del Local) + (Avg Goles en Contra del Visitante) / 2
            
            const lambda_Home = localData.avg;
            const lambda_Away = awayData.avg;
            
            // Asumiendo que el JSON no tiene goles en contra, usamos la media de la liga como factor de defensa
            // Más realista sería usar:
            // const avg_defense_away = (awayData.goalsAgainstSum / awayData.dataUsed) / leagueAvgGoal;
            // const lambda_Home = localData.avg * avg_defense_away; 
            
            // Para mantener la simplicidad, usamos solo el promedio de goles a favor:
            // Si no hay datos, lambda_Home será 0.
            if (lambda_Home === 0 || lambda_Away === 0) {
                 throw new Error("No hay suficientes datos válidos para calcular la media de goles para uno o ambos equipos.");
            }

            // --- 3. CÁLCULO DE PROBABILIDADES DE POISSON ---
            
            let P_Less_Equal_2 = 0; // P(Total Goles <= 2) = P(0) + P(1) + P(2)

            // Recorremos los posibles resultados (Local | Visitante) donde la suma sea <= 2
            for (let i = 0; i <= 2; i++) { // Goles del Local (i)
                for (let j = 0; j <= 2 - i; j++) { // Goles del Visitante (j), tal que i + j <= 2
                    
                    const P_Home = poisson_prob(i, lambda_Home);
                    const P_Away = poisson_prob(j, lambda_Away);
                    
                    // P(i, j) = P(Local=i) * P(Visitante=j)
                    P_Less_Equal_2 += P_Home * P_Away;
                }
            }

            const P_Over_25 = 1 - P_Less_Equal_2;

            // --- 4. MOSTRAR RESULTADOS ---
            outputDiv.innerHTML += `
                <h2>Detalles de la Predicción</h2>
                <div class="result-item">
                    <strong>Liga:</strong> ${league} | <strong>Partido:</strong> ${localTeam} vs ${awayTeam}
                </div>
                
                <h3>Parámetros Poisson ($\lambda$) y Data Utilizada</h3>
                <div class="result-item">
                    ** $\lambda_{\\text{Local}}$ (${localTeam}):** ${lambda_Home.toFixed(3)}
                    <div class="data-summary">(${localData.goalsSum} goles en ${localData.dataUsed} partidos como Local)</div>
                </div>
                <div class="result-item">
                    ** $\lambda_{\\text{Visitante}}$ (${awayTeam}):** ${lambda_Away.toFixed(3)}
                    <div class="data-summary">(${awayData.goalsSum} goles en ${awayData.dataUsed} partidos como Visitante)</div>
                </div>
                <div class="result-item">
                    **Media Total de Goles de la Liga:** ${leagueAvgGoal.toFixed(3)}
                </div>
                
                <h3>Probabilidad del Mercado Over 2.5 (Poisson)</h3>
                <div class="result-item prediction">
                    P(Total $\\le 2$ Goles): ${ (P_Less_Equal_2 * 100).toFixed(2) }%
                    <br>P(Total $\\ge 3$ Goles) **(Over 2.5):** <strong>${ (P_Over_25 * 100).toFixed(2) }%</strong>
                </div>
            `;

        } catch (e) {
            console.error(e);
            errorMsg.textContent = `Error al procesar el JSON: ${e.message}`;
            errorMsg.style.display = 'block';
        }
    });
</script>

</body>
</html>

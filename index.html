<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo de Poisson: Selectores Dinámicos Corregidos</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="file"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        input[type="file"] { padding: 10px 10px; background-color: #e9ecef; cursor: pointer; }
        select { background-color: #fff; appearance: none; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; margin-top: 20px; width: 100%; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #resultados { margin-top: 30px; padding: 20px; border: 2px solid #007bff; border-radius: 8px; background-color: #e6f7ff; }
        #resultados h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        .result-item { margin-top: 10px; padding: 8px; border-left: 4px solid #007bff; background-color: #fff; border-radius: 4px; }
        .alert-error { color: #dc3545; font-weight: bold; margin-top: 15px; }
        .simulacion-notice { color: #ffc107; background-color: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffc107; }
        .prediction { font-size: 1.5em; color: #28a745; font-weight: bold; }
        .data-summary { font-size: 0.9em; margin-top: 5px; color: #6c757d; }
    </style>
</head>
<body>

<div class="container">
    <h1>Modelo de Poisson: Selectores Dinámicos para O2.5</h1>
    <div class="simulacion-notice">
        **Instrucción:** Elige un archivo JSON. **Asegúrate de que tus datos usan las claves exactas:** `League`, `Home`, `Away`, `GolesLocal`, `GolesVisita`. Al seleccionar la Liga, los menús de equipos se actualizarán.
    </div>

    <form id="poissonForm">
        <label for="fileInput">1. Selecciona tu archivo JSON de partidos históricos:</label>
        <input type="file" id="fileInput" accept=".json" required>
        
        <label for="liga">2. Selecciona la Liga:</label>
        <select id="liga" disabled>
            <option value="">Carga el archivo...</option>
        </select>

        <label for="local">3. Selecciona el Equipo Local:</label>
        <select id="local" disabled>
            <option value="">Selecciona una liga...</option>
        </select>

        <label for="visita">4. Selecciona el Equipo Visitante:</label>
        <select id="visita" disabled>
            <option value="">Selecciona una liga...</option>
        </select>
        
        <button type="submit">Calcular Probabilidad O2.5 con Poisson</button>
    </form>

    <div id="resultados">
        <h2>Predicción del Modelo de Poisson</h2>
        <p class="alert-error" id="errorMsg" style="display: none;"></p>
        <div id="modelOutput">
            <p>Elige un archivo, selecciona las opciones y presiona calcular.</p>
        </div>
    </div>
</div>

<script>
    let globalHistory = []; // Almacena el array de partidos cargado globalmente

    // --- Funciones Matemáticas ---
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }
    function poisson_prob(k, lambda) {
        if (k < 0) return 0;
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }

    // --- Funciones de Llenado Dinámico ---

    function populateSelect(selectId, optionsSet, defaultText = "-- Selecciona --") {
        const select = document.getElementById(selectId);
        select.innerHTML = `<option value="">${defaultText}</option>`; // Opción por defecto
        optionsSet.forEach(option => {
            const element = document.createElement('option');
            element.value = option;
            element.textContent = option;
            select.appendChild(element);
        });
        select.disabled = false;
    }

    // Analiza TODAS las ligas y llena el selector de liga
    function loadLeagues(history) {
        const leagues = new Set();
        history.forEach(match => {
            // Se asume que la clave de la liga es 'League'
            if (match.League) leagues.add(match.League);
        });
        populateSelect('liga', Array.from(leagues).sort(), '-- Selecciona una liga --');
    }

    // Filtra los equipos según la liga seleccionada
    function populateTeamsByLeague() {
        const selectedLeague = document.getElementById('liga').value;
        const localSelect = document.getElementById('local');
        const visitaSelect = document.getElementById('visita');

        // Resetear selectores de equipo
        localSelect.innerHTML = '<option value="">Cargando equipos...</option>';
        visitaSelect.innerHTML = '<option value="">Cargando equipos...</option>';
        localSelect.disabled = true;
        visitaSelect.disabled = true;

        if (!selectedLeague) {
             localSelect.innerHTML = '<option value="">Selecciona una liga...</option>';
             visitaSelect.innerHTML = '<option value="">Selecciona una liga...</option>';
            return;
        }

        const teams = new Set();
        
        // Filtrar solo los partidos de la liga seleccionada
        const leagueMatches = globalHistory.filter(match => match.League === selectedLeague);

        leagueMatches.forEach(match => {
            // Se asumen las claves 'Home' y 'Away'
            if (match.Home) teams.add(match.Home);
            if (match.Away) teams.add(match.Away);
        });
        
        const sortedTeams = Array.from(teams).sort();
        
        if (sortedTeams.length > 0) {
            // Llenar los selectores de equipo con los equipos únicos de esa liga
            populateSelect('local', sortedTeams, '-- Selecciona Local --');
            populateSelect('visita', sortedTeams, '-- Selecciona Visitante --');
        } else {
             // Si no hay equipos, significa que la liga seleccionada no tiene partidos en el archivo
            localSelect.innerHTML = '<option value="">No hay equipos para esta liga</option>';
            visitaSelect.innerHTML = '<option value="">No hay equipos para esta liga</option>';
        }
    }

    // --- Funciones de Procesamiento de Datos ---

    // Filtra y limita los datos históricos al rango de 8 a 10 partidos.
    function filterAndLimitData(history, team, role, maxCount = 10, minCount = 8) {
        const filtered = history
            .filter(match => (role === 'Home' ? match.Home === team : match.Away === team));
        
        const recentMatches = filtered.slice(Math.max(filtered.length - maxCount, 0));
        
        const dataUsed = recentMatches.length;

        const goalsSum = recentMatches.reduce((sum, match) => {
            return sum + (role === 'Home' ? match.GolesLocal : match.GolesVisita);
        }, 0);

        const avg = dataUsed > 0 ? goalsSum / dataUsed : 0;

        return { avg, dataUsed, goalsSum, hasMinData: dataUsed >= minCount };
    }


    // --- Manejo de Eventos ---

    // 1. Manejo del Evento de Carga de Archivo
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const errorMsg = document.getElementById('errorMsg');
        errorMsg.style.display = 'none';

        if (!file) return;

        const reader = new FileReader();

        reader.onload = function(event) {
            try {
                const jsonText = event.target.result;
                const history = JSON.parse(jsonText);

                // Validación básica de la estructura del JSON
                if (!Array.isArray(history) || history.length < 1) {
                    throw new Error("El archivo JSON debe contener un array de partidos.");
                }
                
                // Almacenar globalmente la data
                globalHistory = history;
                
                // Llenar solo el selector de Ligas
                loadLeagues(history);
                
                // Resetear y deshabilitar selectores de equipos
                document.getElementById('local').innerHTML = '<option value="">Selecciona una liga...</option>';
                document.getElementById('visita').innerHTML = '<option value="">Selecciona una liga...</option>';
                document.getElementById('local').disabled = true;
                document.getElementById('visita').disabled = true;

                document.getElementById('modelOutput').innerHTML = '<p>Archivo cargado exitosamente. Ahora selecciona la liga.</p>';
            } catch (error) {
                console.error("Error al procesar el archivo:", error);
                errorMsg.textContent = `Error al procesar el archivo JSON: ${error.message}. Verifica que sea JSON válido y use las claves correctas.`;
                errorMsg.style.display = 'block';
                document.getElementById('liga').disabled = true;
                globalHistory = [];
            }
        };
        reader.onerror = () => {
            errorMsg.textContent = 'Error al leer el archivo. Intenta de nuevo.';
            errorMsg.style.display = 'block';
        };

        reader.readAsText(file);
    });

    // 2. Manejo del Evento de Cambio de Liga (CORRECCIÓN CLAVE)
    document.getElementById('liga').addEventListener('change', populateTeamsByLeague);


    // 3. Manejo del Evento de Formulario (Cálculo)
    document.getElementById('poissonForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const localTeam = document.getElementById('local').value;
        const awayTeam = document.getElementById('visita').value;
        const league = document.getElementById('liga').value;
        const errorMsg = document.getElementById('errorMsg');
        const outputDiv = document.getElementById('modelOutput');
        outputDiv.innerHTML = '';
        errorMsg.style.display = 'none';

        if (!globalHistory || globalHistory.length === 0) {
            errorMsg.textContent = 'Por favor, primero carga un archivo JSON válido.';
            errorMsg.style.display = 'block';
            return;
        }

        if (!league || !localTeam || !awayTeam) {
            errorMsg.textContent = 'Por favor, selecciona la Liga, el Equipo Local y el Equipo Visitante.';
            errorMsg.style.display = 'block';
            return;
        }

        if (localTeam === awayTeam) {
            errorMsg.textContent = 'El equipo Local y el Visitante no pueden ser el mismo.';
            errorMsg.style.display = 'block';
            return;
        }


        try {
            // Filtrar los datos por la liga seleccionada
            const filteredHistory = globalHistory.filter(match => match.League === league);

            // 1. Procesamiento de la Muestra Limitada
            const localData = filterAndLimitData(filteredHistory, localTeam, 'Home');
            const awayData = filterAndLimitData(filteredHistory, awayTeam, 'Away');

            // 2. Simulación de la Regresión de Poisson (Cálculo de Lambdas)
            const lambda_Home = localData.avg;
            const lambda_Away = awayData.avg;

            if (localData.dataUsed < 1 || awayData.dataUsed < 1) {
                 throw new Error("No se encontraron suficientes partidos históricos para uno o ambos equipos en esta liga.");
            }

            // Media total de goles en la liga filtrada
            const totalGoals = filteredHistory.reduce((sum, match) => sum + match.GolesLocal + match.GolesVisita, 0);
            const leagueAvgGoal = filteredHistory.length > 0 ? totalGoals / (filteredHistory.length * 2) : 0;
            
            // 3. Cálculo de Probabilidades de Poisson
            let P_Less_Equal_2 = 0; // P(Total Goles <= 2) = P(0) + P(1) + P(2)

            for (let i = 0; i <= 2; i++) { // Goles del Local (i)
                for (let j = 0; j <= 2 - i; j++) { // Goles del Visitante (j)
                    
                    const P_Home = poisson_prob(i, lambda_Home);
                    const P_Away = poisson_prob(j, lambda_Away);
                    
                    P_Less_Equal_2 += P_Home * P_Away;
                }
            }

            const P_Over_25 = 1 - P_Less_Equal_2;

            // 4. Mostrar Resultados
            let missingDataWarning = '';
            if (!localData.hasMinData || !awayData.hasMinData) {
                const missing = [];
                if (!localData.hasMinData) missing.push(`${localTeam} (Local)`);
                if (!awayData.hasMinData) missing.push(`${awayTeam} (Visitante)`);
                missingDataWarning = `<p class="simulacion-notice">⚠️ **Muestra Insuficiente:** Se usaron ${localData.dataUsed} y ${awayData.dataUsed} partidos (mínimo 8 requerido). El resultado puede ser menos fiable.</p>`;
            }

            outputDiv.innerHTML += `
                ${missingDataWarning}
                <h2>Detalles de la Predicción</h2>
                <div class="result-item">
                    <strong>Liga Seleccionada:</strong> ${league}
                    <br><strong>Partidos de Liga Analizados:</strong> ${filteredHistory.length}
                </div>
                
                <h3>Parámetros Poisson ($\lambda$) y Muestra Utilizada</h3>
                <div class="result-item">
                    ** $\lambda_{\\text{Local}}$ (${localTeam}):** ${lambda_Home.toFixed(3)}
                    <div class="data-summary">(${localData.goalsSum} goles en ${localData.dataUsed} partidos como Local)</div>
                </div>
                <div class="result-item">
                    ** $\lambda_{\\text{Visitante}}$ (${awayTeam}):** ${lambda_Away.toFixed(3)}
                    <div class="data-summary">(${awayData.goalsSum} goles en ${awayData.dataUsed} partidos como Visitante)</div>
                </div>
                <div class="result-item">
                    **Media de Goles de la Liga (por equipo/partido):** ${leagueAvgGoal.toFixed(3)}
                </div>
                
                <h3>Probabilidad del Mercado Over 2.5 (Poisson)</h3>
                <div class="result-item prediction">
                    P(Total $\\le 2$ Goles): ${ (P_Less_Equal_2 * 100).toFixed(2) }%
                    <br>P(Total $\\ge 3$ Goles) **(Over 2.5):** <strong>${ (P_Over_25 * 100).toFixed(2) }%</strong>
                </div>
            `;

        } catch (e) {
            console.error("Error en el cálculo:", e);
            errorMsg.textContent = `Error en el cálculo del modelo: ${e.message}`;
            errorMsg.style.display = 'block';
        }
    });
</script>

</body>
</html>

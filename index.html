<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Backtesting ROI por Partido</title>
<style>
    body {
        font-family: Arial;
        margin: 20px;
        background: #f1f1f1;
    }
    h2 { margin-top: 30px; }
    .box {
        background: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0px 2px 4px rgba(0,0,0,0.15);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: white;
    }
    table th, table td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: center;
    }
    table th {
        background: #333;
        color: white;
    }
    .btn {
        background: #007bff;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
    }
    .btn:hover {
        background: #0056b3;
    }
</style>
</head>

<body>
<h1>Herramienta de Backtesting ROI (Local vs Visitante)</h1>

<div class="box">
    <h2>Cargar archivos</h2>

    <p><b>Archivo HISTORIAL (JSON):</b>
    <input type="file" id="historialFile" accept=".json"></p>

    <p><b>Archivo PARTIDOS FUTUROS (JSON):</b>
    <input type="file" id="futurosFile" accept=".json"></p>

    <button class="btn" onclick="hacerBacktesting()">Hacer Backtesting</button>
</div>

<div id="resultados" class="box"></div>

<script>
let historialData = [];
let futurosData = [];

/* ---------------------------------------------------
   LECTOR DE ARCHIVOS (NO BORRA NADA, NO RECARGA NADA)
----------------------------------------------------*/
document.getElementById("historialFile").addEventListener("change", function(e) {
    cargarArchivoJSON(e.target.files[0], "historial");
});
document.getElementById("futurosFile").addEventListener("change", function(e) {
    cargarArchivoJSON(e.target.files[0], "futuros");
});

function cargarArchivoJSON(file, tipo) {
    const reader = new FileReader();
    reader.onload = function(e) {
        let txt = e.target.result.trim();

        // Si el JSON viene como objetos separados por comas, lo reparamos
        if (!txt.startsWith("[")) {
            txt = "[" + txt + "]";
        }

        try {
            const data = JSON.parse(txt);
            if (tipo === "historial") historialData = data;
            if (tipo === "futuros") futurosData = data;
        } catch (err) {
            alert("Error leyendo archivo JSON");
        }
    };
    reader.readAsText(file);
}

/* ---------------------------------------------------
   OBTENER ROI DE UN EQUIPO SEGÚN SU POSICIÓN (L o V)
----------------------------------------------------*/
function calcularROIEquipo(equipo, historial, modo) {
    // modo = "local" → buscar solo partidos donde fue local
    // modo = "visitante" → solo partidos donde fue visitante

    let apuestas = historial.filter(p => {
        if (!p.Match) return false;
        const [loc, vis] = p.Match.split(" - ").map(s => s.trim());
        return (modo === "local" && loc === equipo) ||
               (modo === "visitante" && vis === equipo);
    });

    let total = 0;

    for (let p of apuestas) {
        const odd = parseFloat(p.Odd);
        if (p.Result === "Winning") {
            total += (odd - 1);
        } else if (p.Result === "Losing") {
            total -= 1;
        }
    }

    return {
        partidos: apuestas.length,
        roi: total,
        detalle: apuestas
    };
}

/* ---------------------------------------------------
   BACKTESTING PRINCIPAL POR PARTIDO
----------------------------------------------------*/
function hacerBacktesting() {

    if (historialData.length === 0 || futurosData.length === 0) {
        alert("Debes cargar ambos archivos.");
        return;
    }

    let resultadosPartido = [];

    for (let pf of futurosData) {

        if (!pf.Match) continue;

        const [localFut, visitaFut] = pf.Match.split(" - ").map(s => s.trim());

        // ROI LOCAL FUTURO (solo historial como local)
        const roiLocal = calcularROIEquipo(localFut, historialData, "local");

        // ROI VISITANTE FUTURO (solo historial como visitante)
        const roiVisitante = calcularROIEquipo(visitaFut, historialData, "visitante");

        resultadosPartido.push({
            partido: pf.Match,
            local: localFut,
            visitante: visitaFut,
            roiLocal: roiLocal.roi,
            roiVisitante: roiVisitante.roi,
            partidosLocal: roiLocal.partidos,
            partidosVisitante: roiVisitante.partidos,
            roiTotal: roiLocal.roi + roiVisitante.roi
        });
    }

    // ORDENAR
    resultadosPartido.sort((a, b) => b.roiTotal - a.roiTotal);

    mostrarResultados(resultadosPartido);
}

/* ---------------------------------------------------
   MOSTRAR TABLA DE RESULTADOS
----------------------------------------------------*/
function mostrarResultados(lista) {
    let html = `
        <h2>Resultados por Partido (Ordenado por ROI Total)</h2>
        <table>
            <tr>
                <th>Partido</th>
                <th>ROI Local</th>
                <th>ROI Visitante</th>
                <th>Total ROI</th>
                <th>Partidos Local</th>
                <th>Partidos Visitante</th>
            </tr>
    `;

    for (let r of lista) {
        html += `
        <tr>
            <td>${r.partido}</td>
            <td>${r.roiLocal.toFixed(2)}</td>
            <td>${r.roiVisitante.toFixed(2)}</td>
            <td><b>${r.roiTotal.toFixed(2)}</b></td>
            <td>${r.partidosLocal}</td>
            <td>${r.partidosVisitante}</td>
        </tr>
        `;
    }

    html += "</table>";
    document.getElementById("resultados").innerHTML = html;
}
</script>
</body>
</html>
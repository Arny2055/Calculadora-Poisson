<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Poisson + Monte Carlo Mejorada</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: #0e0e0e;
      color: #f0f0f0;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 30px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1b1b1b;
      padding: 15px 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 0 25px rgba(0, 255, 20, 0.4);
    }
    .header img {
      width: 60px;
      filter: drop-shadow(0 0 6px #39FF14);
    }
    .header h2 {
      margin: 0;
      color: #39FF14;
      font-weight: 600;
      letter-spacing: 1.2px;
    }
    .header button {
      background-color: #2c2c2c;
      color: #f0f0f0;
      border: 1px solid #39FF14;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }
    .header button:hover {
      background-color: #39FF14;
      color: #000;
    }
    .inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    input,
    select,
    button {
      padding: 8px;
      font-size: 14px;
      background: #2c2c2c;
      color: #f0f0f0;
      border: 1px solid #444;
      border-radius: 6px;
      transition: 0.3s;
    }
    input:focus,
    select:focus {
      border-color: #39FF14;
      outline: none;
    }
    button {
      background-color: #333;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background-color: #39FF14;
      color: #000;
    }
    .small-input {
      width: 60px;
      text-align: center;
    }
    #resultado table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }
    #resultado th,
    #resultado td {
      padding: 8px;
      border: 1px solid #333;
      text-align: center;
      background: #151515;
      color: #f0f0f0;
    }
    #resultado th {
      background: #1f1f1f;
      font-weight: 600;
    }
    tr.highlight td {
      background-color: rgba(57, 255, 20, 0.15) !important;
      font-weight: 600;
    }
    #notificacion {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #39FF14;
      color: #000;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      opacity: 0;
      transition: 0.4s;
      pointer-events: none;
      user-select: none;
    }
    #notificacion.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- CALCULADORA PREPARTIDO -->
    <div class="header">
      <div style="display:flex; align-items:center; gap:15px;">
        <img src="https://cdn-icons-png.flaticon.com/512/287/287221.png" alt="Logo" />
        <h2>Calculadora Poisson + Monte Carlo</h2>
      </div>
      <button onclick="window.location.href='historial.html'">ðŸ“œ Ver Historial</button>
    </div>

    <div class="inputs">
      <input type="text" id="nombreLocal" placeholder="Equipo Local" style="flex:1;" />
      <input type="number" id="golesLocal" placeholder="Promedio Local" step="0.01" min="0" />
      <input type="text" id="nombreVisita" placeholder="Equipo Visitante" style="flex:1;" />
      <input type="number" id="golesVisita" placeholder="Promedio Visita" step="0.01" min="0" />
      <input type="number" id="bankroll" placeholder="Bankroll ($)" step="0.01" value="100" min="0" />
      <input type="number" id="simulaciones" placeholder="Simulaciones" value="10000" min="1" />
      <button onclick="calcular()">Calcular</button>
    </div>

    <div class="inputs">
      <select id="equipoHandicap" aria-label="Seleccionar equipo para hÃ¡ndicap">
        <option value="local">HÃ¡ndicap Local</option>
        <option value="visita">HÃ¡ndicap Visitante</option>
      </select>
      <input type="number" id="lineaHandicap" placeholder="LÃ­nea AH (ej: -0.25)" step="0.25" />
    </div>

    <div class="inputs">
      <button onclick="agregarAlHistorial()">âž• Agregar al historial</button>
      <button onclick="exportarHistorial()">â¬‡ Exportar historial</button>
      <select id="kellyFrac" onchange="calcular()" aria-label="FracciÃ³n Kelly">
        <option value="0.05">5%</option>
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20">20%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.30">30%</option>
        <option value="0.40">40%</option>
      </select>
    </div>

    <div id="resultado" role="region" aria-live="polite"></div>
  </div>

  <div id="notificacion" role="alert" aria-atomic="true"></div>

  <script>
    // Factorial recursivo
    const factorial = n => (n <= 1 ? 1 : n * factorial(n - 1));

    // DistribuciÃ³n Poisson
    const poisson = (k, lambda) => (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);

    // Cuota implÃ­cita
    const cuotaImplicita = p => (p > 0 ? (1 / p).toFixed(2) : "-");

    // CÃ¡lculo Valor Esperado
    const valueBet = (p, cuota) => ((p * cuota) - 1).toFixed(2);

    // FÃ³rmula Kelly
    const kelly = (p, cuota, f = 1) => {
      const b = cuota - 1;
      if (b <= 0) return 0;
      const k = ((b * p - (1 - p)) / b) * f;
      return Math.max(0, k);
    };

    // Muestra notificaciÃ³n en pantalla
    function mostrarNotificacion(msg) {
      const n = document.getElementById("notificacion");
      n.textContent = msg;
      n.classList.add("visible");
      setTimeout(() => n.classList.remove("visible"), 3000);
    }

    // Muestreo Poisson (para Monte Carlo)
    const samplePoisson = lambda => {
      let L = Math.exp(-lambda), k = 0, p = 1;
      do {
        k++;
        p *= Math.random();
      } while (p > L);
      return k - 1;
    };

    // Variables globales
    let cuotasGuardadas = {};
    let exportData = [];

    function calcular() {
      const nombreLocal = document.getElementById("nombreLocal").value.trim();
      const nombreVisita = document.getElementById("nombreVisita").value.trim();
      const lambdaL = parseFloat(document.getElementById("golesLocal").value);
      const lambdaV = parseFloat(document.getElementById("golesVisita").value);
      const bankroll = parseFloat(document.getElementById("bankroll").value);
      const sims = parseInt(document.getElementById("simulaciones").value);
      const kellyFrac = parseFloat(document.getElementById("kellyFrac").value);

      if (
        !nombreLocal ||
        !nombreVisita ||
        isNaN(lambdaL) ||
        isNaN(lambdaV) ||
        isNaN(bankroll) ||
        isNaN(sims) ||
        lambdaL < 0 ||
        lambdaV < 0 ||
        bankroll <= 0 ||
        sims < 1
      ) {
        mostrarNotificacion("âš  Completa todos los campos correctamente");
        return;
      }

      const maxGoals = 5;

      // Probabilidades marginales Poisson
      const pLocal = Array.from({ length: maxGoals + 1 }, (_, i) => poisson(i, lambdaL));
      const pVisita = Array.from({ length: maxGoals + 1 }, (_, i) => poisson(i, lambdaV));

      // Variables para probabilidades combinadas
      let winL = 0,
        draw = 0,
        winV = 0,
        btts = 0,
        bttsNo = 0;
      const thresholds = [0.5, 1.5, 2.5, 3.5];
      const under = {};
      thresholds.forEach(t => (under[t] = 0));

      // Calculo probabilidades Poisson joint
      for (let i = 0; i <= maxGoals; i++) {
        for (let j = 0; j <= maxGoals; j++) {
          const joint = pLocal[i] * pVisita[j];
          if (i > j) winL += joint;
          else if (i === j) draw += joint;
          else winV += joint;

          if (i > 0 && j > 0) btts += joint;
          else bttsNo += joint;

          thresholds.forEach(t => {
            if (i + j <= t) under[t] += joint;
          });
        }
      }

      const overs = thresholds.map(t => 1 - under[t]);

      // Monte Carlo
      let mcWinL = 0,
        mcDraw = 0,
        mcWinV = 0,
        mcBTTS = 0,
        mcBTTSNo = 0,
        mcOvers = [0, 0, 0, 0];

      for (let s = 0; s < sims; s++) {
        const gL = samplePoisson(lambdaL),
          gV = samplePoisson(lambdaV);
        if (gL > gV) mcWinL++;
        else if (gL === gV) mcDraw++;
        else mcWinV++;

        if (gL > 0 && gV > 0) mcBTTS++;
        else mcBTTSNo++;

        thresholds.forEach((t, idx) => {
          if (gL + gV > t) mcOvers[idx]++;
        });
      }

      // Probabilidades resultado
      const probPoisson = [winL, draw, winV];
      const probMC = [mcWinL, mcDraw, mcWinV].map(x => x / sims);
      const probOversPoisson = overs;
      const probOversMC = mcOvers.map(x => x / sims);

      // HÃ¡ndicap AsiÃ¡tico
      const equipoAH = document.getElementById("equipoHandicap").value;
      const lineaAH = parseFloat(document.getElementById("lineaHandicap").value);
      let probAH = 0;
      if (!isNaN(lineaAH)) {
        for (let i = 0; i <= maxGoals; i++) {
          for (let j = 0; j <= maxGoals; j++) {
            const diff = equipoAH === "local" ? i - j : j - i;
            if (diff + lineaAH > 0) probAH += pLocal[i] * pVisita[j];
          }
        }
      }

      // Construir tabla HTML resultados
      exportData = [];
      let html = `<table aria-label="Resultados de la calculadora">
        <thead>
          <tr>
            <th>Grupo</th><th>OpciÃ³n</th><th>Poisson %</th><th>MC %</th><th>Cuota ImplÃ­cita</th>
            <th>Cuota Bookie</th><th>EV</th><th>Kelly (${kellyFrac * 100}%)</th><th>Apostar $</th>
          </tr>
        </thead><tbody>`;

      // Filas para los grupos: 1X2, Over/Under, BTTS
      const filas = [
        ["1X2 âš½", [nombreLocal, "Empate", nombreVisita], probPoisson, probMC],
        ["Over/Under ðŸŽ¯", thresholds.map(t => `Over ${t}`), probOversPoisson, probOversMC],
        ["BTTS ðŸ””", ["SÃ­", "No"], [btts, bttsNo], [mcBTTS / sims, mcBTTSNo / sims]],
      ];

      filas.forEach(([grupo, labels, probs, probsMC], gi) => {
        labels.forEach((label, idx) => {
          const p = probs[idx],
            mc = probsMC[idx],
            id = `bookie_${gi}_${idx}`;
          const cuotaGuardada = cuotasGuardadas[id] || "";
          const cuotaBookie = parseFloat(cuotasGuardadas[id]);
          const ev = !isNaN(cuotaBookie) ? valueBet(p, cuotaBookie) : "-";
          const k = !isNaN(cuotaBookie) ? kelly(p, cuotaBookie, kellyFrac) : 0;
          const apuesta = k > 0 ? (bankroll * k).toFixed(2) : "-";
          const highlight = (!isNaN(ev) && ev > 0) || k > 0 ? "highlight" : "";

          html += `<tr class="${highlight}">
            <td>${grupo}</td>
            <td>${label}</td>
            <td>${(p * 100).toFixed(2)}</td>
            <td>${(mc * 100).toFixed(2)}</td>
            <td>${cuotaImplicita(p)}</td>
            <td><input
                  type="text"
                  class="small-input"
                  id="${id}"
                  value="${cuotaGuardada}"
                  aria-label="Cuota bookie para ${grupo} - ${label}"
                  oninput="cuotasGuardadas['${id}'] = this.value.replace(',', '.');"
                  onblur="calcular()"
                  onkeydown="if(event.key==='Enter'){this.blur();}"
                ></td>
            <td>${ev}</td>
            <td>${(k * 100).toFixed(1)}%</td>
            <td>${apuesta}</td>
          </tr>`;

          if (!isNaN(cuotaBookie))
            exportData.push([
              grupo,
              label,
              (p * 100).toFixed(2),
              cuotaBookie,
              ev,
              (k * 100).toFixed(1) + "%",
              apuesta,
              nombreLocal,
              nombreVisita,
            ]);
        });
      });

      // HÃ¡ndicap AsiÃ¡tico
      if (!isNaN(lineaAH)) {
        const labelAH = `${equipoAH === "local" ? nombreLocal : nombreVisita} AH ${lineaAH > 0 ? "+" : ""}${lineaAH}`;
        const p = probAH;
        const mc = p;
        const id = "bookie_AH";
        const cuotaGuardada = cuotasGuardadas[id] || "";
        const cuotaBookie = parseFloat(cuotasGuardadas[id]);
        const ev = !isNaN(cuotaBookie) ? valueBet(p, cuotaBookie) : "-";
        const k = !isNaN(cuotaBookie) ? kelly(p, cuotaBookie, kellyFrac) : 0;
        const apuesta = k > 0 ? (bankroll * k).toFixed(2) : "-";
        const highlight = (!isNaN(ev) && ev > 0) || k > 0 ? "highlight" : "";

        html += `<tr class="${highlight}">
          <td>HÃ¡ndicap AsiÃ¡tico ðŸ¥¢</td>
          <td>${labelAH}</td>
          <td>${(p * 100).toFixed(2)}</td>
          <td>${(mc * 100).toFixed(2)}</td>
          <td>${cuotaImplicita(p)}</td>
          <td><input
                type="text"
                class="small-input"
                id="${id}"
                value="${cuotaGuardada}"
                aria-label="Cuota bookie para HÃ¡ndicap AsiÃ¡tico"
                oninput="cuotasGuardadas['${id}'] = this.value.replace(',', '.');"
                onblur="calcular()"
                onkeydown="if(event.key==='Enter'){this.blur();}"
              ></td>
          <td>${ev}</td>
          <td>${(k * 100).toFixed(1)}%</td>
          <td>${apuesta}</td>
        </tr>`;

        if (!isNaN(cuotaBookie))
          exportData.push([
            "HÃ¡ndicap AsiÃ¡tico",
            labelAH,
            (p * 100).toFixed(2),
            cuotaBookie,
            ev,
            (k * 100).toFixed(1) + "%",
            apuesta,
            nombreLocal,
            nombreVisita,
          ]);
      }

      html += "</tbody></table>";

      // Mostrar resultado en el div
      document.getElementById("resultado").innerHTML = html;
    }

    function agregarAlHistorial() {
      calcular();
      if (!exportData.length) {
        mostrarNotificacion("âš  No hay mercados con cuota de la bookie para agregar.");
        return;
      }
      const historial = JSON.parse(localStorage.getItem("poissonHistorial")) || [];
      exportData.forEach(r => historial.push(r));
      localStorage.setItem("poissonHistorial", JSON.stringify(historial));
      mostrarNotificacion("âœ… Mercados agregados al historial");
    }

    function exportarHistorial() {
      const historial = JSON.parse(localStorage.getItem("poissonHistorial")) || [];
      if (!historial.length) {
        mostrarNotificacion("âš  No hay historial para exportar");
        return;
      }
      const csvHeader = "Grupo,OpciÃ³n,Prob %,Cuota Bookie,EV,Kelly %,Apostar $,Local,Visitante\n";
      const csvContent = csvHeader + historial.map(r => r.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "historial_poisson.csv";
      a.click();
      a.remove();
    }
  </script>
</body>
</html>

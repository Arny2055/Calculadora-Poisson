<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Football Backtester Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root {
            --bg-main: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6; /* Azul profesional */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: var(--bg-panel);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .brand { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--accent); }

        .upload-btn {
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .upload-btn:hover { background: #2563eb; }
        input[type="file"] { display: none; }

        /* LAYOUT PRINCIPAL */
        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* SIDEBAR (CONTROLES) */
        .sidebar {
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar h3 { margin: 0 0 10px 0; font-size: 0.85rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; }

        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: var(--text-secondary); }
        
        select, input[type="date"], input[type="number"] {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }
        
        /* Range Sliders Estilizados */
        .range-wrapper { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; color: var(--accent); }
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }

        .btn-run {
            width: 100%;
            padding: 12px;
            background: var(--success);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: auto; /* Empuja el botón al fondo */
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-run:hover { background: #059669; }

        /* CONTENIDO PRINCIPAL */
        .main {
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* TARJETAS DE MÉTRICAS (KPIs) */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .kpi-card {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
        }
        .kpi-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }
        .kpi-value { font-size: 1.5rem; font-weight: 700; }
        .kpi-sub { font-size: 0.75rem; margin-top: 5px; }
        
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* GRÁFICOS */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            height: 350px;
        }
        .chart-container {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
        }

        /* TABLA DE RESULTADOS */
        .table-container {
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border);
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .table-header { padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: bold; font-size: 0.9rem; }
        
        .table-scroll { overflow-y: auto; height: 100%; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 12px 15px; background: #252f45; position: sticky; top: 0; color: var(--text-secondary); }
        td { padding: 10px 15px; border-bottom: 1px solid var(--border); color: var(--text-primary); }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }
        .empty-state i { font-size: 3rem; margin-bottom: 20px; opacity: 0.5; }

    </style>
</head>
<body>

    <header>
        <div class="brand"><i class="fas fa-futbol"></i> Ultimate Backtester <span style="font-size:0.7em; background:var(--accent); padding:2px 5px; border-radius:3px; margin-left:5px; color:white;">PRO</span></div>
        <div>
            <label for="csvInput" class="upload-btn"><i class="fas fa-cloud-upload-alt"></i> Cargar CSV (Football-Data)</label>
            <input type="file" id="csvInput" accept=".csv">
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h3>1. Estrategia y Mercado</h3>
            <div class="control-group">
                <label>Mercado</label>
                <select id="marketSelect">
                    <option value="H">1 - Victoria Local</option>
                    <option value="D">X - Empate</option>
                    <option value="A">2 - Victoria Visitante</option>
                    <option value="O25">Over 2.5 Goles</option>
                    <option value="U25">Under 2.5 Goles</option>
                </select>
            </div>

            <h3>2. Gestión de Banca</h3>
            <div class="control-group">
                <label>Tipo de Stake</label>
                <select id="stakeType">
                    <option value="flat">Stake Plano (Fijo)</option>
                    <option value="percent">% del Banco Actual</option>
                </select>
            </div>
            <div class="control-group">
                <label>Valor del Stake / %</label>
                <input type="number" id="stakeValue" value="1" step="0.1">
            </div>
            <div class="control-group">
                <label>Banca Inicial</label>
                <input type="number" id="initialBank" value="1000">
            </div>

            <h3>3. Filtros Avanzados</h3>
            <div class="control-group">
                <label>Rango de Cuotas (Min - Max)</label>
                <div class="range-wrapper">
                    <span id="minOddsDisp">1.50</span>
                    <span id="maxOddsDisp">3.00</span>
                </div>
                <input type="range" id="minOdds" min="1.01" max="10" step="0.01" value="1.50">
                <input type="range" id="maxOdds" min="1.01" max="20" step="0.01" value="3.00" style="margin-top:5px;">
            </div>

            <div class="control-group">
                <label>Liga</label>
                <select id="leagueSelect">
                    <option value="all">Todas las Ligas</option>
                </select>
            </div>

            <div class="control-group">
                <label>Fecha Inicio</label>
                <input type="date" id="dateStart">
            </div>

            <button class="btn-run" onclick="runBacktest()"><i class="fas fa-play"></i> EJECUTAR SIMULACIÓN</button>
        </aside>

        <main class="main">
            <div id="loading" style="display:none; text-align:center;">Procesando datos...</div>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">Total Apuestas</div>
                    <div class="kpi-value" id="valBets">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Win Rate</div>
                    <div class="kpi-value" id="valWinRate">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Beneficio Neto</div>
                    <div class="kpi-value" id="valProfit">0.00</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Yield (ROI)</div>
                    <div class="kpi-value" id="valYield">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title" style="color: var(--danger);">Max Drawdown</div>
                    <div class="kpi-value text-red" id="valDrawdown">0%</div>
                    <div class="kpi-sub">Peor caída</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="equityChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="leagueChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">Últimos 100 Partidos Simulados</div>
                <div class="table-scroll">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Liga</th>
                                <th>Partido</th>
                                <th>Res</th>
                                <th>Mercado</th>
                                <th>Cuota</th>
                                <th>Stake</th>
                                <th>P/L</th>
                                <th>Banca</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                    <div id="emptyState" class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <h3>Carga un archivo CSV para comenzar</h3>
                        <p>Soporta formato standard de Football-Data.co.uk</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let rawData = [];
        let chartEquity = null;
        let chartLeagues = null;

        // --- 1. IMPORTACIÓN Y PARSEO ---
        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('loading').style.display = 'block';
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processCSV(results.data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'none';
                }
            });
        });

        function processCSV(data) {
            // Mapear datos "sucios" a formato interno limpio
            // Detectamos columnas comunes de football-data.co.uk
            rawData = data.map(row => {
                // Validar que exista fecha y equipos
                if (!row.Date || !row.HomeTeam) return null;

                // Parsear fecha (A veces viene como DD/MM/YY)
                let dateParts = row.Date.split('/');
                let isoDate = row.Date;
                if(dateParts.length === 3) {
                    // Asumimos formato europeo DD/MM/YY -> YYYY-MM-DD
                    let year = dateParts[2].length === 2 ? '20' + dateParts[2] : dateParts[2];
                    isoDate = `${year}-${dateParts[1]}-${dateParts[0]}`;
                }

                return {
                    date: isoDate,
                    league: row.Div,
                    home: row.HomeTeam,
                    away: row.AwayTeam,
                    goalsH: row.FTHG,
                    goalsA: row.FTAG,
                    res: row.FTR, // H, D, A
                    // Cuotas (Intentamos Bet365, luego Pinnacle, luego Promedio)
                    oddsH: row.B365H || row.PSH || row.AvgH,
                    oddsD: row.B365D || row.PSD || row.AvgD,
                    oddsA: row.B365A || row.PSA || row.AvgA,
                    oddsO25: row.B36525 || row.Avg25, // A veces viene como B365>2.5
                    oddsU25: row.B36525_1 || row.Avg25_1 // El formato varía, simplificamos búsqueda luego si es necesario
                };
            }).filter(item => item !== null && item.oddsH > 0); // Limpiar nulos

            // Llenar Select de Ligas
            const leagues = [...new Set(rawData.map(d => d.league))].sort();
            const leagueSel = document.getElementById('leagueSelect');
            leagueSel.innerHTML = '<option value="all">Todas las Ligas</option>';
            leagues.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l;
                opt.innerText = l;
                leagueSel.appendChild(opt);
            });

            // Ejecutar primera simulación
            runBacktest();
        }

        // --- 2. LÓGICA DE NEGOCIO (EL MOTOR) ---
        function runBacktest() {
            if (rawData.length === 0) return;

            // A. Obtener Inputs
            const market = document.getElementById('marketSelect').value;
            const stakeType = document.getElementById('stakeType').value;
            const stakeVal = parseFloat(document.getElementById('stakeValue').value);
            const initialBank = parseFloat(document.getElementById('initialBank').value);
            const minO = parseFloat(document.getElementById('minOdds').value);
            const maxO = parseFloat(document.getElementById('maxOdds').value);
            const selectedLeague = document.getElementById('leagueSelect').value;
            const startDate = document.getElementById('dateStart').value;

            // B. Variables de Seguimiento
            let currentBank = initialBank;
            let peakBank = initialBank;
            let maxDrawdown = 0;
            let wins = 0;
            let totalBets = 0;
            let equityCurve = [{x: 'Inicio', y: initialBank}];
            let resultsList = [];
            let profitByLeague = {};

            // C. Bucle Principal
            rawData.forEach(match => {
                // 1. Filtros Previos
                if (selectedLeague !== 'all' && match.league !== selectedLeague) return;
                if (startDate && match.date < startDate) return;

                // 2. Determinar Cuota y Resultado según Mercado
                let odds = 0;
                let isWin = false;
                let betLabel = "";

                // Lógica de Mercados
                if (market === 'H') {
                    odds = match.oddsH;
                    isWin = match.res === 'H';
                    betLabel = "Home";
                } else if (market === 'D') {
                    odds = match.oddsD;
                    isWin = match.res === 'D';
                    betLabel = "Draw";
                } else if (market === 'A') {
                    odds = match.oddsA;
                    isWin = match.res === 'A';
                    betLabel = "Away";
                } else if (market === 'O25') {
                    // Nota: CSVs antiguos a veces no tienen cuotas O/U, validar
                    odds = match.oddsO25 || 0; 
                    isWin = (match.goalsH + match.goalsA) > 2.5;
                    betLabel = "Over 2.5";
                } else if (market === 'U25') {
                    // Football-Data a veces pone cuota Under en col separada, asumimos simplificación para demo
                    // En un caso real, habría que mapear mejor las columnas de O/U
                    odds = 1.90; // Placeholder si no hay dato exacto para U2.5 en el mapeo simple
                    isWin = (match.goalsH + match.goalsA) < 2.5;
                    betLabel = "Under 2.5";
                }

                // 3. Filtro de Cuotas
                if (!odds || odds < minO || odds > maxO) return;

                // 4. Gestión de Stake
                let stakeAmount = 0;
                if (stakeType === 'flat') {
                    stakeAmount = stakeVal;
                } else {
                    stakeAmount = currentBank * (stakeVal / 100);
                }

                // 5. Calcular P/L
                totalBets++;
                let pnl = 0;
                if (isWin) {
                    wins++;
                    pnl = (stakeAmount * odds) - stakeAmount;
                } else {
                    pnl = -stakeAmount;
                }

                currentBank += pnl;

                // 6. Calcular Drawdown
                if (currentBank > peakBank) peakBank = currentBank;
                let dd = (peakBank - currentBank) / peakBank * 100;
                if (dd > maxDrawdown) maxDrawdown = dd;

                // 7. Guardar Datos
                equityCurve.push({x: match.date, y: currentBank}); // Simplificado para gráfico
                
                // Agregar a Resultados (Solo guardamos todos para métricas, pero limitaremos tabla)
                let rowData = {
                    date: match.date,
                    league: match.league,
                    match: `${match.home} vs ${match.away}`,
                    res: `${match.goalsH}-${match.goalsA} (${match.res})`,
                    market: betLabel,
                    odds: odds,
                    stake: stakeAmount,
                    pnl: pnl,
                    bank: currentBank
                };
                resultsList.push(rowData);

                // Agrupar por Liga
                if (!profitByLeague[match.league]) profitByLeague[match.league] = 0;
                profitByLeague[match.league] += pnl;
            });

            // D. Actualizar UI
            updateKPIs(totalBets, wins, currentBank, initialBank, maxDrawdown);
            updateTable(resultsList);
            renderCharts(equityCurve, profitByLeague);
        }

        // --- 3. ACTUALIZACIÓN DE UI ---
        function updateKPIs(total, wins, currentBank, initialBank, maxDD) {
            const profit = currentBank - initialBank;
            const totalStaked = total * (document.getElementById('stakeType').value === 'flat' ? parseFloat(document.getElementById('stakeValue').value) : 0); // Aprox para yield stake plano
            // Nota: El yield exacto con stake variable requiere sumar todos los stakes individuales. Simplificamos para Stake Plano en esta demo.
            
            const winRate = total > 0 ? ((wins / total) * 100).toFixed(2) : 0;
            const yieldVal = total > 0 ? ((profit / total) * 100).toFixed(2) : 0; // Yield simplificado (Profit / N apuestas) para Stake 1

            document.getElementById('valBets').innerText = total.toLocaleString();
            document.getElementById('valWinRate').innerText = winRate + "%";
            
            const pEl = document.getElementById('valProfit');
            pEl.innerText = profit.toFixed(2);
            pEl.className = "kpi-value " + (profit >= 0 ? "text-green" : "text-red");

            const yEl = document.getElementById('valYield');
            yEl.innerText = yieldVal + "% (Avg)"; // Yield promedio por apuesta unitaria
            yEl.className = "kpi-value " + (yieldVal >= 0 ? "text-green" : "text-red");

            document.getElementById('valDrawdown').innerText = "-" + maxDD.toFixed(2) + "%";
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            
            // Mostrar solo los últimos 100 para rendimiento
            const viewData = data.slice(-100).reverse();
            
            viewData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.league}</td>
                    <td>${row.match}</td>
                    <td>${row.res}</td>
                    <td>${row.market}</td>
                    <td>${row.odds.toFixed(2)}</td>
                    <td>${row.stake.toFixed(1)}</td>
                    <td class="${row.pnl >= 0 ? 'text-green' : 'text-red'}">${row.pnl >= 0 ? '+' : ''}${row.pnl.toFixed(2)}</td>
                    <td>${row.bank.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. GRÁFICOS (CHART.JS) ---
        function renderCharts(equityData, leagueData) {
            const ctxEq = document.getElementById('equityChart').getContext('2d');
            const ctxLg = document.getElementById('leagueChart').getContext('2d');

            // Destruir previos
            if (chartEquity) chartEquity.destroy();
            if (chartLeagues) chartLeagues.destroy();

            // 1. Equity Curve
            // Reducir puntos si hay demasiados (optimizacion)
            const chartPoints = equityData.length > 500 
                ? equityData.filter((_, i) => i % Math.ceil(equityData.length / 500) === 0) 
                : equityData;

            chartEquity = new Chart(ctxEq, {
                type: 'line',
                data: {
                    labels: chartPoints.map(p => p.x),
                    datasets: [{
                        label: 'Banca',
                        data: chartPoints.map(p => p.y),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Curva de Equidad (Crecimiento)', color: '#94a3b8' } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });

            // 2. Profit by League (Bar Chart)
            const sortedLeagues = Object.entries(leagueData).sort((a,b) => b[1] - a[1]); // Ordenar por ganancia
            
            chartLeagues = new Chart(ctxLg, {
                type: 'bar',
                data: {
                    labels: sortedLeagues.map(x => x[0]),
                    datasets: [{
                        label: 'Profit',
                        data: sortedLeagues.map(x => x[1]),
                        backgroundColor: sortedLeagues.map(x => x[1] >= 0 ? '#10b981' : '#ef4444'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Barras horizontales
                    plugins: { legend: { display: false }, title: { display: true, text: 'Rendimiento por Liga', color: '#94a3b8' } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { ticks: { color: '#94a3b8', font: {size: 10} } }
                    }
                }
            });
        }

        // Listeners de UI para inputs (Sliders)
        document.getElementById('minOdds').addEventListener('input', e => {
            document.getElementById('minOddsDisp').innerText = parseFloat(e.target.value).toFixed(2);
        });
        document.getElementById('maxOdds').addEventListener('input', e => {
            document.getElementById('maxOddsDisp').innerText = parseFloat(e.target.value).toFixed(2);
        });

    </script>
</body>
</html>

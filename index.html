<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Backtesting ROI por Equipo</title>
<style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    h2 { margin-top: 30px; }
    button { padding: 10px 20px; cursor: pointer; margin: 10px 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #eee; }
    .positivo { background: #caffc8 !important; }
    #status { background: #222; color: white; padding: 10px; margin-top: 20px; }
    select { padding: 8px; }
</style>
</head>
<body>

<h1>Backtesting ROI por Equipo</h1>

<h2>1. Cargar archivo HISTORIAL (JSON)</h2>
<input type="file" id="historialFile" accept=".json">

<h2>2. Cargar archivo PARTIDOS FUTUROS (JSON)</h2>
<input type="file" id="futurosFile" accept=".json">

<h2>3. Filtro por liga</h2>
<select id="ligaSelect">
    <option value="all">Todas las ligas</option>
</select>

<br>
<button onclick="runBacktesting()">HACER BACKTESTING</button>
<button onclick="exportCSV()">DESCARGAR CSV</button>

<div id="status">Esperando archivos…</div>

<h2>Resultados por equipo</h2>
<table id="resultsTable">
    <thead>
        <tr>
            <th>Equipo</th>
            <th>Partidos encontrados</th>
            <th>Ganados</th>
            <th>Perdidos</th>
            <th>ROI (%)</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Resultados por partido</h2>
<table id="detalleTable">
    <thead>
        <tr>
            <th>Equipo</th>
            <th>Partido</th>
            <th>Liga</th>
            <th>Fecha</th>
            <th>Odd</th>
            <th>Resultado</th>
            <th>ROI</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Gráfica ROI por equipo</h2>
<canvas id="roiChart" height="100"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let historial = [];
let futuros = [];
let resultadosTabla = [];
let detallePartidos = [];

/* ----------------------- LECTURA DE ARCHIVOS ----------------------- */

document.getElementById("historialFile").addEventListener("change", function () {
    readJSONFile(this.files[0], data => {
        historial = Array.isArray(data) ? data : [data];
        actualizarLigas();
        document.getElementById("status").innerText = "Historial cargado con " + historial.length + " registros.";
    });
});

document.getElementById("futurosFile").addEventListener("change", function () {
    readJSONFile(this.files[0], data => {
        futuros = Array.isArray(data) ? data : [data];
        actualizarLigas();
        document.getElementById("status").innerText = "Partidos futuros cargados: " + futuros.length;
    });
});

function readJSONFile(file, callback) {
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const cleaned = "[" + e.target.result.replace(/}\s*,\s*{/g, "},{") + "]";
            const json = JSON.parse(cleaned);
            callback(json);
        } catch (err) {
            alert("Error leyendo el JSON: " + err);
        }
    };
    reader.readAsText(file);
}

/* ----------------------- FILTRO LIGAS ----------------------- */

function actualizarLigas() {
    let ligas = new Set();

    [...historial, ...futuros].forEach(r => {
        if (r.League) ligas.add(r.League);
    });

    const sel = document.getElementById("ligaSelect");
    sel.innerHTML = `<option value="all">Todas las ligas</option>`;

    [...ligas].forEach(l => {
        sel.innerHTML += `<option value="${l}">${l}</option>`;
    });
}

/* ----------------------- BACKTESTING ----------------------- */

function runBacktesting() {
    if (historial.length === 0 || futuros.length === 0) {
        alert("Debes cargar ambos archivos primero.");
        return;
    }

    document.getElementById("status").innerText = "Procesando Backtesting…";

    const ligaFiltro = document.getElementById("ligaSelect").value;

    let resultados = {};
    detallePartidos = [];

    futuros.forEach(fut => {
        if (!fut.Match) return;
        if (ligaFiltro !== "all" && fut.League !== ligaFiltro) return;

        let [home, away] = fut.Match.split(" - ").map(x => x.trim());

        analizarEquipo(home, historial, resultados);
        analizarEquipo(away, historial, resultados);
    });

    let tabla = Object.entries(resultados).map(([equipo, d]) => {
        let roi = ((d.wins - d.losses) / d.games) * 100;

        return {
            equipo,
            games: d.games,
            wins: d.wins,
            losses: d.losses,
            roi
        };
    });

    tabla.sort((a, b) => b.roi - a.roi);
    resultadosTabla = tabla;

    mostrarTablaResumen(tabla);
    mostrarTablaDetalle(detallePartidos);
    graficar(tabla);

    document.getElementById("status").innerText = "Backtesting finalizado ✔️";
}

function analizarEquipo(equipo, historial, resultados) {
    if (!resultados[equipo]) resultados[equipo] = {games: 0, wins: 0, losses: 0};

    historial.forEach(registro => {
        if (!registro.Match) return;

        let [h, a] = registro.Match.split(" - ").map(x => x.trim());

        if (equipo === h || equipo === a) {
            let gano = registro.Result === "Winning";

            resultados[equipo].games++;
            if (gano) resultados[equipo].wins++;
            else resultados[equipo].losses++;

            let roi = gano ? (parseFloat(registro.Odd) - 1) : -1;

            detallePartidos.push({
                equipo,
                partido: registro.Match,
                liga: registro.League,
                fecha: registro.Date,
                odd: registro.Odd,
                result: registro.Result,
                roi
            });
        }
    });
}

/* ----------------------- TABLA RESUMEN ----------------------- */

function mostrarTablaResumen(data) {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";

    data.forEach(r => {
        let tr = document.createElement("tr");
        if (r.roi > 0) tr.classList.add("positivo");

        tr.innerHTML = `
            <td>${r.equipo}</td>
            <td>${r.games}</td>
            <td>${r.wins}</td>
            <td>${r.losses}</td>
            <td><b>${r.roi.toFixed(2)}%</b></td>
        `;

        tbody.appendChild(tr);
    });
}

/* ----------------------- TABLA DETALLE ----------------------- */

function mostrarTablaDetalle(data) {
    const tbody = document.querySelector("#detalleTable tbody");
    tbody.innerHTML = "";

    data.forEach(r => {
        let tr = document.createElement("tr");
        if (r.roi > 0) tr.classList.add("positivo");

        tr.innerHTML = `
            <td>${r.equipo}</td>
            <td>${r.partido}</td>
            <td>${r.liga}</td>
            <td>${r.fecha}</td>
            <td>${r.odd}</td>
            <td>${r.result}</td>
            <td>${r.roi.toFixed(2)}</td>
        `;

        tbody.appendChild(tr);
    });
}

/* ----------------------- CSV EXPORT ----------------------- */

function exportCSV() {
    let csv = "Equipo,Partidos,Ganados,Perdidos,ROI\n";

    resultadosTabla.forEach(r => {
        csv += `${r.equipo},${r.games},${r.wins},${r.losses},${r.roi.toFixed(2)}\n`;
    });

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = "backtesting.csv";
    a.click();
}

/* ----------------------- GRÁFICA ----------------------- */

let chart;

function graficar(data) {
    const ctx = document.getElementById("roiChart");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: data.map(x => x.equipo),
            datasets: [{
                label: "ROI %",
                data: data.map(x => x.roi)
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}

</script>

</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Poisson Pro V12 - Tramo 20-45 Especial</title>
    <style>
        :root { --primary: #001e54; --accent: #2563eb; --whatsapp: #25d366; --telegram: #0088cc; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        textarea { width: 100%; height: 180px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: monospace; font-size: 11px; box-sizing: border-box; }
        
        .main-btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 20px 0; }
        
        .share-container { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; display: none; }
        .share-btn { padding: 12px 20px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; text-decoration: none; font-size: 13px; }
        .btn-ws { background: var(--whatsapp); } .btn-tg { background: var(--telegram); }

        #resultsUI { display: none; }
        .match-header { text-align: center; margin-bottom: 25px; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; }
        .racha-badge { font-size: 11px; padding: 2px 6px; border-radius: 3px; margin: 0 2px; color: white; font-weight: bold; }
        .racha-W { background: #10b981; } .racha-D { background: #f59e0b; } .racha-L { background: #ef4444; }

        .special-market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .special-market { background: #eff6ff; border: 2px solid #bfdbfe; padding: 20px; border-radius: 12px; text-align: center; }
        .prob-large { font-size: 32px; font-weight: 900; color: var(--accent); }
        
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .card-header { background: var(--primary); color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        .val-win { color: #059669; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="grid-inputs">
        <textarea id="hInput" placeholder="Datos LOCAL (incluyendo 'Flag' y 'This season in the league')..."></textarea>
        <textarea id="aInput" placeholder="Datos VISITANTE (incluyendo 'Flag' y 'This season in the league')..."></textarea>
    </div>

    <button class="main-btn" onclick="executeAnalysis()">CALCULAR PROBABILIDADES EXPERTAS</button>

    <div id="resultsUI">
        <div class="share-container" id="shareBtns">
            <button class="share-btn btn-ws" onclick="share('whatsapp')">WhatsApp</button>
            <button class="share-btn btn-tg" onclick="share('telegram')">Telegram</button>
        </div>

        <div class="match-header">
            <h2 id="matchTitle">Partido</h2>
            <div id="rachasDisplay" style="margin-top:10px;"></div>
        </div>

        <div class="special-market-grid">
            <div class="special-market">
                <h3 style="margin:0; font-size: 14px;">üéØ GOL ANTES DEL MIN 30</h3>
                <div id="p30" class="prob-large">0%</div>
                <div id="c30" style="font-weight: bold;">C: 0.00</div>
            </div>
            <div class="special-market" style="border-color: #f59e0b; background: #fffbeb;">
                <h3 style="margin:0; font-size: 14px; color: #b45309;">‚è≥ GOL ENTRE 20' - 45'</h3>
                <div id="p2045" class="prob-large" style="color: #d97706;">0%</div>
                <div id="c2045" style="font-weight: bold; color: #b45309;">C: 0.00</div>
            </div>
        </div>

        <div class="tables-grid">
            <div class="card"><div class="card-header">MERCADOS PRINCIPALES</div><table id="mainTab"></table></div>
            <div class="card"><div class="card-header">AN√ÅLISIS POR TRAMOS 15'</div><table id="rngTab"></table></div>
        </div>
    </div>
</div>

<script>
const fact = n => (n <= 1) ? 1 : n * fact(n - 1);
const poisson = (k, l) => (Math.pow(l, k) * Math.exp(-l)) / fact(k);
let reportData = {};

function getDixonColesAdj(x, y, lX, lY) {
    const rho = -0.15;
    if (x === 0 && y === 0) return 1 - (lX * lY * rho);
    if (x === 0 && y === 1) return 1 + (lX * rho);
    if (x === 1 && y === 0) return 1 + (lY * rho);
    if (x === 1 && y === 1) return 1 - rho;
    return 1;
}

function extractName(text) {
    const match = text.match(/Flag\s+([^\n\r]+)/i);
    return match ? match[1].split('-')[0].split('Stats')[0].trim() : "Equipo";
}

function extractRachaAfterText(text) {
    const keyword = "This season in the league";
    const index = text.indexOf(keyword);
    if (index === -1) return [];
    const relevantPart = text.substring(index + keyword.length);
    const rachaMatch = relevantPart.match(/[WDL]{3,10}/g);
    return rachaMatch ? rachaMatch[0].split('') : [];
}

function parseInput(text) {
    const name = extractName(text);
    const racha = extractRachaAfterText(text);
    const gp = parseInt(text.match(/GP\s+(\d+)/)?.[1] || 10);
    let formFactor = 1.0;
    racha.slice(-5).forEach(res => {
        if(res === 'W') formFactor += 0.04;
        if(res === 'L') formFactor -= 0.04;
    });
    const intervals = ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"];
    let tramos = [];
    intervals.forEach(r => {
        const m = text.match(new RegExp(r + "\\s+GF\\s+(\\d+)\\s+GA\\s+(\\d+)"));
        tramos.push({ gf: m ? ((parseInt(m[1])/gp)*formFactor):0.05, ga: m ? (parseInt(m[2])/gp):0.05 });
    });
    return { name, tramos, racha };
}

function executeAnalysis() {
    const h = parseInput(document.getElementById('hInput').value);
    const a = parseInput(document.getElementById('aInput').value);
    document.getElementById('matchTitle').innerText = `${h.name} vs ${a.name}`;
    
    let rhtml = `<b>${h.name}:</b> `;
    h.racha.forEach(r => rhtml += `<span class="racha-badge racha-${r}">${r}</span>`);
    rhtml += `<br><b>${a.name}:</b> `;
    a.racha.forEach(r => rhtml += `<span class="racha-badge racha-${r}">${r}</span>`);
    document.getElementById('rachasDisplay').innerHTML = rhtml;

    let lH = [], lA = [];
    for(let i=0; i<6; i++) {
        lH.push((h.tramos[i].gf + a.tramos[i].ga) / 2);
        lA.push((a.tramos[i].gf + h.tramos[i].ga) / 2);
    }

    const calcProb = (lhArr, laArr, line) => {
        const sH = lhArr.reduce((a,b)=>a+b,0), sA = laArr.reduce((a,b)=>a+b,0);
        let pU = 0;
        for(let x=0; x<=8; x++) for(let y=0; y<=8; y++) 
            if(x+y < line) pU += poisson(x,sH)*poisson(y,sA)*getDixonColesAdj(x,y,sH,sA);
        return (1-pU)*100;
    };

    const pFT25 = calcProb(lH, lA, 2.5);
    const pHT05 = calcProb(lH.slice(0,3), lA.slice(0,3), 0.5);
    const pSH05 = calcProb(lH.slice(3,6), lA.slice(3,6), 0.5);
    const p30 = calcProb(lH.slice(0,2), lA.slice(0,2), 0.5);
    
    // C√°lculo 20-45: (2/3 del tramo 16-30) + (100% del tramo 31-45)
    const lH2045 = (lH[1] * 0.66) + lH[2];
    const lA2045 = (lA[1] * 0.66) + lA[2];
    const p2045 = calcProb([lH2045], [lA2045], 0.5);

    reportData = { 
        title: `${h.name} vs ${a.name}`, 
        pFT25, cFT25: 100/pFT25, pHT05, cHT05: 100/pHT05,
        pSH05, cSH05: 100/pSH05, p30, c30: 100/p30,
        p2045, c2045: 100/p2045,
        p015: calcProb([lH[0]], [lA[0]], 0.5),
        p1630: calcProb([lH[1]], [lA[1]], 0.5)
    };

    document.getElementById('p30').innerText = p30.toFixed(1) + "%";
    document.getElementById('c30').innerText = `C: ${reportData.c30.toFixed(2)}`;
    document.getElementById('p2045').innerText = p2045.toFixed(1) + "%";
    document.getElementById('c2045').innerText = `C: ${reportData.c2045.toFixed(2)}`;

    document.getElementById('mainTab').innerHTML = `
        <tr><th>Mercado</th><th>Prob.</th><th>Cuota</th></tr>
        <tr><td>Over 2.5 FT</td><td class="val-win">${pFT25.toFixed(1)}%</td><td>${reportData.cFT25.toFixed(2)}</td></tr>
        <tr><td>Over 0.5 HT</td><td class="val-win">${pHT05.toFixed(1)}%</td><td>${reportData.cHT05.toFixed(2)}</td></tr>
        <tr><td>Over 0.5 2ndH</td><td class="val-win">${pSH05.toFixed(1)}%</td><td>${reportData.cSH05.toFixed(2)}</td></tr>
    `;

    const labels = ["0-15'", "16-30'", "31-45'", "46-60'", "61-75'", "76-90'"];
    let tramoHtml = "<tr><th>Tramo</th><th>Prob.</th><th>Cuota</th></tr>";
    for(let i=0; i<6; i++) {
        let p = calcProb([lH[i]], [lA[i]], 0.5);
        tramoHtml += `<tr><td>${labels[i]}</td><td class="val-win">${p.toFixed(1)}%</td><td>${(100/p).toFixed(2)}</td></tr>`;
    }
    document.getElementById('rngTab').innerHTML = tramoHtml;

    document.getElementById('resultsUI').style.display = 'block';
    document.getElementById('shareBtns').style.display = 'flex';
}

function share(platform) {
    const msg = `üìä *REPORTE:* *${reportData.title}*\n\n` +
                `‚öΩ Over 2.5 FT: ${reportData.pFT25.toFixed(1)}% (C: ${reportData.cFT25.toFixed(2)})\n` +
                `‚è± Over 0.5 HT: ${reportData.pHT05.toFixed(1)}% (C: ${reportData.cHT05.toFixed(2)})\n` +
                `üîÑ Over 0.5 2ndH: ${reportData.pSH05.toFixed(1)}% (C: ${reportData.cSH05.toFixed(2)})\n\n` +
                `üéØ *GOL ANTES MIN 30:* ${reportData.p30.toFixed(1)}% (C: ${reportData.c30.toFixed(2)})\n` +
                `‚è≥ *GOL TRAMO 20'-45':* ${reportData.p2045.toFixed(1)}% (C: ${reportData.c2045.toFixed(2)})\n\n` +
                `üïí *Tramos:* \n` +
                `- 0-15': ${reportData.p015.toFixed(1)}%\n` +
                `- 16-30': ${reportData.p1630.toFixed(1)}%`;
    
    const url = platform === 'whatsapp' 
        ? `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`
        : `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
}
</script>
</body>
</html>

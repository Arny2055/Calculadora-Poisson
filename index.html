<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Backtesting Robusto (Corregido) - Historial + Futuros</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--card-bg:#fff;--page-bg:#f4f6f8;--accent:#0b67d0}
body{font-family:Inter, system-ui, Arial, sans-serif;background:var(--page-bg);margin:0;padding:20px;color:#111}
.container{max-width:1100px;margin:0 auto}
h1{margin:0 0 12px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:var(--card-bg);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(12,20,30,0.06)}
label{display:block;margin-bottom:6px;font-weight:600}
input[type=file]{display:block}
button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;margin-top:8px}
button[disabled]{opacity:.5;cursor:not-allowed}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{border:1px solid #e6e9ee;padding:8px;text-align:left}
th{background:#0f1724;color:#fff}
.small{font-size:13px;color:#666}
.good{color:green;font-weight:700}
.bad{color:red;font-weight:700}
pre.log{background:#0b1220;color:#dbe9ff;padding:8px;border-radius:6px;height:120px;overflow:auto;font-size:13px}
.full{grid-column:1/ -1}
.csv-btn{background:#1f8a3d}
.count{font-weight:700;margin-left:8px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
    <h1>Backtesting ‚Äî Versi√≥n Corregida</h1>
    <p class="small">Bank = <b>100</b> (referencia) ‚Ä¢ Stake fijo = <b>1</b> por apuesta.</p>

    <div class="grid">
        <div class="card">
            <label>1) Archivo HISTORIAL (Backtesting)</label>
            <input id="histInput" type="file" accept=".json" />
            <div class="small">Registros detectados: <span id="histCount" class="count">0</span></div>
            <div class="small" style="margin-top:8px">Campos esperados: <code>Match</code>, <code>Odd</code>, <code>Result</code> (Winning/Losing).</div>
        </div>

        <div class="card">
            <label>2) Archivo PARTIDOS FUTUROS</label>
            <input id="futInput" type="file" accept=".json" />
            <div class="small">Registros detectados: <span id="futCount" class="count">0</span></div>
            <div class="small" style="margin-top:8px">Campos √∫tiles: <code>Match</code>, <code>Date</code>, <code>Odd</code> (opcional).</div>
        </div>

        <div class="card full">
            <button id="runBtn">üîç Hacer Backtesting y Aplicar a Futuros</button>
            <button id="downloadCsv" class="csv-btn" style="margin-left:8px">‚¨á Descargar CSV (Predicci√≥n)</button>
            <button id="clearMemory" style="margin-left:8px;background:#d03b3b">üóë Limpiar archivos cargados</button>
            <div style="margin-top:8px" class="small">Logs / mensajes:</div>
            <pre id="log" class="log"></pre>
        </div>

        <div class="card full">
            <h3>Resumen global</h3>
            <div id="summary" class="small">A√∫n no hay datos procesados.</div>
        </div>

        <div class="card">
            <h3>Tabla: Partidos HISTORIAL procesados</h3>
            <table id="histTable">
                <thead><tr><th>Fecha</th><th>Liga</th><th>Match</th><th>Pick</th><th>Odd</th><th>Result</th><th>Ganancia</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card">
            <h3>ROI por Equipo (hist√≥rico)</h3>
            <table id="teamTable">
                <thead><tr><th>Equipo</th><th>Partidos</th><th>Victorias</th><th>Profit</th><th>ROI %</th><th>Profit / part. (avg)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card full">
            <h3>Predicci√≥n aplicada a PARTIDOS FUTUROS</h3>
            <table id="predTable">
                <thead><tr><th>Fecha</th><th>Liga</th><th>Match</th><th>Local (ROI%)</th><th>Visitante (ROI%)</th><th>AvgProfit Local</th><th>AvgProfit Visit.</th><th>EV estimado</th><th>Recomendaci√≥n</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const STAKE = 1;
const INITIAL_BANK = 100;

/* ---------- HELPERS ---------- */
const $ = id => document.getElementById(id);
const logEl = $('log');
function log(msg){
    const time = new Date().toLocaleTimeString();
    logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
}
function toNumber(v){
    if(v === null || v === undefined || v === '') return NaN;
    const s = String(v).replace(/\u00A0/g,'').trim();
    const s2 = s.replace(/,(\d{1,})$/,'.$1');
    const n = parseFloat(s2);
    return isNaN(n) ? NaN : n;
}
function isWinning(result){
    if(!result) return false;
    const r = String(result).toLowerCase().trim();
    return ['winning','won','win','w','ganado','g','victoria','victorias','victory'].includes(r);
}

/* Robust parse (same as versi√≥n anterior) */
function parseJSONContent(content){
    content = content.trim();
    if(!content) throw new Error("Contenido vac√≠o");
    try {
        const parsed = JSON.parse(content);
        if(Array.isArray(parsed)) return parsed;
        if(typeof parsed === 'object') return [parsed];
    } catch(e){}
    try {
        const wrapped = '[' + content + ']';
        const cleaned = wrapped.replace(/,\s*(\]|\})/g, '$1');
        const parsed = JSON.parse(cleaned);
        if(Array.isArray(parsed)) return parsed;
    } catch(e){}
    const lines = content.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length > 1){
        const out=[];
        for(const line of lines){
            let ln=line;
            if(ln.endsWith(',')) ln=ln.slice(0,-1);
            try { out.push(JSON.parse(ln)); } catch(e){}
        }
        if(out.length) return out;
    }
    const objs=[];
    const regex=/{[^}]*}/g;
    let m;
    while((m=regex.exec(content))!==null){
        try { objs.push(JSON.parse(m[0])); } catch(e){}
    }
    if(objs.length) return objs;
    throw new Error("No se pudo parsear el JSON. Ver formato.");
}

/* ---------- ESTADO EN MEMORIA ---------- */
/* Ahora guardamos los datos parseados en memoria inmediatamente al subir los archivos. */
let historialUploaded = null;
let futurosUploaded = null;
let teamStats = {};

/* ---------- UI: Lectura inmediata al subir ---------- */
$('histInput').addEventListener('change', async (ev) => {
    const f = ev.target.files[0];
    if(!f){ historialUploaded = null; $('histCount').textContent = 0; return; }
    try {
        const text = await f.text();
        const arr = parseJSONContent(text);
        historialUploaded = arr;
        $('histCount').textContent = arr.length;
        log(`Historial cargado en memoria (${f.name}): ${arr.length} registros.`);
    } catch(err){
        historialUploaded = null;
        $('histCount').textContent = 0;
        log('ERROR parseando historial: ' + err.message);
        alert('Error parseando archivo historial: ' + err.message);
    }
});

$('futInput').addEventListener('change', async (ev) => {
    const f = ev.target.files[0];
    if(!f){ futurosUploaded = null; $('futCount').textContent = 0; return; }
    try {
        const text = await f.text();
        const arr = parseJSONContent(text);
        futurosUploaded = arr;
        $('futCount').textContent = arr.length;
        log(`Futuros cargados en memoria (${f.name}): ${arr.length} registros.`);
    } catch(err){
        futurosUploaded = null;
        $('futCount').textContent = 0;
        log('ERROR parseando futuros: ' + err.message);
        alert('Error parseando archivo futuros: ' + err.message);
    }
});

/* ---------- CLEAR MEMORY BUTTON ---------- */
$('clearMemory').addEventListener('click', () => {
    historialUploaded = null;
    futurosUploaded = null;
    $('histCount').textContent = 0;
    $('futCount').textContent = 0;
    $('histInput').value = '';
    $('futInput').value = '';
    log('Archivos cargados en memoria eliminados por usuario.');
});

/* ---------- PROCESSING (usar datos en memoria) ---------- */
function resetUIOutputs(){
    $('histTable').querySelector('tbody').innerHTML = '';
    $('teamTable').querySelector('tbody').innerHTML = '';
    $('predTable').querySelector('tbody').innerHTML = '';
    $('summary').textContent = 'A√∫n no hay datos procesados.';
}

function processHistorialArray(arr){
    teamStats = {};
    const histBody = $('histTable').querySelector('tbody');
    histBody.innerHTML = '';

    let totalProfit = 0;
    let processed = 0;

    arr.forEach((m, idx) => {
        if(!m.Match){
            log(`Hist registro ${idx+1}: falta 'Match' -> ignorado.`);
            return;
        }
        const match = m.Match;
        const oddRaw = m.Odd ?? m['Odd'] ?? m['odd'] ?? m['Odd 1 PreMatch'] ?? '';
        const odd = toNumber(oddRaw);
        const resultRaw = m.Result ?? m['Result'] ?? '';
        const won = isWinning(resultRaw);

        let gain = 0;
        if(resultRaw){
            if(won && !isNaN(odd)) gain = (odd - 1) * STAKE;
            else if(won && isNaN(odd)) gain = 0;
            else if(!won) gain = -STAKE;
        } else {
            gain = 0;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${m.Date ?? ''}</td>
                        <td>${m.League ?? ''}</td>
                        <td>${match}</td>
                        <td>${m['Desired Outcome'] ?? ''}</td>
                        <td>${oddRaw ?? ''}</td>
                        <td>${resultRaw ?? ''}</td>
                        <td>${gain.toFixed(2)}</td>`;
        histBody.appendChild(tr);

        if(resultRaw){
            totalProfit += gain;
            processed++;

            const parts = match.split(' - ');
            let home = parts[0] ? parts[0].trim() : null;
            let away = parts[1] ? parts[1].trim() : null;

            if(!home || !away){
                const key = match.trim();
                if(!teamStats[key]) teamStats[key] = { matches:0, wins:0, profit:0 };
                teamStats[key].matches++;
                if(won) teamStats[key].wins++;
                teamStats[key].profit += gain;
            } else {
                [home, away].forEach(team => {
                    if(!teamStats[team]) teamStats[team] = { matches:0, wins:0, profit:0 };
                    teamStats[team].matches++;
                    if(won) teamStats[team].wins++;
                    teamStats[team].profit += gain;
                });
            }
        }
    });

    const globalROI = processed > 0 ? (totalProfit / (processed * STAKE)) * 100 : 0;
    $('summary').innerHTML = `<b>Historial procesado:</b> ${processed} partidos con resultado ‚Ä¢ Profit total: ${totalProfit.toFixed(2)} ‚Ä¢ ROI global: ${globalROI.toFixed(2)}%`;

    renderTeamTable();
}

function renderTeamTable(){
    const tbody = $('teamTable').querySelector('tbody');
    tbody.innerHTML = '';
    const keys = Object.keys(teamStats).sort((a,b) => (teamStats[b].profit - teamStats[a].profit));
    keys.forEach(team => {
        const t = teamStats[team];
        const roiPct = t.matches > 0 ? (t.profit / (t.matches * STAKE)) * 100 : 0;
        const avgProfit = t.matches > 0 ? (t.profit / t.matches) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${team}</td>
                        <td>${t.matches}</td>
                        <td>${t.wins}</td>
                        <td>${t.profit.toFixed(2)}</td>
                        <td class="${roiPct>=0?'good':'bad'}">${roiPct.toFixed(2)} %</td>
                        <td>${avgProfit.toFixed(3)}</td>`;
        tbody.appendChild(tr);
    });
}

function applyToFuturos(arr){
    const tbody = $('predTable').querySelector('tbody');
    tbody.innerHTML = '';

    arr.forEach((m, idx) => {
        if(!m.Match){ log(`Fut ${idx+1}: falta Match -> ignorado.`); return; }
        const match = m.Match;
        const parts = match.split(' - ');
        const home = parts[0] ? parts[0].trim() : null;
        const away = parts[1] ? parts[1].trim() : null;

        const statsHome = home && teamStats[home] ? teamStats[home] : null;
        const statsAway = away && teamStats[away] ? teamStats[away] : null;

        const roiHome = statsHome && statsHome.matches>0 ? (statsHome.profit / (statsHome.matches * STAKE)) * 100 : null;
        const roiAway = statsAway && statsAway.matches>0 ? (statsAway.profit / (statsAway.matches * STAKE)) * 100 : null;

        const avgHome = statsHome && statsHome.matches>0 ? (statsHome.profit / statsHome.matches) : null;
        const avgAway = statsAway && statsAway.matches>0 ? (statsAway.profit / statsAway.matches) : null;

        let recommendation = 'Sin datos';
        let ev = null;

        if(avgHome !== null && avgAway !== null){
            ev = Math.max(avgHome, avgAway);
            if(ev > 0) recommendation = avgHome > avgAway ? `${home} (Apostar)` : `${away} (Apostar)`;
            else recommendation = 'No rentable (ev ‚â§ 0)';
        } else if(avgHome !== null){
            ev = avgHome;
            recommendation = avgHome > 0 ? `${home} (Apostar)` : 'No rentable (ev ‚â§ 0)';
        } else if(avgAway !== null){
            ev = avgAway;
            recommendation = avgAway > 0 ? `${away} (Apostar)` : 'No rentable (ev ‚â§ 0)';
        }

        const displayRoiHome = roiHome === null ? 'N/A' : `${roiHome.toFixed(2)} %`;
        const displayRoiAway = roiAway === null ? 'N/A' : `${roiAway.toFixed(2)} %`;
        const displayAvgHome = avgHome === null ? 'N/A' : avgHome.toFixed(3);
        const displayAvgAway = avgAway === null ? 'N/A' : avgAway.toFixed(3);
        const displayEV = ev === null ? 'N/A' : ev.toFixed(3);

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${m.Date ?? ''}</td>
                        <td>${m.League ?? ''}</td>
                        <td>${match}</td>
                        <td class="${(roiHome||0)>=0?'good':'bad'}">${displayRoiHome}</td>
                        <td class="${(roiAway||0)>=0?'good':'bad'}">${displayRoiAway}</td>
                        <td>${displayAvgHome}</td>
                        <td>${displayAvgAway}</td>
                        <td>${displayEV}</td>
                        <td><b>${recommendation}</b></td>`;
        tbody.appendChild(tr);
    });
}

/* CSV export */
function downloadPredictionCSV(){
    const rows = [];
    rows.push(['Fecha','Liga','Match','ROI Local (%)','ROI Visitante (%)','AvgProfit Local','AvgProfit Visitante','EV estimado','Recomendaci√≥n']);
    const tbody = $('predTable').querySelector('tbody');
    for(const tr of tbody.querySelectorAll('tr')){
        const cols = Array.from(tr.children).map(td => td.innerText.replace(/\n/g,' ').trim());
        rows.push(cols);
    }
    if(rows.length <= 1){ alert('No hay predicciones para exportar.'); return; }
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `predicciones_backtesting_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

/* ---------- RUN BUTTON ---------- */
$('runBtn').addEventListener('click', async () => {
    // Validaciones: usar datos ya cargados en memoria
    if(!historialUploaded){
        alert('Primero carga el archivo de HISTORIAL (se parsear√° en memoria al subir).');
        return;
    }
    if(!futurosUploaded){
        alert('Primero carga el archivo de PARTIDOS FUTUROS (se parsear√° en memoria al subir).');
        return;
    }

    // Desactivar bot√≥n durante procesado
    $('runBtn').disabled = true;
    $('downloadCsv').disabled = true;
    log('Iniciando backtesting con datos en memoria...');

    try {
        resetUIOutputs();
        processHistorialArray(historialUploaded);
        applyToFuturos(futurosUploaded);
        log('Backtesting completado correctamente.');
    } catch(err){
        log('ERROR durante backtesting: ' + (err.message || err));
        alert('Error durante backtesting: ' + (err.message || 'ver logs'));
    } finally {
        $('runBtn').disabled = false;
        $('downloadCsv').disabled = false;
    }
});

$('downloadCsv').addEventListener('click', downloadPredictionCSV);

/* Inicial state */
log('Interfaz lista. Sube archivos para empezar. (Se guardan en memoria al subir).');

</script>
</body>
</html>
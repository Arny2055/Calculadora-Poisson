<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora Poisson + CV (1X2, DNB, OU, BTTS)</title>
<style>
  :root{--bg:#0f1115;--panel:#171a21;--text:#e8ecf3;--muted:#a9b2c3;--accent:#7aa2ff;--ok:#5dd4a4;--warn:#ffb84d;--danger:#ff6b6b;--border:#2a3140}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif}
  header{padding:18px 20px;border-bottom:1px solid var(--border);background:#0c0e13}
  h1{font-size:18px;margin:0} .wrap{max-width:980px;margin:0 auto;padding:20px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="number"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#12151c;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{margin-top:14px;background:var(--accent);border:none;border-radius:10px;padding:12px 14px;color:#0b0f18;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  th:first-child,td:first-child{text-align:left}
  .kpi{display:flex;gap:18px;flex-wrap:wrap;margin-top:12px;font-size:14px}
  .pill{padding:6px 10px;border-radius:999px;background:#12151c;border:1px solid var(--border);color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  small{color:var(--muted)}
</style>
</head>
<body>
  <header><h1>Calculadora Poisson con Coeficiente de Variación</h1></header>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h3>Parámetros de entrada</h3>
        <div class="row">
          <div>
            <label>Goles a favor LOCAL (GF<sub>H</sub>)</label>
            <input id="gfH" type="number" step="0.01" min="0" value="1.4">
          </div>
          <div>
            <label>CV LOCAL</label>
            <input id="cvH" type="number" step="0.01" min="0" value="0.77">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Goles a favor VISITA (GF<sub>A</sub>)</label>
            <input id="gfA" type="number" step="0.01" min="0" value="1.6">
          </div>
          <div>
            <label>CV VISITA</label>
            <input id="cvA" type="number" step="0.01" min="0" value="0.60">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>α (fuerza del encogimiento por CV) <small>0.0–1.5</small></label>
            <input id="alpha" type="number" step="0.05" min="0" max="1.5" value="0.5">
          </div>
          <div>
            <label>Límite de suma de marcadores <small>(máx goles por lado)</small></label>
            <input id="maxGoals" type="number" step="1" min="6" value="12">
          </div>
        </div>
        <button class="btn" id="calc">Calcular mercados</button>
        <div class="kpi" id="kpi"></div>
        <small>Modelo: λ = GF · 1/(1+α·CV). Independencia Poisson por equipo.</small>
      </div>

      <div class="card">
        <h3>Resultados</h3>
        <table id="tbl1">
          <thead><tr><th>Mercado</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="tbl2">
          <thead><tr><th>Over/Under</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="tbl3">
          <thead><tr><th>BTTS</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);

  function shrink(gf, cv, alpha){
    return gf * (1 / (1 + alpha * Math.max(cv,0)));
  }

  // Poisson PMF
  function poisPMF(k, lambda){
    if(lambda<=0) return (k===0)?1:0;
    // log-sum for stability
    let logp = -lambda + k * Math.log(lambda) - logFactorial(k);
    return Math.exp(logp);
  }
  // Poisson CDF up to k
  function poisCDF(k, lambda){
    let sum = 0;
    for(let i=0;i<=k;i++) sum += poisPMF(i, lambda);
    return sum;
  }

  // factorial cache
  const fact = [1];
  function factorial(n){
    for(let i=fact.length;i<=n;i++) fact[i]=fact[i-1]*i;
    return fact[n];
  }
  function logFactorial(n){
    // Stirling for big n to avoid overflow
    if(n<100) return Math.log(factorial(n));
    const x=n;
    return x*Math.log(x)-x+0.5*Math.log(2*Math.PI*x); // Stirling
  }

  function matrix1X2(lH, lA, maxGoals){
    let p1=0, px=0, p2=0;
    for(let i=0;i<=maxGoals;i++){
      const pHi = poisPMF(i,lH);
      for(let j=0;j<=maxGoals;j++){
        const pAj = poisPMF(j,lA);
        const pij = pHi * pAj;
        if(i>j) p1 += pij;
        else if(i===j) px += pij;
        else p2 += pij;
      }
    }
    // Tail correction for goals beyond maxGoals (usually tiny)
    const tailH = 1 - poisCDF(maxGoals, lH);
    const tailA = 1 - poisCDF(maxGoals, lA);
    // Add approximate mass by pushing tails to closest categories:
    // H tail vs A<=max → mostly win; A tail vs H<=max → mostly lose; both tails → draw
    // (impact minúsculo si maxGoals>=10)
    p1 += tailH * (1 - poisCDF(maxGoals, lA));
    p2 += tailA * (1 - poisCDF(maxGoals, lH));
    // Re-normaliza
    const s = p1+px+p2;
    return {p1:p1/s, px:px/s, p2:p2/s};
  }

  function toOdds(p){
    return (p<=0)? Infinity : (1/p);
  }
  function fmtP(p){ return (100*p).toFixed(2)+'%'; }
  function fmtO(o){ return (o===Infinity)? '—' : o.toFixed(2); }

  function calc(){
    const gfH = +$('#gfH').value, cvH = +$('#cvH').value;
    const gfA = +$('#gfA').value, cvA = +$('#cvA').value;
    const alpha = +$('#alpha').value;
    const maxGoals = Math.max(6, Math.floor(+$('#maxGoals').value)||12);

    const lamH = shrink(gfH, cvH, alpha);
    const lamA = shrink(gfA, cvA, alpha);
    const lamT = lamH + lamA;

    // 1X2
    const m = matrix1X2(lamH, lamA, maxGoals);
    const p1 = m.p1, px = m.px, p2 = m.p2;

    // DNB fair odds: (1 - P(draw)) / P(win)
    const pNotDraw = 1 - px;
    const dnb1_odds = toOdds(p1 / pNotDraw);
    const dnb2_odds = toOdds(p2 / pNotDraw);

    // OU using Poisson(lamT)
    const over15 = 1 - poisCDF(1, lamT);
    const over25 = 1 - poisCDF(2, lamT);
    const over35 = 1 - poisCDF(3, lamT);

    // BTTS
    const pBTTSyes = 1 - Math.exp(-lamH) - Math.exp(-lamA) + Math.exp(-lamT);
    const pBTTSno  = 1 - pBTTSyes;

    // KPIs arriba
    $('#kpi').innerHTML = `
      <span class="pill">λ<sub>H</sub>=<b class="mono">${lamH.toFixed(3)}</b></span>
      <span class="pill">λ<sub>A</sub>=<b class="mono">${lamA.toFixed(3)}</b></span>
      <span class="pill">λ<sub>T</sub>=<b class="mono">${lamT.toFixed(3)}</b></span>
      <span class="pill">P(draw)=<b class="mono">${fmtP(px)}</b></span>
    `;

    // Tabla 1X2 + DNB
    const t1 = $('#tbl1 tbody');
    t1.innerHTML = `
      <tr><td>1 (Local)</td><td class="mono">${fmtP(p1)}</td><td class="mono">${fmtO(toOdds(p1))}</td></tr>
      <tr><td>X (Empate)</td><td class="mono">${fmtP(px)}</td><td class="mono">${fmtO(toOdds(px))}</td></tr>
      <tr><td>2 (Visita)</td><td class="mono">${fmtP(p2)}</td><td class="mono">${fmtO(toOdds(p2))}</td></tr>
      <tr><td>1 DNB</td><td class="mono"><small>éxito = ganar</small></td><td class="mono">${fmtO(dnb1_odds)}</td></tr>
      <tr><td>2 DNB</td><td class="mono"><small>éxito = ganar</small></td><td class="mono">${fmtO(dnb2_odds)}</td></tr>
    `;

    // Tabla OU
    const t2 = $('#tbl2 tbody');
    t2.innerHTML = `
      <tr><td>Over 1.5</td><td class="mono">${fmtP(over15)}</td><td class="mono">${fmtO(toOdds(over15))}</td></tr>
      <tr><td>Under 1.5</td><td class="mono">${fmtP(1-over15)}</td><td class="mono">${fmtO(toOdds(1-over15))}</td></tr>
      <tr><td>Over 2.5</td><td class="mono">${fmtP(over25)}</td><td class="mono">${fmtO(toOdds(over25))}</td></tr>
      <tr><td>Under 2.5</td><td class="mono">${fmtP(1-over25)}</td><td class="mono">${fmtO(toOdds(1-over25))}</td></tr>
      <tr><td>Over 3.5</td><td class="mono">${fmtP(over35)}</td><td class="mono">${fmtO(toOdds(over35))}</td></tr>
      <tr><td>Under 3.5</td><td class="mono">${fmtP(1-over35)}</td><td class="mono">${fmtO(toOdds(1-over35))}</td></tr>
    `;

    // Tabla BTTS
    const t3 = $('#tbl3 tbody');
    t3.innerHTML = `
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTSyes)}</td><td class="mono">${fmtO(toOdds(pBTTSyes))}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pBTTSno)}</td><td class="mono">${fmtO(toOdds(pBTTSno))}</td></tr>
    `;
  }

  $('#calc').addEventListener('click', calc);
  // cálculo inicial con valores de ejemplo
  calc();
})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson - Veredicto Final</title>
    <style>
        /* Estilos CSS Base */
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); width: 100%; max-width: 800px; text-align: center; }
        h1 { color: #8b008b; margin-bottom: 15px; border-bottom: 3px solid #8b008b; padding-bottom: 10px; font-size: 2em; }
        h2 { color: #007bff; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-row { border: 1px solid #8b008b; border-radius: 5px; padding: 15px; }
        .input-row h3 { color: #8b008b; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 0; }
        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { font-weight: bold; display: block; font-size: 0.9em; margin-bottom: 2px; }
        .input-group input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; text-align: center; }
        button { width: 80%; padding: 12px; background-color: #8b008b; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px; }
        button:hover { background-color: #5d005d; }
        
        /* Resultados */
        #results { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .rates-summary { background-color: #f3e5f5; border: 1px solid #ce93d8; color: #4a148c; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .market-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .market-results { text-align: center; }
        .market-results h4 { color: #555; margin-bottom: 10px; }
        .result-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .result-box { padding: 10px; border-radius: 8px; text-align: center; }
        .result-box.btts { background-color: #d6eaff; border: 2px solid #007bff; }
        .result-box.ou { background-color: #e0ffe0; border: 2px solid #28a745; }
        .result-value { font-size: 1.4em; font-weight: bold; }
        
        /* Secci√≥n de Veredicto y An√°lisis */
        #analysis_section { background-color: #fff8e1; border: 2px solid #ffd700; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left; }
        #analysis_section h3 { color: #b8860b; margin-top: 0; border-bottom: 1px dashed #ffeeba; padding-bottom: 5px; }
        .efficiency-summary { margin-bottom: 10px; font-size: 1em; }
        .context-text { font-size: 0.95em; }
        
        /* VEREDICTO FINAL */
        #final_verdict { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 2.5em; /* Letras grandes */
            font-weight: 900; 
            text-transform: uppercase;
        }
        .bet { 
            background-color: #4CAF50; /* Verde */
            color: white; 
            border: 3px solid #388E3C;
        }
        .pass { 
            background-color: #f44336; /* Rojo */
            color: white; 
            border: 3px solid #D32F2F;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> ‚öΩ Modelo Poisson Refinado </h1>
        <p>Utiliza **Goles Esperados** ($\lambda$) y las m√©tricas de disparo (SOT, S/G) para el an√°lisis de riesgo/eficiencia.</p>
           
        <div class="input-grid">
            <div class="input-row">
                <h3>Local</h3>
                <div class="input-group">
                    <label for="home_lambda">Goles Esperados ($\lambda$):</label>
                    <input type="number" id="home_lambda" value="1.8" step="0.01" min="0">
                </div>
                <div class="input-group">
                    <label for="home_sot">Disparos a Puerta (SOT) Promedio:</label>
                    <input type="number" id="home_sot" value="4.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="home_spg">Disparos por Gol (S/G) Promedio:</label>
                    <input type="number" id="home_spg" value="4.0" step="0.1" min="0">
                </div>
            </div>

            <div class="input-row">
                <h3>Visitante</h3>
                <div class="input-group">
                    <label for="away_lambda">Goles Esperados ($\lambda$):</label>
                    <input type="number" id="away_lambda" value="1.5" step="0.01" min="0">
                </div>
                <div class="input-group">
                    <label for="away_sot">Disparos a Puerta (SOT) Promedio:</label>
                    <input type="number" id="away_sot" value="5.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="away_spg">Disparos por Gol (S/G) Promedio:</label>
                    <input type="number" id="away_spg" value="7.0" step="0.1" min="0">
                </div>
            </div>
        </div>

        <button onclick="calculateProbabilities()">Calcular Pron√≥stico y Veredicto</button>
        
        <div id="results">
            <h2>Resultados Base de Poisson</h2>

            <div class="rates-summary" id="calculated_rates_summary">
                $\lambda_{\text{Local}}$: 0.00 | $\lambda_{\text{Visita}}$: 0.00 | $\lambda_{\text{Total}}$: 0.00
            </div>
            
            <div class="market-section">
                <div class="market-results">
                    <h4>Mercado: Ambos Anotan (BTTS)</h4>
                    <div class="result-box-grid">
                        <div class="result-box btts">
                            <strong>BTTS S√ç</strong>
                            <div class="result-value" id="prob_btts_yes_td">0.00%</div>
                        </div>
                        <div class="result-box btts">
                            <strong>Cuota Impl√≠cita</strong>
                            <div class="result-value" id="odd_btts_yes_td">0.00</div>
                        </div>
                    </div>
                </div>

                <div class="market-results">
                    <h4>Mercado: Total de Goles (2.5)</h4>
                    <div class="result-box-grid">
                        <div class="result-box ou">
                            <strong>M√ÅS DE 2.5</strong>
                            <div class="result-value" id="prob_over_2_5_td">0.00%</div>
                        </div>
                        <div class="result-box ou">
                            <strong>Cuota Impl√≠cita</strong>
                            <div class="result-value" id="odd_over_2_5_td">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="analysis_section">
                <h3>üéØ An√°lisis de Presi√≥n y Eficiencia</h3>
                <div class="efficiency-summary" id="sot_summary"></div>
                <div class="efficiency-summary" id="spg_summary"></div>
                <div class="context-text" id="efficiency_context"></div>
            </div>

            <div id="final_verdict" class="pass">
                REALICE EL C√ÅLCULO
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n de Probabilidad de Poisson P(k; lambda)
        function poissonProbability(k, lambda) {
            if (k < 0 || lambda < 0) return 0;
            if (lambda === 0 && k > 0) return 0;
            if (lambda === 0 && k === 0) return 1;
            
            let logFactorial = 0;
            for (let i = 2; i <= k; i++) {
                logFactorial += Math.log(i);
            }
            // Utiliza logaritmos para evitar errores de punto flotante en c√°lculos grandes, aunque Math.pow/factorial simple funciona para k peque√±os.
            // Para este caso, mantenemos el c√°lculo simple ya que k es peque√±o (m√°x. 2) para el under/over 2.5
            let factorial = 1;
            for (let i = 2; i <= k; i++) {
                factorial *= i;
            }
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial;
        }

        // Calcula las probabilidades de los mercados principales
        function calculateMarketProbs(lambdaHome, lambdaAway) {
            const lambdaTotal = lambdaHome + lambdaAway;
            
            // Probabilidad de Ambos Anotan (BTTS)
            const probHomeZero = poissonProbability(0, lambdaHome);
            const probAwayZero = poissonProbability(0, lambdaAway);
            const probZeroZero = probHomeZero * probAwayZero; 
            // P(BTTS No) = P(Goles Local=0) + P(Goles Visita=0) - P(0-0)
            const probBTTsNo = probHomeZero + probAwayZero - probZeroZero;
            const probBTTsYes = 1 - probBTTsNo;

            // Probabilidad de M√°s/Menos de 2.5 Goles
            const probTotalZero = poissonProbability(0, lambdaTotal);
            const probTotalOne = poissonProbability(1, lambdaTotal);
            const probTotalTwo = poissonProbability(2, lambdaTotal);
            const probUnder2_5 = probTotalZero + probTotalOne + probTotalTwo;
            const probOver2_5 = 1 - probUnder2_5;

            return {
                lambdaHome: lambdaHome,
                lambdaAway: lambdaAway,
                lambdaTotal: lambdaTotal,
                bttsYes: probBTTsYes,
                over2_5: probOver2_5,
                under2_5: probUnder2_5
            };
        }
        
        // Funciones de formato
        const format = (p) => (p * 100).toFixed(2) + '%';
        const formatOdd = (p) => (p > 0.005 ? (1 / p).toFixed(2) : '‚àû');
        
        // Funci√≥n principal de c√°lculo y veredicto
        function calculateProbabilities() {
            // 1. Obtener entradas del usuario
            const lambdaHome = parseFloat(document.getElementById('home_lambda').value);
            const homeSOT = parseFloat(document.getElementById('home_sot').value);
            const homeSPG = parseFloat(document.getElementById('home_spg').value); 
            
            const lambdaAway = parseFloat(document.getElementById('away_lambda').value);
            const awaySOT = parseFloat(document.getElementById('away_sot').value);
            const awaySPG = parseFloat(document.getElementById('away_spg').value);
            
            // Validaci√≥n b√°sica
            if (isNaN(lambdaHome) || isNaN(homeSOT) || isNaN(homeSPG) || 
                isNaN(lambdaAway) || isNaN(awaySOT) || isNaN(awaySPG) ||
                lambdaHome < 0 || lambdaAway < 0 || homeSOT < 0 || awaySOT < 0 || homeSPG <= 0 || awaySPG <= 0) {
                alert('Por favor, introduce valores num√©ricos v√°lidos y positivos (S/G debe ser > 0).');
                return;
            }
            
            // 2. Calcular los mercados (Base Poisson)
            const results = calculateMarketProbs(lambdaHome, lambdaAway);

            // 3. Actualizar la Interfaz de Resultados (Base Poisson)
            document.getElementById('calculated_rates_summary').innerHTML = 
                `$\lambda_{\\text{Local}}$: ${results.lambdaHome.toFixed(3)} | 
                $\lambda_{\\text{Visita}}$: ${results.lambdaAway.toFixed(3)} | 
                $\lambda_{\\text{Total}}$: ${results.lambdaTotal.toFixed(3)}`;
            
            document.getElementById('prob_btts_yes_td').textContent = format(results.bttsYes);
            document.getElementById('odd_btts_yes_td').textContent = formatOdd(results.bttsYes);
            
            document.getElementById('prob_over_2_5_td').textContent = format(results.over2_5);
            document.getElementById('odd_over_2_5_td').textContent = formatOdd(results.over2_5);
            
            // 4. AN√ÅLISIS DE PRESI√ìN Y EFICIENCIA (SOT y S/G)
            let efficiencyContext = "";
            // riskFactor: 0 = Neutral, +1 = Menos Riesgo (Eficiente), -1 = M√°s Riesgo (Ineficiente)
            let riskFactor = 0; 
            
            // An√°lisis de Presi√≥n (SOT)
            const diffSOT = homeSOT - awaySOT;
            const avgSOT = (homeSOT + awaySOT) / 2;
            document.getElementById('sot_summary').innerHTML = `SOT Promedio: **Local ${homeSOT.toFixed(1)}** vs. **Visita ${awaySOT.toFixed(1)}** (Diferencia: ${diffSOT.toFixed(1)})`;
            
            if (Math.abs(diffSOT) > Math.max(1.5, avgSOT * 0.3)) { // Diferencia significativa
                efficiencyContext += `El equipo con m√°s presi√≥n (${diffSOT > 0 ? 'Local' : 'Visita'}) es notablemente superior en SOT. `;
            } else {
                efficiencyContext += "La presi√≥n ofensiva (SOT) de ambos equipos es **equilibrada**. ";
            }
            
            // An√°lisis de Eficiencia (S/G)
            // Umbrales de eficiencia: Eficiente <= 4.0; Ineficiente >= 7.0
            const isHomeEfficient = homeSPG <= 4.0;
            const isAwayEfficient = awaySPG <= 4.0;
            const isHomeInefficient = homeSPG >= 7.0;
            const isAwayInefficient = awaySPG >= 7.0;

            document.getElementById('spg_summary').innerHTML = `S/G Promedio: **Local ${homeSPG.toFixed(1)}** vs. **Visita ${awaySPG.toFixed(1)}**`;

            if (isHomeEfficient && isAwayEfficient) {
                efficiencyContext += "Ambos equipos son **altamente eficientes** (S/G bajo), lo que **reduce el riesgo** en el Over/BTTS. ";
                riskFactor = 1;
            } else if (isHomeInefficient && isAwayInefficient) {
                efficiencyContext += "Ambos equipos son **ineficientes** (S/G alto). El Over/BTTS es **m√°s riesgoso** de lo que indica el $\lambda$ base. ";
                riskFactor = -1;
            } else if (isHomeEfficient || isAwayEfficient) {
                 efficiencyContext += `Al menos un equipo es **eficiente** (S/G bajo), lo que equilibra el riesgo. `;
                 riskFactor = 0;
            } else {
                efficiencyContext += "Ambos equipos tienen una **eficiencia media** (S/G entre 4.0 y 7.0). ";
                riskFactor = 0;
            }

            document.getElementById('efficiency_context').innerHTML = `**CONCLUSI√ìN DEL AN√ÅLISIS:** ${efficiencyContext}`;
            
            // 5. VEREDICTO FINAL
            let verdictElement = document.getElementById('final_verdict');
            let probMax = Math.max(results.bttsYes, results.over2_5);
            const PROB_BASE = 0.60; 

            let threshold = PROB_BASE;
            
            // Ajuste del umbral seg√∫n el factor de riesgo
            if (riskFactor === 1) { // Menos Riesgo (Eficientes)
                threshold = 0.55; // Se puede apostar con 55%
            } else if (riskFactor === -1) { // M√°s Riesgo (Ineficientes)
                threshold = 0.65; // Se necesita 65% o m√°s para apostar
            } else { // Neutro o un equipo eficiente/otro ineficiente
                threshold = PROB_BASE; // 60%
            }

            // Generar el Veredicto
            let finalVerdictText = "";
            if (probMax >= threshold) {
                finalVerdictText = "‚úÖ APOSTAR";
                verdictElement.className = 'bet';
            } else {
                finalVerdictText = "‚ùå DEJAR PASAR";
                verdictElement.className = 'pass';
            }
            
            // L√≥gica para mostrar el mercado m√°s probable en el veredicto
            if (finalVerdictText === "‚úÖ APOSTAR") {
                if (results.bttsYes >= results.over2_5) {
                    finalVerdictText += " (BTTS S√ç)";
                } else {
                    finalVerdictText += " (M√ÅS DE 2.5)";
                }
            }


            verdictElement.textContent = finalVerdictText;
        }

        // Ejecutar el c√°lculo al cargar la p√°gina con los valores por defecto
        document.addEventListener('DOMContentLoaded', calculateProbabilities);
    </script>
</body>
</html>

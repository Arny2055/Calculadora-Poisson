<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson HT Table Parser</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 1.5rem; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: monospace; font-size: 0.8rem; resize: none; box-sizing: border-box; }
        .controls { margin: 20px 0; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: end; }
        select, input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        button { grid-column: span 3; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        button:hover { background: #1d4ed8; }
        .results { margin-top: 25px; display: none; border-top: 2px solid #f1f5f9; padding-top: 20px; }
        .card-res { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
        .val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h1>Calculadora Poisson HT Automática</h1>
    
    <div class="grid">
        <div>
            <label>1. Pega Tabla LOCAL (Home)</label>
            <textarea id="rawHome" placeholder="Pega aquí la tabla AT HOME..."></textarea>
        </div>
        <div>
            <label>2. Pega Tabla VISITANTE (Away)</label>
            <textarea id="rawAway" placeholder="Pega aquí la tabla AWAY..."></textarea>
        </div>
    </div>

    <div class="controls">
        <div>
            <label>Equipo Local</label>
            <select id="selectHome"><option>Carga las tablas primero</option></select>
        </div>
        <div>
            <label>Equipo Visitante</label>
            <select id="selectAway"><option>Carga las tablas primero</option></select>
        </div>
        <div style="text-align: right;">
            <button type="button" onclick="parseTables()" style="grid-column: auto; background: #64748b; padding: 10px;">Cargar Equipos</button>
        </div>
        <button onclick="calculate()">Calcular Predicción 1er Tiempo</button>
    </div>

    <div id="resultArea" class="results">
        <div class="grid">
            <div class="card-res">
                <div>Prob. Over 0.5 HT</div>
                <div id="o05" class="val">-</div>
            </div>
            <div class="card-res">
                <div>Prob. Over 1.5 HT</div>
                <div id="o15" class="val">-</div>
            </div>
        </div>
    </div>
</div>

<script>
    let dbHome = {};
    let dbAway = {};

    function parseTables() {
        const textHome = document.getElementById('rawHome').value;
        const textAway = document.getElementById('rawAway').value;
        
        dbHome = processData(textHome);
        dbAway = processData(textAway);

        updateSelect('selectHome', dbHome);
        updateSelect('selectAway', dbAway);
        alert("Tablas procesadas. Ahora elige los equipos.");
    }

    function processData(text) {
        const lines = text.split('\n');
        const teams = {};
        lines.forEach(line => {
            // Regex para capturar: Nombre Equipo + GP + W + D + L + GF + GA
            const match = line.match(/([a-zA-Z\s]+?)\t?(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)/);
            if (match) {
                const name = match[1].trim();
                teams[name] = {
                    gp: parseInt(match[2]),
                    gf: parseInt(match[6]),
                    ga: parseInt(match[7])
                };
            }
        });
        return teams;
    }

    function updateSelect(id, data) {
        const sel = document.getElementById(id);
        sel.innerHTML = "";
        Object.keys(data).forEach(team => {
            let opt = document.createElement('option');
            opt.value = team;
            opt.innerText = team;
            sel.appendChild(opt);
        });
    }

    function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
    function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

    function calculate() {
        const homeName = document.getElementById('selectHome').value;
        const awayName = document.getElementById('selectAway').value;

        const home = dbHome[homeName];
        const away = dbAway[awayName];

        if (!home || !away) return alert("Selecciona equipos válidos");

        // Promedios
        const attackH = home.gf / home.gp;
        const defenseH = home.ga / home.gp;
        const attackA = away.gf / away.gp;
        const defenseA = away.ga / away.gp;

        // Lambdas (Expectativa de gol)
        const lambdaH = attackH * defenseA;
        const lambdaA = attackA * defenseH;

        // Poisson
        const p0H = poisson(0, lambdaH);
        const p0A = poisson(0, lambdaA);
        const p1H = poisson(1, lambdaH);
        const p1A = poisson(1, lambdaA);

        const prob00 = p0H * p0A;
        const over05 = (1 - prob00) * 100;
        
        const prob10 = p1H * p0A;
        const prob01 = p0H * p1A;
        const over15 = (1 - (prob00 + prob10 + prob01)) * 100;

        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('o05').innerText = over05.toFixed(2) + "%";
        document.getElementById('o15').innerText = over15.toFixed(2) + "%";
    }
</script>
</body>
</html>

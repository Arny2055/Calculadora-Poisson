<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OddAlerts — Calculadora avanzada (Poisson + Monte Carlo, Backtest)</title>

<!-- Fuentes y Chart.js -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#071026; --card:#0f1b2b; --muted:#94a3b8; --accent:#06b6d4;
    --glass: rgba(255,255,255,0.03); --success:#10b981; --danger:#ef4444;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#031024);color:#e6eef8;min-height:100vh;padding:18px}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .logo{width:54px;height:54px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0ea5a7);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021423}
  h1{margin:0;font-size:18px}
  .grid{display:grid;grid-template-columns:380px 1fr;gap:14px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.03)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:9px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
  .row{display:flex;gap:8px}
  .small{flex:1}
  button{background:var(--accent);border:none;padding:9px 12px;border-radius:8px;color:#021423;font-weight:700;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .metric{padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
  .metric h3{margin:0;font-size:12px;color:var(--muted)}
  .metric p{margin:6px 0 0;font-size:16px;font-weight:700}
  .good{color:var(--success);font-weight:800}
  .bad{color:var(--danger);font-weight:800}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  @media (max-width:980px){
    .grid{grid-template-columns:1fr}
    .charts{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">OA</div>
      <div>
        <h1>OddAlerts — Calculadora avanzada (Poisson + Monte Carlo, Backtest)</h1>
        <div class="muted">Motor Poisson+MC, backtest CSV, filtros, API template y visualizaciones.</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: inputs, Poisson, API, Backtest upload, filtros -->
      <div>
        <div class="card">
          <label>Partido / Mercado</label>
          <input id="matchInput" type="text" placeholder="Equipo A vs Equipo B — Mercado (p.ej. Over 2.5)">

          <div style="height:8px"></div>
          <label>Datos de equipos (media de goles)</label>
          <div class="row" style="margin-bottom:8px">
            <input id="homeGF" type="number" step="0.01" placeholder="Home GF avg" class="small">
            <input id="homeGA" type="number" step="0.01" placeholder="Home GA avg" class="small">
          </div>
          <div class="row" style="margin-bottom:8px">
            <input id="awayGF" type="number" step="0.01" placeholder="Away GF avg" class="small">
            <input id="awayGA" type="number" step="0.01" placeholder="Away GA avg" class="small">
          </div>

          <label>Ajustes (home/away attack/defense multipliers)</label>
          <div class="row" style="margin-bottom:8px">
            <input id="homeAttack" type="number" step="0.01" placeholder="Home attack (1.0)" class="small" value="1">
            <input id="awayAttack" type="number" step="0.01" placeholder="Away attack (1.0)" class="small" value="1">
          </div>

          <div class="row">
            <button id="estimateBtn">Generar probabilidades (Poisson + MC)</button>
            <button id="resetMC" style="background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)">Limpiar</button>
          </div>

          <div class="metrics" style="margin-top:10px">
            <div class="metric">
              <h3>Prob. 1 (local)</h3><p id="pHome">—</p>
            </div>
            <div class="metric">
              <h3>Prob. X (empate)</h3><p id="pDraw">—</p>
            </div>
            <div class="metric">
              <h3>Prob. 2 (visit)</h3><p id="pAway">—</p>
            </div>
            <div class="metric">
              <h3>Prob. Over 2.5</h3><p id="pOver">—</p>
            </div>
            <div class="metric" style="grid-column:1 / -1">
              <h3>Correct score top (3)</h3>
              <div id="topScores" style="margin-top:6px" class="muted">—</div>
            </div>
          </div>

          <div class="hint">El motor usa λ local = homeGF * awayGA * homeAttack, y λ visitante = awayGF * homeGA * awayAttack (puedes ajustar multiplicadores).</div>
        </div>

        <div class="card" style="margin-top:12px">
          <label>Odds del book (decimal)</label>
          <div class="row">
            <input id="oddsHome" type="number" step="0.001" placeholder="Home (ej 2.15)" class="small">
            <input id="oddsDraw" type="number" step="0.001" placeholder="Draw (ej 3.40)" class="small">
          </div>
          <div style="height:8px"></div>
          <div class="row">
            <input id="oddsAway" type="number" step="0.001" placeholder="Away (ej 3.10)" class="small">
            <input id="oddsOver" type="number" step="0.001" placeholder="Over 2.5 (ej 1.95)" class="small">
          </div>

          <div style="height:8px"></div>
          <label>Bankroll</label>
          <input id="bankroll" type="number" step="0.01" placeholder="Ej: 1000">

          <div style="height:8px"></div>
          <label>Opciones Kelly / Staking</label>
          <div class="row">
            <select id="kellyMode" class="small">
              <option value="full">Kelly completo</option>
              <option value="half">1/2 Kelly</option>
              <option value="quarter">1/4 Kelly</option>
            </select>
            <select id="stakeMode" class="small">
              <option value="currency">Mostrar stake en moneda</option>
              <option value="percent">Mostrar stake en % bankroll</option>
            </select>
          </div>

          <div class="controls">
            <button id="calcValue">Calcular Value/EV/Kelly</button>
            <button id="addToTracker" style="background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)">Agregar a tracker</button>
          </div>

          <div style="height:8px"></div>
          <div class="metrics">
            <div class="metric"><h3>Implied book (home)</h3><p id="implHome">—</p></div>
            <div class="metric"><h3>Fair odds (home)</h3><p id="fairHome">—</p></div>
            <div class="metric"><h3>Edge / EV (home)</h3><p id="evHome">—</p></div>
            <div class="metric"><h3>Kelly (home)</h3><p id="kellyHome">—</p></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <label>Filtros / Reglas automáticas</label>
          <div class="row" style="margin-bottom:8px">
            <input id="minOdds" type="number" step="0.01" placeholder="Min odds (ej 1.8)" class="small">
            <input id="maxOdds" type="number" step="0.01" placeholder="Max odds (ej 5.0)" class="small">
          </div>
          <div style="height:8px"></div>
          <label>Ligass / mercados permitidos (coma-sep)</label>
          <input id="allowedLeagues" placeholder="EPL,LaLiga,SerieA">

          <div class="hint">Las reglas pueden combinarse para filtrar las alertas automáticamente. Se aplican al añadir al tracker o al backtest.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <label>API / Odds en vivo (plantilla)</label>
          <input id="apiEndpoint" placeholder="Endpoint (p.ej. https://api.provider.com/odds)">
          <input id="apiKey" placeholder="API Key (ponla aquí)">

          <div class="row" style="margin-top:8px">
            <button id="testApi">Probar API (plantilla)</button>
            <button id="clearApi" style="background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)">Limpiar</button>
          </div>
          <div id="apiResult" class="muted" style="margin-top:8px">Resultado: —</div>

          <div class="hint">Pega tu endpoint + key. El script muestra cómo autenticar y parsear JSON (necesitas CORS y credenciales válidas).</div>
        </div>
      </div>

      <!-- RIGHT: Backtest, tracker, charts -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Backtest / Tracker</strong><div class="muted" style="font-size:13px">Sube CSV con columnas: date,match,market,league,stake,odds,result(win/lose),model_prob</div></div>
            <div>
              <input id="csvFile" type="file" accept=".csv">
            </div>
          </div>

          <div style="height:8px"></div>
          <div style="display:flex;gap:8px">
            <button id="loadCSV">Cargar CSV</button>
            <button id="downloadCSV" style="background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)">Descargar tracker</button>
            <button id="clearTracker" style="background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)">Limpiar tracker</button>
          </div>

          <div style="height:10px"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="metric" style="min-width:140px"><h3>Eventos</h3><p id="m_count">0</p></div>
            <div class="metric" style="min-width:140px"><h3>ROI</h3><p id="m_roi">—</p></div>
            <div class="metric" style="min-width:140px"><h3>P&L</h3><p id="m_pnl">—</p></div>
            <div class="metric" style="min-width:140px"><h3>Max Drawdown</h3><p id="m_dd">—</p></div>
          </div>

          <div style="height:10px"></div>
          <div style="max-height:260px;overflow:auto;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
            <table id="trackerTable">
              <thead><tr><th>#</th><th>Fecha</th><th>Match</th><th>Market</th><th>Odds</th><th>Stake</th><th>Result</th><th>P&L</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="charts">
            <canvas id="pnlChart"></canvas>
            <canvas id="evChart"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Conversor de cuotas y utilidades</strong>
          <div style="height:8px"></div>
          <div class="row">
            <input id="convOdds" placeholder="Decimal (ej 2.15)">
            <button id="convBtn">Convertir</button>
          </div>
          <div style="display:flex;gap:12px;margin-top:8px">
            <div style="flex:1"><div class="muted">Fraccional</div><div id="convFrac" style="font-weight:700">—</div></div>
            <div style="flex:1"><div class="muted">Americana</div><div id="convAm" style="font-weight:700">—</div></div>
            <div style="flex:1"><div class="muted">Implied %</div><div id="convImp" style="font-weight:700">—</div></div>
          </div>

          <div style="height:8px"></div>
          <div class="hint">Guardado automático de configuración en tu navegador.</div>
        </div>
      </div>
    </div>

    <footer style="margin-top:12px" class="muted">Hecho para integrarse con Poisson/Monte Carlo y APIs. ¿Quieres que lo adapte para tu CSV real (muestra) o que lo conecte a la API de OddAlerts cuando tengas la key?</footer>
  </div>

<script>
/* ======================
   UTILIDADES BÁSICAS
   ====================== */
function toNum(v){ const n = parseFloat(v); return isNaN(n)?null:n; }
function fmt(n, d=2){ if (n===null || n===undefined || isNaN(n)) return '—'; return Number(n).toFixed(d); }
function pct(n,d=2){ if (n===null || n===undefined || isNaN(n)) return '—'; return (n*100).toFixed(d) + '%'; }

/* ======================
   POISSON + MONTE CARLO
   ====================== */
/* Diseño sencillo:
   - λ_home = homeGF * awayGA * homeAttack
   - λ_away = awayGF * homeGA * awayAttack
   - Simulaciones: N iteraciones (por defecto 50000) simulando goles ~ Poisson(λ)
   - Calculamos prob 1,X,2 ; Over2.5 ; BTTS ; top correct scores
*/
function samplePoisson(lambda){
  // Knuth's algorithm
  let L = Math.exp(-lambda), k = 0, p = 1;
  do {
    k++;
    p *= Math.random();
  } while (p > L);
  return k - 1;
}

function runMonteCarlo(lambdaH, lambdaA, iters=50000, maxGoalsConsider=7){
  const counts = {homeWins:0,draws:0,awayWins:0,over25:0, btts:0, scoreCounts:{}};
  for (let i=0;i<iters;i++){
    // generate goals; cap improbable large values
    const gh = samplePoisson(lambdaH);
    const ga = samplePoisson(lambdaA);
    // record result
    if (gh > ga) counts.homeWins++;
    else if (gh === ga) counts.draws++;
    else counts.awayWins++;
    if ((gh + ga) > 2) counts.over25++;
    if (gh > 0 && ga > 0) counts.btts++;
    const key = `${gh}-${ga}`;
    counts.scoreCounts[key] = (counts.scoreCounts[key] || 0) + 1;
  }
  // compute probs
  const pHome = counts.homeWins / iters;
  const pDraw = counts.draws / iters;
  const pAway = counts.awayWins / iters;
  const pOver = counts.over25 / iters;
  const pBTTS = counts.btts / iters;
  // top 3 scores by frequency
  const entries = Object.entries(counts.scoreCounts).map(([k,v])=>({k, v: v/iters})).sort((a,b)=>b.v-a.v).slice(0,6);
  return {pHome,pDraw,pAway,pOver,pBTTS, scoreDist:entries};
}

/* ======================
   VALUE / EV / KELLY
   ====================== */
function calcValue(p, odds){
  // p: model prob (0..1); odds decimal
  const implied = 1 / odds;
  const fairOdds = 1 / p;
  const ev = odds * p - 1; // EV per unit stake
  const b = odds - 1;
  const q = 1 - p;
  let kelly = (b * p - q) / b;
  if (!isFinite(kelly)) kelly = 0;
  return {implied, fairOdds, ev, kelly};
}

/* ======================
   ELEMENTS DOM
   ====================== */
const homeGF = document.getElementById('homeGF');
const homeGA = document.getElementById('homeGA');
const awayGF = document.getElementById('awayGF');
const awayGA = document.getElementById('awayGA');
const homeAttack = document.getElementById('homeAttack');
const awayAttack = document.getElementById('awayAttack');
const estimateBtn = document.getElementById('estimateBtn');
const resetMC = document.getElementById('resetMC');

const pHomeEl = document.getElementById('pHome');
const pDrawEl = document.getElementById('pDraw');
const pAwayEl = document.getElementById('pAway');
const pOverEl = document.getElementById('pOver');
const topScoresEl = document.getElementById('topScores');

estimateBtn.addEventListener('click', ()=> {
  // read inputs
  const hGF = toNum(homeGF.value);
  const hGA = toNum(homeGA.value);
  const aGF = toNum(awayGF.value);
  const aGA = toNum(awayGA.value);
  const hAtk = toNum(homeAttack.value) || 1;
  const aAtk = toNum(awayAttack.value) || 1;
  if ([hGF,hGA,aGF,aGA].some(x=>x===null)){ alert('Introduce las medias de goles (GF/GA) para ambos equipos'); return; }
  const lambdaH = hGF * aGA * hAtk;
  const lambdaA = aGF * hGA * aAtk;

  // run Monte Carlo (async-ish)
  estimateBtn.disabled = true; estimateBtn.textContent = 'Simulando...';
  setTimeout(()=>{ // avoid blocking UI
    const res = runMonteCarlo(lambdaH, lambdaA, 40000);
    pHomeEl.textContent = pct(res.pHome,3);
    pDrawEl.textContent = pct(res.pDraw,3);
    pAwayEl.textContent = pct(res.pAway,3);
    pOverEl.textContent = pct(res.pOver,3);
    topScoresEl.innerHTML = res.scoreDist.map(s=>`${s.k} (${(s.v*100).toFixed(2)}%)`).join(' — ');
    // store last model probabilities to use in valuation
    window._lastModel = {home:res.pHome, draw:res.pDraw, away:res.pAway, over:res.pOver, scoreDist:res.scoreDist};
    estimateBtn.disabled=false; estimateBtn.textContent='Generar probabilidades (Poisson + MC)';
    saveSettings();
  }, 10);
});

resetMC.addEventListener('click', ()=>{
  [homeGF,homeGA,awayGF,awayGA].forEach(i=>i.value=''); [pHomeEl,pDrawEl,pAwayEl,pOverEl,topScoresEl].forEach(e=>e.textContent='—'); window._lastModel = null;
});

/* ======================
   CALC VALUE & ADD TRACKER
   ====================== */
const oddsHome = document.getElementById('oddsHome');
const oddsDraw = document.getElementById('oddsDraw');
const oddsAway = document.getElementById('oddsAway');
const oddsOver = document.getElementById('oddsOver');
const bankrollEl = document.getElementById('bankroll');
const kellyMode = document.getElementById('kellyMode');
const stakeMode = document.getElementById('stakeMode');

const implHome = document.getElementById('implHome');
const fairHome = document.getElementById('fairHome');
const evHome = document.getElementById('evHome');
const kellyHome = document.getElementById('kellyHome');

const calcValueBtn = document.getElementById('calcValue');
const addToTrackerBtn = document.getElementById('addToTracker');

calcValueBtn.addEventListener('click', ()=>{
  if (!window._lastModel){ alert('Genera primero la probabilidad con Poisson+MC (botón Generar probabilidades).'); return; }
  // Example: evaluate home market
  const p = window._lastModel.home;
  const odds = toNum(oddsHome.value);
  if (!odds || odds <= 1){ alert('Introduce una cuota decimal válida para el mercado (home).'); return; }
  const {implied,fairOdds,ev,kelly} = calcValue(p, odds);
  implHome.textContent = pct(implied,3);
  fairHome.textContent = fmt(fairOdds,4);
  evHome.textContent = (ev*100).toFixed(3) + '%';
  // apply fraction
  const frac = kellyMode.value === 'full' ? 1 : (kellyMode.value === 'half' ? 0.5 : 0.25);
  const kAdj = Math.max(0, kelly) * frac;
  kellyHome.textContent = (kelly*100).toFixed(3) + '% → ' + (kAdj*100).toFixed(3) + '% aplic.';
});

/* ======================
   TRACKER & BACKTEST (CSV)
   ====================== */
// tracker array stores objects: {date,match,market,league,odds,stake,result,model_prob}
let tracker = JSON.parse(localStorage.getItem('oa_tracker_v1') || '[]');

const trackerTableBody = document.querySelector('#trackerTable tbody');
const m_count = document.getElementById('m_count');
const m_roi = document.getElementById('m_roi');
const m_pnl = document.getElementById('m_pnl');
const m_dd = document.getElementById('m_dd');

function renderTracker(){
  trackerTableBody.innerHTML = '';
  let cum = 0;
  const cumArr = [];
  tracker.forEach((t,i)=>{
    const pnl = t.result.toLowerCase() === 'win' ? (t.odds * t.stake - t.stake) : -t.stake;
    cum += pnl;
    cumArr.push(cum);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${t.date||''}</td><td>${t.match||''}</td><td>${t.market||''}</td><td>${fmt(t.odds,3)}</td><td>${fmt(t.stake,2)}</td><td>${t.result}</td><td>${fmt(pnl,2)}</td>`;
    trackerTableBody.appendChild(tr);
  });
  // metrics
  const totalStake = tracker.reduce((s,t)=>s + (t.stake || 0), 0);
  const totalPnL = cum;
  const roi = totalStake > 0 ? totalPnL / totalStake : 0;
  const maxDD = calcMaxDrawdown(cumArr);
  m_count.textContent = tracker.length;
  m_roi.textContent = (totalStake>0 ? (roi*100).toFixed(2) + '%' : '—');
  m_pnl.textContent = fmt(totalPnL,2);
  m_dd.textContent = fmt(maxDD,2);
  saveTracker();
  updateCharts();
}

function calcMaxDrawdown(cumArr){
  if (!cumArr.length) return 0;
  let peak = cumArr[0], maxDD = 0;
  for (let v of cumArr){
    if (v > peak) peak = v;
    const dd = peak - v;
    if (dd > maxDD) maxDD = dd;
  }
  return maxDD;
}

// add to tracker from UI (using home market as example)
addToTrackerBtn.addEventListener('click', ()=>{
  const match = document.getElementById('matchInput').value || 'manual';
  const market = '1X2 - Home';
  const league = (document.getElementById('allowedLeagues').value || '').split(',')[0] || '';
  const odds = toNum(oddsHome.value);
  const bank = toNum(bankrollEl.value) || 0;
  // stake from kelly suggestion
  if (!window._lastModel){ alert('Genera la probabilidad primero.'); return; }
  if (!odds){ alert('Introduce la cuota (home).'); return; }
  const p = window._lastModel.home;
  const {kelly} = calcValue(p, odds);
  const frac = kellyMode.value === 'full' ? 1 : (kellyMode.value === 'half' ? 0.5 : 0.25);
  const kAdj = Math.max(0, kelly) * frac;
  const stakeCurrency = bank * kAdj;
  const stake = stakeCurrency > 0 ? Number(stakeCurrency.toFixed(2)) : Number((Math.max(0.01, (kAdj*100)/100)).toFixed(2)); // fallback small stake
  // push a provisional entry with unknown result
  tracker.push({date: new Date().toISOString().slice(0,10), match, market, league, odds, stake, result: 'open', model_prob: p});
  renderTracker();
});

// CSV upload parsing (simple CSV parser)
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  const headers = lines[0].split(',').map(h=>h.trim());
  const rows = lines.slice(1).map(l=>{
    const cols = l.split(',').map(c=>c.trim());
    const obj = {};
    headers.forEach((h,i)=> obj[h]=cols[i]||'');
    return obj;
  });
  return rows;
}

const csvFile = document.getElementById('csvFile');
const loadCSV = document.getElementById('loadCSV');
const downloadCSV = document.getElementById('downloadCSV');
const clearTracker = document.getElementById('clearTracker');

loadCSV.addEventListener('click', ()=>{
  const f = csvFile.files[0];
  if (!f){ alert('Selecciona un archivo CSV.'); return; }
  const reader = new FileReader();
  reader.onload = (e)=>{
    try {
      const rows = parseCSV(e.target.result);
      // standardize rows with expected fields; convert numeric types
      rows.forEach(r=>{
        // expected fields: date,match,market,league,stake,odds,result,model_prob
        const rec = {
          date: r.date || r.Date || new Date().toISOString().slice(0,10),
          match: r.match || r.Match || r.home_vs_away || '',
          market: r.market || r.Market || '',
          league: r.league || r.League || '',
          stake: Number(r.stake || r.Stake || 0),
          odds: Number(r.odds || r.Odds || 0),
          result: (r.result || r.Result || '').toLowerCase(),
          model_prob: Number(r.model_prob || r.modelProb || 0)
        };
        // Accept only if odds and stake present
        if (!isNaN(rec.odds) && !isNaN(rec.stake)) tracker.push(rec);
      });
      renderTracker();
      alert('CSV cargado: ' + rows.length + ' filas procesadas.');
    } catch(err){ alert('Error al parsear CSV: ' + err.message); }
  };
  reader.readAsText(f);
});

downloadCSV.addEventListener('click', ()=>{
  if (!tracker.length){ alert('Tracker vacío.'); return; }
  const headers = ['date','match','market','league','stake','odds','result','model_prob'];
  const csv = [headers.join(',')].concat(tracker.map(t => headers.map(h=> (t[h]===undefined?'':String(t[h]).replace(/,/g,' '))).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'oa_tracker.csv'; a.click();
  URL.revokeObjectURL(url);
});

clearTracker.addEventListener('click', ()=>{
  if (!confirm('Limpiar tracker? Esta acción no se puede deshacer.')) return;
  tracker = []; renderTracker();
});

/* ======================
   STORAGE
   ====================== */
function saveTracker(){ localStorage.setItem('oa_tracker_v1', JSON.stringify(tracker)); }
function saveSettings(){
  const s = {
    homeAttack: homeAttack.value, awayAttack: awayAttack.value,
    minOdds: document.getElementById('minOdds').value,
    maxOdds: document.getElementById('maxOdds').value,
    allowedLeagues: document.getElementById('allowedLeagues').value,
    apiEndpoint: document.getElementById('apiEndpoint').value
  };
  localStorage.setItem('oa_settings_v1', JSON.stringify(s));
}
function loadSettings(){
  const s = JSON.parse(localStorage.getItem('oa_settings_v1') || '{}');
  if (s.homeAttack) homeAttack.value = s.homeAttack;
  if (s.awayAttack) awayAttack.value = s.awayAttack;
  if (s.minOdds) document.getElementById('minOdds').value = s.minOdds;
  if (s.maxOdds) document.getElementById('maxOdds').value = s.maxOdds;
  if (s.allowedLeagues) document.getElementById('allowedLeagues').value = s.allowedLeagues;
  if (s.apiEndpoint) document.getElementById('apiEndpoint').value = s.apiEndpoint;
}

/* ======================
   API TEMPLATE (no call by default)
   ====================== */
const apiEndpoint = document.getElementById('apiEndpoint');
const apiKey = document.getElementById('apiKey');
const testApi = document.getElementById('testApi');
const apiResult = document.getElementById('apiResult');

testApi.addEventListener('click', async ()=>{
  const url = apiEndpoint.value;
  const key = apiKey.value;
  if (!url || !key){ alert('Pega endpoint y API key.'); return; }
  apiResult.textContent = 'Probando... (esto es plantilla; necesita CORS en el endpoint)';
  try {
    // Ejemplo de fetch (cabeza): Authorization bearer o header x-api-key
    const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' }});
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const json = await res.json();
    apiResult.textContent = 'OK — respuesta recibida (ver consola).';
    console.log('API response', json);
    // Aquí puedes parsear json y poblar odds/probs según la estructura real.
  } catch(err){
    apiResult.textContent = 'Error: ' + err.message;
  }
});

/* ======================
   CONVERSOR DE CUOTAS
   ====================== */
const convOdds = document.getElementById('convOdds');
const convBtn = document.getElementById('convBtn');
const convFrac = document.getElementById('convFrac');
const convAm = document.getElementById('convAm');
const convImp = document.getElementById('convImp');

function toFraction(x, maxDen=1000){
  // simple continued fraction approximation
  let best = {n:1,d:1,err:Math.abs(x-1)};
  for (let q=1;q<=maxDen;q++){
    const p = Math.round((x-1)*q);
    const err = Math.abs((x-1) - p/q);
    if (err < best.err){ best = {n:p,d:q,err}; if (err === 0) break; }
  }
  const g = (a,b)=>b?g(b,a%b):a;
  const gg = g(best.n,best.d) || 1;
  return `${best.n/gg}/${best.d/gg}`;
}

convBtn.addEventListener('click', ()=>{
  const d = toNum(convOdds.value);
  if (!d || d <= 1){ alert('Introduce una cuota decimal válida (>1).'); return; }
  convFrac.textContent = toFraction(d);
  convImp.textContent = pct(1/d,3);
  let am;
  if (d >= 2) am = '+' + Math.round((d-1)*100);
  else am = '-' + Math.round(100 / (d - 1));
  convAm.textContent = am;
});

/* ======================
   CHARTS
   ====================== */
let pnlChart = null, evChart = null;
function updateCharts(){
  // PNL acumulado
  const labels = tracker.map((t,i)=>i+1);
  let cum = 0; const cumArr = [];
  const pnlArr = tracker.map(t=>{
    const pnl = (t.result.toLowerCase()==='win') ? (t.odds * t.stake - t.stake) : (t.result.toLowerCase()==='lose' ? -t.stake : 0);
    cum += pnl; cumArr.push(cum);
    return pnl;
  });

  if (!pnlChart){
    const ctx = document.getElementById('pnlChart').getContext('2d');
    pnlChart = new Chart(ctx, {
      type: 'line', data: { labels, datasets: [{ label: 'PNL acumulado', data: cumArr, fill:false, tension:0.25 }]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  } else {
    pnlChart.data.labels = labels;
    pnlChart.data.datasets[0].data = cumArr;
    pnlChart.update();
  }

  // EV distribution: compute mean EV per bet if model_prob present
  const evs = tracker.map(t => (t.model_prob ? (t.model_prob * t.odds - 1) * t.stake : 0));
  if (!evChart){
    const ctx2 = document.getElementById('evChart').getContext('2d');
    evChart = new Chart(ctx2, {
      type: 'bar', data: { labels: tracker.map((t,i)=>i+1), datasets:[{label:'EV por apuesta', data:evs}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  } else {
    evChart.data.labels = tracker.map((t,i)=>i+1);
    evChart.data.datasets[0].data = evs;
    evChart.update();
  }
}

/* ======================
   INIT: load settings & tracker
   ====================== */
loadSettings();
renderTracker();

/* Save settings on unload */
window.addEventListener('beforeunload', ()=> saveSettings());

</script>
</body>
</html>
// Variable global para almacenar los datos cargados del JSON
let matchHistory = [];

document.getElementById('jsonFile').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // Guarda los datos en la variable global
                matchHistory = JSON.parse(e.target.result);
                console.log("Datos cargados correctamente:", matchHistory.length, "partidos.");
            } catch (error) {
                alert("Error al parsear el archivo JSON. Aseg칰rate de que el formato sea correcto.");
                console.error(error);
            }
        };
        reader.readAsText(file);
    }
});

function analyzeData() {
    const localTeam = document.getElementById('localTeam').value.trim();
    const visitorTeam = document.getElementById('visitorTeam').value.trim();

    // 1. Validaciones
    if (!matchHistory.length) {
        alert("Primero debes cargar el archivo JSON con el historial de partidos.");
        return;
    }
    if (!localTeam || !visitorTeam) {
        alert("Por favor, ingresa el nombre del equipo Local y Visitante.");
        return;
    }

    // 2. Filtrar partidos relevantes
    // Obtenemos los partidos donde particip칩 el local o el visitante.
    const relevantMatches = matchHistory.filter(match =>
        (match.local.toLowerCase() === localTeam.toLowerCase() || match.visitante.toLowerCase() === localTeam.toLowerCase()) ||
        (match.local.toLowerCase() === visitorTeam.toLowerCase() || match.visitante.toLowerCase() === visitorTeam.toLowerCase())
    );

    if (relevantMatches.length === 0) {
        document.getElementById('prob25').textContent = "N/A";
        document.getElementById('probBTTS').textContent = "N/A";
        document.getElementById('personalAnalysis').textContent = "No se encontraron partidos en el historial para los equipos ingresados. No se puede realizar el an치lisis.";
        document.getElementById('results').style.display = 'block';
        return;
    }

    // --- 3. C치lculo de Probabilidades ---
    let countOver25 = 0;
    let countBTTS = 0;
    let totalMatchesForAnalysis = relevantMatches.length;

    // M칠tricas para el an치lisis personal
    let localScored = 0;
    let visitorScored = 0;
    let localConceded = 0;
    let visitorConceded = 0;
    
    // Total de goles esperados/promedio
    let totalGoals = 0;

    relevantMatches.forEach(match => {
        // Aseg칰rate de que los nombres de las propiedades coincidan con tu JSON
        const G_local = parseInt(match.golesLocal || 0); 
        const G_visitor = parseInt(match.golesVisitante || 0);

        // a) M치s de 2.5 Goles
        const totalGoles = G_local + G_visitor;
        if (totalGoles > 2.5) {
            countOver25++;
        }
        totalGoals += totalGoles;

        // b) Ambos Anotan (BTTS: Both Teams To Score)
        if (G_local > 0 && G_visitor > 0) {
            countBTTS++;
        }

        // c) M칠tricas por equipo
        // Si el partido involucra al equipo local del an치lisis
        if (match.local.toLowerCase() === localTeam.toLowerCase()) {
            localScored += G_local;
            localConceded += G_visitor;
        } else if (match.visitante.toLowerCase() === localTeam.toLowerCase()) {
            localScored += G_visitor;
            localConceded += G_local;
        }

        // Si el partido involucra al equipo visitante del an치lisis
        if (match.local.toLowerCase() === visitorTeam.toLowerCase()) {
            visitorScored += G_local;
            visitorConceded += G_visitor;
        } else if (match.visitante.toLowerCase() === visitorTeam.toLowerCase()) {
            visitorScored += G_visitor;
            visitorConceded += G_local;
        }
    });

    // Calcular promedios
    const probOver25 = (countOver25 / totalMatchesForAnalysis) * 100;
    const probBTTS = (countBTTS / totalMatchesForAnalysis) * 100;
    
    const avgGoals = (totalGoals / totalMatchesForAnalysis).toFixed(2);
    
    // El n칰mero de partidos para calcular los promedios de ataque/defensa es distinto. 
    // Para simplificar, calcularemos un 칤ndice general sobre el total de partidos relevantes
    // (Esto puede mejorarse usando solo los partidos donde el equipo es Local/Visitante).
    const localAttackIndex = (localScored / totalMatchesForAnalysis).toFixed(2);
    const visitorAttackIndex = (visitorScored / totalMatchesForAnalysis).toFixed(2);
    const localDefenseIndex = (localConceded / totalMatchesForAnalysis).toFixed(2);
    const visitorDefenseIndex = (visitorConceded / totalMatchesForAnalysis).toFixed(2);


    // --- 4. Mostrar Resultados ---
    document.getElementById('prob25').textContent = `${probOver25.toFixed(2)}% (${countOver25} de ${totalMatchesForAnalysis} partidos)`;
    document.getElementById('probBTTS').textContent = `${probBTTS.toFixed(2)}% (${countBTTS} de ${totalMatchesForAnalysis} partidos)`;
    document.getElementById('results').style.display = 'block';

    // --- 5. An치lisis Personalizado (Deducci칩n) ---
    const analysisText = generatePersonalAnalysis(localTeam, visitorTeam, probOver25, probBTTS, avgGoals, localAttackIndex, visitorAttackIndex, localDefenseIndex, visitorDefenseIndex);
    document.getElementById('personalAnalysis').innerHTML = analysisText;
}

/**
 * Genera un an치lisis y deducci칩n personalizada.
 * @param {string} localTeam - Nombre del equipo local.
 * @param {string} visitorTeam - Nombre del equipo visitante.
 * @param {number} p25 - Probabilidad de M치s de 2.5 Goles.
 * @param {number} pBTTS - Probabilidad de Ambos Anotan.
 * @param {number} avgG - Promedio de goles total.
 * @param {number} laI - 칈ndice de ataque del local.
 * @param {number} vaI - 칈ndice de ataque del visitante.
 * @param {number} ldI - 칈ndice de defensa del local.
 * @param {number} vdI - 칈ndice de defensa del visitante.
 * @returns {string} El texto del an치lisis.
 */
function generatePersonalAnalysis(localTeam, visitorTeam, p25, pBTTS, avgG, laI, vaI, ldI, vdI) {
    let analysis = "";

    // An치lisis de Goles Totales (M치s de 2.5)
    analysis += `**游꿢 Sobre el Total de Goles (M치s de 2.5):**<br>`;
    if (p25 >= 70) {
        analysis += `Dado que la probabilidad hist칩rica de un M치s de 2.5 es alta (**${p25.toFixed(0)}%**), y el promedio de goles por partido analizado es de **${avgG}**, todo indica que ser치 un partido con un **marcador abultado**. Ambos equipos tienen tendencias ofensivas que hist칩ricamente suelen superar la l칤nea.<br><br>`;
    } else if (p25 >= 50) {
        analysis += `La probabilidad de M치s de 2.5 Goles est치 en un rango moderado (**${p25.toFixed(0)}%**). Es un 50/50, lo que sugiere que podr칤a definirse por un gol de diferencia (2-1 o 1-2). El promedio de **${avgG}** goles es prometedor, pero hay un riesgo considerable de un marcador bajo (1-0 o 1-1).<br><br>`;
    } else {
        analysis += `La probabilidad de M치s de 2.5 Goles es baja (**${p25.toFixed(0)}%**), con un promedio de **${avgG}** goles por partido. Parece que el partido tender치 al **Menos de 2.5 Goles**. Esto puede deberse a defensas s칩lidas o ataques poco contundentes en los historiales.<br><br>`;
    }

    // An치lisis de Ambos Anotan (BTTS)
    analysis += `**游뱋 Sobre Ambos Anotan (BTTS):**<br>`;
    if (pBTTS >= 70) {
        analysis += `Una probabilidad tan alta (**${pBTTS.toFixed(0)}%**) de BTTS sugiere que **ambos equipos son muy propensos a marcar**. El 칤ndice de ataque del local (${laI}) y del visitante (${vaI}) parecen superar el 칤ndice de defensa del rival, lo que hace muy probable que el marcador se abra por ambos lados.<br><br>`;
    } else if (pBTTS >= 50) {
        analysis += `La probabilidad moderada de BTTS (**${pBTTS.toFixed(0)}%**) indica que, aunque tienen potencial ofensivo, uno de los dos equipos suele mantener la porter칤a a cero con frecuencia. Hay que ver si **${localTeam}** (${laI} goles marcados) logra superar a la defensa de **${visitorTeam}** (${vdI} goles encajados).<br><br>`;
    } else {
        analysis += `La baja probabilidad de BTTS (**${pBTTS.toFixed(0)}%**) sugiere que la defensa o el portero de al menos un equipo es excepcionalmente s칩lido, o uno de los ataques es muy d칠bil. La tendencia es que **solo un equipo (o ninguno) marque**.<br><br>`;
    }

    // Deducci칩n Final
    analysis += `**游눠 Deducci칩n Final del Analista:**<br>`;
    if (p25 >= 60 && pBTTS >= 60) {
        analysis += `**춰Recomendaci칩n Ofensiva!** La combinaci칩n de alta probabilidad en ambas m칠tricas apunta a un **espect치culo de goles** donde ambos equipos marcar치n (Ej: 2-1, 2-2, 3-1). El historial nos dice que ambos suelen conceder y anotar.<br>`;
    } else if (p25 < 50 && pBTTS < 50) {
        analysis += `**춰Recomendaci칩n Defensiva!** Ambas probabilidades son bajas. Esto sugiere un partido muy cerrado, t치ctico y con pocas ocasiones. Es muy probable un **Menos de 2.5 Goles** y que **solo un equipo gane por la m칤nima** (Ej: 1-0).<br>`;
    } else if (p25 >= 60 && pBTTS < 50) {
        analysis += `**춰Cuidado con la Paliza!** Una alta probabilidad de M치s de 2.5 y una baja de BTTS es la se침al cl치sica de una **goleada unilateral** (Ej: 3-0, 4-0). El equipo con mejor 칤ndice de ataque probablemente anote mucho, mientras que el otro se quedar치 en blanco.<br>`;
    } else {
        analysis += `**춰Partido Incierto!** Las probabilidades est치n divididas, con una m칠trica alta y otra baja. Se recomienda un an치lisis m치s profundo en la **condici칩n de local/visitante** y la **forma reciente** de ambos equipos para tomar una decisi칩n final.<br>`;
    }
    
    return analysis;
}


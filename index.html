<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Poisson - Goles Esperados</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        h2 { color: #28a745; margin-top: 25px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="file"], select, button { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .result-table, .prob-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td, .prob-table th, .prob-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .result-table th { background-color: #e9ecef; }
        .error { color: #dc3545; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>⚽ Calculadora de Goles Esperados (Poisson)</h1>

    <h2>1. Carga de Datos de la Liga</h2>
    <p>Carga tu tabla de datos. **Debe ser un archivo CSV** (separado por comas o punto y coma) con columnas con estos títulos exactos: `Equipo`, `Prom. Goles locales Anotados`, `Prom. Goles locales Lanzados`, `Prom. Goles visitante Anotados`, `Prom. Goles visitante Lanzados`.</p>
    <input type="file" id="data-file" accept=".csv" onchange="loadData()">
    <p id="data-status" class="error">¡Aún no se ha cargado la tabla!</p>

    <h2>2. Seleccionar Partido</h2>
    <div class="grid">
        <div>
            <label for="local-team">Equipo Local</label>
            <select id="local-team" disabled>
                <option value="">Selecciona un equipo</option>
            </select>
        </div>
        <div>
            <label for="visitor-team">Equipo Visitante</label>
            <select id="visitor-team" disabled>
                <option value="">Selecciona un equipo</option>
            </select>
        </div>
    </div>
    <button onclick="calculateExpectedGoals()">Calcular Goles Esperados</button>
    <p id="calculation-error" class="error"></p>

    <div id="results" style="display: none;">
        <h2>3. Resultados del Partido</h2>
        
        <table class="result-table">
            <thead>
                <tr><th>Equipo</th><th>Factor Ataque</th><th>Factor Defensa</th><th>$\lambda$ (Goles Esperados)</th></tr>
            </thead>
            <tbody id="lambda-results">
            </tbody>
        </table>

        <table class="prob-table">
            <thead>
                <tr><th>Resultado</th><th>Probabilidad</th></tr>
            </thead>
            <tbody id="outcome-probabilities">
            </tbody>
        </table>

        <h3>Probabilidad de Marcador Exacto (Top 5)</h3>
        <table class="prob-table">
            <thead>
                <tr><th>Marcador</th><th>Probabilidad</th></tr>
            </thead>
            <tbody id="score-probabilities">
            </tbody>
        </table>
    </div>
</div>

<script>
    let leagueData = [];
    let GL_prom = 0; // Promedio Goles Local de la Liga
    let GV_prom = 0; // Promedio Goles Visitante de la Liga

    // Función para cargar y parsear el archivo CSV
    function loadData() {
        const file = document.getElementById('data-file').files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const text = e.target.result;
                // Intentar detectar el separador (coma o punto y coma)
                const separator = text.includes(';') ? ';' : ','; 
                
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].trim().split(separator).map(h => h.trim());
                
                // Definir los nombres de columna necesarios
                const requiredHeaders = [
                    'Equipo',
                    'Prom. Goles locales Anotados',
                    'Prom. Goles locales Lanzados', // Usado para Recibidos local
                    'Prom. Goles visitante Anotados',
                    'Prom. Goles visitante Lanzados' // Usado para Recibidos visitante
                ];

                if (!requiredHeaders.every(h => headers.includes(h))) {
                    document.getElementById('data-status').textContent = 'Error: El archivo CSV debe contener las columnas: ' + requiredHeaders.join(', ');
                    return;
                }

                // Parsear los datos del equipo
                leagueData = lines.slice(1).map(line => {
                    const values = line.split(separator).map(v => v.trim());
                    let team = {};
                    headers.forEach((header, i) => {
                        if (header === 'Equipo') {
                            team[header] = values[i];
                        } else {
                            // Convertir valores numéricos a float, manejando posibles comas decimales
                            team[header] = parseFloat(values[i].replace(',', '.')) || 0;
                        }
                    });
                    return team;
                });

                if (leagueData.length === 0) {
                     document.getElementById('data-status').textContent = 'Error: No se encontraron datos válidos en la tabla.';
                     return;
                }

                calculateLeagueAverages();
                populateTeamSelectors();

                document.getElementById('data-status').textContent = `✅ Datos cargados correctamente. ${leagueData.length} equipos analizados.`;
            } catch (error) {
                document.getElementById('data-status').textContent = `Error al procesar el archivo: ${error.message}`;
                console.error(error);
            }
        };
        reader.readAsText(file);
    }

    // Función para calcular los promedios base de la liga
    function calculateLeagueAverages() {
        const totalTeams = leagueData.length;
        if (totalTeams === 0) return;

        let sumGLA = 0; // Suma Goles Locales Anotados
        let sumGVA = 0; // Suma Goles Visitantes Anotados

        leagueData.forEach(team => {
            sumGLA += team['Prom. Goles locales Anotados'];
            sumGVA += team['Prom. Goles visitante Anotados'];
        });

        GL_prom = sumGLA / totalTeams;
        GV_prom = sumGVA / totalTeams;
    }

    // Función para llenar los selectores de equipo
    function populateTeamSelectors() {
        const localSelect = document.getElementById('local-team');
        const visitorSelect = document.getElementById('visitor-team');

        [localSelect, visitorSelect].forEach(select => {
            select.innerHTML = '<option value="">Selecciona un equipo</option>';
            leagueData.forEach(team => {
                const option = document.createElement('option');
                option.value = team.Equipo;
                option.textContent = team.Equipo;
                select.appendChild(option);
            });
            select.disabled = false;
        });
    }

    // Función principal para la calculadora
    function calculateExpectedGoals() {
        const localTeamName = document.getElementById('local-team').value;
        const visitorTeamName = document.getElementById('visitor-team').value;
        const errorElement = document.getElementById('calculation-error');
        const resultsDiv = document.getElementById('results');

        if (!localTeamName || !visitorTeamName) {
            errorElement.textContent = 'Por favor, selecciona ambos equipos.';
            resultsDiv.style.display = 'none';
            return;
        }

        if (localTeamName === visitorTeamName) {
            errorElement.textContent = 'El equipo local y el visitante deben ser diferentes.';
            resultsDiv.style.display = 'none';
            return;
        }

        errorElement.textContent = '';

        const localTeam = leagueData.find(t => t.Equipo === localTeamName);
        const visitorTeam = leagueData.find(t => t.Equipo === visitorTeamName);

        // --- 1. Cálculo de Factores de Fuerza (Índices) ---

        // Ataque Local: Prom. Goles locales Anotados / GL_prom
        const GF_l = localTeam['Prom. Goles locales Anotados'] / GL_prom; 
        
        // Defensa Visitante: Prom. Goles visitante Lanzados / GL_prom
        const GC_v = visitorTeam['Prom. Goles visitante Lanzados'] / GL_prom;

        // Ataque Visitante: Prom. Goles visitante Anotados / GV_prom
        const GF_v = visitorTeam['Prom. Goles visitante Anotados'] / GV_prom;

        // Defensa Local: Prom. Goles locales Lanzados / GV_prom
        const GC_l = localTeam['Prom. Goles locales Lanzados'] / GV_prom;

        // --- 2. Cálculo de Goles Esperados (Lambda) ---

        // Lambda Local: GL_prom * GF_l * GC_v
        const lambdaLocal = GL_prom * GF_l * GC_v;

        // Lambda Visitante: GV_prom * GF_v * GC_l
        const lambdaVisitor = GV_prom * GF_v * GC_l;

        // --- 3. Distribución de Poisson ---
        const poisson = (k, lambda) => (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        const factorial = (n) => { if (n === 0) return 1; let result = 1; for (let i = 1; i <= n; i++) result *= i; return result; };

        let probLocalWin = 0;
        let probDraw = 0;
        let probVisitorWin = 0;
        let scoreProbabilities = [];

        // Calcular probabilidades de 0-0 hasta 5-5
        for (let i = 0; i <= 5; i++) { // Goles Local
            for (let j = 0; j <= 5; j++) { // Goles Visitante
                const probL = poisson(i, lambdaLocal);
                const probV = poisson(j, lambdaVisitor);
                const matchProb = probL * probV;

                scoreProbabilities.push({
                    score: `${i} - ${j}`,
                    prob: matchProb
                });

                if (i > j) {
                    probLocalWin += matchProb;
                } else if (i === j) {
                    probDraw += matchProb;
                } else {
                    probVisitorWin += matchProb;
                }
            }
        }
        
        // Agregar la probabilidad de "Otros resultados"
        probLocalWin = Math.min(probLocalWin, 1);
        probDraw = Math.min(probDraw, 1);
        probVisitorWin = Math.min(probVisitorWin, 1);
        const others = 1.0 - (probLocalWin + probDraw + probVisitorWin);
        probLocalWin += (others > 0) ? others * (probLocalWin/(probLocalWin + probDraw + probVisitorWin)) : 0;
        probDraw += (others > 0) ? others * (probDraw/(probLocalWin + probDraw + probVisitorWin)) : 0;
        probVisitorWin += (others > 0) ? others * (probVisitorWin/(probLocalWin + probDraw + probVisitorWin)) : 0;


        // Ordenar los marcadores más probables
        scoreProbabilities.sort((a, b) => b.prob - a.prob);


        // --- 4. Mostrar Resultados ---
        
        // Tabla Lambda
        document.getElementById('lambda-results').innerHTML = `
            <tr>
                <td>${localTeamName}</td>
                <td>${GF_l.toFixed(2)}</td>
                <td>${GC_v.toFixed(2)}</td>
                <td><strong>${lambdaLocal.toFixed(2)}</strong></td>
            </tr>
            <tr>
                <td>${visitorTeamName}</td>
                <td>${GF_v.toFixed(2)}</td>
                <td>${GC_l.toFixed(2)}</td>
                <td><strong>${lambdaVisitor.toFixed(2)}</strong></td>
            </tr>
        `;

        // Tabla de Probabilidades del Resultado
        document.getElementById('outcome-probabilities').innerHTML = `
            <tr><td>Gana ${localTeamName}</td><td>${(probLocalWin * 100).toFixed(2)}%</td></tr>
            <tr><td>Empate (X)</td><td>${(probDraw * 100).toFixed(2)}%</td></tr>
            <tr><td>Gana ${visitorTeamName}</td><td>${(probVisitorWin * 100).toFixed(2)}%</td></tr>
        `;

        // Tabla de Marcadores
        document.getElementById('score-probabilities').innerHTML = scoreProbabilities.slice(0, 5).map(item => 
            `<tr><td>${item.score}</td><td>${(item.prob * 100).toFixed(2)}%</td></tr>`
        ).join('');

        resultsDiv.style.display = 'block';
    }

    // Alerta si el archivo no es cargado
    window.onload = function() {
        document.getElementById('data-status').textContent = 'Carga un archivo CSV para empezar.';
    };
</script>

</body>
</html>

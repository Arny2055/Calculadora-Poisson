<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Backtesting Detallado por Equipo y Casa</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h1 { color: #0056b3; }
        h2, h3, h4 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 25px; }
        #resultados { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .success { color: #28a745; font-weight: bold; }
        .failure { color: #dc3545; font-weight: bold; }
        .neutral { color: #ffc107; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        /* Estilo espec칤fico para la tabla de equipo-casa */
        .equipo-row { background-color: #d8eaff; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Herramienta de Backtesting Detallado (Equipo, Casa y Mercado) 游늵</h1>
    <p>Carga tu archivo JSON para obtener un an치lisis granular.</p>

    <input type="file" id="jsonFile" accept=".json">
    <button onclick="iniciarBacktesting()">Iniciar Backtesting</button>

    <h2>Resultados del An치lisis</h2>
    <div id="resultados">Carga un archivo JSON para comenzar...</div>

    <script>
        let datosPartidos = []; 
        let analisisEquipos = {}; 
        
        // Mercados y Casas a analizar
        const MERCADOS = ['1X2_H', '1X2_D', '1X2_A', 'O2.5', 'U2.5'];
        const CASAS = ['B365', 'BFD', 'BMGM', 'BV', 'BW', 'CL', 'LB', 'PS', 'Max', 'Avg'];

        // Estructuras de An치lisis
        let analisisCasas = {}; // Global por Casa y Mercado
        let analisisEquipoCasaMercado = {}; // Detallado por Equipo, Casa y Mercado

        // Inicializa la estructura de an치lisisCasas (Global por Casa)
        CASAS.forEach(casa => {
            analisisCasas[casa] = {};
            MERCADOS.forEach(mercado => {
                analisisCasas[casa][mercado] = {
                    apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 
                };
            });
        });

        // Estructura para rangos de cuotas (solo para el O2.5 en Avg)
        let analisisRangosO25 = {
            '1.00-1.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '1.51-2.00': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '2.01-2.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '2.51+':     { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 }
        };

        // --- MANEJO DE ARCHIVOS (Se mantiene la misma l칩gica) ---
        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    datosPartidos = JSON.parse(e.target.result);
                    if (!Array.isArray(datosPartidos)) {
                        if (typeof datosPartidos === 'object' && datosPartidos !== null) {
                            datosPartidos = [datosPartidos];
                        } else {
                             throw new Error("El archivo JSON debe ser un array de partidos.");
                        }
                    }
                    if (datosPartidos.length === 0) {
                         throw new Error("El array de partidos est치 vac칤o.");
                    }
                    document.getElementById('resultados').innerHTML = `<p class="success">Archivo JSON cargado correctamente. Se encontraron ${datosPartidos.length} partidos.</p>`;
                } catch (error) {
                    document.getElementById('resultados').innerHTML = `<p class="failure">Error al leer o parsear el archivo JSON: ${error.message}</p>`;
                    datosPartidos = [];
                }
            };
            reader.readAsText(file);
        });

        // --- FUNCIONES AUXILIARES DE AN츼LISIS ---

        function inicializarEstadisticasDetalle() {
            return { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 };
        }

        function actualizarEstadisticasEquipo(equipo, esLocal, golesFavor, golesContra, resultadoFTR) {
            // ... (Funci칩n para actualizar estad칤sticas por equipo, la misma de antes)
            if (!equipo || !resultadoFTR) return; 

            if (!analisisEquipos[equipo]) {
                analisisEquipos[equipo] = {
                    jugados: 0, victorias: 0, empates: 0, derrotas: 0, 
                    gf: 0, gc: 0, loc_jugados: 0, vis_jugados: 0
                };
            }

            const stats = analisisEquipos[equipo];
            stats.jugados++;
            stats.gf += golesFavor;
            stats.gc += golesContra;
            stats[esLocal ? 'loc_jugados' : 'vis_jugados']++;

            if (resultadoFTR === 'H') {
                if (esLocal) stats.victorias++; else stats.derrotas++;
            } else if (resultadoFTR === 'A') {
                if (esLocal) stats.derrotas++; else stats.victorias++;
            } else { 
                stats.empates++;
            }
        }
        
        function obtenerRangoCuotaO25(cuota) {
            if (cuota >= 1.00 && cuota <= 1.50) return '1.00-1.50';
            if (cuota >= 1.51 && cuota <= 2.00) return '1.51-2.00';
            if (cuota >= 2.01 && cuota <= 2.50) return '2.01-2.50';
            if (cuota > 2.50) return '2.51+';
            return null;
        }


        // Funci칩n que actualiza las 3 estructuras de an치lisis simult치neamente
        function actualizarAnalisis(equipo, casa, mercado, cuota, esGanadora) {
            const apuesta = 1; // Stake fijo

            // 1. Inicializar estructura de Equipo -> Casa -> Mercado si es la primera vez
            if (!analisisEquipoCasaMercado[equipo]) analisisEquipoCasaMercado[equipo] = {};
            if (!analisisEquipoCasaMercado[equipo][casa]) analisisEquipoCasaMercado[equipo][casa] = {};
            if (!analisisEquipoCasaMercado[equipo][casa][mercado]) {
                analisisEquipoCasaMercado[equipo][casa][mercado] = inicializarEstadisticasDetalle();
            }

            // --- Actualizar Estad칤sticas ---
            
            // a) Global por Casa y Mercado
            const statsCasa = analisisCasas[casa][mercado];
            // b) Detallado por Equipo, Casa y Mercado
            const statsDetalle = analisisEquipoCasaMercado[equipo][casa][mercado];

            [statsCasa, statsDetalle].forEach(stats => {
                stats.apuestas++;
                stats.totalCuota += cuota;
                stats.cuotaMedia = stats.totalCuota / stats.apuestas;

                if (esGanadora) {
                    stats.gananciaNeta += (cuota - 1) * apuesta;
                    stats.victorias++;
                } else {
                    stats.gananciaNeta -= apuesta;
                    stats.perdidas++;
                }
            });
        }


        // --- FUNCIONES DE GENERACI칍N DE TABLAS ---
        
        function generarFilaEstadistica(stats, isHeader = false) {
            if (isHeader) {
                return '<th>PJ</th><th>Cuota Media</th><th>Ganancia Neta (u)</th><th>ROI (%)</th><th>Acierto (%)</th>';
            }
            if (stats.apuestas === 0) {
                return '<td colspan="5">-</td>';
            }

            const totalApuestas = stats.apuestas;
            const roi = (stats.gananciaNeta / totalApuestas) * 100;
            const acierto = (stats.victorias / totalApuestas) * 100;
            const cssClass = stats.gananciaNeta >= 0 ? 'success' : 'failure';

            return `
                <td>${totalApuestas}</td>
                <td>${stats.cuotaMedia.toFixed(3)}</td>
                <td class="${cssClass}">${stats.gananciaNeta.toFixed(2)}</td>
                <td class="${cssClass}">${roi.toFixed(2)}%</td>
                <td>${acierto.toFixed(1)}%</td>
            `;
        }

        function generarTablaEquipos() {
            // ... (Funci칩n para generar tabla de equipos, la misma de antes)
            let htmlTabla = '<h3>An치lisis de Rendimiento General por Equipo (Todos los partidos)</h3>';
            // ... (c칩digo HTML de la tabla de equipos)
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Equipo</th><th>PJ</th><th>V</th><th>E</th><th>D</th><th>GF</th><th>GC</th><th>Dif</th><th>%V</th></tr>';

            const equiposOrdenados = Object.keys(analisisEquipos).sort();

            equiposOrdenados.forEach(equipo => {
                const stats = analisisEquipos[equipo];
                const diferencia = stats.gf - stats.gc;
                const porcentajeVictoria = stats.jugados > 0 ? ((stats.victorias / stats.jugados) * 100).toFixed(1) : 0;
                
                htmlTabla += `<tr>
                    <td>${equipo}</td>
                    <td>${stats.jugados}</td>
                    <td>${stats.victorias}</td>
                    <td>${stats.empates}</td>
                    <td>${stats.derrotas}</td>
                    <td>${stats.gf}</td>
                    <td>${stats.gc}</td>
                    <td class="${diferencia >= 0 ? 'success' : 'failure'}">${diferencia}</td>
                    <td>${porcentajeVictoria}%</td>
                </tr>`;
            });

            htmlTabla += '</table>';
            return htmlTabla;
        }

        function generarTablaCasas() {
            // ... (Funci칩n para generar tabla global por casa, la misma de antes)
            let htmlTabla = '<h3>Rentabilidad Global por Casa de Apuestas y Mercado (Stake Fijo de 1u)</h3>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Casa</th><th>Mercado</th><th>Apuestas</th><th>Cuota Media</th><th>Ganancia Neta (u)</th><th>ROI (%)</th><th>Acierto (%)</th></tr>';
            
            CASAS.forEach(casa => {
                MERCADOS.forEach(mercado => {
                    const stats = analisisCasas[casa][mercado];
                    const totalApuestas = stats.apuestas;
                    
                    if (totalApuestas > 0) {
                        const roi = (stats.gananciaNeta / totalApuestas) * 100;
                        const acierto = (stats.victorias / totalApuestas) * 100;
                        const cssClass = stats.gananciaNeta >= 0 ? 'success' : 'failure';
    
                        htmlTabla += `<tr>
                            <td>${casa}</td>
                            <td>${mercado}</td>
                            <td>${totalApuestas}</td>
                            <td>${stats.cuotaMedia.toFixed(3)}</td>
                            <td class="${cssClass}">${stats.gananciaNeta.toFixed(2)}</td>
                            <td class="${cssClass}">${roi.toFixed(2)}%</td>
                            <td>${acierto.toFixed(1)}%</td>
                        </tr>`;
                    }
                });
            });

            htmlTabla += '</table>';
            return htmlTabla;
        }

        function generarTablaRangosO25() {
             // ... (Funci칩n para generar tabla de rangos O25, la misma de antes)
            let htmlTabla = '<h3>Desglose de Rentabilidad: Over 2.5 Goles (Avg) por Rango de Cuotas</h3>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Rango de Cuotas</th><th>Apuestas</th><th>Ganancia Neta (u)</th><th>ROI (%)</th><th>Acierto (%)</th></tr>';

            for (const rango in analisisRangosO25) {
                const stats = analisisRangosO25[rango];
                const totalApuestas = stats.victorias + stats.perdidas;
                const roi = totalApuestas > 0 ? ((stats.gananciaNeta / totalApuestas) * 100).toFixed(2) : 0;
                const acierto = totalApuestas > 0 ? ((stats.victorias / totalApuestas) * 100).toFixed(1) : 0;
                const cssClass = stats.gananciaNeta >= 0 ? 'success' : 'failure';

                htmlTabla += `<tr>
                    <td>${rango}</td>
                    <td>${totalApuestas}</td>
                    <td class="${cssClass}">${stats.gananciaNeta.toFixed(2)}</td>
                    <td class="${cssClass}">${roi}</td>
                    <td>${acierto}</td>
                </tr>`;
            }

            htmlTabla += '</table>';
            return htmlTabla;
        }
        
        function generarTablaDetallada() {
            let htmlTabla = '<h3>Rentabilidad Detallada por Equipo, Casa de Apuestas y Mercado</h3>';
            htmlTabla += '<p>Muestra el rendimiento de los mercados para cada equipo individualmente en cada casa de apuestas.</p>';
            
            const equipos = Object.keys(analisisEquipoCasaMercado).sort();
            
            equipos.forEach(equipo => {
                htmlTabla += `<h4>Equipo: ${equipo}</h4>`;
                htmlTabla += '<table>';
                htmlTabla += '<tr><th>Casa</th><th>Mercado</th>' + generarFilaEstadistica(null, true) + '</tr>';

                CASAS.forEach(casa => {
                    MERCADOS.forEach(mercado => {
                        const stats = analisisEquipoCasaMercado[equipo] && analisisEquipoCasaMercado[equipo][casa] ? analisisEquipoCasaMercado[equipo][casa][mercado] : null;

                        // Solo mostrar filas con datos
                        if (stats && stats.apuestas > 0) {
                            htmlTabla += `<tr>
                                <td>${casa}</td>
                                <td>${mercado}</td>
                                ${generarFilaEstadistica(stats)}
                            </tr>`;
                        }
                    });
                });
                htmlTabla += '</table>';
            });
            
            return htmlTabla;
        }


        // --- FUNCI칍N PRINCIPAL DE BACKTESTING ---

        function iniciarBacktesting() {
            if (datosPartidos.length === 0) {
                document.getElementById('resultados').innerHTML = '<p class="failure">Por favor, primero carga un archivo JSON.</p>';
                return;
            }

            // Reiniciar estructuras de an치lisis
            analisisEquipos = {}; 
            analisisEquipoCasaMercado = {}; // Reiniciar el an치lisis detallado

            // (Reiniciar an치lisisCasas y Rangos O25 - l칩gica omitida para concisi칩n, ya est치 arriba)
            CASAS.forEach(casa => {
                analisisCasas[casa] = {};
                MERCADOS.forEach(mercado => {
                    analisisCasas[casa][mercado] = inicializarEstadisticasDetalle();
                });
            });
            analisisRangosO25 = {
                '1.00-1.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '1.51-2.00': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '2.01-2.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '2.51+':     { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 }
            };


            // --- BUCLE DE BACKTESTING ---
            datosPartidos.forEach((partido) => {
                const homeTeam = partido.HomeTeam;
                const awayTeam = partido.AwayTeam;
                
                // Resultados
                const fthg = parseInt(partido.FTHG) || 0; 
                const ftag = parseInt(partido.FTAG) || 0; 
                const ftr = partido.FTR;
                const golesTotales = fthg + ftag;
                
                // 1. An치lisis de Rendimiento de Equipos (Para tabla general)
                actualizarEstadisticasEquipo(homeTeam, true, fthg, ftag, ftr);
                actualizarEstadisticasEquipo(awayTeam, false, ftag, fthg, ftr);


                // 2. BACKTESTING POR CASA DE APUESTAS Y EQUIPO
                const ganaO2_5 = golesTotales >= 3;
                const ganaU2_5 = golesTotales <= 2;
                
                CASAS.forEach(casa => {
                    // --- 2.1 Mercado 1X2 ---
                    const cuotas1X2 = {
                        'H': parseFloat(partido[casa + 'H']) || 0,
                        'D': parseFloat(partido[casa + 'D']) || 0,
                        'A': parseFloat(partido[casa + 'A']) || 0
                    };
                    
                    // Solo se consideran apuestas si la cuota es v치lida
                    if (cuotas1X2.H > 0) {
                        actualizarAnalisis(homeTeam, casa, '1X2_H', cuotas1X2.H, ftr === 'H');
                        actualizarAnalisis(awayTeam, casa, '1X2_H', cuotas1X2.H, ftr === 'H');
                    }
                    if (cuotas1X2.D > 0) {
                        actualizarAnalisis(homeTeam, casa, '1X2_D', cuotas1X2.D, ftr === 'D');
                        actualizarAnalisis(awayTeam, casa, '1X2_D', cuotas1X2.D, ftr === 'D');
                    }
                    if (cuotas1X2.A > 0) {
                        actualizarAnalisis(homeTeam, casa, '1X2_A', cuotas1X2.A, ftr === 'A');
                        actualizarAnalisis(awayTeam, casa, '1X2_A', cuotas1X2.A, ftr === 'A');
                    }
                    

                    // --- 2.2 Mercado O/U 2.5 ---
                    const cuotaO2_5 = parseFloat(partido[casa + '>2'] ? partido[casa + '>2'][5] : null) || 0; 
                    const cuotaU2_5 = parseFloat(partido[casa + '<2'] ? partido[casa + '<2'][5] : null) || 0;
                    
                    if (cuotaO2_5 > 0) {
                        actualizarAnalisis(homeTeam, casa, 'O2.5', cuotaO2_5, ganaO2_5);
                        actualizarAnalisis(awayTeam, casa, 'O2.5', cuotaO2_5, ganaO2_5);

                        // REGISTRO DE RANGOS O2.5 (Solo para el promedio 'Avg')
                        if (casa === 'Avg') {
                            const rango = obtenerRangoCuotaO25(cuotaO2_5);
                            if (rango) {
                                const statsRango = analisisRangosO25[rango];
                                statsRango.apuestas++;
                                if (ganaO2_5) {
                                    statsRango.gananciaNeta += (cuotaO2_5 - 1) * 1;
                                    statsRango.victorias++;
                                } else {
                                    statsRango.gananciaNeta -= 1;
                                    statsRango.perdidas++;
                                }
                            }
                        }
                    }
                    if (cuotaU2_5 > 0) {
                        actualizarAnalisis(homeTeam, casa, 'U2.5', cuotaU2_5, ganaU2_5);
                        actualizarAnalisis(awayTeam, casa, 'U2.5', cuotaU2_5, ganaU2_5);
                    }
                });
            });
            // --- FIN DEL BUCLE ---

            // --- Generar Reporte ---
            let resultadosHTML = '';
            
            // 1. Tabla Detallada por Equipo, Casa y Mercado (NUEVA)
            resultadosHTML += generarTablaDetallada();
            
            // 2. Tabla Global por Casa
            resultadosHTML += generarTablaCasas();
            
            // 3. Desglose de Rangos O2.5 (Usando Avg)
            resultadosHTML += generarTablaRangosO25();
            
            // 4. Tabla de Rendimiento General de Equipos
            resultadosHTML += generarTablaEquipos();
            
            document.getElementById('resultados').innerHTML = resultadosHTML;
        }

    </script>

</body>
</html>

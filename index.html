<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora Kelly ‚Äî Pro (Portafolio Conectado)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0e1014; --card:#161a23; --ink:#e7eaf2; --muted:#9aa4b2; --accent:#5b9cff;
    --good:#2ecc71; --bad:#ff5b6e; --ring:rgba(91,156,255,.35); --line:#242a3a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0d1016,#0b0e14 60%);color:var(--ink);
       font:15px/1.45 system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
       display:grid; place-items:start center; min-height:100vh; padding:18px}
  .wrap{width:100%; max-width:1200px}
  h1{margin:0 0 8px; font-size:clamp(22px,3vw,28px)}
  .lead{color:var(--muted); margin:0 0 16px}
  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px}
  .span-3{grid-column:span 3} .span-4{grid-column:span 4} .span-5{grid-column:span 5}
  .span-6{grid-column:span 6} .span-8{grid-column:span 8} .span-12{grid-column:span 12}
  @media (max-width:980px){ .span-6,.span-8,.span-5,.span-4,.span-3{grid-column:span 12} }
  label{display:block; font-weight:600; margin:8px 0 6px}
  input,select,button{
    background:#0f1320; color:var(--ink); border:1px solid #2b3145; border-radius:10px; padding:10px;
    outline:none; width:100%;
  }
  input:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 5px var(--ring)}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .pill{display:inline-block; border:1px dashed #2a3350; color:#c7d0e0; padding:4px 8px; border-radius:999px; font-size:12px}
  .hint{color:var(--muted); font-size:12px}
  .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
  .kpi .item{background:#101423; border:1px solid var(--line); border-radius:10px; padding:10px}
  .kpi .label{color:var(--muted); font-size:12px}
  .kpi .value{font-size:18px; font-weight:800; margin-top:4px}
  .value.good{color:var(--good)} .value.bad{color:var(--bad)}
  table{width:100%; border-collapse:collapse}
  th,td{border:1px solid var(--line); padding:6px 8px; text-align:center}
  th{background:#1a1f2e}
  .btn{cursor:pointer; user-select:none}
  .btn-ghost{background:#0f1320}
  .btn-accent{background:#18223a; border-color:#34405f}
  .flex{display:flex; gap:10px; align-items:center}
  .right{margin-left:auto}
  .note{font-size:12px; color:var(--muted)}
  .sep{height:10px}
  .tag{font-size:12px; color:#cbd3e6}
  .blocked{outline:2px solid var(--bad); box-shadow:0 0 0 6px rgba(255,91,110,.2)}
  .settled{opacity:.6}
  .tiny{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Calculadora Kelly ‚Äî Pro</h1>
  <p class="lead">Kelly din√°mico, stop-loss, Monte Carlo, ajuste por deporte, gr√°fico y portafolio conectado al control diario.</p>

  <div class="grid">
    <!-- Controles principales -->
    <div class="card span-6">
      <div class="row">
        <div style="flex:1">
          <label>Bankroll</label>
          <input id="bankroll" type="number" value="100" min="1" step="0.01">
        </div>
        <div style="width:135px">
          <label>Fracci√≥n Kelly (%)</label>
          <input id="fraction" type="number" value="25" min="1" max="100" step="1">
        </div>
      </div>

      <label>Deporte / mercado (ajuste por varianza)</label>
      <select id="sport">
        <option value="1.00">Tenis (baja varianza) ‚Äî x1.00</option>
        <option value="0.90">Baloncesto ‚Äî x0.90</option>
        <option value="0.80">MMA / Box ‚Äî x0.80</option>
        <option value="0.70">NFL ‚Äî x0.70</option>
        <option value="0.65" selected>F√∫tbol (soccer) ‚Äî x0.65</option>
      </select>
      <div class="hint">Se multiplica el stake Kelly por este factor seg√∫n la varianza t√≠pica.</div>

      <div class="sep"></div>

      <div class="row">
        <div style="flex:1">
          <label>Probabilidad estimada (%)</label>
          <input id="prob" type="number" placeholder="Ej. 55" min="0" max="100" step="0.01">
        </div>
        <div style="flex:1">
          <label>Cuota decimal</label>
          <input id="odds" type="number" placeholder="Ej. 1.91" min="1.01" step="0.001">
        </div>
      </div>

      <label>Confianza en tu estimaci√≥n (%)</label>
      <input id="confidence" type="range" min="0" max="100" value="70">
      <div class="hint">p<sub>ajustada</sub> = c¬∑p + (1‚àíc)¬∑(1/odds), con c = confianza/100.</div>

      <div class="sep"></div>

      <div class="row">
        <div style="flex:1">
          <label>Stop-loss diario (% BR)</label>
          <input id="stopLossPct" type="number" value="5" min="1" max="50" step="1">
        </div>
        <div style="flex:1">
          <label>Cap por apuesta (% BR)</label>
          <input id="capPct" type="number" value="10" min="1" max="50" step="1">
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <label class="flex" style="gap:8px; align-items:center">
          <input id="autoUpdateBR" type="checkbox" style="width:auto; height:auto"> 
          <span class="tiny">Actualizar bankroll con resultados del portafolio</span>
        </label>
      </div>
      <div class="hint">Si est√° activo, cada resultado registrado mover√° tu bankroll y recalcular√° stakes.</div>
    </div>

    <!-- Resultados -->
    <div class="card span-6" id="resultCard">
      <div class="kpi">
        <div class="item">
          <div class="label">Kelly completo (f*)</div>
          <div id="kFull" class="value">‚Äî</div>
        </div>
        <div class="item">
          <div class="label">Stake Kelly 100%</div>
          <div id="k100" class="value">‚Äî</div>
        </div>
        <div class="item">
          <div class="label">Stake fraccional</div>
          <div id="stakeFrac" class="value">‚Äî</div>
        </div>
        <div class="item">
          <div class="label">Stake final (con caps)</div>
          <div id="stakeFinal" class="value">‚Äî</div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="row">
        <span class="tag" id="impliedTag">Prob. impl√≠cita: ‚Äî</span>
        <span class="tag" id="padjTag">p ajustada: ‚Äî</span>
        <span class="tag" id="edgeTag">Edge: ‚Äî</span>
        <span class="right pill" id="stopState">Stop-loss: activo/desactivado</span>
      </div>
      <div class="hint" id="summaryTxt">Introduce datos para calcular.</div>
    </div>

    <!-- Simulaci√≥n y gr√°fico -->
    <div class="card span-8">
      <div class="row">
        <div style="width:120px">
          <label>Apuestas a simular</label>
          <input id="simBets" type="number" value="100" min="10" max="500" step="10">
        </div>
        <div style="width:140px">
          <label>Trayectorias</label>
          <input id="simPaths" type="number" value="1000" min="100" max="5000" step="100">
        </div>
        <div style="width:160px">
          <label>Exposici√≥n m√°x. simult√°nea (%)</label>
          <input id="expoMax" type="number" value="20" min="5" max="100" step="1">
        </div>
        <button id="runSim" class="btn btn-accent right" style="width:180px">‚ñ∂ Simular Monte Carlo</button>
      </div>

      <div class="sep"></div>
      <canvas id="bankrollChart" height="220"></canvas>
      <div class="row">
        <div class="kpi" style="width:100%; grid-template-columns:repeat(4,1fr); margin-top:10px">
          <div class="item"><div class="label">P(duplicar BR)</div><div id="pDouble" class="value">‚Äî</div></div>
          <div class="item"><div class="label">P(caer < 50% BR)</div><div id="pHalf" class="value">‚Äî</div></div>
          <div class="item"><div class="label">Mediana BR final</div><div id="p50" class="value">‚Äî</div></div>
          <div class="item"><div class="label">P(ruina: BR‚â§0)</div><div id="pRuin" class="value">‚Äî</div></div>
        </div>
      </div>
      <div class="note">La simulaci√≥n usa p<sub>ajustada</sub>, factor de deporte, fracci√≥n Kelly y caps. El gr√°fico muestra mediana y bandas 10‚Äì90%.</div>
    </div>

    <!-- Registro diario / historial -->
    <div class="card span-4">
      <h3 style="margin:6px 0 10px">Control diario</h3>
      <div class="row">
        <div style="flex:1">
          <label>Resultado (unidades)</label>
          <input id="logPnL" type="number" placeholder="Ej. +3.50 o -2.00" step="0.01">
        </div>
        <button id="btnLog" class="btn btn-ghost" style="width:120px">‚ûï Registrar</button>
      </div>
      <div class="sep"></div>
      <div class="kpi">
        <div class="item"><div class="label">Fecha</div><div id="todayKey" class="value">‚Äî</div></div>
        <div class="item"><div class="label">P&L de hoy</div><div id="pnlToday" class="value">‚Äî</div></div>
        <div class="item"><div class="label">Stop-loss hoy</div><div id="stopThresh" class="value">‚Äî</div></div>
        <div class="item"><div class="label">Estado</div><div id="stateSL" class="value">‚Äî</div></div>
      </div>
      <div class="sep"></div>
      <h3 style="margin:6px 0 10px">Historial r√°pido</h3>
      <table id="historyTable">
        <thead><tr><th>Fecha</th><th>p%</th><th>Cuota</th><th>Frac%</th><th>Stake</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:8px">
        <button id="clearHist" class="btn btn-ghost">üóë Limpiar historial</button>
      </div>
    </div>

    <!-- Multi-apuesta simult√°nea -->
    <div class="card span-12">
      <div class="row">
        <h3 style="margin:6px 0">Portafolio de apuestas simult√°neas</h3>
        <button id="addRow" class="btn btn-ghost right" style="width:140px">‚ûï A√±adir apuesta</button>
      </div>
      <table id="multiTable" style="margin-top:8px">
        <thead>
          <tr>
            <th>#</th><th>Prob (%)</th><th>Cuota</th><th>Conf. (%)</th><th>Deporte</th>
            <th>Stake (Kelly)</th><th>Stake (final)</th>
            <th>Nota</th>
            <th>Resultado</th>
            <th>‚Äî</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:8px">
        <span class="tag" id="multiSummary">Exposici√≥n total: ‚Äî</span>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const bankroll = $("bankroll"), fraction = $("fraction"), sport = $("sport");
  const prob = $("prob"), odds = $("odds"), confidence = $("confidence");
  const stopLossPct = $("stopLossPct"), capPct = $("capPct"), autoUpdateBR = $("autoUpdateBR");
  const kFull = $("kFull"), k100 = $("k100"), stakeFrac = $("stakeFrac"), stakeFinal = $("stakeFinal");
  const impliedTag = $("impliedTag"), padjTag = $("padjTag"), edgeTag = $("edgeTag"), stopState = $("stopState");
  const summaryTxt = $("summaryTxt"), resultCard = $("resultCard");
  const simBets = $("simBets"), simPaths = $("simPaths"), runSim = $("runSim"), expoMax = $("expoMax");
  const pDouble = $("pDouble"), pHalf = $("pHalf"), p50 = $("p50"), pRuin = $("pRuin");
  const logPnL = $("logPnL"), btnLog = $("btnLog"), todayKey = $("todayKey"), pnlToday = $("pnlToday"), stopThresh = $("stopThresh"), stateSL = $("stateSL");
  const tableBody = $("historyTable").querySelector("tbody");
  const addRow = $("addRow"), multiTable = $("multiTable").querySelector("tbody"), multiSummary = $("multiSummary");

  // ===== Utilidades
  const clamp = (x,a,b)=>Math.min(Math.max(x,a),b);
  const today = ()=> new Date().toISOString().slice(0,10);
  const read = (k,def)=> JSON.parse(localStorage.getItem(k) || JSON.stringify(def));
  const write = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

  function bFromOdds(o){ return o-1; }
  function kellyF(p,o){
    const b = bFromOdds(o), q=1-p;
    const f = (b*p - q)/b;
    return Math.max(0, isFinite(f)?f:0);
  }
  function pAdjusted(p, o, conf){ // conf in [0,1]
    const impl = 1/o;
    return clamp(conf*p + (1-conf)*impl, 0, 1);
  }
  function fmtPct(x){ return isFinite(x) ? (x*100).toFixed(2)+"%" : "‚Äî"; }
  function fmtNum(x, d=2){ return isFinite(x) ? Number(x).toFixed(d) : "‚Äî"; }

  // ===== Stop-loss diario
  function getDaily(){
    const key = "kelly_daily_"+today();
    return read(key,{ pnl:0 });
  }
  function setDaily(obj){
    const key = "kelly_daily_"+today();
    write(key,obj);
  }
  function refreshDaily(){
    const d = getDaily();
    todayKey.textContent = today();
    pnlToday.textContent = fmtNum(d.pnl);
    const BR = parseFloat(bankroll.value)||0;
    const thresh = - ( (parseFloat(stopLossPct.value)||0)/100 ) * BR;
    stopThresh.textContent = fmtNum(thresh);
    const blocked = d.pnl <= thresh;
    stateSL.textContent = blocked ? "BLOQUEADO" : "OK";
    stopState.textContent = "Stop-loss: " + (blocked ? "ACTIVO" : "OK");
    resultCard.classList.toggle("blocked", blocked);
    return blocked;
  }
  btnLog.addEventListener("click", ()=>{
    const v = parseFloat(logPnL.value);
    if(!isFinite(v)) return;
    const d = getDaily(); d.pnl += v; setDaily(d);
    logPnL.value = "";
    refreshDaily();
  });

  // ===== Historial c√°lculos
  function saveToHistory(p, o, frac, stake){
    const hist = read("kellyHist",[]);
    hist.unshift({ date:new Date().toLocaleString(), p:p.toFixed(2), o:o.toFixed(3), f:frac.toFixed(0), s:stake.toFixed(2) });
    if(hist.length>30) hist.pop();
    write("kellyHist",hist);
  }
  function renderHistory(){
    const hist = read("kellyHist",[]);
    tableBody.innerHTML = "";
    hist.forEach(h=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${h.date}</td><td>${h.p}</td><td>${h.o}</td><td>${h.f}%</td><td>${h.s}</td>`;
      tableBody.appendChild(tr);
    });
  }
  $("clearHist").addEventListener("click", ()=>{ localStorage.removeItem("kellyHist"); renderHistory(); });

  // ===== C√°lculo principal
  [bankroll, fraction, sport, prob, odds, confidence, capPct, stopLossPct].forEach(el => el.addEventListener("input", compute));
  function compute(){
    const BR = parseFloat(bankroll.value)||0;
    const p = (parseFloat(prob.value)||0)/100;
    const o = parseFloat(odds.value)||0;
    const c = (parseFloat(confidence.value)||0)/100;
    const frac = (parseFloat(fraction.value)||0)/100;
    const sportF = parseFloat(sport.value)||1;
    const cap = ((parseFloat(capPct.value)||10)/100) * BR;
    if(BR<=0 || o<=1 || p<=0){ summaryTxt.textContent = "Completa probabilidad y cuota para calcular."; return refreshDaily(); }

    const pAdj = pAdjusted(p,o,c);
    const fStar = kellyF(pAdj,o);
    const stakeKelly = fStar*BR;
    const stakeFracRaw = frac*stakeKelly;
    const stakeFracSport = sportF * stakeFracRaw;
    const final = Math.min(stakeFracSport, cap);

    const impl = 1/o;
    const edge = pAdj - impl;

    const blocked = refreshDaily();
    const showFinal = blocked ? 0 : final;

    kFull.textContent = fmtPct(fStar);
    k100.textContent = fmtNum(stakeKelly);
    stakeFrac.textContent = fmtNum(stakeFracSport);
    stakeFinal.textContent = fmtNum(showFinal);
    impliedTag.textContent = "Prob. impl√≠cita: " + fmtPct(impl);
    padjTag.textContent = "p ajustada: " + fmtPct(pAdj);
    edgeTag.textContent = "Edge: " + (edge>=0?"+":"") + fmtPct(edge);
    summaryTxt.textContent = blocked
      ? "Stop-loss alcanzado: se sugiere NO apostar hoy."
      : `Con f*=${fmtPct(fStar)}, fracci√≥n=${(frac*100).toFixed(0)}% y factor deporte=${sportF.toFixed(2)}, stake final=${fmtNum(final)} (cap ${fmtNum(cap)}).`;

    if(!blocked && fStar>0){
      saveToHistory(p*100, o, frac*100, final);
      renderHistory();
    }

    // Recalcular portafolio ante cualquier cambio
    computePortfolio();
  }

  // ===== Simulaci√≥n Monte Carlo
  let chart;
  function ensureChart(){
    if(chart) return chart;
    const ctx = document.getElementById("bankrollChart");
    chart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [
        { label: "P10", data: [], borderWidth:1, fill:false, tension:.15 },
        { label: "Mediana", data: [], borderWidth:2, fill:false, tension:.15 },
        { label: "P90", data: [], borderWidth:1, fill:false, tension:.15 },
      ]},
      options: {
        responsive:true,
        interaction:{ mode:"index", intersect:false },
        plugins:{ legend:{ position:"bottom" } },
        scales:{ x:{ grid:{ color:"#233" }}, y:{ grid:{ color:"#233" }, beginAtZero:true } }
      }
    });
    return chart;
  }

  function simulate(){
    const BR0 = parseFloat(bankroll.value)||0;
    const p = (parseFloat(prob.value)||0)/100;
    const o = parseFloat(odds.value)||0;
    const c = (parseFloat(confidence.value)||0)/100;
    const frac = (parseFloat(fraction.value)||0)/100;
    const sportF = parseFloat(sport.value)||1;
    const cap = ((parseFloat(capPct.value)||10)/100) * BR0;
    const nB = clamp(parseInt(simBets.value)||100, 10, 500);
    const nP = clamp(parseInt(simPaths.value)||1000, 100, 5000);

    if(BR0<=0 || o<=1 || p<=0) return;

    const pAdj = pAdjusted(p,o,c);
    const fStar = kellyF(pAdj,o);

    const labels = Array.from({length:nB+1}, (_,i)=>i);
    const paths = [];
    let countDouble=0, countHalf=0, countRuin=0;

    for(let k=0;k<nP;k++){
      let br = BR0;
      for(let t=1;t<=nB;t++){
        const cap_t = (cap/BR0)*br; 
        const stakeKelly = fStar*br;
        const stakeFrac = sportF * frac * stakeKelly;
        const stake = Math.min(stakeFrac, cap_t);

        const win = Math.random() < pAdj;
        br += win ? stake*(o-1) : -stake;

        if(!paths[k]) paths[k] = Array(nB+1).fill(0);
        paths[k][t] = br;
      }
      paths[k][0] = BR0;

      if(br >= 2*BR0) countDouble++;
      if(paths[k].some(v => v>0 && v <= 0.5*BR0)) countHalf++;
      if(br <= 0) countRuin++;
    }

    const p10=[], p50arr=[], p90=[];
    for(let t=0;t<=nB;t++){
      const slice = paths.map(p=>p[t]).sort((a,b)=>a-b);
      const q = qtile => slice[Math.floor(qtile*(slice.length-1))];
      p10.push(q(0.10)); p50arr.push(q(0.50)); p90.push(q(0.90));
    }

    const Pdouble = countDouble/nP, Phalf = countHalf/nP, Pruin = countRuin/nP;

    const ch = ensureChart();
    ch.data.labels = labels;
    ch.data.datasets[0].data = p10.map(x=>+x.toFixed(2));
    ch.data.datasets[1].data = p50arr.map(x=>+x.toFixed(2));
    ch.data.datasets[2].data = p90.map(x=>+x.toFixed(2));
    ch.update();

    pDouble.textContent = fmtPct(Pdouble);
    pHalf.textContent = fmtPct(Phalf);
    pRuin.textContent = fmtPct(Pruin);
    p50.textContent = fmtNum(p50arr[p50arr.length-1]);
  }
  runSim.addEventListener("click", simulate);

  // ===== Portafolio: filas + conexi√≥n a Control diario
  function addMultiRow(defaults={p:"",o:"",c:70, s:"0.65", note:""}){
    const idx = multiTable.children.length+1;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="idx">${idx}</td>
      <td><input type="number" step="0.01" min="0" max="100" value="${defaults.p}" style="width:110px"></td>
      <td><input type="number" step="0.001" min="1.01" value="${defaults.o}" style="width:110px"></td>
      <td><input type="number" step="1" min="0" max="100" value="${defaults.c}" style="width:100px"></td>
      <td>
        <select style="width:180px">
          <option value="1.00">Tenis</option>
          <option value="0.90">Baloncesto</option>
          <option value="0.80">MMA/Box</option>
          <option value="0.70">NFL</option>
          <option value="${defaults.s}" selected>F√∫tbol</option>
        </select>
      </td>
      <td class="stakeK">‚Äî</td>
      <td class="stakeF">‚Äî</td>
      <td><input type="text" placeholder="Nota" value="${defaults.note}" style="width:180px"></td>
      <td class="settleCell">
        <div class="row" style="gap:6px; justify-content:center">
          <button class="btn btn-ghost win" title="Ganada">‚úÖ</button>
          <button class="btn btn-ghost loss" title="Perdida">‚ùå</button>
          <button class="btn btn-ghost halfwin" title="Half win">üåì+</button>
          <button class="btn btn-ghost halfloss" title="Half loss">üåì‚àí</button>
          <button class="btn btn-ghost void" title="Void">‚õî</button>
        </div>
        <div class="tiny" style="margin-top:4px">P&L: <span class="plVal">0.00</span></div>
      </td>
      <td><button class="btn btn-ghost del">‚úñ</button></td>
    `;
    multiTable.appendChild(tr);

    // listeners
    tr.querySelectorAll("input,select").forEach(el=> el.addEventListener("input", ()=>{ computePortfolio(); }));
    tr.querySelector(".del").addEventListener("click", ()=>{ tr.remove(); renumberMulti(); computePortfolio(); });

    // settle buttons
    tr.querySelector(".win").addEventListener("click", ()=> registerOutcome(tr,"win"));
    tr.querySelector(".loss").addEventListener("click", ()=> registerOutcome(tr,"loss"));
    tr.querySelector(".halfwin").addEventListener("click", ()=> registerOutcome(tr,"halfwin"));
    tr.querySelector(".halfloss").addEventListener("click", ()=> registerOutcome(tr,"halfloss"));
    tr.querySelector(".void").addEventListener("click", ()=> registerOutcome(tr,"void"));

    computePortfolio();
  }
  function renumberMulti(){
    [...multiTable.children].forEach((tr,i)=> tr.querySelector(".idx").textContent = (i+1));
  }

  function computePortfolio(){
    const BR = parseFloat(bankroll.value)||0;
    const frac = (parseFloat(fraction.value)||0)/100;
    const cap = ((parseFloat(capPct.value)||10)/100) * BR;
    const expo = ((parseFloat(expoMax.value)||20)/100) * BR;

    const rows = [...multiTable.children];
    if(rows.length===0){ multiSummary.textContent = "Exposici√≥n total: ‚Äî"; return; }

    const items = rows.map(tr=>{
      const p = (parseFloat(tr.children[1].querySelector("input").value)||0)/100;
      const o = parseFloat(tr.children[2].querySelector("input").value)||0;
      const c = (parseFloat(tr.children[3].querySelector("input").value)||0)/100;
      const sportF = parseFloat(tr.children[4].querySelector("select").value)||1;
      const pAdj = pAdjusted(p,o,c);
      const fStar = kellyF(pAdj,o);
      const stakeK = fStar*BR;
      const stakeFrac = sportF * frac * stakeK;
      const sCap = Math.min(stakeFrac, cap);
      // guardar datos para la fila
      tr.dataset.odds = o || 0;
      tr.dataset.stakeFinal = sCap || 0;
      tr.dataset.settled = tr.dataset.settled || "0";
      return {tr, pAdj, o, fStar, stakeK, sCap};
    });

    // Exposici√≥n total y escalado si supera el m√°ximo
    const sum = items.reduce((acc,it)=> acc + it.sCap, 0);
    const scale = sum > expo ? (expo / sum) : 1;

    items.forEach(it=>{
      const sK = it.stakeK;
      const sF = it.sCap * scale;
      it.tr.querySelector(".stakeK").textContent = fmtNum(sK);
      it.tr.querySelector(".stakeF").textContent = fmtNum(sF);
      it.tr.dataset.stakeFinal = sF; // guardar stake final escalado
    });

    multiSummary.textContent = `Exposici√≥n total: ${fmtNum(Math.min(sum, expo))} / ${fmtNum(expo)} (${fmtPct(Math.min(sum/expo,1))}) ${sum>expo ? " ‚Äî escalado" : ""}`;
  }

  // Registrar resultado de una fila del portafolio -> suma al P&L diario y (opcional) mueve bankroll
  function registerOutcome(tr, kind){
    // no permitir doble registro
    if(tr.dataset.settled === "1") return;

    const stake = parseFloat(tr.dataset.stakeFinal)||0;
    const o = parseFloat(tr.dataset.odds)||0;
    if(stake<=0 || o<=1) return;

    let pnl = 0;
    if(kind==="win") pnl = stake*(o-1);
    else if(kind==="loss") pnl = -stake;
    else if(kind==="halfwin") pnl = stake*(o-1)/2;
    else if(kind==="halfloss") pnl = -stake/2;
    else pnl = 0; // void

    // Actualizar P&L diario
    const d = getDaily(); d.pnl += pnl; setDaily(d);
    refreshDaily();

    // Actualizar bankroll si est√° activado
    if(autoUpdateBR.checked){
      const BR = parseFloat(bankroll.value)||0;
      bankroll.value = (BR + pnl).toFixed(2);
    }

    // Mostrar P&L de la fila y marcar como liquidada
    tr.querySelector(".plVal").textContent = fmtNum(pnl);
    tr.classList.add("settled");
    tr.dataset.settled = "1";

    // Recalcular todo (por si cambi√≥ el BR)
    compute();
  }

  // ===== Inicializaci√≥n
  renderHistory();
  refreshDaily();
  compute();
  // Fila de ejemplo
  addMultiRow({p:55,o:1.90,c:70,s:"0.65",note:"Ejemplo ‚Äî soccer"});

  // Simulaci√≥n bot√≥n
  runSim.addEventListener("click", simulate);
})();
</script>
</body>
</html>
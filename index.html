<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rentabilidad Mercados</title>
<style>
  :root{
    --bg:#0a0f1c; --card:#121826; --panel:#1a2333; --text:#e5e7eb;
    --green:#10b981; --red:#ef4444; --line:#263143;
  }
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px}
  h1{text-align:center;margin:12px 0}
  .card{background:var(--card);border-radius:14px;padding:16px;margin:16px 0}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--line)}
  th{background:#0f1726;color:#cbd5e1}
  tr:last-child td{border-bottom:0}
  button{margin-top:10px;padding:10px;border:none;border-radius:10px;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer}
</style>
</head>
<body>
  <h1>Rentabilidad de Mercados</h1>
  <div class="card">
    <input type="file" id="fileInput" accept=".json,.txt">
    <div id="results"></div>
  </div>

<script>
let rawMatches = [];

function tryParseJSON(text){
  try { return JSON.parse(text); } catch(e){ return []; }
}

function toNum(v){ return (v==null||v==='')? null : Number(v); }

/* === Calcular PnL de cualquier mercado === */
function computeProfitability(matches){
  let total=0, hits=0, fails=0, considered=0, sumOdds=0;
  const details=[];

  matches.forEach((m,idx)=>{
    const market = m["Name"] || m["Desired Outcome"] || "—";
    const match  = m["Match"] || "—";
    const odd    = toNum(m["Odd"]);
    const result = (m["Result"]||"").toLowerCase();

    let pnl="—", hit="—";
    if(odd && odd>1){
      considered++;
      if(result.includes("win") || result.includes("✔")){
        hit="✔"; pnl=(odd-1); total+=pnl; hits++; sumOdds+=odd;
      }else if(result.includes("lose") || result.includes("✘")){
        hit="✘"; pnl=-1; total+=pnl; fails++; sumOdds+=odd;
      }
    }
    details.push({n:idx+1, market, match, odd, result, hit, pnl});
  });

  const avgOdd = considered? (sumOdds/considered).toFixed(2) : "—";
  const roi = considered? ((total/considered)*100).toFixed(1)+"%" : "—";

  return {details,total,hits,fails,considered,avgOdd,roi};
}

/* === Renderizar tabla + botón CSV === */
function renderPanel(res){
  const rows = res.details.map(d=>`
    <tr>
      <td>${d.n}</td>
      <td>${d.market}</td>
      <td>${d.match}</td>
      <td>${d.odd||""}</td>
      <td>${d.result}</td>
      <td>${d.hit}</td>
      <td style="color:${d.pnl>=0?'#10b981':'#ef4444'}">${d.pnl}</td>
    </tr>`).join("");

  const summary = `
    <div class="card">
      <h3>Resumen</h3>
      <table>
        <tr><th>Considerados</th><th>Hits</th><th>Fails</th><th>Odd media</th><th>Profit (u)</th><th>ROI</th></tr>
        <tr>
          <td>${res.considered}</td>
          <td>${res.hits}</td>
          <td>${res.fails}</td>
          <td>${res.avgOdd}</td>
          <td style="color:${res.total>=0?'#10b981':'#ef4444'}">${res.total.toFixed(2)}</td>
          <td style="color:${res.roi.includes('-')?'#ef4444':'#10b981'}">${res.roi}</td>
        </tr>
      </table>
    </div>`;

  return `
    <div class="card">
      <h3>Detalle de Apuestas</h3>
      <table>
        <tr><th>#</th><th>Mercado</th><th>Partido</th><th>Odd</th><th>Resultado</th><th>Hit</th><th>PnL</th></tr>
        ${rows}
      </table>
      ${summary}
      <button id="downloadCsvBtn">Descargar CSV</button>
    </div>`;
}

document.getElementById("fileInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const rd=new FileReader();
  rd.onload=ev=>{
    rawMatches=tryParseJSON(ev.target.result);
    if(!Array.isArray(rawMatches) || rawMatches.length===0){ alert("Archivo inválido"); return; }
    const res = computeProfitability(rawMatches);
    const html = renderPanel(res);
    document.getElementById("results").innerHTML=html;

    // Exportar CSV
    const csvRows=[["#","Mercado","Partido","Odd","Resultado","Hit","PnL"]];
    res.details.forEach(d=>csvRows.push([d.n,d.market,d.match,d.odd,d.result,d.hit,d.pnl]));
    csvRows.push([]);
    csvRows.push(["Resumen","Considerados","Hits","Fails","Odd media","Profit","ROI"]);
    csvRows.push(["",res.considered,res.hits,res.fails,res.avgOdd,res.total.toFixed(2),res.roi]);
    const csv = csvRows.map(r=>r.join(",")).join("\n");

    document.getElementById("downloadCsvBtn").onclick=()=>{
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="rentabilidad.csv";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
  };
  rd.readAsText(file);
});
</script>
</body>
</html>
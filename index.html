<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Wave | Professional Dashboard</title>
    <style>
        :root {
            --bg: #06090f;
            --card-bg: #0d1117;
            --border: #30363d;
            --accent: #58a6ff;
            --success: #238636;
            --text: #c9d1d9;
            --gold: #d29922;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        /* PANEL DE ENTRADA (IZQUIERDA) */
        .input-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }

        textarea {
            width: 100%; height: 80px; background: #161b22; border: 1px solid var(--border);
            border-radius: 6px; color: var(--accent); padding: 8px; font-family: monospace;
            font-size: 11px; margin-bottom: 10px; resize: none;
        }

        label { display: block; font-size: 12px; margin-bottom: 5px; color: #8b949e; text-transform: uppercase; }

        select { width: 100%; padding: 10px; background: #161b22; color: white; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px; }

        button {
            width: 100%; padding: 15px; border-radius: 6px; border: none;
            background: var(--success); color: white; font-weight: bold; cursor: pointer;
            transition: 0.2s;
        }

        button:hover { filter: brightness(1.2); }

        /* PANEL DE RESULTADOS (DERECHA) */
        .main-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dash-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .dash-card h3 {
            margin-top: 0; font-size: 14px; color: var(--accent);
            border-bottom: 1px solid var(--border); padding-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .stat-row {
            display: flex; justify-content: space-between; padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .val { font-weight: bold; color: white; }

        .full-width { grid-column: 1 / -1; }

        /* MATRIZ DE MARCADORES */
        .score-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px;
        }

        .score-box {
            background: #161b22; border: 1px solid var(--border); padding: 10px;
            border-radius: 6px; text-align: center;
        }

        .score-box small { display: block; color: #8b949e; font-size: 10px; }
        .score-box b { color: var(--gold); }

        #audit-step { font-family: monospace; font-size: 11px; color: #8b949e; background: #000; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="input-panel">
        <h2 style="margin-top:0; color:white">Crystal Wave</h2>
        
        <label>Home Table Data</label>
        <textarea id="homeIn" oninput="updateH()"></textarea>
        
        <label>Away Table Data</label>
        <textarea id="awayIn" oninput="updateV()"></textarea>
        
        <label>League Statistics</label>
        <textarea id="statIn" oninput="updateS()"></textarea>

        <label>Partido</label>
        <select id="selH"></select>
        <select id="selV"></select>

        <button onclick="runAnalysis()">ANALIZAR DASHBOARD</button>

        <div style="margin-top:20px">
            <label>Auditoría de xG</label>
            <div id="audit-step">Esperando...</div>
        </div>
    </div>

    <div class="main-display" id="dashView" style="display:none">
        
        <div class="dash-card">
            <h3>Resultado Final (1X2)</h3>
            <div class="stat-row"><span>Victoria Local</span><span class="val" id="resH"></span></div>
            <div class="stat-row"><span>Empate</span><span class="val" id="resD"></span></div>
            <div class="stat-row"><span>Victoria Visita</span><span class="val" id="resV"></span></div>
            <div class="stat-row"><span>Doble Op. 1X</span><span class="val" id="res1X"></span></div>
        </div>

        <div class="dash-card">
            <h3>Mercado de Goles</h3>
            <div class="stat-row"><span>Más de 1.5</span><span class="val" id="ov15"></span></div>
            <div class="stat-row"><span>Más de 2.5</span><span class="val" id="ov25"></span></div>
            <div class="stat-row"><span>Ambos Marcan</span><span class="val" id="btts"></span></div>
            <div class="stat-row"><span>Expectativa Total</span><span class="val" id="totalXG"></span></div>
        </div>

        <div class="dash-card">
            <h3>Handicaps Asiáticos (L)</h3>
            <div class="stat-row"><span>Handicap -0.5</span><span class="val" id="hcap1"></span></div>
            <div class="stat-row"><span>Handicap +0.5</span><span class="val" id="hcap2"></span></div>
            <div class="stat-row"><span>Handicap +1.5</span><span class="val" id="hcap3"></span></div>
        </div>

        <div class="dash-card full-width">
            <h3>Top 10 Marcadores Correctos</h3>
            <div class="score-grid" id="scoreGrid"></div>
        </div>

    </div>
</div>

<script>
    let dbH = {}, dbV = {}, avgH = 1.58, avgV = 1.22;

    function extract(text) {
        const teams = {};
        text.split('\n').forEach(l => {
            const m = l.trim().match(/^(\d+)\s+(.+?)\s+(\d+)\s+\d+\s+\d+\s+\d+\s+(\d+)\s+(\d+)/);
            if (m) {
                const gp = parseInt(m[3]);
                teams[m[2].trim()] = { gf: parseInt(m[4])/gp, ga: parseInt(m[5])/gp };
            }
        });
        return teams;
    }

    function updateH() { dbH = extract(document.getElementById('homeIn').value); fill(); }
    function updateV() { dbV = extract(document.getElementById('awayIn').value); fill(); }
    function updateS() {
        const t = document.getElementById('statIn').value;
        const hm = t.match(/Home goals per match:\s*([\d.]+)/);
        const am = t.match(/Away goals per match:\s*([\d.]+)/);
        if(hm) avgH = parseFloat(hm[1]);
        if(am) avgV = parseFloat(am[1]);
    }

    function fill() {
        const sH = document.getElementById('selH'); const sV = document.getElementById('selV');
        sH.innerHTML = ""; sV.innerHTML = "";
        Object.keys(dbH).sort().forEach(t => sH.add(new Option(t, t)));
        Object.keys(dbV).sort().forEach(t => sV.add(new Option(t, t)));
    }

    function poisson(k, l) {
        let fact = 1; for(let i=2; i<=k; i++) fact *= i;
        return (Math.pow(l, k) * Math.exp(-l)) / fact;
    }

    function runAnalysis() {
        const tH = document.getElementById('selH').value;
        const tV = document.getElementById('selV').value;
        if(!dbH[tH] || !dbV[tV]) return;

        const xGH = (dbH[tH].gf / avgH) * (dbV[tV].ga / avgH) * avgH;
        const xGV = (dbV[tV].gf / avgV) * (dbH[tH].ga / avgV) * avgV;

        document.getElementById('audit-step').innerHTML = `xG L: ${xGH.toFixed(2)}<br>xG V: ${xGV.toFixed(2)}`;

        let pH=0, pD=0, pV=0, o15=0, o25=0, scores=[];

        for(let i=0; i<=20; i++) {
            for(let j=0; j<=20; j++) {
                let p = poisson(i, xGH) * poisson(j, xGV);
                if(i > j) pH += p; else if(i === j) pD += p; else pV += p;
                if(i + j > 1.5) o15 += p;
                if(i + j > 2.5) o25 += p;
                if(i <= 5 && j <= 5) scores.push({ s: `${i}-${j}`, p: p });
            }
        }

        // UI Update
        document.getElementById('dashView').style.display = "grid";
        document.getElementById('resH').innerText = (pH*100).toFixed(1) + "%";
        document.getElementById('resD').innerText = (pD*100).toFixed(1) + "%";
        document.getElementById('resV').innerText = (pV*100).toFixed(1) + "%";
        document.getElementById('res1X').innerText = ((pH+pD)*100).toFixed(1) + "%";
        
        document.getElementById('ov15').innerText = (o15*100).toFixed(1) + "%";
        document.getElementById('ov25').innerText = (o25*100).toFixed(1) + "%";
        document.getElementById('btts').innerText = ((1-poisson(0,xGH))*(1-poisson(0,xGV))*100).toFixed(1) + "%";
        document.getElementById('totalXG').innerText = (xGH+xGV).toFixed(2);

        document.getElementById('hcap1').innerText = (pH*100).toFixed(1) + "%";
        document.getElementById('hcap2').innerText = ((pH+pD)*100).toFixed(1) + "%";
        document.getElementById('hcap3').innerText = ((pH+pD + (pV * poisson(j=i-1, xGV) ) )*100).toFixed(1) + "%"; // Simplificado para Dashboard

        // Marcadores
        scores.sort((a,b) => b.p - a.p);
        let sHtml = "";
        scores.slice(0, 10).forEach(x => {
            sHtml += `<div class="score-box"><small>${x.s}</small><b>${(x.p*100).toFixed(1)}%</b></div>`;
        });
        document.getElementById('scoreGrid').innerHTML = sHtml;
    }
</script>
</body>
</html>

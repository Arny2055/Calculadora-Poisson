<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Poisson de Apuestas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #121212;
      color: #f0f0f0;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: #1e1e1e;
      padding: 20px 30px 30px 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 20, 0.7);
    }

    h2 {
      text-align: center;
      color: #ffffff;
      margin-top: 0;
      font-weight: 700;
      letter-spacing: 1.2px;
    }

    .logo {
      display: block;
      margin: 0 auto 20px auto;
      width: 100px;
      filter: drop-shadow(0 0 5px #39FF14);
    }

    input, button, select {
      padding: 8px;
      margin: 5px 10px 10px 0;
      font-size: 14px;
      background: #2c2c2c;
      color: #f0f0f0;
      border: 1px solid #444;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    input::placeholder {
      color: #aaa;
    }

    button:hover {
      background-color: #39FF14;
      color: #000;
      cursor: pointer;
      border-color: #39FF14;
      font-weight: 700;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 20px;
      color: #f0f0f0;
    }

    th, td {
      padding: 6px;
      border: 1px solid #333;
      text-align: center;
    }

    th {
      background: #2a2a2a;
    }

    td {
      background: #222;
    }

    .highlight {
      background-color: #39FF14 !important;
      font-weight: 900;
      color: #000 !important;
    }

    .small-input {
      width: 60px;
      background: #2c2c2c;
      color: #f0f0f0;
      border: 1px solid #444;
      border-radius: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://cdn-icons-png.flaticon.com/512/287/287221.png" alt="Logo FÃºtbol" class="logo" />
    <h2>Calculadora Poisson de Apuestas</h2>

    <button onclick="window.location.href='historial.html'">Ver historial</button><br />
    <input type="text" id="nombreLocal" placeholder="Nombre equipo Local" style="width:200px" />
    <input type="number" id="golesLocal" placeholder="Promedio Local" step="0.01" />
    <input type="text" id="nombreVisita" placeholder="Nombre equipo Visitante" style="width:200px" />
    <input type="number" id="golesVisita" placeholder="Promedio Visita" step="0.01" /><br />
    <input type="number" id="bankroll" placeholder="Bankroll ($)" step="0.01" style="width:120px" value="100" />
    <button onclick="calcular()">Calcular</button>
    <button onclick="agregarAlHistorial()">Agregar al historial</button>
    <button onclick="exportarHistorial()">Exportar historial</button>
    <button onclick="borrarHistorial()">Borrar historial</button><br />

    <label>
      <input type="checkbox" id="toggleEV" onchange="calcular()" /> Mostrar Valor Esperado (EV) y Kelly
    </label>
    <label for="kellyFrac"> Kelly fraccional:</label>
    <select id="kellyFrac" onchange="calcular()">
      <option value="0.05">5%</option>
      <option value="0.10">10%</option>
      <option value="0.15">15%</option>
      <option value="0.20">20%</option>
      <option value="0.25" selected>25%</option>
      <option value="0.30">30%</option>
      <option value="0.40">40%</option>
    </select>

    <div id="resultado"></div>
  </div>

  <script>
    function factorial(n) {
      if (n === 0 || n === 1) return 1;
      let res = 1;
      for (let i = 2; i <= n; i++) res *= i;
      return res;
    }

    function poisson(k, lambda) {
      return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }

    function cuotaImplicita(p) { return p > 0 ? (1 / p).toFixed(2) : "-"; }
    function valueBet(prob, cuota) { return ((prob * cuota) - 1).toFixed(2); }
    function kelly(prob, cuota, fraction = 1) {
      const raw = ((cuota - 1) * prob - (1 - prob)) / (cuota - 1);
      return raw > 0 ? raw * fraction : 0;
    }

    let cuotasGuardadas = {};
    let exportData = [];

    function calcular() {
      const nombreLocal = document.getElementById("nombreLocal").value.trim();
      const nombreVisita = document.getElementById("nombreVisita").value.trim();
      const lambdaL = parseFloat(document.getElementById("golesLocal").value);
      const lambdaV = parseFloat(document.getElementById("golesVisita").value);
      const showEV = document.getElementById("toggleEV").checked;
      const kellyFrac = parseFloat(document.getElementById("kellyFrac").value);
      const bankroll = parseFloat(document.getElementById("bankroll").value);

      if (!nombreLocal || !nombreVisita || isNaN(lambdaL) || isNaN(lambdaV) || isNaN(bankroll) || bankroll <= 0) {
        alert("Por favor, completa todos los campos correctamente.");
        return;
      }

      const maxGoals = 5;
      const pLocal = Array.from({ length: maxGoals + 1 }, (_, i) => poisson(i, lambdaL));
      const pVisita = Array.from({ length: maxGoals + 1 }, (_, i) => poisson(i, lambdaV));
      const joint = Array.from({ length: maxGoals + 1 }, () => Array(maxGoals + 1).fill(0));

      for (let i = 0; i <= maxGoals; i++) {
        for (let j = 0; j <= maxGoals; j++) joint[i][j] = pLocal[i] * pVisita[j];
      }

      // 1X2
      let winL = 0, draw = 0, winV = 0;
      for (let i = 0; i <= maxGoals; i++) {
        for (let j = 0; j <= maxGoals; j++) {
          if (i > j) winL += joint[i][j];
          else if (i === j) draw += joint[i][j];
          else winV += joint[i][j];
        }
      }
      const prob1x2 = [winL, draw, winV];
      const max1x2 = Math.max(...prob1x2);

      // Over/Under
      const thresholds = [0.5, 1.5, 2.5, 3.5];
      const under = Object.fromEntries(thresholds.map(t => [t, 0]));
      for (let i = 0; i <= maxGoals; i++) {
        for (let j = 0; j <= maxGoals; j++) {
          const total = i + j;
          thresholds.forEach(th => { if (total <= th) under[th] += joint[i][j]; });
        }
      }
      const overs = thresholds.map(t => 1 - under[t]);
      const maxOver = Math.max(...overs);

      // Ambos anotan
      let btts = 0;
      for (let i = 1; i <= maxGoals; i++) {
        for (let j = 1; j <= maxGoals; j++) btts += joint[i][j];
      }

      exportData = [];
      let html = `<table>
        <tr><th>Grupo</th><th>OpciÃ³n</th><th>Prob (%)</th><th>Cuota ImplÃ­cita</th>
        ${showEV ? `<th>Cuota Bookie</th><th>EV</th><th>Kelly (${kellyFrac*100}%)</th><th>Apostar ($)</th>` : ""}
        </tr>`;

      const filas = [
        ["1X2 âš½", [nombreLocal, "Empate", nombreVisita], prob1x2, max1x2],
        ["Over/Under ðŸŽ¯", thresholds.map(t => `Over ${t}`), overs, maxOver],
        ["Ambos Anotan ðŸ””", ["SÃ­"], [btts], btts],
      ];

      filas.forEach(([grupo, labels, probs, max], grupoIndex) => {
        labels.forEach((label, idx) => {
          const p = probs[idx];
          const isMax = p === max ? "highlight" : "";
          const id = `bookie_${grupoIndex}_${idx}`;
          const cuotaGuardada = cuotasGuardadas[id] || "";

          let row = `<tr class="${isMax}">
            <td class="${isMax}">${grupo}</td>
            <td class="${isMax}">${label}</td>
            <td class="${isMax}">${(p * 100).toFixed(2)}</td>
            <td class="${isMax}">${cuotaImplicita(p)}</td>`;

          if (showEV) {
            row += `<td>
              <input type="text" inputmode="decimal" class="small-input"
              id="${id}" value="${cuotaGuardada}"
              oninput="cuotasGuardadas['${id}'] = this.value.replace(',', '.');"
              onblur="calcular()"
              onkeydown="if(event.key==='Enter'){this.blur();}">
            </td>`;

            const cuotaBookie = parseFloat(cuotasGuardadas[id]);
            const ev = !isNaN(cuotaBookie) ? valueBet(p, cuotaBookie) : "-";
            const k = !isNaN(cuotaBookie) ? kelly(p, cuotaBookie, kellyFrac) : 0;
            const apuesta = k > 0 ? (bankroll * k).toFixed(2) : "-";

            const evClass = (!isNaN(ev) && ev > 0) ? "highlight" : "";
            const kellyClass = (k > 0) ? "highlight" : "";

            row += `<td class="${evClass}">${ev}</td>
                    <td class="${kellyClass}">${(k * 100).toFixed(1)}%</td>
                    <td class="${kellyClass}">${apuesta}</td>`;

            if (!isNaN(cuotaBookie)) {
              exportData.push([grupo, label, (p*100).toFixed(2), cuotaBookie, ev, (k*100).toFixed(1)+"%", apuesta, nombreLocal, nombreVisita]);
            }
          }
          row += "</tr>";
          html += row;
        });
        html += `<tr><td colspan="9" style="height:8px; background:#121212; border:none"></td></tr>`;
      });

      document.getElementById("resultado").innerHTML = html;
    }

    function agregarAlHistorial() {
      calcular();
      if (!exportData || exportData.length === 0) return alert("No hay mercados con cuota de la bookie para agregar.");
      let historial = JSON.parse(localStorage.getItem("poissonHistorial")) || [];
      exportData.forEach((row) => historial.push(row));
      localStorage.setItem("poissonHistorial", JSON.stringify(historial));
      alert("Mercados agregados al historial.");
    }

    function exportarHistorial() {
      let historial = JSON.parse(localStorage.getItem("poissonHistorial")) || [];
      if (historial.length === 0) return alert("No hay historial para exportar.");
      let csv = "Grupo,OpciÃ³n,Prob %,Cuota Bookie,EV,Kelly %,Apostar $,Local,Visitante\n";
      historial.forEach((row) => { csv += row.join(",") + "\n"; });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "historial_poisson.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function borrarHistorial() {
      if (confirm("Â¿Seguro quieres borrar todo el historial guardado?")) {
        localStorage.removeItem("poissonHistorial");
        alert("Historial borrado.");
      }
    }
  </script>
</body>
</html>
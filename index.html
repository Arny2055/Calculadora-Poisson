<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Poisson Simple</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Paleta de Colores de Gemini (Limpios y Neutros con un toque de azul) */
        :root {
            --color-bg-primary: #ffffff;      /* Fondo principal blanco */
            --color-bg-secondary: #f0f4f9;    /* Fondo de tarjetas/inputs gris claro */
            --color-text-dark: #3c4043;       /* Texto oscuro principal */
            --color-text-muted: #5f6368;      /* Texto secundario */
            --color-highlight: #1a73e8;       /* Azul de Google para highlights y botones */
            --color-success: #34a853;         /* Verde para resultados clave */
            --color-border: #dadce0;          /* Borde sutil */
        }

        /* Estilos Generales */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--color-bg-secondary);
            color: var(--color-text-dark);
            line-height: 1.5;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: var(--color-bg-primary);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--color-border);
        }
        h1 {
            color: var(--color-highlight);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 700;
        }
        h2 {
            color: var(--color-text-dark);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 8px;
            margin-top: 25px;
            font-size: 1.4em;
            font-weight: 700;
        }

        /* Controles de Entrada */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 15px;
            background-color: var(--color-bg-secondary);
            border-radius: 6px;
        }
        label {
            display: block;
            margin-top: 8px;
            font-size: 0.9em;
            color: var(--color-text-muted);
        }
        input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            box-sizing: border-box;
            background-color: var(--color-bg-primary);
            color: var(--color-text-dark);
            font-size: 1em;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus {
            border-color: var(--color-highlight);
            outline: none;
        }

        /* Botón de Cálculo */
        button {
            background-color: var(--color-highlight);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            margin-top: 20px;
            width: 100%;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        button:hover {
            background-color: #1669e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Resultados Destacados (Lambdas) */
        .lambda-display {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px dashed var(--color-border);
        }
        .lambda-value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--color-text-dark);
        }
        .resultado {
            color: var(--color-success);
            font-weight: 700;
            margin-left: 5px;
        }

        /* Sección de Sugerencias */
        .suggestions-box {
            border: 2px solid var(--color-highlight);
            background-color: #f0f6ff; /* Un azul muy suave */
            padding: 20px;
            border-radius: 6px;
            margin-top: 25px;
            display: block; /* Siempre visible en esta versión simplificada */
        }
        .suggestions-box h2 {
            border-bottom: none;
            color: var(--color-highlight);
            margin-top: 0;
        }
        #suggested_markets p {
            font-size: 1em;
            margin: 10px 0;
            padding: 10px;
            background-color: var(--color-bg-primary);
            border-left: 4px solid var(--color-success);
            border-radius: 4px;
        }
        #suggested_markets .market-item {
            font-weight: 700;
            color: var(--color-highlight);
            margin-right: 5px;
        }
        .most-likely {
            background-color: #fffbe6 !important; /* Amarillo muy suave para destacar */
            border-left-color: #fbbc05 !important; /* Amarillo de Google */
        }
        .most-likely .market-item {
             color: #d94225; /* Un color cálido para el top */
        }

        /* Resultados Exactos (Lista) */
        .score-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .score-list li {
            padding: 8px;
            border-bottom: 1px dashed var(--color-border);
            font-size: 0.95em;
        }
        .score-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>📈 Calculadora de Proyecciones de Goles (Poisson)</h1>

    <div class="input-group">
        <h2>Parámetros de Entrada</h2>

        <div class="input-grid">
            <div>
                <label for="gl_l">Goles Promedio Local Liga ($\text{GL}_{\text{L}}$):</label>
                <input type="number" id="gl_l" value="1.5" step="0.01">
                <label for="gl_v">Goles Promedio Visitante Liga ($\text{GL}_{\text{V}}$):</label>
                <input type="number" id="gl_v" value="1.2" step="0.01">
            </div>

            <div>
                <label for="gf_l">Goles a Favor Local (en casa):</label>
                <input type="number" id="gf_l" value="1.8" step="0.01">
                <label for="gc_l">Goles En Contra Local (en casa):</label>
                <input type="number" id="gc_l" value="0.9" step="0.01">
            </div>

            <div>
                <label for="gf_v">Goles a Favor Visitante (fuera):</label>
                <input type="number" id="gf_v" value="1.4" step="0.01">
                <label for="gc_v">Goles En Contra Visitante (fuera):</label>
                <input type="number" id="gc_v" value="1.3" step="0.01">
            </div>
        </div>
    </div>

    <button onclick="calcularPoisson()">Calcular Proyecciones 🚀</button>

    <div class="lambda-display">
        <div class="lambda-value">
            Lambda Local ($\lambda_{\text{L}}$): <span id="lambda_l" class="resultado">N/A</span>
        </div>
        <div class="lambda-value">
            Lambda Visitante ($\lambda_{\text{V}}$): <span id="lambda_v" class="resultado">N/A</span>
        </div>
    </div>

    <div id="suggestion_box" class="suggestions-box">
        <h2>🎯 Sugerencias de Mercados (60% - 70% Prob.)</h2>
        <div id="suggested_markets">
            <p>Pulsa el botón de cálculo para generar las sugerencias.</p>
        </div>
    </div>

    <div class="exact-scores">
        <h2>🥇 Top 5 Marcadores Exactos</h2>
        <ul id="top_scores" class="score-list">
            <li>N/A</li>
        </ul>
    </div>

</div>

<script>
    // --- Lógica Matemática y de Cálculo (Mantenida del original) ---

    // Rango de Probabilidad Deseado (60% a 70%)
    const MIN_PROB = 0.60;
    const MAX_PROB = 0.70;

    // Función Factorial
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }

    // Distribución de Poisson
    function poisson(k, lambda) {
        if (lambda <= 0) return 0;
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }
    
    // Función para formatear las probabilidades a porcentaje
    const formatP = (p) => isNaN(p) ? 'N/A' : (p * 100).toFixed(2) + '%';
    
    // Función para calcular la Cuota Implícita (1 / Probabilidad)
    const calculateOdd = (p) => p > 0 ? (1 / p).toFixed(2) : 'N/A';
    
    // Función para calcular la probabilidad acumulada P(Goles <= K)
    function p_under_k(k, p_cumulativa) {
        if (k < 0) return 0;
        const index = Math.floor(k);
        return p_cumulativa[index] || 0;
    }
    
    // Función principal de cálculo
    function calcularPoisson() {
        // 1. Obtener datos de entrada
        const GL_L = parseFloat(document.getElementById('gl_l').value); 
        const GL_V = parseFloat(document.getElementById('gl_v').value); 
        const GF_L = parseFloat(document.getElementById('gf_l').value); 
        const GC_L = parseFloat(document.getElementById('gc_l').value); 
        const GF_V = parseFloat(document.getElementById('gf_v').value); 
        const GC_V = parseFloat(document.getElementById('gc_v').value); 

        if (GL_L <= 0 || GL_V <= 0) {
            alert("Los promedios de goles de la liga deben ser mayores a 0 para calcular.");
            return;
        }

        // 2. Calcular Goles Esperados (Lambda)
        const FA_L = GF_L / GL_L; 
        const PD_V = GC_V / GL_L; 
        const FA_V = GF_V / GL_V; 
        const PD_L = GC_L / GL_V; 

        const lambda_L = FA_L * PD_V * GL_L;
        const lambda_V = FA_V * PD_L * GL_V;

        document.getElementById('lambda_l').textContent = lambda_L.toFixed(3);
        document.getElementById('lambda_v').textContent = lambda_V.toFixed(3);

        // 3. Crear la Matriz de Probabilidades (hasta 6 goles) y acumulados
        const MAX_GOALS = 6; 
        let p_1 = 0, p_x = 0, p_2 = 0; 
        let p_total_goles = {}; 
        let top_scores_list = []; 
        
        let p_local_cumulativa = [poisson(0, lambda_L)];
        let p_visitante_cumulativa = [poisson(0, lambda_V)];
        
        // Calcular matriz de P(gL, gV) y acumulados
        for (let i = 0; i <= MAX_GOALS; i++) { // Goles Local (gL)
            let p_gL = poisson(i, lambda_L);
            if (i > 0) p_local_cumulativa.push((p_local_cumulativa[i-1] || 0) + p_gL);
            
            for (let j = 0; j <= MAX_GOALS; j++) { // Goles Visitante (gV)
                let p_gV = poisson(j, lambda_V);
                if (i === 0 && j > 0) p_visitante_cumulativa.push((p_visitante_cumulativa[j-1] || 0) + p_gV);

                let p_score = p_gL * p_gV;
                top_scores_list.push({ score: `${i}-${j}`, prob: p_score });

                if (i > j) { p_1 += p_score; } 
                else if (i === j) { p_x += p_score; } 
                else { p_2 += p_score; }

                const total = i + j;
                p_total_goles[total] = (p_total_goles[total] || 0) + p_score;
            }
        }
        
        // Probabilidad acumulada total
        let p_total_cumulativa = [p_total_goles[0] || 0];
        for (let t = 1; t <= MAX_GOALS * 2; t++) {
             p_total_cumulativa.push((p_total_cumulativa[t-1] || 0) + (p_total_goles[t] || 0));
        }

        // 4. Ajustar 1X2 para que sume 100%
        const p_total_scores = p_1 + p_x + p_2;
        if (p_total_scores > 0) {
            const ratio = 1 / p_total_scores;
            p_1 *= ratio;
            p_x *= ratio;
            p_2 *= ratio;
        }

        // 5. Acumular y Calcular Mercados (Solo los necesarios para sugerencias)
        const p_1x = p_1 + p_x;
        const p_x2 = p_x + p_2;
        
        const p_0_0 = poisson(0, lambda_L) * poisson(0, lambda_V);
        const p_btts_no = poisson(0, lambda_L) + poisson(0, lambda_V) - p_0_0;
        const p_btts_yes = 1 - p_btts_no;

        const calc_under = (k) => p_total_cumulativa[k];
        const calc_over = (k) => 1 - calc_under(k);

        const calc_l_under = (k) => p_local_cumulativa[k];
        const calc_l_over = (k) => 1 - calc_l_under(k);
        const calc_v_under = (k) => p_visitante_cumulativa[k];
        const calc_v_over = (k) => 1 - calc_v_under(k);

        // 6. Almacenar resultados para la sugerencia
        const all_market_probs = [
            // 1X2, DO
            { name: "1 (Victoria Local)", prob: p_1 },
            { name: "X (Empate)", prob: p_x },
            { name: "2 (Victoria Visitante)", prob: p_2 },
            { name: "Doble Opción 1X", prob: p_1x },
            { name: "Doble Opción X2", prob: p_x2 },
            // BTTS
            { name: "Ambos Anotan (Sí)", prob: p_btts_yes },
            { name: "Ambos Anotan (No)", prob: p_btts_no },
            // Over/Under Totales
            { name: "Over 1.5 Goles", prob: calc_over(1) },
            { name: "Under 1.5 Goles", prob: calc_under(1) },
            { name: "Over 2.5 Goles", prob: calc_over(2) },
            { name: "Under 2.5 Goles", prob: calc_under(2) },
            // Over/Under por Equipo
            { name: "Local Over 1.5 Goles", prob: calc_l_over(1) },
            { name: "Local Under 1.5 Goles", prob: calc_l_under(1) },
            { name: "Visitante Over 1.5 Goles", prob: calc_v_over(1) },
            { name: "Visitante Under 1.5 Goles", prob: calc_v_under(1) },
        ];


        // 7. Generar Sugerencias de Valor (60% - 70%)
        const suggested_markets = [];

        all_market_probs.forEach(market => {
            if (market.prob >= MIN_PROB && market.prob <= MAX_PROB) {
                suggested_markets.push({
                    name: market.name,
                    odd: parseFloat(calculateOdd(market.prob)),
                    prob: market.prob
                });
            }
        });

        const suggestions_div = document.getElementById('suggested_markets');
        if (suggested_markets.length > 0) {
            suggestions_div.innerHTML = '';
            
            suggested_markets.sort((a, b) => b.prob - a.prob);

            suggested_markets.forEach((s, index) => {
                const p = document.createElement('p');
                const implied_odd_range = `(Cuota Implícita: ≈ ${s.odd.toFixed(2)})`;
                
                let market_name_html = s.name;
                
                // Marcar el más probable
                if (index === 0) {
                    p.classList.add('most-likely');
                    market_name_html = `✨ TOP VALOR: ${s.name}`; 
                }
                
                p.innerHTML = `<span class="market-item">${market_name_html}</span> | Probabilidad: <span class="resultado">${formatP(s.prob)}</span> ${implied_odd_range}`;
                suggestions_div.appendChild(p);
            });
        } else {
            suggestions_div.innerHTML = `<p style="color: var(--color-highlight);">No se encontraron mercados con una probabilidad entre 60.0% y 70.0% (Cuota 1.43-1.67).</p>`;
        }
        
        // 8. Top 5 Resultados Exactos
        top_scores_list.sort((a, b) => b.prob - a.prob);
        const top_5 = top_scores_list.slice(0, 5);
        
        const top_scores_ul = document.getElementById('top_scores');
        top_scores_ul.innerHTML = ''; 
        top_5.forEach(item => {
            const li = document.createElement('li');
            const odd = calculateOdd(item.prob);
            li.innerHTML = `**${item.score}** - Probabilidad: <span class="resultado">${formatP(item.prob)}</span> (Cuota Implícita: ${odd})`;
            top_scores_ul.appendChild(li);
        });
    }

    // Ejecutar cálculo inicial para mostrar "N/A"
    document.addEventListener('DOMContentLoaded', calcularPoisson);
</script>

</body>
</html>

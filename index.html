<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Backtesting ROI por Equipo</title>
<style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    h2 { margin-top: 30px; }
    input[type="file"] { padding: 10px; }
    button { padding: 10px 20px; cursor: pointer; margin-top: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #eee; }
    #status { background: #222; color: white; padding: 10px; margin-top: 20px; }
</style>
</head>
<body>

<h1>Herramienta Backtesting ROI por Equipo</h1>

<h2>1. Cargar archivo HISTORIAL (JSON)</h2>
<input type="file" id="historialFile" accept=".json">

<h2>2. Cargar archivo PARTIDOS FUTUROS (JSON)</h2>
<input type="file" id="futurosFile" accept=".json">

<br><br>
<button onclick="runBacktesting()">HACER BACKTESTING</button>

<div id="status">Esperando archivos…</div>

<h2>Resultados</h2>
<table id="resultsTable">
    <thead>
        <tr>
            <th>Equipo</th>
            <th>Partidos encontrados</th>
            <th>Ganados</th>
            <th>Perdidos</th>
            <th>ROI (%)</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
let historial = [];
let futuros = [];

/* ----------------------- LECTURA DE ARCHIVOS ----------------------- */

document.getElementById("historialFile").addEventListener("change", function () {
    readJSONFile(this.files[0], data => {
        historial = Array.isArray(data) ? data : [data];
        document.getElementById("status").innerText = "Historial cargado con " + historial.length + " registros.";
    });
});

document.getElementById("futurosFile").addEventListener("change", function () {
    readJSONFile(this.files[0], data => {
        futuros = Array.isArray(data) ? data : [data];
        document.getElementById("status").innerText = "Partidos futuros cargados: " + futuros.length;
    });
});

function readJSONFile(file, callback) {
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const json = JSON.parse("[" + e.target.result.replace(/}\s*,\s*{/g, "},{") + "]");
            callback(json);
        } catch (err) {
            alert("Error leyendo el JSON: " + err);
        }
    };
    reader.readAsText(file);
}

/* ----------------------- BACKTESTING ----------------------- */

function runBacktesting() {
    if (historial.length === 0 || futuros.length === 0) {
        alert("Debes cargar ambos archivos primero.");
        return;
    }

    document.getElementById("status").innerText = "Procesando Backtesting…";

    let resultados = {}; // estructura: equipo → {games, wins, losses}

    futuros.forEach(match => {
        if (!match.Match) return;

        let [home, away] = match.Match.split(" - ").map(x => x.trim());

        analizarEquipo(home, historial, resultados);
        analizarEquipo(away, historial, resultados);
    });

    // Convertir a tabla computando ROI
    let tabla = Object.entries(resultados).map(([equipo, data]) => {
        let roi = ((data.wins * 1) - (data.losses * 1)) / data.games * 100;
        return {
            equipo,
            games: data.games,
            wins: data.wins,
            losses: data.losses,
            roi: roi.toFixed(2)
        };
    });

    // Ordenar por mayor ROI
    tabla.sort((a, b) => b.roi - a.roi);

    mostrarTabla(tabla);

    document.getElementById("status").innerText = "Backtesting finalizado ✔️";
}

function analizarEquipo(equipo, historial, resultados) {
    if (!resultados[equipo]) resultados[equipo] = {games: 0, wins: 0, losses: 0};

    historial.forEach(registro => {
        if (!registro.Match) return;

        let [h, a] = registro.Match.split(" - ").map(x => x.trim());

        if (equipo === h || equipo === a) {
            resultados[equipo].games++;

            if (registro.Result === "Winning") {
                resultados[equipo].wins++;
            } else {
                resultados[equipo].losses++;
            }
        }
    });
}

/* ----------------------- TABLA ----------------------- */

function mostrarTabla(data) {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.equipo}</td>
            <td>${row.games}</td>
            <td>${row.wins}</td>
            <td>${row.losses}</td>
            <td><b>${row.roi}%</b></td>
        `;
        tbody.appendChild(tr);
    });
}
</script>

</body>
</html>
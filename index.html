<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mantenimiento Automotriz ‚Äî Diagn√≥stico + Contramedidas + B√∫squeda Web</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140; --focus:#b9ccff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(15,17,21,.95), rgba(15,17,21,.65));border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
  .wrap{max-width:1280px;margin:0 auto;padding:14px}
  h1{margin:0 0 4px;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  button,.btn{background:var(--panel2);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  button:hover{border-color:var(--accent)}
  .btn-accent{background:var(--accent);color:#0b1020;border-color:transparent}
  .btn-ok{background:var(--ok);color:#0b1020;border-color:transparent}
  .btn-warn{background:var(--warn);color:#0b1020;border-color:transparent}
  .btn-danger{background:var(--danger);color:#0b1020;border-color:transparent}

  .layout{display:grid;grid-template-columns:330px 1fr;gap:16px;padding:16px}
  @media (max-width:1180px){.layout{grid-template-columns:1fr}}
  aside,section.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  h2{margin:0 0 8px;font-size:18px}
  h3{margin:12px 0 6px;font-size:16px}
  .grid{display:grid;gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .grid.three{grid-template-columns:repeat(3,1fr)}
  @media (max-width:980px){.grid.two,.grid.three{grid-template-columns:1fr}}

  /* Inputs (excluye chips y file) */
  input:not([type="file"]), select, textarea{
    width:100%; padding:10px 12px; background:#0c0f18; color:var(--text);
    border:1px solid var(--border); border-radius:10px; outline:none;
  }
  textarea{min-height:110px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px #b9ccff22}
  label{font-size:12px;color:var(--muted)}

  /* Chips */
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
    background:#0c0f18;border:1px solid var(--border);cursor:pointer;user-select:none;
    font-size:13px;line-height:1;
  }
  .chip input{display:none}
  .chip.active{background:#10192a;border-color:var(--focus);box-shadow:0 0 0 3px #b9ccff22 inset}
  .chip .dot{width:10px;height:10px;border-radius:50%;background:var(--muted)}
  .chip.active .dot{background:var(--accent)}

  /* Resultados web */
  .result{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0e1220;display:grid;gap:8px}
  .result h4{margin:0;font-size:15px}
  .result p{margin:0;color:#cdd5e0;font-size:13px}
  .result .rbar{display:flex;gap:6px;flex-wrap:wrap}

  .pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#101521;border:1px solid var(--border);color:var(--muted);font-size:12px}
  .badge{font-weight:800;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
  .ok{background:#102017;color:#b7ffcc} .warn{background:#261c09;color:#ffddaa} .danger{background:#281214;color:#ffbdbd}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;font-size:14px}
  th{background:#131824;color:var(--muted)}
  .row-actions{display:flex;gap:6px}
  footer{color:var(--muted);font-size:12px;padding:10px 16px 30px}
  @media print{header,.toolbar,.no-print{display:none!important} body{background:#fff;color:#000}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Mantenimiento Automotriz ‚Äî Diagn√≥stico & Contramedidas (con b√∫squeda web)</h1>
    <div class="sub">Chips ‚Üí motor de reglas ‚Üí FMEA/MTBF/MTTR + b√∫squeda web (Wikipedia / DuckDuckGo / Google-SerpAPI) para apoyar contramedidas definitivas</div>
    <div class="toolbar">
      <button id="btnSave" class="btn-accent">üíæ Guardar local</button>
      <button id="btnLoad">üì• Cargar local</button>
      <button id="btnExport">‚¨áÔ∏è Exportar JSON</button>
      <label class="btn no-print" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
        üì§ Importar JSON
        <input id="fileImport" type="file" accept="application/json" style="display:none">
      </label>
      <button id="btnPrint" class="btn-warn">üñ®Ô∏è PDF</button>
      <button id="btnNew" class="btn-danger">üßπ Nuevo</button>
    </div>
  </div>
</header>

<div class="layout wrap">
  <aside>
    <h2>Configuraci√≥n del caso</h2>
    <div class="grid two">
      <div><label>T√≠tulo</label><input id="title" placeholder="Ej: Falsos en sensor robot spot #3"></div>
      <div><label>L√≠nea/Equipo</label><input id="area" placeholder="Body Shop / Robot R3"></div>
      <div><label>Fecha</label><input id="date" type="date"></div>
      <div><label>Turno</label><select id="shift"><option>D√≠a</option><option>Noche</option></select></div>
      <div><label>Impacto (min, scrap, riesgo)</label><input id="impact" placeholder="Paro 28 min, retrabajo 6 pzs"></div>
      <div><label>Responsable</label><input id="owner" placeholder="Jefe de Mantenimiento"></div>
    </div>

    <h3 style="margin-top:10px">Tipo de equipo</h3>
    <select id="asset">
      <option value="robot_soldadura">Robot soldadura por puntos</option>
      <option value="prensa_mecanica">Prensa mec√°nica/hidr√°ulica</option>
      <option value="soldadura_mig">Soldadura MIG/MAG</option>
      <option value="transportador">Transportador/Conveyor</option>
      <option value="vfd_plc">VFD / PLC / I/O</option>
      <option value="inyeccion">Inyecci√≥n pl√°stica</option>
      <option value="cnc">CNC / Mecanizado</option>
      <option value="compresor">Compresor de aire</option>
      <option value="hvac">HVAC/Horno</option>
      <option value="vision">Visi√≥n/sensores</option>
    </select>

    <h3 style="margin-top:10px">S√≠ntomas</h3>
    <div id="symptoms" class="chips"></div>

    <h3 style="margin-top:10px">Contexto</h3>
    <div id="context" class="chips"></div>

    <div style="margin-top:8px">
      <label>Descripci√≥n breve</label>
      <textarea id="desc" placeholder="¬øQu√© pas√≥? ¬øD√≥nde? ¬øCon qu√© frecuencia? Cambios recientes, clima, proveedor, setup, etc."></textarea>
    </div>

    <h3 style="margin-top:12px">B√∫squeda web (soporte a contramedidas)</h3>
    <div class="grid two">
      <div>
        <label>Proveedor</label>
        <select id="provider">
          <option value="wikipedia">Wikipedia (sin clave)</option>
          <option value="duck">DuckDuckGo (sugerencias)</option>
          <option value="serpapi">Google (SerpAPI - requiere API key)</option>
        </select>
      </div>
      <div>
        <label>Idioma/Pa√≠s (SerpAPI opcional)</label>
        <div class="grid two">
          <input id="hl" placeholder="hl=es (idioma)">
          <input id="gl" placeholder="gl=mx (pa√≠s)">
        </div>
      </div>
    </div>
    <div class="grid two" style="margin-top:6px">
      <div>
        <label>API Key (solo SerpAPI)</label>
        <input id="serpKey" placeholder="tu_serpapi_key">
      </div>
      <div>
        <label>Consulta</label>
        <input id="q" placeholder="ej. contramedidas EMI cableado sensor IP67 robot">
      </div>
    </div>
    <div class="toolbar" style="margin-top:8px">
      <button id="btnSearch">üîé Buscar</button>
      <span class="pill">Tip: combina ‚Äúequipo + s√≠ntoma + causa + est√°ndar‚Äù</span>
    </div>
    <div id="webResults" style="display:grid;gap:8px;margin-top:10px"></div>
  </aside>

  <main>
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2>Motor de recomendaciones</h2>
        <div class="toolbar">
          <button id="btnSuggest" class="btn-ok">üß† Generar contramedidas</button>
        </div>
      </div>

      <div class="grid three" style="margin-top:6px">
        <div>
          <h3>Acciones inmediatas (contenci√≥n)</h3>
          <ul id="actInmediatas"></ul>
        </div>
        <div>
          <h3>Acciones correctivas (causa ra√≠z)</h3>
          <ul id="actCorrectivas"></ul>
        </div>
        <div>
          <h3>Contramedidas definitivas (permanentes)</h3>
          <ul id="actDefinitivas"></ul>
        </div>
      </div>

      <h3 style="margin-top:10px">Checklist de ejecuci√≥n</h3>
      <table id="checkTable">
        <thead><tr><th>Tarea</th><th>Resp.</th><th>Fecha</th><th>Estatus</th><th>Acc.</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="justify-content:flex-end;margin-top:6px">
        <button id="addCheck">‚ûï Agregar tarea</button>
        <button id="clearCheck">üßπ Limpiar</button>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Mini-FMEA (S-O-D y RPN)</h2>
      <div class="grid three">
        <div><label>Modo de falla</label><input id="fmeaMode" placeholder="Ej: falsos por EMI"></div>
        <div><label>Efecto</label><input id="fmeaEffect" placeholder="Paro / rechazo / seguridad"></div>
        <div><label>Causa</label><input id="fmeaCause" placeholder="Desalineo / EMI / desgaste / fuga"></div>
      </div>
      <div class="grid three" style="margin-top:6px">
        <div><label>S (1‚Äì10)</label><input id="fmeaS" type="number" min="1" max="10" value="7"></div>
        <div><label>O (1‚Äì10)</label><input id="fmeaO" type="number" min="1" max="10" value="6"></div>
        <div><label>D (1‚Äì10)</label><input id="fmeaD" type="number" min="1" max="10" value="6"></div>
      </div>
      <div style="margin-top:8px"><span id="rpnBadge" class="badge">RPN: ‚Äî</span></div>
      <div class="grid two" style="margin-top:8px">
        <div>
          <h3>Ideas para bajar RPN</h3>
          <ul id="fmeaTips"></ul>
        </div>
        <div>
          <label>Acciones FMEA</label>
          <textarea id="fmeaActions" placeholder="Reducir S (dise√±o), O (proceso), D (detecci√≥n)‚Ä¶"></textarea>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Resultados r√°pidos (MTTR/MTBF)</h2>
      <div class="grid three">
        <div><label>Fallos en el periodo</label><input id="nFails" type="number" min="0" value="1"></div>
        <div><label>Horas de operaci√≥n</label><input id="opHours" type="number" min="0" value="160"></div>
        <div><label>Minutos totales de paro</label><input id="downMins" type="number" min="0" value="45"></div>
      </div>
      <div style="margin-top:8px">
        <span id="mttrBadge" class="badge">MTTR: ‚Äî</span>
        <span id="mtbfBadge" class="badge">MTBF: ‚Äî</span>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h2>Resumen CAPA / A3</h2>
        <button id="btnResumen" class="btn">üìù Generar resumen</button>
      </div>
      <textarea id="resumen" style="min-height:240px" placeholder="Resumen listo para tu sistema CAPA/A3"></textarea>
    </section>
  </main>
</div>

<footer class="wrap">
  Hecho para Mantenimiento (Automotriz). Chips + buscador web. Guarda local, exporta JSON o imprime a PDF.
</footer>

<script>
  /* ===================== Datos base ===================== */
  const stateKey='auto_maint_helper_v2_chips_web';

  const SYMPTOMS = [
    {id:'no_detecta', label:'No detecta / sin se√±al'},
    {id:'intermitente', label:'Intermitente / falsos'},
    {id:'fuerza_baja', label:'Fuerza insuficiente (cilindro/prensa)'},
    {id:'carrera_incompleta', label:'Carrera incompleta / atoro'},
    {id:'fuga', label:'Fuga (aire/aceite)'},
    {id:'sobretemp', label:'Sobretemperatura'},
    {id:'sobreconsumo', label:'Sobrecorriente / sobreconsumo'},
    {id:'vibracion', label:'Vibraci√≥n / ruido anormal'},
    {id:'desalineo', label:'Desalineo / holgura'},
    {id:'fallo_io', label:'Fallo I/O PLC / comunicaci√≥n'},
    {id:'emi', label:'EMI / ruido el√©ctrico'},
    {id:'contaminacion', label:'Contaminaci√≥n (rebaba/aceite/agua)'},
    {id:'desgaste', label:'Desgaste consumible (electrodos/boquillas)'},
  ];

  const CONTEXT = [
    {id:'cambio_reciente', label:'Cambio reciente de componente/ajuste'},
    {id:'mantenimiento_reciente', label:'Mantenimiento reciente'},
    {id:'proveedor_nuevo', label:'Proveedor/material nuevo'},
    {id:'ambiente_humedo', label:'H√∫medo/lavado'},
    {id:'alta_temp', label:'Alta temperatura'},
    {id:'alta_vibracion', label:'Alta vibraci√≥n/golpes'},
    {id:'cables_potencia', label:'Cables potencia cercanos/VFD'},
    {id:'turno_noche', label:'Solo ocurre en noche'},
    {id:'post_setup', label:'Inmediatamente tras setup'},
  ];

  const RULES = [
    { asset:'robot_soldadura', ifAny:['intermitente','emi','fallo_io'], ctxAny:['cables_potencia','alta_vibracion','post_setup'], defScore:5,
      acciones:{ inmediata:['Revisar continuidad en pinzas y retorno; ciclo vac√≠o.','Separar mazos se√±al/potencia; revisar M12.'],
                 correctiva:['A√±adir ferritas/filtros EMI; tierra √∫nica.','Ajustar debounce/antirrebote en PLC/robot.'],
                 definitiva:['Re-ruteo segregado con blindaje integral (ECR).','Doble verificaci√≥n de pieza (redundancia + ventana).','Checklist EMC + torque con auditor√≠a mensual.'] } },
    { asset:'robot_soldadura', ifAny:['desgaste','fuerza_baja','carrera_incompleta'], ctxAny:['mantenimiento_reciente','post_setup'], defScore:4,
      acciones:{ inmediata:['Redress de cables; revisar enfriamiento.','Cambio de electrodos / presi√≥n.'],
                 correctiva:['Recalibrar servo/presi√≥n.','Mangueras flexibles en zonas de giro.'],
                 definitiva:['Estandarizar vida de consumibles (contador de piezas).','Poka-yoke de electrodos y BOM √∫nica.'] } },
    { asset:'prensa_mecanica', ifAny:['fuga','fuerza_baja','vibracion'], ctxAny:['alta_vibracion'], defScore:5,
      acciones:{ inmediata:['Verificar niveles/fugas; paro seguro.','Medir presi√≥n/caudal; inspecci√≥n de v√°lvulas.'],
                 correctiva:['Cambiar sellos/valvuler√≠a; limpiar filtros; alinear gu√≠as.'],
                 definitiva:['Upgrade de sellos y filtraci√≥n fina + monitoreo.','Bloqueo de par√°metros y plan de recalibraci√≥n.'] } },
    { asset:'transportador', ifAny:['carrera_incompleta','sobreconsumo','vibracion'], ctxAny:['contaminacion','post_setup'], defScore:4,
      acciones:{ inmediata:['Limpiar/tensar banda; revisar poleas.','Medir corriente y fricci√≥n.'],
                 correctiva:['Alinear cama/poleas; cambiar rodillos.'],
                 definitiva:['Cojinetes sellados/auto-alineables + protector anti-rebaba.','Estandarizar tensi√≥n con dinam√≥metro.'] } },
    { asset:'vfd_plc', ifAny:['fallo_io','emi','intermitente','sobreconsumo'], ctxAny:['cables_potencia','post_setup','alta_vibracion'], defScore:5,
      acciones:{ inmediata:['Revisar tierra/PE y pantallas; segregar rutas.','Verificar VFD (rampa/carrier) y filtros.'],
                 correctiva:['Filtros EMC (l√≠nea/motor), ferritas, reactores; earthing √∫nico.'],
                 definitiva:['Arquitectura de cableado segregada (norma) + ductos dedicados.','Diagn√≥stico predictivo en PLC con dashboard.'] } },
    { asset:'inyeccion', ifAny:['sobretemp','fuga','intermitente'], ctxAny:['ambiente_humedo','alta_temp'], defScore:4,
      acciones:{ inmediata:['Revisar enfriamiento, termopares y presiones.'],
                 correctiva:['Reemplazar sellos/termopares; balancear agua.'],
                 definitiva:['Mapa de setpoints + sensores redundantes.','Sellado IP y deflectores.'] } },
    { asset:'cnc', ifAny:['contaminacion','desalineo','vibracion'], ctxAny:['post_setup','alta_vibracion'], defScore:4,
      acciones:{ inmediata:['Limpieza de viruta/gu√≠as; referencias y aprietes.'],
                 correctiva:['Realinear husillos/gu√≠as; recalibraci√≥n.'],
                 definitiva:['Deflectores anti-viruta + extracci√≥n; verificaci√≥n diaria de geometr√≠a.','Plantillas de alineaci√≥n y torque (control de cambios).'] } },
    { asset:'compresor', ifAny:['fuga','sobretemp','vibracion'], ctxAny:['ambiente_humedo','alta_temp'], defScore:4,
      acciones:{ inmediata:['Revisar filtros/aceite; purgar drenajes; correas.'],
                 correctiva:['Cambiar filtros/aceite; ventilaci√≥n; alinear acople.'],
                 definitiva:['Filtraci√≥n + secador dimensionado; monitoreo dew point.','Programa de fugas con % KPI.'] } },
    { asset:'hvac', ifAny:['sobretemp','intermitente','falla_io'], ctxAny:['ambiente_humedo','alta_temp'], defScore:3,
      acciones:{ inmediata:['Comprobar sensores/limit; limpiar filtros.'],
                 correctiva:['Calibrar sensores; revisar motores/flujo.'],
                 definitiva:['Redundancia sensores cr√≠ticos + PM por condici√≥n + tendencias.'] } },
    { asset:'vision', ifAny:['no_detecta','intermitente','contaminacion','emi'], ctxAny:['cables_potencia','ambiente_humedo','post_setup'], defScore:5,
      acciones:{ inmediata:['Limpiar √≥pticas; enfoque/ganancia; conectores.'],
                 correctiva:['Filtros √≥pticos; capuchones IP; ferritas; rutas segregadas.'],
                 definitiva:['Iluminaci√≥n controlada; housing IP69K; fuente aislada; GR&R peri√≥dico.'] } },
  ];

  /* ===================== Utilidades UI ===================== */
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',background:'#111725',color:'#e6eaf2',padding:'10px 12px',border:'1px solid var(--border)',borderRadius:'10px',zIndex:9999});
    document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
  }

  function renderChips(container, items){
    container.innerHTML='';
    items.forEach(it=>{
      const chip=document.createElement('label');
      chip.className='chip'; chip.setAttribute('data-id', it.id);
      chip.innerHTML=`<span class="dot"></span><span>${it.label}</span>`;
      chip.addEventListener('click', e=>{
        chip.classList.toggle('active');
      });
      container.appendChild(chip);
    });
  }
  function getSelectedChips(container){
    return Array.from(container.querySelectorAll('.chip.active')).map(c=>c.getAttribute('data-id'));
  }

  /* ===================== Motor de reglas ===================== */
  function runEngine(){
    const asset = $('#asset').value;
    const sSel = getSelectedChips($('#symptoms'));
    const cSel = getSelectedChips($('#context'));

    const matched = RULES.filter(r=> r.asset===asset && r.ifAny.some(id=>sSel.includes(id)) && (r.ctxAny? r.ctxAny.some(id=>cSel.includes(id)) : true))
                         .sort((a,b)=> (b.defScore||0)-(a.defScore||0));

    const out = {inmediatas:[],correctivas:[],definitivas:[]};
    matched.forEach(m=>{
      out.inmediatas.push(...m.acciones.inmediata);
      out.correctivas.push(...m.acciones.correctiva);
      out.definitivas.push(...m.acciones.definitiva);
    });

    out.definitivas.push(...suggestUniversalDefs(asset, sSel, cSel));

    const uniq = arr => [...new Set(arr)];
    renderList('#actInmediatas', uniq(out.inmediatas));
    renderList('#actCorrectivas', uniq(out.correctivas));
    renderList('#actDefinitivas', uniq(out.definitivas));

    $('#checkTable tbody').innerHTML='';
    uniq(out.inmediatas).slice(0,3).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));
    uniq(out.correctivas).slice(0,3).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));
    uniq(out.definitivas).slice(0,2).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));

    toast('Contramedidas generadas');
  }
  function suggestUniversalDefs(asset, sSel, cSel){
    const defs = [
      'Poka-yoke/guardado permanente para impedir reposicionamiento indebido.',
      'Estandarizar instalaci√≥n (torques, rutas, plantillas) + control de cambios (ECR/ECO).',
      'Actualizar BOM con especificaci√≥n superior (IP/EMC/temperatura) y vida √∫til definida.',
      'Monitoreo de condici√≥n (vibraci√≥n/temp/corriente) con alarmas.',
      'Capacitaci√≥n y certificaci√≥n de montaje/ajuste por turno.',
    ];
    if(['vision','robot_soldadura','vfd_plc','hvac'].includes(asset)) defs.push('Redundancia en sensores cr√≠ticos y validaci√≥n 2oo2.');
    if(sSel.includes('emi') || cSel.includes('cables_potencia')) defs.push('Arquitectura EMC definitiva: rutas segregadas, blindajes continuos, tierra √∫nica, filtros normalizados.');
    if(sSel.includes('contaminacion') || cSel.includes('ambiente_humedo')) defs.push('Carcasas IP67/68/69K, deflectores y sellado; normas de limpieza por turno.');
    if(sSel.includes('desalineo') || sSel.includes('vibracion')) defs.push('Tope/gu√≠a r√≠gida + aislaci√≥n de vibraci√≥n; plantillas permanentes de alineaci√≥n.');
    return defs;
  }
  function renderList(sel, items){
    const ul=$(sel); ul.innerHTML='';
    if(!items.length){ ul.innerHTML='<li class="pill">Sin coincidencias; ajusta s√≠ntomas/contexto</li>'; return; }
    items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
  }

  /* ===================== Checklist ===================== */
  function addCheckRow(row={tarea:'',resp:'',fecha:'',status:'Pendiente'}){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input placeholder="Tarea" value="${row.tarea||''}"></td>
      <td><input placeholder="Responsable" value="${row.resp||''}"></td>
      <td><input type="date" value="${row.fecha||''}"></td>
      <td>
        <select>
          <option ${row.status==='Pendiente'?'selected':''}>Pendiente</option>
          <option ${row.status==='En curso'?'selected':''}>En curso</option>
          <option ${row.status==='Hecha'?'selected':''}>Hecha</option>
          <option ${row.status==='Bloqueada'?'selected':''}>Bloqueada</option>
        </select>
      </td>
      <td class="row-actions">
        <button class="btn" onclick="moveRow(this,-1)">‚¨Ü</button>
        <button class="btn" onclick="moveRow(this,1)">‚¨á</button>
        <button class="btn" onclick="this.closest('tr').remove()">‚úñ</button>
      </td>`;
    $('#checkTable tbody').appendChild(tr);
  }
  function moveRow(btn,dir){
    const tr=btn.closest('tr'); const tb=tr.parentElement;
    const idx=[...tb.children].indexOf(tr); const target=idx+dir;
    if(target<0 || target>=tb.children.length)return;
    tb.insertBefore(tr, tb.children[target+(dir>0?1:0)]);
  }
  function getChecklist(){
    return $$('#checkTable tbody tr').map(tr=>({
      tarea: tr.children[0].querySelector('input').value.trim(),
      resp: tr.children[1].querySelector('input').value.trim(),
      fecha: tr.children[2].querySelector('input').value,
      status: tr.children[3].querySelector('select').value,
    })).filter(r=>r.tarea||r.resp||r.fecha);
  }

  /* ===================== Mini-FMEA / KPIs ===================== */
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function updateRPN(){
    const S = clamp(parseInt($('#fmeaS').value||'0'),1,10);
    const O = clamp(parseInt($('#fmeaO').value||'0'),1,10);
    const D = clamp(parseInt($('#fmeaD').value||'0'),1,10);
    const RPN = S*O*D;
    const badge=$('#rpnBadge');
    badge.textContent = `RPN: ${RPN} (S:${S} O:${O} D:${D})`;
    badge.className = 'badge ' + (RPN>=200?'danger': RPN>=120?'warn':'ok');
    const tips = [];
    if(S>=8) tips.push('Protecciones f√≠sicas, enclavamientos y l√≠mites de software.');
    if(O>=7) tips.push('Especificaci√≥n superior (IP/EMC/temperatura) y PM por condici√≥n.');
    if(D>=7) tips.push('Redundancia y autodiagn√≥stico por ciclo; alarmas tempranas.');
    const asset=$('#asset').value;
    if(asset==='vfd_plc') tips.push('Diagn√≥sticos en PLC (watchdog/CRC) y bit√°cora autom√°tica.');
    if(asset==='robot_soldadura') tips.push('Validaci√≥n 2oo2 de pieza y verificaci√≥n de cierre con curva de firma.');
    const ul=$('#fmeaTips'); ul.innerHTML=''; tips.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
  }
  function updateKPIs(){
    const n = parseFloat($('#nFails').value||'0');
    const h = parseFloat($('#opHours').value||'0');
    const d = parseFloat($('#downMins').value||'0');
    const mttr = n>0? d/n : 0;
    const mtbf = n>0? (h/n) : 0;
    $('#mttrBadge').textContent = `MTTR: ${mttr.toFixed(1)} min/falla`;
    $('#mtbfBadge').textContent = `MTBF: ${mtbf.toFixed(1)} h`;
    $('#mttrBadge').className='badge ' + (mttr<=30?'ok': mttr<=60?'warn':'danger');
    $('#mtbfBadge').className='badge ' + (mtbf>=80?'ok': mtbf>=40?'warn':'danger');
  }

  /* ===================== Resumen CAPA/A3 ===================== */
  function listText(arr){ return (arr&&arr.length)? arr.map(x=>`- ${x}`).join('\n') : '-'; }
  function buildResumen(){
    const s = getState();
    const sSel = getSelectedChips($('#symptoms')).map(id=> SYMPTOMS.find(x=>x.id===id)?.label).filter(Boolean);
    const cSel = getSelectedChips($('#context')).map(id=> CONTEXT.find(x=>x.id===id)?.label).filter(Boolean);
    const chk = getChecklist().map(r=>`| ${r.tarea} | ${r.resp||'-'} | ${r.fecha||'-'} | ${r.status} |`).join('\n');
    const defTop = (s.actDefinitivas||[]).slice(0,5).map(x=>`- ${x}`).join('\n') || '-';

    const md = `# A3/CAPA ‚Äî ${s.title||'Sin t√≠tulo'}
**L√≠nea/Equipo:** ${s.area||'-'}  
**Fecha/Turno/Resp:** ${s.date||'-'} / ${s.shift||'-'} / ${s.owner||'-'}  
**Impacto:** ${s.impact||'-'}

## Problema
${s.desc||'-'}

## S√≠ntomas / Contexto
- S√≠ntomas: ${sSel.join(', ')||'-'}
- Contexto: ${cSel.join(', ')||'-'}

## Acciones
### Inmediatas
${listText(s.actInmediatas)}
### Correctivas
${listText(s.actCorrectivas)}
### Contramedidas definitivas (Permanentes)
${defTop}

## FMEA
- Modo: ${$('#fmeaMode').value||'-'}
- Efecto: ${$('#fmeaEffect').value||'-'}
- Causa: ${$('#fmeaCause').value||'-'}
- **RPN:** ${($('#fmeaS').value||'?')}√ó${($('#fmeaO').value||'?')}√ó${($('#fmeaD').value||'?')} = ${($('#fmeaS').value&&$('#fmeaO').value&&$('#fmeaD').value)? ($('#fmeaS').value*$('#fmeaO').value*$('#fmeaD').value) : '?'}
- Acciones FMEA:  
${($('#fmeaActions').value||'-')}

## KPIs
- MTTR: ${$('#mttrBadge').textContent.replace('MTTR: ','')}
- MTBF: ${$('#mtbfBadge').textContent.replace('MTBF: ','')}

## Checklist
| Tarea | Responsable | Fecha | Estatus |
|---|---|---|---|
${chk || '| ‚Äî | ‚Äî | ‚Äî | ‚Äî |'}
`;
    $('#resumen').value = md.trim();
    toast('Resumen generado');
  }

  /* ===================== Estado / Guardado ===================== */
  function getState(){
    return {
      title:$('#title').value, area:$('#area').value, date:$('#date').value, shift:$('#shift').value, impact:$('#impact').value, owner:$('#owner').value,
      asset:$('#asset').value, desc:$('#desc').value,
      symptoms: getSelectedChips($('#symptoms')), context: getSelectedChips($('#context')),
      actInmediatas: Array.from($('#actInmediatas').children).map(li=>li.textContent),
      actCorrectivas: Array.from($('#actCorrectivas').children).map(li=>li.textContent),
      actDefinitivas: Array.from($('#actDefinitivas').children).map(li=>li.textContent),
      checklist: getChecklist(),
      fmea:{ mode:$('#fmeaMode').value, effect:$('#fmeaEffect').value, cause:$('#fmeaCause').value, S:$('#fmeaS').value, O:$('#fmeaO').value, D:$('#fmeaD').value, actions:$('#fmeaActions').value },
      kpis:{ nFails:$('#nFails').value, opHours:$('#opHours').value, downMins:$('#downMins').value },
      resumen:$('#resumen').value
    };
  }
  function setState(s){
    $('#title').value=s.title||''; $('#area').value=s.area||''; $('#date').value=s.date||''; $('#shift').value=s.shift||'D√≠a'; $('#impact').value=s.impact||''; $('#owner').value=s.owner||'';
    $('#asset').value=s.asset||'robot_soldadura'; $('#desc').value=s.desc||'';
    // chips
    $$('#symptoms .chip').forEach(ch=> ch.classList.toggle('active', (s.symptoms||[]).includes(ch.dataset.id)));
    $$('#context .chip').forEach(ch=> ch.classList.toggle('active', (s.context||[]).includes(ch.dataset.id)));
    // listas
    renderList('#actInmediatas', s.actInmediatas||[]);
    renderList('#actCorrectivas', s.actCorrectivas||[]);
    renderList('#actDefinitivas', s.actDefinitivas||[]);
    // checklist
    $('#checkTable tbody').innerHTML=''; (s.checklist&&s.checklist.length?s.checklist:[{status:'Pendiente'}]).forEach(r=>addCheckRow(r));
    // FMEA y KPIs
    $('#fmeaMode').value=s.fmea?.mode||''; $('#fmeaEffect').value=s.fmea?.effect||''; $('#fmeaCause').value=s.fmea?.cause||'';
    $('#fmeaS').value=s.fmea?.S||7; $('#fmeaO').value=s.fmea?.O||6; $('#fmeaD').value=s.fmea?.D||6; $('#fmeaActions').value=s.fmea?.actions||'';
    updateRPN();
    $('#nFails').value=s.kpis?.nFails||1; $('#opHours').value=s.kpis?.opHours||160; $('#downMins').value=s.kpis?.downMins||45; updateKPIs();
    $('#resumen').value=s.resumen||'';
  }
  function saveLocal(){ localStorage.setItem(stateKey, JSON.stringify(getState())); toast('Guardado local'); }
  function loadLocal(){ const raw=localStorage.getItem(stateKey); if(!raw) return toast('No hay guardado local'); try{ setState(JSON.parse(raw)); toast('Cargado'); }catch(e){ alert('Error: '+e.message); } }
  function exportJSON(){ const blob=new Blob([JSON.stringify(getState(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(($('#title').value.trim())||'mantto')+'.json'; a.click(); URL.revokeObjectURL(a.href); }
  function importJSON(file){ const rdr=new FileReader(); rdr.onload=()=>{ try{ setState(JSON.parse(rdr.result)); toast('Importado'); }catch(e){ alert('JSON inv√°lido: '+e.message); } }; rdr.readAsText(file); }

  /* ===================== B√∫squeda Web ===================== */
  async function doSearch(){
    const provider = $('#provider').value;
    const q = ($('#q').value||'').trim();
    if(!q) return toast('Escribe una consulta');
    $('#webResults').innerHTML = '<div class="pill">Buscando‚Ä¶</div>';
    try{
      let items = [];
      if(provider==='wikipedia'){
        items = await searchWikipedia(q);
      }else if(provider==='duck'){
        items = await searchDuckSuggest(q);
      }else if(provider==='serpapi'){
        const key = ($('#serpKey').value||'').trim();
        if(!key){ $('#webResults').innerHTML='<div class="pill">Falta API Key de SerpAPI</div>'; return; }
        items = await searchSerpApi(q, key, $('#hl').value.trim(), $('#gl').value.trim());
      }
      renderResults(items);
    }catch(e){
      $('#webResults').innerHTML = `<div class="pill">Error: ${e.message}</div>`;
    }
  }

  async function searchWikipedia(q){
    const url = `https://es.wikipedia.org/w/api.php?origin=*&action=query&list=search&srsearch=${encodeURIComponent(q)}&format=json&srlimit=8`;
    const j = await fetch(url).then(r=>r.json());
    const pages = (j.query?.search||[]);
    return pages.map(p=>({
      title: p.title,
      url: `https://es.wikipedia.org/wiki/${encodeURIComponent(p.title.replaceAll(' ','_'))}`,
      snippet: (p.snippet||'').replace(/<\/?span[^>]*>/g,'').replace(/&quot;/g,'"') + '‚Ä¶',
      provider: 'Wikipedia'
    }));
  }

  async function searchDuckSuggest(q){
    const url = `https://duckduckgo.com/ac/?q=${encodeURIComponent(q)}&type=list`;
    const j = await fetch(url).then(r=>r.json());
    return (j||[]).slice(0,8).map(s=>({
      title: s.phrase,
      url: `https://duckduckgo.com/?q=${encodeURIComponent(s.phrase)}`,
      snippet: 'Sugerencia de b√∫squeda relacionada en DuckDuckGo.',
      provider: 'DuckDuckGo'
    }));
  }

  async function searchSerpApi(q, key, hl, gl){
    const params = new URLSearchParams({ engine:'google', q, api_key:key });
    if(hl) params.set('hl', hl);
    if(gl) params.set('gl', gl);
    const url = `https://serpapi.com/search.json?${params.toString()}`;
    const j = await fetch(url).then(r=>r.json());
    const organic = j.organic_results || [];
    return organic.slice(0,10).map(r=>({
      title: r.title, url: r.link, snippet: r.snippet || '', provider: 'Google/SerpAPI'
    }));
  }

  function renderResults(items){
    const box = $('#webResults'); box.innerHTML='';
    if(!items.length){ box.innerHTML='<div class="pill">Sin resultados.</div>'; return; }
    items.forEach(it=>{
      const el = document.createElement('div'); el.className='result';
      el.innerHTML = `
        <div class="rbar">
          <span class="pill">${it.provider||'Web'}</span>
          <a href="${it.url}" target="_blank" class="btn">Abrir</a>
          <button class="btn" data-type="inmediata">‚ûï Inmediata</button>
          <button class="btn" data-type="correctiva">‚ûï Correctiva</button>
          <button class="btn" data-type="definitiva">‚ûï Definitiva</button>
        </div>
        <h4>${escapeHTML(it.title||'(sin t√≠tulo)')}</h4>
        <p>${escapeHTML(it.snippet||'')}</p>
      `;
      el.querySelectorAll('button[data-type]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const line = `${it.title} ‚Äî ${it.snippet} (${new URL(it.url).hostname})`;
          if(b.dataset.type==='inmediata') appendTo('#actInmediatas', line);
          if(b.dataset.type==='correctiva') appendTo('#actCorrectivas', line);
          if(b.dataset.type==='definitiva') appendTo('#actDefinitivas', line);
          toast('A√±adido a ' + b.dataset.type);
        });
      });
      box.appendChild(el);
    });
  }
  function appendTo(sel, text){
    const ul=$(sel); const li=document.createElement('li'); li.textContent=text; ul.appendChild(li);
  }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  /* ===================== Eventos ===================== */
  document.getElementById('btnSuggest').onclick=runEngine;
  document.getElementById('addCheck').onclick=()=>addCheckRow();
  document.getElementById('clearCheck').onclick=()=>{ $('#checkTable tbody').innerHTML=''; addCheckRow(); };

  ['fmeaS','fmeaO','fmeaD'].forEach(id=> document.getElementById(id).addEventListener('input',updateRPN));
  ['nFails','opHours','downMins'].forEach(id=> document.getElementById(id).addEventListener('input',updateKPIs));
  document.getElementById('btnResumen').onclick=buildResumen;

  document.getElementById('btnSave').onclick=saveLocal;
  document.getElementById('btnLoad').onclick=loadLocal;
  document.getElementById('btnExport').onclick=exportJSON;
  document.getElementById('fileImport').addEventListener('change',e=>{ const f=e.target.files[0]; if(f) importJSON(f); });
  document.getElementById('btnPrint').onclick=()=>window.print();
  document.getElementById('btnNew').onclick=()=>{ if(confirm('¬øLimpiar todo?')){ localStorage.removeItem(stateKey); location.reload(); } };

  document.getElementById('btnSearch').onclick=doSearch;

  /* ===================== Init ===================== */
  function init(){
    renderChips($('#symptoms'), SYMPTOMS);
    renderChips($('#context'), CONTEXT);
    addCheckRow();
    updateRPN(); updateKPIs();
  }
  init();
</script>
</body>
</html>
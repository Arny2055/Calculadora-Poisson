<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Poisson Profesional V3 - Corrección de Escala</title>
    <style>
        :root { --primary: #001e54; --accent: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: monospace; font-size: 11px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 20px 0; font-size: 16px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; display: none; }
        .card { border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; background: #fff; }
        .card-header { background: var(--primary); color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 13px; }
        .special-box { background: #eff6ff; border: 2px solid #bfdbfe; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .highlight { color: #059669; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">Calculadora Poisson (Escala Corregida)</h2>
    
    <div class="grid">
        <div>
            <label><b>Stats LOCAL:</b></label>
            <textarea id="hText" placeholder="Pega aquí..."></textarea>
        </div>
        <div>
            <label><b>Stats VISITANTE:</b></label>
            <textarea id="aText" placeholder="Pega aquí..."></textarea>
        </div>
    </div>

    <button onclick="calculate()">ANALIZAR PARTIDO</button>

    <div id="results" class="dashboard">
        <div class="special-box" style="grid-column: 1 / -1;">
            <h3 style="margin:0">Gol antes del Minuto 30</h3>
            <div id="prob30" style="font-size: 28px; font-weight: bold; color: var(--accent);">0%</div>
            <div id="cuota30">Cuota: -</div>
        </div>

        <div class="card"><div class="card-header">FULL TIME (90')</div><table id="ftTable"></table></div>
        <div class="card"><div class="card-header">1st HALF (HT)</div><table id="htTable"></table></div>
        <div class="card"><div class="card-header">2nd HALF (SH)</div><table id="shTable"></table></div>
        <div class="card"><div class="card-header">RANGOS 15'</div><table id="rangeTable"></table></div>
    </div>
</div>

<script>
const fact = n => (n <= 1) ? 1 : n * fact(n - 1);
const poisson = (k, l) => (Math.pow(l, k) * Math.exp(-l)) / fact(k);

function parseData(text) {
    // 1. Extraer GP (Partidos jugados) - FUNDAMENTAL para normalizar
    const gpMatch = text.match(/GP\s+(\d+)/);
    const gp = gpMatch ? parseInt(gpMatch[1]) : 9;

    const intervals = ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"];
    let tramos = [];
    
    intervals.forEach(r => {
        const m = text.match(new RegExp(r + "\\s+GF\\s+(\\d+)\\s+GA\\s+(\\d+)"));
        // Dividimos los goles del tramo entre GP para tener el Lambda por partido
        tramos.push({
            gf: m ? (parseInt(m[1]) / gp) : 0.05, // Suavizado mínimo si es 0
            ga: m ? (parseInt(m[2]) / gp) : 0.05
        });
    });

    return { gp, tramos };
}

function calculate() {
    const home = parseData(document.getElementById('hText').value);
    const away = parseData(document.getElementById('aText').value);
    
    // Cálculo de Lambdas por tramo cruzando Ataque L vs Defensa V
    let tramosL = [];
    for(let i=0; i<6; i++) {
        // Expectativa = (Goles Favor Local en tramo + Goles Contra Visita en tramo) / 2
        let l = (home.tramos[i].gf + away.tramos[i].ga) / 2 + (away.tramos[i].gf + home.tramos[i].ga) / 2;
        tramosL.push(l);
    }

    // Agrupación de Lambdas
    const lambdaFT = tramosL.reduce((a, b) => a + b, 0);
    const lambdaHT = tramosL[0] + tramosL[1] + tramosL[2];
    const lambdaSH = tramosL[3] + tramosL[4] + tramosL[5];
    const lambda30 = tramosL[0] + tramosL[1];

    // 1. Gol antes del 30
    const p30 = (1 - poisson(0, lambda30)) * 100;
    document.getElementById('prob30').innerText = p30.toFixed(2) + "%";
    document.getElementById('cuota30').innerHTML = "Cuota justa: <b>" + (100/p30).toFixed(2) + "</b>";

    // 2. Render de tablas
    renderTable('ftTable', lambdaFT, [0.5, 1.5, 2.5, 3.5]);
    renderTable('htTable', lambdaHT, [0.5, 1.5]);
    renderTable('shTable', lambdaSH, [0.5, 1.5]);
    
    // 3. Rangos 15'
    const rT = document.getElementById('rangeTable');
    rT.innerHTML = "<thead><tr><th>Tramo</th><th>Prob.</th><th>Cuota</th></tr></thead>";
    const labels = ["0-15'", "16-30'", "31-45'", "46-60'", "61-75'", "76-90'"];
    tramosL.forEach((l, i) => {
        let p = (1 - poisson(0, l)) * 100;
        rT.innerHTML += `<tr><td>${labels[i]}</td><td>${p.toFixed(1)}%</td><td>${(100/p).toFixed(2)}</td></tr>`;
    });

    document.getElementById('results').style.display = 'grid';
}

function renderTable(id, l, lines) {
    const table = document.getElementById(id);
    table.innerHTML = "<thead><tr><th>Línea</th><th>Prob.</th><th>Cuota</th></tr></thead>";
    lines.forEach(line => {
        let pU = 0;
        for(let i=0; i < line; i++) pU += poisson(i, l);
        let pO = 1 - pU;
        table.innerHTML += `<tr><td>Over ${line}</td><td class="highlight">${(pO*100).toFixed(1)}%</td><td>${(1/pO).toFixed(2)}</td></tr>`;
        table.innerHTML += `<tr><td>Under ${line}</td><td>${(pU*100).toFixed(1)}%</td><td>${(1/pU).toFixed(2)}</td></tr>`;
    });
}
</script>

</body>
</html>

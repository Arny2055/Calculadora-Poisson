<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de ROI y Registro de Apuestas PRO</title>
    <style>
        /* --- ESTILOS BASE (MESA/DESKTOP) --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #121212;
            color: #E0E0E0;
            padding: 20px;
        }
        .container {
            /* Se reduce el max-width para ser m√°s amigable en pantallas peque√±as */
            max-width: 900px; 
            margin: auto;
            background: #1E1E1E;
            padding: 25px;
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333333; 
        }
        h1, h2, h3 {
            text-align: center;
            color: #BB86FC;
            margin-bottom: 20px;
        }
        hr {
            border-color: #333333;
            margin: 30px 0;
        }

        /* --- LAYOUT Y SECCIONES --- */
        .section-box {
            padding: 15px;
            border: 1px solid #333333; 
            border-radius: 4px;
            background-color: #2C2C2C;
        }
        .match-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .match-row label {
            width: 70px;
            font-weight: bold;
            color: #E0E0E0;
            flex-shrink: 0;
        }
        input[type="number"], select, input[type="text"] {
            padding: 8px; /* Aumentar padding para touch */
            border: 1px solid #555555;
            border-radius: 4px;
            background-color: #121212; 
            color: #E0E0E0; 
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Colores de resultados */
        .positive { color: #00A800; font-weight: bold; }
        .negative { color: #CF6679; font-weight: bold; }
        .zero { color: #AAAAAA; font-weight: bold; }
        .pending-text { color: #BB86FC; font-weight: bold; }

        /* TABLA DE HISTORIAL */
        #match-history-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
        }
        #match-history-table th, #match-history-table td {
            border: 1px solid #333333;
            background-color: #1E1E1E;
            color: #E0E0E0;
            padding: 8px 4px; 
            font-size: 0.8em; /* Tama√±o de fuente normalizado */
            text-align: center;
        }
        #match-history-table th {
            background-color: #333333;
            color: #BB86FC;
            border-bottom: 2px solid #BB86FC;
        }
        .action-cell { min-width: 130px; } /* Ancho m√≠nimo para botones */
        .history-roi-summary {
            background-color: #2C2C2C;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }

        /* CONFIGURACI√ìN Y REGISTRO */
        #unit-config, #registration-section {
            max-width: 450px;
            margin: 0 auto 30px;
        }
        #unit-config .match-row label {
            width: 150px;
        }

        /* FILTROS */
        #history-filters {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #2C2C2C;
            border-radius: 4px;
        }
        #history-filters label {
            flex-shrink: 0;
        }
        #history-filters select {
            width: auto;
            min-width: 130px;
        }
        
        /* BOTONES */
        button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            margin-top: 10px;
            width: 100%;
        }
        #save-unit-btn { background-color: #03DAC6; color: #121212; }
        #save-match-btn { background-color: #6200EE; color: #FFFFFF; }
        
        .btn-edit, .btn-delete {
            padding: 5px;
            font-size: 0.8em;
            margin-top: 0;
            width: 48%; /* Para que quepan bien dos botones en la celda */
            display: inline-block;
        }
        .btn-delete { background-color: #CF6679; }
        .btn-edit { background-color: #BB86FC; }

        /* MODALES */
        .modal-content {
            background-color: #2C2C2C; margin: 10% auto; padding: 20px; border: 1px solid #BB86FC; width: 90%; max-width: 600px; border-radius: 8px;
        }
        
        /* --- RESPONSIVIDAD (M√≥vil) --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 10px;
            }
            
            /* Ajuste de filtros */
            #history-filters {
                flex-direction: column;
                align-items: stretch;
            }
            #history-filters label {
                text-align: center;
            }
            #history-filters select {
                width: 100%;
            }

            /* Asegurar el despliegue horizontal de la tabla */
            .history-section {
                /* Contenedor del scroll de la tabla */
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; /* Suavidad en iOS */
            }
            #match-history-table {
                /* M√≠nimo ancho para que la tabla no se colapse */
                min-width: 700px; 
            }
            #match-history-table th, #match-history-table td {
                padding: 6px 3px;
                font-size: 0.7em;
            }
            
            /* Ajuste de labels y inputs para m√≥viles */
            .match-row label {
                width: 60px;
                font-size: 0.9em;
            }
            #unit-config .match-row label {
                width: 100px;
            }
            input[type="number"], select, input[type="text"] {
                padding: 10px; /* Aumentar un poco m√°s para facilitar el toque */
            }
            
            /* Reducir botones en celdas de acci√≥n */
            .btn-edit, .btn-delete {
                padding: 8px 3px;
                font-size: 0.7em;
                width: 45%; 
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìä Calculadora de ROI y Registro de Apuestas PRO</h1>

        <section id="unit-config" class="section-box">
            <h3>‚öôÔ∏è Configuraci√≥n de 1 Unidad (Stake 1)</h3>
            <div class="match-row">
                <label for="unit-value">Valor de 1 Unidad (‚Ç¨/\$):</label>
                <input type="number" id="unit-value" step="0.01" min="0.01" placeholder="Ej: 10.00" required>
            </div>
            <p style="font-size: 0.8em; color: #AAAAAA; text-align: center;">Actual: <span id="current-unit-value">1.00</span></p>
            <button id="save-unit-btn" onclick="saveUnitValue()">Guardar Valor de Unidad</button>
        </section>

        <hr>

        <section style="margin-bottom: 30px;">
            <h2>üìà Progreso de Beneficio Acumulado (P&L por Mercado)</h2>
            <div style="background: #1e1e1e; padding: 15px; border-radius: 8px; height: 350px;">
                <canvas id="profitChart" width="800" height="400"></canvas>
            </div>
        </section>

        <hr>

        <section id="registration-section">
            <div class="section-box">
                <h3 style="color: #6200EE;">üíæ Registrar Apuesta Real (en Unidades)</h3>

                <div class="match-row">
                    <label for="reg-home">Local:</label>
                    <input type="text" id="reg-home" placeholder="Nombre Local" required>
                </div>
                <div class="match-row">
                    <label for="reg-away">Visitante:</label>
                    <input type="text" id="reg-away" placeholder="Nombre Visitante" required>
                </div>
                <div class="match-row">
                    <label for="reg-market">Mercado:</label>
                    <select id="reg-market">
                        <option value="OU">Over/Under</option>
                        <option value="BTTS">BTTS</option>
                    </select>
                </div>

                <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #03DAC6;">ROIs An√°lisis (%):</p>
                <div class="manual-roi-group" style="display: flex; gap: 10px;">
                    <div class="match-row" style="width: 50%; margin-bottom: 0;">
                        <label for="reg-roi-local" style="width: auto; flex-grow: 1; text-align: right;">ROI L.:</label>
                        <input type="number" id="reg-roi-local" step="0.01" placeholder="Ej: 15.5">
                    </div>
                    <div class="match-row" style="width: 50%; margin-bottom: 0;">
                        <label for="reg-roi-visitor" style="width: auto; flex-grow: 1; text-align: right;">ROI V.:</label>
                        <input type="number" id="reg-roi-visitor" step="0.01" placeholder="Ej: -5.0">
                    </div>
                </div>

                <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #E0E0E0;">Datos de Apuesta:</p>
                <div class="match-row">
                    <label for="reg-stake">Stake (U.):</label>
                    <input type="number" id="reg-stake" step="0.1" min="0.1" placeholder="Ej: 1.5 Unidades" required>
                </div>
                <div class="match-row">
                    <label for="reg-quota">Cuota:</label>
                    <input type="number" id="reg-quota" step="0.01" min="1.01" placeholder="Cuota Apostada" required>
                </div>
                <div class="match-row">
                    <label for="reg-result">Resultado:</label>
                    <select id="reg-result" onchange="applyResultStyle(this)" class="result-default" required>
                        <option value="" selected disabled>-- Selecciona --</option>
                        <option value="1">Ganado</option>
                        <option value="0">Perdido</option>
                        <option value="-1">Pendiente</option> 
                    </select>
                </div>
                <button id="save-match-btn" onclick="saveMatchToHistory()">Guardar Apuesta</button>
            </div>
        </section>

        <hr>

        <section class="history-section">
            <h2>üìú Historial de Apuestas</h2>
            
            <div id="historical-roi-summary" class="history-roi-summary">
                </div>

            <div id="history-filters">
                <label>Filtrar:</label>
                <select id="filter-result" onchange="filterHistory()">
                    <option value="all">Resultado: Todos</option>
                    <option value="1">Ganado</option>
                    <option value="0">Perdido</option>
                    <option value="-1">Pendiente</option>
                </select>
                <select id="filter-market" onchange="filterHistory()">
                    <option value="all">Mercado: Todos</option>
                    <option value="OU">Over/Under</option>
                    <option value="BTTS">BTTS</option>
                </select>
            </div>

            <div style="overflow-x: auto;">
                <table id="match-history-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Partido</th>
                            <th>Mercado</th>
                            <th>ROI L. (Target)</th>
                            <th>ROI V. (Target)</th>
                            <th>Stake (U.)</th>
                            <th>Cuota</th>
                            <th>Estado</th>
                            <th>P&L (U.)</th>
                            <th>ROI Gral. (%)</th>
                            <th class="action-cell">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="match-history-body">
                        </tbody>
                </table>
            </div>
            
            <button id="show-summary-btn" onclick="showPerformanceSummary()">üìà Ver Resumen de Rendimiento Detallado</button>
            <button id="delete-all-btn" onclick="confirmClearHistory()">üóëÔ∏è Borrar Todo el Historial</button>
        </section>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3>‚úèÔ∏è Editar Apuesta</h3>
            <input type="hidden" id="edit-id">

            <div class="match-row"><label for="edit-home">Local:</label><input type="text" id="edit-home" required></div>
            <div class="match-row"><label for="edit-away">Visitante:</label><input type="text" id="edit-away" required></div>
            <div class="match-row"><label for="edit-market">Mercado:</label><select id="edit-market"><option value="OU">Over/Under</option><option value="BTTS">BTTS</option></select></div>

            <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #03DAC6;">ROIs An√°lisis:</p>
            <div class="manual-roi-group" style="display: flex; gap: 10px;">
                <div class="match-row" style="width: 50%; margin-bottom: 0;"><label for="edit-roi-local" style="width: auto; flex-grow: 1; text-align: right;">ROI L.:</label><input type="number" id="edit-roi-local" step="0.01"></div>
                <div class="match-row" style="width: 50%; margin-bottom: 0;"><label for="edit-roi-visitor" style="width: auto; flex-grow: 1; text-align: right;">ROI V.:</label><input type="number" id="edit-roi-visitor" step="0.01"></div>
            </div>

            <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #E0E0E0;">Datos de Apuesta:</p>
            <div class="match-row"><label for="edit-stake">Stake (U.):</label><input type="number" id="edit-stake" step="0.1" min="0.1"></div>
            <div class="match-row"><label for="edit-quota">Cuota:</label><input type="number" id="edit-quota" step="0.01" min="1.01"></div>
            <div class="match-row"><label for="edit-result">Resultado:</label><select id="edit-result" onchange="applyResultStyle(this)" class="result-default"><option value="1">Ganado</option><option value="0">Perdido</option><option value="-1">Pendiente</option> </select></div>
            
            <button id="save-edit-btn" onclick="saveEdit()">Guardar Cambios</button>
        </div>
    </div>

    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSummaryModal()">&times;</span>
            <h3>üìà Resumen de Rendimiento Detallado</h3>
            
            <div id="market-summary-container">
                </div>
            
            <table id="summary-table">
                <thead>
                    <tr>
                        <th>M√©trica</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody id="summary-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // *** Las funciones de l√≥gica de JavaScript (calculateBetMetrics, saveMatchToHistory, updateHistoryTable, renderProfitChart, etc.) 
        // *** Se mantienen exactamente igual que en la versi√≥n anterior para no introducir errores en la l√≥gica.
        // *** Solo se han modificado las funciones de inicializaci√≥n y las que interact√∫an con el DOM para el manejo de unidades/filtros.

        const MIN_ROI_THRESHOLD = 15; 
        
        let matchHistory = JSON.parse(localStorage.getItem('bettingHistory')) || []; 
        let UNIT_VALUE = parseFloat(localStorage.getItem('unitValue')) || 1.00;
        let myProfitChart; 
        let currentFilter = { result: 'all', market: 'all' };


        // --- CONFIGURACI√ìN DE UNIDADES ---

        function saveUnitValue() {
            const input = document.getElementById('unit-value');
            const value = parseFloat(input.value);

            if (isNaN(value) || value <= 0) {
                alert('üö® ERROR: Ingresa un valor num√©rico v√°lido y positivo para 1 Unidad.');
                return;
            }

            UNIT_VALUE = value;
            localStorage.setItem('unitValue', UNIT_VALUE.toFixed(2));
            alert(`‚úÖ Valor de 1 Unidad guardado: ${UNIT_VALUE.toFixed(2)}`);
            updateUnitDisplay();
            updateHistoryTable(); 
        }

        function updateUnitDisplay() {
            document.getElementById('current-unit-value').textContent = `${UNIT_VALUE.toFixed(2)}`;
            document.getElementById('unit-value').value = UNIT_VALUE.toFixed(2);
        }

        // --- FUNCIONES DE REGISTRO Y C√ÅLCULO ---

        function calculateBetMetrics(stake, quota, isWon) {
            let netProfit = 0; 
            let roi = 0; 

            if (isWon === 1) {
                const grossReturn = quota * stake;
                netProfit = grossReturn - stake;
                roi = (netProfit / stake) * 100;
            } else if (isWon === 0) {
                netProfit = -stake;
                roi = -100;
            } else { 
                netProfit = 0;
                roi = 0;
            }
            return { netProfit, roi };
        }

        function saveMatchToHistory() {
            const home = document.getElementById('reg-home').value.trim();
            const away = document.getElementById('reg-away').value.trim();
            const market = document.getElementById('reg-market').value;
            const stakeInput = document.getElementById('reg-stake').value;
            const quotaInput = document.getElementById('reg-quota').value;
            const resultSelect = document.getElementById('reg-result').value;
            const roiLocalManual = document.getElementById('reg-roi-local').value.trim();
            const roiVisitorManual = document.getElementById('reg-roi-visitor').value.trim();

            if (!home || !away || !stakeInput || !quotaInput || resultSelect === "") {
                alert('üö® ERROR: Completa los campos obligatorios de Apuesta.');
                return;
            }

            const stake = parseFloat(stakeInput);
            const quota = parseFloat(quotaInput);
            const isWon = parseInt(resultSelect);

            if (isNaN(stake) || stake <= 0.0) {
                alert('üö® ERROR: El Stake (U.) debe ser un n√∫mero positivo.');
                return;
            }
            if (isNaN(quota) || quota <= 1.0) {
                alert('üö® ERROR: La Cuota debe ser un n√∫mero > 1.01.');
                return;
            }
            
            const roiLocal = roiLocalManual !== '' && !isNaN(parseFloat(roiLocalManual)) ? parseFloat(roiLocalManual) : null;
            const roiVisitor = roiVisitorManual !== '' && !isNaN(parseFloat(roiVisitorManual)) ? parseFloat(roiVisitorManual) : null;
            if ((roiLocalManual !== '' && roiLocal === null) || (roiVisitorManual !== '' && roiVisitor === null)) {
                alert('üö® ERROR: Los valores de ROI L/V deben ser num√©ricos v√°lidos.');
                return;
            }

            const { netProfit, roi } = calculateBetMetrics(stake, quota, isWon);

            const match = {
                id: Date.now(), 
                home: home,
                away: away,
                market: market,
                roiLocal: roiLocal, 
                roiVisitor: roiVisitor, 
                stake: stake,
                quota: quota,
                result: isWon,
                netProfit: netProfit,
                roi: roi
            };

            matchHistory.push(match);
            localStorage.setItem('bettingHistory', JSON.stringify(matchHistory));
            updateHistoryTable();

            document.getElementById('reg-home').value = '';
            document.getElementById('reg-away').value = '';
            document.getElementById('reg-stake').value = '';
            document.getElementById('reg-quota').value = '';
            document.getElementById('reg-roi-local').value = '';
            document.getElementById('reg-roi-visitor').value = '';
            const regResult = document.getElementById('reg-result');
            regResult.value = '';
            applyResultStyle(regResult);
            alert(`‚úÖ Apuesta registrada: ${home} vs ${away}.`);
        }

        function confirmClearHistory() {
            if (matchHistory.length === 0) {
                 alert('El historial ya est√° vac√≠o.');
                 return;
            }
            if (confirm('üö® ¬°ADVERTENCIA! ¬øEst√°s seguro de que quieres borrar TODO el historial de apuestas?')) {
                matchHistory = [];
                localStorage.removeItem('bettingHistory');
                updateHistoryTable();
                alert('Historial completamente borrado.');
            }
        }

        // --- FUNCIONES DE FILTRO Y VISTA DE TABLA ---

        window.filterHistory = function() {
            currentFilter.result = document.getElementById('filter-result').value;
            currentFilter.market = document.getElementById('filter-market').value;
            updateHistoryTable();
        }

        function updateHistoryTable() {
            const tableBody = document.getElementById('match-history-body');
            tableBody.innerHTML = ''; 

            const filteredHistory = matchHistory.filter(match => {
                const resultMatch = currentFilter.result === 'all' || match.result.toString() === currentFilter.result;
                const marketMatch = currentFilter.market === 'all' || match.market === currentFilter.market;
                return resultMatch && marketMatch;
            });

            filteredHistory.forEach((match, index) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = index + 1; 
                row.insertCell().textContent = `${match.home} vs ${match.away}`;
                row.insertCell().textContent = match.market;

                const roiLocalCell = row.insertCell();
                if (match.roiLocal !== null) {
                    const isTarget = match.roiLocal >= MIN_ROI_THRESHOLD;
                    const indicator = isTarget ? '<span style="color: #00A800;">üü¢</span> ' : '';
                    roiLocalCell.innerHTML = indicator + formatResultSimple(match.roiLocal);
                } else {
                    roiLocalCell.textContent = '-';
                }

                const roiVisitorCell = row.insertCell();
                if (match.roiVisitor !== null) {
                    const isTarget = match.roiVisitor >= MIN_ROI_THRESHOLD;
                    const indicator = isTarget ? '<span style="color: #00A800;">üü¢</span> ' : '';
                    roiVisitorCell.innerHTML = indicator + formatResultSimple(match.roiVisitor);
                } else {
                    roiVisitorCell.textContent = '-';
                }

                row.insertCell().textContent = match.stake.toFixed(2);
                row.insertCell().textContent = match.quota.toFixed(2);
                
                const resultCell = row.insertCell();
                let statusText;
                if (match.result === 1) {
                    statusText = 'Ganado';
                    resultCell.classList.add('positive');
                } else if (match.result === 0) {
                    statusText = 'Perdido';
                    resultCell.classList.add('negative');
                } else {
                    statusText = 'Pendiente';
                    resultCell.classList.add('pending-text');
                }
                resultCell.textContent = statusText;
                
                const profitCell = row.insertCell();
                if (match.result === -1) {
                    profitCell.textContent = 'N/A';
                    profitCell.classList.add('zero');
                } else {
                    profitCell.textContent = match.netProfit.toFixed(2);
                    profitCell.classList.add(match.netProfit >= 0 ? 'positive' : 'negative');
                }

                const roiCell = row.insertCell();
                if (match.result === -1) {
                    roiCell.textContent = 'N/A';
                    roiCell.classList.add('zero');
                } else {
                    roiCell.innerHTML = formatResultSimple(match.roi);
                }

                const actionCell = row.insertCell();
                actionCell.classList.add('action-cell');
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editMatch(${match.id})">Editar</button>
                    <button class="btn-delete" onclick="deleteMatch(${match.id})">Borrar</button>
                `;
            });
            
            updateHistoricalSummary(); 
            renderProfitChart(); 
        }

        function formatResult(label, roi) {
            const roundedRoi = roi.toFixed(2);
            let className;
            let sign = roi >= 0 ? '+' : '';

            if (roi > 0) {
                className = 'positive';
            } else if (roi < 0) {
                className = 'negative';
                sign = ''; 
            } else {
                className = 'zero';
            }
            return `${label}: <span class="${className}">${sign}${roundedRoi}%</span>`;
        }

        function formatResultSimple(roi) {
            const roundedRoi = roi.toFixed(2);
            let className;
            let sign = roi >= 0 ? '+' : '';

            if (roi > 0) {
                className = 'positive';
            } else if (roi < 0) {
                className = 'negative';
                sign = ''; 
            } else {
                className = 'zero';
            }
            return `<span class="${className}">${sign}${roundedRoi}</span>%`;
        }

        // --- FUNCIONES DE RESUMEN Y ESTAD√çSTICAS ---

        function calculateSummaryMetrics() {
            const terminatedMatches = matchHistory.filter(match => match.result !== -1);
            
            let totalInvestment = 0; 
            let totalNetProfit = 0; 

            const marketMetrics = {
                OU: { investment: 0, profit: 0, count: 0 },
                BTTS: { investment: 0, profit: 0, count: 0 }
            };

            terminatedMatches.forEach(match => {
                totalInvestment += match.stake; 
                totalNetProfit += match.netProfit;

                const market = match.market;
                if (marketMetrics[market]) {
                    marketMetrics[market].investment += match.stake;
                    marketMetrics[market].profit += match.netProfit;
                    marketMetrics[market].count++;
                }
            });

            for (const market in marketMetrics) {
                const metrics = marketMetrics[market];
                metrics.roi = metrics.investment > 0 ? (metrics.profit / metrics.investment) * 100 : 0;
            }

            let totalROI = totalInvestment > 0 ? (totalNetProfit / totalInvestment) * 100 : 0;
            
            return { totalInvestment, totalNetProfit, totalROI, totalYield: totalROI, terminatedCount: terminatedMatches.length, marketMetrics };
        }

        function updateHistoricalSummary() {
            const historySummary = document.getElementById('historical-roi-summary');
            const summaryData = calculateSummaryMetrics(); 
            
            const totalStakes = summaryData.totalInvestment.toFixed(2); 
            
            const roiGeneralFormatted = formatResult(`‚ú® ROI General (${summaryData.terminatedCount} Ap. Terminadas)`, summaryData.totalROI);
            
            historySummary.innerHTML = `
                <div style="display: flex; justify-content: space-around;">
                    <div style="font-weight: bold;">
                        ${roiGeneralFormatted}
                    </div>
                    <div style="font-size: 0.9em; color: #BB86FC;">
                        Unidades Apostadas: <span class="zero">${totalStakes} U.</span>
                    </div>
                </div>
            `;
        }

        function renderMarketSummary(summaryData) {
            const container = document.getElementById('market-summary-container');
            container.innerHTML = '<h3>Resumen por Mercado</h3>';
            
            for (const market in summaryData.marketMetrics) {
                const metrics = summaryData.marketMetrics[market];
                const marketName = market === 'OU' ? 'Over/Under' : 'BTTS';
                const profitText = metrics.profit.toFixed(2);
                const profitClass = metrics.profit >= 0 ? 'positive' : 'negative';

                container.innerHTML += `
                    <div class="section-box" style="margin-bottom: 15px;">
                        <h4 style="color: #03DAC6; margin: 0 0 10px 0;">${marketName} (${metrics.count} Apuestas)</h4>
                        <div style="display: flex; justify-content: space-around; font-size: 1.1em; flex-wrap: wrap;">
                            <div style="min-width: 150px; text-align: center;">ROI/Yield: ${formatResultSimple(metrics.roi)}</div>
                            <div style="min-width: 150px; text-align: center;">P&L: <span class="${profitClass}">${profitText} U.</span></div>
                            <div style="min-width: 150px; text-align: center;">Stake Total: ${metrics.investment.toFixed(2)} U.</div>
                        </div>
                    </div>
                `;
            }
        }


        // --- FUNCIONES DEL GR√ÅFICO ---

        function renderProfitChart() {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;

            let accumulatedProfitOU = 0;
            let accumulatedProfitBTTS = 0;
            const labels = ['Inicio'];
            const dataPointsOU = [0]; 
            const dataPointsBTTS = [0]; 

            matchHistory.forEach((match, index) => {
                if (match.result !== -1) { 
                    if (match.market === 'OU') {
                        accumulatedProfitOU += match.netProfit;
                    } else if (match.market === 'BTTS') {
                        accumulatedProfitBTTS += match.netProfit;
                    }
                }
                
                labels.push(`Apuesta ${index + 1}`);
                dataPointsOU.push(parseFloat(accumulatedProfitOU.toFixed(2))); 
                dataPointsBTTS.push(parseFloat(accumulatedProfitBTTS.toFixed(2))); 
            });
            
            if (window.myProfitChart) {
                window.myProfitChart.destroy();
            }

            window.myProfitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'P&L Acumulado (Over/Under)',
                            data: dataPointsOU,
                            borderColor: '#03DAC6', 
                            backgroundColor: 'rgba(3, 218, 198, 0.1)', 
                            tension: 0.4, 
                            pointRadius: 3,
                            pointBackgroundColor: '#03DAC6'
                        },
                        {
                            label: 'P&L Acumulado (BTTS)',
                            data: dataPointsBTTS,
                            borderColor: '#BB86FC', 
                            backgroundColor: 'rgba(187, 134, 252, 0.1)', 
                            tension: 0.4, 
                            pointRadius: 3,
                            pointBackgroundColor: '#BB86FC'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Unidades (U.)', color: '#E0E0E0' },
                            grid: { color: '#333333' },
                            ticks: { color: '#E0E0E0' }
                        },
                        x: {
                            title: { display: true, text: 'Progresi√≥n de Apuestas', color: '#E0E0E0' },
                            grid: { color: '#333333' },
                            ticks: { color: '#E0E0E0' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { color: '#E0E0E0' } }
                    }
                }
            });
        }

        // --- FUNCIONES DEL MODAL DE RESUMEN (FINAL) ---

        window.closeSummaryModal = function() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        window.showPerformanceSummary = function() {
            const summaryData = calculateSummaryMetrics();
            const tableBody = document.getElementById('summary-table-body');
            tableBody.innerHTML = ''; 

            renderMarketSummary(summaryData);

            if (summaryData.terminatedCount === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" class="pending-text">A√∫n no hay apuestas terminadas para el resumen.</td></tr>';
            } else {
                tableBody.innerHTML += `
                    <tr><td>ROI (Retorno de Inversi√≥n)</td><td>${formatResultSimple(summaryData.totalROI)}</td></tr>
                    <tr><td>Yield (Rendimiento)</td><td>${formatResultSimple(summaryData.totalYield)}</td></tr>
                `;

                let netProfitCell = summaryData.totalNetProfit.toFixed(2);
                let profitClass = summaryData.totalNetProfit >= 0 ? 'positive' : 'negative';
                tableBody.innerHTML += `
                    <tr><td>Ganancia Neta Total</td><td class="${profitClass}">${netProfitCell} U.</td></tr>
                    <tr><td>Total Apostado (Stake)</td><td class="zero">${summaryData.totalInvestment.toFixed(2)} U.</td></tr>
                    <tr><td>Total Apuestas Terminadas</td><td class="zero">${summaryData.terminatedCount}</td></tr>
                    <tr><td>Valor 1 Unidad (Referencia)</td><td class="zero">${UNIT_VALUE.toFixed(2)}</td></tr>
                `;
            }

            document.getElementById('summaryModal').style.display = 'block';
        }
        
        // --- FUNCIONES DE EDICI√ìN Y ESTILO ---
        
        window.deleteMatch = function(id) {
            if (confirm('¬øSeguro que deseas borrar esta apuesta individual?')) {
                matchHistory = matchHistory.filter(match => match.id !== id);
                localStorage.setItem('bettingHistory', JSON.stringify(matchHistory));
                updateHistoryTable();
                alert('Apuesta eliminada.');
            }
        }

        window.editMatch = function(id) {
            const match = matchHistory.find(m => m.id === id);
            if (!match) return;

            document.getElementById('edit-id').value = match.id;
            document.getElementById('edit-home').value = match.home;
            document.getElementById('edit-away').value = match.away;
            document.getElementById('edit-market').value = match.market;
            document.getElementById('edit-roi-local').value = match.roiLocal !== null ? match.roiLocal : '';
            document.getElementById('edit-roi-visitor').value = match.roiVisitor !== null ? match.roiVisitor : '';
            document.getElementById('edit-stake').value = match.stake.toFixed(2);
            document.getElementById('edit-quota').value = match.quota.toFixed(2);
            
            const editResultSelect = document.getElementById('edit-result');
            editResultSelect.value = match.result;
            applyResultStyle(editResultSelect); 

            document.getElementById('editModal').style.display = 'block';
        }

        window.saveEdit = function() {
            const id = parseInt(document.getElementById('edit-id').value);
            const index = matchHistory.findIndex(m => m.id === id);
            
            if (index === -1) { alert('Error: Apuesta no encontrada.'); return; }

            const home = document.getElementById('edit-home').value.trim();
            const away = document.getElementById('edit-away').value.trim();
            const market = document.getElementById('edit-market').value;
            const stakeInput = document.getElementById('edit-stake').value;
            const quotaInput = document.getElementById('edit-quota').value;
            const resultSelect = document.getElementById('edit-result').value;
            const roiLocalManual = document.getElementById('edit-roi-local').value.trim();
            const roiVisitorManual = document.getElementById('edit-roi-visitor').value.trim();

            if (!home || !away || !stakeInput || !quotaInput) { alert('üö® ERROR: Completa los campos obligatorios.'); return; }
            
            const stake = parseFloat(stakeInput);
            const quota = parseFloat(quotaInput);
            const isWon = parseInt(resultSelect);

            if (stake <= 0 || quota <= 1.0) { alert('üö® ERROR: Stake > 0 y Cuota > 1.0'); return; }
            
            const { netProfit, roi } = calculateBetMetrics(stake, quota, isWon);
            
            const roiLocal = roiLocalManual !== '' && !isNaN(parseFloat(roiLocalManual)) ? parseFloat(roiLocalManual) : null;
            const roiVisitor = roiVisitorManual !== '' && !isNaN(parseFloat(roiVisitorManual)) ? parseFloat(roiVisitorManual) : null;

            matchHistory[index] = {
                ...matchHistory[index], home, away, market,
                roiLocal, roiVisitor, stake, quota, result: isWon, netProfit, roi
            };

            localStorage.setItem('bettingHistory', JSON.stringify(matchHistory));
            updateHistoryTable();
            closeEditModal();
            alert(`‚úÖ Apuesta actualizada con √©xito.`);
        }

        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
        }

        window.applyResultStyle = function(selectElement) {
            const value = selectElement.value;
            selectElement.classList.remove('result-won', 'result-lost', 'result-pending', 'result-default');
            if (value === '1') { selectElement.classList.add('result-won'); } 
            else if (value === '0') { selectElement.classList.add('result-lost'); } 
            else if (value === '-1') { selectElement.classList.add('result-pending'); } 
            else { selectElement.classList.add('result-default'); }
        }

        // --- INICIALIZACI√ìN ---
        window.onload = function() {
            updateUnitDisplay();
            updateHistoryTable(); 
        };
    </script>

</body>
</html>

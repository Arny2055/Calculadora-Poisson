<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Betting Intelligence Pro - Ultimate Suite 2025</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; font-size: 14px; }
        .container { max-width: 1500px; margin: auto; }
        textarea { width: 100%; height: 80px; background: #334155; color: white; border: 1px solid #475569; border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .btn-gold { background: var(--gold); color: #0f172a; font-size: 16px; padding: 18px; }
        .btn-mini { padding: 6px 12px; width: auto; font-size: 11px; background: #475569; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .league-section { background: var(--card); border-radius: 12px; padding: 20px; margin-top: 25px; border-left: 5px solid var(--accent); }
        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2d3748; align-items: center; }
        .roi-tag { font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .pos { color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .neg { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .premium-team { border: 1px solid var(--gold) !important; background: rgba(251, 191, 36, 0.1) !important; border-radius: 6px; padding: 4px; }
        .highlight-box { background: #1e3a8a; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; border: 2px solid var(--gold); }
        h2, h3, h4 { margin-top: 0; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
        .chk-row { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="margin-bottom: 20px;">
        <h2>üìä Betting Intelligence Hub - Suite Definitiva</h2>
        <textarea id="dataInput" placeholder="Pega aqu√≠ tus datos hist√≥ricos con encabezados..."></textarea>
        <button class="btn" onclick="initialProcess()">1. CARGAR Y ANALIZAR DATOS</button>
    </div>

    <div id="resultsMain" style="display:none;">
        <div class="highlight-box">
            <h1 id="simRoiTotal" style="margin:0;">ROI: 0%</h1>
            <p id="simStatsTotal" style="margin:5px 0 0 0; opacity: 0.8;"></p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>‚öñÔ∏è Filtro de Cuotas</h3>
                <div id="oddsFilterList"></div>
                <button class="btn btn-gold" style="margin-top:15px;" onclick="updateAllDashboard()">RE-CALCULAR TODO EL TABLERO</button>
            </div>

            <div class="card">
                <h3>üõ°Ô∏è Gesti√≥n de Riesgo</h3>
                <div class="row"><span>Peor Racha:</span> <span id="maxLoss" class="neg roi-tag">0</span></div>
                <div class="row"><span>Bankroll Sugerido:</span> <span id="bankReq" style="color:var(--gold); font-weight:bold;">0 u.</span></div>
                <div class="row"><span>Stake M√°ximo:</span> <span id="stakeSugg">0%</span></div>
                <div id="riskAdvice" style="margin-top:10px; font-size:12px; color:#94a3b8;"></div>
            </div>

            <div class="card">
                <h3>üíé Top Valor Global</h3>
                <div id="topTeamsGlobal"></div>
            </div>
        </div>

        <div id="leagueBreakdown"></div>
    </div>
</div>

<script>
let allMatches = []; 

function initialProcess() {
    const input = document.getElementById('dataInput').value.trim();
    if (!input) return;

    const lines = input.split('\n');
    const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
    const find = (keys) => headers.findIndex(h => keys.some(k => h.includes(k)));

    const idx = {
        league: find(['league', 'liga']),
        date: find(['date', 'fecha']),
        match: find(['match']),
        result: headers.lastIndexOf('result'),
        odd: find(['odd'])
    };

    allMatches = [];
    let initialOdds = {};

    lines.slice(1).forEach(line => {
        const col = line.split('\t').map(c => c.trim());
        if (col.length < 5) return;

        const isWin = col.some((c, i) => i >= idx.result && c.toLowerCase() === 'winning');
        const odd = parseFloat(col[idx.odd]?.replace(',','.')) || 0;
        const league = col[idx.league] || "Otras";
        const dateStr = col[idx.date] || "";
        const [hT, aT] = col[idx.match] ? col[idx.match].split(' - ') : ['?', '?'];

        if(odd > 0) {
            const floor = (Math.floor(odd * 10) / 10).toFixed(2);
            const range = `${floor} - ${(parseFloat(floor)+0.10).toFixed(2)}`;
            allMatches.push({ odd, isWin, league, range, dateStr, teams: [hT, aT] });

            if(!initialOdds[range]) initialOdds[range] = {s:0, r:0};
            initialOdds[range].s++; initialOdds[range].r += (isWin?odd:0);
        }
    });

    renderOddsFilters(initialOdds);
    updateAllDashboard();
    document.getElementById('resultsMain').style.display = 'block';
}

function renderOddsFilters(odds) {
    const container = document.getElementById('oddsFilterList');
    container.innerHTML = "";
    Object.entries(odds).sort((a,b) => parseFloat(a[0]) - parseFloat(b[0])).forEach(([range, d]) => {
        const roi = ((d.r/d.s - 1)*100).toFixed(1);
        container.innerHTML += `<div class="row"><label class="chk-row"><input type="checkbox" checked class="rng-chk" value="${range}"><span>${range}</span></label><span class="roi-tag ${roi>=0?'pos':'neg'}">${roi}%</span></div>`;
    });
}

function updateAllDashboard() {
    const activeRanges = Array.from(document.querySelectorAll('.rng-chk:checked')).map(c => c.value);
    const filtered = allMatches.filter(m => activeRanges.includes(m.range));

    let stats = { s:0, r:0, w:0, maxLoss:0, currLoss:0, leagues:{}, teams:{} };

    filtered.forEach(m => {
        stats.s++;
        if(m.isWin) {
            stats.r += m.odd; stats.w++;
            stats.maxLoss = Math.max(stats.maxLoss, stats.currLoss);
            stats.currLoss = 0;
        } else { stats.currLoss++; }

        if(!stats.leagues[m.league]) stats.leagues[m.league] = { s:0, r:0, days:{}, hours:{}, teams:{} };
        let L = stats.leagues[m.league];
        L.s++; L.r += (m.isWin ? m.odd : 0);

        let day = "Otros", hhMatch = m.dateStr.match(/(\d{2}):(\d{2})/);
        const hh = hhMatch ? parseInt(hhMatch[1]) : -1;
        const dLow = m.dateStr.toLowerCase();
        if(dLow.includes('lun')) day="Lunes"; else if(dLow.includes('mar')) day="Martes"; else if(dLow.includes('mi√©')) day="Mi√©rcoles";
        else if(dLow.includes('jue')) day="Jueves"; else if(dLow.includes('vie')) day="Viernes"; else if(dLow.includes('s√°b')) day="S√°bado";
        else if(dLow.includes('dom')) day="Domingo";

        let slot = "Otros";
        if(hh >= 13 && hh < 18) slot="Tarde"; else if(hh >= 18 && hh < 22) slot="Noche";

        if(!L.days[day]) L.days[day] = {s:0, r:0}; L.days[day].s++; L.days[day].r += (m.isWin?m.odd:0);
        if(!L.hours[slot]) L.hours[slot] = {s:0, r:0}; L.hours[slot].s++; L.hours[slot].r += (m.isWin?m.odd:0);

        m.teams.forEach(t => {
            if(!t || t === '?') return;
            if(!L.teams[t]) L.teams[t] = {s:0, r:0}; L.teams[t].s++; L.teams[t].r += (m.isWin ? m.odd : 0);
            if(!stats.teams[t]) stats.teams[t] = {s:0, r:0}; stats.teams[t].s++; stats.teams[t].r += (m.isWin ? m.odd : 0);
        });
    });
    stats.maxLoss = Math.max(stats.maxLoss, stats.currLoss);
    renderUI(stats);
}

function renderUI(s) {
    const totalRoi = s.s > 0 ? ((s.r/s.s - 1)*100).toFixed(2) : 0;
    document.getElementById('simRoiTotal').innerText = `ROI FILTRADO: ${totalRoi}%`;
    document.getElementById('simRoiTotal').style.color = totalRoi >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('simStatsTotal').innerText = `${s.s} Partidos | Beneficio: ${(s.r - s.s).toFixed(2)} uds.`;

    document.getElementById('maxLoss').innerText = s.maxLoss;
    const br = (s.maxLoss * 3) + 5;
    document.getElementById('bankReq').innerText = br + " u.";
    document.getElementById('stakeSugg').innerText = s.s > 0 ? (100/br).toFixed(1) + "%" : "0%";

    const topTG = Object.entries(s.teams).filter(e => e[1].s > 1).sort((a,b) => (b[1].r/b[1].s) - (a[1].r/a[1].s)).slice(0, 6);
    document.getElementById('topTeamsGlobal').innerHTML = topTG.map(([n, d]) => `<div class="row"><span>${n}</span><span class="roi-tag pos">${((d.r/d.s-1)*100).toFixed(0)}%</span></div>`).join('');

    const lDiv = document.getElementById('leagueBreakdown');
    lDiv.innerHTML = "<h2 style='margin-top:30px;'>üî¨ Desglose por Liga Filtrada</h2>";
    
    Object.entries(s.leagues).sort((a,b) => b[1].s - a[1].s).forEach(([name, data]) => {
        const lRoi = ((data.r/data.s-1)*100).toFixed(1);
        const section = document.createElement('div');
        section.className = "league-section";
        section.id = `section-${name.replace(/\s/g, '')}`;
        section.dataset.teams = JSON.stringify(data.teams);
        section.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>${name} (${data.s} part.)</h4>
                <span class="roi-tag ${lRoi>=0?'pos':'neg'}">ROI: ${lRoi}%</span>
            </div>
            <div class="grid" style="margin-top:15px;">
                <div class="card" style="background:rgba(0,0,0,0.1)">
                    <h5>üìÖ Mejores D√≠as</h5>
                    ${Object.entries(data.days).sort((a,b)=>(b[1].r/b[1].s)-(a[1].r/a[1].s)).map(([day, sd]) => `<div class="row"><span>${day}</span><span class="${((sd.r/sd.s-1)*100)>=0?'pos':'neg'}">${((sd.r/sd.s-1)*100).toFixed(0)}%</span></div>`).join('')}
                </div>
                <div class="card" style="background:rgba(0,0,0,0.1)">
                    <h5>‚è∞ Mejores Horas</h5>
                    ${Object.entries(data.hours).sort((a,b)=>(b[1].r/b[1].s)-(a[1].r/a[1].s)).map(([h,sh]) => `<div class="row"><span>${h}</span><span class="${((sh.r/sh.s-1)*100)>=0?'pos':'neg'}">${((sh.r/sh.s-1)*100).toFixed(0)}%</span></div>`).join('')}
                </div>
                <div class="card" style="background:rgba(0,0,0,0.1)">
                    <h5>üî• Equipos Destacados</h5>
                    <div id="teams-list-${name.replace(/\s/g, '')}"><p style="font-size:11px; color:#94a3b8;">Carga los equipos de valor para esta liga.</p></div>
                    <button class="btn btn-mini" onclick="simulateTeamsInLeague('${name}')">SIMULAR EQUIPOS VALOR</button>
                </div>
            </div>`;
        lDiv.appendChild(section);
    });
}

function simulateTeamsInLeague(leagueName) {
    const section = document.getElementById(`section-${leagueName.replace(/\s/g, '')}`);
    const teamsData = JSON.parse(section.dataset.teams);
    const container = document.getElementById(`teams-list-${leagueName.replace(/\s/g, '')}`);
    
    const topTeams = Object.entries(teamsData)
        .map(([name, d]) => ({ name, roi: ((d.r/d.s-1)*100), s: d.s }))
        .sort((a,b) => b.roi - a.roi)
        .slice(0, 6);

    container.innerHTML = topTeams.map(t => {
        const isPremium = t.roi >= 20 && t.s >= 3;
        const cls = isPremium ? 'premium-team' : '';
        const fire = isPremium ? 'üî• ' : '';
        return `<div class="row ${cls}"><span>${fire}${t.name} <small>(${t.s}p)</small></span><span class="roi-tag ${t.roi>=0?'pos':'neg'}">${t.roi.toFixed(0)}%</span></div>`;
    }).join('');
}
</script>
</body>
</html>

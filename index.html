<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS - Pro Analytics & Deep Backtesting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --fondo: #050d0a;
            --card-bg: #101d18;
            --texto-blanco: #e0e7e4;
            --texto-amarillo: #ffdf1b;
            --accent-green: #00ff88;
            --input-bg: #000000;
            --border: #243a33;
            --delete: #ff4d4d;
            --blue-info: #00d4ff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--fondo);
            color: var(--texto-blanco);
            margin: 0;
            padding: 0;
        }

        /* --- NAVEGACI√ìN --- */
        .nav-tabs {
            display: flex;
            background: var(--card-bg);
            border-bottom: 2px solid var(--texto-amarillo);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-link {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #7f9c93;
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .tab-link.active {
            color: var(--texto-amarillo);
            background: rgba(255, 223, 27, 0.1);
        }

        .container {
            padding: 20px;
            max-width: 800px; /* Reducido para mejor lectura de una sola columna */
            margin: auto;
        }

        .screen { display: none; }
        .active-screen { display: block; }

        /* --- COMPONENTES --- */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .card h2 {
            margin: 0 0 15px 0;
            color: var(--texto-amarillo);
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 6px; }
        
        input, textarea, select {
            width: 100%; padding: 12px; background: var(--input-bg);
            border: 1px solid var(--border); color: white; border-radius: 6px;
            box-sizing: border-box; font-weight: bold; font-family: inherit;
            font-size: 0.9rem;
        }

        select { cursor: pointer; color: var(--accent-green); }

        textarea { resize: none; font-size: 0.8rem; height: 80px; margin-bottom: 10px; }

        .results-box {
            background: rgba(0,0,0,0.3);
            padding: 20px; border-radius: 8px; text-align: center; margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .recommendation {
            font-weight: 900; padding: 12px; border-radius: 4px;
            font-size: 0.9rem; display: block; margin-bottom: 15px;
        }

        .status-bet { background: #1b5e20; color: var(--accent-green); border: 1px solid var(--accent-green); }
        .status-no { background: #222; color: #777; border: 1px solid #444; }
        .status-danger { background: #4a0000; color: #ff8a80; border: 1px solid #ff4d4d; }

        .btn-register {
            width: 100%; padding: 14px; background: var(--accent-green);
            color: #000; border: none; border-radius: 6px; font-weight: bold;
            cursor: pointer; margin-top: 10px; display: none; font-size: 0.9rem;
        }

        .btn-clear {
            width: 100%; background: none; border: 1px solid #333; color: #555;
            padding: 8px; margin-top: 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
        }

        /* --- BOTONES DE CONTROL --- */
        .btn-toggle-bt {
            width: 100%; background: rgba(0, 212, 255, 0.05);
            border: 1px dashed var(--blue-info); color: var(--blue-info);
            padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;
            margin-bottom: 20px;
        }

        #backtest-wrapper { display: none; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- BACKTESTING GRID --- */
        .backtest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }

        .bt-card {
            background: rgba(0, 212, 255, 0.03); border: 1px solid rgba(0, 212, 255, 0.2);
            padding: 12px; border-radius: 10px;
        }

        .bt-card h3 { font-size: 0.7rem; color: var(--blue-info); text-transform: uppercase; margin: 0 0 10px 0; border-bottom: 1px solid rgba(0, 212, 255, 0.1); padding-bottom: 5px; }

        .bt-header, .insight-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; font-size: 0.7rem; }
        .bt-header { color: #555; font-weight: bold; margin-bottom: 5px; }
        .insight-row { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }

        .val-pos { color: var(--accent-green); font-weight: bold; }
        .val-neg { color: var(--delete); font-weight: bold; }

        /* --- STATS Y CHART --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 1.1rem; font-weight: 900; display: block; }

        .chart-container { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 25px; height: 220px; }

        /* --- HISTORIAL --- */
        .history-item { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #444; }
        .history-item.win { border-left-color: var(--accent-green); }
        .history-item.loss { border-left-color: var(--delete); }
        .history-league { font-size: 0.65rem; color: var(--blue-info); text-transform: uppercase; font-weight: bold; }
        .history-event { font-size: 0.9rem; color: var(--texto-amarillo); font-weight: bold; display: block; margin: 4px 0; }
        .history-date { font-size: 0.65rem; color: #777; }
        .actions { display: flex; gap: 10px; margin-top: 12px; }
        .btn-win { background: var(--accent-green); border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-loss { background: var(--delete); border: none; padding: 8px; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-del { background: #222; border: 1px solid var(--border); color: var(--delete); padding: 5px 12px; border-radius: 4px; cursor: pointer; }

    </style>
</head>
<body>

    <div class="nav-tabs">
        <div class="tab-link active" onclick="nav('calc-screen', this)"><i class="fa-solid fa-calculator"></i> Calculadora</div>
        <div class="tab-link" onclick="nav('control-screen', this)"><i class="fa-solid fa-chart-line"></i> Control</div>
    </div>

    <div class="container">
        
        <div id="calc-screen" class="screen active-screen">
            <div style="background: rgba(0,255,136,0.05); padding: 10px; border-radius: 8px; border: 1px solid var(--accent-green); margin-bottom: 20px; text-align: center; font-size: 0.8rem;">
                <i class="fa-solid fa-bank"></i> Gesti√≥n: <b>Kelly 25%</b> | Banca <b>$100.00</b>
            </div>

            <div class="card">
                <h2><i class="fa-solid fa-flask"></i> An√°lisis de Valor</h2>
                
                <div style="margin-bottom: 20px;">
                    <label>Selecciona Mercado</label>
                    <select id="market-select" onchange="runCalc()">
                        <option value="OVER (Goles)">OVER (Goles)</option>
                        <option value="UNDER (Goles)">UNDER (Goles)</option>
                        <option value="BTTS: S√ç">BTTS: S√ç</option>
                        <option value="BTTS: NO">BTTS: NO</option>
                    </select>
                </div>

                <div class="input-group">
                    <div>
                        <label>Cuota Mercado</label>
                        <input type="number" id="odds" step="0.01" placeholder="1.90" oninput="runCalc()">
                    </div>
                    <div>
                        <label>Cuota Contra (No Ocurre)</label>
                        <input type="number" id="contra" step="0.01" placeholder="2.10" oninput="runCalc()">
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Tu Probabilidad Estimada %</label>
                    <input type="number" id="prob" step="0.1" placeholder="55" oninput="runCalc()">
                </div>

                <div class="results-box">
                    <span id="rec-display" class="recommendation status-no">INTRODUCE DATOS</span>
                    
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:15px; padding: 0 10px;">
                        <span>Edge: <b id="edge-display" style="color:var(--blue-info)">0.00%</b></span>
                        <span>Overround: <b id="ovr-display">0.00%</b></span>
                    </div>

                    <label>Datos del Evento (Pega aqu√≠)</label>
                    <textarea id="event-data" placeholder="Ej: Liga üÜö Equipos üóìÔ∏è Fecha"></textarea>
                    
                    <div style="text-align:left; margin-top: 10px;">
                        <label>Stake Sugerido (Kelly Fractional)</label>
                        <input type="number" id="stake-display" value="0.00">
                    </div>

                    <button id="btn-reg" class="btn-register" onclick="registerBet()">REGISTRAR EN CONTROL</button>
                </div>

                <button class="btn-clear" onclick="clearCalc()">Limpiar Campos</button>
            </div>
        </div>

        <div id="control-screen" class="screen">
            
            <div class="stats-grid">
                <div class="stat-box">
                    <span style="font-size:0.55rem; color:#888;">PROFIT</span>
                    <span id="stat-profit" class="stat-val">0.00$</span>
                </div>
                <div class="stat-box">
                    <span style="font-size:0.55rem; color:#888;">WIN RATE</span>
                    <span id="stat-wr" class="stat-val">0%</span>
                </div>
                <div class="stat-box">
                    <span style="font-size:0.55rem; color:#888;">YIELD</span>
                    <span id="stat-yield" class="stat-val">0%</span>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="growthChart"></canvas>
            </div>

            <button class="btn-toggle-bt" id="toggle-bt-btn" onclick="toggleBacktest()">
                <i class="fa-solid fa-eye"></i> MOSTRAR BACKTESTING DETALLADO
            </button>

            <div id="backtest-wrapper">
                <div class="backtest-grid" id="backtest-results"></div>
            </div>

            <h2 style="color: var(--texto-amarillo); font-size: 1rem; margin-bottom: 15px;"><i class="fa-solid fa-list"></i> Historial</h2>
            <div id="history-list"></div>
            
            <button onclick="clearAllHistory()" style="width:100%; background:none; color:var(--delete); border:1px solid var(--delete); padding:10px; border-radius:6px; margin-top:20px; cursor:pointer; font-weight:bold; font-size: 0.7rem;">RESETEAR SISTEMA</button>
        </div>

    </div>

    <script>
        const BANCA_BASE = 100;
        const KELLY_FRACTION = 0.25;

        let apuestas = JSON.parse(localStorage.getItem('betags_history')) || [];
        let growthChart = null;
        let showBacktest = false;

        function toggleBacktest() {
            showBacktest = !showBacktest;
            const wrapper = document.getElementById('backtest-wrapper');
            const btn = document.getElementById('toggle-bt-btn');
            wrapper.style.display = showBacktest ? "block" : "none";
            btn.innerHTML = showBacktest ? '<i class="fa-solid fa-eye-slash"></i> OCULTAR BACKTESTING' : '<i class="fa-solid fa-eye"></i> MOSTRAR BACKTESTING DETALLADO';
        }

        function runCalc() {
            const odds = parseFloat(document.getElementById('odds').value);
            const contra = parseFloat(document.getElementById('contra').value);
            const prob = parseFloat(document.getElementById('prob').value);
            
            const recEl = document.getElementById('rec-display');
            const edgeEl = document.getElementById('edge-display');
            const ovrEl = document.getElementById('ovr-display');
            const btnReg = document.getElementById('btn-reg');
            const stakeInput = document.getElementById('stake-display');

            if (odds > 1 && contra > 1 && prob > 0) {
                const overround = ((1/odds) + (1/contra) - 1) * 100;
                const edge = ((odds * (prob / 100)) - 1) * 100;

                ovrEl.innerText = overround.toFixed(2) + "%";
                edgeEl.innerText = edge.toFixed(2) + "%";

                const p = prob / 100;
                const fKelly = Math.max(0, ((p * odds - 1) / (odds - 1)) * KELLY_FRACTION);
                const stakeFinal = BANCA_BASE * fKelly;

                if (edge >= 3 && overround <= 8 && edge > overround) {
                    recEl.innerText = "‚úì APUESTA RENTABLE";
                    recEl.className = "recommendation status-bet";
                    btnReg.style.display = "block";
                    stakeInput.value = stakeFinal.toFixed(2);
                } else if (edge > 0) {
                    recEl.innerText = "‚ö† VALOR BAJO / RIESGO";
                    recEl.className = "recommendation status-danger";
                    btnReg.style.display = "block";
                    stakeInput.value = stakeFinal.toFixed(2);
                } else {
                    recEl.innerText = "‚úó SIN VALOR";
                    recEl.className = "recommendation status-no";
                    btnReg.style.display = "none";
                    stakeInput.value = "0.00";
                }
            } else {
                recEl.innerText = "INTRODUCE DATOS";
                recEl.className = "recommendation status-no";
                btnReg.style.display = "none";
            }
        }

        function registerBet() {
            const odds = parseFloat(document.getElementById('odds').value);
            const edge = parseFloat(document.getElementById('edge-display').innerText);
            const ovr = parseFloat(document.getElementById('ovr-display').innerText);
            const stake = parseFloat(document.getElementById('stake-display').value) || 0;
            const market = document.getElementById('market-select').value;
            const rawEvent = document.getElementById('event-data').value.trim();

            let liga = "General", partido = "Evento Manual", fecha = "S/D";

            if (rawEvent.includes('üÜö')) {
                const parts = rawEvent.split(/[üÜöüóìÔ∏è]/);
                liga = parts[0]?.trim() || "General";
                partido = parts[1]?.trim() || "Evento";
                fecha = parts[2]?.trim() || "Hoy";
            } else {
                partido = rawEvent || "Apuesta r√°pida";
            }

            const now = new Date();
            const nueva = {
                id: Date.now(),
                timestamp: now.getTime(),
                liga, partido, fecha_evento: fecha,
                mercado: market,
                cuota: odds, edge, overround: ovr, stake,
                status: 'pending',
                registro: now.toLocaleString()
            };

            apuestas.unshift(nueva);
            localStorage.setItem('betags_history', JSON.stringify(apuestas));
            clearCalc();
            alert("¬°Registrada!");
        }

        function loadHistory() {
            const list = document.getElementById('history-list');
            let profit = 0, inv = 0, wins = 0, total = 0;
            const chartData = [0];

            const stats = { mercado: {}, cuota: {}, edge: {}, dia: {}, hora: {}, liga: {} };
            const diasArr = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

            apuestas.forEach(a => {
                if (a.status !== 'pending') {
                    const isWin = a.status === 'win';
                    const res = isWin ? (a.cuota - 1) * a.stake : -a.stake;
                    
                    const d = new Date(a.timestamp);
                    const dia = diasArr[d.getDay()];
                    const hora = d.getHours() + ":00";
                    const rCuota = a.cuota < 1.7 ? 'Baja' : (a.cuota < 2.2 ? 'Media' : 'Alta');
                    const rEdge = a.edge < 7 ? 'Bajo' : 'Alto';

                    const update = (obj, k) => {
                        if(!obj[k]) obj[k] = { p: 0, i: 0, w: 0, c: 0 };
                        obj[k].p += res; obj[k].i += a.stake; obj[k].c++;
                        if(isWin) obj[k].w++;
                    };

                    update(stats.mercado, a.mercado);
                    update(stats.cuota, rCuota);
                    update(stats.edge, rEdge);
                    update(stats.dia, dia);
                    update(stats.hora, hora);
                    update(stats.liga, a.liga);

                    profit += res; inv += a.stake; total++;
                    if(isWin) wins++;
                }
            });

            [...apuestas].reverse().filter(x => x.status !== 'pending').forEach(x => {
                chartData.push(chartData[chartData.length-1] + (x.status==='win' ? (x.cuota-1)*x.stake : -x.stake));
            });

            renderBT(stats);

            list.innerHTML = apuestas.map(a => `
                <div class="history-item ${a.status}">
                    <span class="history-league">${a.liga}</span>
                    <span class="history-event">${a.partido}</span>
                    <span class="history-date">${a.fecha_evento} | Edge: ${a.edge}%</span>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:8px;">
                        <span>${a.mercado} @${a.cuota}</span>
                        <span>$${a.stake.toFixed(2)}</span>
                    </div>
                    <div class="actions">
                        ${a.status === 'pending' ? `
                            <button class="btn-win" onclick="upd(${a.id},'win')">W</button>
                            <button class="btn-loss" onclick="upd(${a.id},'loss')">L</button>
                        ` : `<b>${a.status.toUpperCase()}</b>`}
                        <button class="btn-del" onclick="del(${a.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            document.getElementById('stat-profit').innerText = profit.toFixed(2) + "$";
            document.getElementById('stat-profit').style.color = profit >= 0 ? "var(--accent-green)" : "var(--delete)";
            document.getElementById('stat-wr').innerText = total > 0 ? ((wins/total)*100).toFixed(0) + "%" : "0%";
            document.getElementById('stat-yield').innerText = inv > 0 ? ((profit/inv)*100).toFixed(1) + "%" : "0%";
            updateChart(chartData);
        }

        function renderBT(s) {
            const container = document.getElementById('backtest-results');
            const box = (t, d) => {
                let h = `<div class="bt-card"><h3>${t}</h3><div class="bt-header"><span>Cat.</span><span>P/L</span><span>WR</span><span>Yld</span></div>`;
                Object.keys(d).forEach(k => {
                    const x = d[k];
                    const y = ((x.p/x.i)*100).toFixed(1);
                    h += `<div class="insight-row"><span>${k}</span><span class="${x.p>=0?'val-pos':'val-neg'}">${x.p.toFixed(1)}</span><span>${((x.w/x.c)*100).toFixed(0)}%</span><span style="font-size:0.6rem">${y}%</span></div>`;
                });
                return h + `</div>`;
            };
            container.innerHTML = box('Mercados', s.mercado) + box('Cuotas', s.cuota) + box('D√≠a', s.dia) + box('Hora', s.hora) + box('Ligas', s.liga);
        }

        function updateChart(pts) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            if (growthChart) growthChart.destroy();
            growthChart = new Chart(ctx, {
                type: 'line',
                data: { labels: pts.map((_,i)=>i), datasets: [{ data: pts, borderColor: '#00ff88', tension: 0.3, fill: true, backgroundColor: 'rgba(0,255,136,0.1)', pointRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#555', font: { size: 9 } } } } }
            });
        }

        function upd(id, st) {
            const idx = apuestas.findIndex(a => a.id === id);
            apuestas[idx].status = st;
            localStorage.setItem('betags_history', JSON.stringify(apuestas));
            loadHistory();
        }

        function del(id) {
            if(confirm("¬øEliminar?")) {
                apuestas = apuestas.filter(a => a.id !== id);
                localStorage.setItem('betags_history', JSON.stringify(apuestas));
                loadHistory();
            }
        }

        function clearAllHistory() { if(confirm("¬øBorrar todo?")) { apuestas = []; localStorage.clear(); loadHistory(); } }

        function clearCalc() {
            ['odds','contra','prob','event-data'].forEach(id => document.getElementById(id).value = "");
            runCalc();
        }

        function nav(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active-screen');
            el.classList.add('active');
            if(id === 'control-screen') loadHistory();
        }

        loadHistory();
    </script>
</body>
</html>

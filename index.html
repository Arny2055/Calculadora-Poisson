<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Modelo de Conteo Combinado (ZINB/Hurdle)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 30px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        textarea { height: 150px; resize: vertical; }
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; margin-top: 20px; width: 100%; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        #resultados { margin-top: 30px; padding: 20px; border: 2px solid #007bff; border-radius: 8px; background-color: #e9f7ff; }
        #resultados h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        .result-item { margin-top: 10px; padding: 8px; border-left: 4px solid #007bff; background-color: #fff; border-radius: 4px; }
        .alert-error { color: #dc3545; font-weight: bold; margin-top: 15px; }
        .simulacion-notice { color: #ffc107; background-color: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffc107; }
    </style>
</head>
<body>

<div class="container">
    <h1>Modelo de Predicción para Datos de Conteo (Simulado)</h1>
    <div class="simulacion-notice">
        ⚠️ **AVISO:** Los cálculos son simulados. Un modelo real ZINB/Hurdle requiere ser entrenado en un servidor con datos históricos.
    </div>

    <form id="analisisForm">
        <label for="liga">Liga:</label>
        <input type="text" id="liga" value="Brazil Serie B" required>

        <label for="local">Equipo Local:</label>
        <input type="text" id="local" value="ABC" required>

        <label for="visita">Equipo Visitante:</label>
        <input type="text" id="visita" value="Mirassol" required>

        <label for="jsonInput">Pega tu JSON de características aquí:</label>
        <textarea id="jsonInput" placeholder='{"Name":"Ligas Over 2.5 3 horas", "Home Attacks at FT":"99", ...}' required>
{"Name":"Ligas Over 2.5 3 horas","Desired Outcome":"O25","Odd":"2.75","Date":"mar., 10 oct. 2023 18:30","League":"Brazil Serie B","Match":"ABC - Mirassol","Home Attacks at FT":"99","Away Attacks at FT":"109","Home Dangerous Attacks at FT":"38","Away Dangerous Attacks at FT":"45","Home OnGoal Shots at FT":"8","Away OnGoal Shots at FT":"5","Home Total Shots at FT":"18","Away Total Shots at FT":"11","Home Ball Possession at FT":"51","Away Ball Possession at FT":"49","Home Corners at FT":"9","Away Corners at FT":"0","Home RedCards at FT":"0","Away RedCards at FT":"0","Home YellowCards at FT":"2","Away YellowCards at FT":"3","Result HT":"0-2","Result FT":"1-2","Odd 1 PreMatch":"5.50","Odd X PreMatch":"3.20","Odd 2 PreMatch":"1.80","Home Position":"20","Away Position":"8","Result":"Winning","Success Rate":"","Overall ROI":""}
        </textarea>

        <button type="submit">Ejecutar Modelo Combinado (Simulado)</button>
    </form>

    <div id="resultados">
        <h2>Resultados del Modelo (Simulado)</h2>
        <p class="alert-error" id="errorMsg" style="display: none;"></p>
        <div id="modelOutput">
            <p>Introduce los datos y presiona "Ejecutar" para ver la simulación.</p>
        </div>
    </div>
</div>

<script>
    document.getElementById('analisisForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const jsonText = document.getElementById('jsonInput').value;
        const errorMsg = document.getElementById('errorMsg');
        const outputDiv = document.getElementById('modelOutput');
        outputDiv.innerHTML = '';
        errorMsg.style.display = 'none';

        try {
            const data = JSON.parse(jsonText);
            
            // --- SIMULACIÓN DEL MODELO COMBINADO (ZINB) ---
            // Un modelo ZINB (Zero-Inflated Negative Binomial) predice dos cosas:
            // 1. La probabilidad de que el conteo sea cero (el componente cero-inflado).
            // 2. La media de conteo (el componente Binomial Negativo).

            // 1. Extracción de variables clave (Las que influyen en los conteos de goles)
            const H_ATT = parseInt(data["Home Attacks at FT"]);
            const A_ATT = parseInt(data["Away Attacks at FT"]);
            const H_DA = parseInt(data["Home Dangerous Attacks at FT"]);
            const A_DA = parseInt(data["Away Dangerous Attacks at FT"]);
            const H_SOG = parseInt(data["Home OnGoal Shots at FT"]);
            const A_SOG = parseInt(data["Away OnGoal Shots at FT"]);
            const H_POS = parseInt(data["Home Ball Possession at FT"]);
            const A_POS = parseInt(data["Away Ball Possession at FT"]);
            const H_POS_DIFF = H_POS - A_POS;
            const POS_AWAY = parseInt(data["Away Position"]);
            const POS_HOME = parseInt(data["Home Position"]);

            // 2. Componente de Cero-Inflado (Probabilidad de 0-0 "Estructural")
            // Los ceros estructurales (ej. 0-0) son más probables si la posesión es equilibrada y hay pocos tiros a puerta.
            // Coeficientes Simulados: (log(p/(1-p))) = C0 + C1*H_SOG + C2*POS_DIFF + ...
            const logit_zero = 3.5 - 0.2 * H_SOG - 0.2 * A_SOG - 0.05 * Math.abs(H_DA - A_DA);
            const prob_zero = 1 / (1 + Math.exp(-logit_zero)); // Probabilidad de 0 goles

            // 3. Componente de Conteo (Binomial Negativo)
            // Predicción de Goles Totales (Media mu).
            // Coeficientes Simulados: (log(mu)) = C0 + C1*H_DA + C2*A_SOG + C3*Posición
            const log_mu = 1.0 + 0.005 * H_DA + 0.05 * A_SOG + 0.01 * (POS_HOME - POS_AWAY);
            const mu_total_simulado = Math.exp(log_mu);
            
            // 4. Parámetro de Dispersión (Propiedad de la Binomial Negativa)
            // El parámetro 'theta' o 'alpha' del NB. Un valor bajo (ej. 0.5) indica alta sobredispersión.
            const dispersion_theta_simulado = 1.5; // Simulación: Dispersión moderada.

            // 5. Cálculo final de Probabilidades Simulado
            // La probabilidad de O25 es la suma de P(3) + P(4) + P(5) + ...
            // Usamos una aproximación simplificada de la Binomial Negativa:
            const P_OVER_25_SIM = 1 - (
                0.3 * Math.exp(-mu_total_simulado) + // P(0)
                0.4 * Math.exp(-mu_total_simulado) * mu_total_simulado + // P(1)
                0.3 * Math.pow(mu_total_simulado, 2) * Math.exp(-mu_total_simulado) / 2 // P(2)
            );
            
            // Ajustamos la probabilidad con el componente cero-inflado:
            // P(0) del modelo ZINB = P(Cero Estructural) + P(Cero de Conteo)
            const P_0_ZINB = prob_zero + (1 - prob_zero) * 0.3 * Math.exp(-mu_total_simulado);
            
            const Probabilidad_O25_final = (1 - P_0_ZINB) * P_OVER_25_SIM * 0.8 + 0.15; // Ajuste heurístico para la O25 real

            // --- MOSTRAR RESULTADOS ---
            outputDiv.innerHTML = `
                <h2>Análisis del Partido: ${data.Match}</h2>
                <div class="result-item"><strong>Liga:</strong> ${data.League}</div>
                <div class="result-item"><strong>Resultado Final (JSON):</strong> ${data["Result FT"]} (Cuota: ${data.Odd})</div>
                
                <h3>Componente de Cero-Inflado (Modelo Binario)</h3>
                <div class="result-item">
                    Probabilidad de **Cero Goles Estructurales (P(0)):** ${ (prob_zero * 100).toFixed(2) }%
                    <br><small> *(Si esta es alta, el modelo sugiere que un 0-0 es probable debido a factores no aleatorios).*</small>
                </div>

                <h3>Componente de Conteo (Binomial Negativa)</h3>
                <div class="result-item">
                    **Goles Totales Esperados ( $\\mu_{simulado}$ ):** ${mu_total_simulado.toFixed(2)}
                    <br><small> *(Predicción media del conteo de goles, ajustada por factores de ataque).*</small>
                </div>
                <div class="result-item">
                    **Parámetro de Dispersión ( $\\theta_{NB}$ ):** ${dispersion_theta_simulado.toFixed(2)}
                    <br><small> *(Indica la Sobredispersión. Un valor más alto significa menor varianza que un modelo NB).*</small>
                </div>

                <h3>Predicción Final Combinada (O2.5)</h3>
                <div class="result-item" style="font-size: 1.2em; background-color: #d4edda; border-left-color: #28a745;">
                    **Probabilidad Predicha O2.5:** <strong>${ (Probabilidad_O25_final * 100).toFixed(2) }%</strong>
                </div>
                <div class="result-item">
                    **Valor Esperado (EV):** ${((data.Odd - 1) * Probabilidad_O25_final - (1 - Probabilidad_O25_final)).toFixed(3)}
                    <br><small> *(Si el EV es positivo, el valor es favorable respecto a la cuota).*</small>
                </div>
            `;

        } catch (e) {
            console.error(e);
            errorMsg.textContent = 'Error al parsear el JSON. Asegúrate de que el formato es correcto.';
            errorMsg.style.display = 'block';
        }
    });
</script>

</body>
</html>

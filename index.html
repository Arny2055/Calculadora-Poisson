<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Análisis de Fútbol Avanzado y Mercados</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        h1, h2 {
            color: #004d40;
            border-bottom: 2px solid #004d40;
            padding-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #dddddd;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background-color: #e0f2f1;
            color: #004d40;
            cursor: help;
            font-size: 0.9em;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .positive {
            color: #2e7d32; /* Verde oscuro */
            font-weight: bold;
        }
        .negative {
            color: #c62828; /* Rojo oscuro */
        }
        .neutral {
            color: #333;
        }
        .analysis-section {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 5px solid #004d40;
        }
        .market-prediction {
            background-color: #fff3e0;
            border-left: 5px solid #ff9800;
            margin-top: 30px;
            padding: 15px;
            border-radius: 8px;
        }
        .market-prediction h3 {
            color: #e65100;
            border-bottom: 1px solid #ff9800;
        }
        .market-table {
            width: 50%;
            float: left;
            margin-right: 20px;
        }
        .market-table th {
            background-color: #ffe0b2;
            color: #e65100;
        }
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
    </style>
</head>
<body>

    <h1>⚽ Herramienta de Análisis de Fútbol Avanzado</h1>
    
    <h2>Tabla de Clasificación y Rendimiento ($\text{xG}$)</h2>
    
    <div id="table-container">
        </div>

    <div class="analysis-section">
        <h2>📊 Resumen del Rendimiento General ($\text{GD} - \text{xGD}$)</h2>
        <p>El análisis identifica la diferencia entre el **Rendimiento Real** ($\text{GD}$) y el **Rendimiento Esperado** ($\text{xGD}$).</p>
        
        <p>🥇 **Mayor Sobre-rendimiento:** **Sevilla** ($\mathbf{+7.20}$): Sus resultados son mucho mejores que la calidad de sus ocasiones, sugiriendo gran eficacia.</p>
        <p>📉 **Mayor Sub-rendimiento:** **Valencia** ($\mathbf{-2.30}$): Sus resultados son peores que la calidad de sus ocasiones, sugiriendo falta de puntería o errores defensivos.</p>
    </div>

    <div class="market-prediction clearfix">
        <h2>📈 Predicción de Mercados (Modelo de Poisson)</h2>
        <p>Ejemplo: **Real Madrid (Local) vs. Barcelona (Visitante)**</p>
        
        <div id="prediction-results">
            </div>
    </div>

    <script>
        const data = [
            {"Rk":"1","Squad":"Real Madrid","MP":4,"W":3,"D":0,"L":1,"GF":11,"GA":7,"GD":4,"Pts":9,"Pts/MP":2.25,"xG":9.6,"xGA":6.5,"xGD":3.0,"xGD/90":0.76},
            {"Rk":"2","Squad":"Barcelona","MP":5,"W":3,"D":1,"L":1,"GF":11,"GA":8,"GD":3,"Pts":10,"Pts/MP":2.00,"xG":10.0,"xGA":7.7,"xGD":2.3,"xGD/90":0.46},
            {"Rk":"3","Squad":"Villarreal","MP":4,"W":1,"D":1,"L":2,"GF":4,"GA":7,"GD":-3,"Pts":4,"Pts/MP":1.00,"xG":5.0,"xGA":6.4,"xGD":-1.4,"xGD/90":-0.34},
            {"Rk":"4","Squad":"Betis","MP":4,"W":1,"D":3,"L":0,"GF":6,"GA":5,"GD":1,"Pts":6,"Pts/MP":1.50,"xG":5.6,"xGA":4.5,"xGD":1.1,"xGD/90":0.27},
            {"Rk":"5","Squad":"Atlético Madrid","MP":4,"W":0,"D":3,"L":1,"GF":4,"GA":5,"GD":-1,"Pts":3,"Pts/MP":0.75,"xG":4.7,"xGA":4.7,"xGD":0.0,"xGD/90":-0.01},
            {"Rk":"6","Squad":"Sevilla","MP":4,"W":3,"D":0,"L":1,"GF":7,"GA":4,"GD":3,"Pts":9,"Pts/MP":2.25,"xG":3.3,"xGA":7.6,"xGD":-4.2,"xGD/90":-1.06},
            {"Rk":"7","Squad":"Elche","MP":4,"W":0,"D":3,"L":1,"GF":5,"GA":7,"GD":-2,"Pts":3,"Pts/MP":0.75,"xG":2.7,"xGA":5.3,"xGD":-2.5,"xGD/90":-0.63},
            {"Rk":"8","Squad":"Athletic Club","MP":3,"W":1,"D":0,"L":2,"GF":2,"GA":4,"GD":-2,"Pts":3,"Pts/MP":1.00,"xG":2.9,"xGA":3.7,"xGD":-0.8,"xGD/90":-0.27},
            {"Rk":"9","Squad":"Espanyol","MP":3,"W":0,"D":2,"L":1,"GF":2,"GA":4,"GD":-2,"Pts":2,"Pts/MP":0.67,"xG":3.8,"xGA":3.3,"xGD":0.5,"xGD/90":0.18},
            {"Rk":"10","Squad":"Alavés","MP":4,"W":1,"D":1,"L":2,"GF":2,"GA":3,"GD":-1,"Pts":4,"Pts/MP":1.00,"xG":2.6,"xGA":4.0,"xGD":-1.4,"xGD/90":-0.35},
            {"Rk":"11","Squad":"Getafe","MP":5,"W":2,"D":0,"L":3,"GF":5,"GA":9,"GD":-4,"Pts":6,"Pts/MP":1.20,"xG":4.0,"xGA":4.7,"xGD":-0.7,"xGD/90":-0.15},
            {"Rk":"12","Squad":"Osasuna","MP":4,"W":0,"D":0,"L":4,"GF":1,"GA":6,"GD":-5,"Pts":0,"Pts/MP":0.00,"xG":4.2,"xGA":6.0,"xGD":-1.8,"xGD/90":-0.45},
            {"Rk":"13","Squad":"Levante","MP":5,"W":2,"D":1,"L":2,"GF":8,"GA":5,"GD":3,"Pts":7,"Pts/MP":1.40,"xG":7.6,"xGA":4.6,"xGD":3.0,"xGD/90":0.60},
            {"Rk":"14","Squad":"Rayo Vallecano","MP":5,"W":2,"D":0,"L":3,"GF":6,"GA":7,"GD":-1,"Pts":6,"Pts/MP":1.20,"xG":7.2,"xGA":8.0,"xGD":-0.8,"xGD/90":-0.16},
            {"Rk":"15","Squad":"Valencia","MP":4,"W":0,"D":1,"L":3,"GF":3,"GA":11,"GD":-8,"Pts":1,"Pts/MP":0.25,"xG":2.5,"xGA":8.2,"xGD":-5.7,"xGD/90":-1.43},
            {"Rk":"16","Squad":"Celta Vigo","MP":3,"W":0,"D":2,"L":1,"GF":3,"GA":4,"GD":-1,"Pts":2,"Pts/MP":0.67,"xG":2.4,"xGA":5.3,"xGD":-2.9,"xGD/90":-0.95},
            {"Rk":"17","Squad":"Oviedo","MP":4,"W":1,"D":0,"L":3,"GF":2,"GA":6,"GD":-4,"Pts":3,"Pts/MP":0.75,"xG":3.1,"xGA":6.1,"xGD":-3.0,"xGD/90":-0.75},
            {"Rk":"18","Squad":"Girona","MP":3,"W":0,"D":2,"L":1,"GF":2,"GA":7,"GD":-5,"Pts":2,"Pts/MP":0.67,"xG":1.6,"xGA":6.2,"xGD":-4.6,"xGD/90":-1.54},
            {"Rk":"19","Squad":"Real Sociedad","MP":4,"W":0,"D":1,"L":3,"GF":3,"GA":7,"GD":-4,"Pts":1,"Pts/MP":0.25,"xG":3.7,"xGA":6.9,"xGD":-3.2,"xGD/90":-0.81},
            {"Rk":"20","Squad":"Mallorca","MP":4,"W":0,"D":0,"L":4,"GF":4,"GA":8,"GD":-4,"Pts":0,"Pts/MP":0.00,"xG":4.0,"xGA":8.9,"xGD":-4.9,"xGD/90":-1.23}
        ];

        // ----------------------------------------------------
        // CÁLCULOS AUXILIARES DE RENDIMIENTO (GD vs xGD)
        // ----------------------------------------------------
        function calculatePerformance(team) {
            const attPerf = (team.GF - team.xG).toFixed(2);
            const defPerf = (team.xGA - team.GA).toFixed(2);
            const overallPerf = (team.GD - team.xGD).toFixed(2);
            return { attPerf, defPerf, overallPerf };
        }

        function formatValue(value) {
            const num = parseFloat(value);
            let className = 'neutral';
            if (num > 0) {
                className = 'positive';
            } else if (num < 0) {
                className = 'negative';
            }
            return `<span class="${className}">${value}</span>`;
        }

        // ----------------------------------------------------
        // GENERACIÓN DE LA TABLA PRINCIPAL
        // ----------------------------------------------------
        function generateMainTable() {
            const table = document.createElement('table');
            const headerRow = table.insertRow();
            const headers = ["Rk", "Squad", "MP", "W", "D", "L", "GF", "GA", "GD", "Pts", "Pts/MP", "xG", "xGA", "xGD", "xGD/90", "Att_Perf", "Def_Perf", "Overall_Perf"];
            const tooltips = {
                "Rk": "Clasificación.", "Squad": "Equipo.", "MP": "Partidos Jugados.", "W": "Victorias.", "D": "Empates.", "L": "Derrotas.", "GF": "Goles a Favor.", "GA": "Goles en Contra.", "GD": "Diferencia de Goles.", "Pts": "Puntos.", "Pts/MP": "Puntos por Partido.",
                "xG": "Goles Esperados.", "xGA": "Goles Esperados en Contra.", "xGD": "Diferencia de Goles Esperados.", "xGD/90": "xGD por 90 minutos.",
                "Att_Perf": "Rendimiento de Ataque (GF - xG).", "Def_Perf": "Rendimiento Defensivo (xGA - GA).", "Overall_Perf": "Rendimiento General (GD - xGD).",
            };

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.setAttribute('title', tooltips[header]);
                headerRow.appendChild(th);
            });

            data.forEach(team => {
                const perf = calculatePerformance(team);
                const row = table.insertRow();
                row.insertCell().textContent = team.Rk;
                row.insertCell().textContent = team.Squad;
                row.insertCell().textContent = team.MP;
                row.insertCell().textContent = team.W;
                row.insertCell().textContent = team.D;
                row.insertCell().textContent = team.L;
                row.insertCell().textContent = team.GF;
                row.insertCell().textContent = team.GA;
                row.insertCell().innerHTML = formatValue(team.GD);
                row.insertCell().textContent = team.Pts;
                row.insertCell().textContent = team['Pts/MP'];
                row.insertCell().textContent = team.xG;
                row.insertCell().textContent = team.xGA;
                row.insertCell().innerHTML = formatValue(team.xGD.toFixed(2));
                row.insertCell().innerHTML = formatValue(team['xGD/90'].toFixed(2));
                row.insertCell().innerHTML = formatValue(perf.attPerf);
                row.insertCell().innerHTML = formatValue(perf.defPerf);
                row.insertCell().innerHTML = formatValue(perf.overallPerf);
            });

            document.getElementById('table-container').appendChild(table);
        }

        // ----------------------------------------------------
        // CÁLCULOS DEL MODELO DE POISSON
        // ----------------------------------------------------

        // Función factorial
        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        // Distribución de Poisson
        function poisson(lambda, k) {
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }

        function calculateMarketPrediction() {
            // 1. Promedios de la Liga
            const totalXG = data.reduce((sum, team) => sum + team.xG, 0);
            const totalMP = data.reduce((sum, team) => sum + team.MP, 0);
            const avgXGPerMatch = totalXG / totalMP; // ~0.8935897

            // Parámetros del Partido (Real Madrid vs Barcelona)
            const teamHome = data.find(t => t.Squad === 'Real Madrid');
            const teamAway = data.find(t => t.Squad === 'Barcelona');
            const homeAdvantage = 1.25; // Factor de ventaja de localía

            if (!teamHome || !teamAway) return;

            // 2. Tasa de Ataque y Defensa
            const homeAttRate = (teamHome.xG / teamHome.MP) / avgXGPerMatch; // 2.685
            const homeDefRate = (teamHome.xGA / teamHome.MP) / avgXGPerMatch; // 1.818
            const awayAttRate = (teamAway.xG / teamAway.MP) / avgXGPerMatch; // 2.237
            const awayDefRate = (teamAway.xGA / teamAway.MP) / avgXGPerMatch; // 1.722

            // 3. Goles Esperados (Lambda)
            const lambdaHome = homeAttRate * awayDefRate * avgXGPerMatch * homeAdvantage; // 5.17
            const lambdaAway = awayAttRate * homeDefRate * avgXGPerMatch; // 3.64

            // 4. Calcular Matriz de Probabilidades (hasta 7 goles)
            const maxGoals = 7;
            let probHomeWin = 0;
            let probDraw = 0;
            let probAwayWin = 0;
            let totalProb = 0;
            
            // Usamos un array para almacenar las probabilidades de Over/Under para evitar recálculos
            let probTotalGoals = new Array(maxGoals * 2 + 1).fill(0); // Hasta 14 goles

            for (let i = 0; i <= maxGoals; i++) { // Goles Local (Real Madrid)
                for (let j = 0; j <= maxGoals; j++) { // Goles Visitante (Barcelona)
                    let prob = poisson(lambdaHome, i) * poisson(lambdaAway, j);
                    totalProb += prob;
                    
                    if (i > j) {
                        probHomeWin += prob;
                    } else if (i === j) {
                        probDraw += prob;
                    } else {
                        probAwayWin += prob;
                    }

                    probTotalGoals[i + j] += prob;
                }
            }
            
            // Ajustar el Over 7+ para cubrir el restante
            probHomeWin += (1 - totalProb) * (lambdaHome > lambdaAway ? 1 : 0);
            probAwayWin += (1 - totalProb) * (lambdaHome < lambdaAway ? 1 : 0);
            probDraw += (1 - totalProb) * (lambdaHome === lambdaAway ? 1 : 0);
            
            // Normalizar las probabilidades (aunque ya deberían sumar ~1)
            const total1x2 = probHomeWin + probDraw + probAwayWin;
            probHomeWin /= total1x2;
            probDraw /= total1x2;
            probAwayWin /= total1x2;

            // 5. Calcular Over/Under
            const overUnder = [2.5, 3.5, 4.5];
            const marketData = {};

            overUnder.forEach(line => {
                let probUnder = 0;
                let goalLine = Math.floor(line);
                for (let k = 0; k <= goalLine; k++) {
                    probUnder += probTotalGoals[k];
                }
                // Si la línea es alta (ej: 4.5), las probabilidades para 9+ goles son despreciables, usamos la matriz calculada
                
                marketData[line] = {
                    under: probUnder,
                    over: 1 - probUnder
                };
            });
            
            // 6. Ambos Equipos Anotan (BTTS)
            // 1 - P(0-0) - P(0-x) - P(x-0)
            const prob00 = poisson(lambdaHome, 0) * poisson(lambdaAway, 0);
            const probHomeCleanSheet = poisson(lambdaAway, 0); // P(Bar=0)
            const probAwayCleanSheet = poisson(lambdaHome, 0); // P(RM=0)
            
            // P(NO BTTS) = P(0-0) + P(X-0) - P(0-0)
            // Donde P(X-0) es la prob de que RM marque y Bar no, y P(0-Y) es la prob de que Bar marque y RM no.
            
            let probNoBTTS = 0;
            // P(RM 0, Bar != 0)
            for(let j=1; j <= maxGoals; j++) {
                probNoBTTS += poisson(lambdaHome, 0) * poisson(lambdaAway, j);
            }
            // P(RM != 0, Bar 0)
            for(let i=1; i <= maxGoals; i++) {
                probNoBTTS += poisson(lambdaHome, i) * poisson(lambdaAway, 0);
            }
            probNoBTTS += poisson(lambdaHome, 0) * poisson(lambdaAway, 0); // P(0-0) ya se cuenta, hay que corregir.
            
            // Una forma más simple: P(NO BTTS) = P(RM gana a 0) + P(Bar gana a 0) + P(0-0)
            probNoBTTS = probHomeCleanSheet + probAwayCleanSheet - prob00; // P(A no marca) + P(B no marca) - P(Ninguno marca)
            
            const probBTTS = 1 - probNoBTTS;

            // 7. Renderizar Resultados
            const formatProb = (p) => (p * 100).toFixed(1) + '%';
            const formatOdds = (p) => (1 / p).toFixed(2);
            
            let html = `
                <div class="market-table">
                    <h3>Mercado 1$\times$2</h3>
                    <table>
                        <tr><th>Resultado</th><th>Probabilidad</th><th>Cuota Implícita</th></tr>
                        <tr><td>1 (Real Madrid)</td><td>${formatProb(probHomeWin)}</td><td>${formatOdds(probHomeWin)}</td></tr>
                        <tr><td>$\times$ (Empate)</td><td>${formatProb(probDraw)}</td><td>${formatOdds(probDraw)}</td></tr>
                        <tr><td>2 (Barcelona)</td><td>${formatProb(probAwayWin)}</td><td>${formatOdds(probAwayWin)}</td></tr>
                    </table>
                    <p style="font-size:0.9em; margin-top:10px;"><em>Goles Esperados (RM $\lambda$): ${lambdaHome.toFixed(2)}</em></p>
                    <p style="font-size:0.9em;"><em>Goles Esperados (Bar $\lambda$): ${lambdaAway.toFixed(2)}</em></p>
                </div>
                
                <div class="market-table">
                    <h3>Mercado de Goles</h3>
                    <table>
                        <tr><th>Mercado</th><th>Prob. (%)</th><th>Cuota Implícita</th></tr>
                        <tr>
                            <td>**Ambos Anotan (Sí)**</td>
                            <td class="${probBTTS > 0.9 ? 'positive' : ''}">${formatProb(probBTTS)}</td>
                            <td>${formatOdds(probBTTS)}</td>
                        </tr>
                        ${overUnder.map(line => `
                            <tr>
                                <td>Under ${line}</td>
                                <td>${formatProb(marketData[line].under)}</td>
                                <td>${formatOdds(marketData[line].under)}</td>
                            </tr>
                            <tr>
                                <td>Over ${line}</td>
                                <td class="${marketData[line].over > 0.9 ? 'positive' : ''}">${formatProb(marketData[line].over)}</td>
                                <td>${formatOdds(marketData[line].over)}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
            
            document.getElementById('prediction-results').innerHTML = html;
        }

        // ----------------------------------------------------
        // INICIO
        // ----------------------------------------------------
        window.onload = () => {
            generateMainTable();
            calculateMarketPrediction();
        };

    </script>

</body>
</html>

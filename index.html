<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Backtester definitivo con patrones avanzados</title>
<style>
:root{--bg:#071225;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4}
body{background:linear-gradient(180deg,var(--bg),#04101a);color:#e6eef6;font-family:Inter,system-ui,Arial;margin:0;padding:18px}
h1{font-size:1.1rem;margin:0 0 12px 0}
.card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
input,textarea,select,button{font:inherit}
input[type=file]{color:transparent}
textarea{width:100%;min-height:90px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:inherit}
.row{display:flex;gap:8px;align-items:center}
.btn{background:linear-gradient(90deg,var(--accent),#26d0ce);border:none;color:#021522;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
progress{width:100%;height:14px;border-radius:8px;overflow:hidden}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
th{color:var(--muted);font-weight:600;font-size:12px}
.green{color:#8ee99b}
.red{color:#ff8b8b}
.small{font-size:13px;color:var(--muted)}
pre{white-space:pre-wrap;font-size:13px}
.warning{color:#ffd166}
</style>
</head>
<body>
<h1>Backtesting definitivo con patrones avanzados</h1>

<div class="card">
  <div class="row" style="margin-bottom:10px">
    <input id="fileInput" type="file" accept=".json"/>
    <button id="btnPaste" class="btn">Pegar JSON</button>
  </div>
  <textarea id="pasteArea" placeholder="Pega aquí tu JSON (array o NDJSON)"></textarea>
  <div style="margin-top:8px" class="row">
    <button id="btnStart" class="btn">Procesar Backtest</button>
    <div style="margin-left:auto" class="small">Stake fijo = <strong>1</strong></div>
  </div>
  <progress id="progress" value="0" max="100" style="display:none;margin-top:8px"></progress>
  <div id="status" class="small" style="margin-top:8px"></div>
</div>

<div id="output" style="display:none">
  <div class="card"><h3>Resumen</h3><div id="metrics" class="small"></div></div>
  <div class="card"><h3>Top ligas</h3><div id="byLeague"></div></div>
  <div class="card"><h3>Top equipos</h3><div id="byTeam"></div></div>
  <div class="card"><h3>Rango de cuotas</h3><div id="byOdds"></div></div>
  <div class="card"><h3>Patrones detectados automáticamente</h3><div id="patterns"></div></div>
  <div class="card"><h3>Registros no decididos</h3><div id="undetermined" class="small"></div></div>
  <div class="card"><button id="btnExportCSV" class="btn">Exportar resultados CSV</button></div>
</div>

<script>
/* ------------------ Worker definitivo ------------------ */
const workerCode = `

function normalizeKey(k){ return k?String(k).trim().toLowerCase().replace(/\\s+/g,' '):'';}
function tryNum(v){ if(v===null||v===undefined) return NaN; if(typeof v==='number') return v; let s=String(v).trim().replace(/,/g,'.'); const m=s.match(/-?\\d+(\\.\\d+)?/); return m?Number(m[0]):NaN;}
function parseScore(s){ if(!s) return null; const m=String(s).match(/(\\d+)\\s*[-:]\\s*(\\d+)/); return m?{home:parseInt(m[1],10),away:parseInt(m[2],10)}:null;}

// Evaluación completa de Desired Outcome y mercados
function evaluateDesired(d, market, score){
  if(!d && !market) return null;
  const s=(d||'').toLowerCase(), m=(market||'').toLowerCase();
  if(/gg|btts|both/i.test(s)||/btts|both/i.test(m)){return score?score.home>0 && score.away>0:null;}
  if(/no goal|no/i.test(s)||/no|nogoal/i.test(m)){return score?!(score.home>0 && score.away>0):null;}
  const over=s.match(/over\\s*([0-9]+(?:\\.[0-9]+)?)/i)||m.match(/over\\s*([0-9]+(?:\\.[0-9]+)?)/i);
  if(over && score){return score.home+score.away>parseFloat(over[1]);}
  const under=s.match(/under\\s*([0-9]+(?:\\.[0-9]+)?)/i)||m.match(/under\\s*([0-9]+(?:\\.[0-9]+)?)/i);
  if(under && score){return score.home+score.away<=parseFloat(under[1]);}
  if(/^1$/.test(s)||/home/.test(s)){return score?score.home>score.away:null;}
  if(/^2$/.test(s)||/away/.test(s)){return score?score.away>score.home:null;}
  if(/^x$/.test(s)||/draw/.test(s)){return score?score.home===score.away:null;}
  if(/^\\d+[-:]\\d+$/.test(s)&&score){const m=s.match(/(\\d+)\\s*[-:]\\s*(\\d+)/); return parseInt(m[1],10)===score.home && parseInt(m[2],10)===score.away;}
  return null;
}

// Obtiene el valor de varias posibles claves
function getValue(obj,candidates){
  const map={};for(const k in obj){map[normalizeKey(k)]=obj[k];}
  for(const c of candidates){const n=normalizeKey(c); if(map[n]!==undefined) return map[n];}
  for(const nKey in map){for(const c of candidates){const q=normalizeKey(c); if(nKey.includes(q)||q.includes(nKey)) return map[nKey];}}
  return undefined;
}

function oddsBucket(o){if(isNaN(o))return 'unknown';if(o<1.5)return'1.01-1.49';if(o<2)return'1.50-1.99';if(o<3)return'2.00-2.99';if(o<5)return'3.00-4.99';return'5.00+';}

function addPattern(key, p, patterns){if(!patterns[key])patterns[key]={count:0,profit:0,ganado:0,perdido:0};patterns[key].count++;patterns[key].profit+=p;p>0?patterns[key].ganado+=p:patterns[key].perdido+=Math.abs(p);}

self.onmessage=function(e){
  try{
    let records=[]; try{records=JSON.parse(e.data.text); if(!Array.isArray(records)) records=[records];}catch(err){const lines=e.data.text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);for(const l of lines){try{records.push(JSON.parse(l));}catch(errLine){}}}
    const stake=1; let total=0,profit=0,ganado=0,perdido=0;
    const leagues={},teams={},oddsBuckets={},undetermined=[],patterns={};

    // Prepara estadísticas y campos para patrones combinados
    const patternFields=['home attacks at ft','away attacks at ft','home dangerous attacks at ft','away dangerous attacks at ft','home corners at ft','away corners at ft','home ball possession at ft','away ball possession at ft'];

    // Genera combinaciones simples de hasta 3 condiciones para patrones
    const combinationKeys=[];
    for(let i=0;i<patternFields.length;i++){
      combinationKeys.push([patternFields[i]]);
      for(let j=i+1;j<patternFields.length;j++){
        combinationKeys.push([patternFields[i],patternFields[j]]);
        for(let k=j+1;k<patternFields.length;k++){
          combinationKeys.push([patternFields[i],patternFields[j],patternFields[k]]);
        }
      }
    }

    for(let idx=0;idx<records.length;idx++){
      if(idx%500===0)self.postMessage({progress:idx/records.length*100,status:'Procesando registros... '+idx+'/'+records.length});
      const r=records[idx];
      total++;
      const rawOdds=getValue(r,['odd','odds']); const rawFT=getValue(r,['result ft']); const rawDesired=getValue(r,['desired outcome','desired']); const rawLeague=getValue(r,['league']); const rawMatch=getValue(r,['match']);
      const odds=tryNum(rawOdds); const score=parseScore(rawFT); let p=NaN;
      const outcome=evaluateDesired(rawDesired,null,score); 
      if(outcome===true)p=(odds>0?odds-1:0); else if(outcome===false)p=-stake; else{undetermined.push(r); continue;}
      profit+=p;p>0?ganado+=p:perdido+=Math.abs(p);

      const leagueKey=rawLeague||'Desconocida';if(!leagues[leagueKey])leagues[leagueKey]={count:0,profit:0,ganado:0,perdido:0};leagues[leagueKey].count++;leagues[leagueKey].profit+=p;p>0?leagues[leagueKey].ganado+=p:leagues[leagueKey].perdido+=Math.abs(p);

      let home='',away='';if(rawMatch){const sep=rawMatch.includes('-')?'-':(rawMatch.includes(' vs ')?' vs ':(rawMatch.includes(' v ')?' v ':null));if(sep){const parts=rawMatch.split(sep).map(s=>s.trim()).filter(Boolean);if(parts.length>=2){home=parts[0];away=parts[1];}}}
      if(home){if(!teams[home])teams[home]={count:0,profit:0,ganado:0,perdido:0};teams[home].count++;teams[home].profit+=p;p>0?teams[home].ganado+=p:teams[home].perdido+=Math.abs(p);}
      if(away){if(!teams[away])teams[away]={count:0,profit:0,ganado:0,perdido:0};teams[away].count++;teams[away].profit+=p;p>0?teams[away].ganado+=p:teams[away].perdido+=Math.abs(p);}
      const bucket=oddsBucket(odds);if(!oddsBuckets[bucket])oddsBuckets[bucket]={count:0,profit:0,ganado:0,perdido:0};oddsBuckets[bucket].count++;oddsBuckets[bucket].profit+=p;p>0?oddsBuckets[bucket].ganado+=p:oddsBuckets[bucket].perdido+=Math.abs(p);

      // ----------------- DETECCIÓN DE PATRONES AVANZADOS -----------------
      const values={}; patternFields.forEach(f=>values[f]=tryNum(getValue(r,[f])));
      // Patrón individual simple
      for(const f of patternFields){ if(!isNaN(values[f])) addPattern(f+' >= '+values[f], p, patterns);}
      // Patrón combinaciones hasta 3
      for(const comb of combinationKeys){
        const key=comb.map(f=>f+'='+values[f]).join(' + ');
        addPattern(key,p,patterns);
      }
    }

    const roi=total?profit/total*100:0;
    self.postMessage({ok:true,metrics:{total,profit,ganado,perdido,roi,undetermined:undetermined.length},leagues,teams,oddsBuckets,patterns,undetermined:undetermined.slice(0,20)});
  }catch(err){self.postMessage({ok:false,error:err.message});}
};
`;

// ------------------ Código principal ------------------
const blob = new Blob([workerCode], {type:"application/javascript"});
const worker = new Worker(URL.createObjectURL(blob));
const progress=document.getElementById('progress');
const status=document.getElementById('status');

worker.onmessage = e => {
  if(e.data.progress!==undefined){progress.style.display='';progress.value=e.data.progress;status.textContent=e.data.status; return;}
  progress.style.display='none'; status.textContent='';
  if(!e.data.ok){alert('Error worker: '+e.data.error);return;}
  const m=e.data.metrics;
  document.getElementById('metrics').innerHTML=\`
    <div>Apuestas procesadas: <strong>\${m.total}</strong></div>
    <div>✅ Ganado: <strong class="green">\${m.ganado.toFixed(2)}</strong></div>
    <div>❌ Perdido: <strong class="red">\${m.perdido.toFixed(2)}</strong></div>
    <div>Beneficio neto: <strong>\${m.profit.toFixed(2)}</strong></div>
    <div>ROI: <strong>\${m.roi.toFixed(2)}%</strong></div>
    <div class="small">Registros no decididos: <strong class="warning">\${m.undetermined}</strong></div>
  \`;
  renderGroupTable(e.data.leagues,'byLeague','Liga');
  renderGroupTable(e.data.teams,'byTeam','Equipo');
  renderGroupTable(e.data.oddsBuckets,'byOdds','Rango cuota');
  renderGroupTable(e.data.patterns,'patterns','Condición');

  const und=e.data.undetermined||[];
  const undDiv=document.getElementById('undetermined');
  undDiv.innerHTML=und.length===0?'<div class="small">Todos los registros fueron decididos</div>':'<pre>'+und.map(u=>JSON.stringify(u,null,2)).join('\\n---\\n')+'</pre>';
  document.getElementById('output').style.display='';
  window._lastWorkerResult=e.data;
};

function renderGroupTable(mapObj,containerId,label){
  const arr=Object.keys(mapObj).map(k=>({key:k,count:mapObj[k].count,profit:mapObj[k].profit||0,ganado:mapObj[k].ganado||0,perdido:mapObj[k].perdido||0})).sort((a,b)=>b.profit-a.profit);
  if(arr.length===0){document.getElementById(containerId).innerHTML='<div class="small">Sin datos</div>';return;}
  let html='<table><thead><tr><th>'+label+'</th><th>Apuestas</th><th>Ganado</th><th>Perdido</th><th>Profit</th></tr></thead><tbody>';
  arr.forEach(r=>{html+='<tr><td>'+escapeHtml(r.key)+'</td><td>'+r.count+'</td><td class="green">'+r.ganado.toFixed(2)+'</td><td class="red">'+r.perdido.toFixed(2)+'</td><td style="font-weight:700;color:'+(r.profit>=0?'#8ee99b':'#ff8b8b')+'">'+r.profit.toFixed(2)+'</td></tr>';});
  html+='</tbody></table>';document.getElementById(containerId).innerHTML=html;
}
function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

document.getElementById('fileInput').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onprogress=ev=>{if(ev.lengthComputable){progress.style.display='';progress.value=ev.loaded/ev.total*100;status.textContent='Leyendo archivo '+Math.round(progress.value)+'%';}};
  reader.onload=ev=>{status.textContent='Procesando en worker...';worker.postMessage({text:ev.target.result});};
  reader.onerror=()=>alert('Error al leer archivo');reader.readAsText(f);
});
document.getElementById('btnPaste').addEventListener('click',()=>{const t=prompt('Pega tu JSON');if(t)document.getElementById('pasteArea').value=t;});
document.getElementById('btnStart').addEventListener('click',()=>{const txt=document.getElementById('pasteArea').value.trim();if(!txt){alert('JSON vacío');return;}progress.style.display='';progress.value=10;status.textContent='Procesando...';worker.postMessage({text:txt});});

document.getElementById('btnExportCSV').addEventListener('click',()=>{
  const res=window._lastWorkerResult; if(!res){alert('No hay resultados');return;}
  const rows=[];rows.push(['scope','key','count','ganado','perdido','profit']);
  Object.entries(res.leagues).forEach(([k,v])=>rows.push(['league',k,v.count,(v.ganado||0).toFixed(2),(v.perdido||0).toFixed(2),(v.profit||0).toFixed(2)]));
  Object.entries(res.teams).forEach(([k,v])=>rows.push(['team',k,v.count,(v.ganado||0).toFixed(2),(v.perdido||0).toFixed(2),(v.profit||0).toFixed(2)]));
  Object.entries(res.oddsBuckets).forEach(([k,v])=>rows.push(['odds',k,v.count,(v.ganado||0).toFixed(2),(v.perdido||0).toFixed(2),(v.profit||0).toFixed(2)]));
  Object.entries(res.patterns).forEach(([k,v])=>rows.push(['pattern',k,v.count,(v.ganado||0).toFixed(2),(v.perdido||0).toFixed(2),(v.profit||0).toFixed(2)]));
  const csv='data:text/csv;charset=utf-8,'+rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\\r\\n');
  const a=document.createElement('a');a.href=csv;a.download='backtest_patterns_advanced.csv';a.click();
});
</script>
</body>
</html>
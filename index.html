<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Pro de Poisson (Mercados de Goles)</title>
    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            background-color: #121212; /* Fondo oscuro */
            color: #e0e0e0; /* Texto claro */
            padding: 20px;
        }
        .container { 
            max-width: 1000px; 
            margin: auto; 
            background: #1e1e1e; /* Contenedor principal */
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5); 
        }
        h1 { 
            color: #00cc66; /* Verde de acento */
            border-bottom: 3px solid #00cc66; 
            padding-bottom: 10px; 
            margin-bottom: 30px; 
            text-align: center; 
            font-size: 2em;
        }
        h2 { 
            color: #4CAF50; 
            margin-top: 25px; 
            border-left: 5px solid #00cc66;
            padding-left: 10px;
            font-weight: 600;
        }
        label { 
            display: block; 
            margin-top: 10px; 
            font-weight: bold; 
            color: #aaaaaa;
        }

        /* --- INPUTS Y BOTONES --- */
        textarea, select, button { 
            width: 100%; 
            padding: 12px; 
            margin-top: 8px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border: 1px solid #333; 
            box-sizing: border-box; 
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        textarea { 
            height: 180px; 
            font-family: monospace; 
            resize: vertical;
        }
        button { 
            background-color: #00cc66; 
            color: #1e1e1e; 
            cursor: pointer; 
            border: none; 
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s; 
        }
        button:hover { 
            background-color: #00a050; 
            transform: translateY(-1px);
        }
        .grid-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* --- TABLAS DE RESULTADOS --- */
        .result-table, .prob-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .result-table th, .result-table td, .prob-table th, .prob-table td { 
            border: 1px solid #333; 
            padding: 12px; 
            text-align: center; 
        }
        .result-table th, .prob-table th { 
            background-color: #333; 
            color: #e0e0e0;
            font-weight: 600;
        }
        .result-table td, .prob-table td {
            background-color: #2a2a2a;
        }
        .market-section { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-top: 20px; 
        }

        /* Columna de 1X2 */
        #misc-probabilities tr:nth-child(2) td, 
        #misc-probabilities tr:nth-child(4) td {
            background-color: #15381a; /* Ligeramente más oscuro para 1X2 */
            font-weight: bold;
            color: #00cc66;
        }

        /* Valores destacados */
        .result-table strong, .prob-table strong {
            color: #00cc66;
            font-weight: 800;
        }

        /* Mensajes */
        #data-status { color: #00cc66; font-weight: bold; margin-top: 10px; }
        .error { color: #ff5555; font-weight: bold; margin-top: 10px; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .grid-2, .market-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>⚽ ANÁLISIS PRO DE MERCADOS DE GOLES</h1>

    <!-- 1. Pegar Datos -->
    <h2>1. Fuente de Datos de la Liga</h2>
    <p style="color: #aaa;">Pega la tabla de estadísticas completa. El sistema identifica las columnas automáticamente y asume la coma (,) como decimal.</p>
    <textarea id="data-input" placeholder="Pega la tabla completa aquí..."></textarea>
    <button onclick="parseAndLoadData()">Cargar y Analizar Datos de la Liga</button>
    <p id="data-status" class="error">Cargando...</p>

    <!-- 2. Selección de Partido -->
    <h2>2. Seleccionar Evento</h2>
    <div class="grid-2">
        <div>
            <label for="local-team">Equipo Local (Casa)</label>
            <select id="local-team" disabled>
                <option value="">Selecciona un equipo</option>
            </select>
        </div>
        <div>
            <label for="visitor-team">Equipo Visitante (Fuera)</label>
            <select id="visitor-team" disabled>
                <option value="">Selecciona un equipo</option>
            </select>
        </div>
    </div>
    <button onclick="calculateExpectedGoals()">Ejecutar Análisis de Poisson</button>
    <p id="calculation-error" class="error"></p>

    <!-- 3. Resultados -->
    <div id="results" style="display: none;">
        
        <h2>3. Goles Esperados ($\lambda$) e Índices de Fuerza</h2>
        <!-- Tabla de Goles Esperados -->
        <table class="result-table">
            <thead>
                <tr><th>Equipo</th><th>Factor Ataque (GF)</th><th>Factor Defensa (GC)</th><th>Goles Esperados ($\lambda$)</th></tr>
            </thead>
            <tbody id="lambda-results">
            </tbody>
        </table>

        <h2>4. Probabilidades por Mercado</h2>
        
        <div class="market-section">
            <!-- Columna 1: Mercados de Total de Goles (Over/Under) -->
            <div>
                <h3>Total de Goles (Líneas O/U)</h3>
                <table class="prob-table">
                    <thead><tr><th>Línea</th><th>Probabilidad</th></tr></thead>
                    <tbody id="total-goals-probabilities"></tbody>
                </table>
            </div>

            <!-- Columna 2: Mercados por Equipo y BTTS -->
            <div>
                <h3>Por Equipo y BTTS</h3>
                <table class="prob-table">
                    <thead><tr><th>Mercado</th><th>Probabilidad</th></tr></thead>
                    <tbody id="team-and-btts-probabilities"></tbody>
                </table>
            </div>

            <!-- Columna 3: Mercados Pares/Impares y 1X2 -->
            <div>
                <h3>Resultado Final y Pares</h3>
                <table class="prob-table" id="misc-probabilities">
                    <thead><tr><th>Mercado</th><th>Probabilidad</th></tr></thead>
                    <tbody>
                        <tr><td>Gana Local (1)</td><td id="prob-1"></td></tr>
                        <tr><td>Empate (X)</td><td id="prob-X"></td></tr>
                        <tr><td>Gana Visita (2)</td><td id="prob-2"></td></tr>
                        <tr><td>Total Par</td><td id="prob-par"></td></tr>
                        <tr><td>Total Impar</td><td id="prob-impar"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabla de Marcadores -->
        <h3>5. Top 5 Marcadores Exactos</h3>
        <table class="prob-table">
            <thead>
                <tr><th>Marcador</th><th>Probabilidad</th></tr>
            </thead >
            <tbody id="score-probabilities">
            </tbody >
        </table>
    </div>
</div>

<script>
    let leagueData = [];
    let GL_prom = 0; 
    let GV_prom = 0; 
    
    // Índices de las columnas necesarias en la tabla pegada
    const COL_INDEXES = {
        'Team': 0, 
        'Prom. Goles locales Anotados': 4,
        'Prom. Goles locales Lanzados': 5, 
        'Prom. Goles visitante Anotados': 7,
        'Prom. Goles visitante Lanzados': 8 
    };

    // Función Factorial (k!)
    const factorial = (n) => { 
        if (n === 0) return 1; 
        let result = 1; 
        for (let i = 1; i <= n; i++) result *= i; 
        return result; 
    };

    // Función de Probabilidad de Poisson P(k; λ)
    const poisson = (k, lambda) => {
        if (lambda === 0) return k === 0 ? 1 : 0;
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    };


    // --- 1. FUNCIÓN DE CARGA Y PARSEO DE DATOS ---
    function parseAndLoadData() {
        const text = document.getElementById('data-input').value;
        const statusElement = document.getElementById('data-status');
        
        if (!text.trim()) {
            statusElement.textContent = 'Error: Por favor, pega la tabla de datos en el campo superior.';
            return;
        }

        try {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const dataLines = lines.slice(2); 
            leagueData = [];

            const delimiterRegex = /\s{2,}|\t/;

            dataLines.forEach(line => {
                const values = line.trim().split(delimiterRegex).filter(v => v !== '');
                
                if (values.length > COL_INDEXES['Prom. Goles visitante Lanzados']) {
                    let team = {};
                    team.Equipo = values[COL_INDEXES['Team']];
                    
                    // Asignar y convertir valores numéricos. Reemplazar ',' por '.'
                    const convert = (val) => parseFloat(val.replace(',', '.')) || 0;

                    team['Prom. Goles locales Anotados'] = convert(values[COL_INDEXES['Prom. Goles locales Anotados']]);
                    team['Prom. Goles locales Lanzados'] = convert(values[COL_INDEXES['Prom. Goles locales Lanzados']]);
                    team['Prom. Goles visitante Anotados'] = convert(values[COL_INDEXES['Prom. Goles visitante Anotados']]);
                    team['Prom. Goles visitante Lanzados'] = convert(values[COL_INDEXES['Prom. Goles visitante Lanzados']]);
                    
                    leagueData.push(team);
                }
            });

            if (leagueData.length === 0) {
                 statusElement.textContent = 'Error: No se encontraron datos válidos de equipos. Verifica que el formato sea correcto.';
                 return;
            }

            calculateLeagueAverages();
            populateTeamSelectors();

            statusElement.textContent = `✅ Datos cargados y analizados correctamente. ${leagueData.length} equipos disponibles.`;
        } catch (error) {
            statusElement.textContent = `Error al procesar los datos: ${error.message}. Verifica el formato pegado.`;
            console.error(error);
        }
    }
    
    // --- 2. FUNCIÓN PARA CÁLCULO DE PROMEDIOS DE LIGA ---
    function calculateLeagueAverages() {
        const totalTeams = leagueData.length;
        if (totalTeams === 0) return;

        let sumGLA = 0; 
        let sumGVA = 0; 

        leagueData.forEach(team => {
            sumGLA += team['Prom. Goles locales Anotados'];
            sumGVA += team['Prom. Goles visitante Anotados'];
        });

        GL_prom = sumGLA / totalTeams;
        GV_prom = sumGVA / totalTeams;
    }

    // --- 3. FUNCIÓN PARA LLENAR SELECTORES ---
    function populateTeamSelectors() {
        const localSelect = document.getElementById('local-team');
        const visitorSelect = document.getElementById('visitor-team');

        [localSelect, visitorSelect].forEach(select => {
            select.innerHTML = '<option value="">Selecciona un equipo</option>';
            // Ordenar los equipos alfabéticamente
            leagueData.sort((a, b) => a.Equipo.localeCompare(b.Equipo));
            
            leagueData.forEach(team => {
                const option = document.createElement('option');
                option.value = team.Equipo;
                option.textContent = team.Equipo;
                select.appendChild(option);
            });
            select.disabled = false;
        });
    }

    // --- 4. FUNCIÓN PRINCIPAL DE CÁLCULO (MODIFICADA) ---
    function calculateExpectedGoals() {
        const localTeamName = document.getElementById('local-team').value;
        const visitorTeamName = document.getElementById('visitor-team').value;
        const errorElement = document.getElementById('calculation-error');
        const resultsDiv = document.getElementById('results');

        if (GL_prom === 0 || GV_prom === 0) {
             errorElement.textContent = 'Error: Primero debes cargar los datos de la liga.';
             resultsDiv.style.display = 'none';
             return;
        }

        if (!localTeamName || !visitorTeamName || localTeamName === visitorTeamName) {
            errorElement.textContent = 'Por favor, selecciona dos equipos diferentes.';
            resultsDiv.style.display = 'none';
            return;
        }

        errorElement.textContent = '';

        const localTeam = leagueData.find(t => t.Equipo === localTeamName);
        const visitorTeam = leagueData.find(t => t.Equipo === visitorTeamName);

        // --- CÁLCULO DE FACTORES DE FUERZA Y LAMBDA (Goles Esperados) ---
        // Recordatorio: GF_l/GC_v se comparan contra GL_prom (promedio local de la liga)
        // GF_v/GC_l se comparan contra GV_prom (promedio visitante de la liga)
        
        // Factores de Ataque
        const GF_l = GL_prom > 0 ? localTeam['Prom. Goles locales Anotados'] / GL_prom : 0; 
        const GF_v = GV_prom > 0 ? visitorTeam['Prom. Goles visitante Anotados'] / GV_prom : 0;

        // Factores de Defensa
        const GC_v = GL_prom > 0 ? visitorTeam['Prom. Goles visitante Lanzados'] / GL_prom : 0; 
        const GC_l = GV_prom > 0 ? localTeam['Prom. Goles locales Lanzados'] / GV_prom : 0; 

        // Goles Esperados (Lambda)
        const lambdaLocal = GL_prom * GF_l * GC_v;
        const lambdaVisitor = GV_prom * GF_v * GC_l;

        // --- VARIABLES DE MERCADOS ---
        let probLocalWin = 0;
        let probDraw = 0;
        let probVisitorWin = 0;
        let probTotalGoals = {}; // {0: P(0), 1: P(1), 2: P(2), ...}
        let probPar = 0;
        let probImpar = 0;
        let scoreProbabilities = [];
        
        const MAX_GOALS = 6; // Límite seguro para calcular marcadores (0-0 hasta 6-6)

        // Inicializar probTotalGoals
        for(let k = 0; k <= 2 * MAX_GOALS; k++) {
            probTotalGoals[k] = 0;
        }

        // Bucle principal para calcular probabilidades de marcadores
        for (let i = 0; i <= MAX_GOALS; i++) { // Goles Local
            const probL = poisson(i, lambdaLocal);

            for (let j = 0; j <= MAX_GOALS; j++) { // Goles Visitante
                const probV = poisson(j, lambdaVisitor);
                const matchProb = probL * probV;
                const totalGoals = i + j;

                // 1. Probabilidades 1X2
                if (i > j) { probLocalWin += matchProb; } 
                else if (i === j) { probDraw += matchProb; } 
                else { probVisitorWin += matchProb; }
                
                // 2. Probabilidades Total de Goles (hasta un límite seguro)
                if (totalGoals <= 2 * MAX_GOALS) {
                     probTotalGoals[totalGoals] += matchProb;
                }

                // 3. Probabilidades Pares/Impares
                if (totalGoals % 2 === 0) {
                    probPar += matchProb;
                } else {
                    probImpar += matchProb;
                }

                // Guardar los marcadores (solo hasta 5-5 para el Top 5)
                if (i <= 5 && j <= 5) {
                    scoreProbabilities.push({ score: `${i} - ${j}`, prob: matchProb });
                }
            }
        }
        
        // --- CÁLCULO DE MERCADOS FINALES ---
        
        // 1. Over/Under (U: Under, O: Over)
        let P_U = {};
        P_U[0.5] = probTotalGoals[0];
        P_U[1.5] = P_U[0.5] + probTotalGoals[1];
        P_U[2.5] = P_U[1.5] + probTotalGoals[2];
        P_U[3.5] = P_U[2.5] + probTotalGoals[3];
        P_U[4.5] = P_U[3.5] + probTotalGoals[4];
        P_U[5.5] = P_U[4.5] + probTotalGoals[5];
        
        // 2. Ambos Equipos Marcan (BTTS)
        const probLocalNoScore = poisson(0, lambdaLocal);
        const probVisitorNoScore = poisson(0, lambdaVisitor);
        const probZeroZero = probLocalNoScore * probVisitorNoScore;
        
        const probBTTS_NO = probLocalNoScore + probVisitorNoScore - probZeroZero;
        const probBTTS_YES = 1.0 - probBTTS_NO;
        
        // 3. Total de Goles por Equipo (Over/Under)
        const P_L_U = (linea) => {
            let sum = 0;
            for(let k = 0; k < linea; k++) {
                sum += poisson(k, lambdaLocal);
            }
            return sum;
        }
        
        const P_V_U = (linea) => {
            let sum = 0;
            for(let k = 0; k < linea; k++) {
                sum += poisson(k, lambdaVisitor);
            }
            return sum;
        }

        // Normalizar 1X2 (para manejar la probabilidad residual más allá de 6-6)
        const totalCalculatedProb = probLocalWin + probDraw + probVisitorWin;
        const remainingProb = 1.0 - totalCalculatedProb;

        if (remainingProb > 0.001) {
            const totalWeightedProb = probLocalWin + probDraw + probVisitorWin;
            if (totalWeightedProb > 0) {
                // Redistribuir el remanente proporcionalmente
                probLocalWin += remainingProb * (probLocalWin / totalWeightedProb);
                probDraw += remainingProb * (probDraw / totalWeightedProb);
                probVisitorWin += remainingProb * (probVisitorWin / totalWeightedProb);
            }
        }
        
        // Ordenar los marcadores más probables
        scoreProbabilities.sort((a, b) => b.prob - a.prob);


        // --- 5. MOSTRAR RESULTADOS EN EL DOM ---
        
        // Tabla Lambda
        document.getElementById('lambda-results').innerHTML = `
            <tr>
                <td>${localTeamName}</td>
                <td>${GF_l.toFixed(3)}</td>
                <td>${GC_v.toFixed(3)}</td>
                <td><strong>${lambdaLocal.toFixed(3)}</strong></td>
            </tr>
            <tr>
                <td>${visitorTeamName}</td>
                <td>${GF_v.toFixed(3)}</td>
                <td>${GC_l.toFixed(3)}</td>
                <td><strong>${lambdaVisitor.toFixed(3)}</strong></td>
            </tr>
        `;

        // Columna 1: Total de Goles (Over/Under)
        let totalGoalsHTML = '';
        for (const line in P_U) {
            const U = P_U[line];
            const O = 1.0 - U;
            const U_class = U > O ? '<strong>' : '';
            const O_class = O > U ? '<strong>' : '';

            totalGoalsHTML += `
                <tr><td>Menos de ${line}</td><td>${U_class}${(U * 100).toFixed(2)}%${U_class ? '</strong>' : ''}</td></tr>
                <tr><td>Más de ${line}</td><td>${O_class}${(O * 100).toFixed(2)}%${O_class ? '</strong>' : ''}</td></tr>
            `;
        }
        document.getElementById('total-goals-probabilities').innerHTML = totalGoalsHTML;
        
        // Columna 2: Por Equipo y BTTS
        document.getElementById('team-and-btts-probabilities').innerHTML = `
            <tr><td>**BTTS SÍ**</td><td><strong>${(probBTTS_YES * 100).toFixed(2)}%</strong></td></tr>
            <tr><td>BTTS NO</td><td>${(probBTTS_NO * 100).toFixed(2)}%</td></tr>
            <tr style="background-color:#121212;"><td colspan="2"></td></tr>
            <tr><td>${localTeamName} - Más de 0.5</td><td><strong>${((1 - P_L_U(1)) * 100).toFixed(2)}%</strong></td></tr>
            <tr><td>${localTeamName} - Menos de 0.5</td><td>${(P_L_U(1) * 100).toFixed(2)}%</td></tr>
            <tr><td>${localTeamName} - Más de 1.5</td><td><strong>${((1 - P_L_U(2)) * 100).toFixed(2)}%</strong></td></tr>
            <tr><td>${localTeamName} - Menos de 1.5</td><td>${(P_L_U(2) * 100).toFixed(2)}%</td></tr>
            <tr style="background-color:#121212;"><td colspan="2"></td></tr>
            <tr><td>${visitorTeamName} - Más de 0.5</td><td><strong>${((1 - P_V_U(1)) * 100).toFixed(2)}%</strong></td></tr>
            <tr><td>${visitorTeamName} - Menos de 0.5</td><td>${(P_V_U(1) * 100).toFixed(2)}%</td></tr>
            <tr><td>${visitorTeamName} - Más de 1.5</td><td><strong>${((1 - P_V_U(2)) * 100).toFixed(2)}%</strong></td></tr>
            <tr><td>${visitorTeamName} - Menos de 1.5</td><td>${(P_V_U(2) * 100).toFixed(2)}%</td></tr>
        `;

        // Columna 3: Pares/Impares y 1X2
        document.getElementById('prob-1').innerHTML = `${(probLocalWin * 100).toFixed(2)}%`;
        document.getElementById('prob-X').innerHTML = `${(probDraw * 100).toFixed(2)}%`;
        document.getElementById('prob-2').innerHTML = `${(probVisitorWin * 100).toFixed(2)}%`;
        document.getElementById('prob-par').innerHTML = `<strong>${(probPar * 100).toFixed(2)}%</strong>`;
        document.getElementById('prob-impar').innerHTML = `${(probImpar * 100).toFixed(2)}%`;
        
        // Tabla de Marcadores
        document.getElementById('score-probabilities').innerHTML = scoreProbabilities.slice(0, 5).map(item => 
            `<tr><td>${item.score}</td><td><strong>${(item.prob * 100).toFixed(2)}%</strong></td></tr>`
        ).join('');

        resultsDiv.style.display = 'block';
    }

    window.onload = function() {
        document.getElementById('data-status').textContent = 'Pega la tabla en el área de texto para empezar.';
        // Llamar a parseAndLoadData() si hay texto preexistente (útil en entornos de edición)
        if (document.getElementById('data-input').value.trim() !== '') {
            parseAndLoadData();
        }
    };
</script>

</body>
</html>

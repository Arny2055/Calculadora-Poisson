<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson - Refinada por Disparos</title>
    <style>
        /* Estilos CSS */
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); width: 100%; max-width: 800px; text-align: center; }
        h1 { color: #8b008b; margin-bottom: 15px; border-bottom: 3px solid #8b008b; padding-bottom: 10px; font-size: 2em; }
        h2 { color: #007bff; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-row { border: 1px solid #8b008b; border-radius: 5px; padding: 15px; }
        .input-row h3 { color: #8b008b; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 0; }
        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { font-weight: bold; display: block; font-size: 0.9em; margin-bottom: 2px; }
        .input-group input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; text-align: center; }
        button { width: 80%; padding: 12px; background-color: #8b008b; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px; }
        button:hover { background-color: #5d005d; }
        
        /* Resultados */
        #results { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .rates-summary { background-color: #f3e5f5; border: 1px solid #ce93d8; color: #4a148c; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .market-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .result-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .result-box { padding: 10px; border-radius: 8px; text-align: center; }
        .result-box.btts { background-color: #d6eaff; border: 2px solid #007bff; }
        .result-box.ou { background-color: #e0ffe0; border: 2px solid #28a745; }
        .result-value { font-size: 1.4em; font-weight: bold; }
        
        /* Recomendaci√≥n y Contexto */
        #analysis_section { background-color: #fff8e1; border: 2px solid #ffd700; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left; }
        #analysis_section h3 { color: #b8860b; margin-top: 0; border-bottom: 1px dashed #ffeeba; padding-bottom: 5px; }
        .efficiency-summary { margin-bottom: 10px; }
        .context-text { font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="container">
        <h1> ‚öΩ Modelo Poisson Refinado </h1>
        <p>Utiliza **Goles Esperados** como $\lambda$ base y las m√©tricas de disparo para el an√°lisis de riesgo/eficiencia.</p>
           
        <div class="input-grid">
            <div class="input-row">
                <h3>Local</h3>
                <div class="input-group">
                    <label for="home_lambda">Goles Esperados ($\lambda$):</label>
                    <input type="number" id="home_lambda" value="1.8" step="0.01" min="0">
                </div>
                <div class="input-group">
                    <label for="home_sot">Disparos a Puerta (SOT) Promedio:</label>
                    <input type="number" id="home_sot" value="4.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="home_spg">Disparos por Gol (S/G) Promedio:</label>
                    <input type="number" id="home_spg" value="4.0" step="0.1" min="0">
                </div>
            </div>

            <div class="input-row">
                <h3>Visitante</h3>
                <div class="input-group">
                    <label for="away_lambda">Goles Esperados ($\lambda$):</label>
                    <input type="number" id="away_lambda" value="1.5" step="0.01" min="0">
                </div>
                <div class="input-group">
                    <label for="away_sot">Disparos a Puerta (SOT) Promedio:</label>
                    <input type="number" id="away_sot" value="5.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="away_spg">Disparos por Gol (S/G) Promedio:</label>
                    <input type="number" id="away_spg" value="7.0" step="0.1" min="0">
                </div>
            </div>
        </div>

        <button onclick="calculateProbabilities()">Calcular Pron√≥stico y An√°lisis de Eficiencia</button>
        
        <div id="results">
            <h2>Resultados Base de Poisson</h2>

            <div class="rates-summary" id="calculated_rates_summary">
                $\lambda_{\text{Local}}$: 0.00 | $\lambda_{\text{Visita}}$: 0.00 | $\lambda_{\text{Total}}$: 0.00
            </div>
            
            <div class="market-section">
                <div class="market-results">
                    <h4>Mercado: Ambos Anotan (BTTS)</h4>
                    <div class="result-box-grid">
                        <div class="result-box btts">
                            <strong>BTTS S√ç</strong>
                            <div class="result-value" id="prob_btts_yes_td">0.00%</div>
                        </div>
                        <div class="result-box btts">
                            <strong>Cuota Impl√≠cita</strong>
                            <div class="result-value" id="odd_btts_yes_td">0.00</div>
                        </div>
                    </div>
                </div>

                <div class="market-results">
                    <h4>Mercado: Total de Goles (2.5)</h4>
                    <div class="result-box-grid">
                        <div class="result-box ou">
                            <strong>M√ÅS DE 2.5</strong>
                            <div class="result-value" id="prob_over_2_5_td">0.00%</div>
                        </div>
                        <div class="result-box ou">
                            <strong>Cuota Impl√≠cita</strong>
                            <div class="result-value" id="odd_over_2_5_td">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="analysis_section">
                <h3>üéØ An√°lisis de Presi√≥n y Eficiencia</h3>
                <div class="efficiency-summary" id="sot_summary"></div>
                <div class="efficiency-summary" id="spg_summary"></div>
                <div class="context-text" id="efficiency_context"></div>
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n de Poisson P(k, lambda)
        function poissonProbability(k, lambda) {
            if (k < 0 || lambda < 0) return 0;
            if (lambda === 0 && k > 0) return 0;
            if (lambda === 0 && k === 0) return 1;
            if (k === 0) {
                return Math.exp(-lambda); 
            }
            let factorial = 1;
            for (let i = 2; i <= k; i++) {
                factorial *= i;
            }
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial;
        }

        // Funci√≥n para calcular BTTS y O/U para un par de lambdas
        function calculateMarketProbs(lambdaHome, lambdaAway) {
            const lambdaTotal = lambdaHome + lambdaAway;
            
            const probHomeZero = poissonProbability(0, lambdaHome);
            const probAwayZero = poissonProbability(0, lambdaAway);
            const probZeroZero = probHomeZero * probAwayZero; 
            const probBTTsNo = probHomeZero + probAwayZero - probZeroZero;
            const probBTTsYes = 1 - probBTTsNo;

            const probTotalZero = poissonProbability(0, lambdaTotal);
            const probTotalOne = poissonProbability(1, lambdaTotal);
            const probTotalTwo = poissonProbability(2, lambdaTotal);
            const probUnder2_5 = probTotalZero + probTotalOne + probTotalTwo;
            const probOver2_5 = 1 - probUnder2_5;

            return {
                lambdaHome: lambdaHome,
                lambdaAway: lambdaAway,
                lambdaTotal: lambdaTotal,
                bttsYes: probBTTsYes,
                over2_5: probOver2_5,
                under2_5: probUnder2_5
            };
        }
        
        // Funci√≥n de formateo de resultados
        const format = (p) => (p * 100).toFixed(2) + '%';
        const formatOdd = (p) => (p > 0.005 ? (1 / p).toFixed(2) : '‚àû');
        
        // Funci√≥n principal de c√°lculo
        function calculateProbabilities() {
            // 1. Obtener entradas del usuario
            const lambdaHome = parseFloat(document.getElementById('home_lambda').value);
            const homeSOT = parseFloat(document.getElementById('home_sot').value);
            const homeSPG = parseFloat(document.getElementById('home_spg').value); 
            
            const lambdaAway = parseFloat(document.getElementById('away_lambda').value);
            const awaySOT = parseFloat(document.getElementById('away_sot').value);
            const awaySPG = parseFloat(document.getElementById('away_spg').value);
            
            // Validaci√≥n
            if (isNaN(lambdaHome) || isNaN(homeSOT) || isNaN(homeSPG) || 
                isNaN(lambdaAway) || isNaN(awaySOT) || isNaN(awaySPG) ||
                lambdaHome < 0 || lambdaAway < 0 || homeSOT < 0 || awaySOT < 0) {
                alert('Por favor, introduce valores num√©ricos v√°lidos y positivos.');
                return;
            }
            
            // 2. Calcular los mercados (Base Poisson)
            const results = calculateMarketProbs(lambdaHome, lambdaAway);

            // 3. Actualizar la Interfaz de Resultados (Base Poisson)
            document.getElementById('calculated_rates_summary').innerHTML = 
                `$\lambda_{\\text{Local}}$: ${results.lambdaHome.toFixed(3)} | 
                $\lambda_{\\text{Visita}}$: ${results.lambdaAway.toFixed(3)} | 
                $\lambda_{\\text{Total}}$: ${results.lambdaTotal.toFixed(3)}`;
            
            document.getElementById('prob_btts_yes_td').textContent = format(results.bttsYes);
            document.getElementById('odd_btts_yes_td').textContent = formatOdd(results.bttsYes);
            
            document.getElementById('prob_over_2_5_td').textContent = format(results.over2_5);
            document.getElementById('odd_over_2_5_td').textContent = formatOdd(results.over2_5);
            
            // 4. AN√ÅLISIS DE PRESI√ìN Y EFICIENCIA (SOT y S/G)
            
            // Interpretaci√≥n de S/G: Un valor BAJO (cercano a 4.0 o menos) es ALTA eficiencia. Un valor ALTO (cercano a 7.0 o m√°s) es BAJA eficiencia.
            
            let sotSummaryText = `
                SOT Promedio: **Local ${homeSOT.toFixed(1)}** vs. **Visita ${awaySOT.toFixed(1)}**
            `;
            let spgSummaryText = `
                S/G Promedio: **Local ${homeSPG.toFixed(1)}** vs. **Visita ${awaySPG.toFixed(1)}**
            `;
            
            let efficiencyContext = "";
            
            // An√°lisis de Presi√≥n (SOT)
            const diffSOT = homeSOT - awaySOT;
            if (diffSOT > 1.5) {
                efficiencyContext += "El **Local (SOT +)** ejerce mucha m√°s presi√≥n ofensiva. ";
            } else if (diffSOT < -1.5) {
                efficiencyContext += "El **Visitante (SOT +)** ejerce mucha m√°s presi√≥n ofensiva. ";
            } else {
                efficiencyContext += "La presi√≥n ofensiva (SOT) de ambos equipos es **equilibrada**. ";
            }
            
            // An√°lisis de Eficiencia (S/G)
            const isHomeEfficient = homeSPG <= 4.5;
            const isAwayEfficient = awaySPG <= 4.5;
            const isHomeInefficient = homeSPG >= 7.0;
            const isAwayInefficient = awaySPG >= 7.0;

            if (isHomeEfficient && isAwayEfficient) {
                efficiencyContext += "Ambos equipos son **altamente eficientes** (S/G bajo), lo que refuerza el pron√≥stico **Over/BTTS**. ";
            } else if (isHomeInefficient && isAwayInefficient) {
                efficiencyContext += "Ambos equipos son **ineficientes** (S/G alto). El Over/BTTS es **m√°s riesgoso** de lo que indica el $\lambda$ base. ";
            } else if (isHomeEfficient && isAwayInefficient) {
                efficiencyContext += "El Local es **muy eficiente** y el Visitante es **ineficiente**. El $\lambda$ del Local es m√°s confiable. ";
            } else if (isHomeInefficient && isAwayEfficient) {
                efficiencyContext += "El Visitante es **muy eficiente** y el Local es **ineficiente**. El $\lambda$ del Visitante es m√°s confiable. ";
            } else {
                efficiencyContext += "Ambos equipos tienen una **eficiencia media** (S/G entre 4.5 y 7.0). ";
            }
            
            document.getElementById('sot_summary').innerHTML = sotSummaryText;
            document.getElementById('spg_summary').innerHTML = spgSummaryText;
            document.getElementById('efficiency_context').innerHTML = `**CONCLUSI√ìN:** ${efficiencyContext}`; 
        }

        // Ejecutar el c√°lculo al cargar la p√°gina con los valores por defecto
        document.addEventListener('DOMContentLoaded', calculateProbabilities);
    </script>
</body>
</html>

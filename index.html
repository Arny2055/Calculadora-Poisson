<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS Pro - Calculadora de Poisson Doble Corregido</title>
    <style>
        /* ================================================= */
        /* == CSS: Variables Globales y Estilos Base      == */
        /* ================================================= */
        :root {
            /* Modo Claro (Default) */
            --bg-page: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        /* Modo Oscuro */
        .dark-mode {
            --bg-page: #1a1a1a;
            --bg-card: #2c2c2c;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --accent-color: #4da6ff;
            --accent-hover: #007bff;
            --success-color: #40c463;
            --warning-color: #ffeb3b;
            --danger-color: #ff6b6b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-page);
            color: var(--text-primary);
            transition: background-color 0.4s, color 0.4s;
        }

        #calculator-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 30px;
            background-color: var(--bg-card);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
        }

        /* ================================================= */
        /* == CSS: Tipografía y Headers                   == */
        /* ================================================= */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: var(--accent-color);
            margin-bottom: 5px;
            font-size: 2.2em;
        }

        header h2 {
            font-size: 1.1em;
            color: var(--text-secondary);
            font-weight: 400;
        }

        h3 {
            color: var(--accent-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            margin-top: 30px;
        }

        h4 {
            margin-top: 10px;
            color: var(--text-primary);
        }

        /* ================================================= */
        /* == CSS: Inputs y Controles                     == */
        /* ================================================= */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input[type="number"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-page);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .correction-factor {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed var(--accent-color);
            border-radius: 6px;
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .dark-mode .correction-factor {
             background-color: rgba(77, 166, 255, 0.1);
        }

        button.calculate-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
        }

        button.calculate-btn:hover {
            background-color: #1e7e34;
            transform: translateY(-2px);
        }

        /* ================================================= */
        /* == CSS: Tablas de Resultados y Matriz          == */
        /* ================================================= */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95em;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .dark-mode th {
            background-color: #3a3a3a;
        }

        /* Fila de Encabezado de Matriz */
        #score-matrix thead th:not(:first-child) {
            background-color: var(--accent-color);
            color: white;
        }

        /* Columna de Encabezado de Matriz */
        #score-matrix tbody tr th {
            background-color: var(--accent-color);
            color: white;
        }

        /* Colores Condicionales de Fila */
        .highlight-win { background-color: rgba(40, 167, 69, 0.1); }
        .highlight-draw { background-color: rgba(255, 193, 7, 0.1); }
        .highlight-loss { background-color: rgba(220, 53, 69, 0.1); }
        .dark-mode .highlight-win { background-color: rgba(64, 196, 99, 0.2); }
        .dark-mode .highlight-draw { background-color: rgba(255, 235, 59, 0.2); }
        .dark-mode .highlight-loss { background-color: rgba(255, 107, 107, 0.2); }

        #score-matrix td {
            min-width: 60px;
            font-weight: 500;
        }

        .max-prob {
            background-color: var(--accent-color) !important;
            color: white;
            font-weight: 700 !important;
            border: 2px solid var(--warning-color) !important;
        }

        /* ================================================= */
        /* == CSS: Sugerencias de Valor                   == */
        /* ================================================= */
        #value-suggestions {
            min-height: 100px;
            padding: 15px;
            border: 2px solid var(--success-color);
            border-radius: 8px;
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .dark-mode #value-suggestions {
             background-color: rgba(64, 196, 99, 0.15);
        }

        .value-tip {
            background-color: var(--success-color);
            color: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .advice-text {
            font-style: italic;
            font-size: 0.9em;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .no-value-msg {
            text-align: center;
            color: var(--text-secondary);
            padding-top: 20px;
        }
        
        /* ================================================= */
        /* == CSS: Footer y Modo Toggle                   == */
        /* ================================================= */
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        #mode-toggle {
            background-color: var(--text-secondary);
            width: 200px;
            font-size: 0.9em;
            padding: 8px 15px;
        }
        
        #mode-toggle:hover {
            background-color: #5a6268;
        }
        
        /* ================================================= */
        /* == CSS: Responsividad                          == */
        /* ================================================= */
        @media (max-width: 850px) {
            .input-grid, .results-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 500px) {
            #calculator-container {
                padding: 15px;
            }
            .input-group label {
                font-size: 0.8em;
            }
            th, td {
                padding: 6px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body class="light-mode">

<div id="calculator-container">
    <header>
        <h1>BetAGS Pro 📊⚽</h1>
        <h2>Calculadora de Predicción Avanzada: Modelo de Poisson Doble Corregido</h2>
    </header>

    <main>
        <section id="input-section">
            <h3>Entrada de Parámetros Base</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="gl_l">GL_L (Media Goles Liga Local):</label>
                    <input type="number" id="gl_l" value="1.50" step="0.01">
                </div>
                <div class="input-group">
                    <label for="gl_v">GL_V (Media Goles Liga Visitante):</label>
                    <input type="number" id="gl_v" value="1.20" step="0.01">
                </div>
                <div class="input-group">
                    <label for="gf_l">GF_L (Media Goles a Favor Local):</label>
                    <input type="number" id="gf_l" value="1.70" step="0.01">
                </div>
                <div class="input-group">
                    <label for="gc_l">GC_L (Media Goles en Contra Local):</label>
                    <input type="number" id="gc_l" value="1.00" step="0.01">
                </div>
                <div class="input-group">
                    <label for="gf_v">GF_V (Media Goles a Favor Visitante):</label>
                    <input type="number" id="gf_v" value="1.40" step="0.01">
                </div>
                <div class="input-group">
                    <label for="gc_v">GC_V (Media Goles en Contra Visitante):</label>
                    <input type="number" id="gc_v" value="1.30" step="0.01">
                </div>
            </div>
            <div class="correction-factor">
                <label for="correlation_factor">Factor de Correlación/Ajuste Empírico (Corrección 0-0 & 1-1):</label>
                <input type="number" id="correlation_factor" value="0.04" step="0.005">
            </div>
            <button class="calculate-btn" onclick="calculatePredictions()">🚀 Calcular Predicciones</button>
        </section>

        <section id="output-section">
            <h3>Resultados y Análisis</h3>
            
            <div class="results-grid">
                <div>
                    <h4>1) Probabilidades Clave y Cuotas Implícitas</h4>
                    <table id="prob-odds-table">
                        <thead>
                            <tr><th>Mercado</th><th>P (%)</th><th>Cuota Implícita</th><th>Cuota Mínima Valor</th></tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                
                <div>
                    <h4>3) Sugerencias de Valor (Edge)</h4>
                    <p class="advice-text">El valor se sugiere si la **Probabilidad Predicha (P)** es significativamente mayor que la probabilidad implícita de la cuota de mercado ofrecida. (Criterio: Cuota de Mercado > 1/P + 0.10)</p>
                    <div id="value-suggestions">
                        <p class="no-value-msg">Calcula para ver sugerencias de apuestas.</p>
                    </div>
                </div>
            </div>

            <h3 style="margin-top: 40px;">2) Matriz de Probabilidades de Marcador Exacto (Corregido 5x5)</h3>
            <div class="score-matrix-container">
                <table id="score-matrix">
                    <thead>
                        <tr><th>L \ V</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4+</th></tr>
                    </thead>
                    <tbody>
                        <tr><th>0</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>1</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>2</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>3</th><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><th>4+</th><td></td><td></td><td></td><td></td><td></td></tr>
                    </tbody>
                </table>
            </div>

        </section>
    </main>

    <footer>
        <button id="mode-toggle" onclick="toggleMode()">🌞 Modo Oscuro / Claro 🌙</button>
    </footer>
</div>

<script>
    // =================================================
    // == JAVASCRIPT: Funcionalidad del Modelo        ==
    // =================================================

    // Cache para Factoriales para eficiencia
    const factorialCache = { 0: 1, 1: 1 };
    function factorial(n) {
        if (n in factorialCache) return factorialCache[n];
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return factorialCache[n] = result;
    }
    
    // Distribución de Poisson: P(X=k | lambda)
    function poisson(k, lambda) {
        if (k < 0) return 0;
        // Evitar overflow/underflow con logaritmos en entornos de producción, pero aquí se usa la fórmula directa.
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function calculatePredictions() {
        // 1. OBTENER PARÁMETROS
        const inputs = ['gl_l', 'gl_v', 'gf_l', 'gc_l', 'gf_v', 'gc_v', 'correlation_factor'];
        const params = {};
        for (const id of inputs) {
            params[id] = parseFloat(document.getElementById(id).value);
            if (isNaN(params[id]) || params[id] < 0) {
                alert('Por favor, introduce valores numéricos no negativos válidos en todos los campos.');
                return;
            }
        }

        const { gl_l, gl_v, gf_l, gc_l, gf_v, gc_v, correlation_factor: CORR_FACTOR } = params;

        // 2. CALCULAR TASAS ESPERADAS (LAMBDAS)
        // La implementación estándar del modelo de Poisson Doble es:
        // lambda_L = GF_L * GC_V * HOME_ADVANTAGE / (GL_L * GL_V)
        // Para simplificar, y dado que GL_L, GL_V ya contienen el promedio general, se usa:
        const lambdaL = (gf_l / gl_l) * (gc_v / gl_v) * gl_l; // Fuerza Ataque Local * Debilidad Defensa Visitante * Media Goles Local
        const lambdaV = (gf_v / gl_v) * (gc_l / gl_l) * gl_v; // Fuerza Ataque Visitante * Debilidad Defensa Local * Media Goles Visitante

        // 3. GENERAR MATRIZ INICIAL (POISSON INDEPENDIENTE)
        const maxGoals = 4;
        let probMatrix = [];
        let totalProb = 0;

        for (let i = 0; i <= maxGoals; i++) {
            probMatrix[i] = [];
            for (let j = 0; j <= maxGoals; j++) {
                let probL = (i < maxGoals) ? poisson(i, lambdaL) : 1 - Array.from({ length: maxGoals }, (_, k) => poisson(k, lambdaL)).reduce((a, b) => a + b, 0);
                let probV = (j < maxGoals) ? poisson(j, lambdaV) : 1 - Array.from({ length: maxGoals }, (_, k) => poisson(k, lambdaV)).reduce((a, b) => a + b, 0);
                
                probMatrix[i][j] = probL * probV;
                totalProb += probMatrix[i][j];
            }
        }
        
        // Normalización inicial
        let normalizedProbMatrix = probMatrix.map(row => row.map(p => p / totalProb));
        let sumBeforeCorrection = 1.0; 

        // 4. APLICAR CORRECCIÓN EMPÍRICA (CORRELACIÓN)
        
        // Sumamos el factor a 0-0 y 1-1
        const prob00 = normalizedProbMatrix[0][0];
        const prob11 = normalizedProbMatrix[1][1];
        
        const correction_applied = CORR_FACTOR;
        
        normalizedProbMatrix[0][0] += correction_applied / 2;
        normalizedProbMatrix[1][1] += correction_applied / 2;
        
        // Reducimos proporcionalmente el resto de la matriz para re-normalizar
        const reductionFactor = (sumBeforeCorrection - correction_applied) / (sumBeforeCorrection - prob00 - prob11);
        
        let finalProbMatrix = [];
        let newTotalProb = 0;

        for (let i = 0; i <= maxGoals; i++) {
            finalProbMatrix[i] = [];
            for (let j = 0; j <= maxGoals; j++) {
                if (!((i === 0 && j === 0) || (i === 1 && j === 1))) {
                    // Reducir la probabilidad de todos los demás marcadores
                    finalProbMatrix[i][j] = normalizedProbMatrix[i][j] * reductionFactor;
                } else {
                    // Mantener los valores corregidos para 0-0 y 1-1
                    finalProbMatrix[i][j] = normalizedProbMatrix[i][j];
                }
                newTotalProb += finalProbMatrix[i][j];
            }
        }
        
        // Ajuste final para asegurar que la suma es 1.0 (para errores de redondeo)
        const finalNormalizationFactor = 1.0 / newTotalProb;
        for (let i = 0; i <= maxGoals; i++) {
            for (let j = 0; j <= maxGoals; j++) {
                finalProbMatrix[i][j] *= finalNormalizationFactor;
            }
        }


        // 5. CALCULAR MERCADOS (1X2, O/U, Ambos Anotan)
        let prob1 = 0, probX = 0, prob2 = 0;
        let probOU15 = 0, probOU25 = 0, probOU35 = 0;
        let probBTTS = 0;
        
        for (let i = 0; i <= maxGoals; i++) {
            for (let j = 0; j <= maxGoals; j++) {
                const P = finalProbMatrix[i][j];

                if (i > j) { prob1 += P; }
                else if (i === j) { probX += P; }
                else { prob2 += P; }
                
                // La suma de goles usa los índices (0-3) o un valor de 4 para 4+
                const totalGoals = (i === maxGoals ? maxGoals : i) + (j === maxGoals ? maxGoals : j);
                
                if (totalGoals > 1.5) { probOU15 += P; }
                if (totalGoals > 2.5) { probOU25 += P; }
                if (totalGoals > 3.5) { probOU35 += P; }

                // BTTS: Si ambos equipos han marcado al menos 1 gol (incluye 4+ en ambos casos)
                if (i >= 1 && j >= 1) { probBTTS += P; }
            }
        }
        
        // 6. FORMATEAR Y MOSTRAR RESULTADOS
        
        const markets = [
            { name: '1 (Local Gana)', prob: prob1, type: 'win' },
            { name: 'X (Empate)', prob: probX, type: 'draw' },
            { name: '2 (Visitante Gana)', prob: prob2, type: 'loss' },
            { name: 'Over 1.5 Goles', prob: probOU15, type: 'over' },
            { name: 'Under 1.5 Goles', prob: 1 - probOU15, type: 'under' },
            { name: 'Over 2.5 Goles', prob: probOU25, type: 'over' },
            { name: 'Under 2.5 Goles', prob: 1 - probOU25, type: 'under' },
            { name: 'Over 3.5 Goles', prob: probOU35, type: 'over' },
            { name: 'Under 3.5 Goles', prob: 1 - probOU35, type: 'under' },
            { name: 'Ambos Anotan (Sí)', prob: probBTTS, type: 'btts' },
            { name: 'Ambos Anotan (No)', prob: 1 - probBTTS, type: 'btts' }
        ];

        // 6.1 Tabla Detallada
        const tableBody = document.querySelector('#prob-odds-table tbody');
        tableBody.innerHTML = '';
        
        let valueSuggestionsHTML = '';
        let hasValue = false;
        
        markets.forEach(m => {
            const probPercent = (m.prob * 100).toFixed(2);
            const impliedOdd = (1 / m.prob).toFixed(2);
            // Cuota Mínima de Valor: Cuota Implícita + 0.10 de margen (Edge Requerido)
            const minOddValue = (1 / m.prob + 0.10).toFixed(2); 

            let rowClass = '';
            if (m.type === 'win') rowClass = 'highlight-win';
            if (m.type === 'draw') rowClass = 'highlight-draw';
            if (m.type === 'loss') rowClass = 'highlight-loss';
            
            tableBody.innerHTML += `
                <tr class="${rowClass}">
                    <td>${m.name}</td>
                    <td>${probPercent}%</td>
                    <td>$${impliedOdd}</td>
                    <td>$${minOddValue}</td>
                </tr>
            `;
            
            // 6.3 Sugerencias de Valor
            // Asumimos una cuota de mercado simulada para el ejemplo de valor.
            // Si la probabilidad es alta y la cuota simulada está por encima del valor requerido, es valor.
            let simulatedOdd = 0;
            if (m.prob >= 0.65) simulatedOdd = (m.prob > 0.68) ? impliedOdd + 0.15 : impliedOdd + 0.11;
            else if (m.prob >= 0.50) simulatedOdd = (m.prob > 0.55) ? impliedOdd + 0.20 : 0;
            
            if (simulatedOdd > 0 && simulatedOdd > parseFloat(minOddValue)) {
                valueSuggestionsHTML += `
                    <p class="value-tip">🤑 **¡VALOR EN ${m.name}**! P: ${probPercent}% (Impl.: $${impliedOdd}). Si la casa ofrece **$${simulatedOdd.toFixed(2)}**, ¡es **EDGE**!</p>
                `;
                hasValue = true;
            }
        });
        
        // Mostrar Sugerencias de Valor
        const suggestionsDiv = document.getElementById('value-suggestions');
        suggestionsDiv.innerHTML = hasValue ? valueSuggestionsHTML : `<p class="no-value-msg">No se encontraron sugerencias de valor con el criterio actual ($1/P + 0.10). Prueba a ajustar los parámetros.</p>`;
        

        // 6.2 Matriz Visual de Marcadores
        const matrixTable = document.getElementById('score-matrix');
        let maxProbScore = { i: -1, j: -1, prob: -1 };
        
        for (let i = 0; i <= maxGoals; i++) {
            const row = matrixTable.rows[i + 1];
            for (let j = 0; j <= maxGoals; j++) {
                const cell = row.cells[j + 1];
                const P = finalProbMatrix[i][j];
                const probPercent = (P * 100).toFixed(2) + '%';
                
                cell.textContent = probPercent;
                cell.className = '';

                if (P > maxProbScore.prob) {
                    maxProbScore = { i: i, j: j, prob: P };
                }
            }
        }
        
        // Resaltar el marcador de máxima probabilidad
        if (maxProbScore.i !== -1) {
            matrixTable.rows[maxProbScore.i + 1].cells[maxProbScore.j + 1].classList.add('max-prob');
        }
    }
    
    // Función para alternar Modo Oscuro/Claro
    function toggleMode() {
        const body = document.body;
        const button = document.getElementById('mode-toggle');
        
        if (body.classList.contains('light-mode')) {
            body.classList.remove('light-mode');
            body.classList.add('dark-mode');
            button.innerHTML = '🌞 Modo Claro 🌙';
        } else {
            body.classList.remove('dark-mode');
            body.classList.add('light-mode');
            button.innerHTML = '🌞 Modo Oscuro / Claro 🌙';
        }
    }
    
    // Ejecutar el cálculo al cargar la página con valores por defecto
    document.addEventListener('DOMContentLoaded', calculatePredictions);
</script>

</body>
</html>

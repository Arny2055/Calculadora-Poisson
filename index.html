<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson de Apuestas de Fútbol</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h2 { color: #333; text-align: center; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="number"] { width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .resultado { margin-top: 30px; padding: 15px; border: 2px solid #28a745; border-radius: 5px; background-color: #e9f7eb; }
        .resultado h3 { margin-top: 0; color: #28a745; }
        .probabilidad { margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Calculadora Poisson Fútbol</h2>
    
    <form id="poisson-form">
        <label for="avg_goles_liga">Promedio de Goles de la Liga por partido (ej: 2.7)</label>
        <input type="number" id="avg_goles_liga" value="2.7" step="0.01" required>

        <label for="avg_gl_home">Promedio de Goles Local (GL) de la Liga (ej: 1.55)</label>
        <input type="number" id="avg_gl_home" value="1.55" step="0.01" required>

        <label for="avg_gv_away">Promedio de Goles Visita (GV) de la Liga (ej: 1.15)</label>
        <input type="number" id="avg_gv_away" value="1.15" step="0.01" required>
        
        <label for="gf_local">GF del Equipo Local (Total Goles a Favor como Local) (ej: 25)</label>
        <input type="number" id="gf_local" value="25" required>

        <label for="gc_local">GC del Equipo Local (Total Goles en Contra como Local) (ej: 15)</label>
        <input type="number" id="gc_local" value="15" required>
        
        <label for="partidos_local">Partidos jugados como Local (ej: 10)</label>
        <input type="number" id="partidos_local" value="10" required>
        
        <label for="gf_visita">GF del Equipo Visitante (Total Goles a Favor como Visita) (ej: 18)</label>
        <input type="number" id="gf_visita" value="18" required>
        
        <label for="gc_visita">GC del Equipo Visitante (Total Goles en Contra como Visita) (ej: 22)</label>
        <input type="number" id="gc_visita" value="22" required>
        
        <label for="partidos_visita">Partidos jugados como Visita (ej: 10)</label>
        <input type="number" id="partidos_visita" value="10" required>
        
        <label for="porc_aa">Porcentaje de Ambos Anotan de la Liga (%) (ej: 55)</label>
        <input type="number" id="porc_aa" value="55" step="0.1" required>

        <label for="porc_over25">Porcentaje de Over 2.5 FT de la Liga (%) (ej: 50)</label>
        <input type="number" id="porc_over25" value="50" step="0.1" required>
        
        <button type="submit">Calcular Predicción</button>
    </form>

    <div id="resultado" class="resultado" style="display:none;">
        <h3>Resultado de la Predicción</h3>
        <p><strong>Goles Esperados (Lambda):</strong></p>
        <p>Local ($\lambda_H$): <span id="lambda_home"></span></p>
        <p>Visita ($\lambda_A$): <span id="lambda_away"></span></p>
        
        <div class="probabilidad">
            <strong>Probabilidades:</strong>
            <p>P(Over 2.5): <span id="prob_over25"></span></p>
            <p>P(Ambos Anotan): <span id="prob_aa"></span></p>
            <p>P(Local Gana): <span id="prob_local"></span></p>
            <p>P(Empate): <span id="prob_empate"></span></p>
            <p>P(Visita Gana): <span id="prob_visita"></span></p>
        </div>

        <div class="mercado-sugerido">
            <strong>Mercado Sugerido:</strong>
            <p id="sugerencia"></p>
        </div>
    </div>
</div>

<script>
    document.getElementById('poisson-form').addEventListener('submit', function(event) {
        event.preventDefault();
        calcularPoisson();
    });

    // Función factorial (para la fórmula de Poisson)
    function factorial(n) {
        if (n === 0) return 1;
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    // Fórmula de Distribución de Poisson: P(k; lambda)
    function poisson(k, lambda) {
        if (lambda <= 0) return 0;
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function calcularPoisson() {
        // 1. Obtener valores de entrada
        const avgGolesLiga = parseFloat(document.getElementById('avg_goles_liga').value);
        const avgGLHome = parseFloat(document.getElementById('avg_gl_home').value); // Promedio goles a favor de local de la liga
        const avgGVAway = parseFloat(document.getElementById('avg_gv_away').value); // Promedio goles a favor de visita de la liga

        const gfLocal = parseInt(document.getElementById('gf_local').value);
        const gcLocal = parseInt(document.getElementById('gc_local').value);
        const partidosLocal = parseInt(document.getElementById('partidos_local').value);
        
        const gfVisita = parseInt(document.getElementById('gf_visita').value);
        const gcVisita = parseInt(document.getElementById('gc_visita').value);
        const partidosVisita = parseInt(document.getElementById('partidos_visita').value);

        const porcAA = parseFloat(document.getElementById('porc_aa').value) / 100;
        const porcOver25 = parseFloat(document.getElementById('porc_over25').value) / 100;
        
        // Criterios de Sugerencia
        const MARGEN_SUGERENCIA_OVER = 0.05; // 5% por encima del promedio de liga
        const MARGEN_SUGERENCIA_AA = 0.05; // 5% por encima del promedio de liga
        const MARGEN_SUGERENCIA_UNDER_AA = 0.05; // 5% por debajo del promedio de liga

        // 2. Calcular Atributos Individuales
        
        // A. Fuerza de Ataque y Defensa del Local
        const attLocal = (gfLocal / partidosLocal) / avgGLHome;
        const defLocal = (gcLocal / partidosLocal) / avgGVAway; // Promedio de goles en contra como Local / Promedio de goles a favor de Visitantes de Liga

        // B. Fuerza de Ataque y Defensa del Visitante
        const attVisita = (gfVisita / partidosVisita) / avgGVAway;
        const defVisita = (gcVisita / partidosVisita) / avgGLHome; // Promedio de goles en contra como Visitante / Promedio de goles a favor de Locales de Liga
        
        // 3. Calcular Goles Esperados ($\lambda$) para el partido
        // Goles esperados del Local (en casa)
        const lambdaHome = attLocal * avgGLHome * defVisita;
        // Goles esperados del Visitante (fuera)
        const lambdaAway = attVisita * avgGVAway * defLocal;
        
        // 4. Calcular la Matriz de Probabilidades de Marcador (hasta 5-5 para simplificar)
        let prob_matriz = [];
        let prob_over25 = 0;
        let prob_aa = 0;
        let prob_local = 0;
        let prob_empate = 0;
        let prob_visita = 0;

        for (let home_goals = 0; home_goals <= 5; home_goals++) {
            prob_matriz[home_goals] = [];
            for (let away_goals = 0; away_goals <= 5; away_goals++) {
                // Probabilidad de un marcador específico
                const prob_score = poisson(home_goals, lambdaHome) * poisson(away_goals, lambdaAway);
                prob_matriz[home_goals][away_goals] = prob_score;

                // Sumar para P(Over 2.5 Goles)
                if (home_goals + away_goals > 2.5) {
                    prob_over25 += prob_score;
                }
                
                // Sumar para P(Ambos Anotan) - Solo si ambos marcan 1 o más
                if (home_goals >= 1 && away_goals >= 1) {
                    prob_aa += prob_score;
                }
                
                // Sumar para P(Resultado Final)
                if (home_goals > away_goals) {
                    prob_local += prob_score;
                } else if (home_goals === away_goals) {
                    prob_empate += prob_score;
                } else {
                    prob_visita += prob_score;
                }
            }
        }
        
        // 5. Normalizar P(Resultado Final) para el rango 0-5
        const totalProbabilidades = prob_local + prob_empate + prob_visita + (1 - prob_matriz.flat().reduce((a, b) => a + b, 0));
        
        // 6. Generar Sugerencia de Mercado
        let sugerencia = "No hay una sugerencia clara.";
        const probOver25Porc = prob_over25 * 100;
        const probAAPorc = prob_aa * 100;
        
        if (probOver25 > porcOver25 + MARGEN_SUGERENCIA_OVER) {
            sugerencia = `**OVER 2.5 FT** (${probOver25Porc.toFixed(2)}%)`;
        } else if (prob_over25 < porcOver25 - MARGEN_SUGERENCIA_OVER) {
             sugerencia = `**UNDER 2.5 FT** (${(100 - probOver25Porc).toFixed(2)}%)`;
        }
        
        if (prob_aa > porcAA + MARGEN_SUGERENCIA_AA) {
            sugerencia += (sugerencia !== "No hay una sugerencia clara." ? " y " : "") + `**AMBOS ANOTAN** (${probAAPorc.toFixed(2)}%)`;
        } else if (prob_aa < porcAA - MARGEN_SUGERENCIA_UNDER_AA) {
            sugerencia += (sugerencia !== "No hay una sugerencia clara." ? " y " : "") + `**AMBOS NO ANOTAN** (${(100 - probAAPorc).toFixed(2)}%)`;
        }

        // Si la probabilidad de victoria de un equipo es significativamente alta
        const probGanarLocal = (prob_local / totalProbabilidades) * 100;
        const probGanarVisita = (prob_visita / totalProbabilidades) * 100;

        if (probGanarLocal > 60) {
            sugerencia += (sugerencia !== "No hay una sugerencia clara." ? " o " : "") + `**VICTORIA LOCAL** (${probGanarLocal.toFixed(2)}%)`;
        } else if (probGanarVisita > 60) {
            sugerencia += (sugerencia !== "No hay una sugerencia clara." ? " o " : "") + `**VICTORIA VISITANTE** (${probGanarVisita.toFixed(2)}%)`;
        }
        
        if (sugerencia === "No hay una sugerencia clara." && prob_empate / totalProbabilidades > 0.35) {
             sugerencia = `**POSIBLE EMPATE** (${((prob_empate / totalProbabilidades) * 100).toFixed(2)}%)`;
        }

        // 7. Mostrar Resultados
        document.getElementById('lambda_home').textContent = lambdaHome.toFixed(3);
        document.getElementById('lambda_away').textContent = lambdaAway.toFixed(3);
        document.getElementById('prob_over25').textContent = `${(prob_over25 * 100).toFixed(2)}%`;
        document.getElementById('prob_aa').textContent = `${(prob_aa * 100).toFixed(2)}%`;
        document.getElementById('prob_local').textContent = `${probGanarLocal.toFixed(2)}%`;
        document.getElementById('prob_empate').textContent = `${((prob_empate / totalProbabilidades) * 100).toFixed(2)}%`;
        document.getElementById('prob_visita').textContent = `${probGanarVisita.toFixed(2)}%`;
        document.getElementById('sugerencia').innerHTML = sugerencia;
        document.getElementById('resultado').style.display = 'block';
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Estadísticas Over/Under</title>
<style>
  :root{
    --bg:#0a0f1c; --card:#121826; --panel:#1a2333; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#3b82f6; --green:#10b981; --amber:#f59e0b; --red:#ef4444; --line:#263143;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px}
  h1{color:var(--accent);text-align:center;margin:8px 0 16px}

  /* Controles */
  .card{background:var(--card);border-radius:14px;padding:16px;margin:16px 0;border:3px solid transparent;transition:.2s border-color}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-size:.95rem}
  select,input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1726;color:var(--text);font-size:16px}
  button{background:var(--accent);border-color:var(--accent);font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.05)}

  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .tab{flex:1;min-width:110px;background:#0f1726;border:1px solid var(--line);color:var(--muted);padding:10px;border-radius:10px;cursor:pointer;text-align:center}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:700}

  /* Grid panels */
  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h3{margin:0 0 10px;font-size:1.05rem;color:#cbd5e1}

  /* Listas de stats */
  .kv{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed var(--line)}
  .kv:last-child{border-bottom:0}
  .muted{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums}
  .badge{display:inline-block;min-width:52px;text-align:center;padding:3px 8px;border-radius:999px;font-weight:700;color:#fff}
  .b-green{background:var(--green)} .b-amber{background:var(--amber)} .b-red{background:var(--red)}
  .b-soft{background:#0f1726;border:1px solid var(--line);color:#cbd5e1}

  /* Tablas compactas */
  table{width:100%;border-collapse:collapse;font-size:.95rem;margin-top:8px;overflow:hidden;border-radius:10px;border:1px solid var(--line)}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--line)}
  th{background:#0f1726;color:#cbd5e1;font-weight:600}
  tr:last-child td{border-bottom:0}

  .valueBox{margin-top:10px;padding:10px;border-radius:10px;text-align:center;font-weight:800}
  .value{background:var(--green);color:#fff} .novalue{background:var(--red);color:#fff}

  /* Subtítulos */
  .sub{display:flex;align-items:center;gap:8px;color:#cbd5e1;margin:8px 0 4px}
  .divider{height:1px;background:var(--line);margin:8px 0;border-radius:1px}

  /* Responsive helpers */
  .row{display:grid;gap:10px}
  @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
  <h1>Estadísticas Over/Under</h1>

  <!-- Controles -->
  <div class="card">
    <input type="file" id="fileInput" accept=".json,.txt"><br>

    <div class="row">
      <div>
        <label>Selecciona Liga</label>
        <select id="leagueSelect"></select>
      </div>
      <div>
        <label>Odd Over 2.5</label>
        <input type="number" id="oddOver" step="0.01" placeholder="Ej: 1.90">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Equipo Local</label>
        <select id="homeSelect"></select>
      </div>
      <div>
        <label>Odd Under 2.5</label>
        <input type="number" id="oddUnder" step="0.01" placeholder="Ej: 2.00">
      </div>
    </div>

    <label>Equipo Visitante</label>
    <select id="awaySelect"></select>

    <div class="tabs" id="tabs">
      <div class="tab active" data-period="FT">Full Time</div>
      <div class="tab" data-period="1H">First Half</div>
      <div class="tab" data-period="2H">Second Half</div>
    </div>

    <button id="analyzeBtn" style="margin-top:10px">Analizar</button>
  </div>

  <!-- Resultado principal (borde dinámico por O2.5) -->
  <div id="results" class="card"></div>

<script>
let allMatches = [];
let currentPeriod = "FT"; // FT | 1H | 2H

/* ---------- Utilidades ---------- */
function tryParseJSON(text){
  try { return JSON.parse(text); } catch(e){}
  // si viene como objetos separados por comas/nuevas líneas, intentamos envoltura
  const wrapped = "[" + text.trim()
    .replace(/(^,)|(,$)/g,"")
    .replace(/\n+/g,"\n")
    .replace(/\}\s*,\s*\{/g,"},{") + "]";
  try { return JSON.parse(wrapped); } catch(e2){ return []; }
}
function pct(a,b){ return b ? Math.round((a/b)*100) : 0; }
function cls(p){ return p>=70?"b-green":(p>=50?"b-amber":"b-red"); }
function badge(p){ return `<span class="badge ${cls(p)}">${p}%</span>`; }
function parseScore(txt){
  if(!txt) return [0,0];
  const m = txt.split("-").map(x=>parseInt(x,10));
  return [m[0]||0, m[1]||0];
}
function periodGoals(m){ // retorna [golesHomePeriodo, golesAwayPeriodo]
  const [hHT,aHT] = parseScore(m["Result HT"]);
  const [hFT,aFT] = parseScore(m["Result FT"]);
  if(currentPeriod==="FT") return [hFT,aFT];
  if(currentPeriod==="1H") return [hHT,aHT];
  return [(hFT-hHT),(aFT-aHT)]; // 2H
}
function teamPeriodGoals(m, team){
  const [home, away] = m.Match.split(" - ");
  const [gH,gA] = periodGoals(m);
  return (team===home)?[gH,gA]:(team===away)?[gA,gH]:[null,null];
}

/* ---------- Filtros ---------- */
function lastMatchesByRole(matches, team, role){ // role: "home" | "away"
  const arr = matches.filter(m=>{
    const [h,a]=m.Match.split(" - ");
    return role==="home"? h===team : a===team;
  });
  return arr.slice(-10);
}

/* ---------- Cálculos por equipo (sin tabla de overs para evitar redundancia) ---------- */
function calcTeamBlock(matches, team, role){
  const last = lastMatchesByRole(matches, team, role);
  const n = last.length;
  let scored=0, conceded=0, total=0, noScore=0, noConcede=0;

  // para summary (BTTS / OverX.X) usamos luego el promedio entre bloques home/away
  last.forEach(m=>{
    const [forTeam, opp] = teamPeriodGoals(m, team);
    if(forTeam==null) return;
    const tot = forTeam + opp;
    scored += forTeam; conceded += opp; total += tot;
    if(forTeam===0) noScore++;
    if(opp===0) noConcede++;
  });

  const avgScored = n? (scored/n).toFixed(1):"0.0";
  const avgConceded = n?(conceded/n).toFixed(1):"0.0";
  const avgGoals = n? (total/n).toFixed(1):"0.0";

  // devolvemos solo métricas base; Overs/BTTS se calcularán en funciones dedicadas por consistencia
  return {
    n, last,
    avgScored, avgConceded, avgGoals,
    pNoScore: pct(noScore,n),
    pNoConcede: pct(noConcede,n)
  };
}

/* ---------- Cálculos para summary (Home/Away/Match) ---------- */
function percentOver(lastMatches, team, line){
  const n = lastMatches.length;
  let over=0;
  lastMatches.forEach(m=>{
    const [h,a] = periodGoals(m);
    if(h+a > line) over++;
  });
  return pct(over,n);
}
function percentBTTS(lastMatches){
  const n = lastMatches.length;
  let yes=0;
  lastMatches.forEach(m=>{
    const [h,a] = periodGoals(m);
    if(h>0 && a>0) yes++;
  });
  return pct(yes,n);
}

/* ---------- Handicap por equipo ---------- */
function handicapBlock(lastMatches, team){
  const lines=[-2.5,-1.5,-0.5,0.5,1.5,2.5];
  const n = lastMatches.length;
  const hcap = Object.fromEntries(lines.map(l=>[l,{win:0,loss:0}]));
  lastMatches.forEach(m=>{
    const [home, away] = m.Match.split(" - ");
    const [h,a] = periodGoals(m);
    const forTeam = (team===home)?h:(team===away)?a:null;
    const opp = (team===home)?a:(team===away)?h:null;
    if(forTeam==null) return;
    const diff = forTeam - opp;
    lines.forEach(l=>{
      if(diff - l > 0) hcap[l].win++;
      else hcap[l].loss++;
    });
  });
  // convertir a %
  lines.forEach(l=>{
    hcap[l].win = pct(hcap[l].win,n);
    hcap[l].loss = pct(hcap[l].loss,n);
  });
  return hcap;
}

/* ---------- UI ---------- */
function renderTeamPanel(title, stats){
  return `
  <div class="panel">
    <div class="sub"><strong>${title}</strong></div>
    <div class="kv"><span class="muted">Avg. Scored</span><span class="mono">${stats.avgScored}</span></div>
    <div class="kv"><span class="muted">Avg. Suffer</span><span class="mono">${stats.avgConceded}</span></div>
    <div class="kv"><span class="muted">Avg. Goals</span><span class="mono">${stats.avgGoals}</span></div>
    <div class="divider"></div>
    <div class="kv"><span>Games without Scoring</span><span>${badge(stats.pNoScore)}</span></div>
    <div class="kv"><span>Games without Conceding</span><span>${badge(stats.pNoConcede)}</span></div>
  </div>`;
}

function renderHandicapTable(title, hcap){
  const lines=[-2.5,-1.5,-0.5,0.5,1.5,2.5];
  const rows = lines.map(l=>`
    <tr>
      <td class="mono">${l>0?`+${l}`:l}</td>
      <td>${badge(hcap[l].win)}</td>
      <td>${badge(hcap[l].loss)}</td>
    </tr>
  `).join("");
  return `
    <div class="panel">
      <h3>${title}</h3>
      <table>
        <tr><th>Hcp</th><th>Win</th><th>Loss</th></tr>
        ${rows}
      </table>
    </div>
  `;
}

/* Summary con BTTS debajo de Over 3.5 */
function renderSummaryTable(homeLast, awayLast){
  // Home/Away por rol
  const h = {
    o05: percentOver(homeLast,"home",0.5), // esta firma no usa el segundo arg realmente
    o15: percentOver(homeLast,"home",1.5),
    o25: percentOver(homeLast,"home",2.5),
    o35: percentOver(homeLast,"home",3.5),
    btts: percentBTTS(homeLast)
  };
  const a = {
    o05: percentOver(awayLast,"away",0.5),
    o15: percentOver(awayLast,"away",1.5),
    o25: percentOver(awayLast,"away",2.5),
    o35: percentOver(awayLast,"away",3.5),
    btts: percentBTTS(awayLast)
  };
  const avg = (x,y)=>Math.round((x+y)/2);

  const row = (label, hv, av, mv)=>`
    <tr>
      <td>${label}</td>
      <td>${badge(hv)}</td>
      <td>${badge(av)}</td>
      <td><span class="badge ${cls(mv)}">${mv}%</span></td>
    </tr>
  `;

  return `
    <div class="panel">
      <h3>Summary</h3>
      <table>
        <tr><th></th><th>Home</th><th>Away</th><th>Match</th></tr>
        ${row('Over 0.5',  h.o05, a.o05, avg(h.o05,a.o05))}
        ${row('Over 1.5',  h.o15, a.o15, avg(h.o15,a.o15))}
        ${row('Over 2.5',  h.o25, a.o25, avg(h.o25,a.o25))}
        ${row('Over 3.5',  h.o35, a.o35, avg(h.o35,a.o35))}
        ${row('BTTS',      h.btts, a.btts, avg(h.btts,a.btts))}
      </table>
    </div>
  `;
}

function valueBox(prob, odd){
  if(!odd || odd<=1) return "";
  const implied = Math.round(100/odd);
  return prob > implied
    ? `<div class="valueBox value">VALUE (Model ${prob}% vs ${implied}% imp.)</div>`
    : `<div class="valueBox novalue">NO VALUE (Model ${prob}% vs ${implied}% imp.)</div>`;
}

/* ---------- Carga de archivo ---------- */
document.getElementById("fileInput").addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const rd = new FileReader();
  rd.onload = ev=>{
    allMatches = tryParseJSON(ev.target.result).map(m=>({
      ...m,
      League: m.League || m.league || "",
      Match: m.Match || m.match || "",
      "Result HT": m["Result HT"] || m.result_ht || m.ht || "0-0",
      "Result FT": m["Result FT"] || m.result_ft || m.ft || "0-0"
    }));
    const leagues = [...new Set(allMatches.map(m=>m.League).filter(Boolean))].sort();
    const leagueSelect = document.getElementById("leagueSelect");
    leagueSelect.innerHTML = "<option value=''>--Selecciona--</option>" + leagues.map(l=>`<option>${l}</option>`).join("");
  };
  rd.readAsText(file);
});

/* ---------- Selects dependientes ---------- */
document.getElementById("leagueSelect").addEventListener("change", function(){
  const league = this.value;
  const leagueMatches = allMatches.filter(m=>m.League===league);
  const teams = [...new Set(leagueMatches.flatMap(m=>m.Match.split(" - ")))].sort();
  const home = document.getElementById("homeSelect");
  const away = document.getElementById("awaySelect");
  home.innerHTML = teams.map(t=>`<option>${t}</option>`).join("");
  away.innerHTML = teams.map(t=>`<option>${t}</option>`).join("");
});

/* ---------- Tabs de periodo ---------- */
document.getElementById("tabs").addEventListener("click", (e)=>{
  const t = e.target.closest(".tab"); if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  currentPeriod = t.dataset.period;
});

/* ---------- Acción principal ---------- */
document.getElementById("analyzeBtn").addEventListener("click", ()=>{
  const league = document.getElementById("leagueSelect").value;
  const homeTeam = document.getElementById("homeSelect").value;
  const awayTeam = document.getElementById("awaySelect").value;
  const oddOver = parseFloat(document.getElementById("oddOver").value);
  const oddUnder = parseFloat(document.getElementById("oddUnder").value);

  if(!league || !homeTeam || !awayTeam || homeTeam===awayTeam){
    alert("Selecciona liga y equipos (distintos).");
    return;
  }

  const leagueMatches = allMatches.filter(m=>m.League===league);
  // Últimos 10 por rol
  const homeLast = lastMatchesByRole(leagueMatches, homeTeam, "home");
  const awayLast = lastMatchesByRole(leagueMatches, awayTeam, "away");

  // Bloques base (sin overs por equipo para evitar redundancia)
  const homeStats = calcTeamBlock(leagueMatches, homeTeam, "home");
  const awayStats = calcTeamBlock(leagueMatches, awayTeam, "away");

  // Paneles
  const teamPanels = `
    ${renderTeamPanel(homeTeam, homeStats)}
    ${renderTeamPanel(awayTeam, awayStats)}
  `;

  // Summary (incluye BTTS debajo de Over 3.5)
  const summary = renderSummaryTable(homeLast, awayLast);

  // Handicap
  const hcapHome = handicapBlock(homeLast, homeTeam);
  const hcapAway = handicapBlock(awayLast, awayTeam);
  const hcaps = `
    ${renderHandicapTable(`${homeTeam} Handicap Goals`, hcapHome)}
    ${renderHandicapTable(`${awayTeam} Handicap Goals`, hcapAway)}
  `;

  // Value para O/U 2.5 del periodo activo (Match = promedio H/A)
  const o25Home = percentOver(homeLast,"home",2.5);
  const o25Away = percentOver(awayLast,"away",2.5);
  const matchOver25 = Math.round((o25Home+o25Away)/2);
  const valueOver = valueBox(matchOver25, oddOver);
  const valueUnder = valueBox(100-matchOver25, oddUnder);

  // Dump
  const res = document.getElementById("results");
  res.innerHTML = `
    <div class="kv"><span class="muted">Periodo activo</span><span class="badge b-soft">${currentPeriod}</span></div>
    <div class="divider"></div>
    <div class="grid">${teamPanels}</div>
    <div class="grid" style="margin-top:12px">${summary}${hcaps}</div>
    ${(oddOver||oddUnder)?`<div class="grid" style="margin-top:12px">
      <div class="panel"><h3>Over 2.5</h3>${valueOver||'<div class="muted">Ingresa Odd Over 2.5</div>'}</div>
      <div class="panel"><h3>Under 2.5</h3>${valueUnder||'<div class="muted">Ingresa Odd Under 2.5</div>'}</div>
    </div>`:""}
  `;

  // Contorno dinámico por Over 2.5 del periodo (summary Match)
  if (matchOver25 >= 70) res.style.borderColor = "var(--green)";
  else if (matchOver25 >= 50) res.style.borderColor = "var(--amber)";
  else res.style.borderColor = "var(--red)";
});
</script>
</body>
</html>
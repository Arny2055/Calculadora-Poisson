<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Poisson — 1X2 en 3 columnas + Hot Picks (FT/HT, Córners, Tarjetas)</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{ --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
         --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --border:#2a3140; }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
  header{padding:18px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#121520,#0f1115)}
  h1{margin:0; font-size:20px}
  .wrap{max-width:1200px; margin:20px auto; padding:0 16px}
  .grid{display:grid; gap:14px}
  @media(min-width:1180px){ .grid{grid-template-columns: 1.2fr 1fr} }
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; position:relative}
  .card h2{margin:6px 0 12px; font-size:16px}
  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  select, input[type="number"], input[type="text"]{
    width:100%; padding:10px 12px; background:var(--panel2); color:var(--text);
    border:1px solid var(--border); border-radius:10px; font-size:14px;
  }
  input[type="file"]{width:100%}
  .row{display:grid; gap:10px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }
  .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--border);
    background:linear-gradient(180deg,#1b2130,#171a21); color:var(--text); font-weight:600; cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .accent{background:linear-gradient(180deg,#2a58ff,#264bda); border-color:#2c4fd0}
  .muted{color:var(--muted)}
  .kpis{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
  @media(min-width:960px){ .kpis{grid-template-columns:repeat(4,1fr)} }
  .kpi{background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:12px; position:relative; overflow:hidden}
  .kpi .t{font-size:12px; color:var(--muted)}
  .kpi .v{font-size:20px; font-weight:800; margin-top:4px}
  .kpi .sub{font-size:12px; color:var(--muted); margin-top:2px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:8px 10px; border-bottom:1px solid var(--border)}
  th{text-align:left; color:#c9d3e7; background:#1a1f2a; position:sticky; top:0}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--panel2)}
  details {background:var(--panel2); border:1px solid var(--border); border-radius:10px; padding:10px; }
  summary{cursor:pointer; font-weight:600}
  .code{font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#cfe1ff}
  .footer{color:var(--muted); font-size:12px; text-align:center; padding:18px}

  /* Destacar "hot" */
  .hot{
    border-color: rgba(93,212,164,0.9);
    box-shadow: 0 0 0 1px rgba(93,212,164,0.9), 0 0 0 8px rgba(93,212,164,0.12);
    background:
      radial-gradient(1200px 80px at -10% -10%, rgba(93,212,164,0.08), transparent 60%),
      var(--panel2);
  }
  .badge-hot{
    position:absolute; top:8px; right:8px;
    font-size:11px; font-weight:700; letter-spacing:.2px;
    background:linear-gradient(180deg,#54e3b2,#3bc48f);
    color:#0e1a14; border:0; border-radius:999px; padding:4px 8px;
    display:none;
  }
  .kpi.hot .badge-hot{ display:inline-block; }
</style>
</head>
<body>
<header><h1>Poisson — 1X2 en 3 columnas + Hot Picks (FT/HT, Córners, Tarjetas)</h1></header>
<div class="wrap grid">
  <div class="card">
    <h2>1) Cargar JSON & elegir</h2>
    <label>Archivo JSON (array, objeto o NDJSON). Acepta agregados por equipo, partidos crudos o “Match + Result FT”.</label>
    <input id="file" type="file" accept=".json,.txt,.ndjson,.csv" />

    <div class="row">
      <div>
        <label> Liga </label>
        <select id="league" disabled></select>
      </div>
      <div>
        <label> Ventaja local FT (HA) </label>
        <input id="ha" type="number" step="0.01" min="0.5" max="1.6" value="1.10" />
      </div>
    </div>

    <div class="row">
      <div>
        <label> Local </label>
        <select id="home" disabled></select>
      </div>
      <div>
        <label> Visitante </label>
        <select id="away" disabled></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label> Factor HT (goles 1T / partido) </label>
        <input id="htFactor" type="number" step="0.01" min="0.2" max="0.8" value="0.45" />
      </div>
      <div>
        <label> Ventaja local HT (HA_HT) </label>
        <input id="ha_ht" type="number" step="0.01" min="0.5" max="1.6" value="1.05" />
      </div>
    </div>

    <div class="row">
      <div>
        <label> HA Córners (solo local) </label>
        <input id="ha_corners" type="number" step="0.01" min="0.8" max="1.4" value="1.05" />
      </div>
      <div>
        <label> HA Tarjetas (solo local) </label>
        <input id="ha_cards" type="number" step="0.01" min="0.8" max="1.4" value="1.00" />
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="calc" class="btn accent" disabled>Calcular</button>
      <span id="status" class="muted" style="margin-left:10px"></span>
    </div>

    <details style="margin-top:14px">
      <summary>Claves que reconoce (ejemplos)</summary>
      <div class="code" style="margin-top:8px">
        [
          {"League":"Argentina Liga Profesional","Match":"Banfield - Instituto","Result FT":"1-2",
           "Home Corners at FT":"7","Away Corners at FT":"8",
           "Home YellowCards at FT":"3","Away YellowCards at FT":"5",
           "Home RedCards at FT":"0","Away RedCards at FT":"0"}
        ]
      </div>
    </details>
  </div>

  <!-- MÉTRICAS GOLES (FT) -->
  <div class="card">
    <h2>2) Métricas FT — Goles</h2>
    <div class="kpis">
      <div class="kpi"><div class="t">μ liga (goles/eq/part)</div><div class="v" id="k_mu">—</div></div>
      <div class="kpi"><div class="t">Att Local</div><div class="v" id="k_att_h">—</div></div>
      <div class="kpi"><div class="t">Def Local</div><div class="v" id="k_def_h">—</div></div>
      <div class="kpi"><div class="t">Att Visit</div><div class="v" id="k_att_a">—</div></div>
      <div class="kpi"><div class="t">Def Visit</div><div class="v" id="k_def_a">—</div></div>
      <div class="kpi"><div class="t">λ Local FT</div><div class="v" id="k_lh">—</div></div>
      <div class="kpi"><div class="t">λ Visit FT</div><div class="v" id="k_la">—</div></div>
    </div>
  </div>

  <!-- 1X2 FT en 3 columnas -->
  <div class="card">
    <h2>3) 1X2 — FT</h2>
    <div class="grid3">
      <div class="kpi" data-market="ft_1"><span class="badge-hot">🔥 Más probable</span><div class="t">Home Win (1)</div><div class="v pv" id="ft_1">—</div></div>
      <div class="kpi" data-market="ft_x"><span class="badge-hot">🔥 Más probable</span><div class="t">Draw (X)</div><div class="v pv" id="ft_x">—</div></div>
      <div class="kpi" data-market="ft_2"><span class="badge-hot">🔥 Más probable</span><div class="t">Away Win (2)</div><div class="v pv" id="ft_2">—</div></div>
    </div>
    <div class="sub muted" style="margin-top:8px">Señalamos automáticamente las probabilidades más altas entre todos los mercados.</div>
  </div>

  <!-- Otros mercados FT -->
  <div class="card">
    <h2>4) FT — O/U & BTTS</h2>
    <div class="kpis">
      <div class="kpi" data-market="btts"><span class="badge-hot">🔥 Más probable</span><div class="t">BTTS: Sí</div><div class="v pv" id="m_btts">—</div></div>
      <div class="kpi" data-market="o25"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 2.5</div><div class="v pv" id="m_o25">—</div></div>
      <div class="kpi" data-market="u25"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 2.5</div><div class="v pv" id="m_u25">—</div></div>
    </div>
  </div>

  <!-- 1X2 HT en 3 columnas -->
  <div class="card">
    <h2>5) 1X2 — HT (1er tiempo)</h2>
    <div class="grid3">
      <div class="kpi" data-market="ht_1"><span class="badge-hot">🔥 Más probable</span><div class="t">HT Home (1)</div><div class="v pv" id="ht_1">—</div></div>
      <div class="kpi" data-market="ht_x"><span class="badge-hot">🔥 Más probable</span><div class="t">HT Draw (X)</div><div class="v pv" id="ht_x">—</div></div>
      <div class="kpi" data-market="ht_2"><span class="badge-hot">🔥 Más probable</span><div class="t">HT Away (2)</div><div class="v pv" id="ht_2">—</div></div>
    </div>
  </div>

  <!-- Otros mercados HT -->
  <div class="card">
    <h2>6) HT — O/U & BTTS</h2>
    <div class="kpis">
      <div class="kpi" data-market="ht_btts"><span class="badge-hot">🔥 Más probable</span><div class="t">BTTS HT: Sí</div><div class="v pv" id="ht_btts">—</div></div>
      <div class="kpi" data-market="ht_o05"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 0.5 HT</div><div class="v pv" id="ht_o05">—</div></div>
      <div class="kpi" data-market="ht_u05"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 0.5 HT</div><div class="v pv" id="ht_u05">—</div></div>
      <div class="kpi" data-market="ht_o15"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 1.5 HT</div><div class="v pv" id="ht_o15">—</div></div>
      <div class="kpi" data-market="ht_u15"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 1.5 HT</div><div class="v pv" id="ht_u15">—</div></div>
    </div>
  </div>

  <!-- CÓRNERS -->
  <div class="card">
    <h2>7) Córners (FT)</h2>
    <div class="kpis">
      <div class="kpi"><div class="t">μ liga (córners/eq/part)</div><div class="v" id="c_mu">—</div></div>
      <div class="kpi"><div class="t">λ Córners Local</div><div class="v" id="c_lh">—</div></div>
      <div class="kpi"><div class="t">λ Córners Visit</div><div class="v" id="c_la">—</div></div>
      <div class="kpi"><div class="t">λ Córners Total</div><div class="v" id="c_tot">—</div></div>
    </div>
    <div class="kpis" style="margin-top:10px">
      <div class="kpi" data-market="c_o85"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 8.5</div><div class="v pv" id="c_o85">—</div></div>
      <div class="kpi" data-market="c_u85"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 8.5</div><div class="v pv" id="c_u85">—</div></div>
      <div class="kpi" data-market="c_o95"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 9.5</div><div class="v pv" id="c_o95">—</div></div>
      <div class="kpi" data-market="c_u95"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 9.5</div><div class="v pv" id="c_u95">—</div></div>
      <div class="kpi" data-market="c_o105"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 10.5</div><div class="v pv" id="c_o105">—</div></div>
      <div class="kpi" data-market="c_u105"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 10.5</div><div class="v pv" id="c_u105">—</div></div>
    </div>
  </div>

  <!-- TARJETAS -->
  <div class="card">
    <h2>8) Tarjetas (FT)</h2>
    <div class="kpis">
      <div class="kpi"><div class="t">μ liga (amarillas/eq/part)</div><div class="v" id="y_mu">—</div></div>
      <div class="kpi"><div class="t">λ Amarillas Local</div><div class="v" id="y_lh">—</div></div>
      <div class="kpi"><div class="t">λ Amarillas Visit</div><div class="v" id="y_la">—</div></div>
      <div class="kpi"><div class="t">λ Amarillas Total</div><div class="v" id="y_tot">—</div></div>
      <div class="kpi"><div class="t">μ liga (rojas/eq/part)</div><div class="v" id="r_mu">—</div></div>
      <div class="kpi"><div class="t">λ Rojas Local</div><div class="v" id="r_lh">—</div></div>
      <div class="kpi"><div class="t">λ Rojas Visit</div><div class="v" id="r_la">—</div></div>
      <div class="kpi"><div class="t">λ Rojas Total</div><div class="v" id="r_tot">—</div></div>
    </div>
    <div class="kpis" style="margin-top:10px">
      <div class="kpi" data-market="y_o35"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 3.5 Amarillas</div><div class="v pv" id="y_o35">—</div></div>
      <div class="kpi" data-market="y_u35"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 3.5 Amarillas</div><div class="v pv" id="y_u35">—</div></div>
      <div class="kpi" data-market="y_o45"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 4.5 Amarillas</div><div class="v pv" id="y_o45">—</div></div>
      <div class="kpi" data-market="y_u45"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 4.5 Amarillas</div><div class="v pv" id="y_u45">—</div></div>
      <div class="kpi" data-market="r_o05"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 0.5 Rojas</div><div class="v pv" id="r_o05">—</div></div>
      <div class="kpi" data-market="r_u05"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 0.5 Rojas</div><div class="v pv" id="r_u05">—</div></div>
      <div class="kpi" data-market="r_o15"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 1.5 Rojas</div><div class="v pv" id="r_o15">—</div></div>
      <div class="kpi" data-market="r_u15"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 1.5 Rojas</div><div class="v pv" id="r_u15">—</div></div>
      <div class="kpi" data-market="r_any"><span class="badge-hot">🔥 Más probable</span><div class="t">¿Habrá roja? (Sí)</div><div class="v pv" id="r_any">—</div></div>
    </div>
  </div>

  <!-- TABLAS DE MARCADORES -->
  <div class="card">
    <h2>9) Probabilidades de marcadores FT (0–10)</h2>
    <div style="overflow:auto; max-height:280px">
      <table id="scoretab_ft">
        <thead><tr><th>Marcador</th><th>Prob.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>10) Probabilidades HT (0–5)</h2>
    <div style="overflow:auto; max-height:280px">
      <table id="scoretab_ht">
        <thead><tr><th>Marcador HT</th><th>Prob.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="wrap footer">Las tarjetas/córners se modelan con Poisson simple a partir de medias de liga y fuerzas. El “🔥 Más probable” marca las <b>top 3 probabilidades</b> globales (ajustable).</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const status=$('status'), leagueSel=$('league'), homeSel=$('home'), awaySel=$('away');
  const btnCalc=$('calc'), haInput=$('ha'), htFactorInput=$('htFactor'), haHTInput=$('ha_ht');
  const haCornersInput=$('ha_corners'), haCardsInput=$('ha_cards');
  const scoreFT = document.querySelector('#scoretab_ft tbody');
  const scoreHT = document.querySelector('#scoretab_ht tbody');

  // teams[league][team] = {gf,ga,matches, cf,ca, yF,yA, rF,rA}
  let teams = {};
  const TOP_N_HOT = 3; // <-- cambia cuántas "hot" globales quieres

  // ---------- Parseo robusto ----------
  function parsePotentialJSON(text){
    try{ const j=JSON.parse(text); return Array.isArray(j)? j:[j]; }
    catch(e){
      const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const arr=[]; for(const ln of lines){ try{arr.push(JSON.parse(ln));}catch(_){}} 
      if(arr.length) return arr;
      throw new Error("No se pudo leer el JSON. Verifica formato (array/objeto/NDJSON).");
    }
  }

  const keyMap = {
    league:/^(league|liga)$/i, team:/^(team|equipo|name|nombre)$/i,
    gf:/^(gf|goals\s*for|goles\s*a\s*favor|golesf|golesaf)$/i,
    ga:/^(ga|goals\s*against|goles\s*en\s*contra|golesc|golesec|golesen)$/i,
    matches:/^(matches|mp|pj|games|partidos)$/i,
    homeTeam:/^(hometeam|local|equipo\s*local)$/i, awayTeam:/^(awayteam|visitante|equipo\s*visitante)$/i,
    fthg:/^(fthg|home(goals)?|goles\s*local|gf\s*local)$/i, ftag:/^(ftag|away(goals)?|goles\s*visitante|gf\s*visitante)$/i,
    matchStr:/^(match|partido)$/i, resultFT:/^(result\s*ft|resultado\s*ft|ft\s*result|final\s*score)$/i,

    // Córners
    hc:/^(home\s*corners(?:\s*at\s*ft)?|corners?\s*local|saques\s*de\s*esquina\s*local)$/i,
    ac:/^(away\s*corners(?:\s*at\s*ft)?|corners?\s*visitante|saques\s*de\s*esquina\s*visitante)$/i,

    // Amarillas
    hy:/^(home\s*yellow(?:cards)?(?:\s*at\s*ft)?|amarillas\s*local|tarjetas\s*amarillas\s*local)$/i,
    ay:/^(away\s*yellow(?:cards)?(?:\s*at\s*ft)?|amarillas\s*visitante|tarjetas\s*amarillas\s*visitante)$/i,

    // Rojas
    hr:/^(home\s*red(?:cards)?(?:\s*at\s*ft)?|rojas\s*local|tarjetas\s*rojas\s*local)$/i,
    ar:/^(away\s*red(?:cards)?(?:\s*at\s*ft)?|rojas\s*visitante|tarjetas\s*rojas\s*visitante)$/i
  };
  function findKey(o, rx){ for(const k of Object.keys(o)){ if(rx.test(k)) return k; } return null; }
  const num = x => { const n=Number(x); return Number.isFinite(n)? n:0; };
  function ensureTeam(league, team){
    teams[league]=teams[league]||{};
    teams[league][team]=teams[league][team]||{gf:0,ga:0,matches:0, cf:0,ca:0, yF:0,yA:0, rF:0,rA:0};
    return teams[league][team];
  }
  function accumulateTeam(league, team, gf, ga, cf, ca, yF, yA, rF, rA){
    if(!league||!team) return;
    const t=ensureTeam(league, team);
    t.gf+=gf; t.ga+=ga; t.cf+=cf; t.ca+=ca; t.yF+=yF; t.yA+=yA; t.rF+=rF; t.rA+=rA; t.matches+=1;
  }
  function parseMatchTeams(s){
    const sep=/\s+(?:-|–|—|vs\.?|VS|:)\s+/i;
    const parts=String(s).split(sep).map(x=>x.trim()).filter(Boolean);
    return parts.length>=2? [parts[0],parts[1]]:[null,null];
  }
  function parseScoreFT(s){
    const m=String(s).match(/(\d+)\s*(?:-|–|—|:)\s*(\d+)/);
    return m? [num(m[1]), num(m[2])] : [null,null];
  }

  function buildFromArray(arr){
    teams={};
    for(const row of arr){
      if(!row||typeof row!=='object') continue;
      const kLeague=findKey(row,keyMap.league);
      const league=kLeague? String(row[kLeague]).trim() :"—";

      const kTeam=findKey(row,keyMap.team), kGF=findKey(row,keyMap.gf), kGA=findKey(row,keyMap.ga), kM=findKey(row,keyMap.matches);
      const kHT=findKey(row,keyMap.homeTeam), kAT=findKey(row,keyMap.awayTeam), kFTHG=findKey(row,keyMap.fthg), kFTAG=findKey(row,keyMap.ftag);
      const kMatch=findKey(row,keyMap.matchStr), kResFT=findKey(row,keyMap.resultFT);

      const kHC=findKey(row,keyMap.hc), kAC=findKey(row,keyMap.ac);
      const kHY=findKey(row,keyMap.hy), kAY=findKey(row,keyMap.ay);
      const kHR=findKey(row,keyMap.hr), kAR=findKey(row,keyMap.ar);

      if(kTeam && (kGF||kGA) && kM){
        const team=String(row[kTeam]).trim();
        const m=Math.max(1,num(row[kM]));
        const gf=num(row[kGF]), ga=num(row[kGA]);
        const cf=num(row[kHC]||0), ca=num(row[kAC]||0);
        const yF=num(row[kHY]||0), yA=num(row[kAY]||0);
        const rF=num(row[kHR]||0), rA=num(row[kAR]||0);
        const t=ensureTeam(league, team);
        t.gf+=gf; t.ga+=ga; t.cf+=cf; t.ca+=ca; t.yF+=yF; t.yA+=yA; t.rF+=rF; t.rA+=rA; t.matches+=m;
      } else if(kHT && kAT && (kFTHG||kFTAG)){
        const ht=String(row[kHT]).trim(), at=String(row[kAT]).trim();
        const gh=num(row[kFTHG]), ga=num(row[kFTAG]);
        const hc=num(row[kHC]||0), ac=num(row[kAC]||0);
        const hy=num(row[kHY]||0), ay=num(row[kAY]||0);
        const hr=num(row[kHR]||0), ar=num(row[kAR]||0);
        accumulateTeam(league, ht, gh, ga, hc, ac, hy, ay, hr, ar);
        accumulateTeam(league, at, ga, gh, ac, hc, ay, hy, ar, hr);
      } else if(kMatch && kResFT){
        const [ht,at]=parseMatchTeams(row[kMatch]);
        const [gh,ga]=parseScoreFT(row[kResFT]);
        if(ht&&at&&Number.isFinite(gh)&&Number.isFinite(ga)){
          const hc=num(row[kHC]||0), ac=num(row[kAC]||0);
          const hy=num(row[kHY]||0), ay=num(row[kAY]||0);
          const hr=num(row[kHR]||0), ar=num(row[kAR]||0);
          accumulateTeam(league, ht, gh, ga, hc, ac, hy, ay, hr, ar);
          accumulateTeam(league, at, ga, gh, ac, hc, ay, hy, ar, hr);
        }
      }
    }
  }

  // ---------- UI ----------
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function fillSelectors(){
    const leagues=Object.keys(teams).sort((a,b)=>a.localeCompare(b));
    leagueSel.innerHTML='<option value="">— Selecciona liga —</option>'+leagues.map(l=>`<option>${escapeHtml(l)}</option>`).join('');
    leagueSel.disabled=leagues.length===0;
    function setTeams(lig){
      const list=lig&&teams[lig]? Object.keys(teams[lig]).sort((a,b)=>a.localeCompare(b)):[];
      const opts='<option value="">— Equipo —</option>'+list.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
      homeSel.innerHTML=opts; awaySel.innerHTML=opts;
      homeSel.disabled=!list.length; awaySel.disabled=!list.length; btnCalc.disabled=!list.length;
    }
    setTeams(leagues[0]||"");
    leagueSel.addEventListener('change',()=>setTeams(leagueSel.value));
  }

  // ---------- Poisson ----------
  const factMemo=[1]; function fact(n){ for(let i=factMemo.length;i<=n;i++) factMemo[i]=factMemo[i-1]*i; return factMemo[n]; }
  const poisPMF=(k,λ)=> Math.exp(-λ)*Math.pow(λ,k)/fact(k);
  function poisCDF(k,λ){ let s=0; for(let i=0;i<=k;i++) s+=poisPMF(i,λ); return s; }
  const clamp=(x,min,max)=> Math.max(min,Math.min(max,x));

  // Formateo y “hot picks”
  function setProb(id, p){
    const el = $(id);
    if(!el) return;
    el.textContent = (p*100).toFixed(1)+'%';
    const kpi = el.closest('.kpi');
    if(kpi){ kpi.dataset.prob = String(p); } // solo los que llamemos con setProb entran a la competencia "hot"
  }
  function clearHot(){
    document.querySelectorAll('.kpi').forEach(k=>{ k.classList.remove('hot'); });
  }
  function markHotTopN(n){
    // Toma todos los .kpi con data-prob, elige top N y marca .hot
    const cards = Array.from(document.querySelectorAll('.kpi[data-prob]'))
      .map(k=>({k, p: Number(k.dataset.prob||'0')}))
      .filter(x=>Number.isFinite(x.p));
    cards.sort((a,b)=>b.p-a.p);
    cards.slice(0, Math.max(0,n)).forEach(x=> x.k.classList.add('hot'));
  }

  function compute(){
    status && (status.textContent='');
    clearHot();

    const lig=leagueSel.value, home=homeSel.value, away=awaySel.value;
    const HA=clamp(Number(haInput.value)||1.00,0.5,1.6);
    const factorHT=clamp(Number(htFactorInput.value)||0.45,0.2,0.8);
    const HA_HT=clamp(Number(haHTInput.value)||1.00,0.5,1.6);
    const HA_COR=clamp(Number(haCornersInput.value)||1.05,0.8,1.4);
    const HA_CAR=clamp(Number(haCardsInput.value)||1.00,0.8,1.4);

    if(!lig||!teams[lig]){ status && (status.textContent='Elige una liga.'); return; }
    if(!home||!away||home===away){ status && (status.textContent='Elige dos equipos distintos.'); return; }

    const tH=teams[lig][home], tA=teams[lig][away];
    if(!tH||!tA){ status && (status.textContent='Faltan datos para esos equipos.'); return; }

    // μ liga GOLES (goles por equipo por partido)
    let sumGF=0,sumM=0; for(const t of Object.values(teams[lig])){ sumGF+=t.gf; sumM+=t.matches; }
    const mu = sumM>0 ? (sumGF/sumM) : 1.2;

    // μ liga CÓRNERS (córners por equipo por partido)
    let sumCF=0; for(const t of Object.values(teams[lig])) sumCF+=t.cf;
    const muC = sumM>0 ? (sumCF/sumM) : 4.5;

    // μ liga AMARILLAS
    let sumY=0; for(const t of Object.values(teams[lig])) sumY+=t.yF;
    const muY = sumM>0 ? (sumY/sumM) : 2.2;

    // μ liga ROJAS
    let sumR=0; for(const t of Object.values(teams[lig])) sumR+=t.rF;
    const muR = sumM>0 ? (sumR/sumM) : 0.15;

    // Promedios por eq/part
    const h_gfpm=tH.gf/Math.max(1,tH.matches), h_gapm=tH.ga/Math.max(1,tH.matches);
    const a_gfpm=tA.gf/Math.max(1,tA.matches), a_gapm=tA.ga/Math.max(1,tA.matches);

    const h_cfpm=tH.cf/Math.max(1,tH.matches), h_capm=tH.ca/Math.max(1,tH.matches);
    const a_cfpm=tA.cf/Math.max(1,tA.matches), a_capm=tA.ca/Math.max(1,tA.matches);

    const h_ypm=tH.yF/Math.max(1,tH.matches), h_yapm=tH.yA/Math.max(1,tH.matches);
    const a_ypm=tA.yF/Math.max(1,tA.matches), a_yapm=tA.yA/Math.max(1,tA.matches);

    const h_rpm=tH.rF/Math.max(1,tH.matches), h_rapm=tH.rA/Math.max(1,tH.matches);
    const a_rpm=tA.rF/Math.max(1,tA.matches), a_rapm=tA.rA/Math.max(1,tA.matches);

    // Fuerzas GOLES
    const attH=h_gfpm/mu, defH=h_gapm/mu, attA=a_gfpm/mu, defA=a_gapm/mu;

    // Lambdas GOLES FT
    const λH = attH*defA*mu*HA;
    const λA = attA*defH*mu;

    // KPIs GOLES
    $('k_mu').textContent=mu.toFixed(3);
    $('k_att_h').textContent=attH.toFixed(3);
    $('k_def_h').textContent=defH.toFixed(3);
    $('k_att_a').textContent=attA.toFixed(3);
    $('k_def_a').textContent=defA.toFixed(3);
    $('k_lh').textContent=λH.toFixed(3);
    $('k_la').textContent=λA.toFixed(3);

    // ---- FT probabilidades 1X2 / O/U / BTTS ----
    const MAXG_FT=10;
    const pH = Array.from({length:MAXG_FT+1},(_,k)=>poisPMF(k,λH));
    const pA = Array.from({length:MAXG_FT+1},(_,k)=>poisPMF(k,λA));
    let p1=0,px=0,p2=0,pUnder25=0; let rows=[];
    for(let h=0; h<=MAXG_FT; h++){
      for(let a=0; a<=MAXG_FT; a++){
        const p=pH[h]*pA[a];
        rows.push({score:`${h}-${a}`,p});
        if(h>a) p1+=p; else if(h===a) px+=p; else p2+=p;
        if(h+a<=2) pUnder25+=p;
      }
    }
    const pOver25=1-pUnder25;
    const btts = 1 - pH[0] - pA[0] + pH[0]*pA[0];

    // 1X2 FT en 3 columnas
    setProb('ft_1', p1);
    setProb('ft_x', px);
    setProb('ft_2', p2);

    setProb('m_btts', btts);
    setProb('m_o25', pOver25);
    setProb('m_u25', pUnder25);

    rows.sort((a,b)=>b.p-a.p);
    scoreFT.innerHTML=rows.slice(0,50).map(x=>`<tr><td><span class="pill">${x.score}</span></td><td>${(x.p*100).toFixed(3)}%</td></tr>`).join('');

    // ---- HT goles ----
    const λH_HT = λH * factorHT * (HA_HT/HA);
    const λA_HT = λA * factorHT;
    const MAXG_HT=5;
    const pH_ht = Array.from({length:MAXG_HT+1},(_,k)=>poisPMF(k,λH_HT));
    const pA_ht = Array.from({length:MAXG_HT+1},(_,k)=>poisPMF(k,λA_HT));
    let ht1=0,htx=0,ht2=0, u05=0, u15=0; let rowsHT=[];
    for(let h=0; h<=MAXG_HT; h++){
      for(let a=0; a<=MAXG_HT; a++){
        const p=pH_ht[h]*pA_ht[a];
        rowsHT.push({score:`${h}-${a}`,p});
        if(h>a) ht1+=p; else if(h===a) htx+=p; else ht2+=p;
        if(h+a<=0) u05+=p;
        if(h+a<=1) u15+=p;
      }
    }
    const o05=1-u05, o15=1-u15;
    const btts_ht = 1 - pH_ht[0] - pA_ht[0] + pH_ht[0]*pA_ht[0];

    // 1X2 HT en 3 columnas
    setProb('ht_1', ht1);
    setProb('ht_x', htx);
    setProb('ht_2', ht2);

    setProb('ht_btts', btts_ht);
    setProb('ht_o05', o05);
    setProb('ht_u05', u05);
    setProb('ht_o15', o15);
    setProb('ht_u15', u15);

    rowsHT.sort((a,b)=>b.p-a.p);
    scoreHT.innerHTML=rowsHT.slice(0,40).map(x=>`<tr><td><span class="pill">${x.score}</span></td><td>${(x.p*100).toFixed(3)}%</td></tr>`).join('');

    // ======= CÓRNERS =======
    const attC_H = (tH.cf/Math.max(1,tH.matches)) / Math.max(muC, 1e-9);
    const defC_A = (tA.ca/Math.max(1,tA.matches)) / Math.max(muC, 1e-9);
    const attC_A = (tA.cf/Math.max(1,tA.matches)) / Math.max(muC, 1e-9);
    const defC_H = (tH.ca/Math.max(1,tH.matches)) / Math.max(muC, 1e-9);

    const λC_H = attC_H * defC_A * muC * HA_COR;
    const λC_A = attC_A * defC_H * muC;
    const λC_T = λC_H + λC_A;

    $('c_mu').textContent=muC.toFixed(3);
    $('c_lh').textContent=λC_H.toFixed(3);
    $('c_la').textContent=λC_A.toFixed(3);
    $('c_tot').textContent=λC_T.toFixed(3);

    setProb('c_o85', 1 - poisCDF(8, λC_T));
    setProb('c_u85',      poisCDF(8, λC_T));
    setProb('c_o95', 1 - poisCDF(9, λC_T));
    setProb('c_u95',      poisCDF(9, λC_T));
    setProb('c_o105',1 - poisCDF(10,λC_T));
    setProb('c_u105',     poisCDF(10,λC_T));

    // ======= TARJETAS =======
    // Amarillas
    const attY_H = (tH.yF/Math.max(1,tH.matches)) / Math.max(muY,1e-9);
    const defY_A = (tA.yA/Math.max(1,tA.matches)) / Math.max(muY,1e-9);
    const attY_A = (tA.yF/Math.max(1,tA.matches)) / Math.max(muY,1e-9);
    const defY_H = (tH.yA/Math.max(1,tH.matches)) / Math.max(muY,1e-9);

    const λY_H = attY_H * defY_A * muY * HA_CAR;
    const λY_A = attY_A * defY_H * muY;
    const λY_T = λY_H + λY_A;

    $('y_mu').textContent=muY.toFixed(3);
    $('y_lh').textContent=λY_H.toFixed(3);
    $('y_la').textContent=λY_A.toFixed(3);
    $('y_tot').textContent=λY_T.toFixed(3);

    setProb('y_o35', 1 - poisCDF(3, λY_T));
    setProb('y_u35',      poisCDF(3, λY_T));
    setProb('y_o45', 1 - poisCDF(4, λY_T));
    setProb('y_u45',      poisCDF(4, λY_T));

    // Rojas
    const attR_H = (tH.rF/Math.max(1,tH.matches)) / Math.max(muR,1e-9);
    const defR_A = (tA.rA/Math.max(1,tA.matches)) / Math.max(muR,1e-9);
    const attR_A = (tA.rF/Math.max(1,tA.matches)) / Math.max(muR,1e-9);
    const defR_H = (tH.rA/Math.max(1,tH.matches)) / Math.max(muR,1e-9);

    const λR_H = attR_H * defR_A * muR * HA_CAR;
    const λR_A = attR_A * defR_H * muR;
    const λR_T = λR_H + λR_A;

    $('r_mu').textContent=muR.toFixed(3);
    $('r_lh').textContent=λR_H.toFixed(3);
    $('r_la').textContent=λR_A.toFixed(3);
    $('r_tot').textContent=λR_T.toFixed(3);

    const pR_o05 = 1 - poisCDF(0, λR_T);
    const pR_u05 =     poisCDF(0, λR_T);
    const pR_o15 = 1 - poisCDF(1, λR_T);
    const pR_u15 =     poisCDF(1, λR_T);

    setProb('r_o05', pR_o05);
    setProb('r_u05', pR_u05);
    setProb('r_o15', pR_o15);
    setProb('r_u15', pR_u15);
    setProb('r_any', pR_o05); // ¿Habrá roja? (Sí)

    // ---- Marcar TOP-N "hot" ----
    markHotTopN(TOP_N_HOT);
  }

  // Eventos
  document.getElementById('calc').addEventListener('click', compute);

  document.getElementById('file').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text=await f.text();
      const arr=parsePotentialJSON(text);
      if(!arr.length) throw new Error("El archivo está vacío.");
      buildFromArray(arr);
      fillSelectors();
      status && (status.textContent='Datos cargados ✔ Elige liga y equipos.');
    }catch(err){
      leagueSel.disabled=true; homeSel.disabled=true; awaySel.disabled=true; btnCalc.disabled=true;
      leagueSel.innerHTML=''; homeSel.innerHTML=''; awaySel.innerHTML='';
      status && (status.textContent=err.message||'Error al leer el JSON.');
    }
  });
})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Poisson Pro V8 - Share Analysis</title>
    <style>
        :root { --primary: #001e54; --accent: #2563eb; --whatsapp: #25d366; --telegram: #0088cc; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        textarea { width: 100%; height: 160px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: monospace; font-size: 11px; box-sizing: border-box; }
        
        .main-btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 20px 0; }
        
        .share-container { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; display: none; }
        .share-btn { padding: 12px 20px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; text-decoration: none; font-size: 14px; }
        .btn-ws { background: var(--whatsapp); }
        .btn-tg { background: var(--telegram); }

        #resultsUI { display: none; }
        .match-header { text-align: center; margin-bottom: 25px; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; }
        .special-market { background: #eff6ff; border: 2px solid #bfdbfe; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; }
        .prob-large { font-size: 38px; font-weight: 900; color: var(--accent); }
        
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .card-header { background: var(--primary); color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 13px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        .val-win { color: #059669; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="grid-inputs">
        <textarea id="hInput" placeholder="Pega datos Local (con 'Flag')..."></textarea>
        <textarea id="aInput" placeholder="Pega datos Visitante (con 'Flag')..."></textarea>
    </div>

    <button class="main-btn" onclick="executeAnalysis()">CALCULAR Y GENERAR REPORTE</button>

    <div id="resultsUI">
        <div class="share-container" id="shareBtns">
            <button class="share-btn btn-ws" onclick="share('whatsapp')">Compartir en WhatsApp</button>
            <button class="share-btn btn-tg" onclick="share('telegram')">Compartir en Telegram</button>
        </div>

        <div class="match-header">
            <h2 id="matchTitle">Partido</h2>
            <div style="color: #64748b; font-size: 12px; margin-top:5px;">Modelo Dixon-Coles Optimizado</div>
        </div>

        <div class="special-market">
            <h3 style="margin:0;">GOL ANTES DEL MINUTO 30</h3>
            <div id="p30" class="prob-large">0%</div>
            <div id="c30">Cuota Justa: 0.00</div>
        </div>

        <div class="tables-grid">
            <div class="card"><div class="card-header">FT / HT / 2ndH</div><table id="mainTab"></table></div>
            <div class="card"><div class="card-header">TRAMOS ESPEC√çFICOS</div><table id="rngTab"></table></div>
        </div>
    </div>
</div>

<script>
const fact = n => (n <= 1) ? 1 : n * fact(n - 1);
const poisson = (k, l) => (Math.pow(l, k) * Math.exp(-l)) / fact(k);
let reportData = {};

function getDixonColesAdj(x, y, lX, lY) {
    const rho = -0.15;
    if (x === 0 && y === 0) return 1 - (lX * lY * rho);
    if (x === 0 && y === 1) return 1 + (lX * rho);
    if (x === 1 && y === 0) return 1 + (lY * rho);
    if (x === 1 && y === 1) return 1 - rho;
    return 1;
}

function extractName(text, fallback) {
    const match = text.match(/Flag\s+([^\n\r]+)/i);
    return match ? match[1].split('-')[0].split('Stats')[0].trim() : fallback;
}

function parseInput(text, fallback) {
    const name = extractName(text, fallback);
    const gp = parseInt(text.match(/GP\s+(\d+)/)?.[1] || 10);
    const intervals = ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"];
    let tramos = [];
    intervals.forEach(r => {
        const m = text.match(new RegExp(r + "\\s+GF\\s+(\\d+)\\s+GA\\s+(\\d+)"));
        tramos.push({ gf: m ? (parseInt(m[1])/gp) : 0.05, ga: m ? (parseInt(m[2])/gp) : 0.05 });
    });
    return { name, tramos };
}

function executeAnalysis() {
    const h = parseInput(document.getElementById('hInput').value, "Local");
    const a = parseInput(document.getElementById('aInput').value, "Visitante");
    const title = `${h.name} vs ${a.name}`;
    document.getElementById('matchTitle').innerText = title;

    let lH = [], lA = [];
    for(let i=0; i<6; i++) {
        lH.push((h.tramos[i].gf + a.tramos[i].ga) / 2);
        lA.push((a.tramos[i].gf + h.tramos[i].ga) / 2);
    }

    const calcProb = (lhArr, laArr, line) => {
        const sH = lhArr.reduce((a,b)=>a+b,0), sA = laArr.reduce((a,b)=>a+b,0);
        let pU = 0;
        for(let x=0; x<=8; x++) for(let y=0; y<=8; y++) 
            if(x+y < line) pU += poisson(x,sH)*poisson(y,sA)*getDixonColesAdj(x,y,sH,sA);
        return (1-pU)*100;
    };

    // C√°lculos para el reporte
    const pFT25 = calcProb(lH, lA, 2.5);
    const pHT05 = calcProb(lH.slice(0,3), lA.slice(0,3), 0.5);
    const pSH05 = calcProb(lH.slice(3,6), lA.slice(3,6), 0.5);
    const p30 = calcProb(lH.slice(0,2), lA.slice(0,2), 0.5);
    const p015 = calcProb([lH[0]], [lA[0]], 0.5);
    const p1630 = calcProb([lH[1]], [lA[1]], 0.5);

    // Guardar para compartir
    reportData = { title, pFT25, pHT05, pSH05, p30, p015, p1630 };

    // UI
    document.getElementById('p30').innerText = p30.toFixed(2) + "%";
    document.getElementById('c30').innerHTML = `Cuota Justa: <b>${(100/p30).toFixed(2)}</b>`;
    
    document.getElementById('mainTab').innerHTML = `
        <tr><td>Over 2.5 FT</td><td class="val-win">${pFT25.toFixed(1)}%</td></tr>
        <tr><td>Over 0.5 HT</td><td class="val-win">${pHT05.toFixed(1)}%</td></tr>
        <tr><td>Over 0.5 2ndH</td><td class="val-win">${pSH05.toFixed(1)}%</td></tr>
    `;
    document.getElementById('rngTab').innerHTML = `
        <tr><td>Tramo 0-15'</td><td class="val-win">${p015.toFixed(1)}%</td></tr>
        <tr><td>Tramo 16-30'</td><td class="val-win">${p1630.toFixed(1)}%</td></tr>
    `;

    document.getElementById('resultsUI').style.display = 'block';
    document.getElementById('shareBtns').style.display = 'flex';
}

function share(platform) {
    const msg = `üìä *AN√ÅLISIS POISSON PRO*\nüìç *${reportData.title}*\n\n` +
                `‚öΩ Over 2.5 FT: ${reportData.pFT25.toFixed(1)}%\n` +
                `‚è± Over 0.5 HT: ${reportData.pHT05.toFixed(1)}%\n` +
                `üîÑ Over 0.5 2ndH: ${reportData.pSH05.toFixed(1)}%\n\n` +
                `üî• *ESPECIALES:*\n` +
                `üéØ Gol antes min 30: ${reportData.p30.toFixed(1)}%\n` +
                `üïí Tramo 0-15': ${reportData.p015.toFixed(1)}%\n` +
                `üïí Tramo 16-30': ${reportData.p1630.toFixed(1)}%`;

    const url = platform === 'whatsapp' 
        ? `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`
        : `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(msg)}`;
    
    window.open(url, '_blank');
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Poisson — OU + BTTS</title>
<style>
  :root{
    --bg:#0e1117; --panel:#1a1f29; --text:#eaeef5; --muted:#8a93a5;
    --accent:#4da6ff; --accent2:#5dd4a4; --border:#2a3140;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
  header{padding:20px;text-align:center;border-bottom:1px solid var(--border)}
  h1{font-size:22px;font-weight:700}
  .wrap{max-width:800px;margin:40px auto;padding:0 20px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:25px;box-shadow:0 2px 6px rgba(0,0,0,0.4)}
  h2{font-size:18px;margin-bottom:12px;color:var(--accent)}
  label{font-size:14px;color:var(--muted);margin-bottom:6px;display:block}
  input{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:#12151c;color:var(--text);margin-bottom:14px;font-size:14px}
  .btn{display:block;width:100%;padding:14px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-weight:700;font-size:15px;cursor:pointer;margin-top:4px;transition:background 0.2s}
  .btn:hover{background:#3399ff}
  .kpi{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
  .pill{padding:6px 12px;border-radius:999px;background:#12151c;border:1px solid var(--border);font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{padding:10px;text-align:right;border-bottom:1px solid var(--border)}
  th:first-child,td:first-child{text-align:left}
  th{color:var(--muted);font-weight:500;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
  td{font-size:14px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<header><h1>Calculadora Poisson — Over/Under + BTTS</h1></header>

<div class="wrap">
  <div class="card">
    <h2>Entradas</h2>
    <label>GF Local (λ<sub>H</sub>)</label>
    <input id="gfH" type="number" step="0.01" min="0" value="1.40">
    <label>GF Visitante (λ<sub>A</sub>)</label>
    <input id="gfA" type="number" step="0.01" min="0" value="1.60">
    <label>Línea OU (ej. 2.5, 3.0, 2.25, 2.75)</label>
    <input id="line" type="number" step="0.25" min="0" value="2.5">
    <button class="btn" id="calc">Calcular</button>
    <div class="kpi" id="kpi"></div>
  </div>

  <div class="card">
    <h2>Over/Under</h2>
    <table id="tblOU">
      <thead><tr><th>Resultado</th><th class="mono">Over</th><th class="mono">Under</th></tr></thead>
      <tbody></tbody>
    </table>
    <table id="tblOU2">
      <thead><tr><th>Métrica</th><th class="mono">Over</th><th class="mono">Under</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>BTTS</h2>
    <table id="tblBTTS">
      <thead><tr><th>BTTS</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const fact=[1];
  function factorial(n){for(let i=fact.length;i<=n;i++)fact[i]=fact[i-1]*i;return fact[n]}
  function logFactorial(n){if(n<100)return Math.log(factorial(n));const x=n;return x*Math.log(x)-x+0.5*Math.log(2*Math.PI*x)}
  function poisPMF(k,lambda){if(lambda<=0)return (k===0)?1:0;if(k<100){return Math.exp(-lambda)*Math.pow(lambda,k)/factorial(k)}return Math.exp(-lambda + k*Math.log(lambda) - logFactorial(k))}
  function poisCDF(k,lambda){let s=0;for(let i=0;i<=k;i++)s+=poisPMF(i,lambda);return s}
  function toOdds(p){return (p<=0)?Infinity:(1/p)}
  function fmtP(p){return (100*p).toFixed(2)+'%'}
  function fmtO(o){return (o===Infinity)?'—':o.toFixed(2)}
  function clamp(x,lo,hi){return Math.max(lo,Math.min(hi,x))}
  // --- OU components ---
  function compOverOutcome(lambdaT,Lc){
    const k=Math.floor(Lc+1e-9);
    const isHalf=Math.abs(Lc-(k+0.5))<1e-9;
    const Fk=poisCDF(k,lambdaT);
    const Fk_1=poisCDF(k-1,lambdaT);
    const pk=Fk-Fk_1;
    if(isHalf){return {win:1-Fk,halfwin:0,push:0,halfloss:0,loss:Fk};}
    else{return {win:1-Fk,halfwin:0,push:pk,halfloss:0,loss:Fk_1};}
  }
  function asianOver(lambdaT,L){
    const k=Math.floor(L);
    const frac=+(L-k).toFixed(2);
    if(frac===0||frac===0.5)return compOverOutcome(lambdaT,L);
    if(frac===0.25){const a=compOverOutcome(lambdaT,k);const b=compOverOutcome(lambdaT,k+0.5);return {win:0.5*(a.win+b.win),halfwin:0,push:0.5*(a.push+b.push),halfloss:0,loss:0.5*(a.loss+b.loss)}}
    if(frac===0.75){const a=compOverOutcome(lambdaT,k+0.5);const b=compOverOutcome(lambdaT,k+1.0);return {win:0.5*(a.win+b.win),halfwin:0,push:0.5*(a.push+b.push),halfloss:0,loss:0.5*(a.loss+b.loss)}}
    const nearest=Math.abs(frac-0.5)<Math.abs(frac-0)?(k+0.5):k;return compOverOutcome(lambdaT,nearest);
  }
  function asianUnder(lambdaT,L){const o=asianOver(lambdaT,L);return {win:o.loss,halfwin:o.halfloss,push:o.push,halfloss:o.halfwin,loss:o.win}}

  function calc(){
    const lamH=Math.max(0,+$('#gfH').value||0);
    const lamA=Math.max(0,+$('#gfA').value||0);
    const L=clamp(+$('#line').value||0,0,20);
    const lamT=lamH+lamA;
    const over=asianOver(lamT,L), under=asianUnder(lamT,L);
    const pCashOver=over.win+0.5*over.halfwin;
    const pCashUnder=under.win+0.5*under.halfwin;
    const pBTTS=1-Math.exp(-lamH)-Math.exp(-lamA)+Math.exp(-(lamT)), pNo=1-pBTTS;
    $('#kpi').innerHTML=`
      <span class="pill">λ<sub>H</sub>=<b class="mono">${lamH.toFixed(2)}</b></span>
      <span class="pill">λ<sub>A</sub>=<b class="mono">${lamA.toFixed(2)}</b></span>
      <span class="pill">λ<sub>T</sub>=<b class="mono">${lamT.toFixed(2)}</b></span>
      <span class="pill">Línea=${L.toFixed(2)}</span>`;
    $('#tblOU tbody').innerHTML=`
      <tr><td>Win</td><td class="mono">${fmtP(over.win)}</td><td class="mono">${fmtP(under.win)}</td></tr>
      <tr><td>Push</td><td class="mono">${fmtP(over.push)}</td><td class="mono">${fmtP(under.push)}</td></tr>
      <tr><td>Loss</td><td class="mono">${fmtP(over.loss)}</td><td class="mono">${fmtP(under.loss)}</td></tr>`;
    $('#tblOU2 tbody').innerHTML=`
      <tr><td>Prob. de cobrar</td><td class="mono">${fmtP(pCashOver)}</td><td class="mono">${fmtP(pCashUnder)}</td></tr>
      <tr><td>Cuota justa aprox.</td><td class="mono">${fmtO(1/Math.max(1e-12,pCashOver))}</td><td class="mono">${fmtO(1/Math.max(1e-12,pCashUnder))}</td></tr>`;
    $('#tblBTTS tbody').innerHTML=`
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTS)}</td><td class="mono">${fmtO(toOdds(pBTTS))}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pNo)}</td><td class="mono">${fmtO(toOdds(pNo))}</td></tr>`;
  }
  $('#calc').addEventListener('click',calc); calc();
})();
</script>
</body>
</html>
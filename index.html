<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Betting Intelligence Pro - Full Memory Edition</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; font-size: 14px; line-height: 1.4; }
        .container { max-width: 1500px; margin: auto; }
        textarea { width: 100%; height: 80px; background: #334155; color: white; border: 1px solid #475569; border-radius: 12px; padding: 12px; margin-bottom: 10px; font-family: monospace; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.2s; margin-bottom: 10px; }
        .btn-gold { background: var(--gold); color: #0f172a; font-size: 16px; padding: 18px; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }
        .btn-mini { padding: 4px 10px; width: auto; font-size: 10px; background: #475569; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .btn-save { background: var(--success); margin-top: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        .league-section { background: var(--card); border-radius: 12px; padding: 20px; margin-top: 25px; border-left: 5px solid var(--accent); }
        .row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #2d3748; align-items: center; }
        .roi-tag { font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .pos { color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .neg { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .premium-team { border: 1px solid var(--gold) !important; background: rgba(251, 191, 36, 0.1) !important; border-radius: 6px; padding: 4px; }
        .highlight-box { background: #1e3a8a; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; border: 2px solid var(--gold); }
        .range-badge { font-size: 10px; color: #fff; background: #334155; padding: 2px 6px; border-radius: 4px; border: 1px solid #475569; display: inline-block; margin-top: 4px; }
        .scroll-list { max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #2d3748; }
        .chk-row { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; flex: 1; }
        .alert-box { padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--gold); background: rgba(251, 191, 36, 0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        table th { text-align: left; color: var(--gold); padding: 8px; border-bottom: 2px solid var(--gold); }
        table td { padding: 8px; border-bottom: 1px solid #475569; }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="margin-bottom: 20px;">
        <h2>üöÄ Betting Master Hub - Pro Persistent Ranges</h2>
        <textarea id="dataInput" placeholder="Pega aqu√≠ tus datos hist√≥ricos..."></textarea>
        <button class="btn" onclick="initialProcess()">1. PROCESAR DATOS HIST√ìRICOS</button>
    </div>

    <div id="resultsMain" style="display:none;">
        <div id="alertContainer"></div>

        <div class="highlight-box">
            <h1 id="simRoiTotal" style="margin:0;">ROI: 0%</h1>
            <h2 id="simUnitsTotal" style="margin:5px 0 0 0; color: var(--success);">+0.00 UDS</h2>
            <p id="simStatsTotal" style="margin:5px 0 0 0; opacity: 0.8; font-size: 12px;"></p>
            <button class="btn btn-save" onclick="saveTopStrategy()">üíæ GUARDAR ESTRATEGIA COMPLETA (ROI > 20%)</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>‚öñÔ∏è Filtro de Cuotas</h3>
                <div class="ctrl-group">
                    <button class="btn-mini" onclick="toggleChecks('.rng-chk', true)">Todas</button>
                    <button class="btn-mini" onclick="toggleChecks('.rng-chk', false)">Ninguna</button>
                </div>
                <div id="oddsFilterList" class="scroll-list"></div>
            </div>

            <div class="card">
                <h3>‚öΩ Filtro de Equipos</h3>
                <div class="ctrl-group">
                    <button class="btn-mini" onclick="toggleChecks('.team-chk', true)">Todos</button>
                    <button class="btn-mini" onclick="toggleChecks('.team-chk', false)">Ninguno</button>
                </div>
                <div id="teamsFilterList" class="scroll-list"></div>
            </div>

            <div class="card">
                <h3>üõ°Ô∏è Riesgo & Bank</h3>
                <div class="row"><span>Peor Racha:</span> <span id="maxLoss" class="neg roi-tag">0</span></div>
                <div class="row"><span>Bankroll:</span> <span id="bankReq" style="color:var(--gold); font-weight:bold;">0 u.</span></div>
                <div class="row"><span>Stake Sug:</span> <span id="stakeSugg">0%</span></div>
                <button class="btn btn-gold" style="margin-top:15px;" onclick="updateAllDashboard()">RE-CALCULAR</button>
            </div>
        </div>

        <div id="leagueBreakdown"></div>

        <div class="card" style="margin-top:30px; border: 1px solid var(--success);">
            <h3>üìÇ Estrategia en Memoria (Snapshot con Rangos)</h3>
            <button class="btn-mini" style="background:var(--danger);" onclick="clearSaved()">Limpiar Memoria</button>
            <div id="savedContainer"></div>
        </div>
    </div>
</div>

<script>
let allMatches = []; 
let currentLeaguesData = {};

function initialProcess() {
    const input = document.getElementById('dataInput').value.trim();
    if (!input) return;
    const lines = input.split('\n');
    const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
    const find = (keys) => headers.findIndex(h => keys.some(k => h.includes(k)));
    const idx = { league: find(['league', 'liga']), date: find(['date', 'fecha']), match: find(['match']), result: headers.lastIndexOf('result'), odd: find(['odd']) };
    allMatches = [];
    let initialOdds = {};
    let initialTeams = {};

    lines.slice(1).forEach(line => {
        const col = line.split('\t').map(c => c.trim());
        if (col.length < 5) return;
        const isWin = col.some((c, i) => i >= idx.result && c.toLowerCase() === 'winning');
        const odd = parseFloat(col[idx.odd]?.replace(',','.')) || 0;
        const league = col[idx.league] || "Otras";
        const dateStr = col[idx.date] || "";
        const [hT, aT] = col[idx.match] ? col[idx.match].split(' - ') : ['?', '?'];
        if(odd > 0) {
            const floor = (Math.floor(odd * 10) / 10).toFixed(2);
            const range = `${floor} - ${(parseFloat(floor)+0.10).toFixed(2)}`;
            allMatches.push({ odd, isWin, league, range, dateStr, teams: [hT, aT] });
            if(!initialOdds[range]) initialOdds[range] = {s:0, r:0};
            initialOdds[range].s++; initialOdds[range].r += (isWin?odd:0);
            [hT, aT].forEach(t => {
                if(!t || t==='?') return;
                if(!initialTeams[t]) initialTeams[t] = {s:0, r:0, w:0};
                initialTeams[t].s++; initialTeams[t].r += (isWin?odd:0);
                if(isWin) initialTeams[t].w++;
            });
        }
    });
    renderOddsFilters(initialOdds);
    renderTeamsFilters(initialTeams);
    updateAllDashboard();
    loadSavedData();
    document.getElementById('resultsMain').style.display = 'block';
}

function renderOddsFilters(odds) {
    const container = document.getElementById('oddsFilterList');
    container.innerHTML = Object.entries(odds).sort((a,b) => parseFloat(a[0]) - parseFloat(b[0])).map(([range, d]) => {
        const roi = ((d.r/d.s - 1)*100).toFixed(1);
        return `<div class="row"><label class="chk-row"><input type="checkbox" checked class="rng-chk" value="${range}"><span>@ ${range}</span></label><span class="roi-tag ${roi>=0?'pos':'neg'}">${roi}%</span></div>`;
    }).join('');
}

function renderTeamsFilters(teams) {
    const container = document.getElementById('teamsFilterList');
    container.innerHTML = Object.entries(teams).sort((a,b) => b[1].s - a[1].s).map(([name, d]) => {
        const roi = ((d.r/d.s - 1)*100).toFixed(0);
        return `<div class="row"><label class="chk-row"><input type="checkbox" checked class="team-chk" value="${name}"><span>${name}</span></label><span class="roi-tag ${roi>=0?'pos':'neg'}">${roi}%</span></div>`;
    }).join('');
}

function toggleChecks(selector, val) { document.querySelectorAll(selector).forEach(c => c.checked = val); }

function updateAllDashboard() {
    const activeRanges = Array.from(document.querySelectorAll('.rng-chk:checked')).map(c => c.value);
    const activeTeams = Array.from(document.querySelectorAll('.team-chk:checked')).map(c => c.value);
    const filtered = allMatches.filter(m => activeRanges.includes(m.range) && m.teams.some(t => activeTeams.includes(t)));
    let stats = { s:0, r:0, w:0, maxLoss:0, currLoss:0, leagues:{} };
    filtered.forEach(m => {
        stats.s++;
        if(m.isWin) { stats.r += m.odd; stats.w++; stats.maxLoss = Math.max(stats.maxLoss, stats.currLoss); stats.currLoss = 0; } else { stats.currLoss++; }
        if(!stats.leagues[m.league]) stats.leagues[m.league] = { s:0, r:0, teams:{} };
        let L = stats.leagues[m.league]; L.s++; L.r += (m.isWin ? m.odd : 0);
        m.teams.forEach(t => {
            if(!activeTeams.includes(t)) return;
            if(!L.teams[t]) L.teams[t] = {s:0, r:0, w:0, maxO:0}; 
            L.teams[t].s++; L.teams[t].r += (m.isWin ? m.odd : 0);
            if(m.isWin) { L.teams[t].w++; L.teams[t].maxO = Math.max(L.teams[t].maxO, m.odd); }
        });
    });
    stats.maxLoss = Math.max(stats.maxLoss, stats.currLoss);
    currentLeaguesData = stats.leagues;
    renderUI(stats);
    checkAlerts();
}

function renderUI(s) {
    const totalProfit = (s.r - s.s).toFixed(2);
    const totalRoi = s.s > 0 ? ((s.r/s.s - 1)*100).toFixed(2) : 0;
    document.getElementById('simRoiTotal').innerText = `ROI: ${totalRoi}%`;
    document.getElementById('simUnitsTotal').innerText = `${totalProfit >= 0 ? '+' : ''}${totalProfit} UNIDADES`;
    document.getElementById('simStatsTotal').innerText = `${s.s} Partidos analizados`;
    document.getElementById('maxLoss').innerText = s.maxLoss;
    const br = (s.maxLoss * 3) + 5;
    document.getElementById('bankReq').innerText = br + " u.";
    document.getElementById('stakeSugg').innerText = s.s > 0 ? (100/br).toFixed(1) + "%" : "0%";
    const lDiv = document.getElementById('leagueBreakdown');
    lDiv.innerHTML = "";
    Object.entries(s.leagues).sort((a,b) => b[1].s - a[1].s).forEach(([name, data]) => {
        const lProfit = (data.r - data.s).toFixed(2);
        const section = document.createElement('div');
        section.className = "league-section";
        section.innerHTML = `<h4>${name} (${data.s}p) - <span style="color:${lProfit>=0?'var(--success)':'var(--danger)'}">${lProfit}u.</span></h4>
        <div class="grid">${Object.entries(data.teams).sort((a,b)=>(b[1].r/b[1].s)-(a[1].r/a[1].s)).slice(0,5).map(([t,st])=>{
            const roi = ((st.r/st.s-1)*100).toFixed(0);
            const hitRate = st.w / st.s;
            const minO = hitRate > 0 ? (1 / hitRate).toFixed(2) : "N/A";
            const maxO = st.maxO > 0 ? st.maxO.toFixed(2) : "N/A";
            return `<div class="card ${roi>=20?'premium-team':''}" style="background:rgba(0,0,0,0.1)">
                <div style="display:flex; justify-content:space-between;"><b>${t}</b> <span class="roi-tag ${roi>=0?'pos':'neg'}">${roi}%</span></div>
                <div class="range-badge">Min: @${minO} - Max: @${maxO}</div>
            </div>`
        }).join('')}</div>`;
        lDiv.appendChild(section);
    });
}

function checkAlerts() {
    const saved = localStorage.getItem('bettingStrategy');
    const container = document.getElementById('alertContainer');
    if(!saved) return;
    const savedData = JSON.parse(saved);
    let alerts = [];
    savedData.forEach(savedItem => {
        Object.entries(currentLeaguesData).forEach(([lName, lData]) => {
            if(lData.teams[savedItem.equipo]) {
                const newRoi = ((lData.teams[savedItem.equipo].r/lData.teams[savedItem.equipo].s - 1)*100);
                const oldRoi = parseFloat(savedItem.roi);
                if(newRoi < oldRoi - 5) alerts.push(`<div class="alert-box" style="border-left-color:var(--danger)"><span style="color:var(--danger)">‚ö†Ô∏è BAJADA:</span> <b>${savedItem.equipo}</b> baj√≥ a ${newRoi.toFixed(1)}% ROI.</div>`);
            }
        });
    });
    container.innerHTML = alerts.length > 0 ? `<h3>üîî Alertas</h3>` + alerts.join('') : "";
}

function saveTopStrategy() {
    let toSave = [];
    Object.entries(currentLeaguesData).forEach(([leagueName, data]) => {
        Object.entries(data.teams).forEach(([teamName, st]) => {
            const roi = ((st.r/st.s - 1)*100);
            const hitRate = st.w / st.s;
            const minO = hitRate > 0 ? (1 / hitRate).toFixed(2) : "N/A";
            const maxO = st.maxO > 0 ? st.maxO.toFixed(2) : "N/A";
            if(roi >= 20) toSave.push({ liga: leagueName, equipo: teamName, roi: roi.toFixed(1) + "%", unidades: (st.r - st.s).toFixed(2), minOdd: minO, maxOdd: maxO });
        });
    });
    localStorage.setItem('bettingStrategy', JSON.stringify(toSave));
    loadSavedData();
    alert("Guardado con √©xito incluyendo rangos Min/Max.");
}

function loadSavedData() {
    const saved = localStorage.getItem('bettingStrategy');
    const container = document.getElementById('savedContainer');
    if(!saved) { container.innerHTML = "<p>No hay equipos guardados.</p>"; return; }
    const data = JSON.parse(saved);
    let html = `<table><thead><tr><th>Liga</th><th>Equipo</th><th>ROI</th><th>Units</th><th>Rango de Valor</th></tr></thead><tbody>`;
    data.forEach(item => { html += `<tr><td>${item.liga}</td><td><b>${item.equipo}</b></td><td>${item.roi}</td><td style="color:var(--success);">+${item.unidades}</td><td><span class="range-badge">@${item.minOdd} - @${item.maxOdd}</span></td></tr>`; });
    container.innerHTML = html + `</tbody></table>`;
}

function clearSaved() { if(confirm("¬øBorrar memoria?")) { localStorage.removeItem('bettingStrategy'); loadSavedData(); document.getElementById('alertContainer').innerHTML = ""; } }
</script>
</body>
</html>
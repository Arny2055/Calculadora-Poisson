<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cuotas Justas — Prepartido (Poisson)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#6ee7b7;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      font-family: 'Inter', sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background: linear-gradient(180deg, #071124 0%, #081526 100%);
      color:#e6eef6;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      -webkit-font-smoothing:antialiased;
    }

    .container{
      width:100%;
      max-width:980px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      padding:22px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:18px;
    }

    header{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:6px;
    }
    header h1{font-size:18px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}

    .form{
      padding:16px;
      background:var(--card);
      border-radius:10px;
      display:grid;
      gap:12px;
    }

    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{
      font-size:13px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    .field{
      flex:1 1 140px;
      min-width:140px;
    }
    input[type="number"], input[type="text"], select{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:var(--glass);
      color:inherit;
      font-size:14px;
    }

    .small{
      font-size:12px;color:var(--muted);
    }

    .slider{
      display:flex;align-items:center;gap:10px;
    }
    input[type="range"]{width:100%}

    .actions{
      display:flex;gap:10px;align-items:center;margin-top:6px;
    }
    button{
      padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,#20c997,#6ee7b7);color:#04201a;font-weight:700;cursor:pointer;
      box-shadow: 0 6px 18px rgba(24,138,111,0.12);
    }
    button.secondary{
      background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);
    }

    .result{
      padding:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border-radius:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card-title{font-size:13px;color:var(--muted)}
    .odds-grid{display:flex;gap:10px;align-items:stretch}
    .odds{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:8px;padding:12px;flex:1;text-align:center;
    }
    .odds h3{margin:0;font-size:16px}
    .odds p{margin:4px 0 0;color:var(--muted);font-size:13px}

    .footnote{font-size:12px;color:var(--muted);margin-top:8px}
    .help{font-size:12px;color:var(--muted);line-height:1.3}
    .error{color:#ffb4b4;background:rgba(255,64,64,0.04);padding:8px;border-radius:8px;font-size:13px}
    footer{grid-column:1/-1;margin-top:6px;color:var(--muted);font-size:12px;text-align:right}
    @media (max-width:920px){
      .container{grid-template-columns:1fr; padding:16px;}
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div>
        <h1>Cuotas Justas — Prepartido (Poisson)</h1>
        <p>Modelo Poisson + ajustes: forma, localía y lesionados.</p>
      </div>
      <div class="small">Salida: probabilidades 1X2 y cuotas justas</div>
    </header>

    <!-- Formulario izquierdo -->
    <div class="form" aria-labelledby="form-title">
      <div id="form-title" class="card-title">Datos por equipo</div>

      <div class="row">
        <div class="field">
          <label for="local-name">Equipo Local</label>
          <input id="local-name" type="text" placeholder="Nombre equipo local" value="Local">
        </div>
        <div class="field">
          <label for="visitante-name">Equipo Visitante</label>
          <input id="visitante-name" type="text" placeholder="Nombre equipo visitante" value="Visitante">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="gf-local">Goles a favor (última temporada / n partidos)</label>
          <input id="gf-local" type="number" min="0" value="25">
        </div>
        <div class="field">
          <label for="ga-local">Goles en contra</label>
          <input id="ga-local" type="number" min="0" value="12">
        </div>
        <div class="field">
          <label for="p-local">Partidos (n)</label>
          <input id="p-local" type="number" min="1" value="10">
        </div>
      </div>

      <div style="height:8px"></div>

      <div class="row">
        <div class="field">
          <label for="gf-vis">Goles a favor (visitante)</label>
          <input id="gf-vis" type="number" min="0" value="15">
        </div>
        <div class="field">
          <label for="ga-vis">Goles en contra (visitante)</label>
          <input id="ga-vis" type="number" min="0" value="18">
        </div>
        <div class="field">
          <label for="p-vis">Partidos (n)</label>
          <input id="p-vis" type="number" min="1" value="10">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="racha-local">Racha local (últimos 5, -5 a +5)</label>
          <div class="slider">
            <input id="racha-local" type="range" min="-5" max="5" value="3">
            <div id="racha-local-val" class="small">3</div>
          </div>
          <div class="small help">+1 por victoria, -1 por derrota. Ej: +3 = buena forma.</div>
        </div>

        <div class="field">
          <label for="racha-vis">Racha visitante</label>
          <div class="slider">
            <input id="racha-vis" type="range" min="-5" max="5" value="-2">
            <div id="racha-vis-val" class="small">-2</div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="les-local">Titulares lesionados — Local</label>
          <input id="les-local" type="number" min="0" value="1">
        </div>
        <div class="field">
          <label for="les-vis">Titulares lesionados — Visitante</label>
          <input id="les-vis" type="number" min="0" value="0">
        </div>

        <div class="field">
          <label for="max-goles">Máx goles a considerar (Poisson)</label>
          <select id="max-goles">
            <option value="6">6</option>
            <option value="8" selected>8</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="calcular">Calcular cuotas</button>
        <button id="ejemplo" class="secondary" type="button">Ejemplo por defecto</button>
        <div style="flex:1"></div>
        <div class="small">Modelo sencillo: ajusta factores si quieres más precisión.</div>
      </div>

      <div id="error" style="display:none" class="error"></div>
    </div>

    <!-- Resultados derecho -->
    <aside class="result" aria-labelledby="result-title">
      <div id="result-title" class="card-title">Resultados</div>

      <div id="summary" class="small help">Pulsa "Calcular cuotas" para ver probabilidades y cuotas justas (1X2).</div>

      <div class="odds-grid" style="display:none" id="odds-grid">
        <div class="odds">
          <h3 id="prob-local">—</h3>
          <p>Prob. Local</p>
          <p class="small" id="cuota-local">Cuota: —</p>
        </div>
        <div class="odds">
          <h3 id="prob-empate">—</h3>
          <p>Prob. Empate</p>
          <p class="small" id="cuota-empate">Cuota: —</p>
        </div>
        <div class="odds">
          <h3 id="prob-vis">—</h3>
          <p>Prob. Visitante</p>
          <p class="small" id="cuota-vis">Cuota: —</p>
        </div>
      </div>

      <div id="details" style="display:none" class="small">
        <div><strong>λ local:</strong> <span id="lambda-local">—</span></div>
        <div><strong>λ visitante:</strong> <span id="lambda-vis">—</span></div>
      </div>

      <div class="footnote">
        Nota: este es un modelo prepartido básico (Poisson). Para mayor precisión integra xG, enfrentamientos directos y minutos de juego.
      </div>
    </aside>

    <footer>Hecho para tu calculadora — Poisson + Monte Carlo</footer>
  </div>

  <script>
    // ---------------------------------------
    // Lógica Poisson + ajustes (prepartido)
    // ---------------------------------------
    const $ = id => document.getElementById(id);

    // UI bindings
    const rL = $('racha-local'), rV = $('racha-vis');
    rL.addEventListener('input', ()=> $('racha-local-val').textContent = rL.value);
    rV.addEventListener('input', ()=> $('racha-vis-val').textContent = rV.value);

    $('ejemplo').addEventListener('click', ()=>{
      // Valores de ejemplo
      $('local-name').value = 'Local';
      $('visitante-name').value = 'Visitante';
      $('gf-local').value = 25; $('ga-local').value = 12; $('p-local').value = 10;
      $('gf-vis').value = 15; $('ga-vis').value = 18; $('p-vis').value = 10;
      $('racha-local').value = 3; $('racha-vis').value = -2;
      $('racha-local-val').textContent = 3; $('racha-vis-val').textContent = -2;
      $('les-local').value = 1; $('les-vis').value = 0;
      $('max-goles').value = 8;
    });

    $('calcular').addEventListener('click', calcular);

    function showError(msg){
      const e = $('error');
      e.style.display = 'block';
      e.textContent = msg;
      setTimeout(()=> e.style.display='none', 4000);
    }

    // Factor helpers (mirrored al pseudocódigo Python)
    function ajustar_por_forma(valor, racha){
      // racha entre -5 y +5 => ajuste lineal: ±0.10 max (2% por unidad)
      return valor * (1 + (racha * 0.02));
    }
    function ajustar_por_localia(valor, es_local){
      return valor * (es_local ? 1.1 : 0.9);
    }
    function ajustar_por_lesiones(valor, num_lesionados){
      return valor * (1 - num_lesionados * 0.03);
    }

    // Poisson probability (k from 0..max)
    function poissonProb(lambda, k){
      // Use iterative factorial-safe calculation
      let res = Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k);
      return res;
    }

    // Factorial with small table for speed
    const factorial = (n => {
      const cache = [1];
      return function(n){
        if (n < 0) return NaN;
        if (cache[n] !== undefined) return cache[n];
        let last = cache.length - 1;
        let val = cache[last];
        for (let i = last+1; i <= n; i++){
          val *= i;
          cache[i] = val;
        }
        return cache[n];
      };
    })();

    function calcular(){
      // Leer inputs
      const gfLocal = Number($('gf-local').value);
      const gaLocal = Number($('ga-local').value);
      const pLocal  = Math.max(1, Number($('p-local').value));
      const gfVis = Number($('gf-vis').value);
      const gaVis = Number($('ga-vis').value);
      const pVis  = Math.max(1, Number($('p-vis').value));
      const rachaLocal = Number($('racha-local').value);
      const rachaVis = Number($('racha-vis').value);
      const lesLocal = Math.max(0, Number($('les-local').value));
      const lesVis = Math.max(0, Number($('les-vis').value));
      const maxGoles = Number($('max-goles').value);

      // Validación mínima
      if (gfLocal < 0 || gaLocal < 0 || gfVis < 0 || gaVis < 0) { showError('Goles no pueden ser negativos'); return; }
      if (pLocal <= 0 || pVis <= 0){ showError('Partidos debe ser >= 1'); return; }

      // Fuerza ofensiva / defensiva (promedios)
      const atkLocal = gfLocal / pLocal;
      const defLocal = gaLocal / pLocal;
      const atkVis = gfVis / pVis;
      const defVis = gaVis / pVis;

      // Lambda inicial (ataque propio * defensa rival)
      let lambdaLocal = atkLocal * defVis;
      let lambdaVis = atkVis * defLocal;

      // Ajustes: forma
      lambdaLocal = ajustar_por_forma(lambdaLocal, rachaLocal);
      lambdaVis   = ajustar_por_forma(lambdaVis, rachaVis);

      // Localía
      lambdaLocal = ajustar_por_localia(lambdaLocal, true);
      lambdaVis   = ajustar_por_localia(lambdaVis, false);

      // Lesionados
      lambdaLocal = ajustar_por_lesiones(lambdaLocal, lesLocal);
      lambdaVis   = ajustar_por_lesiones(lambdaVis, lesVis);

      // Evitar lambdas negativas por exceso de lesionados/racha extrema
      lambdaLocal = Math.max(0.01, lambdaLocal);
      lambdaVis = Math.max(0.01, lambdaVis);

      // Calcular probabilidades 1X2 sumando Poisson de todos los marcadores
      let probLocal = 0, probEmpate = 0, probVis = 0;
      for (let i=0;i<=maxGoles;i++){
        const p_i = poissonProb(lambdaLocal, i);
        for (let j=0;j<=maxGoles;j++){
          const p_j = poissonProb(lambdaVis, j);
          const p = p_i * p_j;
          if (i > j) probLocal += p;
          else if (i === j) probEmpate += p;
          else probVis += p;
        }
      }

      // Parte de probabilidad que quedó fuera (colas) -> asignar pequeña porción si queda < 0.999
      const totalConsiderado = probLocal + probEmpate + probVis;
      if (totalConsiderado < 0.9999){
        // Normalizamos (más correcto) para que sumen 1 sobre lo calculado
        probLocal /= totalConsiderado;
        probEmpate /= totalConsiderado;
        probVis /= totalConsiderado;
      }

      // Cuotas justas (1/prob). Evitar división por cero.
      const cuotaLocal = probLocal > 0 ? (1 / probLocal) : Infinity;
      const cuotaEmpate = probEmpate > 0 ? (1 / probEmpate) : Infinity;
      const cuotaVis = probVis > 0 ? (1 / probVis) : Infinity;

      // Mostrar resultados con formato
      $('odds-grid').style.display = 'flex';
      $('prob-local').textContent = (probLocal*100).toFixed(1) + '%';
      $('prob-empate').textContent = (probEmpate*100).toFixed(1) + '%';
      $('prob-vis').textContent = (probVis*100).toFixed(1) + '%';
      $('cuota-local').textContent = 'Cuota justa: ' + (isFinite(cuotaLocal) ? cuotaLocal.toFixed(2) : '—');
      $('cuota-empate').textContent = 'Cuota justa: ' + (isFinite(cuotaEmpate) ? cuotaEmpate.toFixed(2) : '—');
      $('cuota-vis').textContent = 'Cuota justa: ' + (isFinite(cuotaVis) ? cuotaVis.toFixed(2) : '—');

      $('details').style.display = 'block';
      $('lambda-local').textContent = lambdaLocal.toFixed(3);
      $('lambda-vis').textContent = lambdaVis.toFixed(3);

      $('summary').textContent = `λ (goles esperados) calculados y probabilidades 1X2. Parámetros: max goles ${maxGoles}.`;
    }
  </script>
</body>
</html>
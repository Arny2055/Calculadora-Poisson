<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora Poisson de Fútbol — Ataque, Defensa, xG y Probabilidades</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --border:#2a3140;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
  header{padding:18px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, #121520, #0f1115)}
  h1{margin:0; font-size:20px}
  .wrap{max-width:1100px; margin:20px auto; padding:0 16px}
  .grid{display:grid; gap:14px}
  @media(min-width:900px){ .grid{grid-template-columns: 1.1fr 1fr} }
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px}
  .card h2{margin:6px 0 12px; font-size:16px}
  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  select, input[type="number"], input[type="text"]{
    width:100%; padding:10px 12px; background:var(--panel2); color:var(--text);
    border:1px solid var(--border); border-radius:10px; font-size:14px;
  }
  input[type="file"]{width:100%}
  .row{display:grid; gap:10px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--border);
    background:linear-gradient(180deg,#1b2130,#171a21); color:var(--text); font-weight:600; cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .accent{background:linear-gradient(180deg,#2a58ff,#264bda); border-color:#2c4fd0}
  .muted{color:var(--muted)}
  .kpis{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
  @media(min-width:900px){ .kpis{grid-template-columns:repeat(4,1fr)} }
  .kpi{background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:12px}
  .kpi .t{font-size:12px; color:var(--muted)}
  .kpi .v{font-size:18px; font-weight:800; margin-top:4px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:8px 10px; border-bottom:1px solid var(--border)}
  th{text-align:left; color:#c9d3e7; background:#1a1f2a; position:sticky; top:0}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--panel2)}
  .ok{color:#0dd88d} .bad{color:#ff7d7d} .warn{color:#ffcc66}
  details {background:var(--panel2); border:1px solid var(--border); border-radius:10px; padding:10px; }
  summary{cursor:pointer; font-weight:600}
  .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; color:#cfe1ff}
  .footer{color:var(--muted); font-size:12px; text-align:center; padding:18px}
</style>
</head>
<body>
<header><h1>Calculadora Poisson • xG por fuerzas (Ataque/Defensa) • 1X2 / O2.5 / BTTS</h1></header>
<div class="wrap grid">
  <div class="card">
    <h2>1) Cargar JSON & elegir equipos</h2>
    <label>Archivo JSON (array, objeto o NDJSON). Acepta datos agregados por equipo o partidos crudos.</label>
    <input id="file" type="file" accept=".json,.txt,.ndjson,.csv" />
    <div class="row">
      <div>
        <label> Liga </label>
        <select id="league" disabled></select>
      </div>
      <div>
        <label> Ventaja local (HA) <span class="muted">(1.00 = sin ventaja)</span></label>
        <input id="ha" type="number" step="0.01" min="0.5" max="1.6" value="1.10" />
      </div>
    </div>
    <div class="row">
      <div>
        <label> Local </label>
        <select id="home" disabled></select>
      </div>
      <div>
        <label> Visitante </label>
        <select id="away" disabled></select>
      </div>
    </div>
    <div style="margin-top:12px">
      <button id="calc" class="btn accent" disabled>Calcular Poisson</button>
      <span id="status" class="muted" style="margin-left:10px"></span>
    </div>

    <details style="margin-top:14px">
      <summary>Formato de datos aceptado (ejemplos)</summary>
      <div class="code" style="margin-top:8px">
        <!-- Ejemplo agregado por equipo -->
        [
          {"League":"Argentina Liga Profesional","Team":"Banfield","GF":45,"GA":40,"Matches":30},
          {"League":"Argentina Liga Profesional","Team":"Instituto","GF":38,"GA":42,"Matches":30}
        ]<br/><br/>
        <!-- Ejemplo partidos crudos -->
        [
          {"League":"Argentina Liga Profesional","HomeTeam":"Banfield","AwayTeam":"Instituto","FTHG":1,"FTAG":2},
          {"League":"Argentina Liga Profesional","HomeTeam":"Instituto","AwayTeam":"Banfield","FTHG":0,"FTAG":1}
        ]
      </div>
    </details>
  </div>

  <div class="card">
    <h2>2) Métricas y xG (a partir del JSON)</h2>
    <div class="kpis">
      <div class="kpi"><div class="t">Promedio liga (goles/eq/part)</div><div class="v" id="k_mu">—</div></div>
      <div class="kpi"><div class="t">Ataque Local</div><div class="v" id="k_att_h">—</div></div>
      <div class="kpi"><div class="t">Defensa Local</div><div class="v" id="k_def_h">—</div></div>
      <div class="kpi"><div class="t">Ataque Visitante</div><div class="v" id="k_att_a">—</div></div>
      <div class="kpi"><div class="t">Defensa Visitante</div><div class="v" id="k_def_a">—</div></div>
      <div class="kpi"><div class="t">λ Local (xG)</div><div class="v" id="k_lh">—</div></div>
      <div class="kpi"><div class="t">λ Visitante (xG)</div><div class="v" id="k_la">—</div></div>
    </div>
    <p class="muted" style="margin-top:8px">
      Fórmulas: ataque = (GF/Part) / μ_liga; defensa = (GA/Part) / μ_liga; <br/>
      λ_local = ataque_local × defensa_visitante × μ_liga × HA; λ_visit = ataque_visitante × defensa_local × μ_liga.
    </p>
  </div>

  <div class="card">
    <h2>3) Mercados</h2>
    <div class="row">
      <div class="kpi"><div class="t">Home Win (1)</div><div class="v" id="m_1">—</div></div>
      <div class="kpi"><div class="t">Draw (X)</div><div class="v" id="m_x">—</div></div>
      <div class="kpi"><div class="t">Away Win (2)</div><div class="v" id="m_2">—</div></div>
      <div class="kpi"><div class="t">BTTS: Sí</div><div class="v" id="m_btts">—</div></div>
      <div class="kpi"><div class="t">Over 2.5</div><div class="v" id="m_o25">—</div></div>
      <div class="kpi"><div class="t">Under 2.5</div><div class="v" id="m_u25">—</div></div>
    </div>
  </div>

  <div class="card">
    <h2>4) Probabilidades de marcadores (0–10)</h2>
    <div style="overflow:auto; max-height:420px">
      <table id="scoretab">
        <thead><tr><th>Marcador</th><th>Prob.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="wrap footer">Tip: Si tu JSON tiene claves distintas, intenta mantener equivalentes como <em>League/Liga</em>, <em>Team/Equipo</em>, <em>GF/GA</em>, <em>Matches/PJ</em> o <em>HomeTeam/AwayTeam</em>, <em>FTHG/FTAG</em>.</div>

<script>
(function(){
  const el = (id)=>document.getElementById(id);
  const status = el('status');
  const leagueSel = el('league');
  const homeSel = el('home');
  const awaySel = el('away');
  const btnCalc = el('calc');
  const haInput = el('ha');
  const scoreTbody = document.querySelector('#scoretab tbody');

  // Data estructurada a partir del JSON
  // teams[league][team] = { gf, ga, matches }
  let teams = {};
  let ready = false;

  // Utiles robustos de parseo
  function parsePotentialJSON(text){
    // Intenta: JSON.parse directo; si falla, prueba NDJSON
    try{
      const j = JSON.parse(text);
      if (Array.isArray(j)) return j;
      return [j];
    }catch(e){
      // NDJSON
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const arr = [];
      for (const ln of lines){
        try{ arr.push(JSON.parse(ln)); }catch(_){}
      }
      if (arr.length) return arr;
      throw new Error("No se pudo leer el JSON. Verifica formato (array/objeto/NDJSON).");
    }
  }

  // Normalización de claves
  const keyMap = {
    league: /^(league|liga)$/i,
    team: /^(team|equipo|name|nombre)$/i,
    gf: /^(gf|goals\s*for|goles\s*a\s*favor|golesf|golesaf)$/i,
    ga: /^(ga|goals\s*against|goles\s*en\s*contra|golesc|golesec|golesen)$/i,
    matches: /^(matches|mp|pj|games|partidos)$/i,

    homeTeam: /^(hometeam|local|equipo\s*local)$/i,
    awayTeam: /^(awayteam|visitante|equipo\s*visitante)$/i,
    fthg: /^(fthg|home(goals)?|goles\s*local|gf\s*local)$/i,
    ftag: /^(ftag|away(goals)?|goles\s*visitante|gf\s*visitante)$/i
  };

  function findKey(obj, regex){
    for (const k of Object.keys(obj)){
      if (regex.test(k)) return k;
    }
    return null;
  }

  function num(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

  function accumulateTeam(leag, team, gf, ga, m){
    if (!leag || !team) return;
    teams[leag] = teams[leag] || {};
    const t = teams[leag][team] || {gf:0, ga:0, matches:0};
    t.gf += gf; t.ga += ga; t.matches += m;
    teams[leag][team] = t;
  }

  function buildFromArray(arr){
    teams = {};
    for (const row of arr){
      if (!row || typeof row!=='object') continue;
      const kLeague = findKey(row, keyMap.league);
      const league = kLeague ? String(row[kLeague]).trim() : null;

      // Caso 1: datos agregados por equipo
      const kTeam = findKey(row, keyMap.team);
      const kGF = findKey(row, keyMap.gf);
      const kGA = findKey(row, keyMap.ga);
      const kM  = findKey(row, keyMap.matches);

      // Caso 2: partidos crudos
      const kHT = findKey(row, keyMap.homeTeam);
      const kAT = findKey(row, keyMap.awayTeam);
      const kFTHG = findKey(row, keyMap.fthg);
      const kFTAG = findKey(row, keyMap.ftag);

      if (kTeam && (kGF || kGA) && kM){
        // Agregado por equipo
        const team = String(row[kTeam]).trim();
        const gf = num(row[kGF]);
        const ga = num(row[kGA]);
        const m  = Math.max(1, num(row[kM]));
        accumulateTeam(league, team, gf, ga, m);
      } else if (kHT && kAT && (kFTHG || kFTAG)){
        // Partidos crudos (1 partido = 1 fila)
        const ht = String(row[kHT]).trim();
        const at = String(row[kAT]).trim();
        const gh = num(row[kFTHG]);
        const ga = num(row[kFTAG]);
        // Cada partido suma 1 para cada equipo
        accumulateTeam(league, ht, gh, ga, 1);
        accumulateTeam(league, at, ga, gh, 1);
      } else {
        // Fila no reconocida: la ignoramos de forma segura
        continue;
      }
    }
  }

  function fillSelectors(){
    // Liga
    const leagues = Object.keys(teams).sort((a,b)=>a.localeCompare(b));
    leagueSel.innerHTML = '<option value="">— Selecciona liga —</option>' + leagues.map(l=>`<option>${escapeHtml(l)}</option>`).join('');
    leagueSel.disabled = leagues.length===0;

    function setTeamsForLeague(lig){
      const list = lig && teams[lig] ? Object.keys(teams[lig]).sort((a,b)=>a.localeCompare(b)) : [];
      const opts = '<option value="">— Equipo —</option>' + list.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
      homeSel.innerHTML = opts; awaySel.innerHTML = opts;
      homeSel.disabled = !list.length; awaySel.disabled = !list.length;
    }

    setTeamsForLeague(leagues[0] || "");
    leagueSel.addEventListener('change', e=> setTeamsForLeague(leagueSel.value));
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // Poisson helpers
  const factMemo = [1];
  function fact(n){ for(let i=factMemo.length;i<=n;i++) factMemo[i]=factMemo[i-1]*i; return factMemo[n]; }
  function poisPMF(k, lambda){ return Math.exp(-lambda) * Math.pow(lambda, k) / fact(k); }
  function clamp(x,min,max){ return Math.max(min, Math.min(max,x)); }

  function compute(){
    status.textContent = '';
    const lig = leagueSel.value;
    const home = homeSel.value;
    const away = awaySel.value;
    const HA = clamp(Number(haInput.value)||1.00, 0.5, 1.6);

    if (!lig || !teams[lig]){ status.textContent='Elige una liga.'; return; }
    if (!home || !away || home===away){ status.textContent='Elige dos equipos distintos.'; return; }

    const tH = teams[lig][home];
    const tA = teams[lig][away];
    if (!tH || !tA){ status.textContent='Faltan datos para esos equipos.'; return; }

    // μ_liga = (sum_GF / sum_Partidos) -> goles por equipo por partido
    let sumGF=0, sumM=0;
    for (const t of Object.values(teams[lig])){
      sumGF += t.gf;
      sumM  += t.matches;
    }
    const mu = sumM>0 ? (sumGF/sumM) : 1.2; // fallback prudente

    // Promedios por equipo
    const h_gfpm = tH.gf / Math.max(1,tH.matches);
    const h_gapm = tH.ga / Math.max(1,tH.matches);
    const a_gfpm = tA.gf / Math.max(1,tA.matches);
    const a_gapm = tA.ga / Math.max(1,tA.matches);

    // Fuerzas
    const attH = h_gfpm / mu;
    const defH = h_gapm / mu;
    const attA = a_gfpm / mu;
    const defA = a_gapm / mu;

    // Lambdas (xG)
    const lambdaH = attH * defA * mu * HA;
    const lambdaA = attA * defH * mu;

    // KPI render
    el('k_mu').textContent     = mu.toFixed(3);
    el('k_att_h').textContent  = attH.toFixed(3);
    el('k_def_h').textContent  = defH.toFixed(3);
    el('k_att_a').textContent  = attA.toFixed(3);
    el('k_def_a').textContent  = defA.toFixed(3);
    el('k_lh').textContent     = lambdaH.toFixed(3);
    el('k_la').textContent     = lambdaA.toFixed(3);

    // Scoreline matrix (0..10)
    const MAXG = 10;
    const pH = Array.from({length:MAXG+1}, (_,k)=>poisPMF(k, lambdaH));
    const pA = Array.from({length:MAXG+1}, (_,k)=>poisPMF(k, lambdaA));

    // 1X2, draws, totals
    let p1=0, px=0, p2=0, pUnder25=0;
    let probScores = [];
    for (let h=0; h<=MAXG; h++){
      for (let a=0; a<=MAXG; a++){
        const p = pH[h]*pA[a];
        probScores.push({score:`${h}-${a}`, p});
        if (h>a) p1+=p; else if (h===a) px+=p; else p2+=p;
        if (h+a <= 2) pUnder25 += p;
      }
    }
    const pOver25 = 1 - pUnder25;

    // BTTS Sí = 1 - P(H=0) - P(A=0) + P(H=0,A=0)
    const btts = 1 - pH[0] - pA[0] + (pH[0]*pA[0]);

    // Render mercados
    el('m_1').textContent   = (p1*100).toFixed(1)+'%';
    el('m_x').textContent   = (px*100).toFixed(1)+'%';
    el('m_2').textContent   = (p2*100).toFixed(1)+'%';
    el('m_btts').textContent= (btts*100).toFixed(1)+'%';
    el('m_o25').textContent = (pOver25*100).toFixed(1)+'%';
    el('m_u25').textContent = (pUnder25*100).toFixed(1)+'%';

    // Render scorelines top→bottom por prob.
    probScores.sort((a,b)=>b.p-a.p);
    const rows = probScores.slice(0,50).map(x=>(
      `<tr><td><span class="pill">${x.score}</span></td><td>${(x.p*100).toFixed(3)}%</td></tr>`
    )).join('');
    scoreTbody.innerHTML = rows || '<tr><td colspan="2">—</td></tr>';
  }

  // Eventos
  btnCalc.addEventListener('click', compute);

  el('file').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if (!f){ return; }
    try{
      const text = await f.text();
      const arr = parsePotentialJSON(text);
      if (!arr.length) throw new Error("El archivo está vacío.");
      buildFromArray(arr);
      fillSelectors();
      ready = true;
      btnCalc.disabled = false;
      status.textContent = 'Datos cargados ✔';
    }catch(err){
      ready = false;
      btnCalc.disabled = true;
      leagueSel.disabled = true; homeSel.disabled = true; awaySel.disabled = true;
      leagueSel.innerHTML=''; homeSel.innerHTML=''; awaySel.innerHTML='';
      status.textContent = err.message || 'Error al leer el JSON.';
    }
  });
})();
</script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora estilo BetMines — Fair Odds, EV & Kelly</title>
  <style>
    body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;line-height:1.4;margin:20px;background:#f6f8fb;color:#0f172a}
    h1{font-size:20px;margin-bottom:6px}
    label{display:block;margin-top:10px;font-size:13px;color:#334155}
    input[type="number"],input[type="text"],select{padding:8px;border-radius:6px;border:1px solid #cbd5e1;width:160px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a4;color:white;cursor:pointer}
    table{border-collapse:collapse;width:100%;margin-top:16px;background:white;border-radius:8px;overflow:hidden}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
    th{background:#eef2f6}
    .good{color:#065f46;font-weight:700}
    .bad{color:#b91c1c}
    .muted{color:#64748b;font-size:13px}
    .small{font-size:13px}
    footer{margin-top:18px;color:#475569;font-size:13px}
  </style>
</head>
<body>
  <h1>Calculadora estilo BetMines — Probabilidades, EV y Kelly</h1>
  <p class="muted">Introduce ratings o probabilidades; compara con cuotas del bookmaker para detectar valor.</p>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start">
    <div>
      <label>Local</label>
      <input id="homeName" type="text" value="Equipo A"/>
      <label>Visitante</label>
      <input id="awayName" type="text" value="Equipo B"/>

      <h3 class="small" style="margin-top:12px">Modelo Poisson (prepartido)</h3>
      <label>Atq local (goles esperados por partido)</label>
      <input id="atkHome" type="number" step="0.01" value="1.45"/>
      <label>Def local (goles encajados por partido)</label>
      <input id="defHome" type="number" step="0.01" value="1.15"/>

      <label>Atq visitante</label>
      <input id="atkAway" type="number" step="0.01" value="1.05"/>
      <label>Def visitante</label>
      <input id="defAway" type="number" step="0.01" value="1.25"/>

      <label>Media liguera goles home por partido</label>
      <input id="leagueAvgHome" type="number" step="0.01" value="1.5"/>
      <label>Media liguera goles away por partido</label>
      <input id="leagueAvgAway" type="number" step="0.01" value="1.2"/>

      <div style="margin-top:12px" class="row">
        <button onclick="runAll()">Calcular</button>
        <button onclick="runMonteCarlo()">Simular MonteCarlo (10k)</button>
      </div>
    </div>

    <div>
      <h3 class="small">Cuotas del Bookmaker (decimales)</h3>
      <label>Cuota Local</label>
      <input id="oddsHome" type="number" step="0.01" value="2.40"/>
      <label>Cuota Empate</label>
      <input id="oddsDraw" type="number" step="0.01" value="3.30"/>
      <label>Cuota Visitante</label>
      <input id="oddsAway" type="number" step="0.01" value="3.00"/>

      <label style="margin-top:10px">Tu bankroll</label>
      <input id="bankroll" type="number" step="0.01" value="1000"/>

      <h3 class="small" style="margin-top:12px">Opciones</h3>
      <label>Cap max Kelly (%)</label>
      <input id="capKelly" type="number" step="0.1" value="20"/>
      <label>Usar probabilidades manuales (si las dejas en 0 usa Poisson)</label>
      <div class="row">
        <input id="manualHome" type="number" step="0.0001" placeholder="p(Home)" value="0"/>
        <input id="manualDraw" type="number" step="0.0001" placeholder="p(Draw)" value="0"/>
        <input id="manualAway" type="number" step="0.0001" placeholder="p(Away)" value="0"/>
      </div>
    </div>
  </div>

  <div id="output"></div>

  <table id="resultsTable" style="display:none">
    <thead>
      <tr><th>Resultado</th><th>Prob. Modelo</th><th>Cuota Book</th><th>Prob. Book (sin vig)</th><th>EV (%)</th><th>Kelly %</th><th>Stake sugerido</th></tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

  <footer>
    Sugerencias: ajustar ratings por lesiones/formación y comparar varias casas (scrapping de cuotas) para mejores señales. Este script es educativo — úsalo con responsabilidad.
  </footer>

<script>
  // --- utilidades matemáticas ---
  function factorial(n){ let r=1; for(let i=2;i<=n;i++) r*=i; return r; }
  function poisson(k, lambda){ return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k); }

  // Simula Poisson (Knuth)
  function samplePoisson(lambda){
    let L = Math.exp(-lambda);
    let k = 0;
    let p = 1;
    while (p > L) { k++; p *= Math.random(); if (k > 50) break; }
    return k - 1;
  }

  // Calcula matriz de probabilidades de resultados 0..maxGoals
  function matrixProb(homeLambda, awayLambda, maxGoals=6){
    const mat = [];
    for(let i=0;i<=maxGoals;i++){
      mat[i]=[];
      for(let j=0;j<=maxGoals;j++){
        mat[i][j] = poisson(i, homeLambda)*poisson(j, awayLambda);
      }
    }
    // agregar la cola de probabilidades restantes en el último casillero (approx)
    let tail = 1 - mat.flat().reduce((a,b)=>a+b,0);
    if(tail>0) mat[maxGoals][maxGoals] += tail;
    return mat;
  }

  // De matriz a probabilidades 1X2
  function probsFromMatrix(mat){
    let home=0, draw=0, away=0;
    for(let i=0;i<mat.length;i++){
      for(let j=0;j<mat.length;j++){
        if(i>j) home+=mat[i][j];
        else if(i==j) draw+=mat[i][j];
        else away+=mat[i][j];
      }
    }
    // normalizar por si hay ligera perdida
    const sum = home+draw+away;
    return {home: home/sum, draw: draw/sum, away: away/sum};
  }

  // Remueve vig de cuotas decimales (book implied -> no-vig)
  function removeVig(odds){
    const imps = odds.map(o => 1/o);
    const s = imps.reduce((a,b)=>a+b,0);
    return imps.map(p => p/s);
  }

  // EV y Kelly
  function evPercent(prob, odds){
    return (odds*prob - 1)*100;
  }
  function kellyFraction(prob, odds){
    const b = odds - 1;
    const q = 1 - prob;
    const f = (b*prob - q)/b;
    return Math.max(0, f);
  }

  // Calcula lambdas Poisson usando un modelo simple: lambda_home = atkHome*defAway*leagueAvgHome ...
  function computeLambdas(atkH, defH, atkA, defA, leagueHome, leagueAway){
    // modelo multiplicativo simple:
    const homeLambda = atkH * defA * (leagueHome);
    const awayLambda = atkA * defH * (leagueAway);
    // escalado para evitar extremos (puedes ajustar)
    return {home: Math.max(0.05, homeLambda), away: Math.max(0.05, awayLambda)};
  }

  // --- main runner ---
  function runAll(){
    // inputs
    const odds = [
      parseFloat(document.getElementById('oddsHome').value) || 0,
      parseFloat(document.getElementById('oddsDraw').value) || 0,
      parseFloat(document.getElementById('oddsAway').value) || 0
    ];
    const bankroll = parseFloat(document.getElementById('bankroll').value) || 0;
    const capKellyPct = parseFloat(document.getElementById('capKelly').value) || 100;

    // manual probs?
    const manH = parseFloat(document.getElementById('manualHome').value) || 0;
    const manD = parseFloat(document.getElementById('manualDraw').value) || 0;
    const manA = parseFloat(document.getElementById('manualAway').value) || 0;
    let modelProbs = null;

    if(manH+manD+manA > 0.000001){
      const s = manH+manD+manA;
      modelProbs = {home: manH/s, draw: manD/s, away: manA/s};
    } else {
      // compute Poisson lambdas
      const atkH = parseFloat(document.getElementById('atkHome').value) || 1;
      const defH = parseFloat(document.getElementById('defHome').value) || 1;
      const atkA = parseFloat(document.getElementById('atkAway').value) || 1;
      const defA = parseFloat(document.getElementById('defAway').value) || 1;
      const leagueHome = parseFloat(document.getElementById('leagueAvgHome').value) || 1.3;
      const leagueAway = parseFloat(document.getElementById('leagueAvgAway').value) || 1.0;

      const lambdas = computeLambdas(atkH, defH, atkA, defA, leagueHome, leagueAway);
      const mat = matrixProb(lambdas.home, lambdas.away, 6);
      modelProbs = probsFromMatrix(mat);
    }

    // book implied prob without vig
    const bookProbsNoVig = removeVig(odds);

    // prepare UI
    document.getElementById('resultsTable').style.display = '';
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';

    const labels = ['Local','Empate','Visitante'];
    const modelArr = [modelProbs.home, modelProbs.draw, modelProbs.away];

    for(let i=0;i<3;i++){
      const pModel = modelArr[i];
      const oddBook = odds[i];
      const pBookNoVig = bookProbsNoVig[i];
      const ev = evPercent(pModel, oddBook);
      let kelly = kellyFraction(pModel, oddBook) * 100;
      if(kelly > capKellyPct) kelly = capKellyPct; // cap
      const stake = (kelly/100)*bankroll;
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${labels[i]}</td>
        <td>${(pModel*100).toFixed(2)}%</td>
        <td>${oddBook > 0 ? oddBook.toFixed(2) : '-'}</td>
        <td>${(pBookNoVig*100).toFixed(2)}%</td>
        <td class="${ev>0?'good':'bad'}">${ev.toFixed(2)}%</td>
        <td>${kelly.toFixed(2)}%</td>
        <td>${stake>0?stake.toFixed(2): '-'}</td>
      `;
      tbody.appendChild(tr);
    }

    // show summary
    const o = document.getElementById('output');
    o.innerHTML = `
      <div style="margin-top:12px;padding:12px;background:white;border-radius:8px">
        <div><strong>Probabilidades modelo:</strong>
          Local ${(modelProbs.home*100).toFixed(2)}% —
          Empate ${(modelProbs.draw*100).toFixed(2)}% —
          Visitante ${(modelProbs.away*100).toFixed(2)}%
        </div>
        <div class="muted" style="margin-top:8px">Nota: si quieres más precisión usa ratings ajustados por fuerza de rivales, lesiones, minutos, y compara múltiples casas.</div>
      </div>
    `;
  }

  // Monte Carlo simulation of outcomes using Poisson sampling
  function runMonteCarlo(sims=10000){
    // ensure we use Poisson lambdas (manual probs ignored for MC)
    const atkH = parseFloat(document.getElementById('atkHome').value) || 1;
    const defH = parseFloat(document.getElementById('defHome').value) || 1;
    const atkA = parseFloat(document.getElementById('atkAway').value) || 1;
    const defA = parseFloat(document.getElementById('defAway').value) || 1;
    const leagueHome = parseFloat(document.getElementById('leagueAvgHome').value) || 1.3;
    const leagueAway = parseFloat(document.getElementById('leagueAvgAway').value) || 1.0;
    const lambdas = computeLambdas(atkH, defH, atkA, defA, leagueHome, leagueAway);

    let home=0, draw=0, away=0;
    for(let i=0;i<sims;i++){
      const gH = samplePoisson(lambdas.home);
      const gA = samplePoisson(lambdas.away);
      if(gH>gA) home++;
      else if(gH===gA) draw++;
      else away++;
    }
    const res = {home:home/sims, draw:draw/sims, away:away/sims};
    // set manual fields to these probabilities for quick reuse
    document.getElementById('manualHome').value = res.home.toFixed(4);
    document.getElementById('manualDraw').value = res.draw.toFixed(4);
    document.getElementById('manualAway').value = res.away.toFixed(4);

    runAll();
    alert(`Simulación completa (${sims} iter). Probabilidades fijadas en campos manuales.`);
  }

  // Run once on load
  runAll();
</script>
</body>
</html>
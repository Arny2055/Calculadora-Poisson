<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor de Backtesting Deportivo Avanzado</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN para la visualización de la curva de capital -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Estilos personalizados para la tipografía Inter y la apariencia general */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Clase para el scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        .metric-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">Motor de Backtesting Deportivo</h1>
            <p class="text-lg text-gray-500 mt-2">Simulación y análisis avanzado de estrategias de apuestas con archivos CSV.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna 1: Configuración y Carga de Archivo -->
            <div class="lg:col-span-1 p-6 bg-white rounded-xl shadow-lg h-full">
                <h2 class="text-2xl font-semibold mb-6 text-indigo-700 border-b pb-2">1. Configuración de Simulación</h2>

                <!-- Carga de Archivo CSV -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="csvFile">Cargar Archivo CSV de Datos</label>
                    <input type="file" id="csvFile" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150 rounded-lg border border-gray-300 p-2">
                </div>

                <!-- Parámetros Financieros -->
                <div class="mb-6 space-y-4">
                    <h3 class="text-xl font-medium text-gray-700">Parámetros de Capital</h3>
                    <div>
                        <label for="initialCapital" class="block text-sm font-medium text-gray-700">Capital Inicial (€)</label>
                        <input type="number" id="initialCapital" value="1000" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border">
                    </div>
                    <div>
                        <label for="stakeSize" class="block text-sm font-medium text-gray-700">Tamaño de Apuesta (Stake Fijo)</label>
                        <input type="number" id="stakeSize" value="10" min="0.1" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border">
                    </div>
                </div>

                <!-- Filtros de Datos -->
                <div class="mb-6 space-y-4">
                    <h3 class="text-xl font-medium text-gray-700">Filtros (Opcional)</h3>
                    <div>
                        <label for="leagueFilter" class="block text-sm font-medium text-gray-700">Filtrar por Liga (ej: Premier League)</label>
                        <input type="text" id="leagueFilter" placeholder="Dejar vacío para todas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border">
                    </div>
                    <div>
                        <label for="teamFilter" class="block text-sm font-medium text-gray-700">Filtrar por Equipo (ej: Manchester Utd)</label>
                        <input type="text" id="teamFilter" placeholder="Dejar vacío para todos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border">
                    </div>
                </div>

                <!-- Botón de Ejecución -->
                <button id="runBacktestBtn" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition duration-300 shadow-md disabled:bg-indigo-300" disabled>
                    <span id="buttonText">Cargar CSV para Ejecutar Backtesting</span>
                </button>
                <div id="statusMessage" class="mt-3 text-center text-sm font-medium text-gray-600"></div>

            </div>

            <!-- Columna 2 y 3: Resultados y Gráfico -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Gráfico de Evolución de Capital -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-indigo-700">2. Curva de Capital (Equity Curve)</h2>
                    <div class="relative h-96">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>

                <!-- Métricas Clave -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-indigo-700">3. Métricas de Rendimiento</h2>
                    <div id="metricsOutput" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <!-- Las métricas se inyectarán aquí -->
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">Capital Final</p>
                            <p id="finalCapital" class="text-xl font-bold text-gray-800">0.00 €</p>
                        </div>
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">ROI (%)</p>
                            <p id="roi" class="text-xl font-bold text-gray-800">0.00 %</p>
                        </div>
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">Beneficio Neto</p>
                            <p id="netProfit" class="text-xl font-bold text-gray-800">0.00 €</p>
                        </div>
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">Drawdown Máx.</p>
                            <p id="maxDrawdown" class="text-xl font-bold text-red-600">0.00 %</p>
                        </div>
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">Tasa de Acierto</p>
                            <p id="winRate" class="text-xl font-bold text-green-600">0.00 %</p>
                        </div>
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">Racha Pérdidas Máx.</p>
                            <p id="maxLossStreak" class="text-xl font-bold text-red-600">0</p>
                        </div>
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">Total de Apuestas</p>
                            <p id="totalBets" class="text-xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="metric-card p-4 bg-gray-50 rounded-lg text-center border">
                            <p class="text-xs text-gray-500 font-medium">Ganadas / Perdidas</p>
                            <p id="winsLosses" class="text-xl font-bold text-gray-800">0 / 0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Análisis Detallado (Rachas y Grupos) -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-indigo-700">4. Análisis Exhaustivo (Rachas y Segmentos)</h2>
                    
                    <h3 class="text-xl font-medium text-gray-700 mb-2 mt-4">Análisis de Rachas y Rentabilidad (Basado en la Estrategia)</h3>
                    <div id="streakAnalysis" class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <p class="text-sm text-yellow-800">Esperando datos...</p>
                    </div>

                    <h3 class="text-xl font-medium text-gray-700 mb-2 mt-6">Análisis por Ligas</h3>
                    <div class="overflow-x-auto custom-scroll">
                        <table class="min-w-full divide-y divide-gray-200 mt-2">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Liga</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apuestas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Win Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Beneficio</th>
                                </tr>
                            </thead>
                            <tbody id="leagueAnalysis" class="bg-white divide-y divide-gray-200">
                                <!-- Datos de ligas se inyectarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Función auxiliar para reemplazar alert()
        function showMessage(message, isError = true) {
            statusMessage.textContent = message;
            statusMessage.classList.toggle('text-red-600', isError);
            statusMessage.classList.toggle('text-green-600', !isError);
            setTimeout(() => {
                statusMessage.classList.remove('text-red-600', 'text-green-600');
                statusMessage.textContent = ''; 
            }, 5000);
        }

        // --- VARIABLES GLOBALES Y CONFIGURACIÓN ---
        let rawData = [];
        let equityChartInstance = null;

        // Referencias del DOM
        const csvFile = document.getElementById('csvFile');
        const runBacktestBtn = document.getElementById('runBacktestBtn');
        const buttonText = document.getElementById('buttonText');
        const statusMessage = document.getElementById('statusMessage');
        const finalCapitalEl = document.getElementById('finalCapital');
        const roiEl = document.getElementById('roi');
        const netProfitEl = document.getElementById('netProfit');
        const maxDrawdownEl = document.getElementById('maxDrawdown');
        const winRateEl = document.getElementById('winRate');
        const maxLossStreakEl = document.getElementById('maxLossStreak');
        const totalBetsEl = document.getElementById('totalBets');
        const winsLossesEl = document.getElementById('winsLosses');
        const leagueAnalysisEl = document.getElementById('leagueAnalysis');
        const streakAnalysisEl = document.getElementById('streakAnalysis');

        // --- CONFIGURACIÓN DE COLUMNAS (ADAPTAR ESTO) ---
        // CLAVE INTERNA (USADA POR EL MOTOR): 'NOMBRE EXACTO EN TU ARCHIVO CSV'
        // NOTA: 'Match' y 'Result FT' serán procesadas para obtener HomeTeam/AwayTeam y FTResult.
        const COLUMN_MAP = {
            'Date': 'Date',           
            'League': 'League',       
            'Match': 'Match',         // Columna que contiene "Equipo Local - Equipo Visitante"
            'ScoreFT': 'Result FT',   // Columna que contiene el marcador final (ej: 1-0)
            'OddH': 'Odd 1 PreMatch', // Cuota de la victoria local (1)
            'OddD': 'Odd X PreMatch', // Cuota del empate (X)
            'OddA': 'Odd 2 PreMatch', // Cuota de la victoria visitante (2)
        };
        // Las claves internas finales que el motor necesita
        const REQUIRED_INTERNAL_KEYS = ['Date', 'League', 'HomeTeam', 'AwayTeam', 'FTResult', 'OddH', 'OddD', 'OddA'];
        
        // --- FUNCIONES DE UTILIDAD Y CORE ---

        /**
         * Convierte el marcador final (ej: "1-0") al resultado de apuesta ('H', 'D', 'A').
         * @param {string} score - El marcador final (e.g., "1-0").
         * @returns {string} El resultado ('H', 'D', 'A', o una cadena vacía si es inválido).
         */
        function scoreToResult(score) {
            // Se espera el formato: "H-A" e.g., "1-0" o "3-2"
            if (!score || typeof score !== 'string' || !score.includes('-')) return '';
            
            // Usamos un regex flexible para manejar posibles espacios o formato de guion bajo (aunque asumimos guion)
            const parts = score.split(/-|_/).map(s => parseInt(s.trim()));
            
            if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) return '';

            const homeGoals = parts[0];
            const awayGoals = parts[1];

            if (homeGoals > awayGoals) return 'H'; // Home Win
            if (homeGoals < awayGoals) return 'A'; // Away Win
            return 'D'; // Draw
        }

        /**
         * Parsea el contenido de un archivo CSV a un array de objetos.
         * Mapea y deriva las columnas necesarias para el backtesting.
         * @param {string} csvText - Contenido crudo del archivo CSV.
         * @returns {Array<Object>} Array de objetos donde cada objeto es una fila.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim().length > 0);
            if (lines.length <= 1) { 
                showMessage('Error: El CSV está vacío o solo contiene la cabecera.');
                return [];
            }

            // 1. Obtener cabeceras y limpiarlas (trim)
            // Usamos el primer delimitador que encontremos (coma o punto y coma)
            const delimiter = lines[0].includes(';') ? ';' : ','; 
            const rawHeaders = lines[0].trim().split(delimiter).map(h => h.trim()); 

            // 2. Mapear las columnas requeridas (de CSV a índice)
            const headerIndexMap = {}; 
            const requiredCsvHeaders = Object.values(COLUMN_MAP);
            const missingCsvHeaders = [];

            for (const internalKey in COLUMN_MAP) {
                const csvHeaderName = COLUMN_MAP[internalKey]; 
                const index = rawHeaders.findIndex(rawHeader => rawHeader === csvHeaderName);
                
                if (index === -1) {
                    missingCsvHeaders.push(csvHeaderName);
                } else {
                    headerIndexMap[internalKey] = index;
                }
            }
            
            if (missingCsvHeaders.length > 0) {
                showMessage(`ERROR DE FORMATO: No se encontraron las columnas CSV necesarias: ${missingCsvHeaders.join(', ')}. Por favor, revise el COLUMN_MAP en el código para que coincida con sus encabezados.`, true);
                return [];
            }
            
            // 3. Procesar las filas de datos
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].trim().split(delimiter); 
                if (values.length !== rawHeaders.length) continue; 

                const row = {};
                let isValid = true;
                
                // Mapeo de valores crudos
                for (const internalKey in COLUMN_MAP) {
                    const index = headerIndexMap[internalKey];
                    const val = values[index] ? values[index].trim() : '';

                    // Convertir a número si es cuota (Odd)
                    if (internalKey.startsWith('Odd')) {
                        const numVal = parseFloat(val.replace(',', '.')); // Soporte para coma decimal
                        row[internalKey] = isNaN(numVal) ? null : numVal;
                        if (row[internalKey] === null) {
                            // Si la cuota no es un número, saltamos el partido
                            isValid = false;
                            break; 
                        }
                    } else {
                        row[internalKey] = val;
                    }
                }

                if (!isValid) continue; // Salta si la cuota era inválida

                // 4. Derivación de campos clave
                // Derivar HomeTeam y AwayTeam
                const matchParts = row.Match.split(' - ').map(p => p.trim());
                if (matchParts.length === 2) {
                    row.HomeTeam = matchParts[0];
                    row.AwayTeam = matchParts[1];
                } else {
                    // Si el formato del partido es incorrecto, saltar
                    continue; 
                }

                // Derivar FTResult (H, D, A)
                row.FTResult = scoreToResult(row.ScoreFT);

                // Si el resultado final no se pudo derivar (ej: marcador incompleto), saltar
                if (!row.FTResult) continue; 

                // Limpiar la fila final para solo tener las claves necesarias
                const finalRow = {};
                REQUIRED_INTERNAL_KEYS.forEach(key => {
                    finalRow[key] = row[key];
                });

                data.push(finalRow);
            }
            return data;
        }

        /**
         * LÓGICA DE LA ESTRATEGIA: Define si se realiza una apuesta en un partido y qué tipo.
         * ESTA FUNCIÓN ES LA QUE DEBE MODIFICAR PARA PROBAR SU SISTEMA.
         * @param {Object} match - El objeto del partido con todos los datos.
         * @returns {Object|null} Retorna {betType: 'H'|'D'|'A', odd: number} si hay apuesta, o null.
         */
        function applyStrategy(match) {
            // ESTRATEGIA DE EJEMPLO: Apostar a la Victoria Local (H) si la cuota es >= 2.50
            
            const requiredOdd = 2.50;

            if (match.OddH >= requiredOdd && typeof match.OddH === 'number') {
                return {
                    betType: 'H', // Apostamos a Home (Local)
                    odd: match.OddH // La cuota a la que apostamos
                };
            }

            // No se realiza apuesta
            return null; 
        }

        /**
         * Calcula el resultado de la apuesta.
         * @param {Object} match - El objeto del partido.
         * @param {Object} bet - El objeto de la apuesta ({betType, odd}).
         * @param {number} stake - El tamaño de la apuesta.
         * @returns {number} El beneficio/pérdida de la operación.
         */
        function calculateProfit(match, bet, stake) {
            const actualResult = match.FTResult; // H, D, A
            let isWin = false;

            // La propiedad FTResult debe contener 'H', 'D', o 'A'
            if (bet.betType === actualResult) {
                isWin = true;
            }

            return isWin ? stake * (bet.odd - 1) : -stake;
        }

        /**
         * Itera sobre los datos y aplica el backtesting.
         */
        function runBacktest() {
            if (rawData.length === 0) {
                showMessage('Por favor, cargue un archivo CSV válido y que contenga datos.');
                return;
            }

            const initialCapital = parseFloat(document.getElementById('initialCapital').value);
            const stakeSize = parseFloat(document.getElementById('stakeSize').value);
            const leagueFilter = document.getElementById('leagueFilter').value.toUpperCase().trim();
            const teamFilter = document.getElementById('teamFilter').value.toUpperCase().trim();

            if (isNaN(initialCapital) || initialCapital <= 0 || isNaN(stakeSize) || stakeSize <= 0) {
                 showMessage('El Capital Inicial y el Tamaño de Apuesta deben ser números positivos.');
                return;
            }

            // Inicialización de variables de backtesting
            let currentCapital = initialCapital;
            let peakCapital = initialCapital;
            let maxDrawdown = 0;
            let equityHistory = [initialCapital];
            let totalBets = 0;
            let wins = 0;
            let losses = 0;
            let currentLossStreak = 0;
            let maxLossStreak = 0;
            
            // Inicialización para el análisis por grupo
            const leagueStats = {};
            
            // ----------------------------------------------------
            // 1. APLICACIÓN DE FILTROS Y SIMULACIÓN
            // ----------------------------------------------------
            const filteredData = rawData.filter(match => {
                // Filtro por Liga
                if (leagueFilter && match.League && match.League.toUpperCase().indexOf(leagueFilter) === -1) {
                    return false;
                }
                // Filtro por Equipo (Local o Visitante)
                if (teamFilter && match.HomeTeam && match.AwayTeam && match.HomeTeam.toUpperCase().indexOf(teamFilter) === -1 && match.AwayTeam.toUpperCase().indexOf(teamFilter) === -1) {
                    return false;
                }
                return true;
            });


            filteredData.forEach(match => {
                const bet = applyStrategy(match);

                if (bet) {
                    totalBets++;
                    const profit = calculateProfit(match, bet, stakeSize);
                    currentCapital += profit;

                    // ------------------------------------
                    // Seguimiento de Métricas
                    // ------------------------------------
                    
                    // Ganadas/Perdidas y Rachas
                    if (profit > 0) {
                        wins++;
                        currentLossStreak = 0;
                    } else {
                        losses++;
                        currentLossStreak++;
                        if (currentLossStreak > maxLossStreak) {
                            maxLossStreak = currentLossStreak;
                        }
                    }

                    // Drawdown
                    equityHistory.push(currentCapital);
                    if (currentCapital > peakCapital) {
                        peakCapital = currentCapital;
                    }
                    const drawdown = peakCapital > 0 ? (peakCapital - currentCapital) / peakCapital : 0;
                    if (drawdown > maxDrawdown) {
                        maxDrawdown = drawdown;
                    }

                    // ------------------------------------
                    // 2. ANÁLISIS POR GRUPO (Ligas)
                    // ------------------------------------
                    const leagueName = match.League || 'Desconocida';
                    if (!leagueStats[leagueName]) {
                        leagueStats[leagueName] = { bets: 0, wins: 0, profit: 0, stakeSum: 0 };
                    }
                    leagueStats[leagueName].bets++;
                    leagueStats[leagueName].profit += profit;
                    leagueStats[leagueName].stakeSum += stakeSize;
                    if (profit > 0) {
                        leagueStats[leagueName].wins++;
                    }
                }
            });


            // ----------------------------------------------------
            // 4. CÁLCULO DE MÉTRICAS FINALES
            // ----------------------------------------------------
            
            const netProfit = currentCapital - initialCapital;
            const totalStake = totalBets * stakeSize;
            const roi = totalStake > 0 ? (netProfit / totalStake) * 100 : 0;
            const winRate = totalBets > 0 ? (wins / totalBets) * 100 : 0;

            const results = {
                initialCapital,
                finalCapital: currentCapital,
                netProfit,
                roi,
                maxDrawdown: maxDrawdown * 100, // En porcentaje
                totalBets,
                wins,
                losses,
                winRate,
                maxLossStreak,
                equityHistory,
                leagueStats,
            };

            // ----------------------------------------------------
            // 5. ANÁLISIS DE RACHAS RENTABLES (Condición Específica)
            // ----------------------------------------------------
            const streakResults = analyzeStreaks(filteredData, stakeSize);
            results.streakResults = streakResults;

            displayResults(results);
        }
        
        /**
         * Identifica rachas rentables y perdedoras basadas en la estrategia actual.
         */
        function analyzeStreaks(data, stake) {
            let currentProfitStreak = 0;
            let maxProfitStreak = 0;
            let currentLossStreak = 0;
            let maxLossStreak = 0;
            
            let totalProfit = 0;
            let totalBets = 0;

            for (const match of data) {
                const bet = applyStrategy(match); 
                
                if (bet) {
                    totalBets++;
                    const profit = calculateProfit(match, bet, stake);
                    totalProfit += profit;
                    
                    if (profit > 0) {
                        currentProfitStreak++;
                        currentLossStreak = 0;
                    } else {
                        currentLossStreak++;
                        currentProfitStreak = 0;
                    }

                    // Actualizar máximos
                    if (currentProfitStreak > maxProfitStreak) {
                        maxProfitStreak = currentProfitStreak;
                    }
                    if (currentLossStreak > maxLossStreak) {
                        maxLossStreak = currentLossStreak;
                    }
                }
            }
            
            return {
                maxProfitStreak,
                maxLossStreak,
                totalProfit,
                totalBets
            };
        }


        // --- FUNCIONES DE DISPLAY ---

        /**
         * Muestra los resultados en la interfaz.
         */
        function displayResults(results) {
            const formatter = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
            
            // 1. Métricas Clave
            finalCapitalEl.textContent = formatter.format(results.finalCapital);
            finalCapitalEl.classList.toggle('text-green-600', results.netProfit >= 0);
            finalCapitalEl.classList.toggle('text-red-600', results.netProfit < 0);

            roiEl.textContent = results.roi.toFixed(2) + ' %';
            roiEl.classList.toggle('text-green-600', results.roi >= 0);
            roiEl.classList.toggle('text-red-600', results.roi < 0);

            netProfitEl.textContent = formatter.format(results.netProfit);
            netProfitEl.classList.toggle('text-green-600', results.netProfit >= 0);
            netProfitEl.classList.toggle('text-red-600', results.netProfit < 0);

            maxDrawdownEl.textContent = results.maxDrawdown.toFixed(2) + ' %';
            winRateEl.textContent = results.winRate.toFixed(2) + ' %';
            maxLossStreakEl.textContent = results.maxLossStreak;
            totalBetsEl.textContent = results.totalBets;
            winsLossesEl.textContent = `${results.wins} / ${results.losses}`;

            // 2. Gráfico de Evolución de Capital
            updateChart(results.equityHistory);

            // 3. Análisis de Rachas Rentables
            const strategyDesc = results.streakResults.totalBets > 0 ? 
                `Resultados de la estrategia aplicada (${results.streakResults.totalBets} apuestas):` : 
                'No se realizaron apuestas con la estrategia actual (revisa `applyStrategy`).';

            streakAnalysisEl.innerHTML = `
                <p class="text-sm text-gray-800 font-medium">${strategyDesc}</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li class="font-medium text-green-700">Racha Ganadora Máxima: <span class="font-bold">${results.streakResults.maxProfitStreak}</span> apuestas consecutivas.</li>
                    <li class="font-medium text-red-700">Racha Perdedora Máxima: <span class="font-bold">${results.streakResults.maxLossStreak}</span> apuestas consecutivas.</li>
                </ul>
            `;
            
            // 4. Análisis por Ligas
            leagueAnalysisEl.innerHTML = '';
            const sortedLeagues = Object.entries(results.leagueStats).sort(([, a], [, b]) => b.bets - a.bets);

            if (sortedLeagues.length === 0) {
                 leagueAnalysisEl.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No se realizaron apuestas en ninguna liga con la estrategia actual.</td></tr>';
            } else {
                sortedLeagues.forEach(([league, stats]) => {
                    if (stats.bets === 0) return; // Omitir ligas sin apuestas
                    const winRate = (stats.wins / stats.bets) * 100;
                    const roi = (stats.profit / stats.stakeSum) * 100;
                    const profitText = formatter.format(stats.profit);

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition duration-150';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${league}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.bets}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${winRate >= 50 ? 'text-green-600' : 'text-red-600'}">${winRate.toFixed(2)} %</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${stats.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${profitText} (${roi.toFixed(2)}% ROI)</td>
                    `;
                    leagueAnalysisEl.appendChild(row);
                });
            }

            showMessage(`Análisis completado para ${results.totalBets} apuestas.`, false);
        }

        /**
         * Inicializa o actualiza el gráfico de Chart.js
         * @param {Array<number>} equityData - Historial de valores de capital.
         */
        function updateChart(equityData) {
            const ctx = document.getElementById('equityChart').getContext('2d');

            if (equityChartInstance) {
                equityChartInstance.data.labels = Array.from({ length: equityData.length }, (_, i) => i); // Índice 0 es capital inicial
                equityChartInstance.data.datasets[0].data = equityData;
                equityChartInstance.update();
                return;
            }

            // Inicialización
            equityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: equityData.length }, (_, i) => i),
                    datasets: [{
                        label: 'Capital (€)',
                        data: equityData,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Capital' }
                        },
                        x: {
                            title: { display: true, text: 'Punto de Tiempo (0=Inicial)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }

        // --- MANEJADORES DE EVENTOS ---

        // 1. Manejar la carga del archivo CSV
        csvFile.addEventListener('change', async (event) => {
            rawData = [];
            runBacktestBtn.disabled = true;
            buttonText.textContent = 'Cargando y Procesando Datos...';
            
            const file = event.target.files[0];
            if (!file) {
                buttonText.textContent = 'Cargar CSV para Ejecutar Backtesting';
                return;
            }

            try {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const csvText = e.target.result;
                    rawData = parseCSV(csvText);
                    
                    if (rawData.length > 0) {
                        runBacktestBtn.disabled = false;
                        buttonText.textContent = 'Ejecutar Backtesting';
                        showMessage(`¡Datos cargados! ${rawData.length} filas listas para el análisis.`, false);
                    } else {
                        // El error de parsing ya lo reportó parseCSV en statusMessage
                        runBacktestBtn.disabled = true;
                        buttonText.textContent = 'Corregir el COLUMN_MAP y Reintentar.';
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error al cargar el archivo:', error);
                showMessage('Error crítico al leer el archivo. Revise la consola del navegador.');
                runBacktestBtn.disabled = true;
                buttonText.textContent = 'Cargar CSV para Ejecutar Backtesting';
            }
        });

        // 2. Manejar la ejecución del backtesting
        runBacktestBtn.addEventListener('click', () => {
            if (rawData.length > 0) {
                buttonText.textContent = 'Ejecutando...';
                runBacktestBtn.disabled = true;
                
                // Pequeño timeout para permitir que la UI se actualice con el estado "Ejecutando..."
                setTimeout(() => {
                    try {
                        runBacktest();
                        runBacktestBtn.disabled = false;
                        buttonText.textContent = 'Volver a Ejecutar Backtesting';
                    } catch (error) {
                        console.error('Error durante la ejecución del backtesting:', error);
                        showMessage('Error en el motor de backtesting. Revisa la consola para más detalles.');
                        runBacktestBtn.disabled = false;
                        buttonText.textContent = 'Volver a Ejecutar Backtesting';
                    }
                }, 50);
            }
        });

        // Inicializar el gráfico al cargar la página (vacío)
        window.onload = () => {
            // Inicializamos el gráfico con el capital inicial por defecto
            updateChart([parseFloat(document.getElementById('initialCapital').value)]);
            // Mostrar un mensaje de bienvenida
            showMessage('Carga tu archivo CSV y define tu estrategia en el script para comenzar.', false);
        };
        
    </script>
</body>
</html>


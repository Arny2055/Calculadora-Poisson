<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Poisson con Mercados de Goles</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        h2 { color: #28a745; margin-top: 25px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        textarea, select, button { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        textarea { height: 200px; font-family: monospace; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .result-table, .prob-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td, .prob-table th, .prob-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .result-table th { background-color: #e9ecef; }
        .market-analysis { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .market-table th { background-color: #ffc107; } /* Color para destacar los mercados */
        .error { color: #dc3545; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>⚽ Calculadora de Poisson con Mercados de Goles</h1>

    <h2>1. Pegar Datos de la Liga</h2>
    <p>Pega aquí la tabla de estadísticas, incluyendo las dos filas de encabezado. La calculadora maneja la coma (,) como decimal.</p>
    <textarea id="data-input" placeholder="Pega la tabla completa aquí..."></textarea>
    <button onclick="parseAndLoadData()">Cargar y Analizar Datos</button>
    <p id="data-status" class="error">Aún no se ha cargado la tabla.</p>

    <h2>2. Seleccionar Partido</h2>
    <div class="grid">
        <div>
            <label for="local-team">Equipo Local</label>
            <select id="local-team" disabled>
                <option value="">Selecciona un equipo</option>
            </select>
        </div>
        <div>
            <label for="visitor-team">Equipo Visitante</label>
            <select id="visitor-team" disabled>
                <option value="">Selecciona un equipo</option>
            </select>
        </div>
    </div>
    <button onclick="calculateExpectedGoals()">Calcular Goles Esperados</button>
    <p id="calculation-error" class="error"></p>

    <div id="results" style="display: none;">
        <h2>3. Análisis del Partido</h2>
        
        <table class="result-table">
            <thead>
                <tr><th>Equipo</th><th>Factor Ataque</th><th>Factor Defensa</th><th>$\lambda$ (Goles Esperados)</th></tr>
            </thead>
            <tbody id="lambda-results">
            </tbody>
        </table>

        <h2>4. Probabilidades de Mercados de Goles</h2>
        <div class="market-analysis">
            <div>
                <h3>Over/Under (Más/Menos 2.5)</h3>
                <table class="prob-table market-table">
                    <thead><tr><th>Mercado</th><th>Probabilidad</th></tr></thead>
                    <tbody id="over-under-probabilities"></tbody>
                </table>
            </div>
            
            <div>
                <h3>Ambos Equipos Marcan (BTTS)</h3>
                <table class="prob-table market-table">
                    <thead><tr><th>Mercado</th><th>Probabilidad</th></tr></thead>
                    <tbody id="btts-probabilities"></tbody>
                </table>
            </div>
        </div>

        <h3>Probabilidad de Resultado Final (1X2)</h3>
        <table class="prob-table">
            <thead>
                <tr><th>Resultado</th><th>Probabilidad</th></tr>
            </thead>
            <tbody id="outcome-probabilities">
            </tbody>
        </table>

        <h3>Probabilidad de Marcador Exacto (Top 5)</h3>
        <table class="prob-table">
            <thead>
                <tr><th>Marcador</th><th>Probabilidad</th></tr>
            </thead>
            <tbody id="score-probabilities">
            </tbody>
        </table>
    </div>
</div>

<script>
    let leagueData = [];
    let GL_prom = 0; // Promedio Goles Local de la Liga
    let GV_prom = 0; // Promedio Goles Visitante de la Liga
    
    // Índices de las columnas necesarias en la tabla pegada (basado en tu formato)
    const COL_INDEXES = {
        'Team': 0, 
        'Prom. Goles locales Anotados': 4,
        'Prom. Goles locales Lanzados': 5, // Recibidos Local
        'Prom. Goles visitante Anotados': 7,
        'Prom. Goles visitante Lanzados': 8 // Recibidos Visitante
    };

    // Factorial Function
    const factorial = (n) => { if (n === 0) return 1; let result = 1; for (let i = 1; i <= n; i++) result *= i; return result; };

    // Poisson Probability Function
    const poisson = (k, lambda) => (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);


    // --- 1. FUNCIÓN DE CARGA Y PARSEO DE DATOS ---
    function parseAndLoadData() {
        const text = document.getElementById('data-input').value;
        const statusElement = document.getElementById('data-status');
        
        if (!text.trim()) {
            statusElement.textContent = 'Error: Por favor, pega la tabla de datos en el campo superior.';
            return;
        }

        try {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const dataLines = lines.slice(2); // Omitir las 2 líneas de encabezado
            leagueData = [];

            const delimiterRegex = /\s{2,}|\t/;

            dataLines.forEach(line => {
                const values = line.trim().split(delimiterRegex).filter(v => v !== '');
                
                if (values.length > COL_INDEXES['Prom. Goles visitante Lanzados']) {
                    let team = {};
                    team.Equipo = values[COL_INDEXES['Team']];
                    
                    // Asignar y convertir valores numéricos. Reemplazar ',' por '.' para parseFloat
                    team['Prom. Goles locales Anotados'] = parseFloat(values[COL_INDEXES['Prom. Goles locales Anotados']].replace(',', '.')) || 0;
                    team['Prom. Goles locales Lanzados'] = parseFloat(values[COL_INDEXES['Prom. Goles locales Lanzados']].replace(',', '.')) || 0;
                    team['Prom. Goles visitante Anotados'] = parseFloat(values[COL_INDEXES['Prom. Goles visitante Anotados']].replace(',', '.')) || 0;
                    team['Prom. Goles visitante Lanzados'] = parseFloat(values[COL_INDEXES['Prom. Goles visitante Lanzados']].replace(',', '.')) || 0;
                    
                    leagueData.push(team);
                }
            });

            if (leagueData.length === 0) {
                 statusElement.textContent = 'Error: No se encontraron datos válidos de equipos. Verifica que el formato sea correcto.';
                 return;
            }

            calculateLeagueAverages();
            populateTeamSelectors();

            statusElement.textContent = `✅ Datos cargados y analizados correctamente. ${leagueData.length} equipos disponibles.`;
        } catch (error) {
            statusElement.textContent = `Error al procesar los datos: ${error.message}. Verifica el formato pegado.`;
            console.error(error);
        }
    }
    
    // --- 2. FUNCIÓN PARA CÁLCULO DE PROMEDIOS DE LIGA ---
    function calculateLeagueAverages() {
        const totalTeams = leagueData.length;
        if (totalTeams === 0) return;

        let sumGLA = 0; 
        let sumGVA = 0; 

        leagueData.forEach(team => {
            sumGLA += team['Prom. Goles locales Anotados'];
            sumGVA += team['Prom. Goles visitante Anotados'];
        });

        GL_prom = sumGLA / totalTeams;
        GV_prom = sumGVA / totalTeams;
    }

    // --- 3. FUNCIÓN PARA LLENAR SELECTORES ---
    function populateTeamSelectors() {
        const localSelect = document.getElementById('local-team');
        const visitorSelect = document.getElementById('visitor-team');

        [localSelect, visitorSelect].forEach(select => {
            select.innerHTML = '<option value="">Selecciona un equipo</option>';
            leagueData.forEach(team => {
                const option = document.createElement('option');
                option.value = team.Equipo;
                option.textContent = team.Equipo;
                select.appendChild(option);
            });
            select.disabled = false;
        });
    }

    // --- 4. FUNCIÓN PRINCIPAL DE CÁLCULO (MODIFICADA) ---
    function calculateExpectedGoals() {
        const localTeamName = document.getElementById('local-team').value;
        const visitorTeamName = document.getElementById('visitor-team').value;
        const errorElement = document.getElementById('calculation-error');
        const resultsDiv = document.getElementById('results');

        if (GL_prom === 0 || GV_prom === 0) {
             errorElement.textContent = 'Error: Primero debes cargar los datos de la liga.';
             resultsDiv.style.display = 'none';
             return;
        }

        if (!localTeamName || !visitorTeamName || localTeamName === visitorTeamName) {
            errorElement.textContent = 'Por favor, selecciona dos equipos diferentes.';
            resultsDiv.style.display = 'none';
            return;
        }

        errorElement.textContent = '';

        const localTeam = leagueData.find(t => t.Equipo === localTeamName);
        const visitorTeam = leagueData.find(t => t.Equipo === visitorTeamName);

        // Cálculo de Factores de Fuerza e Lambda
        const GF_l = localTeam['Prom. Goles locales Anotados'] / GL_prom; 
        const GC_v = visitorTeam['Prom. Goles visitante Lanzados'] / GL_prom; 
        const GF_v = visitorTeam['Prom. Goles visitante Anotados'] / GV_prom;
        const GC_l = localTeam['Prom. Goles locales Lanzados'] / GV_prom; 

        const lambdaLocal = GL_prom * GF_l * GC_v;
        const lambdaVisitor = GV_prom * GF_v * GC_l;

        let probLocalWin = 0;
        let probDraw = 0;
        let probVisitorWin = 0;
        let probUnder2_5 = 0; // Probabilidad Menos de 2.5
        let probLocalNoScore = 0; // Probabilidad Local no anota (k=0)
        let probVisitorNoScore = 0; // Probabilidad Visitante no anota (k=0)
        let probZeroZero = 0; // Probabilidad 0-0
        let scoreProbabilities = [];
        
        const MAX_GOALS = 5;

        // Bucle principal para calcular probabilidades de marcadores
        for (let i = 0; i <= MAX_GOALS; i++) { // Goles Local
            const probL = poisson(i, lambdaLocal);
            if (i === 0) probLocalNoScore = probL; // Guardar P(L=0)

            for (let j = 0; j <= MAX_GOALS; j++) { // Goles Visitante
                const probV = poisson(j, lambdaVisitor);
                const matchProb = probL * probV;

                // 1. Probabilidades 1X2
                if (i > j) { probLocalWin += matchProb; } 
                else if (i === j) { probDraw += matchProb; } 
                else { probVisitorWin += matchProb; }

                // 2. Probabilidades Over/Under 2.5
                if (i + j < 3) {
                    probUnder2_5 += matchProb;
                }
                
                // 3. Probabilidades de Marcador (Solo los necesarios)
                if (i === 0 && j === 0) {
                    probZeroZero = matchProb; // Guardar P(0-0)
                    probVisitorNoScore = probV; // Guardar P(V=0)
                }

                // Guardar los marcadores (hasta 5-5)
                scoreProbabilities.push({ score: `${i} - ${j}`, prob: matchProb });
            }
        }
        
        // --- Cálculo de Mercados de Goles ---
        
        // Over/Under 2.5
        const probOver2_5 = 1.0 - probUnder2_5; // Asumiendo que la suma de todos los marcadores es ~1.0

        // Ambos Equipos Marcan (BTTS)
        // BTTS NO = P(L=0) + P(V=0) - P(0-0)
        const probBTTS_NO = probLocalNoScore + probVisitorNoScore - probZeroZero;
        const probBTTS_YES = 1.0 - probBTTS_NO;

        // Normalizar y redistribuir la probabilidad restante de los "Otros"
        const totalCalculatedProb = probLocalWin + probDraw + probVisitorWin;
        const remainingProb = 1.0 - totalCalculatedProb;

        if (remainingProb > 0.001) {
            const totalWeightedProb = probLocalWin + probDraw + probVisitorWin;
            if (totalWeightedProb > 0) {
                probLocalWin += remainingProb * (probLocalWin / totalWeightedProb);
                probDraw += remainingProb * (probDraw / totalWeightedProb);
                probVisitorWin += remainingProb * (probVisitorWin / totalWeightedProb);
            }
        }

        // Ordenar los marcadores más probables
        scoreProbabilities.sort((a, b) => b.prob - a.prob);


        // --- 5. MOSTRAR RESULTADOS EN EL DOM ---
        
        // Tabla Lambda
        document.getElementById('lambda-results').innerHTML = `
            <tr>
                <td>${localTeamName}</td>
                <td>${GF_l.toFixed(3)}</td>
                <td>${GC_v.toFixed(3)}</td>
                <td><strong>${lambdaLocal.toFixed(3)}</strong></td>
            </tr>
            <tr>
                <td>${visitorTeamName}</td>
                <td>${GF_v.toFixed(3)}</td>
                <td>${GC_l.toFixed(3)}</td>
                <td><strong>${lambdaVisitor.toFixed(3)}</strong></td>
            </tr>
        `;

        // Tabla Over/Under
        document.getElementById('over-under-probabilities').innerHTML = `
            <tr><td>Más de 2.5 Goles</td><td><strong>${(probOver2_5 * 100).toFixed(2)}%</strong></td></tr>
            <tr><td>Menos de 2.5 Goles</td><td>${(probUnder2_5 * 100).toFixed(2)}%</td></tr>
        `;
        
        // Tabla BTTS
        document.getElementById('btts-probabilities').innerHTML = `
            <tr><td>Ambos Marcan (Sí)</td><td><strong>${(probBTTS_YES * 100).toFixed(2)}%</strong></td></tr>
            <tr><td>Ambos Marcan (No)</td><td>${(probBTTS_NO * 100).toFixed(2)}%</td></tr>
        `;

        // Tabla 1X2
        document.getElementById('outcome-probabilities').innerHTML = `
            <tr><td>Gana ${localTeamName} (1)</td><td>${(probLocalWin * 100).toFixed(2)}%</td></tr>
            <tr><td>Empate (X)</td><td>${(probDraw * 100).toFixed(2)}%</td></tr>
            <tr><td>Gana ${visitorTeamName} (2)</td><td>${(probVisitorWin * 100).toFixed(2)}%</td></tr>
        `;

        // Tabla de Marcadores
        document.getElementById('score-probabilities').innerHTML = scoreProbabilities.slice(0, 5).map(item => 
            `<tr><td>${item.score}</td><td>${(item.prob * 100).toFixed(2)}%</td></tr>`
        ).join('');

        resultsDiv.style.display = 'block';
    }

    window.onload = function() {
        document.getElementById('data-status').textContent = 'Pega la tabla en el área de texto para empezar.';
    };
</script>

</body>
</html>

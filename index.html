<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson de Apuestas de FÃºtbol</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h2 { color: #333; text-align: center; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="number"] { width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .resultado { margin-top: 30px; padding: 15px; border: 2px solid #28a745; border-radius: 5px; background-color: #e9f7eb; }
        .resultado h3 { margin-top: 0; color: #28a745; }
        .probabilidad { margin-top: 10px; }
        .mercado-sugerido p { font-size: 1.1em; font-weight: bold; color: #d9534f; }
        /* Clases para resaltar la sugerencia */
        .sugerencia-over { color: #28a745; }
        .sugerencia-under { color: #007bff; }
        .sugerencia-aa { color: #f0ad4e; }
        .sugerencia-no-aa { color: #5bc0de; }
        .sugerencia-win { color: #d9534f; }
    </style>
</head>
<body>

<div class="container">
    <h2>Calculadora Poisson FÃºtbol âš½</h2>
    
    <form id="poisson-form">
        <fieldset>
            <legend>1. Datos Promedio de la Liga</legend>
            <label for="avg_gl_home_liga">Promedio Goles Local Liga (GL a favor) (ej: 1.55)</label>
            <input type="number" id="avg_gl_home_liga" value="1.55" step="0.01" required>

            <label for="avg_gv_away_liga">Promedio Goles Visita Liga (GV a favor) (ej: 1.15)</label>
            <input type="number" id="avg_gv_away_liga" value="1.15" step="0.01" required>
            
            <label for="porc_aa">Porcentaje de Ambos Anotan de la Liga (%) (ej: 55)</label>
            <input type="number" id="porc_aa" value="55" step="0.1" required>

            <label for="porc_over25">Porcentaje de Over 2.5 FT de la Liga (%) (ej: 50)</label>
            <input type="number" id="porc_over25" value="50" step="0.1" required>
        </fieldset>
        
        <fieldset>
            <legend>2. Datos del Equipo Local (Home)</legend>
            <label for="gf_local">GF Local (Goles a Favor en casa) (ej: 25)</label>
            <input type="number" id="gf_local" value="25" required>

            <label for="gc_local">GC Local (Goles en Contra en casa) (ej: 15)</label>
            <input type="number" id="gc_local" value="15" required>
            
            <label for="partidos_local">Partidos jugados como Local (ej: 10)</label>
            <input type="number" id="partidos_local" value="10" required>
        </fieldset>
        
        <fieldset>
            <legend>3. Datos del Equipo Visitante (Away)</legend>
            <label for="gf_visita">GF Visita (Goles a Favor fuera) (ej: 18)</label>
            <input type="number" id="gf_visita" value="18" required>
            
            <label for="gc_visita">GC Visita (Goles en Contra fuera) (ej: 22)</label>
            <input type="number" id="gc_visita" value="22" required>
            
            <label for="partidos_visita">Partidos jugados como Visita (ej: 10)</label>
            <input type="number" id="partidos_visita" value="10" required>
        </fieldset>
        
        <button type="submit">Calcular PredicciÃ³n</button>
    </form>

    <div id="resultado" class="resultado" style="display:none;">
        <h3>Resultado de la PredicciÃ³n ðŸ“Š</h3>
        <p><strong>Goles Esperados (Lambda):</strong></p>
        <p>Local ($\lambda_H$): <span id="lambda_home"></span></p>
        <p>Visita ($\lambda_A$): <span id="lambda_away"></span></p>
        
        <div class="probabilidad">
            <strong>Probabilidades Calculadas:</strong>
            <p>P(Over 2.5): <span id="prob_over25"></span></p>
            <p>P(Ambos Anotan): <span id="prob_aa"></span></p>
            <p>P(Local Gana - 1): <span id="prob_local"></span></p>
            <p>P(Empate - X): <span id="prob_empate"></span></p>
            <p>P(Visita Gana - 2): <span id="prob_visita"></span></p>
        </div>

        <div class="mercado-sugerido">
            <strong>Mercado Sugerido (Basado en la Liga):</strong>
            <p id="sugerencia"></p>
        </div>
    </div>
</div>

<script>
    document.getElementById('poisson-form').addEventListener('submit', function(event) {
        event.preventDefault();
        calcularPoisson();
    });

    // FunciÃ³n factorial optimizada
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    // FÃ³rmula de DistribuciÃ³n de Poisson: P(k; lambda)
    function poisson(k, lambda) {
        // Aseguramos que lambda sea positivo y no muy pequeÃ±o
        if (lambda <= 0) return (k === 0) ? 1 : 0;
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function calcularPoisson() {
        // 1. Obtener y parsear valores de entrada
        const avgGlHomeLiga = parseFloat(document.getElementById('avg_gl_home_liga').value);
        const avgGvAwayLiga = parseFloat(document.getElementById('avg_gv_away_liga').value);
        
        const gfLocal = parseInt(document.getElementById('gf_local').value);
        const gcLocal = parseInt(document.getElementById('gc_local').value);
        const partidosLocal = parseInt(document.getElementById('partidos_local').value);
        
        const gfVisita = parseInt(document.getElementById('gf_visita').value);
        const gcVisita = parseInt(document.getElementById('gc_visita').value);
        const partidosVisita = parseInt(document.getElementById('partidos_visita').value);

        const porcAA = parseFloat(document.getElementById('porc_aa').value) / 100;
        const porcOver25 = parseFloat(document.getElementById('porc_over25').value) / 100;
        
        // 2. Calcular Atributos Individuales (Promedios de Goles por partido)
        const avgGolesLocal = gfLocal / partidosLocal;
        const avgGcLocal = gcLocal / partidosLocal;
        const avgGolesVisita = gfVisita / partidosVisita;
        const avgGcVisita = gcVisita / partidosVisita;

        // 3. Calcular la Fuerza de Ataque y Defensa (Strength)
        
        // Fuerza de Ataque Local: (Promedio GF Local) / (Promedio GF Local de Liga)
        const attLocal = avgGolesLocal / avgGlHomeLiga;
        
        // Fuerza de Defensa Local: (Promedio GC Local) / (Promedio GF Visitante de Liga)
        const defLocal = avgGcLocal / avgGvAwayLiga; 

        // Fuerza de Ataque Visita: (Promedio GF Visita) / (Promedio GF Visita de Liga)
        const attVisita = avgGolesVisita / avgGvAwayLiga;
        
        // Fuerza de Defensa Visita: (Promedio GC Visita) / (Promedio GF Local de Liga)
        const defVisita = avgGcVisita / avgGlHomeLiga; 
        
        // 4. Calcular Goles Esperados ($\lambda$) para el partido
        // $\lambda_{Home} = Att_{Home} \times Promedio\ GF_{Liga\ Local} \times Def_{Away}$
        const lambdaHome = attLocal * avgGlHomeLiga * defVisita;
        // $\lambda_{Away} = Att_{Away} \times Promedio\ GF_{Liga\ Away} \times Def_{Home}$
        const lambdaAway = attVisita * avgGvAwayLiga * defLocal;

        // Criterios de Sugerencia
        const MARGEN = 0.05; // Margen de 5% para considerar una diferencia 'significativa'

        // 5. Calcular la Matriz de Probabilidades (hasta 6-6 para mayor precisiÃ³n)
        let prob_over25 = 0;
        let prob_aa = 0;
        let prob_local = 0;
        let prob_empate = 0;
        let prob_visita = 0;
        let prob_total_suma = 0; // Suma de todas las probabilidades calculadas (de 0-0 a 6-6)

        for (let home_goals = 0; home_goals <= 6; home_goals++) {
            for (let away_goals = 0; away_goals <= 6; away_goals++) {
                // Probabilidad de un marcador especÃ­fico
                const prob_score = poisson(home_goals, lambdaHome) * poisson(away_goals, lambdaAway);
                prob_total_suma += prob_score;

                // P(Over 2.5 Goles)
                if (home_goals + away_goals > 2) {
                    prob_over25 += prob_score;
                }
                
                // P(Ambos Anotan)
                if (home_goals >= 1 && away_goals >= 1) {
                    prob_aa += prob_score;
                }
                
                // P(Resultado Final 1X2)
                if (home_goals > away_goals) {
                    prob_local += prob_score;
                } else if (home_goals === away_goals) {
                    prob_empate += prob_score;
                } else {
                    prob_visita += prob_score;
                }
            }
        }
        
        // La suma de 1X2 debe ser la suma total de las probabilidades calculadas (0-6)
        // Normalizamos si la suma es ligeramente inferior a 1 (por truncar la matriz a 6-6)
        const factorNormalizacion = prob_total_suma > 0 ? 1 / prob_total_suma : 1;
        prob_local *= factorNormalizacion;
        prob_empate *= factorNormalizacion;
        prob_visita *= factorNormalizacion;
        
        // 6. Generar Sugerencia de Mercado
        let sugerencias = [];
        
        // Sugerencia Over/Under 2.5
        if (prob_over25 > porcOver25 + MARGEN) {
            sugerencias.push({ text: `**OVER 2.5 FT** (${(prob_over25 * 100).toFixed(2)}%)`, class: 'sugerencia-over' });
        } else if (prob_over25 < porcOver25 - MARGEN) {
            sugerencias.push({ text: `**UNDER 2.5 FT** (${((1 - prob_over25) * 100).toFixed(2)}%)`, class: 'sugerencia-under' });
        }
        
        // Sugerencia Ambos Anotan
        if (prob_aa > porcAA + MARGEN) {
            sugerencias.push({ text: `**AMBOS ANOTAN (SÃ­)** (${(prob_aa * 100).toFixed(2)}%)`, class: 'sugerencia-aa' });
        } else if (prob_aa < porcAA - MARGEN) {
            sugerencias.push({ text: `**AMBOS ANOTAN (No)** (${((1 - prob_aa) * 100).toFixed(2)}%)`, class: 'sugerencia-no-aa' });
        }
        
        // Sugerencia 1X2 (si es muy dominante)
        const max_1x2_prob = Math.max(prob_local, prob_empate, prob_visita);
        if (max_1x2_prob > 0.60) { // Mayor al 60%
            let ganador = max_1x2_prob === prob_local ? "VICTORIA LOCAL" : (max_1x2_prob === prob_visita ? "VICTORIA VISITANTE" : "EMPATE");
            let prob_ganador = (max_1x2_prob * 100).toFixed(2);
            sugerencias.push({ text: `**${ganador}** (${prob_ganador}%)`, class: 'sugerencia-win' });
        }

        let sugerenciaHTML = "No hay una sugerencia de valor clara (probabilidad cercana al promedio de la liga).";
        if (sugerencias.length > 0) {
            sugerenciaHTML = sugerencias.map(s => `<span class="${s.class}">${s.text}</span>`).join(" **Y** ");
        }

        // 7. Mostrar Resultados
        document.getElementById('lambda_home').textContent = lambdaHome.toFixed(3);
        document.getElementById('lambda_away').textContent = lambdaAway.toFixed(3);
        document.getElementById('prob_over25').textContent = `${(prob_over25 * 100).toFixed(2)}%`;
        document.getElementById('prob_aa').textContent = `${(prob_aa * 100).toFixed(2)}%`;
        document.getElementById('prob_local').textContent = `${(prob_local * 100).toFixed(2)}%`;
        document.getElementById('prob_empate').textContent = `${(prob_empate * 100).toFixed(2)}%`;
        document.getElementById('prob_visita').textContent = `${(prob_visita * 100).toFixed(2)}%`;
        document.getElementById('sugerencia').innerHTML = sugerenciaHTML;
        document.getElementById('resultado').style.display = 'block';
    }
</script>

</body>
</html>

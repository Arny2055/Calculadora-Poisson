<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Gur√∫ de las Apuestas | Quantum Engine</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0A1C16; --card: #182B24; --accent-gold: #FFD700; --accent-green: #3CB371;
            --text-main: #E0E7E4; --text-dim: #7F9C93; --border: #3D5C53; --safe-bottom: env(safe-area-inset-bottom);
            --highlight: #00BFFF; --fair-odds: #FFA500; --delete: #ff4d4d; --value-color: #00ff00;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: var(--text-main); 
            font-family: -apple-system, system-ui, sans-serif; 
            overflow: hidden; 
        }

        #setup-screen, #dashboard-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; overflow: hidden; 
        }

        .scroll-content { 
            flex: 1; overflow-y: auto; padding: 15px; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 140px; 
        }

        .header-box { text-align: center; padding: 15px 0; flex-shrink: 0; background: var(--bg); z-index: 10; border-bottom: 1px solid rgba(61, 92, 83, 0.3); }
        .header-box i.logo-icon { color: var(--accent-gold); font-size: 1.8rem; margin-bottom: 5px; display: block; }
        .header-box h2 { font-size: 1.4rem; color: var(--accent-gold); margin: 0; font-weight: 800; letter-spacing: 1px; }
        .header-box small { color: var(--accent-green); font-size: 0.7rem; text-transform: uppercase; }
        
        textarea { 
            width: 100%; height: 60px; background: var(--card); border: 1px solid var(--border); 
            border-radius: 10px; color: var(--accent-green); padding: 8px; font-size: 10px; 
            margin-bottom: 8px; outline: none; resize: none;
        }

        .db-panel { background: rgba(24, 43, 36, 0.5); border: 1px dashed var(--border); border-radius: 12px; padding: 12px; margin-bottom: 15px; }
        .db-input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .db-input-group input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: #fff; padding: 8px; font-size: 12px; }
        .db-btn { background: var(--accent-gold); color: #000; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }
        
        .league-selector-group { margin-top: 10px; }
        .league-selector-group select { background: var(--accent-green); color: #000; font-weight: bold; margin-bottom: 5px; cursor: pointer; width: 100%; padding: 10px; border-radius: 8px; border: none; }

        .select-container { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        select { 
            width: 100%; padding: 12px; background: var(--card); color: var(--text-main); 
            border: 1px solid var(--border); border-radius: 10px; font-size: 14px; outline: none; 
        }
        
        .btn-main { 
            width: 100%; background: linear-gradient(135deg, var(--accent-green), #4CAF50); 
            color: #000; border: none; padding: 16px; border-radius: 12px; 
            font-weight: bold; font-size: 1rem; cursor: pointer; margin-bottom: 10px;
        }

        #league-trend-box {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.75rem;
            display: none;
        }
        .trend-badge { background: var(--accent-gold); color: #000; padding: 2px 5px; border-radius: 4px; font-weight: 800; font-size: 0.65rem; }
        .min-odds-tag { color: var(--fair-odds); font-family: monospace; font-weight: bold; }
        
        .reliability-score {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 215, 0, 0.2);
            display: none;
            flex-direction: column;
            gap: 5px;
        }
        .score-row { display: flex; justify-content: space-between; align-items: center; }
        .score-bar { height: 6px; background: #333; width: 100%; border-radius: 3px; overflow: hidden; margin: 4px 0; }
        .score-fill { height: 100%; background: var(--accent-green); transition: width 0.8s ease-in-out; width: 0%; }

        .page { display: none; }
        .page.active { display: block; }
        
        .section-title { 
            font-size: 0.7rem; color: var(--accent-gold); text-transform: uppercase; 
            letter-spacing: 1px; margin: 15px 0 8px; border-left: 3px solid var(--accent-gold); padding-left: 8px; 
        }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; margin-bottom: 12px; }
        
        .row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid var(--border); gap: 5px; cursor: pointer;
        }
        .row:active { background: rgba(255,255,255,0.05); }
        .row:last-child { border: none; }
        .row span { color: var(--text-dim); font-size: 0.75rem; flex: 1; overflow: hidden; text-overflow: ellipsis; }
        
        .val-group { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .row b.pct { color: var(--accent-gold); font-size: 0.85rem; min-width: 45px; text-align: right; }
        .row b.odds { color: var(--fair-odds); font-size: 0.75rem; min-width: 35px; text-align: right; opacity: 0.8; }

        .row.target-range { background: rgba(0, 191, 255, 0.08); border-radius: 8px; margin: 0 -4px; padding: 12px 8px; }
        .row.target-range b.pct { color: var(--highlight); font-weight: 800; }

        #pick-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 3000; display: none;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content { background: var(--card); border: 1px solid var(--accent-gold); border-radius: 15px; width: 100%; max-width: 350px; padding: 20px; }
        .modal-content h3 { margin: 0 0 15px; font-size: 1rem; color: var(--accent-gold); text-align: center; }
        .modal-content select, .modal-content input { 
            width: 100%; padding: 12px; margin-bottom: 10px; background: var(--bg); 
            border: 1px solid var(--border); color: #fff; border-radius: 8px; font-size: 1rem; 
        }
        .share-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-share { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-wa { background: #25D366; }
        .btn-tg { background: #0088cc; }

        #fab-edit { 
            position: fixed; bottom: 85px; right: 20px; 
            width: 42px; height: 42px; 
            background: rgba(24, 43, 36, 0.8); 
            color: var(--accent-gold); 
            border: 1px solid var(--border); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 2000;
        }

        .tab-bar { 
            height: calc(65px + var(--safe-bottom)); background: var(--card); 
            border-top: 1px solid var(--border); display: flex; justify-content: space-around; 
            position: fixed; bottom: 0; width: 100%; padding-bottom: var(--safe-bottom); z-index: 1000; 
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); font-size: 10px; flex: 1; }
        .tab-item.active { color: var(--accent-gold); }
        .tab-item i { font-size: 1.1rem; margin-bottom: 4px; }

        #reset-toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            background: var(--accent-gold); color: #000; padding: 8px 16px; 
            border-radius: 20px; font-weight: bold; font-size: 12px; display: none; z-index: 4000; 
            animation: fadeInOut 1.5s; 
        }
        @keyframes fadeInOut { 0% {opacity:0} 20% {opacity:1} 80% {opacity:1} 100% {opacity:0} }
    </style>
</head>
<body>

    <div id="reset-toast">SISTEMA LISTO</div>

    <div id="pick-modal">
        <div class="modal-content">
            <i class="fa-solid fa-crown" style="color:var(--accent-gold); display:block; text-align:center; font-size:1.5rem; margin-bottom:10px;"></i>
            <h3 id="modal-market-name">Mercado</h3>
            <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: -10px; text-align: center;">Cuota Justa Quantum: <span id="modal-fair-odds" style="color:var(--fair-odds)"></span></p>
            
            <label style="font-size: 0.7rem; color: var(--accent-green);">CASA DE APUESTAS:</label>
            <select id="bookie-name">
                <option value="Bet365">Bet365</option>
                <option value="Codere">Codere</option>
                <option value="1xBet">1xBet</option>
                <option value="Betano">Betano</option>
                <option value="Stake">Stake</option>
                <option value="Pinnacle">Pinnacle</option>
                <option value="Caliente">Caliente</option>
                <option value="Otra">Otra Casa</option>
            </select>

            <label style="font-size: 0.7rem; color: var(--accent-green);">CUOTA ACTUAL:</label>
            <input type="number" step="0.01" id="bookie-odds" placeholder="Ej: 1.95">
            
            <div class="share-grid">
                <button class="btn-share btn-wa" onclick="sharePick('wa')"><i class="fab fa-whatsapp"></i> Enviar</button>
                <button class="btn-share btn-tg" onclick="sharePick('tg')"><i class="fab fa-telegram-plane"></i> Enviar</button>
            </div>
            <button onclick="closeModal()" style="width:100%; background:none; border:none; color:var(--text-dim); margin-top:15px; font-size:0.8rem; cursor:pointer;">CERRAR</button>
        </div>
    </div>

    <div id="setup-screen">
        <div class="header-box">
            <i class="fa-solid fa-bolt-lightning logo-icon"></i>
            <h2>EL GUR√ö DE LAS APUESTAS</h2>
            <small></small>
        </div>
        <div class="scroll-content">
            <div class="db-panel">
                <div class="db-input-group">
                    <input type="text" id="leagueName" placeholder="Nombre de la liga...">
                    <button class="db-btn" onclick="saveLeague()">GUARDAR</button>
                </div>
                <div class="league-selector-group">
                    <select id="savedLeagues" onchange="loadLeague()">
                        <option value="">-- Cargar Liga Guardada --</option>
                    </select>
                    <button class="db-btn" style="background:var(--delete); color:white; width:100%; margin-top:5px;" onclick="deleteLeague()">ELIMINAR SELECCIONADA</button>
                </div>
            </div>

            <textarea id="hIn" placeholder="Datos Tabla LOCAL..." oninput="uH()"></textarea>
            <textarea id="vIn" placeholder="Datos Tabla VISITA..." oninput="uV()"></textarea>
            <textarea id="sIn" placeholder="Promedios Liga (Caja Maestra)..." oninput="uS()"></textarea>
            
            <div class="select-container">
                <select id="sH"></select>
                <select id="sV"></select>
            </div>
            
            <button class="btn-main" onclick="calculate()">ANALIZAR PARTIDO</button>

            <div id="league-trend-box">
                <div style="color:var(--accent-gold); font-weight:800; margin-bottom:8px; display:flex; align-items:center; gap:5px;">
                    <i class="fa-solid fa-microchip"></i> ESC√ÅNER DE LIGA POISSON
                </div>
                <div id="trend-content"></div>
                
                <div class="reliability-score" id="reliability-container">
                    <div class="score-row">
                        <span style="font-size: 0.65rem; font-weight: bold; color: var(--text-dim);">FIABILIDAD DE MATRIZ:</span>
                        <b id="reliability-pct" style="font-size: 0.75rem;">0%</b>
                    </div>
                    <div class="score-bar"><div id="reliability-bar" class="score-fill"></div></div>
                    <p id="reliability-msg" style="font-size: 0.6rem; color: var(--text-dim); margin: 2px 0 0 0; font-style: italic;"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" style="display:none;">
        <div class="header-box">
            <h2>EL GUR√ö DE LAS APUESTAS</h2>
            <small id="match-title">An√°lisis Predictivo</small>
        </div>
        
        <div id="fab-edit" onclick="resetAnalysis()"><i class="fa-solid fa-pen"></i></div>
        
        <div class="scroll-content">
            <div id="p-win" class="page active">
                <div class="section-title">Resultado Final 1X2</div>
                <div class="card" id="card-1x2"></div>
                <div class="section-title">Empate No Acci√≥n (DNB)</div>
                <div class="card" id="card-dnb"></div>
                <div class="section-title">Doble Oportunidad</div>
                <div class="card" id="card-dc"></div>
            </div>

            <div id="p-goals" class="page">
                <div class="section-title">Goles Primera Mitad (HT)</div>
                <div class="card" id="card-ght"></div>
                <div class="section-title">Goles Tiempo Completo (FT)</div>
                <div class="card" id="card-gft"></div>
                <div class="section-title">Ambos Marcan (BTTS)</div>
                <div class="card" id="card-btts"></div>
            </div>

            <div id="p-handi" class="page">
                <div class="section-title">H√°ndicap Local</div>
                <div class="card" id="card-hl"></div>
                <div class="section-title">H√°ndicap Visita</div>
                <div class="card" id="card-hv"></div>
            </div>

            <div id="p-scores" class="page">
                <div class="section-title">Marcadores Probables (FT)</div>
                <div id="score-list"></div>
            </div>
        </div>

        <nav class="tab-bar">
            <div class="tab-item active" onclick="showPage('p-win', this)"><i class="fa-solid fa-trophy"></i><span>1X2</span></div>
            <div class="tab-item" onclick="showPage('p-goals', this)"><i class="fa-solid fa-futbol"></i><span>Goles</span></div>
            <div class="tab-item" onclick="showPage('p-handi', this)"><i class="fa-solid fa-balance-scale"></i><span>Hcap</span></div>
            <div class="tab-item" onclick="showPage('p-scores', this)"><i class="fa-solid fa-list-ol"></i><span>Result.</span></div>
        </nav>
    </div>

<script>
    let dH={}, dV={}, aH=1.58, aV=1.22;
    let selectedMarket = { name: "", fairOdds: 0, pct: 0 };
    let currentLeagueName = "Liga Desconocida";

    function saveLeague() {
        const name = document.getElementById('leagueName').value.trim();
        if(!name) { alert("Nombre requerido"); return; }
        const data = { h: document.getElementById('hIn').value, v: document.getElementById('vIn').value, s: document.getElementById('sIn').value };
        let db = JSON.parse(localStorage.getItem('guru_db') || '{}');
        db[name] = data;
        localStorage.setItem('guru_db', JSON.stringify(db));
        document.getElementById('leagueName').value = "";
        refreshLeagueList();
        showToast("LIGA GUARDADA");
    }

    function loadLeague() {
        const name = document.getElementById('savedLeagues').value;
        const db = JSON.parse(localStorage.getItem('guru_db') || '{}');
        const data = db[name];
        if(data) {
            currentLeagueName = name;
            document.getElementById('hIn').value = data.h;
            document.getElementById('vIn').value = data.v;
            document.getElementById('sIn').value = data.s;
            uH(); uV(); uS();
            showToast("DATOS CARGADOS");
        }
    }

    function deleteLeague() {
        const name = document.getElementById('savedLeagues').value;
        if(!name) return;
        if(confirm(`‚ö†Ô∏è ¬øEliminar "${name}"?`)) {
            let db = JSON.parse(localStorage.getItem('guru_db') || '{}');
            delete db[name];
            localStorage.setItem('guru_db', JSON.stringify(db));
            refreshLeagueList();
            showToast("ELIMINADA");
        }
    }

    function refreshLeagueList() {
        const sel = document.getElementById('savedLeagues');
        sel.innerHTML = '<option value="">-- Cargar Liga Guardada --</option>';
        const db = JSON.parse(localStorage.getItem('guru_db') || '{}');
        Object.keys(db).sort().forEach(name => sel.add(new Option(name, name)));
    }

    function openShare(name, fairOdds, pctValue) {
        selectedMarket = { name, fairOdds, pct: pctValue };
        document.getElementById('modal-market-name').innerText = name;
        document.getElementById('modal-fair-odds').innerText = fairOdds;
        document.getElementById('pick-modal').style.display = 'flex';
        document.getElementById('bookie-odds').value = "";
    }

    function closeModal() { document.getElementById('pick-modal').style.display = 'none'; }

    function sharePick(platform) {
        const bookieOddsInput = document.getElementById('bookie-odds').value;
        const bookieOdds = parseFloat(bookieOddsInput);
        const bookieName = document.getElementById('bookie-name').value;
        const tH = document.getElementById('sH').value;
        const tV = document.getElementById('sV').value;
        
        let message = `üèÜ *EL GUR√ö DE LAS APUESTAS*\n`;
        message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        message += `üèü *LIGA:* ${currentLeagueName}\n`;
        message += `‚öΩÔ∏è *PARTIDO:* ${tH} vs ${tV}\n\n`;
        message += `üéØ *PICK:* ${selectedMarket.name}\n`;
        message += `üìä Probabilidad: ${selectedMarket.pct.toFixed(1)}%\n`;
        message += `‚öñÔ∏è Cuota Justa: ${selectedMarket.fairOdds}\n`;
        
        if(!isNaN(bookieOdds)) {
            const val = ((bookieOdds / selectedMarket.fairOdds) - 1) * 100;
            const probCasa = (1 / bookieOdds);
            const probContrariaQuantum = (1 - (selectedMarket.pct / 100));
            let estimatedOverround = ((probCasa + probContrariaQuantum) - 1) * 100;
            message += `üí∞ *CUOTA (${bookieName}):* ${bookieOdds.toFixed(2)}\n`;
            if(estimatedOverround < 0) message += `üìà Margen de Valor: +${Math.abs(estimatedOverround).toFixed(2)}%\n`;
            else message += `üìâ Overround Casa: ${estimatedOverround.toFixed(2)}%\n`;
            if(val > 0) message += `üî• Valor Detectado: +${val.toFixed(1)}%\n`;
        }
        
        message += `\n`;
        const encoded = encodeURIComponent(message);
        const url = platform === 'wa' ? `https://api.whatsapp.com/send?text=${encoded}` : `https://t.me/share/url?url=${encoded}`;
        window.open(url, '_blank');
        closeModal();
    }

    function showToast(txt) {
        const t = document.getElementById('reset-toast');
        t.innerText = txt; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1200);
    }

    function resetAnalysis(){ 
        document.getElementById('dashboard-screen').style.display='none';
        document.getElementById('setup-screen').style.display='flex';
    }

    window.onload = function() { refreshLeagueList(); };

    function ext(t) {
        const o={};
        t.split('\n').forEach(l => {
            const m = l.trim().match(/^(\d+)\s+(.+?)\s+(\d+)\s+\d+\s+\d+\s+\d+\s+(\d+)\s+(\d+)/);
            if(m) { const gp=parseInt(m[3]); if(gp>0) o[m[2].trim()]={f:parseInt(m[4])/gp, a:parseInt(m[5])/gp}; }
        });
        return o;
    }

    function uH(){ dH=ext(document.getElementById('hIn').value); fill(); }
    function uV(){ dV=ext(document.getElementById('vIn').value); fill(); }
    
    function uS(){
        const t = document.getElementById('sIn').value;
        
        // EXTRACCI√ìN DE PROMEDIOS PARA POISSON DESDE LA CAJA 3
        const hm = t.match(/Home goals per match:\s*([\d.]+)/);
        const am = t.match(/Away goals per match:\s*([\d.]+)/);
        
        // EXTRACCI√ìN DE ESTAD√çSTICAS REALES DE LA LIGA DESDE LA CAJA 3 PARA COMPARAR
        const realH = t.match(/Home win percentage:\s*([\d.]+)/);
        const realD = t.match(/Draw percentage:\s*([\d.]+)/);
        const realV = t.match(/Away win percentage:\s*([\d.]+)/);

        if(hm && am) {
            aH = parseFloat(hm[1]); 
            aV = parseFloat(am[1]);
            
            let dataReal = null;
            if(realH && realD && realV) {
                dataReal = {
                    h: parseFloat(realH[1]) / 100,
                    d: parseFloat(realD[1]) / 100,
                    v: parseFloat(realV[1]) / 100
                };
            }
            // Ejecutar comparaci√≥n y an√°lisis de tendencia bas√°ndose solo en los datos de esta caja
            analyzeLeagueTrend(aH, aV, dataReal);
        }
    }

    function analyzeLeagueTrend(lh, lv, real) {
        let pH=0, pD=0, pV=0, ov25=0, btts=0;
        // Calculamos el Poisson Te√≥rico de la liga bas√°ndonos en sus promedios
        for(let i=0; i<=10; i++) {
            for(let j=0; j<=10; j++) {
                let p = poi(i, lh) * poi(j, lv);
                if(i>j) pH += p; else if(i===j) pD += p; else pV += p;
                if((i+j) > 2.5) ov25 += p;
                if(i>0 && j>0) btts += p;
            }
        }
        
        document.getElementById('league-trend-box').style.display = 'block';
        const trendContent = document.getElementById('trend-content');
        const cMin = (p) => p > 0 ? (1 / p).toFixed(2) : "0.00";

        let apto = [];
        if(pH > 0.45) apto.push(`<span class="trend-badge">LOCAL</span> C. M√≠nima: <span class="min-odds-tag">${cMin(pH)}</span>`);
        if(ov25 > 0.50) apto.push(`<span class="trend-badge">OVER 2.5</span> C. M√≠nima: <span class="min-odds-tag">${cMin(ov25)}</span>`);
        if(btts > 0.52) apto.push(`<span class="trend-badge">BTTS</span> C. M√≠nima: <span class="min-odds-tag">${cMin(btts)}</span>`);
        if(pD > 0.28) apto.push(`<span class="trend-badge">EMPATE</span> C. M√≠nima: <span class="min-odds-tag">${cMin(pD)}</span>`);
        if(apto.length === 0) apto.push("Liga equilibrada.");
        trendContent.innerHTML = apto.join('<br><div style="margin-top:6px;"></div>');

        const relCont = document.getElementById('reliability-container');
        if(real) {
            relCont.style.display = 'flex';
            // COMPARACI√ìN DIRECTA: Poisson (Goles de caja 3) vs Realidad (Estad√≠sticas de caja 3)
            const diff = Math.abs(pH - real.h) + Math.abs(pD - real.d) + Math.abs(pV - real.v);
            let reliability = Math.max(0, 100 - (diff * 250)); 
            
            const rBar = document.getElementById('reliability-bar');
            const rPct = document.getElementById('reliability-pct');
            const rMsg = document.getElementById('reliability-msg');
            
            rBar.style.width = reliability + '%';
            rPct.innerText = reliability.toFixed(1) + '%';
            
            if(reliability > 85) {
                rPct.style.color = 'var(--value-color)';
                rBar.style.background = 'var(--value-color)';
                rMsg.innerText = "La liga se adapta perfectamente a Poisson.";
            } else if(reliability < 65) {
                rPct.style.color = 'var(--delete)';
                rBar.style.background = 'var(--delete)';
                rMsg.innerText = "Desviaci√≥n alta detectada en los resultados.";
            } else {
                rPct.style.color = 'var(--accent-gold)';
                rBar.style.background = 'var(--accent-gold)';
                rMsg.innerText = "Fiabilidad moderada.";
            }
        } else {
            relCont.style.display = 'none';
        }
    }

    function fill(){
        const sH=document.getElementById('sH'), sV=document.getElementById('sV');
        sH.innerHTML=sV.innerHTML="";
        Object.keys(dH).sort().forEach(t=>sH.add(new Option(t,t)));
        Object.keys(dV).sort().forEach(t=>sV.add(new Option(t,t)));
    }

    function poi(k,l){ 
        if(l <= 0) return k === 0 ? 1 : 0;
        let f=1; for(let i=2; i<=k; i++) f*=i; 
        return (Math.pow(l,k)*Math.exp(-l))/f; 
    }

    function getRow(label, prob) {
        const p = prob * 100;
        const odds = p > 0 ? (100 / p).toFixed(2) : '0.00';
        const isHighlight = p >= 55 && p <= 65;
        return `
            <div class="row ${isHighlight ? 'target-range' : ''}" onclick="openShare('${label}', ${odds}, ${p})">
                <span>${label}</span>
                <div class="val-group">
                    <b class="odds">${odds}</b>
                    <b class="pct">${p.toFixed(1)}%</b>
                </div>
            </div>`;
    }

    function showPage(id, el){
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
        document.querySelector('#dashboard-screen .scroll-content').scrollTop = 0;
    }

    function calculate(){
        const tH=document.getElementById('sH').value, tV=document.getElementById('sV').value;
        if(!dH[tH] || !dV[tV]) return;
        document.getElementById('match-title').innerText = `${tH} vs ${tV}`;
        const xH = (dH[tH].f/aH)*(dV[tV].a/aH)*aH;
        const xV = (dV[tV].f/aV)*(dH[tH].a/aV)*aV;
        const xH_ht = xH * 0.5; const xV_ht = xV * 0.5;
        
        let pH=0, pD=0, pV=0, ov15=0, ov25=0, ov35=0, ov05ht=0, ov15ht=0, haM25=0, haM15=0, haP05=0, haP15=0, vaM25=0, vaM15=0, vaP05=0, vaP15=0, sc=[];
        let pE = Array(13).fill(0); 
        for(let i=0; i<=12; i++){
            for(let j=0; j<=12; j++){
                let p = poi(i,xH)*poi(j,xV);
                if(i>j) pH+=p; else if(i===j) pD+=p; else pV+=p;
                let tot = i+j; if(tot < 13) pE[tot] += p;
                if(tot>1.5) ov15+=p; if(tot>2.5) ov25+=p; if(tot>3.5) ov35+=p;
                if(i-j > 2.5) haM25+=p; if(i-j > 1.5) haM15+=p; if(i-j > -0.5) haP05+=p; if(i-j > -1.5) haP15+=p;
                if(j-i > 2.5) vaM25+=p; if(j-i > 1.5) vaM15+=p; if(j-i > -0.5) vaP05+=p; if(j-i > -1.5) vaP15+=p;
                if(i<=5 && j<=5) sc.push({s:`${i} - ${j}`, p:p});
                let p_ht = poi(i, xH_ht)*poi(j, xV_ht);
                if((i+j)>0.5) ov05ht += p_ht; if((i+j)>1.5) ov15ht += p_ht;
            }
        }
        function getAO(line) { 
            if(line % 1 === 0) { 
                let win=0, loss=0;
                for(let k=line+1; k<13; k++) win+=pE[k];
                for(let k=0; k<line; k++) loss+=pE[k];
                return win / (win + loss);
            } else if(line % 1 === 0.25) { 
                let wf=0; for(let k=Math.floor(line)+1; k<13; k++) wf+=pE[k];
                return wf + (pE[Math.floor(line)] * 0.5);
            } else { 
                let wf=0; for(let k=Math.ceil(line); k<13; k++) wf+=pE[k];
                return wf + (pE[Math.floor(line)] * 0.5);
            }
        }
        document.getElementById('setup-screen').style.display='none';
        document.getElementById('dashboard-screen').style.display='flex';
        document.getElementById('card-1x2').innerHTML = getRow('Local (1)', pH) + getRow('Empate (X)', pD) + getRow('Visita (2)', pV);
        let dnbH = (pH + pV) > 0 ? pH / (pH + pV) : 0.5;
        document.getElementById('card-dnb').innerHTML = getRow('Local DNB', dnbH) + getRow('Visita DNB', 1-dnbH);
        document.getElementById('card-dc').innerHTML = getRow('1X', pH+pD) + getRow('X2', pV+pD) + getRow('12', pH+pV);
        const btts_ht = (1 - poi(0, xH_ht)) * (1 - poi(0, xV_ht));
        document.getElementById('card-ght').innerHTML = getRow('+ 0.5 Goles HT', ov05ht) + getRow('+ 1.5 Goles HT', ov15ht) + getRow('Ambos Marcan HT', btts_ht);
        const btts_si = (1 - poi(0, xH)) * (1 - poi(0, xV));
        document.getElementById('card-gft').innerHTML = getRow('+ 1.5 Goles', ov15) + getRow('+ 1.75 Goles', getAO(1.75)) + getRow('+ 2.0 Goles', getAO(2.0)) + getRow('+ 2.25 Goles', getAO(2.25)) + getRow('+ 2.5 Goles', ov25) + getRow('+ 2.75 Goles', getAO(2.75)) + getRow('+ 3.0 Goles', getAO(3.0)) + getRow('+ 3.25 Goles', getAO(3.25)) + getRow('+ 3.5 Goles', ov35) + getRow('+ 3.75 Goles', getAO(3.75));
        document.getElementById('card-btts').innerHTML = getRow('BTTS S√ç', btts_si) + getRow('BTTS NO', 1-btts_si);
        document.getElementById('card-hl').innerHTML = getRow('Local -2.5', haM25) + getRow('Local -1.5', haM15) + getRow('Local -0.5', pH) + getRow('Local 0.0', dnbH) + getRow('Local +0.5', haP05) + getRow('Local +1.5', haP15);
        document.getElementById('card-hv').innerHTML = getRow('Visita -2.5', vaM25) + getRow('Visita -1.5', vaM15) + getRow('Visita -0.5', pV) + getRow('Visita 0.0', 1-dnbH) + getRow('Visita +0.5', vaP05) + getRow('Visita +1.5', vaP15);
        sc.sort((a,b)=>b.p-a.p);
        let h=""; sc.slice(0,15).forEach(m=>{ h+=getRow(m.s, m.p); });
        document.getElementById('score-list').innerHTML=`<div class="card">${h}</div>`;
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pinnacle — Overround + EV (1X2 & OU) • Futurista</title>
<style>
:root{
  --bg:#05070c;--bg2:#0a0f19;--panel:rgba(16,22,33,.65);--panel-solid:#121a29;
  --text:#eaf0ff;--muted:#9aa7ba;--border:#273246;--accent:#7fb3ff;--accent2:#67e3a1;--warn:#d6a84a;--bad:#d66262;
  --shadow:0 20px 60px rgba(0,0,0,.45)
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(1200px 600px at 10% -10%, #1b2d52 0%, transparent 60%),radial-gradient(1000px 650px at 110% 10%, #113d2c 0%, transparent 55%),radial-gradient(800px 450px at 50% 110%, #1f183a 0%, transparent 55%),linear-gradient(180deg,var(--bg),var(--bg2))}
header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(90deg,rgba(10,16,28,.6),rgba(10,16,28,.35));border-bottom:1px solid var(--border)}
.head{max-width:1180px;margin:0 auto;padding:18px 20px;display:flex;align-items:center;gap:14px}
.logo{width:44px;height:44px;border-radius:14px;background:radial-gradient(160% 120% at 30% 20%, #8fc2ff 0%, #2b84ff 35%, #2662ff00 70%),radial-gradient(140% 120% at 75% 60%, #67e3a1 0%, #29c17a 40%, #2bff5500 75%);box-shadow:0 0 0 1px #2b5aa3,0 10px 28px rgba(43,132,255,.45),inset 0 0 40px rgba(255,255,255,.06)}
h1{margin:0;font-size:20px;font-weight:900} .sub{font-size:12px;color:var(--muted)}
main{max-width:1180px;margin:26px auto;padding:0 20px;display:grid;gap:22px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
.card .bar{height:3px;background:linear-gradient(90deg,#2b84ff,#69e3a2,#9e7bff,#2b84ff);opacity:.9;background-size:200% 100%;animation:flow 8s linear infinite}
@keyframes flow{0%{background-position:0 0}100%{background-position:200% 0}}
.pad{padding:18px}
h2{margin:0 0 12px;font-size:16px;font-weight:800;color:#cfe1ff}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
input[type="number"],textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#0e1523;color:#eaf0ff;outline:none;font-size:14px}
textarea{min-height:150px;resize:vertical}
input[type="number"]:focus,textarea:focus{border-color:#3168ff;box-shadow:0 0 0 5px rgba(49,104,255,.12)}
.btn{padding:10px 14px;border-radius:999px;border:1px solid #2a3a55;background:transparent;color:#cfe1ff;font-weight:700;font-size:13px;cursor:pointer}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
.kpi{background:linear-gradient(180deg,rgba(20,28,44,.85),rgba(14,20,35,.85));border:1px solid var(--border);border-radius:14px;padding:12px}
.k{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.v{font-size:18px;font-weight:900;margin-top:6px;font-family:ui-monospace,Menlo,Consolas,monospace}
table{width:100%;border-collapse:collapse;border-radius:14px;overflow:hidden}
thead th{font-size:11px;color:#c5cee0;text-transform:uppercase;letter-spacing:.5px;background:#0f1726;border-bottom:1px solid var(--border);padding:10px;text-align:right}
thead th:first-child{text-align:left}
tbody td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-size:13px}
tbody td:first-child{text-align:left}
.badge{display:inline-block;margin:6px 6px 0 0;padding:4px 8px;border-radius:999px;border:1px solid #2b3a56;background:#0d1422;color:#cfe1ff;font-size:11px}
.badge-good{border-color:#2f9e6d;background:rgba(47,158,109,.12)}
.badge-warn{border-color:#d6a84a;background:rgba(214,168,74,.10)}
.badge-bad{border-color:#d66262;background:rgba(214,98,98,.10)}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="head">
    <div class="logo"></div>
    <div>
      <h1>Pinnacle — Overround + EV</h1>
      <div class="sub">1X2 y Over/Under (apertura & cierre) • EV% y Kelly¼</div>
    </div>
  </div>
</header>

<main>
  <!-- Entrada -->
  <section class="card">
    <div class="bar"></div>
    <div class="pad">
      <h2>Datos & Probabilidades del modelo (opcional)</h2>
      <div class="grid">
        <div>
          <label>JSON de partidos (Football-Data)</label>
          <textarea id="jsonIn" placeholder='Pega aquí el array JSON de partidos…'></textarea>
        </div>
        <div>
          <label>Prob. modelo 1X2 (sumar 1)</label>
          <div class="grid">
            <div><input id="pH" type="number" step="0.001" min="0" max="1" placeholder="pH ej. 0.52"/></div>
            <div><input id="pD" type="number" step="0.001" min="0" max="1" placeholder="pD ej. 0.25"/></div>
            <div><input id="pA" type="number" step="0.001" min="0" max="1" placeholder="pA ej. 0.23"/></div>
          </div>
          <label style="margin-top:10px">Prob. modelo OU (sumar 1)</label>
          <div class="grid">
            <div><input id="pOver" type="number" step="0.001" min="0" max="1" placeholder="pOver ej. 0.56"/></div>
            <div><input id="pUnder" type="number" step="0.001" min="0" max="1" placeholder="pUnder ej. 0.44"/></div>
            <div><input id="ouLabel" type="text" placeholder="Etiqueta OU (ej. >2.5)"/></div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="loadSample">Cargar ejemplo</button>
        <button class="btn" id="processBtn">Procesar</button>
      </div>
      <div id="badges" class="small"></div>
    </div>
  </section>

  <!-- 1X2 -->
  <section class="card">
    <div class="bar"></div>
    <div class="pad">
      <h2>1X2 — Pinnacle (apertura y cierre)</h2>
      <div class="kpis" id="kpi1x2"></div>
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Home</th><th>Away</th>
            <th>PSH</th><th>PSD</th><th>PSA</th><th>Overround</th>
            <th>Fair H</th><th>Fair D</th><th>Fair A</th>
            <th>EV H</th><th>EV D</th><th>EV A</th><th>Kelly¼ mejor</th>
            <th>PSCH</th><th>PSCD</th><th>PSCA</th><th>Overround C</th>
          </tr>
        </thead>
        <tbody id="tbody1x2"><tr><td colspan="18" style="text-align:center;color:#9aa7ba;padding:16px">Sin datos</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- OU -->
  <section class="card">
    <div class="bar"></div>
    <div class="pad">
      <h2>Over/Under — Pinnacle (apertura y cierre)</h2>
      <div class="kpis" id="kpiOU"></div>
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Home</th><th>Away</th><th>Línea</th>
            <th>P&gt;</th><th>P&lt;</th><th>Overround</th>
            <th>Fair &gt;</th><th>Fair &lt;</th>
            <th>EV &gt;</th><th>EV &lt;</th><th>Kelly¼ mejor</th>
            <th>PC&gt;</th><th>PC&lt;</th><th>Overround C</th>
          </tr>
        </thead>
        <tbody id="tbodyOU"><tr><td colspan="15" style="text-align:center;color:#9aa7ba;padding:16px">Sin datos</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const pct = x => isFinite(x)?(100*x).toFixed(2)+'%':'—';
  const fmt = x => (x==null||!isFinite(x))?'—':(+x).toFixed(2);
  const sum = arr => arr.reduce((a,b)=>a+b,0);

  function overroundFromOdds(oddsArr){
    if(oddsArr.some(o=>!o||o<=1||!isFinite(o))) return null;
    return oddsArr.map(o=>1/o).reduce((a,b)=>a+b,0)-1;
    // (pimp sum) - 1
  }
  function fairProbsFromOdds(oddsArr){
    const inv=oddsArr.map(o=>1/o); const S=sum(inv);
    return inv.map(v=>v/S);
  }
  function evDecimal(p,odds){ if(!odds||odds<=1||!isFinite(odds)||p==null) return null; return p*odds-1; }
  function kellyQuarter(p,odds){ if(!odds||odds<=1||p==null) return null; const b=odds-1; const f=Math.max(0, ((p*odds-1)/b)); return f*0.25; }

  function bestKelly(pArr,oddsArr,labels){
    let best = {label:'—', val:null};
    for(let i=0;i<oddsArr.length;i++){
      const k = kellyQuarter(pArr?.[i], oddsArr[i]);
      if(k!=null && (best.val==null || k>best.val)) best={label:labels[i], val:k};
    }
    return best.val==null ? '—' : `${best.label} ${pct(best.val)}`;
  }

  // Detecta claves OU: soporta P>2.5 / P<2.5 y también P>2 / P<2
  function findOUKeys(row){
    const keys=Object.keys(row);
    const overKey = keys.find(k=>/^P>/.test(k)) || null;
    const underKey= keys.find(k=>/^P</.test(k)) || null;
    const overKeyC= keys.find(k=>/^PC>/.test(k)) || null;
    const underKeyC= keys.find(k=>/^PC</.test(k)) || null;
    // línea desde etiqueta (ej. P>2.5) o del input
    let line=null;
    if(overKey){ const m=overKey.match(/^P>(.+)$/); if(m) line=m[1]; }
    if(!line && $('#ouLabel').value.trim()) line=$('#ouLabel').value.trim();
    return {overKey,underKey,overKeyC,underKeyC,line};
  }

  function process(){
    // parse JSON
    let data=[];
    try{
      const raw=$('#jsonIn').value.trim();
      if(!raw){ alert('Pega el JSON de partidos.'); return; }
      data = JSON.parse(raw);
      if(!Array.isArray(data)) throw new Error('El JSON debe ser un array');
    }catch(e){ alert('JSON inválido: '+e.message); return; }

    // probabilidades modelo
    const pH = parseFloat($('#pH').value), pD=parseFloat($('#pD').value), pA=parseFloat($('#pA').value);
    const pOver=parseFloat($('#pOver').value), pUnder=parseFloat($('#pUnder').value);
    const hasModel1x2 = [pH,pD,pA].every(x=>isFinite(x)) && Math.abs(pH+pD+pA-1)<1e-6;
    const hasModelOU  = [pOver,pUnder].every(x=>isFinite(x)) && Math.abs(pOver+pUnder-1)<1e-6;

    // --- 1X2 ---
    let rows1x2='';
    let cnt1x2=0, orSum=0, orCSum=0;
    data.forEach(r=>{
      const PSH=+r.PSH, PSD=+r.PSD, PSA=+r.PSA;
      const PSCH=+r.PSCH, PSCD=+r.PSCD, PSCA=+r.PSCA;

      const haveOpen = [PSH,PSD,PSA].every(o=>o>1);
      const haveClose= [PSCH,PSCD,PSCA].every(o=>o>1);
      if(!haveOpen && !haveClose) return;

      const or = haveOpen ? overroundFromOdds([PSH,PSD,PSA]) : null;
      const orC= haveClose? overroundFromOdds([PSCH,PSCD,PSCA]) : null;

      let fairH='—', fairD='—', fairA='—';
      if(haveOpen){
        const fair = fairProbsFromOdds([PSH,PSD,PSA]).map(p=>1/p);
        fairH=fmt(fair[0]); fairD=fmt(fair[1]); fairA=fmt(fair[2]);
      }

      const EVH = hasModel1x2 && haveOpen ? evDecimal(pH,PSH) : null;
      const EVD = hasModel1x2 && haveOpen ? evDecimal(pD,PSD) : null;
      const EVA = hasModel1x2 && haveOpen ? evDecimal(pA,PSA) : null;

      const bestK = hasModel1x2 && haveOpen ? bestKelly([pH,pD,pA],[PSH,PSD,PSA],['H','D','A']) : '—';

      rows1x2 += `<tr>
        <td>${r.Date||'—'}</td><td>${r.HomeTeam||'—'}</td><td>${r.AwayTeam||'—'}</td>
        <td class="mono">${fmt(PSH)}</td><td class="mono">${fmt(PSD)}</td><td class="mono">${fmt(PSA)}</td>
        <td class="mono">${or==null?'—':pct(or)}</td>
        <td class="mono">${fairH}</td><td class="mono">${fairD}</td><td class="mono">${fairA}</td>
        <td class="mono">${EVH==null?'—':pct(EVH)}</td><td class="mono">${EVD==null?'—':pct(EVD)}</td><td class="mono">${EVA==null?'—':pct(EVA)}</td>
        <td class="mono">${bestK}</td>
        <td class="mono">${fmt(PSCH)}</td><td class="mono">${fmt(PSCD)}</td><td class="mono">${fmt(PSCA)}</td>
        <td class="mono">${orC==null?'—':pct(orC)}</td>
      </tr>`;

      if(or!=null){ orSum+=or; cnt1x2++; }
      if(orC!=null){ orCSum+=orC; }
    });
    $('#tbody1x2').innerHTML = rows1x2 || '<tr><td colspan="18" style="text-align:center;color:#9aa7ba;padding:16px">Sin filas válidas</td></tr>';
    $('#kpi1x2').innerHTML = `
      <div class="kpi"><div class="k">Media Overround (apertura)</div><div class="v">${cnt1x2?pct(orSum/cnt1x2):'—'}</div></div>
      <div class="kpi"><div class="k">Media Overround (cierre)</div><div class="v">${cnt1x2?pct(orCSum/cnt1x2):'—'}</div></div>
      ${hasModel1x2?`<div class="kpi"><div class="k">Modelo 1X2</div><div class="v mono">H ${pH?.toFixed(2)} · D ${pD?.toFixed(2)} · A ${pA?.toFixed(2)}</div></div>`:''}
    `;

    // --- OU ---
    let rowsOU='';
    let cntOU=0, orOUSum=0, orOUCSum=0;
    data.forEach(r=>{
      const {overKey,underKey,overKeyC,underKeyC,line} = findOUKeys(r);
      if(!overKey||!underKey) return;

      const Pov = +r[overKey], Pun = +r[underKey];
      const PovC= overKeyC ? +r[overKeyC] : NaN;
      const PunC= underKeyC? +r[underKeyC]: NaN;

      const haveOpen = [Pov,Pun].every(o=>o>1);
      const haveClose= [PovC,PunC].every(o=>o>1);

      const or = haveOpen ? overroundFromOdds([Pov,Pun]) : null;
      const orC= haveClose? overroundFromOdds([PovC,PunC]) : null;

      let fairOv='—', fairUn='—';
      if(haveOpen){
        const fair = fairProbsFromOdds([Pov,Pun]).map(p=>1/p);
        fairOv=fmt(fair[0]); fairUn=fmt(fair[1]);
      }

      const EVO = hasModelOU && haveOpen ? evDecimal(pOver,Pov) : null;
      const EVU = hasModelOU && haveOpen ? evDecimal(pUnder,Pun) : null;
      const bestK = hasModelOU && haveOpen ? bestKelly([pOver,pUnder],[Pov,Pun],['Over','Under']) : '—';

      rowsOU += `<tr>
        <td>${r.Date||'—'}</td><td>${r.HomeTeam||'—'}</td><td>${r.AwayTeam||'—'}</td><td class="mono">${line||$('#ouLabel').value||'—'}</td>
        <td class="mono">${fmt(Pov)}</td><td class="mono">${fmt(Pun)}</td><td class="mono">${or==null?'—':pct(or)}</td>
        <td class="mono">${fairOv}</td><td class="mono">${fairUn}</td>
        <td class="mono">${EVO==null?'—':pct(EVO)}</td><td class="mono">${EVU==null?'—':pct(EVU)}</td><td class="mono">${bestK}</td>
        <td class="mono">${fmt(PovC)}</td><td class="mono">${fmt(PunC)}</td><td class="mono">${orC==null?'—':pct(orC)}</td>
      </tr>`;

      if(or!=null){ orOUSum+=or; cntOU++; }
      if(orC!=null){ orOUCSum+=orC; }
    });
    $('#tbodyOU').innerHTML = rowsOU || '<tr><td colspan="15" style="text-align:center;color:#9aa7ba;padding:16px">Sin filas válidas OU</td></tr>';
    $('#kpiOU').innerHTML = `
      <div class="kpi"><div class="k">Media Overround OU (apertura)</div><div class="v">${cntOU?pct(orOUSum/cntOU):'—'}</div></div>
      <div class="kpi"><div class="k">Media Overround OU (cierre)</div><div class="v">${cntOU?pct(orOUCSum/cntOU):'—'}</div></div>
      ${hasModelOU?`<div class="kpi"><div class="k">Modelo OU</div><div class="v mono">Over ${pOver?.toFixed(2)} · Under ${pUnder?.toFixed(2)}</div></div>`:''}
    `;

    // Badges generales
    const badge = (name,val)=>{
      if(val==null) return '';
      const cls = val<=0.04?'badge-good':(val<=0.07?'badge-warn':'badge-bad');
      return `<span class="badge ${cls}">${name}: ${pct(val)}</span>`;
    };
    const avg1x2 = (cnt1x2? orSum/cnt1x2 : null);
    const avg1x2C= (cnt1x2? orCSum/cnt1x2: null);
    const avgOU  = (cntOU? orOUSum/cntOU : null);
    const avgOUC = (cntOU? orOUCSum/cntOU: null);
    $('#badges').innerHTML = [
      badge('Overround medio 1X2 (open)', avg1x2),
      badge('Overround medio 1X2 (close)', avg1x2C),
      badge('Overround medio OU (open)', avgOU),
      badge('Overround medio OU (close)', avgOUC),
    ].join(' ');
  }

  // Sample loader (pega tu JSON real encima)
  $('#loadSample').addEventListener('click', ()=>{
    $('#jsonIn').value = `[{"Date":"2025-08-22","HomeTeam":"Bayern Munich","AwayTeam":"RB Leipzig","PSH":"1.23","PSD":"7.43","PSA":"10.85","PSCH":"1.25","PSCD":"7.24","PSCA":"10.31","P>2":"1.32","P<2":"3.33","PC>2":"1.32","PC<2":"3.33"},
{"Date":"2025-08-23","HomeTeam":"Ein Frankfurt","AwayTeam":"Werder Bremen","PSH":"1.70","PSD":"4.26","PSA":"4.68","PSCH":"1.62","PSCD":"4.52","PSCA":"5.21","P>2":"1.57","P<2":"2.50","PC>2":"1.52","PC<2":"2.63"}]`;
  });
  $('#processBtn').addEventListener('click', process);
})();
</script>
</body>
</html>
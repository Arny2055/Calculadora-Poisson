<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Estadísticas Over/Under</title>
<style>
  :root{
    --bg:#0a0f1c; --card:#121826; --panel:#1a2333; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#3b82f6; --green:#10b981; --amber:#f59e0b; --red:#ef4444; --line:#263143;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px}
  h1{color:var(--accent);text-align:center;margin:8px 0 16px}

  .card{background:var(--card);border-radius:14px;padding:16px;margin:16px 0;border:3px solid transparent;transition:.2s border-color}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-size:.95rem}
  select,input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1726;color:var(--text);font-size:16px}
  button{background:var(--accent);border-color:var(--accent);font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.05)}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .tab{flex:1;min-width:110px;background:#0f1726;border:1px solid var(--line);color:var(--muted);padding:10px;border-radius:10px;cursor:pointer;text-align:center}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:700}

  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h3{margin:0 0 10px;font-size:1.05rem;color:#cbd5e1}

  .kv{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed var(--line)}
  .kv:last-child{border-bottom:0}
  .muted{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums}
  .badge{display:inline-block;min-width:52px;text-align:center;padding:3px 8px;border-radius:999px;font-weight:700;color:#fff}
  .b-green{background:var(--green)} .b-amber{background:var(--amber)} .b-red{background:var(--red)}
  .b-soft{background:#0f1726;border:1px solid var(--line);color:#cbd5e1}

  table{width:100%;border-collapse:collapse;font-size:.95rem;margin-top:8px;overflow:hidden;border-radius:10px;border:1px solid var(--line)}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--line)}
  th{background:#0f1726;color:#cbd5e1;font-weight:600}
  tr:last-child td{border-bottom:0}

  .valueBox{margin-top:10px;padding:10px;border-radius:10px;text-align:center;font-weight:800}
  .value{background:var(--green);color:#fff} .novalue{background:var(--red);color:#fff}

  .sub{display:flex;align-items:center;gap:8px;color:#cbd5e1;margin:8px 0 4px}
  .divider{height:1px;background:var(--line);margin:8px 0;border-radius:1px}
  .row{display:grid;gap:10px}
  @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}

  .pills{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:900px){.pills{grid-template-columns:repeat(3,1fr)}}
  .pill{
    position:relative;background:#0f1726;border:1px solid var(--line);
    border-radius:18px;padding:12px 12px 6px;text-align:center;min-height:84px;
    display:flex;flex-direction:column;justify-content:space-between;gap:6px;
    box-shadow:inset 0 -3px 0 0 rgba(255,255,255,0.06);
  }
  .pill .big{font-weight:800;font-size:1.05rem}
  .pill .caption{color:#cbd5e1;font-weight:600}
  .pill.ok{outline:2px solid var(--green)} .pill.warn{outline:2px solid var(--amber)} .pill.bad{outline:2px solid var(--red)}
  .spark{width:100%;height:28px}

  :root{ --radius:14px; --field-h:56px; --font-base:16px; --font-field:18px; --font-label:1.05rem; --font-chip-lg:1.1rem; }
  label{ font-size: var(--font-label); letter-spacing:.2px; }
  select,input,button{ min-height: var(--field-h); font-size: var(--font-field); border-radius: var(--radius); }
  select option{ font-size: 18px; }
  .tab{ padding:12px; font-size:1rem; font-weight:600; }

  .preview{
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    background:#0f1726;border:1px solid var(--line);border-radius:16px;
    padding:10px 12px;margin-top:12px
  }
  .preview .chip{
    display:inline-flex;align-items:center;gap:8px;
    background:#0b1324;border:1px solid var(--line);border-radius:999px;
    padding:8px 12px;font-weight:700;
    font-size: var(--font-chip-lg); color:#e5e7eb;
    box-shadow:inset 0 -2px 0 rgba(255,255,255,.04);
  }
  .preview .chip .dot{width:8px;height:8px;border-radius:50%}
  .preview .chip.league .dot{background:var(--accent)}
  .preview .chip.home  .dot{background:var(--green)}
  .preview .chip.away  .dot{background:var(--red)}

  @media (max-width:480px){
    body{padding:12px}
    .card{padding:14px}
    h1{font-size:1.25rem}
    :root{ --font-field:19px; --field-h:58px; --font-chip-lg:1.15rem; }
  }
</style>
</head>
<body>
  <h1>Estadísticas Over/Under</h1>

  <div class="card">
    <input type="file" id="fileInput" accept=".json,.txt"><br>

    <div class="row">
      <div>
        <label>Selecciona Liga</label>
        <select id="leagueSelect"></select>
      </div>
      <div>
        <label>Odd Over 2.5</label>
        <input type="number" id="oddOver" step="0.01" placeholder="Ej: 1.90">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Equipo Local</label>
        <select id="homeSelect"></select>
      </div>
      <div>
        <label>Odd Under 2.5</label>
        <input type="number" id="oddUnder" step="0.01" placeholder="Ej: 2.00">
      </div>
    </div>

    <label>Equipo Visitante</label>
    <select id="awaySelect"></select>

    <div class="tabs" id="tabs">
      <div class="tab active" data-period="FT">Full Time</div>
      <div class="tab" data-period="1H">First Half</div>
      <div class="tab" data-period="2H">Second Half</div>
    </div>

    <button id="analyzeBtn" style="margin-top:10px">Analizar</button>

    <!-- Vista previa en chips grandes -->
    <div id="selectionPreview" class="preview" style="display:none">
      <div class="chip league"><span class="dot"></span><span id="pvLeague">—</span></div>
      <div class="chip home"><span class="dot"></span><span id="pvHome">—</span></div>
      <div class="chip away"><span class="dot"></span><span id="pvAway">—</span></div>
    </div>
  </div>

  <div id="results" class="card"></div>

<script>
let allMatches = [];
let currentPeriod = "FT";

/* ---------- Utils ---------- */
function tryParseJSON(text){
  try { return JSON.parse(text); } catch(e){}
  const wrapped = "[" + text.trim().replace(/(^,)|(,$)/g,"").replace(/\n+/g,"\n").replace(/\}\s*,\s*\{/g,"},{") + "]";
  try { return JSON.parse(wrapped); } catch(e2){ return []; }
}
function pct(a,b){ return b ? Math.round((a/b)*100) : 0; }
function cls(p){ return p>=70?"b-green":(p>=50?"b-amber":"b-red"); }
function badge(p){ return `<span class="badge ${cls(p)}">${p}%</span>`; }
function parseScore(txt){ if(!txt) return [0,0]; const m = txt.split("-").map(x=>parseInt(x,10)); return [m[0]||0,m[1]||0]; }
function periodGoals(m){
  const [hHT,aHT] = parseScore(m["Result HT"]); const [hFT,aFT] = parseScore(m["Result FT"]);
  if(currentPeriod==="FT") return [hFT,aFT];
  if(currentPeriod==="1H") return [hHT,aHT];
  return [(hFT-hHT),(aFT-aHT)];
}
function lastMatchesByRole(matches, team, role){
  const arr = matches.filter(m=>{
    const [h,a]=m.Match.split(" - "); return role==="home"? h===team : a===team;
  });
  return arr.slice(-10);
}
function percentOver(lastMatches, line){
  const n = lastMatches.length; let over=0;
  lastMatches.forEach(m=>{ const [h,a]=periodGoals(m); if(h+a>line) over++; });
  return pct(over,n);
}
function percentBTTS(lastMatches){
  const n = lastMatches.length; let yes=0;
  lastMatches.forEach(m=>{ const [h,a]=periodGoals(m); if(h>0 && a>0) yes++; });
  return pct(yes,n);
}
function teamAverages(lastMatches, team){
  let s=0,c=0,t=0,n=lastMatches.length||1;
  lastMatches.forEach(m=>{
    const [home,away]=m.Match.split(" - ");
    const [h,a]=periodGoals(m);
    const forTeam=(team===home)?h:(team===away)?a:null;
    const opp=(team===home)?a:(team===away)?h:null;
    if(forTeam==null) return;
    s+=forTeam; c+=opp; t+=(forTeam+opp);
  });
  return {avgScored:(s/n).toFixed(1), avgConceded:(c/n).toFixed(1), avgGoals:(t/n).toFixed(1)};
}
function avgCornersFT(lastMatches){
  let sum=0, n=0;
  lastMatches.forEach(m=>{
    const hc = Number(m["Home Corners at FT"]||m.home_corners_ft||m.home_corners||0);
    const ac = Number(m["Away Corners at FT"]||m.away_corners_ft||m.away_corners||0);
    if(!isNaN(hc+ac)){ sum += (hc+ac); n++; }
  });
  return n? (sum/n) : 0;
}

/* ====== Poisson PRO ====== */
// Utilidades
function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
function expwWeights(n, alpha=0.85){
  const w = Array.from({length:n}, (_,i)=>Math.pow(alpha, n-1-i));
  const s = w.reduce((a,b)=>a+b,0);
  return w.map(x=>x/s);
}
// Goles por partido para un equipo en el periodo activo
function goalsForTeamInMatch(m, team){
  const [home,away]=m.Match.split(" - ");
  const [h,a]=periodGoals(m);
  const forTeam=(team===home)?h:(team===away)?a:null;
  const opp=(team===home)?a:(team===away)?h:null;
  return {forTeam,opp,role:(team===home)?'home':'away'};
}
// Promedios ponderados por recencia
function recencyAverages(matches, team, maxN=10){
  const last = matches.filter(m=>{
    const [h,a]=m.Match.split(" - ");
    return h===team || a===team;
  }).slice(-maxN);

  const w = expwWeights(last.length);
  let gf=0, ga=0, n=0, homeGames=0, awayGames=0, gfH=0, gfA=0, gaH=0, gaA=0;
  last.forEach((m,i)=>{
    const g = goalsForTeamInMatch(m, team);
    if(g.forTeam==null) return;
    const wi = w[i];
    gf += wi*g.forTeam; ga += wi*g.opp; n++;
    if(g.role==='home'){ homeGames+=wi; gfH+=wi*g.forTeam; gaH+=wi*g.opp; }
    else { awayGames+=wi; gfA+=wi*g.forTeam; gaA+=wi*g.opp; }
  });
  return {
    gf: n?gf:0, ga: n?ga:0,
    gfH: homeGames? gfH/homeGames : 0,
    gfA: awayGames? gfA/awayGames : 0,
    gaH: homeGames? gaH/homeGames : 0,
    gaA: awayGames? gaA/awayGames : 0
  };
}
// Promedios de liga por rol en el periodo activo
function leagueRoleAverages(leagueMatches){
  let hG=0,aG=0, hN=0,aN=0;
  leagueMatches.forEach(m=>{
    const [h,a]=periodGoals(m);
    if(Number.isFinite(h)&&Number.isFinite(a)){
      hG+=h; aG+=a; hN++; aN++;
    }
  });
  const homeAvg = hN? hG/hN : 0;
  const awayAvg = aN? aG/aN : 0;
  return {homeAvg, awayAvg, totalAvg: (homeAvg+awayAvg)};
}
// % de goles 1H/2H para escalar λ en 1H/2H
function periodSplitRatios(leagueAll){
  let gFT=0, g1=0, g2=0;
  leagueAll.forEach(m=>{
    const [hHT,aHT] = parseScore(m["Result HT"]);
    const [hFT,aFT] = parseScore(m["Result FT"]);
    const p1 = hHT + aHT;
    const p2 = (hFT-hHT) + (aFT-aHT);
    const ft = hFT + aFT;
    if(Number.isFinite(ft)){ gFT += ft; g1 += p1; g2 += p2; }
  });
  if(gFT<=0) return {r1H:0.45, r2H:0.55};
  const r1 = g1/gFT, r2 = g2/gFT;
  const s = (r1+r2)||1;
  return {r1H: r1/s, r2H: r2/s};
}
// Fortalezas por rol + promedio liga
function teamStrengths(leagueMatches, team){
  const lg = leagueRoleAverages(leagueMatches);
  const ra = recencyAverages(leagueMatches, team, 10);
  const atkHome = lg.homeAvg>0 ? (ra.gfH||ra.gf)/lg.homeAvg : 1;
  const atkAway = lg.awayAvg>0 ? (ra.gfA||ra.gf)/lg.awayAvg : 1;
  const defHome = lg.awayAvg>0 ? ( (ra.gaH||ra.ga) / lg.awayAvg ) : 1;
  const defAway = lg.homeAvg>0 ? ( (ra.gaA||ra.ga) / lg.homeAvg ) : 1;
  return {atkHome, atkAway, defHome, defAway, league:lg};
}
// Ventaja local estimada por liga
function estimateHomeAdv(leagueMatches){
  const lg = leagueRoleAverages(leagueMatches);
  if(lg.awayAvg<=0) return 1.10;
  const adv = lg.homeAvg / lg.awayAvg;
  return clamp(adv, 0.95, 1.25);
}
// Lambdas por partido con escalado de periodo
function matchLambdasPRO(leagueMatches, homeTeam, awayTeam){
  const {r1H, r2H} = periodSplitRatios(leagueMatches);
  const HA = estimateHomeAdv(leagueMatches);
  const H = teamStrengths(leagueMatches, homeTeam);
  const A = teamStrengths(leagueMatches, awayTeam);

  const baseHomeFT = H.league.homeAvg * H.atkHome * A.defAway * HA;
  const baseAwayFT = A.league.awayAvg * A.atkAway * H.defHome;

  let scale = 1.0;
  if(currentPeriod==="1H") scale = r1H;
  else if(currentPeriod==="2H") scale = r2H;

  const lambdaH = Math.max(0, baseHomeFT*scale);
  const lambdaA = Math.max(0, baseAwayFT*scale);
  return {lambdaH, lambdaA};
}
// Poisson PMF
function poisPMF(k, lambda){
  if(k<0) return 0;
  let p = Math.exp(-lambda);
  if(k===0) return p;
  for(let i=1;i<=k;i++) p = p*(lambda/i);
  return p;
}
// Dixon-Coles tweak para marcadores bajos + renormalización
function dixonColesTau(i,j, lambdaH, lambdaA, rho){
  if(i===0 && j===0) return 1 - (lambdaH*lambdaA*rho);
  if(i===0 && j===1) return 1 + (lambdaH*rho);
  if(i===1 && j===0) return 1 + (lambdaA*rho);
  if(i===1 && j===1) return 1 - rho;
  return 1;
}
function jointScoreMatrix(lambdaH, lambdaA, rho=0.05, maxG=7){
  const M = [];
  let sum=0;
  for(let i=0;i<=maxG;i++){
    const row=[];
    for(let j=0;j<=maxG;j++){
      let pij = poisPMF(i,lambdaH)*poisPMF(j,lambdaA);
      const tau = dixonColesTau(i,j,lambdaH,lambdaA,rho);
      pij = Math.max(0, pij * tau);
      row.push(pij); sum+=pij;
    }
    M.push(row);
  }
  if(sum>0){
    for(let i=0;i<=maxG;i++) for(let j=0;j<=maxG;j++) M[i][j]/=sum;
  }
  return M;
}
// Agregaciones desde la matriz
function probOverFromMatrix(M, lineHalf){
  const k = Math.floor(lineHalf);
  let p=0;
  for(let i=0;i<M.length;i++){
    for(let j=0;j<M[i].length;j++){
      if(i+j > k) p+=M[i][j];
    }
  }
  return p;
}
function probBTTSFromMatrix(M){
  let p=0;
  for(let i=1;i<M.length;i++){
    for(let j=1;j<M[i].length;j++){
      p+=M[i][j];
    }
  }
  return p;
}
function topCorrectScores(M, top=4){
  const arr=[];
  for(let i=0;i<M.length;i++) for(let j=0;j<M[i].length;j++) arr.push({i,j,p:M[i][j]});
  arr.sort((a,b)=>b.p-a.p);
  return arr.slice(0,top);
}
// Calibración a cuota de Over 2.5 (opcional)
function calibrateScaleToMarket(lambdaH, lambdaA, targetOverProb, lineHalf=2.5){
  if(!Number.isFinite(targetOverProb) || targetOverProb<=0 || targetOverProb>=1) return 1.0;
  let lo=0.5, hi=1.8, s=1.0;
  for(let it=0; it<22; it++){
    const mid = (lo+hi)/2;
    const M = jointScoreMatrix(lambdaH*mid, lambdaA*mid, 0.05, 7);
    const p = probOverFromMatrix(M, lineHalf);
    if(p < targetOverProb) lo = mid; else hi = mid;
    s = mid;
  }
  return s;
}

/* ---- Summary Poisson PRO ---- */
function renderPoissonSummaryTable(homeTeam, awayTeam, homeLast, awayLast){
  const league = allMatches.filter(m=>m.League===document.getElementById("leagueSelect").value);
  const {lambdaH:baseH, lambdaA:baseA} = matchLambdasPRO(league, homeTeam, awayTeam);

  const oddOver = parseFloat(document.getElementById("oddOver").value);
  const impliedOver = (oddOver && oddOver>1)? (1/oddOver) : null;
  const scale = impliedOver ? calibrateScaleToMarket(baseH, baseA, impliedOver, 2.5) : 1.0;

  const lambdaH = baseH*scale, lambdaA = baseA*scale;

  const M = jointScoreMatrix(lambdaH, lambdaA, 0.05, 7);

  const lines = [0.5,1.5,2.5,3.5];
  const row = (L)=>{
    const k = Math.floor(L);
    // P(H>k) y P(A>k) vía marginales
    let pH=0, pA=0;
    for(let i=k+1;i<M.length;i++){ let r=0; for(let j=0;j<M[i].length;j++) r+=M[i][j]; pH+=r; }
    for(let j=k+1;j<M[0].length;j++){ let c=0; for(let i=0;i<M.length;i++) c+=M[i][j]; pA+=c; }
    const pMatch = probOverFromMatrix(M, L);
    const ph = Math.round(pH*100), pa = Math.round(pA*100), pm = Math.round(pMatch*100);
    return `
      <tr>
        <td>Over ${L.toFixed(1)}</td>
        <td>${badge(ph)}</td>
        <td>${badge(pa)}</td>
        <td><span class="badge ${cls(pm)}">${pm}%</span></td>
      </tr>`;
  };

  const btts = Math.round(probBTTSFromMatrix(M)*100);
  const topCS = topCorrectScores(M, 4)
    .map(cs=>`${cs.i}-${cs.j} <span class="muted">(${Math.round(cs.p*100)}%)</span>`)
    .join(' · ');

  return `
    <div class="panel">
      <h3>Summary (Poisson PRO · ${currentPeriod})</h3>
      <div class="kv"><span class="muted">λ Home</span><span class="mono">${lambdaH.toFixed(2)}</span></div>
      <div class="kv"><span class="muted">λ Away</span><span class="mono">${lambdaA.toFixed(2)}</span></div>
      ${ (scale!==1)? `<div class="kv"><span class="muted">Market calibration</span><span class="mono">x${scale.toFixed(3)}</span></div>` : '' }
      <div class="divider"></div>
      <table>
        <tr><th></th><th>Home</th><th>Away</th><th>Match</th></tr>
        ${lines.map(row).join("")}
        <tr>
          <td>BTTS</td>
          <td colspan="2"></td>
          <td><span class="badge ${cls(btts)}">${btts}%</span></td>
        </tr>
      </table>
      <div class="divider"></div>
      <div class="kv"><span class="muted">Top correct scores</span><span class="mono">${topCS}</span></div>
    </div>
  `;
}

/* ---------- SPARKLINES ---------- */
function buildSeries(homeLast, awayLast){
  const len = Math.min(homeLast.length, awayLast.length, 10);
  const H = homeLast.slice(-len);
  const A = awayLast.slice(-len);

  const sOver = line => {
    const out=[];
    for(let i=0;i<len;i++){
      const [h1,a1]=periodGoals(H[i]); const [h2,a2]=periodGoals(A[i]);
      const v1=(h1+a1>line)?1:0, v2=(h2+a2>line)?1:0;
      out.push( (v1+v2)/2 * 100 );
    }
    return out;
  };
  const sBTTS = ()=>{
    const out=[];
    for(let i=0;i<len;i++){
      const [h1,a1]=periodGoals(H[i]); const [h2,a2]=periodGoals(A[i]);
      const v1=(h1>0&&a1>0)?1:0, v2=(h2>0&&a2>0)?1:0;
      out.push( (v1+v2)/2 * 100 );
    }
    return out;
  };
  const sGoals = ()=>{
    const out=[];
    for(let i=0;i<len;i++){
      const [h1,a1]=periodGoals(H[i]); const [h2,a2]=periodGoals(A[i]);
      out.push( (h1+h2 + a1+a2)/2 );
    }
    return out;
  };
  const sCorners = ()=>{
    const out=[];
    for(let i=0;i<len;i++){
      const c1 = (Number(H[i]["Home Corners at FT"]||H[i].home_corners_ft||H[i].home_corners||0)+
                  Number(H[i]["Away Corners at FT"]||H[i].away_corners_ft||H[i].away_corners||0));
      const c2 = (Number(A[i]["Home Corners at FT"]||A[i].home_corners_ft||A[i].home_corners||0)+
                  Number(A[i]["Away Corners at FT"]||A[i].away_corners_ft||A[i].away_corners||0));
      out.push((c1+c2)/2);
    }
    return out;
  };

  return { o05: sOver(0.5), o25: sOver(2.5), o15: sOver(1.5), btts: sBTTS(), goals: sGoals(), corners: sCorners() };
}

function drawSpark(canvas, series){
  if(!canvas) return;
  const dpr = window.devicePixelRatio||1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.round(w*dpr); canvas.height = Math.round(h*dpr);
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,w,h);
  if(!series || series.length===0){ return; }

  let min = Math.min(...series), max = Math.max(...series);
  if (min===max){ min = min-1; max = max+1; }
  const nx = i => (i/(series.length-1))*(w-4)+2;
  const ny = v => h-2 - ((v-min)/(max-min))*(h-6);

  ctx.beginPath();
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#22d3ee';
  for(let i=0;i<series.length;i++){
    const x = nx(i), y = ny(series[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  const lastY = ny(series[series.length-1]);
  const lastX = nx(series.length-1);
  ctx.lineTo(lastX,h-2); ctx.lineTo(2,h-2); ctx.closePath();
  ctx.fillStyle = 'rgba(34,211,238,0.10)';
  ctx.fill();

  ctx.beginPath();
  ctx.arc(lastX,lastY,2.5,0,Math.PI*2);
  ctx.fillStyle = '#22d3ee';
  ctx.fill();
}

/* --- Game Predictions con sparklines --- */
function renderPredictions(homeTeam, awayTeam, homeLast, awayLast){
  const pO05 = Math.round((percentOver(homeLast,0.5)+percentOver(awayLast,0.5))/2);
  const pO25 = Math.round((percentOver(homeLast,2.5)+percentOver(awayLast,2.5))/2);
  const pO15 = Math.round((percentOver(homeLast,1.5)+percentOver(awayLast,1.5))/2);
  const pBTTS = Math.round((percentBTTS(homeLast)+percentBTTS(awayLast))/2);

  const hAvg = teamAverages(homeLast, homeTeam);
  const aAvg = teamAverages(awayLast, awayTeam);
  const expGoals = Math.round((parseFloat(hAvg.avgScored)+parseFloat(aAvg.avgScored)));
  const avgCorners = Math.round((avgCornersFT(homeLast) + avgCornersFT(awayLast))/2);

  const pillClass = p => p>=70?'ok':(p>=50?'warn':'bad');
  const S = buildSeries(homeLast, awayLast);
  const pill = (key, big, caption, klass='')=>`
    <div class="pill ${klass}">
      <div class="big">${big}</div>
      <div class="caption">${caption}</div>
      <canvas class="spark" data-key="${key}"></canvas>
    </div>`;

  const html = `
    <div class="panel">
      <h3>Game Predictions</h3>
      <div class="pills">
        ${pill('o05', `${pO05}%`, 'Over 0.5FT', pillClass(pO05))}
        ${pill('o15', `${pO15}%`, 'Over 1.5FT', pillClass(pO15))}
        ${pill('o25', `${pO25}%`, 'Over 2.5FT', pillClass(pO25))}
        ${pill('btts', `${pBTTS}%`, 'BTTS', pillClass(pBTTS))}
        ${pill('goals', `${expGoals}`, 'Goals')}
        ${pill('corners', `${avgCorners}`, 'Corners')}
      </div>
    </div>`;

  setTimeout(()=>{ document.querySelectorAll('.spark').forEach(cv=>{ const key=cv.dataset.key; drawSpark(cv, S[key]); }); },0);
  return html;
}

function valueBox(prob, odd){
  if(!odd || odd<=1) return "";
  const implied = Math.round(100/odd);
  return prob > implied
    ? `<div class="valueBox value">VALUE (Model ${prob}% vs ${implied}% imp.)</div>`
    : `<div class="valueBox novalue">NO VALUE (Model ${prob}% vs ${implied}% imp.)</div>`;
}

/* ---------- Load ---------- */
document.getElementById("fileInput").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const rd = new FileReader();
  rd.onload = ev=>{
    allMatches = tryParseJSON(ev.target.result).map(m=>({
      ...m,
      League: m.League || m.league || "",
      Match: m.Match || m.match || "",
      "Result HT": m["Result HT"] || m.result_ht || m.ht || "0-0",
      "Result FT": m["Result FT"] || m.result_ft || m.ft || "0-0",
      "Home Corners at FT": m["Home Corners at FT"]||m.home_corners_ft||m.home_corners||0,
      "Away Corners at FT": m["Away Corners at FT"]||m.away_corners_ft||m.away_corners||0,
      "Home Corners at HT": m["Home Corners at HT"]||m.home_corners_ht||undefined,
      "Away Corners at HT": m["Away Corners at HT"]||m.away_corners_ht||undefined
    }));
    const leagues = [...new Set(allMatches.map(m=>m.League).filter(Boolean))].sort();
    document.getElementById("leagueSelect").innerHTML = "<option value=''>--Selecciona--</option>" + leagues.map(l=>`<option>${l}</option>`).join("");
    updateSelectionPreview();
  };
  rd.readAsText(file);
});

document.getElementById("leagueSelect").addEventListener("change", function(){
  const league = this.value;
  const leagueMatches = allMatches.filter(m=>m.League===league);
  const teams = [...new Set(leagueMatches.flatMap(m=>m.Match.split(" - ")))].sort();
  document.getElementById("homeSelect").innerHTML = teams.map(t=>`<option>${t}</option>`).join("");
  document.getElementById("awaySelect").innerHTML = teams.map(t=>`<option>${t}</option>`).join("");
  setTimeout(updateSelectionPreview,0);
});

document.getElementById("tabs").addEventListener("click", (e)=>{
  const t = e.target.closest(".tab"); if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active"); currentPeriod = t.dataset.period;
});

document.getElementById("analyzeBtn").addEventListener("click", ()=>{
  updateSelectionPreview();

  const league = document.getElementById("leagueSelect").value;
  const homeTeam = document.getElementById("homeSelect").value;
  const awayTeam = document.getElementById("awaySelect").value;
  const oddOver = parseFloat(document.getElementById("oddOver").value);
  const oddUnder = parseFloat(document.getElementById("oddUnder").value);
  if(!league || !homeTeam || !awayTeam || homeTeam===awayTeam){ alert("Selecciona liga y equipos (distintos)."); return; }

  const leagueMatches = allMatches.filter(m=>m.League===league);
  const homeLast = lastMatchesByRole(leagueMatches, homeTeam, "home");
  const awayLast = lastMatchesByRole(leagueMatches, awayTeam, "away");
  const homeStats = calcTeamBlock(leagueMatches, homeTeam, "home");
  const awayStats = calcTeamBlock(leagueMatches, awayTeam, "away");

  const summary = renderSummaryTable(homeLast, awayLast);
  const poissonSummary = renderPoissonSummaryTable(homeTeam, awayTeam, homeLast, awayLast);

  const preds = renderPredictions(homeTeam, awayTeam, homeLast, awayLast);

  const matchOver25 = Math.round((percentOver(homeLast,2.5)+percentOver(awayLast,2.5))/2);
  const valueOver = valueBox(matchOver25, oddOver);
  const valueUnder = valueBox(100-matchOver25, oddUnder);

  const res = document.getElementById("results");
  res.innerHTML = `
    <div class="kv"><span class="muted">Periodo activo</span><span class="badge b-soft">${currentPeriod}</span></div>
    <div class="divider"></div>
    <div class="grid">
      ${renderTeamPanel(homeTeam, homeStats)}
      ${renderTeamPanel(awayTeam, awayStats)}
    </div>
    <div class="grid" style="margin-top:12px">
      ${summary}
      ${poissonSummary}
    </div>
    <div class="grid" style="margin-top:12px">
      ${preds}
      <div class="panel">
        <h3>Value Check</h3>
        <div class="grid">
          <div class="panel"><h3>Over 2.5</h3>${valueOver||'<div class="muted">Ingresa Odd Over 2.5</div>'}</div>
          <div class="panel"><h3>Under 2.5</h3>${valueUnder||'<div class="muted">Ingresa Odd Under 2.5</div>'}</div>
        </div>
      </div>
    </div>
  `;
  if (matchOver25 >= 70) res.style.borderColor = "var(--green)";
  else if (matchOver25 >= 50) res.style.borderColor = "var(--amber)";
  else res.style.borderColor = "var(--red)";
});

/* ===== Vista previa de selección (chips) ===== */
function updateSelectionPreview(){
  const league = document.getElementById("leagueSelect").value || "";
  const home   = document.getElementById("homeSelect").value || "";
  const away   = document.getElementById("awaySelect").value || "";
  const pv     = document.getElementById("selectionPreview");
  document.getElementById("pvLeague").textContent = league || "—";
  document.getElementById("pvHome").textContent   = home   || "—";
  document.getElementById("pvAway").textContent   = away   || "—";
  pv.style.display = (league && home && away && home!==away) ? "flex" : "none";
}
["leagueSelect","homeSelect","awaySelect"].forEach(id=>{
  document.getElementById(id).addEventListener("change", updateSelectionPreview);
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Poisson FT/HT + CÃ³rners + Tarjetas + BTTS + Disparos + AH + EH</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{ --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
         --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --border:#2a3140; }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
  header{padding:18px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#121520,#0f1115)}
  h1{margin:0; font-size:20px}
  .wrap{max-width:1220px; margin:20px auto; padding:0 16px}
  .grid{display:grid; gap:14px}
  @media(min-width:1180px){ .grid{grid-template-columns: 1.2fr 1fr} }
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; position:relative}
  .card h2{margin:6px 0 12px; font-size:16px}
  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  select, input[type="number"]{
    width:100%; padding:10px 12px; background:var(--panel2); color:var(--text);
    border:1px solid var(--border); border-radius:10px; font-size:14px;
  }
  input[type="file"]{width:100%}
  .row{display:grid; gap:10px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }
  .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--border);
    background:linear-gradient(180deg,#1b2130,#171a21); color:var(--text); font-weight:600; cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .accent{background:linear-gradient(180deg,#2a58ff,#264bda); border-color:#2c4fd0}
  .muted{color:var(--muted)}
  .kpis{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
  @media(min-width:960px){ .kpis{grid-template-columns:repeat(4,1fr)} }
  .kpi{background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:12px; position:relative; overflow:hidden}
  .kpi .t{font-size:12px; color:var(--muted)}
  .kpi .v{font-size:20px; font-weight:800; margin-top:4px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:8px 10px; border-bottom:1px solid var(--border)}
  th{text-align:left; color:#c9d3e7; background:#1a1f2a; position:sticky; top:0}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--panel2)}
  .footer{color:var(--muted); font-size:12px; text-align:center; padding:18px}
  .hot{ border-color: rgba(93,212,164,0.9);
    box-shadow: 0 0 0 1px rgba(93,212,164,0.9), 0 0 0 8px rgba(93,212,164,0.12);
    background: radial-gradient(1200px 80px at -10% -10%, rgba(93,212,164,0.08), transparent 60%), var(--panel2);}
  .badge-hot{ position:absolute; top:8px; right:8px; font-size:11px; font-weight:700; letter-spacing:.2px;
    background:linear-gradient(180deg,#54e3b2,#3bc48f); color:#0e1a14; border:0; border-radius:999px; padding:4px 8px; display:none; }
  .kpi.hot .badge-hot{ display:inline-block; }

  /* Ocultar mÃ©tricas para vista limpia */
  .metrics{ display:none; }

  /* Tablas compactas */
  .mini-ladder{width:100%;border-collapse:collapse}
  .mini-ladder th,.mini-ladder td{padding:8px 10px;border-bottom:1px solid #2a3140;text-align:center}
  .mini-ladder th{background:#1a1f2a;color:#c9d3e7}
  .o{margin-top:6px;background:#c9c9c9;color:#111;border-radius:4px;padding:4px 6px;display:inline-block;min-width:64px}
  .sub{display:block;font-size:11px;color:#9aa3b2;margin-top:4px}
</style>
</head>
<body>
<header><h1>Poisson FT/HT + CÃ³rners + Tarjetas + BTTS + Disparos + Handicap AsiÃ¡tico & Europeo</h1></header>

<div class="wrap grid">
  <!-- 1) Carga -->
  <div class="card">
    <h2>1) Cargar JSON & elegir</h2>
    <label>JSON (array/objeto/NDJSON). Reconoce: <code>Match + Result FT</code>, <code>HomeTeam/AwayTeam + FTHG/FTAG</code>, agregados por equipo (<code>Team, GF, GA, Matches</code>) y, si existen, <i>OnGoal/Total Shots</i>, CÃ³rners, Amarillas, Rojas.</label>
    <input id="file" type="file" accept=".json,.txt,.ndjson,.csv" />
    <div class="row">
      <div><label> Liga </label><select id="league" disabled></select></div>
      <div><label> Ventaja local FT (HA) </label><input id="ha" type="number" step="0.01" min="0.5" max="1.6" value="1.10" /></div>
    </div>
    <div class="row">
      <div><label> Local </label><select id="home" disabled></select></div>
      <div><label> Visitante </label><select id="away" disabled></select></div>
    </div>
    <div class="row">
      <div><label> Factor HT (goles 1T / partido) </label><input id="htFactor" type="number" step="0.01" min="0.2" max="0.8" value="0.45" /></div>
      <div><label> Ventaja local HT (HA_HT) </label><input id="ha_ht" type="number" step="0.01" min="0.5" max="1.6" value="1.05" /></div>
    </div>
    <div class="row">
      <div><label> HA CÃ³rners (solo local) </label><input id="ha_corners" type="number" step="0.01" min="0.8" max="1.4" value="1.05" /></div>
      <div><label> HA Tarjetas (solo local) </label><input id="ha_cards" type="number" step="0.01" min="0.8" max="1.4" value="1.00" /></div>
    </div>
    <div style="margin-top:12px">
      <button id="calc" class="btn accent" disabled>Calcular</button>
      <span id="status" class="muted" style="margin-left:10px"></span>
    </div>
  </div>

  <!-- 2) MÃ©tricas FT â€” Goles (ocultas) -->
  <div class="card metrics">
    <h2>2) MÃ©tricas FT â€” Goles</h2>
    <div class="kpis">
      <div class="kpi"><div class="t">Î¼ liga</div><div class="v" id="k_mu">â€”</div></div>
      <div class="kpi"><div class="t">Att L</div><div class="v" id="k_att_h">â€”</div></div>
      <div class="kpi"><div class="t">Def L</div><div class="v" id="k_def_h">â€”</div></div>
      <div class="kpi"><div class="t">Att V</div><div class="v" id="k_att_a">â€”</div></div>
      <div class="kpi"><div class="t">Def V</div><div class="v" id="k_def_a">â€”</div></div>
      <div class="kpi"><div class="t">Î» L</div><div class="v" id="k_lh">â€”</div></div>
      <div class="kpi"><div class="t">Î» V</div><div class="v" id="k_la">â€”</div></div>
    </div>
  </div>

  <!-- 3) 1X2 FT -->
  <div class="card" data-group="g_ft_1x2">
    <h2>3) 1X2 â€” FT</h2>
    <div class="grid3">
      <div class="kpi" data-market="ft_1"><span class="badge-hot">ðŸ”¥</span><div class="t">Home Win (1)</div><div class="v pv" id="ft_1">â€”</div></div>
      <div class="kpi" data-market="ft_x"><span class="badge-hot">ðŸ”¥</span><div class="t">Draw (X)</div><div class="v pv" id="ft_x">â€”</div></div>
      <div class="kpi" data-market="ft_2"><span class="badge-hot">ðŸ”¥</span><div class="t">Away Win (2)</div><div class="v pv" id="ft_2">â€”</div></div>
    </div>
  </div>

  <!-- 4) FT O/U -->
  <div class="card" data-group="g_ft_ou25">
    <h2>4) FT â€” Over/Under 2.5</h2>
    <div class="kpis">
      <div class="kpi" data-market="o25"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 2.5</div><div class="v pv" id="m_o25">â€”</div></div>
      <div class="kpi" data-market="u25"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 2.5</div><div class="v pv" id="m_u25">â€”</div></div>
    </div>
  </div>

  <!-- 4.1) BTTS -->
  <div class="card" data-group="g_ft_btts">
    <h2>4.1) BTTS (FT)</h2>
    <div class="kpis">
      <div class="kpi" data-market="btts_yes"><span class="badge-hot">ðŸ”¥</span><div class="t">BTTS: SÃ­</div><div class="v pv" id="m_btts_yes">â€”</div></div>
      <div class="kpi" data-market="btts_no"><span class="badge-hot">ðŸ”¥</span><div class="t">BTTS: No</div><div class="v pv" id="m_btts_no">â€”</div></div>
    </div>
  </div>

  <!-- 5) Asian Handicap -->
  <div class="card">
    <h2>5) Asian Handicap â€” Home</h2>
    <table class="mini-ladder" id="table-ah-home"></table>
  </div>
  <div class="card">
    <h2>6) Asian Handicap â€” Away</h2>
    <table class="mini-ladder" id="table-ah-away"></table>
  </div>

  <!-- 7) European Handicap 1X2 -->
  <div class="card">
    <h2>7) Handicap Europeo 1X2 â€” Home (lÃ­nea a Local)</h2>
    <table class="mini-ladder" id="table-eh-home"></table>
  </div>
  <div class="card">
    <h2>8) Handicap Europeo 1X2 â€” Away (lÃ­nea a Visitante)</h2>
    <table class="mini-ladder" id="table-eh-away"></table>
  </div>

  <!-- 9) 1X2 HT -->
  <div class="card" data-group="g_ht_1x2">
    <h2>9) 1X2 â€” HT</h2>
    <div class="grid3">
      <div class="kpi" data-market="ht_1"><span class="badge-hot">ðŸ”¥</span><div class="t">HT 1</div><div class="v pv" id="ht_1">â€”</div></div>
      <div class="kpi" data-market="ht_x"><span class="badge-hot">ðŸ”¥</span><div class="t">HT X</div><div class="v pv" id="ht_x">â€”</div></div>
      <div class="kpi" data-market="ht_2"><span class="badge-hot">ðŸ”¥</span><div class="t">HT 2</div><div class="v pv" id="ht_2">â€”</div></div>
    </div>
  </div>

  <!-- 10) HT O/U -->
  <div class="card">
    <h2>10) HT â€” Over/Under</h2>
    <div class="kpis" data-group="g_ht_ou05">
      <div class="kpi" data-market="ht_o05"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 0.5 HT</div><div class="v pv" id="ht_o05">â€”</div></div>
      <div class="kpi" data-market="ht_u05"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 0.5 HT</div><div class="v pv" id="ht_u05">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_ht_ou15" style="margin-top:10px">
      <div class="kpi" data-market="ht_o15"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 1.5 HT</div><div class="v pv" id="ht_o15">â€”</div></div>
      <div class="kpi" data-market="ht_u15"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 1.5 HT</div><div class="v pv" id="ht_u15">â€”</div></div>
    </div>
  </div>

  <!-- 11) CÃ³rners -->
  <div class="card">
    <h2>11) CÃ³rners (FT)</h2>
    <div class="kpis metrics">
      <div class="kpi"><div class="t">Î¼ liga</div><div class="v" id="c_mu">â€”</div></div>
      <div class="kpi"><div class="t">Î» Local</div><div class="v" id="c_lh">â€”</div></div>
      <div class="kpi"><div class="t">Î» Visit</div><div class="v" id="c_la">â€”</div></div>
      <div class="kpi"><div class="t">Î» Total</div><div class="v" id="c_tot">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_c_85" style="margin-top:10px">
      <div class="kpi" data-market="c_o85"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 8.5</div><div class="v pv" id="c_o85">â€”</div></div>
      <div class="kpi" data-market="c_u85"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 8.5</div><div class="v pv" id="c_u85">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_c_95" style="margin-top:10px">
      <div class="kpi" data-market="c_o95"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 9.5</div><div class="v pv" id="c_o95">â€”</div></div>
      <div class="kpi" data-market="c_u95"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 9.5</div><div class="v pv" id="c_u95">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_c_105" style="margin-top:10px">
      <div class="kpi" data-market="c_o105"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 10.5</div><div class="v pv" id="c_o105">â€”</div></div>
      <div class="kpi" data-market="c_u105"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 10.5</div><div class="v pv" id="c_u105">â€”</div></div>
    </div>
  </div>

  <!-- 12) Tarjetas -->
  <div class="card">
    <h2>12) Tarjetas (FT)</h2>
    <div class="kpis metrics">
      <div class="kpi"><div class="t">Î¼ Am.</div><div class="v" id="y_mu">â€”</div></div>
      <div class="kpi"><div class="t">Î» Am. L</div><div class="v" id="y_lh">â€”</div></div>
      <div class="kpi"><div class="t">Î» Am. V</div><div class="v" id="y_la">â€”</div></div>
      <div class="kpi"><div class="t">Î» Am. Tot</div><div class="v" id="y_tot">â€”</div></div>
      <div class="kpi"><div class="t">Î¼ Rojas</div><div class="v" id="r_mu">â€”</div></div>
      <div class="kpi"><div class="t">Î» Rojas L</div><div class="v" id="r_lh">â€”</div></div>
      <div class="kpi"><div class="t">Î» Rojas V</div><div class="v" id="r_la">â€”</div></div>
      <div class="kpi"><div class="t">Î» Rojas Tot</div><div class="v" id="r_tot">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_y_35" style="margin-top:10px">
      <div class="kpi" data-market="y_o35"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 3.5 Am.</div><div class="v pv" id="y_o35">â€”</div></div>
      <div class="kpi" data-market="y_u35"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 3.5 Am.</div><div class="v pv" id="y_u35">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_y_45" style="margin-top:10px">
      <div class="kpi" data-market="y_o45"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 4.5 Am.</div><div class="v pv" id="y_o45">â€”</div></div>
      <div class="kpi" data-market="y_u45"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 4.5 Am.</div><div class="v pv" id="y_u45">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_r_05" style="margin-top:10px">
      <div class="kpi" data-market="r_o05"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 0.5 Rojas</div><div class="v pv" id="r_o05">â€”</div></div>
      <div class="kpi" data-market="r_u05"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 0.5 Rojas</div><div class="v pv" id="r_u05">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_r_15" style="margin-top:10px">
      <div class="kpi" data-market="r_o15"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 1.5 Rojas</div><div class="v pv" id="r_o15">â€”</div></div>
      <div class="kpi" data-market="r_u15"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 1.5 Rojas</div><div class="v pv" id="r_u15">â€”</div></div>
    </div>
    <div class="kpis" style="margin-top:10px">
      <div class="kpi"><div class="t">Â¿HabrÃ¡ roja? (SÃ­)</div><div class="v" id="r_any">â€”</div></div>
    </div>
  </div>

  <!-- 13) Disparos a puerta -->
  <div class="card">
    <h2>13) Disparos a puerta (SoT) â€” FT</h2>
    <div class="kpis metrics">
      <div class="kpi"><div class="t">Î¼ SoT</div><div class="v" id="sot_mu">â€”</div></div>
      <div class="kpi"><div class="t">Î» L</div><div class="v" id="sot_lh">â€”</div></div>
      <div class="kpi"><div class="t">Î» V</div><div class="v" id="sot_la">â€”</div></div>
      <div class="kpi"><div class="t">Î» Tot</div><div class="v" id="sot_tot">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_sot_75" style="margin-top:10px">
      <div class="kpi" data-market="sot_o75"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 7.5</div><div class="v pv" id="sot_o75">â€”</div></div>
      <div class="kpi" data-market="sot_u75"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 7.5</div><div class="v pv" id="sot_u75">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_sot_85" style="margin-top:10px">
      <div class="kpi" data-market="sot_o85"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 8.5</div><div class="v pv" id="sot_o85">â€”</div></div>
      <div class="kpi" data-market="sot_u85"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 8.5</div><div class="v pv" id="sot_u85">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_sot_95" style="margin-top:10px">
      <div class="kpi" data-market="sot_o95"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 9.5</div><div class="v pv" id="sot_o95">â€”</div></div>
      <div class="kpi" data-market="sot_u95"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 9.5</div><div class="v pv" id="sot_u95">â€”</div></div>
    </div>
  </div>

  <!-- 14) Disparos totales -->
  <div class="card">
    <h2>14) Disparos totales â€” FT</h2>
    <div class="kpis metrics">
      <div class="kpi"><div class="t">Î¼ Shots</div><div class="v" id="sh_mu">â€”</div></div>
      <div class="kpi"><div class="t">Î» L</div><div class="v" id="sh_lh">â€”</div></div>
      <div class="kpi"><div class="t">Î» V</div><div class="v" id="sh_la">â€”</div></div>
      <div class="kpi"><div class="t">Î» Tot</div><div class="v" id="sh_tot">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_sh_205" style="margin-top:10px">
      <div class="kpi" data-market="sh_o205"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 20.5</div><div class="v pv" id="sh_o205">â€”</div></div>
      <div class="kpi" data-market="sh_u205"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 20.5</div><div class="v pv" id="sh_u205">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_sh_225" style="margin-top:10px">
      <div class="kpi" data-market="sh_o225"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 22.5</div><div class="v pv" id="sh_o225">â€”</div></div>
      <div class="kpi" data-market="sh_u225"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 22.5</div><div class="v pv" id="sh_u225">â€”</div></div>
    </div>
    <div class="kpis" data-group="g_sh_245" style="margin-top:10px">
      <div class="kpi" data-market="sh_o245"><span class="badge-hot">ðŸ”¥</span><div class="t">Over 24.5</div><div class="v pv" id="sh_o245">â€”</div></div>
      <div class="kpi" data-market="sh_u245"><span class="badge-hot">ðŸ”¥</span><div class="t">Under 24.5</div><div class="v pv" id="sh_u245">â€”</div></div>
    </div>
  </div>

  <!-- 15) Marcadores -->
  <div class="card">
    <h2>15) Marcadores FT (0â€“10)</h2>
    <div style="overflow:auto; max-height:280px">
      <table id="scoretab_ft"><thead><tr><th>Marcador</th><th>Prob.</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
  <div class="card">
    <h2>16) Marcadores HT (0â€“5)</h2>
    <div style="overflow:auto; max-height:280px">
      <table id="scoretab_ht"><thead><tr><th>Marcador HT</th><th>Prob.</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<div class="wrap footer">
Las mÃ©tricas (Î¼ y Î») estÃ¡n ocultas para una vista limpia. Siguen alimentando los cÃ¡lculos.
Handicap AsiÃ¡tico: % = prob. de ganar la apuesta; lÃ­neas enteras muestran Push%.
Handicap Europeo 1X2: % y cuota implÃ­cita de 1H/XH/2H (Home) o 2H/XH/1H (Away).
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const leagueSel=$('league'), homeSel=$('home'), awaySel=$('away');
  const btnCalc=$('calc'), haInput=$('ha'), htFactorInput=$('htFactor'), haHTInput=$('ha_ht');
  const haCornersInput=$('ha_corners'), haCardsInput=$('ha_cards'), status=$('status');
  const scoreFT = document.querySelector('#scoretab_ft tbody');
  const scoreHT = document.querySelector('#scoretab_ht tbody');

  // ===== almacenamiento equipos =====
  let teams = {};
  function ensureTeam(l,t){
    teams[l]=teams[l]||{};
    teams[l][t]=teams[l][t]||{gf:0,ga:0,matches:0, cf:0,ca:0, yF:0,yA:0, rF:0,rA:0, sotF:0,sotA:0, shF:0, shA:0};
    return teams[l][t];
  }

  // ===== parseo =====
  function parsePotentialJSON(text){
    try{ const j=JSON.parse(text); return Array.isArray(j)? j:[j]; }
    catch(e){
      const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const arr=[]; for(const ln of lines){ try{arr.push(JSON.parse(ln));}catch(_){}} 
      if(arr.length) return arr;
      throw new Error("No se pudo leer el JSON. Verifica formato (array/objeto/NDJSON).");
    }
  }
  const num=x=>{ if(x==null||x==='')return 0; const s=String(x).replace(/,/g,'.').replace(/[^\d.\-+eE]/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };

  const keyMap = {
    league:/^(league|liga)$/i, team:/^(team|equipo|name|nombre)$/i, matches:/^(matches|mp|pj|games|partidos)$/i,
    gf:/^(gf|goals?\s*for|goles\s*a\s*favor|golesf|goles\s*hechos)$/i, ga:/^(ga|goals?\s*against|goles\s*contra|golesc|goles\s*recibidos)$/i,
    homeTeam:/^(hometeam|home\s*team|local|equipo\s*local)$/i, awayTeam:/^(awayteam|away\s*team|visitante|equipo\s*visitante)$/i,
    fthg:/^(fthg|home\s*(goals?|score)|goles\s*local|gf\s*local)$/i, ftag:/^(ftag|away\s*(goals?|score)|goles\s*visitante|gf\s*visitante)$/i,
    matchStr:/^(match|partido)$/i, resultFT:/^(result\s*ft|resultado\s*ft|ft\s*result|final\s*score|resultado)$/i,
    hc:/^(home\s*corners(?:\s*at\s*ft)?|corners?\s*local)/i, ac:/^(away\s*corners(?:\s*at\s*ft)?|corners?\s*visitante)/i,
    hy:/^(home\s*yellow(?:\s*cards?)?(?:\s*at\s*ft)?|amarillas\s*local)/i, ay:/^(away\s*yellow(?:\s*cards?)?(?:\s*at\s*ft)?|amarillas\s*visitante)/i,
    hr:/^(home\s*red(?:\s*cards?)?(?:\s*at\s*ft)?|rojas\s*local)/i, ar:/^(away\s*red(?:\s*cards?)?(?:\s*at\s*ft)?|rojas\s*visitante)/i,
    hSOT:/^(home\s*(on\s*goal|on\-?target)\s*shots(?:\s*at\s*ft)?|tiros\s*a\s*puerta?\s*local)/i,
    aSOT:/^(away\s*(on\s*goal|on\-?target)\s*shots(?:\s*at\s*ft)?|tiros\s*a\s*puerta?\s*visitante)/i,
    hSH:/^(home\s*total\s*shots|disparos\s*totales?\s*local)/i,
    aSH:/^(away\s*total\s*shots|disparos\s*totales?\s*visitante)/i
  };
  const findKey=(o,rx)=>{ for(const k of Object.keys(o)){ if(rx.test(k)) return k; } return null; };

  function accumulateTeam(l,t,gf,ga,cf,ca,yF,yA,rF,rA,sf,sa,shf,sha){
    const T=ensureTeam(l,t);
    T.gf+=gf;T.ga+=ga;T.cf+=cf;T.ca+=ca;T.yF+=yF;T.yA+=yA;T.rF+=rF;T.rA+=rA;T.sotF+=sf;T.sotA+=sa;T.shF+=shf;T.shA+=sha;T.matches++;
  }
  function parseMatchTeams(s){
    const sep=/\s+(?:-|â€“|â€”|vs\.?|VS|:)\s+/i; const p=String(s).split(sep).map(x=>x.trim()).filter(Boolean);
    return p.length>=2?[p[0],p[1]]:[null,null];
  }
  function parseScoreFT(s){ const m=String(s).match(/(\d+)\s*(?:-|â€“|â€”|:)\s*(\d+)/); return m? [num(m[1]),num(m[2])] : [null,null]; }

  function buildFromArray(arr){
    teams={};
    for(const row of arr){
      if(!row||typeof row!=='object') continue;
      const kL=findKey(row,keyMap.league); const league=kL? String(row[kL]).trim() :"â€”";
      const kTeam=findKey(row,keyMap.team), kGF=findKey(row,keyMap.gf), kGA=findKey(row,keyMap.ga), kM=findKey(row,keyMap.matches);
      const kHT=findKey(row,keyMap.homeTeam), kAT=findKey(row,keyMap.awayTeam), kFTHG=findKey(row,keyMap.fthg), kFTAG=findKey(row,keyMap.ftag);
      const kMatch=findKey(row,keyMap.matchStr), kResFT=findKey(row,keyMap.resultFT);
      const kHC=findKey(row,keyMap.hc), kAC=findKey(row,keyMap.ac), kHY=findKey(row,keyMap.hy), kAY=findKey(row,keyMap.ay), kHR=findKey(row,keyMap.hr), kAR=findKey(row,keyMap.ar);
      const kHSOT=findKey(row,keyMap.hSOT), kASOT=findKey(row,keyMap.aSOT), kHSH=findKey(row,keyMap.hSH), kASH=findKey(row,keyMap.aSH);

      if(kTeam && (kGF||kGA) && kM){
        const t=String(row[kTeam]).trim();
        const T=ensureTeam(league,t);
        T.gf += num(row[kGF]); T.ga += num(row[kGA]); T.matches += Math.max(1,num(row[kM]));
        T.cf += num(row[kHC]||0); T.ca += num(row[kAC]||0);
        T.yF += num(row[kHY]||0); T.yA += num(row[kAY]||0);
        T.rF += num(row[kHR]||0); T.rA += num(row[kAR]||0);
        T.sotF+= num(row[kHSOT]||0); T.sotA+= num(row[kASOT]||0);
        T.shF += num(row[kHSH]||0);  T.shA += num(row[kASH]||0);
      }else if(kHT && kAT && (kFTHG||kFTAG)){
        const ht=String(row[kHT]).trim(), at=String(row[kAT]).trim();
        const gh=num(row[kFTHG]), ga=num(row[kFTAG]);
        const hc=num(row[kHC]||0), ac=num(row[kAC]||0);
        const hy=num(row[kHY]||0), ay=num(row[kAY]||0);
        const hr=num(row[kHR]||0), ar=num(row[kAR]||0);
        const hs=num(row[kHSOT]||0), as=num(row[kASOT]||0);
        const hsh=num(row[kHSH]||0), ash=num(row[kASH]||0);
        accumulateTeam(league,ht,gh,ga,hc,ac,hy,ay,hr,ar,hs,as,hsh,ash);
        accumulateTeam(league,at,ga,gh,ac,hc,ay,hy,ar,hr,as,hs,ash,hsh);
      }else if(kMatch && kResFT){
        const [ht,at]=parseMatchTeams(row[kMatch]);
        const [gh,ga]=parseScoreFT(row[kResFT]);
        if(ht&&at&&Number.isFinite(gh)&&Number.isFinite(ga)){
          const hc=num(row[kHC]||0), ac=num(row[kAC]||0);
          const hy=num(row[kHY]||0), ay=num(row[kAY]||0);
          const hr=num(row[kHR]||0), ar=num(row[kAR]||0);
          const hs=num(row[kHSOT]||0), as=num(row[kASOT]||0);
          const hsh=num(row[kHSH]||0), ash=num(row[kASH]||0);
          accumulateTeam(league,ht,gh,ga,hc,ac,hy,ay,hr,ar,hs,as,hsh,ash);
          accumulateTeam(league,at,ga,gh,ac,hc,ay,hy,ar,hr,as,hs,ash,hsh);
        }
      }
    }
  }

  // ===== UI helpers =====
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function fillSelectors(autoselect=true){
    const leagues=Object.keys(teams).sort((a,b)=>a.localeCompare(b));
    $('league').innerHTML='<option value="">â€” Selecciona liga â€”</option>'+leagues.map(l=>`<option>${escapeHtml(l)}</option>`).join('');
    leagueSel.disabled = leagues.length===0;
    function setTeams(lig){
      const list=lig&&teams[lig]? Object.keys(teams[lig]).sort((a,b)=>a.localeCompare(b)):[];
      const opts='<option value="">â€” Equipo â€”</option>'+list.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
      homeSel.innerHTML=opts; awaySel.innerHTML=opts;
      homeSel.disabled=!list.length; awaySel.disabled=!list.length; btnCalc.disabled=!list.length;
      if(autoselect && list.length>=2){ homeSel.value=list[0]; awaySel.value=list[1]; }
    }
    setTeams(leagues[0]||"");
    leagueSel.addEventListener('change',()=>setTeams(leagueSel.value));
  }

  // ===== Poisson & utils =====
  const factMemo=[1]; function fact(n){ for(let i=factMemo.length;i<=n;i++) factMemo[i]=factMemo[i-1]*i; return factMemo[n]; }
  const pmf=(k,l)=> Math.exp(-l)*Math.pow(l,k)/fact(k);
  const cdf=(k,l)=>{let s=0;for(let i=0;i<=k;i++)s+=pmf(i,l);return s;};
  const clamp=(x,min,max)=> Math.max(min,Math.min(max,x));
  const fmtPct=p=> (p*100).toFixed(2)+' %';
  const fmtOdds=p=>{ if(p<=0) return 'â€”'; const o=1/Math.max(p,1e-9); return (o>5000?5000:o).toFixed(2); };

  function setProb(id, p){
    const el = $(id); if(!el) return;
    el.textContent = (p*100).toFixed(1)+'%';
    const kpi = el.closest('.kpi'); if(kpi){ kpi.dataset.prob = String(p); kpi.classList.remove('hot'); }
  }
  function markGroupTop(selector){
    const root = document.querySelector(selector); if(!root) return;
    const items = Array.from(root.querySelectorAll('.kpi[data-prob]')).map(k=>({k, p:Number(k.dataset.prob||'0')}));
    if(!items.length) return; items.forEach(x=>x.k.classList.remove('hot')); items.sort((a,b)=>b.p-a.p); items[0].k.classList.add('hot');
  }

  // ===== cÃ¡lculo principal =====
  function compute(){
    status && (status.textContent='');

    const lig=leagueSel.value, home=homeSel.value, away=awaySel.value;
    const HA=clamp(Number(haInput.value)||1.00,0.5,1.6);
    const factorHT=clamp(Number(htFactorInput.value)||0.45,0.2,0.8);
    const HA_HT=clamp(Number(haHTInput.value)||1.00,0.5,1.6);
    const HA_COR=clamp(Number(haCornersInput.value)||1.05,0.8,1.4);
    const HA_CAR=clamp(Number(haCardsInput.value)||1.00,0.8,1.4);

    if(!lig||!teams[lig]){ status.textContent='Elige una liga.'; return; }
    if(!home||!away||home===away){ status.textContent='Elige dos equipos distintos.'; return; }

    const tH=teams[lig][home], tA=teams[lig][away];
    if(!tH||!tA){ status.textContent='Faltan datos para esos equipos.'; return; }

    // Medias liga
    let sumGF=0,sumM=0,sumCF=0,sumY=0,sumR=0,sumSOT=0,sumSH=0;
    for(const t of Object.values(teams[lig])){ sumGF+=t.gf; sumM+=t.matches; sumCF+=t.cf; sumY+=t.yF; sumR+=t.rF; sumSOT+=t.sotF; sumSH+=t.shF; }
    const mu  = sumM>0 ? (sumGF/Math.max(1,sumM)) : 1.25;
    const muC = sumM>0 ? (sumCF/Math.max(1,sumM)) : 4.8;
    const muY = sumM>0 ? (sumY /Math.max(1,sumM)) : 2.4;
    const muR = sumM>0 ? (sumR /Math.max(1,sumM)) : 0.18;
    const muSOT = sumM>0 ? (sumSOT/Math.max(1,sumM)) : 4.2;
    const muSH  = sumM>0 ? (sumSH /Math.max(1,sumM)) : 12.0;

    // Promedios por equipo
    const h = {
      gfpm: tH.matches? tH.gf/tH.matches : mu,  gapm: tH.matches? tH.ga/tH.matches : mu,
      cfpm: tH.matches? tH.cf/tH.matches : muC, capm: tH.matches? tH.ca/tH.matches : muC,
      ypm:  tH.matches? tH.yF/tH.matches : muY, yapm: tH.matches? tH.yA/tH.matches : muY,
      rpm:  tH.matches? tH.rF/tH.matches : muR, rapm: tH.matches? tH.rA/tH.matches : muR,
      sotpm:tH.matches? tH.sotF/tH.matches: muSOT, sota: tH.matches? tH.sotA/tH.matches: muSOT,
      shpm: tH.matches? tH.shF/tH.matches : muSH,  sha:  tH.matches? tH.shA/tH.matches : muSH
    };
    const a = {
      gfpm: tA.matches? tA.gf/tA.matches : mu,  gapm: tA.matches? tA.ga/tA.matches : mu,
      cfpm: tA.matches? tA.cf/tA.matches : muC, capm: tA.matches? tA.ca/tA.matches : muC,
      ypm:  tA.matches? tA.yF/tA.matches : muY, yapm: tA.matches? tA.yA/tA.matches : muY,
      rpm:  tA.matches? tA.rF/tA.matches : muR, rapm: tA.matches? tA.rA/tA.matches : muR,
      sotpm:tA.matches? tA.sotF/tA.matches: muSOT, sota: tA.matches? tA.sotA/tA.matches: muSOT,
      shpm: tA.matches? tA.shF/tA.matches : muSH,  sha:  tA.matches? tA.shA/tA.matches : muSH
    };

    // Î» goles
    const attH=h.gfpm/Math.max(mu,1e-9), defH=h.gapm/Math.max(mu,1e-9);
    const attA=a.gfpm/Math.max(mu,1e-9), defA=a.gapm/Math.max(mu,1e-9);
    const Î»H = attH*defA*mu*HA;
    const Î»A = attA*defH*mu;

    // KPIs ocultas
    $('k_mu').textContent=mu.toFixed(3);
    $('k_att_h').textContent=attH.toFixed(3);
    $('k_def_h').textContent=defH.toFixed(3);
    $('k_att_a').textContent=attA.toFixed(3);
    $('k_def_a').textContent=defA.toFixed(3);
    $('k_lh').textContent=Î»H.toFixed(3);
    $('k_la').textContent=Î»A.toFixed(3);

    // ===== Distribuciones FT =====
    const MAX=10;
    const pH=Array.from({length:MAX+1},(_,k)=>pmf(k,Î»H));
    const pA=Array.from({length:MAX+1},(_,k)=>pmf(k,Î»A));

    const S=Array(MAX*2+1).fill(0);     // total goals
    const D=Array(2*MAX+1).fill(0);     // diferencias h-a en [-MAX..MAX]
    let p1=0,px=0,p2=0,pUnder25=0; let rows=[];
    for(let hg=0;hg<=MAX;hg++){
      for(let ag=0;ag<=MAX;ag++){
        const p=pH[hg]*pA[ag]; if(!p) continue;
        rows.push({score:`${hg}-${ag}`,p});
        if(hg>ag) p1+=p; else if(hg===ag) px+=p; else p2+=p;
        if(hg+ag<=2) pUnder25+=p;
        S[hg+ag]+=p;
        D[hg-ag+MAX]+=p;
      }
    }
    const pOver25=1-pUnder25;
    setProb('ft_1', p1); setProb('ft_x', px); setProb('ft_2', p2);
    setProb('m_o25', pOver25); setProb('m_u25', pUnder25);
    markGroupTop('[data-group="g_ft_1x2"]'); markGroupTop('[data-group="g_ft_ou25"]');

    // BTTS
    const pBTTS = 1 - (pH[0]||0) - (pA[0]||0) + (pH[0]||0)*(pA[0]||0);
    setProb('m_btts_yes', pBTTS); setProb('m_btts_no', 1 - pBTTS); markGroupTop('[data-group="g_ft_btts"]');

    rows.sort((a,b)=>b.p-a.p);
    scoreFT.innerHTML=rows.slice(0,50).map(x=>`<tr><td><span class="pill">${x.score}</span></td><td>${(x.p*100).toFixed(3)}%</td></tr>`).join('');

    // ===== Handicap AsiÃ¡tico (diferencias D) =====
    const linesAH = [-2.5,-2,-1.5,-1,-0.5,0.5,1,1.5,2,2.5];
    function probHomeAH(line){
      let win=0,push=0,lose=0;
      for(let d=-MAX; d<=MAX; d++){
        const p=D[d+MAX]||0; if(!p) continue;
        if(d>line) win+=p; else if(Number.isInteger(line) && d===line) push+=p; else lose+=p;
      }
      return {win,push,lose};
    }
    function probAwayAH(line){
      // equivalente a comparar d < -line (push si d == -line)
      let win=0,push=0,lose=0; const L=-line;
      for(let d=-MAX; d<=MAX; d++){
        const p=D[d+MAX]||0; if(!p) continue;
        if(d<L) win+=p; else if(Number.isInteger(L) && d===L) push+=p; else lose+=p;
      }
      return {win,push,lose};
    }
    function renderAH(tableId, side){
      let html='<tr><th>LÃ­nea</th><th>Win%</th><th>Cuota</th><th>Push%</th></tr>';
      for(const L of linesAH){
        const r = side==='home'? probHomeAH(L): probAwayAH(L);
        html += `<tr>
          <td><b>${(L>0?'+':'')+L}</b></td>
          <td>${fmtPct(r.win)}</td>
          <td><span class="o">${fmtOdds(r.win)}</span></td>
          <td>${Number.isInteger(L)? fmtPct(r.push) : 'â€”'}</td>
        </tr>`;
      }
      $(tableId).innerHTML=html;
    }
    renderAH('table-ah-home','home');
    renderAH('table-ah-away','away');

    // ===== Handicap Europeo 1X2 =====
    const linesEH = [-2,-1,1,2]; // lÃ­neas enteras
    function probEH_home(h){ // aplica h al local: comparar (d + h)
      let p1h=0, pxh=0, p2h=0;
      for(let d=-MAX; d<=MAX; d++){
        const p=D[d+MAX]||0; const adj=d+h;
        if(adj>0) p1h+=p; else if(adj===0) pxh+=p; else p2h+=p;
      }
      return {p1h,pxh,p2h};
    }
    function probEH_away(h){ // aplica h al visitante: comparar (d - h)
      let p2h=0, pxh=0, p1h=0;
      for(let d=-MAX; d<=MAX; d++){
        const p=D[d+MAX]||0; const adj=d-h;
        if(adj<0) p2h+=p; else if(adj===0) pxh+=p; else p1h+=p;
      }
      return {p2h,pxh,p1h};
    }
    function renderEHHome(){
      let html='<tr><th>LÃ­nea (Home)</th><th>1H</th><th>XH</th><th>2H</th></tr>';
      for(const h of linesEH){
        const r=probEH_home(h);
        html += `<tr>
          <td><b>${(h>0?'+':'')+h}</b></td>
          <td>${fmtPct(r.p1h)}<span class="sub">@${fmtOdds(r.p1h)}</span></td>
          <td>${fmtPct(r.pxh)}<span class="sub">@${fmtOdds(r.pxh)}</span></td>
          <td>${fmtPct(r.p2h)}<span class="sub">@${fmtOdds(r.p2h)}</span></td>
        </tr>`;
      }
      $('table-eh-home').innerHTML=html;
    }
    function renderEHAway(){
      let html='<tr><th>LÃ­nea (Away)</th><th>2H</th><th>XH</th><th>1H</th></tr>';
      for(const h of linesEH){
        const r=probEH_away(h);
        html += `<tr>
          <td><b>${(h>0?'+':'')+h}</b></td>
          <td>${fmtPct(r.p2h)}<span class="sub">@${fmtOdds(r.p2h)}</span></td>
          <td>${fmtPct(r.pxh)}<span class="sub">@${fmtOdds(r.pxh)}</span></td>
          <td>${fmtPct(r.p1h)}<span class="sub">@${fmtOdds(r.p1h)}</span></td>
        </tr>`;
      }
      $('table-eh-away').innerHTML=html;
    }
    renderEHHome();
    renderEHAway();

    // ===== HT =====
    const Î»H_HT = Î»H * factorHT * ((clamp(Number(haHTInput.value)||1,0.5,1.6))/HA);
    const Î»A_HT = Î»A * factorHT;
    const MAXH=5;
    const pH_ht = Array.from({length:MAXH+1},(_,k)=>pmf(k,Î»H_HT));
    const pA_ht = Array.from({length:MAXH+1},(_,k)=>pmf(k,Î»A_HT));
    let ht1=0,htx=0,ht2=0, u05=0, u15=0; let rowsHT=[];
    for(let hg=0; hg<=MAXH; hg++){
      for(let ag=0; ag<=MAXH; ag++){
        const p=pH_ht[hg]*pA_ht[ag];
        rowsHT.push({score:`${hg}-${ag}`,p});
        if(hg>ag) ht1+=p; else if(hg===ag) htx+=p; else ht2+=p;
        if(hg+ag<=0) u05+=p; if(hg+ag<=1) u15+=p;
      }
    }
    const o05=1-u05, o15=1-u15;
    $('ht_1').textContent=fmtPct(ht1); $('ht_x').textContent=fmtPct(htx); $('ht_2').textContent=fmtPct(ht2);
    $('ht_o05').textContent=fmtPct(o05); $('ht_u05').textContent=fmtPct(u05);
    $('ht_o15').textContent=fmtPct(o15); $('ht_u15').textContent=fmtPct(u15);
    rowsHT.sort((a,b)=>b.p-a.p);
    scoreHT.innerHTML=rowsHT.slice(0,40).map(x=>`<tr><td><span class="pill">${x.score}</span></td><td>${(x.p*100).toFixed(3)}%</td></tr>`).join('');

    // ===== CÃ³rners =====
    const attC_H = h.cfpm/Math.max(muC,1e-9), defC_A = a.capm/Math.max(muC,1e-9);
    const attC_A = a.cfpm/Math.max(muC,1e-9), defC_H = h.capm/Math.max(muC,1e-9);
    const Î»C_H = attC_H * defC_A * muC * HA_COR;
    const Î»C_A = attC_A * defC_H * muC;
    const Î»C_T = Î»C_H + Î»C_A;
    setProb('c_o85', 1 - cdf(8, Î»C_T)); setProb('c_u85', cdf(8, Î»C_T));
    setProb('c_o95', 1 - cdf(9, Î»C_T)); setProb('c_u95', cdf(9, Î»C_T));
    setProb('c_o105',1 - cdf(10,Î»C_T)); setProb('c_u105',cdf(10,Î»C_T));

    // ===== Tarjetas =====
    const attY_H = h.ypm/Math.max(muY,1e-9), defY_A = a.yapm/Math.max(muY,1e-9);
    const attY_A = a.ypm/Math.max(muY,1e-9), defY_H = h.yapm/Math.max(muY,1e-9);
    const Î»Y_H = attY_H * defY_A * muY * HA_CAR;
    const Î»Y_A = attY_A * defY_H * muY;
    const Î»Y_T = Î»Y_H + Î»Y_A;
    setProb('y_o35', 1 - cdf(3, Î»Y_T)); setProb('y_u35', cdf(3, Î»Y_T));
    setProb('y_o45', 1 - cdf(4, Î»Y_T)); setProb('y_u45', cdf(4, Î»Y_T));

    const attR_H = h.rpm/Math.max(muR,1e-9), defR_A = a.rapm/Math.max(muR,1e-9);
    const attR_A = a.rpm/Math.max(muR,1e-9), defR_H = h.rapm/Math.max(muR,1e-9);
    const Î»R_H = attR_H * defR_A * muR * HA_CAR;
    const Î»R_A = attR_A * defR_H * muR;
    const Î»R_T = Î»R_H + Î»R_A;
    const r_o05 = 1 - cdf(0, Î»R_T);
    const r_o15 = 1 - cdf(1, Î»R_T);
    $('r_any').textContent=(r_o05*100).toFixed(1)+'%';
    setProb('r_o05', r_o05); setProb('r_u05', 1 - r_o05);
    setProb('r_o15', r_o15); setProb('r_u15', 1 - r_o15);

    // ===== Disparos (SoT / Shots) =====
    const attSOT_H = h.sotpm/Math.max(muSOT,1e-9), defSOT_A = a.sota/Math.max(muSOT,1e-9);
    const attSOT_A = a.sotpm/Math.max(muSOT,1e-9), defSOT_H = h.sota/Math.max(muSOT,1e-9);
    const Î»SOT_H = attSOT_H * defSOT_A * muSOT * HA;
    const Î»SOT_A = attSOT_A * defSOT_H * muSOT;
    const Î»SOT_T = Î»SOT_H + Î»SOT_A;
    setProb('sot_o75', 1 - cdf(7,  Î»SOT_T)); setProb('sot_u75', cdf(7,  Î»SOT_T));
    setProb('sot_o85', 1 - cdf(8,  Î»SOT_T)); setProb('sot_u85', cdf(8,  Î»SOT_T));
    setProb('sot_o95', 1 - cdf(9,  Î»SOT_T)); setProb('sot_u95', cdf(9,  Î»SOT_T));

    const attSH_H = h.shpm/Math.max(muSH,1e-9), defSH_A = a.sha/Math.max(muSH,1e-9);
    const attSH_A = a.shpm/Math.max(muSH,1e-9), defSH_H = h.sha/Math.max(muSH,1e-9);
    const Î»SH_H = attSH_H * defSH_A * muSH * HA;
    const Î»SH_A = attSH_A * defSH_H * muSH;
    const Î»SH_T = Î»SH_H + Î»SH_A;
    setProb('sh_o205', 1 - cdf(20, Î»SH_T)); setProb('sh_u205', cdf(20, Î»SH_T));
    setProb('sh_o225', 1 - cdf(22, Î»SH_T)); setProb('sh_u225', cdf(22, Î»SH_T));
    setProb('sh_o245', 1 - cdf(24, Î»SH_T)); setProb('sh_u245', cdf(24, Î»SH_T));
  }

  // eventos
  btnCalc.addEventListener('click', compute);
  document.getElementById('file').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text=await f.text();
      const arr=parsePotentialJSON(text);
      if(!arr.length) throw new Error("El archivo estÃ¡ vacÃ­o.");
      buildFromArray(arr);
      // Selectores
      const leagues=Object.keys(teams).sort((a,b)=>a.localeCompare(b));
      leagueSel.innerHTML='<option value="">â€” Selecciona liga â€”</option>'+leagues.map(l=>`<option>${l}</option>`).join('');
      leagueSel.disabled = leagues.length===0;
      function setTeams(lig){
        const list=lig&&teams[lig]? Object.keys(teams[lig]).sort((a,b)=>a.localeCompare(b)):[];
        const opts='<option value="">â€” Equipo â€”</option>'+list.map(t=>`<option>${t}</option>`).join('');
        homeSel.innerHTML=opts; awaySel.innerHTML=opts;
        homeSel.disabled=!list.length; awaySel.disabled=!list.length; btnCalc.disabled=!list.length;
        if(list.length>=2){ homeSel.value=list[0]; awaySel.value=list[1]; }
      }
      setTeams(leagues[0]||"");
      leagueSel.addEventListener('change',()=>setTeams(leagueSel.value));
      status && (status.textContent='Datos cargados âœ” Selecciona y pulsa Calcular.');
      btnCalc.disabled=false;
    }catch(err){
      leagueSel.disabled=true; homeSel.disabled=true; awaySel.disabled=true; btnCalc.disabled=true;
      leagueSel.innerHTML=''; homeSel.innerHTML=''; awaySel.innerHTML='';
      status && (status.textContent=err.message||'Error al leer el JSON.');
    }
  });
})();
</script>
</body>
</html>
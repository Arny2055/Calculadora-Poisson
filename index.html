<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Poisson — OU (línea libre) + BTTS</title>
<style>
  :root{
    --bg: #0b0f16;
    --panel: rgba(28,34,47,0.75);
    --panel-solid:#1c222f;
    --text:#eaf0ff;
    --muted:#98a2b3;
    --accent:#6aa8ff;
    --accent-2:#67e3a1;
    --border:#2b3446;
    --ring:#86b8ff;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 10% -10%, #20304b 0%, transparent 60%),
      radial-gradient(900px 600px at 110% 10%, #1a3b2c 0%, transparent 55%),
      linear-gradient(180deg,#0a0d13 0%, #0b0f16 100%);
  }
  header{
    position:sticky; top:0; z-index:10;
    background: linear-gradient(90deg,#182033, #10213b 40%, #152235 60%, #14202f);
    border-bottom:1px solid var(--border);
    box-shadow: 0 2px 18px rgba(0,0,0,.35);
  }
  .head{
    max-width:1000px; margin:0 auto; padding:18px 20px; display:flex; align-items:center; gap:14px;
  }
  .logo{
    width:36px; height:36px; border-radius:10px; background:
    radial-gradient(140% 80% at 30% 20%, #6aa8ff 0%, #2b82ff 35%, #2662ff00 70%),
    radial-gradient(130% 90% at 70% 60%, #67e3a1 0%, #31c77d 40%, #2bff5500 75%);
    box-shadow:0 6px 18px rgba(104,165,255,.45);
    border:1px solid #365a96;
  }
  h1{font-size:18px; font-weight:800; letter-spacing:.3px; margin:0}
  .sub{font-size:12px; color:var(--muted)}

  .wrap{max-width:1000px; margin:28px auto; padding:0 20px; display:grid; gap:20px}

  .card{
    background: var(--panel);
    border:1px solid var(--border);
    border-radius:16px;
    backdrop-filter: blur(6px);
    box-shadow: var(--shadow);
  }
  .card > .pad{padding:18px}

  h2{font-size:16px; margin:0 0 10px 0; color:var(--accent); letter-spacing:.2px}

  .grid{
    display:grid; gap:14px;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }

  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  input[type="number"]{
    width:100%; padding:12px 12px; border:1px solid var(--border); border-radius:12px;
    background:#0f1420; color:var(--text); outline:none; font-size:14px;
  }
  input[type="number"]:focus{border-color:var(--ring); box-shadow:0 0 0 4px rgba(106,168,255,.12)}

  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{
    padding:8px 10px; border-radius:999px; border:1px solid var(--border);
    background:#0f1420; color:var(--muted); font-size:12px; cursor:pointer; user-select:none;
    transition:all .15s;
  }
  .chip:hover{color:var(--text); border-color:#3a4b66}
  .chip.active{background:#12243d; color:#cfe2ff; border-color:#355e9b}

  .range{
    margin-top:6px; display:flex; align-items:center; gap:10px;
  }
  input[type="range"]{
    -webkit-appearance:none; appearance:none; width:100%; height:10px; border-radius:999px;
    background: linear-gradient(90deg, #26456f, #3763a1);
    outline:none;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
    background:#fff; border:3px solid #2f7dff; box-shadow:0 0 0 4px rgba(106,168,255,.25);
    cursor:pointer;
  }

  table{width:100%; border-collapse:collapse; border-radius:12px; overflow:hidden}
  thead th{
    font-size:11px; color:#c5cee0; text-transform:uppercase; letter-spacing:.6px;
    background: #121a29; border-bottom:1px solid var(--border); padding:12px; text-align:right;
  }
  thead th:first-child{text-align:left}
  tbody td{padding:12px; border-bottom:1px solid var(--border); text-align:right; font-size:14px}
  tbody tr:last-child td{border-bottom:none}
  tbody td:first-child{text-align:left}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .pillbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  .pill{
    padding:6px 10px; border-radius:999px; border:1px solid var(--border);
    background:#0f1420; color:#cbd5e1; font-size:12px;
  }
  .accent{color:#bcd8ff}
  .ok{color:#b8f3d3}
  .hint{font-size:12px; color:var(--muted); margin-top:10px}

  .kpis{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:10px
  }
  .kpi{
    background:var(--panel-solid); border:1px solid var(--border); border-radius:12px; padding:12px;
  }
  .kpi .k{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px}
  .kpi .v{font-size:18px; font-weight:800; margin-top:6px}
</style>
</head>
<body>
  <header>
    <div class="head">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Calculadora Poisson — Over/Under + BTTS</h1>
        <div class="sub">Línea libre (.0 / .5 / .25 / .75) · Cálculo en vivo</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Entradas -->
    <section class="card">
      <div class="pad">
        <h2>Parámetros de entrada</h2>
        <div class="grid">
          <div>
            <label>GF Local (λ<sub>H</sub>)</label>
            <input id="gfH" type="number" step="0.01" min="0" value="1.40" />
          </div>
          <div>
            <label>GF Visitante (λ<sub>A</sub>)</label>
            <input id="gfA" type="number" step="0.01" min="0" value="1.60" />
          </div>
          <div>
            <label>Línea OU (escribe o elige un preset)</label>
            <input id="line" type="number" step="0.25" min="0" value="2.50" />
            <div class="chips" id="presets">
              <div class="chip">0.5</div>
              <div class="chip">1.5</div>
              <div class="chip active">2.5</div>
              <div class="chip">3.0</div>
              <div class="chip">3.5</div>
              <div class="chip">2.25</div>
              <div class="chip">2.75</div>
            </div>
          </div>
          <div>
            <label>Ajusta la línea rápidamente</label>
            <div class="range">
              <input id="lineRange" type="range" min="0" max="6" step="0.25" value="2.5"/>
              <span id="lineLbl" class="mono accent">2.50</span>
            </div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">λ<sub>H</sub> (local)</div>
            <div class="v mono" id="kLamH">1.40</div>
          </div>
          <div class="kpi">
            <div class="k">λ<sub>A</sub> (visita)</div>
            <div class="v mono" id="kLamA">1.60</div>
          </div>
          <div class="kpi">
            <div class="k">λ<sub>T</sub> (total)</div>
            <div class="v mono" id="kLamT">3.00</div>
          </div>
        </div>
        <div class="hint">Modelo: X~Pois(λ<sub>H</sub>), Y~Pois(λ<sub>A</sub>), N=X+Y~Pois(λ<sub>T</sub>=λ<sub>H</sub>+λ<sub>A</sub>).</div>
      </div>
    </section>

    <!-- Over/Under -->
    <section class="card">
      <div class="pad">
        <h2>Over/Under — Línea <span class="mono" id="lineHead">2.50</span></h2>
        <div class="pillbar" id="summary"></div>
        <table>
          <thead>
            <tr><th>Resultado</th><th class="mono">Over</th><th class="mono">Under</th></tr>
          </thead>
          <tbody id="tbodyOU"></tbody>
        </table>
        <table style="margin-top:10px">
          <thead>
            <tr><th>Métrica</th><th class="mono">Over</th><th class="mono">Under</th></tr>
          </thead>
          <tbody id="tbodyOU2"></tbody>
        </table>
        <div class="hint">Para líneas .25/.75 se usa la descomposición asiática: 0.5×(línea base) + 0.5×(línea ±0.5).</div>
      </div>
    </section>

    <!-- BTTS -->
    <section class="card">
      <div class="pad">
        <h2>BTTS</h2>
        <table>
          <thead><tr><th>Mercado</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
          <tbody id="tbodyBTTS"></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
(function(){
  const $ = s => document.querySelector(s);

  // -------- utilidades poisson --------
  const fact = [1];
  function factorial(n){for(let i=fact.length;i<=n;i++) fact[i]=fact[i-1]*i; return fact[n]}
  function logFactorial(n){if(n<100) return Math.log(factorial(n)); const x=n; return x*Math.log(x)-x+0.5*Math.log(2*Math.PI*x)}
  function pmf(k,lambda){
    if(lambda<=0) return (k===0)?1:0;
    if(k<100) return Math.exp(-lambda) * Math.pow(lambda,k) / factorial(k);
    return Math.exp(-lambda + k*Math.log(lambda) - logFactorial(k));
  }
  function cdf(k,lambda){let s=0; for(let i=0;i<=k;i++) s+=pmf(i,lambda); return s}
  function fmtP(p){return (100*p).toFixed(2)+'%'}
  function toOdds(p){return (p<=0)? Infinity : 1/p}
  function fmtO(o){return (o===Infinity)? '—' : o.toFixed(2)}
  function clamp(x,lo,hi){return Math.max(lo, Math.min(hi, x))}

  // --- OU components: base (k o k+0.5) ---
  function compOver(lambdaT, Lc){
    const k = Math.floor(Lc+1e-9);
    const isHalf = Math.abs(Lc-(k+0.5))<1e-9;
    const Fk = cdf(k, lambdaT);
    const Fk_1 = cdf(k-1, lambdaT);
    const pk = Fk - Fk_1; // P(N=k)
    if(isHalf){ // Over k+0.5
      return {win:1-Fk, push:0, loss:Fk};
    }else{      // Over k.0
      return {win:1-Fk, push:pk, loss:Fk_1};
    }
  }
  function asianOver(lambdaT, L){
    const k = Math.floor(L);
    const frac = +(L - k).toFixed(2);
    if(frac===0 || frac===0.5) return compOver(lambdaT, L);
    if(frac===0.25){ // 0.5*Over(k) + 0.5*Over(k+0.5)
      const a=compOver(lambdaT,k), b=compOver(lambdaT,k+0.5);
      return {win:0.5*(a.win+b.win), push:0.5*(a.push+b.push), loss:0.5*(a.loss+b.loss)};
    }
    if(frac===0.75){ // 0.5*Over(k+0.5) + 0.5*Over(k+1.0)
      const a=compOver(lambdaT,k+0.5), b=compOver(lambdaT,k+1.0);
      return {win:0.5*(a.win+b.win), push:0.5*(a.push+b.push), loss:0.5*(a.loss+b.loss)};
    }
    // fracciones raras → redondea a .0/.5 más cercano
    const nearest = Math.abs(frac-0.5) < Math.abs(frac-0) ? (k+0.5) : k;
    return compOver(lambdaT, nearest);
  }
  function asianUnder(lambdaT, L){
    const o = asianOver(lambdaT, L);
    return {win:o.loss, push:o.push, loss:o.win};
  }

  // --------- cálculo principal ----------
  function recalc(){
    const lamH = Math.max(0, +$('#gfH').value||0);
    const lamA = Math.max(0, +$('#gfA').value||0);
    let L = +$('#line').value||0;
    L = clamp(L, 0, 15);

    const lamT = lamH + lamA;

    // actualizar kpis
    $('#kLamH').textContent = lamH.toFixed(2);
    $('#kLamA').textContent = lamA.toFixed(2);
    $('#kLamT').textContent = lamT.toFixed(2);
    $('#lineHead').textContent = L.toFixed(2);
    $('#lineLbl').textContent = L.toFixed(2);

    // seleccionar chip activo (si coincide)
    document.querySelectorAll('.chip').forEach(ch => {
      const v = parseFloat(ch.textContent);
      ch.classList.toggle('active', Math.abs(v - L) < 1e-9);
    });

    // OU
    const over = asianOver(lamT, L);
    const under = asianUnder(lamT, L);

    // “prob. de cobrar” (win + 0.5*push en 3-way aproximado)
    const pCashOver  = over.win + 0.5*over.push;
    const pCashUnder = under.win + 0.5*under.push;

    // resumen pills
    $('#summary').innerHTML = `
      <span class="pill">Over <b class="mono accent">${fmtP(pCashOver)}</b> · cuota ${fmtO(1/Math.max(1e-12,pCashOver))}</span>
      <span class="pill">Under <b class="mono accent">${fmtP(pCashUnder)}</b> · cuota ${fmtO(1/Math.max(1e-12,pCashUnder))}</span>
    `;

    // tablas OU
    $('#tbodyOU').innerHTML = `
      <tr><td>Win</td><td class="mono">${fmtP(over.win)}</td><td class="mono">${fmtP(under.win)}</td></tr>
      <tr><td>Push</td><td class="mono">${fmtP(over.push)}</td><td class="mono">${fmtP(under.push)}</td></tr>
      <tr><td>Loss</td><td class="mono">${fmtP(over.loss)}</td><td class="mono">${fmtP(under.loss)}</td></tr>
    `;
    $('#tbodyOU2').innerHTML = `
      <tr><td>Prob. de cobrar (win + 0.5·push)</td><td class="mono">${fmtP(pCashOver)}</td><td class="mono">${fmtP(pCashUnder)}</td></tr>
      <tr><td>Cuota justa aprox.</td><td class="mono">${fmtO(1/Math.max(1e-12,pCashOver))}</td><td class="mono">${fmtO(1/Math.max(1e-12,pCashUnder))}</td></tr>
    `;

    // BTTS
    const pBTTS = 1 - Math.exp(-lamH) - Math.exp(-lamA) + Math.exp(-(lamT));
    const pNo   = 1 - pBTTS;
    $('#tbodyBTTS').innerHTML = `
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTS)}</td><td class="mono">${fmtO(toOdds(pBTTS))}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pNo)}</td><td class="mono">${fmtO(toOdds(pNo))}</td></tr>
    `;
  }

  // --------- eventos ----------
  // recalcular al escribir
  ['gfH','gfA','line'].forEach(id => {
    $(\`#\${id}\`).addEventListener('input', recalc);
  });

  // presets chips
  $('#presets').addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const v = parseFloat(chip.textContent);
    $('#line').value = v;
    $('#lineRange').value = v;
    recalc();
  });

  // range sincronizado con input
  $('#lineRange').addEventListener('input', (e)=>{
    const v = parseFloat(e.target.value);
    $('#line').value = v;
    recalc();
  });

  // init
  recalc();
})();
</script>
</body>
</html>
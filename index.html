<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Football Backtester v7.0 (Poisson Core)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root {
            --bg-main: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
            --poisson-bg: #4c1d95; /* Morado para Poisson */
            --poisson-accent: #a78bfa;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: var(--bg-panel);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .brand { font-weight: 700; display: flex; align-items: center; gap: 10px; min-width: 180px; }
        .tag { font-size:0.7em; background:var(--poisson-bg); padding:2px 6px; border-radius:4px; color:white; }
        
        .url-bar { 
            display: grid; 
            grid-template-columns: 1fr 1fr auto; 
            gap: 10px; 
            flex-grow: 1; 
        }

        .url-input { background: var(--bg-main); border: 1px solid var(--border); color: white; padding: 6px 12px; border-radius: 6px; width: 100%; font-family: monospace; }
        .btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; display: flex; align-items: center; gap: 8px; color:white; font-size: 0.85rem;}
        .btn-primary { background: var(--accent); }
        .btn-secondary { background: var(--bg-input); }
        .btn-run { background: var(--success); width: 100%; justify-content: center; padding: 12px; margin-top: auto; font-size: 1rem; }
        input[type="file"] { display: none; }

        /* LAYOUT */
        .container { display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - 60px); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { background-color: var(--bg-panel); border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .sidebar h3 { margin: 0; font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .control-group label { display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-secondary); }
        select, input[type="number"], input[type="date"] { width: 100%; padding: 6px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; color: white; font-size: 0.85rem; }
        
        /* MATCHUP SELECTORS / POISSON INPUTS */
        .matchup-selectors { display: flex; flex-direction: column; gap: 10px; background: var(--poisson-bg); padding: 10px; border-radius: 6px; border: 1px solid var(--poisson-accent); }
        .vs-badge { align-self: center; background: var(--poisson-accent); color: var(--poisson-bg); font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: bold; }

        /* MAIN */
        .main { padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        /* KPIS */
        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; flex-shrink: 0; }
        .kpi-card { background: var(--bg-panel); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .kpi-title { font-size: 0.75rem; color: var(--text-secondary); }
        .kpi-value { font-size: 1.2rem; font-weight: 700; margin-top: 2px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-orange { color: var(--warning); }
        .text-purple { color: var(--poisson-accent); } /* Nuevo color para Poisson */

        /* POISSON CARD */
        .poisson-card {
            background: #2f496e; 
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--poisson-accent);
            flex-shrink: 0;
            display:none;
        }

        .poisson-odds-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 15px;
            margin-top: 10px;
            border-top: 1px dashed var(--border);
            padding-top: 10px;
        }

        .poisson-odds-item {
            text-align: center;
            background: var(--bg-input);
            padding: 8px;
            border-radius: 4px;
        }

        /* Loading */
        #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 999; text-align: center; padding-top: 20%; }
        .spinner { font-size: 2.5rem; color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Table Styles */
        .table-scroll { overflow-y: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 8px; background: #252f45; position: sticky; top: 0; color: var(--text-secondary); z-index: 1; }
        td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(255,255,255,0.03); }

        /* Mobile Layout (omitted for brevity, assume responsive principles apply) */
    </style>
</head>
<body>

    <div id="loadingOverlay"><i class="fas fa-circle-notch spinner"></i><h3 style="margin-top:15px; color:#ccc;">Procesando Datos y Entrenando Modelo...</h3></div>

    <header>
        <div class="brand"><i class="fas fa-calculator"></i> Backtester <span class="tag">v7.0 POISSON</span></div>
        <div class="url-bar">
            <input type="text" id="urlInputCurrent" class="url-input" placeholder="URL Temporada ACTUAL (Obligatoria)">
            <input type="text" id="urlInputPrevious" class="url-input" placeholder="URL Temporada ANTERIOR (Opcional)">
            <button onclick="loadFromUrls()" class="btn btn-primary"><i class="fas fa-cloud-download-alt"></i> Cargar URLs</button>
        </div>
        <label for="fileInput" class="btn btn-secondary"><i class="fas fa-folder-open"></i> Archivo Local</label>
        <input type="file" id="fileInput" accept=".csv">
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="matchup-selectors">
                <h3 style="border:none; margin-bottom:5px; color:white;">üß† Calculadora Poisson</h3>
                <div class="control-group">
                    <label>Equipo Local</label>
                    <select id="teamHomeSelect"><option value="">Sel. Local</option></select>
                </div>
                <div class="vs-badge">VS</div>
                <div class="control-group">
                    <label>Equipo Visitante</label>
                    <select id="teamAwaySelect"><option value="">Sel. Visita</option></select>
                </div>
                <button class="btn" style="background:var(--poisson-accent); color:black; width:100%; justify-content:center; margin-top:5px;" onclick="analyzeMatchup()">
                    <i class="fas fa-brain"></i> Calcular Poisson / Value
                </button>
            </div>

            <h3>Configuraci√≥n</h3>
            <div class="control-group">
                <label>Mercado</label>
                <select id="marketSelect">
                    <option value="H">Local (1)</option>
                    <option value="D">Empate (X)</option>
                    <option value="A">Visita (2)</option>
                    <option value="O25">Over 2.5 Goles</option>
                    <option value="U25">Under 2.5 Goles</option>
                </select>
            </div>

            <div class="control-group">
                <label>Gesti√≥n de Stake</label>
                <select id="stakeType">
                    <option value="flat">Plano (Fijo)</option>
                    <option value="percent">% Banca</option>
                </select>
            </div>
            <div class="control-group">
                <label>Valor / Banca</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="stakeValue" value="1" step="0.1">
                    <input type="number" id="initialBank" value="1000">
                </div>
            </div>

            <h3>Filtros Globales</h3>
            <div class="control-group">
                <label>Cuota M√≠nima</label>
                <input type="number" id="minOdds" value="1.20" step="0.01" min="1.01">
            </div>
            <div class="control-group">
                <label>Cuota M√°xima</label>
                <input type="number" id="maxOdds" value="3.00" step="0.01" min="1.01">
            </div>
            
            <div class="control-group">
                <label>Liga</label>
                <select id="leagueSelect"><option value="all">Todas</option></select>
            </div>
            
            <button class="btn btn-run" onclick="runBacktest()"><i class="fas fa-play"></i> EJECUTAR BACKTEST (Solo Filtro)</button>
        </aside>

        <main class="main">
            
            <div id="poissonCard" class="poisson-card"></div>

            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-title">Apuestas (Global)</div><div class="kpi-value" id="valBets">0</div></div>
                <div class="kpi-card"><div class="kpi-title">Win Rate</div><div class="kpi-value" id="valWinRate">0%</div></div>
                <div class="kpi-card"><div class="kpi-title">Profit</div><div class="kpi-value" id="valProfit">0.00</div></div>
                <div class="kpi-card"><div class="kpi-title">Yield</div><div class="kpi-value" id="valYield">0%</div></div>
                <div class="kpi-card"><div class="kpi-title" style="color:#ef4444;">Drawdown</div><div class="kpi-value text-red" id="valDrawdown">0%</div></div>
            </div>
            
            <div class="opt-card">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px;">
                    <div class="kpi-title" style="color:white; font-size:1rem;">‚úÖ RANGO √ìPTIMO DE CUOTA</div>
                    <span id="compStatus" style="font-size:0.8rem; font-weight:bold; padding:4px 8px; border-radius:4px; background:var(--warning);">N/A</span>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; text-align:center;">
                    <div>
                        <div class="kpi-title">RANGO GLOBAL</div>
                        <div class="kpi-value" id="valOptimalOddsRange" style="font-size:1.4rem;">N/A</div>
                        <div class="kpi-title" style="margin-top:5px;">Yield Total: <b id="valOptimalOddsYield">0.00%</b></div>
                        <div class="kpi-title">Apuestas: <b id="valOptimalOddsBets">0</b></div>
                    </div>

                    <div style="border-left:1px dashed #334155; padding-left:15px;">
                        <div class="kpi-title"><i class="fas fa-calendar-check"></i> <span id="currentYear">Actual</span></div>
                        <div class="kpi-value text-orange" id="currentYield" style="font-size:1.4rem;">N/A</div>
                        <div class="kpi-title" id="currentSample" style="font-size:0.75rem; margin-top:5px;">(Muestra: 0/0)</div>
                    </div>

                    <div style="border-left:1px dashed #334155; padding-left:15px;">
                        <div class="kpi-title"><i class="fas fa-calendar-alt"></i> <span id="previousYear">Anterior</span></div>
                        <div class="kpi-value text-orange" id="previousYield" style="font-size:1.4rem;">N/A</div>
                        <div class="kpi-title" id="previousSample" style="font-size:0.75rem; margin-top:5px;">(Muestra: 0/0)</div>
                    </div>
                </div>
            </div>


            <div class="charts-section">
                <div class="chart-box-full">
                    <canvas id="equityChart"></canvas>
                </div>
                
                <div class="split-row">
                    <div class="panel-box">
                        <div class="panel-header"><span class="panel-title">Por Ligas</span></div>
                        <div style="padding:10px; flex-grow:1;"><canvas id="leagueChart"></canvas></div>
                    </div>
                    <div class="panel-box">
                        <div class="panel-header"><span class="panel-title">Ranking Equipos (Profit)</span></div>
                        <div class="table-scroll">
                            <table id="teamTable">
                                <thead><tr><th>Equipo</th><th>Sit.</th><th>P/L</th></tr></thead>
                                <tbody id="teamTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-box" style="height: 250px; flex-shrink:0;">
                <div class="panel-header"><span class="panel-title">Historial Detallado</span></div>
                <div class="table-scroll">
                    <table id="resultsTable">
                        <thead><tr><th>Fecha</th><th>Partido</th><th>Sel</th><th>Cuota</th><th>Res</th><th>P/L</th><th>Banca</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let rawData = [];
        let seasonYears = { current: null, previous: null };
        let poissonTrainingData = null; // Almacenar√° { globalAverages, teamCoeffs }
        let chartEq=null, chartLg=null;

        // --- FUNCIONES MATEM√ÅTICAS ---
        function getFactorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function poissonPMF(k, lambda) {
            // P(k; lambda) = (e^(-lambda) * lambda^k) / k!
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / getFactorial(k);
        }
        // --- FIN FUNCIONES MATEM√ÅTICAS ---

        // --- CARGA Y PROCESAMIENTO DE DATOS ---
        document.getElementById('fileInput').addEventListener('change', e=>parseCSV(e.target.files[0]));
        
        // ... loadFromUrls and parseCSV functions remain largely the same, only the error handling alert text is simplified ...
        async function loadFromUrls() {
            const urlCurrent = document.getElementById('urlInputCurrent').value.trim();
            const urlPrevious = document.getElementById('urlInputPrevious').value.trim();
            
            if (!urlCurrent) return alert("La URL de la Temporada Actual es obligatoria.");

            document.getElementById('loadingOverlay').style.display = 'block';

            const urls = [urlCurrent];
            if (urlPrevious) urls.push(urlPrevious);

            try {
                const fetchPromises = urls.map(url => 
                    fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url))
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`Fallo al obtener datos de ${url}. Estado HTTP: ${res.status}.`);
                            }
                            return res.text();
                        })
                );
                
                const texts = await Promise.all(fetchPromises);
                
                let combinedData = [];
                let parsingErrors = []; 

                texts.forEach((text, index) => {
                    const url = urls[index];
                    Papa.parse(text, { 
                        header: true, 
                        dynamicTyping: true, 
                        skipEmptyLines: true, 
                        complete: (results) => {
                            const validData = results.data.filter(r => Object.keys(r).length > 0);
                            
                            if (validData.length === 0 && text.length > 0) {
                                parsingErrors.push(`La URL ${url} no devolvi√≥ datos utilizables. Verifique los encabezados del CSV.`);
                            }
                            combinedData.push(...validData); 
                        },
                        error: (error, file) => {
                            console.error(`Error de PapaParse en la URL ${url}. Mensaje: ${error.message}`);
                            parsingErrors.push(`Error de parsing en la URL ${url}. Mensaje: ${error.message}`);
                        }
                    });
                });
                
                if (parsingErrors.length > 0) {
                    throw new Error(parsingErrors.join('\n'));
                }

                if (combinedData.length === 0) {
                     throw new Error("No se encontraron datos utilizables. Aseg√∫rese de que las URLs sean enlaces directos a CSVs y no est√©n vac√≠os.");
                }

                processData(combinedData);

            } catch(e){ 
                console.error("Error general en carga:", e);
                alert(`‚ùå Error cargando datos:\n\n${e.message || "Verifique si las URLs son enlaces directos a CSVs accesibles o si el archivo no est√° vac√≠o."}`); 
                document.getElementById('loadingOverlay').style.display='none'; 
            }
        }

        function parseCSV(f){ 
            document.getElementById('loadingOverlay').style.display='block'; 
            Papa.parse(f,{
                header:true, 
                dynamicTyping:true, 
                skipEmptyLines:true, 
                complete:r=>{
                    if (r.data.length === 0) {
                         alert("‚ùå Error cargando datos: El archivo CSV local no contiene datos utilizables.");
                         document.getElementById('loadingOverlay').style.display='none';
                    } else {
                         processData(r.data);
                    }
                },
                error: (error, file) => {
                    console.error("Error de PapaParse en archivo local:", error);
                    alert(`‚ùå Error de parsing en archivo local. Verifique el formato CSV:\n${error.message}`);
                    document.getElementById('loadingOverlay').style.display='none';
                }
            }); 
        }

        function trainPoissonModel(data) {
            const teamStats = {};
            let totalMatches = data.length;
            let totalHomeGoals = 0;
            let totalAwayGoals = 0;

            if (totalMatches === 0) return null;

            data.forEach(r => {
                totalHomeGoals += r.goalsH;
                totalAwayGoals += r.goalsA;

                const updateStats = (team, goalsScored, goalsConceded, isHome) => {
                    if (!teamStats[team]) {
                        teamStats[team] = { playedH: 0, scoredH: 0, concededH: 0, playedA: 0, scoredA: 0, concededA: 0 };
                    }
                    if (isHome) {
                        teamStats[team].playedH++;
                        teamStats[team].scoredH += goalsScored;
                        teamStats[team].concededH += goalsConceded;
                    } else {
                        teamStats[team].playedA++;
                        teamStats[team].scoredA += goalsScored;
                        teamStats[team].concededA += goalsConceded;
                    }
                };

                updateStats(r.home, r.goalsH, r.goalsA, true);
                updateStats(r.away, r.goalsA, r.goalsH, false);
            });

            const avgGoalsHome = totalHomeGoals / totalMatches;
            const avgGoalsAway = totalAwayGoals / totalMatches;
            
            const teamCoeffs = {};

            // Calcular Coeficientes
            for (const team in teamStats) {
                const stats = teamStats[team];
                
                // Attack Home / Defense Home (based on Home Avg Goals)
                const attH = (stats.playedH > 0) ? (stats.scoredH / stats.playedH) / avgGoalsHome : 1.0;
                const defH = (stats.playedH > 0) ? (stats.concededH / stats.playedH) / avgGoalsAway : 1.0;
                
                // Attack Away / Defense Away (based on Away Avg Goals)
                const attA = (stats.playedA > 0) ? (stats.scoredA / stats.playedA) / avgGoalsAway : 1.0;
                const defA = (stats.playedA > 0) ? (stats.concededA / stats.playedA) / avgGoalsHome : 1.0;

                teamCoeffs[team] = { attH, defH, attA, defA };
            }

            return {
                globalAverages: { avgGoalsHome, avgGoalsAway, totalMatches },
                teamCoeffs: teamCoeffs
            };
        }

        function processData(data) {
            // 1. Normalizar y Limpiar datos 
            rawData = data.map(r => {
                if(!r.Date || !r.HomeTeam || isNaN(r.FTHG) || isNaN(r.FTAG)) return null;
                
                let d = r.Date; 
                if(typeof d === 'string' && d.includes('/')) { 
                    const p=d.split('/'); 
                    const year = p[2].length===2 ? '20'+p[2] : p[2];
                    d=`${year}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; 
                } 
                
                return {
                    date:d, league:r.Div, home:r.HomeTeam, away:r.AwayTeam, res:r.FTR, goalsH:r.FTHG, goalsA:r.FTAG,
                    // 1X2 Odds
                    oddsH:r.B365H||r.AvgH||1.01, oddsD:r.B365D||r.AvgD||1.01, oddsA:r.B365A||r.AvgA||1.01,
                    // Over/Under 2.5 Odds 
                    oddsO25:r['B365>2.5']||r.Avg25||1.01, oddsU25:r['B365<2.5']||r.Avg25_1||1.01
                };
            }).filter(x=>x && x.oddsH > 1.01); 

            // 2. Ordenar por fecha
            rawData.sort((a, b) => a.date.localeCompare(b.date));
            
            // 3. Entrenar Modelo de Poisson (NUEVO)
            poissonTrainingData = trainPoissonModel(rawData);
            
            // 4. Identificar Temporadas
            const allDates = rawData.map(r => r.date.substring(0, 4));
            const uniqueYears = [...new Set(allDates)].sort().reverse(); 
            
            seasonYears.current = uniqueYears.length > 0 ? uniqueYears[0] : null;
            seasonYears.previous = uniqueYears.length > 1 ? uniqueYears[1] : null;


            // 5. Llenar Selectores (Teams and Leagues)
            const teams = Object.keys(poissonTrainingData.teamCoeffs).sort();
            const populate = (id) => {
                const s = document.getElementById(id); s.innerHTML='<option value="">Seleccionar</option>';
                teams.forEach(t => s.add(new Option(t,t)));
            };
            populate('teamHomeSelect'); populate('teamAwaySelect');
            
            const lgSel = document.getElementById('leagueSelect'); lgSel.innerHTML='<option value="all">Todas</option>';
            [...new Set(rawData.map(x=>x.league))].sort().forEach(l=>lgSel.add(new Option(l,l)));

            document.getElementById('loadingOverlay').style.display='none';
            runBacktest(); // Ejecutar backtest inicial con filtro simple
        }


        // --- L√ìGICA CORE ---
        function calculateProfit(row, mkt, stake, min, max) {
            let o=0, w=false;
            
            // 1. Mercados 1X2
            if(mkt==='H'){ o=row.oddsH; w=row.res==='H'; }
            else if(mkt==='D'){ o=row.oddsD; w=row.res==='D'; }
            else if(mkt==='A'){ o=row.oddsA; w=row.res==='A'; }
            
            // 2. Mercados de Goles (Over/Under 2.5)
            else if(mkt==='O25'){ o=row.oddsO25; w=(row.goalsH+row.goalsA)>2; } // Corregido: >2 para Over 2.5
            else if(mkt==='U25'){ o=row.oddsU25||1.9; w=(row.goalsH+row.goalsA)<3; } // Corregido: <3 para Under 2.5
            
            if(!o || o<min || o>max) return null; 
            return { pnl: w ? (stake*o - stake) : -stake, won: w, odds: o };
        }

        // --- AN√ÅLISIS POISSON (NUEVO) ---
        function calculatePoissonProbabilities(homeTeam, awayTeam) {
            const { globalAverages, teamCoeffs } = poissonTrainingData;
            const homeCoeffs = teamCoeffs[homeTeam];
            const awayCoeffs = teamCoeffs[awayTeam];
            
            if (!homeCoeffs || !awayCoeffs) return null;

            // 1. Calcular Lambdas (Expected Goals)
            // lambda_H = Att_H * Def_A * Avg_H
            const lambda_H = homeCoeffs.attH * awayCoeffs.defA * globalAverages.avgGoalsHome;
            // lambda_A = Att_A * Def_H * Avg_A
            const lambda_A = awayCoeffs.attA * homeCoeffs.defH * globalAverages.avgGoalsAway;
            
            let pHome = 0, pDraw = 0, pAway = 0, pOver25 = 0;
            const maxGoals = 5; // Calcular hasta 5 goles para una buena aproximaci√≥n

            // 2. Calcular matriz de probabilidades de marcador (P(x,y))
            for (let x = 0; x <= maxGoals; x++) { // Goles Local
                const pGx = poissonPMF(x, lambda_H);
                for (let y = 0; y <= maxGoals; y++) { // Goles Visitante
                    const pGy = poissonPMF(y, lambda_A);
                    const pScore = pGx * pGy;
                    
                    if (x > y) pHome += pScore;
                    else if (x === y) pDraw += pScore;
                    else pAway += pScore;
                    
                    if (x + y > 2) pOver25 += pScore;
                }
            }
            
            // 3. La probabilidad de Under 2.5 es el complemento del Over 2.5 (aproximadamente)
            const pUnder25 = 1 - pOver25; 

            // 4. Normalizar 1X2 (para cubrir la probabilidad restante no contabilizada por el rango 0-5)
            const pTotal1X2 = pHome + pDraw + pAway;
            const adjustment = 1 / pTotal1X2;

            pHome *= adjustment;
            pDraw *= adjustment;
            pAway *= adjustment;

            return {
                lambda_H: lambda_H.toFixed(2),
                lambda_A: lambda_A.toFixed(2),
                pHome: pHome,
                pDraw: pDraw,
                pAway: pAway,
                pOver25: pOver25,
                pUnder25: pUnder25
            };
        }


        function analyzeMatchup() {
            const homeTeam = document.getElementById('teamHomeSelect').value;
            const awayTeam = document.getElementById('teamAwaySelect').value;
            const mkt = document.getElementById('marketSelect').value;
            
            if (!homeTeam || !awayTeam || homeTeam === awayTeam) {
                document.getElementById('poissonCard').style.display = 'none';
                return;
            }

            const poissonRes = calculatePoissonProbabilities(homeTeam, awayTeam);
            
            if (!poissonRes) {
                document.getElementById('poissonCard').style.display = 'none';
                alert("Datos de entrenamiento insuficientes para los equipos seleccionados.");
                return;
            }

            // Obtener odds reales del partido m√°s reciente (si existe)
            const lastMatch = rawData.find(r => 
                (r.home === homeTeam && r.away === awayTeam) || 
                (r.home === awayTeam && r.away === homeTeam)
            );
            
            updatePoissonCard(homeTeam, awayTeam, poissonRes, lastMatch, mkt);
        }

        function updatePoissonCard(home, away, res, lastMatch, selectedMkt) {
            const card = document.getElementById('poissonCard');
            card.style.display = 'block';

            const markets = {
                'H': { p: res.pHome, odds: lastMatch ? lastMatch.oddsH : null, label: 'Local (1)' },
                'D': { p: res.pDraw, odds: lastMatch ? lastMatch.oddsD : null, label: 'Empate (X)' },
                'A': { p: res.pAway, odds: lastMatch ? lastMatch.oddsA : null, label: 'Visita (2)' },
                'O25': { p: res.pOver25, odds: lastMatch ? lastMatch.oddsO25 : null, label: 'Over 2.5' },
                'U25': { p: res.pUnder25, odds: lastMatch ? lastMatch.oddsU25 : null, label: 'Under 2.5' }
            };

            let marketHTML = '';
            for (const key in markets) {
                const mkt = markets[key];
                const oddsPoisson = (1 / mkt.p).toFixed(2);
                const oddsReal = mkt.odds ? mkt.odds.toFixed(2) : 'N/A';
                
                let isValue = false;
                if (mkt.odds && mkt.odds > (1 / mkt.p) && key === selectedMkt) {
                    isValue = true;
                }
                
                const style = key === selectedMkt ? 'border: 2px solid var(--success);' : '';
                const valueIndicator = isValue ? '<i class="fas fa-arrow-up text-green"></i> VALUE!' : '';
                
                marketHTML += `
                    <div class="poisson-odds-item" style="${style}">
                        <div class="kpi-title" style="color:var(--poisson-accent);">${mkt.label}</div>
                        <div class="kpi-value" style="font-size:1.1rem; color:white;">P: ${(mkt.p * 100).toFixed(1)}%</div>
                        <div class="kpi-title" style="margin-top:5px; font-weight:bold;">Odds Poisson: ${oddsPoisson}</div>
                        <div class="kpi-title">Odds Real: ${oddsReal} ${valueIndicator}</div>
                    </div>
                `;
            }


            card.innerHTML = `
                <h3 style="margin-top:0; color:white; border-bottom:1px solid var(--poisson-accent); padding-bottom:5px;">üß† Predicci√≥n Poisson: ${home} vs ${away}</h3>
                
                <div style="display:flex; justify-content:space-around; text-align:center;">
                    <div style="font-size:0.9rem;">
                        <span class="text-purple">Goles Esperados (Local):</span> <b>${res.lambda_H}</b>
                    </div>
                    <div style="font-size:0.9rem;">
                        <span class="text-purple">Goles Esperados (Visita):</span> <b>${res.lambda_A}</b>
                    </div>
                </div>

                <div class="poisson-odds-grid">
                    ${marketHTML}
                </div>
            `;
        }
        
        // --- FUNCIONES DE OPTIMIZACI√ìN Y UI RESTANTES (Sin cambios) ---
        function findOptimalOddsRange(optimizableBets) {
            if (optimizableBets.length < 50) return { min: 'N/A', max: 'N/A', yield: 0, bets: 0 }; 

            let bestYield = -100;
            let bestMin = 0, bestMax = 0;
            let bestBets = 0;
            const step = 0.05; 
            const maxOddsLimit = 8.00; 

            for (let min_o = 1.01; min_o <= maxOddsLimit; min_o += step) {
                min_o = parseFloat(min_o.toFixed(2));

                for (let max_o = min_o; max_o <= maxOddsLimit; max_o += step) {
                    max_o = parseFloat(max_o.toFixed(2));
                    
                    let totalProfit = 0;
                    let totalBets = 0;

                    for (const bet of optimizableBets) {
                        if (bet.odds >= min_o && bet.odds <= max_o) {
                            totalProfit += bet.pnl;
                            totalBets++;
                        }
                    }

                    if (totalBets >= 30) { 
                        const currentYield = (totalProfit / totalBets) * 100;
                        if (currentYield > bestYield) {
                            bestYield = currentYield;
                            bestMin = min_o;
                            bestMax = max_o;
                            bestBets = totalBets;
                        }
                    }
                }
            }
            
            return { 
                min: bestMin.toFixed(2), 
                max: bestMax.toFixed(2), 
                yield: bestYield.toFixed(2), 
                bets: bestBets 
            };
        }
        
        function checkCompatibility(optimalRange, currentData, previousData) {
            const min = parseFloat(optimalRange.min);
            const max = parseFloat(optimalRange.max);
            
            if (min === 0 || max === 0 || optimalRange.min === 'N/A') return { current: 'N/A', previous: 'N/A', currentBets: 0, previousBets: 0, status: 'NO HAY MUESTRA' };

            // 1. Check Current Season
            let currentPnl = 0, currentBets = 0, totalCurrentBets = currentData.length;
            currentData.forEach(bet => {
                if (bet.odds >= min && bet.odds <= max) {
                    currentPnl += bet.pnl;
                    currentBets++;
                }
            });
            const currentYield = currentBets > 5 ? (currentPnl / currentBets) * 100 : 0; 

            // 2. Check Previous Season
            let previousPnl = 0, previousBets = 0, totalPreviousBets = previousData.length;
            previousData.forEach(bet => {
                if (bet.odds >= min && bet.odds <= max) {
                    previousPnl += bet.pnl;
                    previousBets++;
                }
            });
            const previousYield = previousBets > 5 ? (previousPnl / previousBets) * 100 : 0; 

            const isCompatible = (currentYield > 1.0 && previousYield > 1.0); 

            let status = 'BAJA COMPATIBILIDAD';
            if (currentBets < 5 && previousBets < 5) { 
                status = 'MUESTRA INSUFICIENTE';
            } else if (isCompatible) {
                 status = 'ALTA COMPATIBILIDAD';
            } else if (currentBets < 5 || previousBets < 5) { 
                 status = 'COMPATIBILIDAD INCOMPLETA';
            }


            return { 
                current: currentYield.toFixed(1) + '%', 
                previous: previousYield.toFixed(1) + '%', 
                currentBets: currentBets,
                previousBets: previousBets,
                totalCurrentBets: totalCurrentBets,
                totalPreviousBets: totalPreviousBets,
                status: status
            };
        }

        function runBacktest() {
            if(!rawData.length) return;
            const mkt = document.getElementById('marketSelect').value;
            const stT = document.getElementById('stakeType').value;
            const stV = parseFloat(document.getElementById('stakeValue').value);
            const bank0 = parseFloat(document.getElementById('initialBank').value);
            const minO = parseFloat(document.getElementById('minOdds').value);
            const maxO = parseFloat(document.getElementById('maxOdds').value);
            const lg = document.getElementById('leagueSelect').value;

            let bank=bank0, peak=bank0, maxDD=0, wins=0, hist=[{x:'Inicio', y:bank0}], rows=[], lgP={}, tmP={};
            let optimizableBetsCombined = [];
            let optimizableBetsCurrent = [];
            let optimizableBetsPrevious = [];


            const filtered = rawData.filter(r => lg==='all' || r.league===lg);

            filtered.forEach(r => {
                const stake = (stT==='flat') ? stV : (bank*(stV/100));
                const res = calculateProfit(r, mkt, stake, minO, maxO);
                
                // C√°lculo de optimizaci√≥n (stake 1u, sin filtros de cuota)
                const resOptimizable = calculateProfit(r, mkt, 1.0, 1.0, 50.0); 
                if(resOptimizable) {
                    const optBet = { odds: resOptimizable.odds, pnl: resOptimizable.pnl, year: r.date.substring(0, 4) };
                    
                    optimizableBetsCombined.push(optBet);

                    if (seasonYears.current && optBet.year == seasonYears.current) {
                        optimizableBetsCurrent.push(optBet);
                    } else if (seasonYears.previous && optBet.year == seasonYears.previous) {
                        optimizableBetsPrevious.push(optBet);
                    }
                }

                if(res) {
                    bank += res.pnl;
                    if(res.won) wins++;
                    if(bank>peak) peak=bank;
                    let dd = (peak-bank)/peak*100; if(dd>maxDD) maxDD=dd;

                    hist.push({x:r.date, y:bank});
                    rows.push({date:r.date, match:`${r.home} v ${r.away}`, sel:mkt, odds:res.odds, res:`${r.goalsH}-${r.goalsA}`, pnl:res.pnl, bank:bank});

                    if(!lgP[r.league]) lgP[r.league]=0; lgP[r.league]+=res.pnl;
                    
                    if(!tmP[r.home]) tmP[r.home]=0; tmP[r.home]+=res.pnl;
                    if(!tmP[r.away]) tmP[r.away]=0; tmP[r.away]+=res.pnl;
                }
            });

            // 1. Encontrar rango √≥ptimo combinado
            const optimalRangeCombined = findOptimalOddsRange(optimizableBetsCombined);

            // 2. Comprobar compatibilidad
            const compatibility = checkCompatibility(optimalRangeCombined, optimizableBetsCurrent, optimizableBetsPrevious);
            
            // 3. Actualizar UI de optimizaci√≥n
            updateOptimalOddsUI(optimalRangeCombined, compatibility); 

            // 4. Actualizar UI Global
            updateGlobalUI(hist, rows, wins, bank0, bank, maxDD, lgP, tmP);
            
            // Ocultar tarjeta Poisson al hacer Backtest Global
            document.getElementById('poissonCard').style.display = 'none';
        }

        function updateOptimalOddsUI(optimalRange, compatibility) {
            document.getElementById('valOptimalOddsRange').innerText = optimalRange.min + ' - ' + optimalRange.max;
            document.getElementById('valOptimalOddsYield').innerText = optimalRange.yield + '%';
            document.getElementById('valOptimalOddsBets').innerText = optimalRange.bets;

            // Compatibilidad
            document.getElementById('compStatus').innerText = compatibility.status;
            
            let compColor = 'var(--warning)';
            if (compatibility.status === 'ALTA COMPATIBILIDAD') compColor = 'var(--success)';
            else if (compatibility.status === 'BAJA COMPATIBILIDAD' || compatibility.status === 'COMPATIBILIDAD INCOMPLETA') compColor = 'var(--danger)';
            document.getElementById('compStatus').style.backgroundColor = compColor;
            
            document.getElementById('currentYear').innerText = seasonYears.current || 'N/A';
            document.getElementById('previousYear').innerText = seasonYears.previous || 'N/A';

            document.getElementById('currentYield').innerText = compatibility.current;
            document.getElementById('previousYield').innerText = compatibility.previous;
            
            document.getElementById('currentYield').className = "kpi-value " + (compatibility.current.includes('-') || compatibility.current === 'N/A' ? 'text-red' : 'text-green');
            document.getElementById('previousYield').className = "kpi-value " + (compatibility.previous.includes('-') || compatibility.previous === 'N/A' ? 'text-red' : 'text-green');


            document.getElementById('currentSample').innerText = `(Muestra en Rango: ${compatibility.currentBets}/${compatibility.totalCurrentBets})`;
            document.getElementById('previousSample').innerText = `(Muestra en Rango: ${compatibility.previousBets}/${compatibility.totalPreviousBets})`;
        }


        // --- UI UPDATES (Global and Charts) ---
        function updateGlobalUI(hist, rows, wins, start, end, dd, lgData, tmData) {
            const tot = rows.length;
            const prof = end-start;
            const yieldVal = tot?((prof/tot)*100).toFixed(1):'0';
            
            document.getElementById('valBets').innerText = tot;
            document.getElementById('valWinRate').innerText = tot?((wins/tot)*100).toFixed(1)+'%':'0%';
            document.getElementById('valProfit').innerText = prof.toFixed(2);
            document.getElementById('valYield').innerText = yieldVal + '%';
            document.getElementById('valDrawdown').innerText = '-'+dd.toFixed(2)+'%';

            document.getElementById('valProfit').className = `kpi-value ${prof>=0?'text-green':'text-red'}`;

            // Tabla Principal
            const tb = document.getElementById('tableBody'); tb.innerHTML='';
            rows.slice(-50).reverse().forEach(r => {
                tb.innerHTML += `<tr><td>${r.date.substring(5)}</td><td>${r.match}</td><td>${r.sel}</td><td>${r.odds.toFixed(2)}</td><td>${r.res}</td><td class="${r.pnl>=0?'text-green':'text-red'}">${r.pnl.toFixed(2)}</td><td>${r.bank.toFixed(0)}</td></tr>`;
            });

            // Tabla Equipos
            const tbTeam = document.getElementById('teamTableBody'); tbTeam.innerHTML='';
            Object.entries(tmData).sort((a,b)=>b[1]-a[1]).slice(0,20).forEach(t => {
                tbTeam.innerHTML += `<tr><td style="color:white; font-weight:bold;">${t[0]}</td><td>Gen</td><td class="${t[1]>=0?'text-green':'text-red'}">${t[1].toFixed(2)}</td></tr>`;
            });

            renderCharts(hist, lgData);
        }

        function renderCharts(hist, lgData) {
            const ctxEq = document.getElementById('equityChart').getContext('2d');
            if(chartEq) chartEq.destroy();
            const pts = hist.length>800 ? hist.filter((_,i)=>i%5===0) : hist;
            chartEq = new Chart(ctxEq, { type:'line', data:{labels:pts.map(p=>p.x), datasets:[{label:'Banca', data:pts.map(p=>p.y), borderColor:'#3b82f6', borderWidth:2, pointRadius:0, fill:true, backgroundColor:'rgba(59,130,246,0.1)'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, title:{display:true, text:'Evoluci√≥n de Banca', color:'white'}}, scales:{x:{display:false},y:{grid:{color:'#334155'}, ticks:{color:'white'}}}}});

            const ctxLg = document.getElementById('leagueChart').getContext('2d');
            if(chartLg) chartLg.destroy();
            const lgArr = Object.entries(lgData).sort((a,b)=>b[1]-a[1]);
            chartLg = new Chart(ctxLg, { type:'bar', data:{labels:lgArr.map(x=>x[0]), datasets:[{data:lgArr.map(x=>x[1]), backgroundColor:lgArr.map(x=>x[1]>=0?'#10b981':'#ef4444')}]}, options:{responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#334155'}, ticks:{color:'white'}}, y:{ticks:{color:'white'}}}}});
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Analizador de Patrones HT - Versi√≥n Robusta</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        textarea { width: 100%; height: 150px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; padding: 12px; font-family: monospace; }
        .controls { margin: 20px 0; display: flex; gap: 10px; }
        button { flex: 1; background: var(--accent); color: white; border: none; padding: 15px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 16px; }
        button:hover { background: #2563eb; }
        #debugLog { background: #450a0a; color: #fecaca; padding: 10px; border-radius: 5px; margin-bottom: 20px; display: none; font-size: 12px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; }
        .pattern-box { background: #064e3b; border-left: 6px solid var(--success); padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .win { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üî¨ Analizador de Patrones Pro</h1>
    <div id="debugLog"></div>
    
    <textarea id="dataInput" placeholder="Pega aqu√≠ los datos desde la fila de encabezados..."></textarea>
    
    <div class="controls">
        <button onclick="processData()">EJECUTAR AN√ÅLISIS</button>
    </div>

    <div id="output" style="display:none;">
        <div id="goldInsights" class="pattern-box"></div>
        <div class="grid">
            <div class="card"><h3>üèÜ Ligas Top</h3><div id="leagueResults"></div></div>
            <div class="card"><h3>üìä Por Cuota</h3><div id="oddResults"></div></div>
            <div class="card"><h3>‚öΩ Equipos Clave</h3><div id="teamResults"></div></div>
        </div>
        <div id="mainChart" style="margin-top:20px;"></div>
    </div>
</div>

<script>
function logError(msg) {
    const log = document.getElementById('debugLog');
    log.style.display = 'block';
    log.innerHTML += `<div>‚ö†Ô∏è ${msg}</div>`;
}

function processData() {
    // Limpiar errores previos
    document.getElementById('debugLog').innerHTML = '';
    document.getElementById('debugLog').style.display = 'none';
    
    const input = document.getElementById('dataInput').value.trim();
    if (!input) {
        logError("El √°rea de texto est√° vac√≠a.");
        return;
    }

    const lines = input.split('\n');
    if (lines.length < 2) {
        logError("No hay suficientes datos. Aseg√∫rate de incluir la fila de encabezados.");
        return;
    }

    // Detectar si el separador es TAB (Excel) o Coma
    const headerLine = lines[0];
    const separator = headerLine.includes('\t') ? '\t' : (headerLine.includes(';') ? ';' : ',');
    const headers = headerLine.split(separator).map(h => h.trim().toLowerCase());

    // Buscar √≠ndices cr√≠ticos
    const idx = {
        league: headers.findIndex(h => h.includes('league')),
        match: headers.findIndex(h => h.includes('match')),
        result: headers.findIndex(h => h.includes('result') && !h.includes('notification')),
        odd: headers.findIndex(h => h.includes('live odd'))
    };

    // Validar si encontramos las columnas
    for (let key in idx) {
        if (idx[key] === -1) {
            logError(`No se encontr√≥ la columna para: ${key}. Revisa los encabezados.`);
            return;
        }
    }

    let stats = { leagues: {}, teams: {}, odds: { baja: {w:0, t:0}, media: {w:0, t:0}, alta: {w:0, t:0} } };

    lines.slice(1).forEach((line, i) => {
        const columns = line.split(separator);
        if (columns.length < headers.length) return;

        const isWin = columns[idx.result].toLowerCase().includes('winning');
        const league = columns[idx.league] || 'Desconocida';
        const match = columns[idx.match] || '';
        const odd = parseFloat(columns[idx.odd].replace(',', '.')) || 0;

        // Ligas
        if (!stats.leagues[league]) stats.leagues[league] = {w: 0, t: 0};
        stats.leagues[league].t++;
        if (isWin) stats.leagues[league].w++;

        // Equipos
        const teams = match.split(' - ');
        teams.forEach(t => {
            const team = t.trim();
            if (!stats.teams[team]) stats.teams[team] = {w: 0, t: 0};
            stats.teams[team].t++;
            if (isWin) stats.teams[team].w++;
        });

        // Cuotas
        if (odd > 0) {
            const range = odd < 1.30 ? 'baja' : (odd < 1.50 ? 'media' : 'alta');
            stats.odds[range].t++;
            if (isWin) stats.odds[range].w++;
        }
    });

    displayResults(stats);
}

function displayResults(stats) {
    document.getElementById('output').style.display = 'block';

    // Mejores Ligas
    const bestLeagues = Object.entries(stats.leagues)
        .sort((a,b) => (b[1].w/b[1].t) - (a[1].w/a[1].t))
        .slice(0, 5)
        .map(([name, s]) => `<div>${name}: <span class="win">${(s.w/s.t*100).toFixed(1)}%</span></div>`)
        .join('');
    document.getElementById('leagueResults').innerHTML = bestLeagues;

    // Mejores Equipos (M√≠nimo 2 partidos)
    const bestTeams = Object.entries(stats.teams)
        .filter(t => t[1].t > 1)
        .sort((a,b) => b[1].w - a[1].w)
        .slice(0, 5)
        .map(([name, s]) => `<div>${name}: <span class="win">${s.w} Wins</span></div>`)
        .join('');
    document.getElementById('teamResults').innerHTML = bestTeams || "No hay equipos repetidos a√∫n";

    // Cuotas
    const oddHtml = `
        <div>1.10 - 1.29: <span class="win">${(stats.odds.baja.w/stats.odds.baja.t*100 || 0).toFixed(1)}%</span></div>
        <div>1.30 - 1.49: <span class="win">${(stats.odds.media.w/stats.odds.media.t*100 || 0).toFixed(1)}%</span></div>
        <div>1.50+: <span class="win">${(stats.odds.alta.w/stats.odds.alta.t*100 || 0).toFixed(1)}%</span></div>
    `;
    document.getElementById('oddResults').innerHTML = oddHtml;

    // Recomendaci√≥n din√°mica
    const topL = Object.entries(stats.leagues).sort((a,b) => (b[1].w/b[1].t) - (a[1].w/a[1].t))[0];
    document.getElementById('goldInsights').innerHTML = `
        <strong>Patr√≥n Detectado:</strong> La liga <b>${topL[0]}</b> tiene el mejor rendimiento. 
        Prioriza apuestas en el rango de cuota con mayor porcentaje de acierto.
    `;
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson - M√≠nimos Datos</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); width: 100%; max-width: 650px; text-align: center; }
        h1 { color: #cc3333; margin-bottom: 15px; border-bottom: 3px solid #cc3333; padding-bottom: 10px; font-size: 2em; }
        h2 { color: #007bff; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-row { border: 1px solid #cc3333; border-radius: 5px; padding: 15px; }
        .input-row h3 { color: #cc3333; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 0; }
        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { font-weight: bold; display: block; font-size: 0.9em; margin-bottom: 2px; }
        .input-group input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; text-align: center; }
        .league-input { background-color: #fcecec; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        button { width: 80%; padding: 12px; background-color: #cc3333; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px; }
        button:hover { background-color: #a02828; }
        
        /* Resultados */
        #results { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .rates-summary { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .market-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .result-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .result-box { padding: 10px; border-radius: 8px; text-align: center; }
        .result-box.btts { background-color: #d6eaff; border: 2px solid #007bff; }
        .result-box.ou { background-color: #e0ffe0; border: 2px solid #28a745; }
        .result-value { font-size: 1.4em; font-weight: bold; }
        
        /* Recomendaci√≥n */
        #recommendation_section { background-color: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left; }
        #recommendation_section h3 { color: #856404; margin-top: 0; border-bottom: 1px dashed #ffeeba; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1> üìâ Poisson con Datos M√≠nimos (GF y CV) </h1>
        <p>Los Goles en Contra (GC) se asumen iguales al Avg GF de la Liga para el c√°lculo de Poisson.</p>
           
        <div class="input-grid">
            <div class="input-row">
                <h3>Local</h3>
                <div class="input-group">
                    <label for="home_gf">Avg GF (Goles a Favor):</label>
                    <input type="number" id="home_gf" value="1.8" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="home_cv">CV (Goles a Favor) [%]:</label>
                    <input type="number" id="home_cv" value="35" step="1" min="0">
                </div>
            </div>

            <div class="input-row">
                <h3>Visitante</h3>
                <div class="input-group">
                    <label for="away_gf">Avg GF (Goles a Favor):</label>
                    <input type="number" id="away_gf" value="1.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="away_cv">CV (Goles a Favor) [%]:</label>
                    <input type="number" id="away_cv" value="60" step="1" min="0">
                </div>
            </div>
        </div>

        <div class="league-input">
            <h3>‚öΩ Promedio √önico de la Liga (Avg GF/GC)</h3>
            <div class="input-group">
                <label for="league_avg_gf">League Avg GF (Usado como GF Liga, GC Liga, GC Local, GC Visita):</label>
                <input type="number" id="league_avg_gf" value="1.3" step="0.01" min="0">
            </div>
        </div>

        <button onclick="calculateProbabilities()">Calcular Pron√≥stico y Recomendaci√≥n</button>
        
        <div id="results">
            <h2>Resultados del Modelo Poisson</h2>

            <div class="rates-summary" id="calculated_rates_summary">
                $\lambda_{\text{Local}}$: 0.00 | $\lambda_{\text{Visita}}$: 0.00 | $\lambda_{\text{Total}}$: 0.00
            </div>
            
            <div class="market-section">
                <div class="market-results">
                    <h4>Mercado: Ambos Anotan (BTTS)</h4>
                    <div class="result-box-grid">
                        <div class="result-box btts">
                            <strong>BTTS S√ç</strong>
                            <div class="result-value" id="prob_btts_yes_td">0.00%</div>
                        </div>
                        <div class="result-box btts">
                            <strong>Cuota Impl√≠cita</strong>
                            <div class="result-value" id="odd_btts_yes_td">0.00</div>
                        </div>
                    </div>
                </div>

                <div class="market-results">
                    <h4>Mercado: Total de Goles (2.5)</h4>
                    <div class="result-box-grid">
                        <div class="result-box ou">
                            <strong>M√ÅS DE 2.5</strong>
                            <div class="result-value" id="prob_over_2_5_td">0.00%</div>
                        </div>
                        <div class="result-box ou">
                            <strong>Cuota Impl√≠cita</strong>
                            <div class="result-value" id="odd_over_2_5_td">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="recommendation_section">
                <h3>‚ú® Recomendaci√≥n Estrat√©gica Basada en CV</h3>
                <div class="cv-summary" id="cv_analysis"></div>
                <p id="recommendation_text" style="font-weight: bold;"></p>
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n de Poisson
        function poissonProbability(k, lambda) {
            if (k < 0 || lambda < 0) return 0;
            if (lambda === 0 && k > 0) return 0;
            if (lambda === 0 && k === 0) return 1;
            if (k === 0) {
                return Math.exp(-lambda); 
            }
            let factorial = 1;
            for (let i = 2; i <= k; i++) {
                factorial *= i;
            }
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial;
        }

        // Funci√≥n para calcular BTTS y O/U para un par de lambdas
        function calculateMarketProbs(lambdaHome, lambdaAway) {
            const lambdaTotal = lambdaHome + lambdaAway;
            
            const probHomeZero = poissonProbability(0, lambdaHome);
            const probAwayZero = poissonProbability(0, lambdaAway);
            const probZeroZero = probHomeZero * probAwayZero; 
            const probBTTsNo = probHomeZero + probAwayZero - probZeroZero;
            const probBTTsYes = 1 - probBTTsNo;

            const probTotalZero = poissonProbability(0, lambdaTotal);
            const probTotalOne = poissonProbability(1, lambdaTotal);
            const probTotalTwo = poissonProbability(2, lambdaTotal);
            const probUnder2_5 = probTotalZero + probTotalOne + probTotalTwo;
            const probOver2_5 = 1 - probUnder2_5;

            return {
                lambdaHome: lambdaHome,
                lambdaAway: lambdaAway,
                lambdaTotal: lambdaTotal,
                bttsYes: probBTTsYes,
                over2_5: probOver2_5,
                under2_5: probUnder2_5
            };
        }
        
        // Funci√≥n de formateo de resultados
        const format = (p) => (p * 100).toFixed(2) + '%';
        const formatOdd = (p) => (p > 0.005 ? (1 / p).toFixed(2) : '‚àû');
        
        // Funci√≥n principal de c√°lculo
        function calculateProbabilities() {
            // 1. Obtener entradas del usuario
            const homeGF = parseFloat(document.getElementById('home_gf').value);
            const homeCV = parseFloat(document.getElementById('home_cv').value);
            const awayGF = parseFloat(document.getElementById('away_gf').value);
            const awayCV = parseFloat(document.getElementById('away_cv').value);
            const leagueAvgGF = parseFloat(document.getElementById('league_avg_gf').value); // GF Liga
            
            // ASUNCIONES NECESARIAS para Poisson:
            const leagueAvgGC = leagueAvgGF; // Asumir GC Liga = GF Liga
            const homeGC = leagueAvgGF;       // Asumir GC Local = GF Liga
            const awayGC = leagueAvgGF;       // Asumir GC Visitante = GF Liga
            const leagueAvgTotal = (leagueAvgGF + leagueAvgGC) / 2;
            
            // Validaci√≥n
            if (isNaN(homeGF) || isNaN(homeCV) || isNaN(awayGF) || isNaN(awayCV) || isNaN(leagueAvgGF) || leagueAvgGF <= 0) {
                alert('Por favor, introduce todos los valores num√©ricos v√°lidos y positivos.');
                return;
            }
            
            // --- C√ÅLCULO DE FUERZAS POISSON (MODELO EST√ÅNDAR) ---
            
            // 1. Calcular Fuerzas (Attack and Defense Strengths)
            const foHome = homeGF / leagueAvgGF; // FO Local vs League GF
            const fdAway = awayGC / leagueAvgGC; // FD Visitante vs League GC (aqu√≠ awayGC = leagueAvgGF)
            const foAway = awayGF / leagueAvgGF; // FO Visitante vs League GF
            const fdHome = homeGC / leagueAvgGC; // FD Local vs League GC (aqu√≠ homeGC = leagueAvgGF)
            
            // 2. Calcular los Lambda (Goles Esperados)
            const lambdaHome = foHome * fdAway * leagueAvgTotal;
            const lambdaAway = foAway * fdHome * leagueAvgTotal;
            
            // 3. Calcular los mercados
            const results = calculateMarketProbs(lambdaHome, lambdaAway);

            // 4. Actualizar la Interfaz de Resultados
            document.getElementById('calculated_rates_summary').innerHTML = 
                `$\lambda_{\\text{Local}}$: ${results.lambdaHome.toFixed(3)} | 
                $\lambda_{\\text{Visita}}$: ${results.lambdaAway.toFixed(3)} | 
                $\lambda_{\\text{Total}}$: ${results.lambdaTotal.toFixed(3)}`;
            
            document.getElementById('prob_btts_yes_td').textContent = format(results.bttsYes);
            document.getElementById('odd_btts_yes_td').textContent = formatOdd(results.bttsYes);
            
            document.getElementById('prob_over_2_5_td').textContent = format(results.over2_5);
            document.getElementById('odd_over_2_5_td').textContent = formatOdd(results.over2_5);
            
            // --- AN√ÅLISIS DE COEFICIENTE DE VARIACI√ìN (CV) ---
            
            const cvMax = Math.max(homeCV, awayCV);
            
            let cvAnalysisText = `
                CV Local (GF): <strong>${homeCV.toFixed(1)}%</strong> 
                | CV Visitante (GF): <strong>${awayCV.toFixed(1)}%</strong>
                <br>
                *Nota: CV bajo (< 30%) = Predecible; CV alto (> 50%) = Impredecible.*
            `;

            let recommendation = "";
            let market = "";
            let probThreshold = 0.55; 

            if (results.bttsYes > results.over2_5) {
                market = "BTTS S√≠";
            } else if (results.over2_5 > results.bttsYes) {
                market = "M√ÅS de 2.5";
            } else {
                market = "BTTS S√≠ / M√ÅS de 2.5 (Empate)";
            }
            
            let probMax = Math.max(results.bttsYes, results.over2_5);

            const highCV = cvMax > 50;
            const lowCV = cvMax < 30;

            if (probMax >= probThreshold) {
                if (lowCV) {
                    recommendation = `‚≠ê **Pron√≥stico Fuerte y Consistente:** La probabilidad de **${market}** es del ${format(probMax)}. Con un CV m√°ximo del ${cvMax.toFixed(1)}%, el resultado es **altamente probable y consistente**.`;
                } else if (highCV) {
                    recommendation = `‚ö†Ô∏è **Pron√≥stico con Riesgo de Variabilidad:** La probabilidad de **${market}** es del ${format(probMax)}. Con un CV m√°ximo del ${cvMax.toFixed(1)}%, existe una **alta variabilidad**. Proceda con precauci√≥n.`;
                } else {
                    recommendation = `‚úÖ **Pron√≥stico Positivo:** La probabilidad de **${market}** es del ${format(probMax)}.`;
                }
            } else {
                recommendation = `Neutral. La probabilidad m√°xima calculada (${format(probMax)}) no supera nuestro umbral de confianza (${format(probThreshold)}). Se recomienda cautela.`;
            }

            document.getElementById('cv_analysis').innerHTML = cvAnalysisText;
            document.getElementById('recommendation_text').innerHTML = recommendation; 
        }

        // Ejecutar el c√°lculo al cargar la p√°gina con los valores por defecto
        document.addEventListener('DOMContentLoaded', calculateProbabilities);
    </script>
</body>
</html>

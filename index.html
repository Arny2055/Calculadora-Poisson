<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩÔ∏è Analizador de Probabilidades de Goles (JSON) - Versi√≥n Final Select</title>
    <style>
        /* --- Estilos CSS --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #eef2f7; }
        .container { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input[type="file"], button, select { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; 
            border: 1px solid #dcdfe6; box-sizing: border-box; font-size: 16px;
        }
        input[type="file"] { background-color: #f7f9fb; }
        button { 
            background-color: #007bff;
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        .result-box { 
            margin-top: 25px; padding: 20px; border: 3px solid #333; 
            border-radius: 8px; background-color: #fff;
        }
        .analysis { 
            background: #fff8e1;
            padding: 15px; border-left: 5px solid #ffc107;
            margin-top: 20px; border-radius: 4px;
        }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        p strong { color: #333; }
        .info { font-size: 0.9em; color: #6c757d; margin-top: -5px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>‚öΩÔ∏è An√°lisis Predictivo de Goles</h2>

        <label for="jsonFile">**1. Cargar Historial de Partidos (JSON):**</label>
        <input type="file" id="jsonFile" accept=".json">
        <p class="info">El script espera las claves **"League"**, **"Match"** (Ej: Equipo A - Equipo B) y **"Result FT"** (Ej: 2-1).</p>

        <hr>

        <label for="leagueSelect">**2. Seleccionar Liga:**</label>
        <select id="leagueSelect" onchange="populateTeams()" disabled>
            <option value="">Cargue el archivo primero...</option>
        </select>

        <label for="localTeam">**3. Equipo Local:**</label>
        <select id="localTeam" disabled>
            <option value="">Seleccione la liga para ver los equipos</option>
        </select>

        <label for="visitorTeam">**4. Equipo Visitante:**</label>
        <select id="visitorTeam" disabled>
            <option value="">Seleccione la liga para ver los equipos</option>
        </select>

        <button onclick="analyzeData()">Analizar Probabilidades</button>

        <hr>

        <div id="results" class="result-box" style="display: none;">
            <h3>üìä Resultados del An√°lisis</h3>
            <p><strong>Probabilidad de M√°s de 2.5 Goles:</strong> <span id="prob25"></span></p>
            <p><strong>Probabilidad de Ambos Anotan (BTTS):</strong> <span id="probBTTS"></span></p>

            <div class="analysis">
                <h4>üß† Deducci√≥n y An√°lisis Personalizado:</h4>
                <p id="personalAnalysis"></p>
            </div>
        </div>

    </div>

    <script>
        // --- L√≥gica JavaScript con SELECT ---
        
        let matchHistory = [];
        const leagueSelect = document.getElementById('leagueSelect');
        const localTeamSelect = document.getElementById('localTeam'); // Ahora es un SELECT
        const visitorTeamSelect = document.getElementById('visitorTeam'); // Ahora es un SELECT

        /**
         * Funci√≥n para limpiar, mapear y normalizar los datos del JSON
         * Se basa en las claves "League", "Match", y "Result FT".
         */
        function cleanAndMapData(data) {
            
            const cleanedData = data.map(match => {
                const matchString = match.Match ? String(match.Match).trim() : null;
                const resultString = match['Result FT'] ? String(match['Result FT']).trim() : null;
                
                let local = '';
                let visitante = '';
                let golesLocal = 0;
                let golesVisitante = 0;
                
                // 1. EXTRAER EQUIPOS DE "Match" (Ej: "Flamengo - Bragantino")
                if (matchString && matchString.includes(' - ')) {
                    const parts = matchString.split(' - ').map(p => p.trim());
                    if (parts.length === 2) {
                        local = parts[0];
                        visitante = parts[1];
                    }
                }
                
                // 2. EXTRAER GOLES DE "Result FT" (Ej: "1-0")
                if (resultString && resultString.includes('-')) {
                    const scoreParts = resultString.split('-').map(p => parseInt(p.trim()));
                    if (scoreParts.length === 2 && !isNaN(scoreParts[0]) && !isNaN(scoreParts[1])) {
                        golesLocal = scoreParts[0];
                        golesVisitante = scoreParts[1];
                    }
                }
                
                return {
                    liga: match.League ? String(match.League).trim() : 'Sin Liga',
                    local: local,
                    visitante: visitante,
                    golesLocal: golesLocal,
                    golesVisitante: golesVisitante,
                };
            });
            
            // Filtramos partidos que no tienen equipos v√°lidos
            const validMatches = cleanedData.filter(match => match.local && match.visitante);
            
            return validMatches;
        }

        // Manejador para la carga de archivo JSON
        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const rawData = JSON.parse(e.target.result);
                        
                        const dataArray = Array.isArray(rawData) ? rawData : [rawData];
                        
                        matchHistory = cleanAndMapData(dataArray);
                        
                        if (matchHistory.length === 0) {
                             alert("‚ö†Ô∏è Archivo JSON cargado, pero no se encontraron partidos v√°lidos. Revisa el formato.");
                        } else {
                            alert(`‚úÖ ¬°Archivo cargado! ${matchHistory.length} partidos listos para analizar.`);
                            populateLeagueSelector();
                        }
                    } catch (error) {
                        alert("‚ùå Error al parsear el archivo JSON. Aseg√∫rate de que el formato sea correcto.");
                        console.error("Error de parseo JSON:", error);
                        matchHistory = []; 
                        leagueSelect.disabled = true;
                    }
                };
                reader.readAsText(file);
            }
        });

        // ---------------------------------------------
        // FUNCIONES DE INTERFAZ
        // ---------------------------------------------

        function populateLeagueSelector() {
            const uniqueLeagues = new Set();
            matchHistory.forEach(match => uniqueLeagues.add(match.liga));

            leagueSelect.innerHTML = '<option value="">-- Seleccione una Liga --</option>';
            uniqueLeagues.forEach(league => {
                const option = document.createElement('option');
                option.value = league;
                option.textContent = league;
                leagueSelect.appendChild(option);
            });
            
            leagueSelect.disabled = false;
            localTeamSelect.disabled = true;
            visitorTeamSelect.disabled = true;
        }

        // FUNCI√ìN CLAVE: HABILITA Y CARGA LOS EQUIPOS EN LOS SELECTS
        function populateTeams() {
            const selectedLeague = leagueSelect.value;
            
            localTeamSelect.innerHTML = '';
            visitorTeamSelect.innerHTML = ''; 

            if (!selectedLeague) {
                // Si no hay liga seleccionada, deshabilitar y poner mensaje
                localTeamSelect.disabled = true;
                visitorTeamSelect.disabled = true;
                localTeamSelect.innerHTML = '<option value="">Seleccione la liga para ver los equipos</option>';
                visitorTeamSelect.innerHTML = '<option value="">Seleccione la liga para ver los equipos</option>';
                return;
            }

            // 1. Recolectar equipos √∫nicos
            const leagueMatches = matchHistory.filter(match => match.liga === selectedLeague);
            const uniqueTeams = new Set();

            leagueMatches.forEach(match => {
                if (match.local) uniqueTeams.add(match.local);
                if (match.visitante) uniqueTeams.add(match.visitante);
            });
            
            // Opci√≥n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Seleccione un Equipo --";

            localTeamSelect.appendChild(defaultOption.cloneNode(true));
            visitorTeamSelect.appendChild(defaultOption.cloneNode(true));

            // 2. Rellenar los SELECTs con los equipos √∫nicos
            uniqueTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                localTeamSelect.appendChild(option.cloneNode(true));
                visitorTeamSelect.appendChild(option.cloneNode(true));
            });

            // 3. HABILITAR CAMPOS DE EQUIPO
            localTeamSelect.disabled = false;
            visitorTeamSelect.disabled = false;
        }


        // ---------------------------------------------
        // FUNCI√ìN PRINCIPAL DE AN√ÅLISIS
        // ---------------------------------------------

        function analyzeData() {
            const selectedLeague = leagueSelect.value;
            // Obtener el valor de los SELECTs
            const localTeam = localTeamSelect.value.trim();
            const visitorTeam = visitorTeamSelect.value.trim();
            
            // 1. Validaciones
            if (!matchHistory.length) {
                alert("Primero debes cargar el archivo JSON.");
                return;
            }
            if (!selectedLeague) {
                alert("Por favor, selecciona una Liga.");
                return;
            }
            if (!localTeam || !visitorTeam) {
                alert("Por favor, selecciona el Equipo Local y Visitante.");
                return;
            }
            if (localTeam.toLowerCase() === visitorTeam.toLowerCase()) {
                alert("El equipo local no puede ser el mismo que el visitante.");
                return;
            }

            const localTeamLC = localTeam.toLowerCase();
            const visitorTeamLC = visitorTeam.toLowerCase();


            // 2. Filtrar partidos relevantes
            const relevantMatches = matchHistory.filter(match => {
                const matchLocalLC = match.local.toLowerCase();
                const matchVisitorLC = match.visitante.toLowerCase();

                return match.liga === selectedLeague && (
                    (matchLocalLC === localTeamLC && matchVisitorLC === visitorTeamLC) ||
                    (matchLocalLC === visitorTeamLC && matchVisitorLC === localTeamLC)
                );
            });

            if (relevantMatches.length === 0) {
                document.getElementById('prob25').textContent = "N/A";
                document.getElementById('probBTTS').textContent = "N/A";
                document.getElementById('personalAnalysis').innerHTML = `No se encontraron **enfrentamientos directos** (${localTeam} vs ${visitorTeam}) en la liga **${selectedLeague}**.`;
                document.getElementById('results').style.display = 'block';
                return;
            }
            
            // --- 3. C√°lculo de M√©tricas (Misma l√≥gica) ---
            let countOver25 = 0;
            let countBTTS = 0;
            let totalMatchesForAnalysis = relevantMatches.length;

            let localScored = 0;
            let visitorScored = 0;
            let localConceded = 0;
            let visitorConceded = 0;
            let totalGoals = 0;

            relevantMatches.forEach(match => {
                const G_local = match.golesLocal; 
                const G_visitor = match.golesVisitante;
                
                const totalGoles = G_local + G_visitor;
                if (totalGoles > 2.5) {
                    countOver25++;
                }
                totalGoals += totalGoles;

                if (G_local > 0 && G_visitor > 0) {
                    countBTTS++;
                }

                if (match.local.toLowerCase() === localTeamLC) {
                    localScored += G_local;
                    localConceded += G_visitor;
                } else if (match.visitante.toLowerCase() === localTeamLC) {
                    localScored += G_visitor;
                    localConceded += G_local;
                }

                if (match.local.toLowerCase() === visitorTeamLC) {
                    visitorScored += G_local;
                    visitorConceded += G_visitor;
                } else if (match.visitante.toLowerCase() === visitorTeamLC) {
                    visitorScored += G_visitor;
                    visitorConceded += G_local;
                }
            });

            const probOver25 = (countOver25 / totalMatchesForAnalysis) * 100;
            const probBTTS = (countBTTS / totalMatchesForAnalysis) * 100;
            
            const avgGoals = (totalGoals / totalMatchesForAnalysis).toFixed(2);
            const localAttackIndex = (localScored / totalMatchesForAnalysis).toFixed(2);
            const visitorAttackIndex = (visitorScored / totalMatchesForAnalysis).toFixed(2);
            const localDefenseIndex = (localConceded / totalMatchesForAnalysis).toFixed(2);
            const visitorDefenseIndex = (visitorConceded / totalMatchesForAnalysis).toFixed(2);


            // --- 4. Mostrar Resultados ---
            document.getElementById('prob25').textContent = `${probOver25.toFixed(2)}% (${countOver25} de ${totalMatchesForAnalysis} partidos)`;
            document.getElementById('probBTTS').textContent = `${probBTTS.toFixed(2)}% (${countBTTS} de ${totalMatchesForAnalysis} partidos)`;
            document.getElementById('results').style.display = 'block';

            // --- 5. An√°lisis Personalizado (Deducci√≥n) ---
            const analysisText = generatePersonalAnalysis(localTeam, visitorTeam, probOver25, probBTTS, avgGoals, localAttackIndex, visitorAttackIndex, localDefenseIndex, visitorDefenseIndex);
            document.getElementById('personalAnalysis').innerHTML = analysisText;
        }

        function generatePersonalAnalysis(localTeam, visitorTeam, p25, pBTTS, avgG, laI, vaI, ldI, vdI) {
            let analysis = "";

            analysis += `**üéØ Sobre el Total de Goles (M√°s de 2.5):**<br>`;
            if (p25 >= 70) {
                analysis += `Con una probabilidad hist√≥rica muy alta (**${p25.toFixed(0)}%**), y un promedio de **${avgG}** goles, es casi seguro que ser√° un partido con **marcador abultado**. <br><br>`;
            } else if (p25 >= 50) {
                analysis += `La probabilidad de M√°s de 2.5 Goles es moderada (**${p25.toFixed(0)}%**). El riesgo es alto, pero el historial de **${avgG}** goles sugiere que la l√≠nea podr√≠a superarse. <br><br>`;
            } else {
                analysis += `La probabilidad de M√°s de 2.5 Goles es baja (**${p25.toFixed(0)}%**). La tendencia clara en sus duelos es al **Menos de 2.5 Goles**, sugiriendo un partido t√°ctico y cerrado. <br><br>`;
            }

            analysis += `**ü§ù Sobre Ambos Anotan (BTTS):**<br>`;
            if (pBTTS >= 70) {
                analysis += `Con una alt√≠sima probabilidad (**${pBTTS.toFixed(0)}%**), es evidente que **ambos equipos se hacen da√±o mutuamente**. <br><br>`;
            } else if (pBTTS >= 50) {
                analysis += `La probabilidad moderada (**${pBTTS.toFixed(0)}%**) de BTTS indica que un equipo puede fallar en su ataque o que la defensa contraria es intermitentemente s√≥lida. Es un riesgo moderado. <br><br>`;
            } else {
                analysis += `La baja probabilidad de BTTS (**${pBTTS.toFixed(0)}%**) sugiere que en sus enfrentamientos directos, **uno de los dos equipos suele dominar o anular al otro**. <br><br>`;
            }

            analysis += `**üí° Deducci√≥n Final del Analista:**<br>`;
            if (p25 >= 60 && pBTTS >= 60) {
                analysis += `**‚úÖ ALTA OFENSIVA:** La combinaci√≥n perfecta para un **festival de goles**. El historial sugiere un resultado como 2-1, 2-2 o 3-2. <br>`;
            } else if (p25 < 50 && pBTTS < 50) {
                analysis += `**‚ùå ALTA DEFENSIVA:** Ambas probabilidades son bajas. Esto es un pron√≥stico de **Menos de 2.5 Goles** y posiblemente un resultado de 1-0 o 0-0. <br>`;
            } else if (p25 >= 60 && pBTTS < 50) {
                analysis += `**‚ö†Ô∏è GOLEADA UNILATERAL:** Alta probabilidad de muchos goles, pero bajo BTTS. El historial sugiere una **dominaci√≥n total** de un equipo sobre el otro (Ej: 3-0, 4-0).<br>`;
            } else {
                analysis += `**ü§î RESULTADO MIXTO:** El partido es incierto. Una m√©trica es alta y la otra baja. Se recomienda un an√°lisis detallado de la forma actual de los equipos.<br>`;
            }
            
            return analysis;
        }

    </script>
</body>
</html>

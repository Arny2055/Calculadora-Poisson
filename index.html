<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Football Backtester v8.5 (Estad√≠sticas por Frecuencia)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root {
            /* Colores Base */
            --bg-main: #0c1524;
            --bg-panel: #1a2434;
            --bg-card: #222e40;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;

            /* Colores de Marca y Feedback */
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --stats-bg: #1d4ed8; 
            --stats-accent: #60a5fa;
            --stats-dark: #1e3a8a;
        }

        * { 
            box-sizing: border-box; 
            outline: none; 
            min-width: 0; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .separator { border: 0; height: 1px; background: var(--border); margin: 15px 0; }
        
        header {
            background-color: var(--bg-panel);
            padding: 10px 15px;
            height: 50px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .brand { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .tag { font-size:0.6em; background:var(--stats-bg); padding:2px 6px; border-radius:8px; color:white; font-weight: normal; }

        .btn { 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            border: none; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            color:white; 
            font-size: 0.8rem; 
            transition: background-color 0.2s;
        }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }

        .container { 
            display: grid; 
            grid-template-columns: 250px 1fr; 
            height: calc(100vh - 50px); 
            overflow: hidden; 
        }
        
        .sidebar { 
            background-color: var(--bg-panel); 
            border-right: 1px solid var(--border); 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }

        .sidebar h3 { 
            margin: 0; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            color: var(--text-secondary); 
            letter-spacing: 0.5px; 
            padding-bottom: 5px; 
        }

        .control-group label { 
            display: block; 
            margin-bottom: 2px; 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            font-weight: 600;
        }

        select, input[type="number"], input[type="text"] { 
            width: 100%; 
            padding: 6px; 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            color: white; 
            font-size: 0.8rem; 
        }
        
        .btn-run { 
            background: var(--success); 
            width: 100%; 
            justify-content: center; 
            padding: 10px; 
            margin-top: 10px; 
            font-size: 0.9rem; 
        }

        .tab-controls {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .tab-button {
            flex-grow: 1;
            text-align: center;
            padding: 8px 0;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }
        .tab-content { display: none; padding-top: 5px; }
        .tab-content.active { display: block; }
        
        .matchup-selectors { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }

        .main { 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }

        .kpi-wrapper {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 5px; 
        }
        .kpi-grid { 
            display: inline-flex; 
            gap: 10px; 
        }
        .kpi-card { 
            min-width: 140px; 
            background: var(--bg-card); 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--border); 
        }
        .kpi-title { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
        .kpi-value { font-size: 1.3rem; font-weight: 700; margin-top: 2px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-blue { color: var(--stats-accent); }
        .text-orange { color: var(--warning); }

        .stats-card { 
            background: #2f496e; 
            padding: 15px; 
            border-radius: 6px;
            border: 1px solid var(--stats-accent);
            flex-shrink: 0;
            display:none;
        }

        .stats-grid-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
        }

        .stats-odds-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px;
        }

        .stats-odds-item {
            padding: 6px;
        }

        .score-matrix table {
            width: 100%;
            font-size: 0.75rem; 
        }
        .score-matrix th, .score-matrix td {
            padding: 3px; 
            border: 1px solid #334155;
        }
        
        .chart-box-full {
            height: 250px; 
        }

        .split-row {
            display: flex; 
            gap: 15px; 
        }
        .panel-box {
            width: 50%;
        }
        
        .panel-title { font-size: 0.85rem; }
        
        .table-scroll { overflow-y: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; } 
        th { padding: 8px 10px; }
        td { padding: 6px 10px; }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2rem;
        }
        .spinner {
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos espec√≠ficos para la tabla de ranking mejorada */
        #teamTable th, #teamTable td {
            padding: 4px 6px; 
            font-size: 0.75rem; 
            text-align: center;
        }
        #teamTable th:first-child, #teamTable td:first-child {
            text-align: left;
            width: 40%;
            font-size: 0.8rem;
        }
        #teamTable thead th {
            font-weight: 700;
            background-color: var(--border);
            color: var(--text-primary);
        }
    </style>
</head>
<body>

    <div id="loadingOverlay" style="display:none;"><i class="fas fa-circle-notch spinner"></i><h3 style="margin-top:20px; color:#ccc;">Procesando Datos y Calculando Estad√≠sticas...</h3></div>

    <header>
        <div class="brand"><i class="fas fa-calculator"></i> Football Backtester <span class="tag">v8.5 Frecuencia</span></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="file" id="fileInput" accept=".csv" multiple>
            <label for="fileInput" class="btn btn-secondary"><i class="fas fa-folder-open"></i> Cargar Archivos CSV (2)</label>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            
            <div class="control-group">
                <label>URL Temporada Actual</label>
                <input type="text" id="urlInputCurrent" placeholder="URL CSV">
            </div>
            <div class="control-group">
                <label>URL Temporada ANTERIOR (Opcional)</label>
                <input type="text" id="urlInputPrevious" placeholder="URL CSV">
            </div>
            <button onclick="loadFromUrls()" class="btn btn-primary" style="margin-bottom:10px;"><i class="fas fa-cloud-download-alt"></i> Cargar URLs</button>

            <hr class="separator">

            <div class="tab-controls">
                <div id="tabConfigBtn" class="tab-button active" onclick="switchTab('config')"><i class="fas fa-sliders-h"></i> Configuraci√≥n</div>
                <div id="tabEstadisticasBtn" class="tab-button" onclick="switchTab('estadisticas')"><i class="fas fa-chart-line"></i> Estad√≠sticas</div>
            </div>

            <div id="tabConfig" class="tab-content active">
                <h3>‚öôÔ∏è Configuraci√≥n de Apuesta</h3>
                <div class="control-group">
                    <label>Mercado</label>
                    <select id="marketSelect">
                        <option value="H">Local (1)</option>
                        <option value="D">Empate (X)</option>
                        <option value="A">Visita (2)</option>
                        <option value="O25">Over 2.5 Goles</option>
                        <option value="U25">Under 2.5 Goles</option>
                    </select>
                </div>
                <div class="control-group">
                    <label style="color:var(--stats-accent); font-weight:bold;">
                        <input type="checkbox" id="useFrequencyValue" style="width:auto; margin-right:5px; transform:scale(1.2);" checked> Usar Filtro de Valor por Frecuencia
                    </label>
                </div>

                <div class="control-group">
                    <label>Gesti√≥n de Stake / Banca (Inicial)</label>
                    <div style="display:flex; gap:5px;">
                        <select id="stakeType" style="width:60%;">
                            <option value="flat">Plano (Fijo)</option>
                            <option value="percent">% Banca</option>
                            <option value="kelly" selected>Criterio de Kelly</option>
                        </select>
                        <input type="number" id="stakeValue" value="5" step="0.1" style="width:40%;" placeholder="Stake">
                    </div>
                    <input type="number" id="initialBank" value="1000" style="margin-top:5px;" placeholder="Banca Inicial">
                </div>
                
                <hr class="separator">

                <h3>üîç Filtros Globales</h3>
                <div class="control-group">
                    <label>Rango de Cuota</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="minOdds" value="1.01" step="0.01" min="1.01" style="width:50%;" placeholder="Min Odd">
                        <input type="number" id="maxOdds" value="10.00" step="0.01" min="1.01" style="width:50%;" placeholder="Max Odd">
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Rango de Goles</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="minGoals" value="0" step="1" min="0" style="width:50%;" placeholder="Min Goles">
                        <input type="number" id="maxGoals" value="10" step="1" min="0" style="width:50%;" placeholder="Max Goles">
                    </div>
                </div>

                <div class="control-group">
                    <label>Liga</label>
                    <select id="leagueSelect"><option value="all">Todas</option></select>
                </div>
            </div>

            <div id="tabEstadisticas" class="tab-content">
                <div class="matchup-selectors">
                    <h3 style="border:none; margin-bottom:5px; color:white; font-size:0.9rem;">Selecci√≥n de Partido (An√°lisis Individual)</h3>
                    <div class="control-group">
                        <label>Equipo Local</label>
                        <select id="teamHomeSelect"><option value="">Sel. Local</option></select>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="control-group">
                        <label>Equipo Visitante</label>
                        <select id="teamAwaySelect"><option value="">Sel. Visita</option></select>
                    </div>
                    <button class="btn" style="background:var(--stats-accent); color:black; width:100%; justify-content:center; margin-top:5px;" onclick="analyzeMatchup()">
                        <i class="fas fa-chart-bar"></i> Calcular Estad√≠sticas / Valor
                    </button>
                </div>

                <hr class="separator">

                <h3 style="border:none; margin-bottom:10px; color:white; font-size:0.9rem;">üìà Proyecci√≥n Hist√≥rica por Cuota</h3>
                <div class="control-group" style="margin-bottom:10px;">
                    <label>Cuota Objetivo ($O_{Target}$)</label>
                    <input type="number" id="targetOddsInput" value="2.00" step="0.01" min="1.01" placeholder="Ej: 2.00">
                </div>
                <button class="btn btn-primary" style="background:var(--accent); width:100%; justify-content:center;" onclick="analyzeOddsProjection()">
                    <i class="fas fa-chart-line"></i> Simular Cuota
                </button>
                
                <div id="oddsProjectionCard" class="stats-card" style="margin-top:15px; display:none; background:var(--bg-card); border-color:var(--accent);">
                    </div>
            </div>
            
            <button class="btn btn-run" onclick="runBacktest()"><i class="fas fa-play"></i> EJECUTAR BACKTEST</button>
            
        </aside>

        <main class="main">
            
            <div id="statsCard" class="stats-card"></div> 

            <div class="kpi-wrapper">
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">Apuestas</div><div class="kpi-value" id="valBets">0</div></div>
                    <div class="kpi-card"><div class="kpi-title">Win Rate</div><div class="kpi-value" id="valWinRate">0%</div></div>
                    <div class="kpi-card"><div class="kpi-title">Profit</div><div class="kpi-value" id="valProfit">0.00</div></div>
                    <div class="kpi-card"><div class="kpi-title">Yield</div><div class="kpi-value" id="valYield">0%</div></div>
                    <div class="kpi-card"><div class="kpi-title">Drawdown</div><div class="kpi-value text-red" id="valDrawdown">0%</div></div>
                    <div class="kpi-card"><div class="kpi-title">Riesgo Ruina</div><div class="kpi-value text-blue" id="valRoR">0%</div></div>
                </div>
            </div>
            
            <div class="opt-card" style="padding:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px; margin-bottom:5px;">
                    <div class="kpi-title" style="color:white; font-size:0.85rem;">‚úÖ RANGO √ìPTIMO DE CUOTA</div>
                    <span id="compStatus" style="font-size:0.75rem; font-weight:bold; padding:2px 6px; border-radius:4px; background:var(--warning);">N/A</span>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; text-align:center;">
                    <div>
                        <div class="kpi-title">RANGO GLOBAL</div>
                        <div class="kpi-value" id="valOptimalOddsRange" style="font-size:1.2rem;">N/A</div>
                        <div class="kpi-title" style="margin-top:3px;">Yield: <b id="valOptimalOddsYield">0.00%</b> (Bets: <b id="valOptimalOddsBets">0</b>)</div>
                    </div>

                    <div style="border-left:1px dashed #334155; padding-left:10px;">
                        <div class="kpi-title"><i class="fas fa-calendar-check"></i> <span id="currentYear">Actual</span></div>
                        <div class="kpi-value text-orange" id="currentYield" style="font-size:1.2rem;">N/A</div>
                        <div class="kpi-title" id="currentSample" style="font-size:0.7rem; margin-top:3px;">(Muestra: 0/0)</div>
                    </div>

                    <div style="border-left:1px dashed #334155; padding-left:10px;">
                        <div class="kpi-title"><i class="fas fa-calendar-alt"></i> <span id="previousYear">Anterior</span></div>
                        <div class="kpi-value text-orange" id="previousYield" style="font-size:1.2rem;">N/A</div>
                        <div class="kpi-title" id="previousSample" style="font-size:0.7rem; margin-top:3px;">(Muestra: 0/0)</div>
                    </div>
                </div>
            </div>


            <div class="charts-section">
                <div class="chart-box-full">
                    <canvas id="equityChart"></canvas>
                </div>
                
                <div class="split-row">
                    <div class="panel-box">
                        <div class="panel-header"><span class="panel-title"><i class="fas fa-chart-bar"></i> Rendimiento Por Ligas</span></div>
                        <div style="padding:10px; flex-grow:1;"><canvas id="leagueChart"></canvas></div>
                    </div>
                    <div class="panel-box">
                        <div class="panel-header"><span class="panel-title"><i class="fas fa-users"></i> Ranking Equipos (Profit)</span></div>
                        <div class="table-scroll">
                            <table id="teamTable">
                                <thead>
                                    <tr>
                                        <th>Equipo</th>
                                        <th><i class="fas fa-globe-americas"></i> Overall</th>
                                        <th><i class="fas fa-home"></i> Home</th>
                                        <th><i class="fas fa-plane-departure"></i> Away</th>
                                    </tr>
                                </thead>
                                <tbody id="teamTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-box" style="height: 250px; flex-shrink:0;">
                <div class="panel-header"><span class="panel-title"><i class="fas fa-history"></i> Historial Detallado (√öltimas 50)</span></div>
                <div class="table-scroll">
                    <table id="resultsTable">
                        <thead><tr><th>Fecha</th><th>Partido</th><th>Sel</th><th>Cuota</th><th>Stake</th><th>Res</th><th>P/L</th><th>Banca</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // *** COMIENZO DE LA L√ìGICA JAVASCRIPT ***
        let rawData = [];
        let seasonYears = { current: null, previous: null };
        let currentSeasonData = []; 
        let currentStats = null; 
        let chartEq=null, chartLg=null;
        const RoR_BANK_FRACTION = 0.5; 
        let globalWinRate = 0; 
        let totalStakeUnits = 0; 

        // --- Tabs Logic ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
            const btnId = tabId === 'estadisticas' ? 'tabEstadisticasBtn' : 'tabConfigBtn';
            document.getElementById(btnId).classList.add('active');
            
            // Ocultar card Stats/Proyeccion al cambiar de tab (si no estamos en el tab Estadisticas)
            if (tabId !== 'estadisticas') {
                document.getElementById('statsCard').style.display = 'none';
                document.getElementById('oddsProjectionCard').style.display = 'none';
            }
        }

        // --- FUNCIONES MATEM√ÅTICAS ---
        
        function calculateKellyStake(p, o) {
            const b = o - 1;
            const q = 1 - p;
            let f = ((b * p) - q) / b;
            return Math.max(0.005, f); 
        }

        function calculateRiskOfRuina(totalBets, totalStake, globalWinRate) {
            if (totalBets === 0 || totalStake === 0) return 100;
            
            const W = globalWinRate;
            const L = 1 - W;
            
            const avgOdds = totalStake / totalBets; 
            const breakEven = 1 / avgOdds;
            if (W <= breakEven) return 100; 

            const bankUnits = parseFloat(document.getElementById('initialBank').value) * RoR_BANK_FRACTION;
            const avgStake = totalStake / totalBets; 

            const B_units = bankUnits / (avgStake || 1);
            const RoR_Estimate = Math.pow((L / W), B_units);

            return Math.min(100, RoR_Estimate * 100);
        }

        // --- FIN FUNCIONES MATEM√ÅTICAS ---

        // --- CARGA Y PROCESAMIENTO DE DATOS ---
        document.getElementById('fileInput').addEventListener('change', loadFromLocalFiles);
        
        function loadFromLocalFiles(e) {
            const files = e.target.files;
            
            if (files.length === 0) return;
            if (files.length !== 2) {
                alert("Por favor, selecciona EXACTAMENTE dos archivos CSV: uno para la temporada actual y uno para la temporada anterior.");
                document.getElementById('fileInput').value = ''; 
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';

            let combinedData = [];
            const parseFile = (file) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const validData = results.data.filter(r => Object.keys(r).length > 0 && r.HomeTeam);
                            if (validData.length === 0 && file.size > 0) {
                                reject(`El archivo ${file.name} no contiene datos utilizables.`);
                            } else {
                                resolve(validData);
                            }
                        },
                        error: (error, file) => {
                            reject(`Error de parsing en el archivo ${file.name}. Mensaje: ${error.message}`);
                        }
                    });
                });
            };

            Promise.all(Array.from(files).map(parseFile))
                .then(dataArrays => {
                    dataArrays.forEach(data => combinedData.push(...data));
                    if (combinedData.length === 0) {
                        throw new Error("No se encontraron datos utilizables en los archivos combinados. Verifique el formato CSV.");
                    }
                    processData(combinedData);
                })
                .catch(error => {
                    console.error("Error al cargar archivos locales:", error);
                    alert(`‚ùå Error cargando archivos locales:\n\n${error}`);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('fileInput').value = ''; 
                });
        }
        
        async function loadFromUrls() {
            const urlCurrent = document.getElementById('urlInputCurrent').value.trim();
            const urlPrevious = document.getElementById('urlInputPrevious').value.trim();
            
            if (!urlCurrent) return alert("La URL de la Temporada Actual es obligatoria.");

            document.getElementById('loadingOverlay').style.display = 'flex';

            // Proxy para evitar problemas de CORS
            const corsProxy = 'https://api.allorigins.win/raw?url=';
            const urls = [urlCurrent];
            if (urlPrevious) urls.push(urlPrevious);

            try {
                const fetchPromises = urls.map(url => 
                    fetch(corsProxy + encodeURIComponent(url))
                        .then(res => {
                            if (!res.ok) throw new Error(`Fallo al obtener datos de ${url}. Estado: ${res.status}`);
                            return res.text();
                        })
                );
                
                const texts = await Promise.all(fetchPromises);
                
                let combinedData = [];
                let parsingErrors = []; 

                texts.forEach((text, index) => {
                    const url = urls[index];
                    Papa.parse(text, { 
                        header: true, 
                        dynamicTyping: true, 
                        skipEmptyLines: true, 
                        complete: (results) => {
                            const validData = results.data.filter(r => Object.keys(r).length > 0 && r.HomeTeam); 
                            if (validData.length === 0 && text.length > 0) parsingErrors.push(`La URL ${url} no devolvi√≥ datos utilizables o el formato es incorrecto.`);
                            combinedData.push(...validData); 
                        },
                        error: (error, file) => {
                            console.error(`Error de PapaParse en la URL ${url}. Mensaje: ${error.message}`);
                            parsingErrors.push(`Error de parsing en la URL ${url}. Mensaje: ${error.message}`);
                        }
                    });
                });
                
                if (parsingErrors.length > 0) throw new Error(parsingErrors.join('\n'));
                if (combinedData.length === 0) throw new Error("No se encontraron datos utilizables. Aseg√∫rese de que las URLs sean enlaces directos a CSVs y no est√©n vac√≠os.");

                processData(combinedData);

            } catch(e){ 
                console.error("Error general en carga:", e);
                alert(`‚ùå Error cargando datos:\n\n${e.message || "Verifique si las URLs son enlaces directos a CSVs accesibles o si el archivo no est√° vac√≠o."}`); 
                document.getElementById('loadingOverlay').style.display='none'; 
            }
        }
        
        // Funci√≥n de C√°lculo de Estad√≠sticas de Frecuencia
        function calculateCurrentSeasonStats(data) {
            const teamStats = {};
            let totalMatches = 0;
            let totalHomeGoals = 0;
            let totalAwayGoals = 0;
            let totalHomeWins = 0, totalDraws = 0, totalAwayWins = 0;
            let totalOver25 = 0;

            // 1. Conteo global y por equipo
            data.forEach(r => {
                if(r.goalsH >= 0 && r.goalsA >= 0) {
                    totalMatches++;
                    totalHomeGoals += r.goalsH;
                    totalAwayGoals += r.goalsA;
                    if (r.res === 'H') totalHomeWins++;
                    else if (r.res === 'D') totalDraws++;
                    else if (r.res === 'A') totalAwayWins++;
                    if (r.goalsH + r.goalsA > 2) totalOver25++;


                    const updateStats = (team, goalsScored, goalsConceded, isHome) => {
                        if (!teamStats[team]) {
                            teamStats[team] = { playedH: 0, scoredH: 0, concededH: 0, playedA: 0, scoredA: 0, concededA: 0 };
                        }
                        if (isHome) {
                            teamStats[team].playedH++;
                            teamStats[team].scoredH += goalsScored;
                            teamStats[team].concededH += goalsConceded;
                        } else {
                            teamStats[team].playedA++;
                            teamStats[team].scoredA += goalsScored;
                            teamStats[team].concededA += goalsConceded;
                        }
                    };

                    updateStats(r.home, r.goalsH, r.goalsA, true);
                    updateStats(r.away, r.goalsA, r.goalsH, false);
                }
            });
            
            if (totalMatches === 0) return null;

            // 2. C√°lculos de promedios globales
            const avgGoalsHome = totalHomeGoals / totalMatches;
            const avgGoalsAway = totalAwayGoals / totalMatches;
            
            const globalProbs = {
                pHome: totalHomeWins / totalMatches,
                pDraw: totalDraws / totalMatches,
                pAway: totalAwayWins / totalMatches,
                pOver25: totalOver25 / totalMatches,
                pUnder25: 1 - (totalOver25 / totalMatches)
            };

            // 3. Coeficientes (Factores de Ataque/Defensa por Frecuencia)
            const teamCoeffs = {};

            for (const team in teamStats) {
                const stats = teamStats[team];
                
                // Ataque y Defensa por Frecuencia Home (Promedio de Goles Marcados/Recibidos en Casa)
                const attH = (stats.playedH > 0) ? (stats.scoredH / stats.playedH) : avgGoalsHome;
                const defH = (stats.playedH > 0) ? (stats.concededH / stats.playedH) : avgGoalsAway;
                
                // Ataque y Defensa por Frecuencia Away (Promedio de Goles Marcados/Recibidos Fuera)
                const attA = (stats.playedA > 0) ? (stats.scoredA / stats.playedA) : avgGoalsAway;
                const defA = (stats.playedA > 0) ? (stats.concededA / stats.playedA) : avgGoalsHome;

                teamCoeffs[team] = { 
                    attH, defH, attA, defA, 
                    playedH: stats.playedH, 
                    playedA: stats.playedA 
                };
            }

            return {
                globalAverages: { avgGoalsHome, avgGoalsAway, totalMatches },
                globalProbs: globalProbs,
                teamCoeffs: teamCoeffs
            };
        }


        function processData(data) {
            rawData = data.map(r => {
                if(!r.Date || !r.HomeTeam || isNaN(r.FTHG) || isNaN(r.FTAG)) return null;
                
                let d = r.Date; 
                if(typeof d === 'string' && d.includes('/')) { 
                    const p = d.split('/');
                    if (p.length === 3) {
                        let year = p[2];
                        if (year.length === 2) {
                            const currentYear = new Date().getFullYear();
                            const century = (currentYear - (currentYear % 100)); 
                            year = (parseInt(year) < 70) ? (century + parseInt(year)).toString() : (century - 100 + parseInt(year)).toString();
                        }
                        d = `${year}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; 
                    }
                } 
                
                return {
                    date:d, league:r.Div, home:r.HomeTeam, away:r.AwayTeam, res:r.FTR, goalsH:r.FTHG, goalsA:r.FTAG,
                    oddsH:r.B365H||r.AvgH||1.01, oddsD:r.B365D||r.AvgD||1.01, oddsA:r.B365A||r.AvgA||1.01,
                    oddsO25:r['B365>2.5']||r.Avg25||1.01, oddsU25:r['B365<2.5']||r.Avg25_1||1.01,
                    totalGoals: r.FTHG + r.FTAG
                };
            }).filter(x=>x && x.oddsH > 1.01); 

            rawData.sort((a, b) => a.date.localeCompare(b.date));
            
            const allDates = rawData.map(r => r.date.substring(0, 4));
            const uniqueYears = [...new Set(allDates)].sort().reverse(); 
            
            seasonYears.current = uniqueYears.length > 0 ? uniqueYears[0] : null;
            seasonYears.previous = uniqueYears.length > 1 ? uniqueYears[1] : null;
            
            // Filtrar y entrenar solo con datos de la temporada actual (o la m√°s reciente)
            currentSeasonData = rawData.filter(r => seasonYears.current && r.date.startsWith(seasonYears.current));
            currentStats = calculateCurrentSeasonStats(currentSeasonData);
            
            if(currentStats) {
                const teams = Object.keys(currentStats.teamCoeffs).sort();
                const populate = (id) => {
                    const s = document.getElementById(id); s.innerHTML='<option value="">Seleccionar</option>';
                    teams.forEach(t => s.add(new Option(t,t)));
                };
                populate('teamHomeSelect'); populate('teamAwaySelect');
            }
            
            const lgSel = document.getElementById('leagueSelect'); lgSel.innerHTML='<option value="all">Todas</option>';
            [...new Set(rawData.map(x=>x.league))].sort().forEach(l=>lgSel.add(new Option(l,l)));

            document.getElementById('loadingOverlay').style.display='none';
            runBacktest(); 
        }


        // --- L√ìGICA CORE ---
        function getMarketOdds(row, mkt) {
            if(mkt==='H') return row.oddsH;
            if(mkt==='D') return row.oddsD;
            if(mkt==='A') return row.oddsA;
            if(mkt==='O25') return row.oddsO25;
            if(mkt==='U25') return row.oddsU25;
            return 0; 
        }

        function isWinningBet(row, mkt) {
            if(mkt==='H') return row.res==='H';
            if(mkt==='D') return row.res==='D';
            if(mkt==='A') return row.res==='A';
            if(mkt==='O25') return (row.goalsH+row.goalsA)>2; 
            if(mkt==='U25') return (row.goalsH+row.goalsA)<3; 
            return false;
        }

        // --- AN√ÅLISIS POR FRECUENCIA ---
        function calculateFrequencyProbabilities(homeTeam, awayTeam, stats) {
            if (!stats) return null;
            const { globalAverages, globalProbs, teamCoeffs } = stats;
            const homeCoeffs = teamCoeffs[homeTeam];
            const awayCoeffs = teamCoeffs[awayTeam];
            
            if (!homeCoeffs || !awayCoeffs) return null;

            // C√°lculo de Goles Esperados (Lambda)
            // L√≥gica: AttH * DefA / AvgGoalsAway (Similar a Poisson pero usando coeficientes de frecuencia pura)
            const lambda_H = homeCoeffs.attH * awayCoeffs.defA / globalAverages.avgGoalsAway;
            const lambda_A = awayCoeffs.attA * homeCoeffs.defH / globalAverages.avgGoalsHome;
            
            // Frecuencias de Resultados 1X2, O/U 2.5 
            // NOTA: Se usan las frecuencias globales para simular la probabilidad de mercado (O_frecuencia = 1/P_global)
            const pHome = globalProbs.pHome;
            const pDraw = globalProbs.pDraw;
            const pAway = globalProbs.pAway;

            const pOver25 = globalProbs.pOver25;
            const pUnder25 = globalProbs.pUnder25;
            
            return {
                lambda_H: lambda_H,
                lambda_A: lambda_A,
                pHome: pHome,
                pDraw: pDraw,
                pAway: pAway,
                pOver25: pOver25,
                pUnder25: pUnder25,
                scoreMatrix: null 
            };
        }
        
        function calculateProfit(row, mkt, stakeType, stakeValue, bank, minOdds, maxOdds, minGoals, maxGoals, useFrequency) {
            let o=getMarketOdds(row, mkt);
            if(!o || o<1.01) return null; 

            // --- 1. Filtro de Goles ---
            if(row.totalGoals < minGoals || row.totalGoals > maxGoals) return null;
            
            let pMarket = 0;
            let oddsFrequency = 0;
            let isValueBet = false;
            
            const isKelly = (stakeType === 'kelly');
            const requiresFrequency = useFrequency || isKelly;


            if (requiresFrequency) {
                // LLAMADA A LA NUEVA FUNCI√ìN DE ESTAD√çSTICAS
                const freqRes = calculateFrequencyProbabilities(row.home, row.away, currentStats); 
                if (!freqRes) return null; 

                if(mkt==='H') pMarket = freqRes.pHome;
                else if(mkt==='D') pMarket = freqRes.pDraw;
                else if(mkt==='A') pMarket = freqRes.pAway;
                else if(mkt==='O25') pMarket = freqRes.pOver25;
                else if(mkt==='U25') pMarket = freqRes.pUnder25;
                
                if (pMarket <= 0) return null; 

                oddsFrequency = 1 / pMarket;
                
                // Determinar si es una apuesta de valor (Odds Real > Odds Frecuencia)
                isValueBet = o > oddsFrequency;

                // Filtro de Valor Frecuencia: SI est√° activo, solo se permiten apuestas de valor
                if (useFrequency && !isValueBet) return null;
                
                // Si usamos Kelly, tambi√©n debe ser una apuesta de valor para calcular el stake Kelly positivo
                if (isKelly && !isValueBet) return null;
            }

            // --- 2. Filtro de Cuota Plana ---
            if (!requiresFrequency && (o < minOdds || o > maxOdds)) return null; 


            // --- L√≥gica de Stake ---
            let actualStake;
            if (stakeType === 'flat') {
                actualStake = stakeValue;
            } else if (stakeType === 'percent') {
                actualStake = bank * (stakeValue / 100);
            } else if (isKelly) {
                const kellyFraction = calculateKellyStake(pMarket, o);
                actualStake = bank * kellyFraction;
                actualStake = Math.min(actualStake, bank * (stakeValue / 100));
            }
            
            actualStake = Math.min(actualStake, bank);
            if (actualStake < 0.01) actualStake = 0; 
            if (actualStake === 0) return null;
            
            // --- Cierre de Apuesta ---
            let w = isWinningBet(row, mkt);
            return { 
                pnl: w ? (actualStake * o - actualStake) : -actualStake, 
                won: w, 
                odds: o, 
                stake: actualStake
            };
        }
        
        // --- AN√ÅLISIS DE PARTIDO POR FRECUENCIA ---
        function analyzeMatchup() {
            const homeTeam = document.getElementById('teamHomeSelect').value;
            const awayTeam = document.getElementById('teamAwaySelect').value;
            const mkt = document.getElementById('marketSelect').value;
            
            if (!homeTeam || !awayTeam || homeTeam === awayTeam) {
                document.getElementById('statsCard').style.display = 'none';
                return;
            }

            // Usamos las estad√≠sticas de la temporada actual
            const freqRes = calculateFrequencyProbabilities(homeTeam, awayTeam, currentStats);
            
            if (!freqRes) {
                document.getElementById('statsCard').style.display = 'block';
                document.getElementById('statsCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">No hay suficientes datos hist√≥ricos de la temporada actual para calcular las estad√≠sticas.</h3>`;
                return;
            }

            const lastMatch = currentSeasonData.find(r => r.home === homeTeam && r.away === awayTeam); 
            
            updateStatsCard(homeTeam, awayTeam, freqRes, lastMatch, mkt);
            document.getElementById('oddsProjectionCard').style.display = 'none'; 
        }

        function updateStatsCard(home, away, res, lastMatch, selectedMkt) {
            const card = document.getElementById('statsCard');
            card.style.display = 'block';

            const homeCoeffs = currentStats.teamCoeffs[home];
            const awayCoeffs = currentStats.teamCoeffs[away];
            
            const sampleH = homeCoeffs.playedH; 
            const sampleA = awayCoeffs.playedA; 

            // Datos de Goles Esperados (solo como referencia)
            const globalAvgH = currentStats.globalAverages.avgGoalsHome;
            const globalAvgA = currentStats.globalAverages.avgGoalsAway;
            
            const teamGoalData = {
                home_att: homeCoeffs.attH.toFixed(2), 
                home_def: homeCoeffs.defH.toFixed(2), 
                away_att: awayCoeffs.attA.toFixed(2), 
                away_def: awayCoeffs.defA.toFixed(2), 
            };


            const markets = {
                'H': { p: res.pHome, odds: lastMatch ? lastMatch.oddsH : null, label: 'Local (1)' },
                'D': { p: res.pDraw, odds: lastMatch ? lastMatch.oddsD : null, label: 'Empate (X)' },
                'A': { p: res.pAway, odds: lastMatch ? lastMatch.oddsA : null, label: 'Visita (2)' },
                'O25': { p: res.pOver25, odds: lastMatch ? lastMatch.oddsO25 : null, label: 'O2.5' },
                'U25': { p: res.pUnder25, odds: lastMatch ? lastMatch.oddsU25 : null, label: 'U2.5' }
            };

            let marketHTML = '';
            for (const key in markets) {
                const mkt = markets[key];
                const oddsFrequency = (mkt.p > 0 ? (1 / mkt.p) : 0);
                const oddsReal = mkt.odds;
                
                let isValue = false;
                if (oddsReal && oddsFrequency > 0 && oddsReal > oddsFrequency) {
                    isValue = true;
                }
                
                const style = key === selectedMkt ? 'border: 2px solid var(--success);' : '';
                const valueIndicator = isValue ? '<i class="fas fa-arrow-up text-green"></i>' : '';
                
                marketHTML += `
                    <div class="stats-odds-item" style="${style}">
                        <div class="kpi-title" style="color:var(--stats-accent);">${mkt.label}</div>
                        <div class="kpi-value" style="font-size:1rem; color:white;">P: ${(mkt.p * 100).toFixed(1)}%</div>
                        <div class="kpi-title" style="margin-top:3px; font-weight:bold;">Odds F: ${oddsFrequency > 0 ? oddsFrequency.toFixed(2) : 'N/A'}</div>
                        <div class="kpi-title">Odds R: ${oddsReal ? oddsReal.toFixed(2) : 'N/A'} ${valueIndicator}</div>
                    </div>
                `;
            }

            // --- Generaci√≥n de Matriz de Rendimiento de Equipos ---
            let matrixHTML = `
                <div class="score-matrix">
                    <h4 style="margin:0 0 5px 0; color:white; font-size:0.85rem;">M√©tricas de Rendimiento (Temp. Actual)</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>M√©trica</th>
                                <th>${home} (Local)</th>
                                <th>${away} (Visita)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align:left; font-weight:bold;">Goles Esperados (Lambda)</td>
                                <td>${res.lambda_H.toFixed(2)}</td>
                                <td>${res.lambda_A.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="text-align:left; font-weight:bold;">Factor Ataque/Defensa (Home)</td>
                                <td>${homeCoeffs.attH.toFixed(2)} / ${homeCoeffs.defH.toFixed(2)}</td>
                                <td>${awayCoeffs.attH.toFixed(2) || 'N/A'} / ${awayCoeffs.defH.toFixed(2) || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="text-align:left; font-weight:bold;">Factor Ataque/Defensa (Away)</td>
                                <td>${homeCoeffs.attA.toFixed(2) || 'N/A'} / ${homeCoeffs.defA.toFixed(2) || 'N/A'}</td>
                                <td>${awayCoeffs.attA.toFixed(2)} / ${awayCoeffs.defA.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="font-size:0.75rem; color:var(--text-secondary); margin-top:10px;">*Probabilidades (P) basadas en la frecuencia global de la liga en la temporada actual. Lambda se usa para referencia.</p>
                </div>
            `;
            // --- Fin de Matriz ---


            card.innerHTML = `
                <h3 style="margin-top:0; color:white; border-bottom:1px solid var(--stats-accent); padding-bottom:5px; font-size:0.9rem; text-transform:none;">üìä Estad√≠sticas de Frecuencia: ${home} vs ${away}</h3>
                
                <div style="display:flex; justify-content:space-around; text-align:center; padding:5px 0;">
                    <div style="font-size:0.8rem;">
                        <span class="text-blue" style="font-weight:600;">Goles Global (L):</span> <b>${globalAvgH.toFixed(2)}</b>
                    </div>
                    <div style="font-size:0.8rem;">
                        <span class="text-blue" style="font-weight:600;">Goles Global (V):</span> <b>${globalAvgA.toFixed(2)}</b>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-around; text-align:center; padding:5px 0; border-bottom:1px solid var(--stats-dark);">
                    <div style="font-size:0.75rem;">
                        <span class="text-secondary" style="font-weight:600;"><i class="fas fa-home"></i> Muestra ${home}:</span> <b>${sampleH} Loc.</b>
                    </div>
                    <div style="font-size:0.75rem;">
                        <span class="text-secondary" style="font-weight:600;"><i class="fas fa-plane-departure"></i> Muestra ${away}:</span> <b>${sampleA} Vis.</b>
                    </div>
                </div>

                <div class="stats-grid-wrapper">
                    <div class="stats-odds-grid">
                        ${marketHTML}
                    </div>
                    ${matrixHTML}
                </div>
            `;
        }


        // --- FUNCI√ìN PRINCIPAL DE BACKTESTING ---
        function runBacktest() {
            if(!rawData.length || !currentStats) {
                document.getElementById('statsCard').style.display = 'block';
                document.getElementById('statsCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">Cargue datos primero (URL o Archivos) para iniciar el backtest.</h3>`;
                return;
            }

            const mkt = document.getElementById('marketSelect').value;
            const useFrequency = document.getElementById('useFrequencyValue').checked; 
            const stT = document.getElementById('stakeType').value;
            const stV = parseFloat(document.getElementById('stakeValue').value);
            const bank0 = parseFloat(document.getElementById('initialBank').value);
            const minO = parseFloat(document.getElementById('minOdds').value);
            const maxO = parseFloat(document.getElementById('maxOdds').value);
            const minG = parseFloat(document.getElementById('minGoals').value);
            const maxG = parseFloat(document.getElementById('maxGoals').value);
            const lg = document.getElementById('leagueSelect').value;

            let bank=bank0, peak=bank0, maxDD=0, wins=0, hist=[{x:'Inicio', y:bank0}], rows=[], lgP={};
            let tmPRanking = {}; 
            let optimizableBetsCombined = [];
            let totalProfitUnits = 0;
            totalStakeUnits = 0; 
            let totalBets = 0;

            const filtered = rawData.filter(r => lg==='all' || r.league===lg);

            filtered.forEach(r => {
                // C√°lculo de Profit/Stake (Kelly/Valor)
                const res = calculateProfit(r, mkt, stT, stV, bank, minO, maxO, minG, maxG, useFrequency);
                
                // Generaci√≥n de lista de apuestas optimizables (para el rango √≥ptimo)
                const resOptimizable = calculateProfit(r, mkt, 'flat', 1.0, 1.0, 1.0, 50.0, 0, 10, false); 
                if(resOptimizable) {
                    const optBet = { odds: resOptimizable.odds, pnl: resOptimizable.pnl, year: r.date.substring(0, 4) };
                    optimizableBetsCombined.push(optBet);
                }

                if(res) {
                    bank += res.pnl;
                    totalProfitUnits += res.pnl;
                    totalStakeUnits += res.stake;
                    totalBets++;
                    
                    if(res.won) wins++;
                    if(bank>peak) peak=bank;
                    let dd = (peak-bank)/peak*100; if(dd>maxDD) maxDD=dd;

                    hist.push({x:r.date, y:bank});
                    rows.push({date:r.date, match:`${r.home} v ${r.away}`, sel:mkt, odds:res.odds, stake:res.stake, res:`${r.goalsH}-${r.goalsA}`, pnl:res.pnl, bank:bank});

                    // Acumulaci√≥n de Profit/Loss por Liga
                    if(!lgP[r.league]) lgP[r.league]=0; lgP[r.league]+=res.pnl;
                    
                    // --- Acumulaci√≥n de Profit/Loss por Equipo (Ranking Mejorado) ---
                    const updateTeamRanking = (team, pnl, type) => {
                        if (!tmPRanking[team]) {
                            tmPRanking[team] = { overall: 0, home: 0, away: 0 };
                        }
                        tmPRanking[team].overall += pnl;
                        if (type === 'home') {
                            tmPRanking[team].home += pnl;
                        } else if (type === 'away') {
                            tmPRanking[team].away += pnl;
                        }
                    };

                    updateTeamRanking(r.home, res.pnl, 'home'); 
                    updateTeamRanking(r.away, res.pnl, 'away'); 
                    // --- Fin Acumulaci√≥n de Profit/Loss por Equipo ---
                }
            });

            globalWinRate = totalBets > 0 ? wins / totalBets : 0;

            const currentData = optimizableBetsCombined.filter(b => seasonYears.current && b.year == seasonYears.current);
            const previousData = optimizableBetsCombined.filter(b => seasonYears.previous && b.year == seasonYears.previous);

            const optimalRangeCombined = findOptimalOddsRange(optimizableBetsCombined);

            const compatibility = checkCompatibility(optimalRangeCombined, currentData, previousData); 
            
            updateOptimalOddsUI(optimalRangeCombined, compatibility); 
            
            const RoR = calculateRiskOfRuina(totalBets, totalStakeUnits, globalWinRate);

            updateGlobalUI(hist, rows, wins, bank0, bank, maxDD, lgP, tmPRanking, totalStakeUnits, RoR);
            
            document.getElementById('statsCard').style.display = 'none';
            document.getElementById('oddsProjectionCard').style.display = 'none';
        }


        // --- FUNCIONES DE OPTIMIZACI√ìN y UI ---
        function findOptimalOddsRange(optimizableBets) {
            const minBetsRequired = 50; 
            if (optimizableBets.length < minBetsRequired) return { min: 'N/A', max: 'N/A', yield: 0, bets: 0 }; 

            let bestYield = -100;
            let bestMin = 0, bestMax = 0;
            let bestBets = 0;
            
            const maxOddsLimit = 15.00; 

            const uniqueOdds = [...new Set(optimizableBets.map(b => b.odds))].sort((a, b) => a - b);
            
            const effectiveOddsToTest = uniqueOdds.filter(o => o <= maxOddsLimit);

            for (let i = 0; i < effectiveOddsToTest.length; i++) {
                let min_o = effectiveOddsToTest[i];
                
                for (let j = i; j < effectiveOddsToTest.length; j++) {
                    let max_o = effectiveOddsToTest[j];
                    
                    min_o = parseFloat(min_o.toFixed(2));
                    max_o = parseFloat(max_o.toFixed(2));

                    let totalProfit = 0;
                    let totalBets = 0;

                    for (const bet of optimizableBets) {
                        if (bet.odds >= min_o && bet.odds <= max_o) {
                            totalProfit += bet.pnl;
                            totalBets++;
                        }
                    }

                    if (totalBets >= minBetsRequired) { 
                        const currentYield = (totalProfit / totalBets) * 100; 
                        
                        if (currentYield > bestYield || (currentYield.toFixed(2) === bestYield.toFixed(2) && totalBets > bestBets)) {
                            bestYield = currentYield;
                            bestMin = min_o;
                            bestMax = max_o;
                            bestBets = totalBets;
                        }
                    }
                }
            }
            
            if (bestBets === 0 || bestYield <= 0) {
                 return { min: 'N/A', max: 'N/A', yield: 0, bets: 0 };
            }

            return { 
                min: bestMin.toFixed(2), 
                max: bestMax.toFixed(2), 
                yield: bestYield.toFixed(2), 
                bets: bestBets 
            };
        }
        
        function checkCompatibility(optimalRange, currentData, previousData) {
            const min = parseFloat(optimalRange.min);
            const max = parseFloat(optimalRange.max); 
            const STAKE_UNIT = 1.0; 
            
            if (min === 0 || max === 0 || optimalRange.min === 'N/A') return { current: 'N/A', previous: 'N/A', currentBets: 0, previousBets: 0, totalCurrentBets: currentData.length, totalPreviousBets: previousData.length, status: 'NO HAY MUESTRA' };

            let currentPnl = 0, currentBets = 0, totalCurrentBets = currentData.length;
            currentData.forEach(bet => {
                if (bet.odds >= min && bet.odds <= max) {
                    currentPnl += bet.pnl;
                    currentBets++;
                }
            });
            const currentYield = currentBets > 0 ? (currentPnl / currentBets) * 100 / STAKE_UNIT : 0; 

            let previousPnl = 0, previousBets = 0, totalPreviousBets = previousData.length;
            previousData.forEach(bet => {
                if (bet.odds >= min && bet.odds <= max) {
                    previousPnl += bet.pnl;
                    previousBets++;
                }
            });
            const previousYield = previousBets > 0 ? (previousPnl / previousBets) * 100 / STAKE_UNIT : 0; 

            const isCompatible = (currentYield > 1.0 && previousYield > 1.0); 

            let status = 'BAJA COMPATIBILIDAD';
            if (currentBets < 5 && previousBets < 5) { 
                status = 'MUESTRA INSUFICIENTE';
            } else if (isCompatible) {
                 status = 'ALTA COMPATIBILIDAD';
            } else if (currentBets < 5 || previousBets < 5) { 
                 status = 'COMPATIBILIDAD INCOMPLETA';
            }


            return { 
                current: currentYield.toFixed(1) + '%', 
                previous: previousYield.toFixed(1) + '%', 
                currentBets: currentBets,
                previousBets: previousBets,
                totalCurrentBets: totalCurrentBets,
                totalPreviousBets: totalPreviousBets,
                status: status
            };
        }

        function updateOptimalOddsUI(optimalRange, compatibility) {
            document.getElementById('valOptimalOddsRange').innerText = optimalRange.min + ' - ' + optimalRange.max;
            document.getElementById('valOptimalOddsYield').innerText = optimalRange.yield + '%';
            document.getElementById('valOptimalOddsBets').innerText = optimalRange.bets;

            document.getElementById('compStatus').innerText = compatibility.status;
            
            let compColor = 'var(--warning)';
            if (compatibility.status === 'ALTA COMPATIBILIDAD') compColor = 'var(--success)';
            else if (compatibility.status === 'BAJA COMPATIBILIDAD') compColor = 'var(--danger)';
            document.getElementById('compStatus').style.backgroundColor = compColor;
            
            document.getElementById('currentYear').innerText = seasonYears.current || 'N/A';
            document.getElementById('previousYear').innerText = seasonYears.previous || 'N/A';

            document.getElementById('currentYield').innerText = compatibility.current;
            document.getElementById('previousYield').innerText = compatibility.previous;
            
            const isCurrentYieldNegative = compatibility.current.includes('-') || compatibility.current === 'N/A';
            document.getElementById('currentYield').className = "kpi-value " + (isCurrentYieldNegative ? 'text-red' : 'text-green');
            
            const isPreviousYieldNegative = compatibility.previous.includes('-') || compatibility.previous === 'N/A';
            document.getElementById('previousYield').className = "kpi-value " + (isPreviousYieldNegative ? 'text-red' : 'text-green');


            document.getElementById('currentSample').innerText = `(Muestra: ${compatibility.currentBets}/${compatibility.totalCurrentBets})`;
            document.getElementById('previousSample').innerText = `(Muestra: ${compatibility.previousBets}/${compatibility.totalPreviousBets})`;
        }


        // --- UI UPDATES (Global and Charts) ---
        function updateGlobalUI(hist, rows, wins, start, end, dd, lgData, tmPRanking, totalStakeUnits, RoR) {
            const tot = rows.length;
            const prof = end-start;
            const yieldVal = totalStakeUnits>0?((prof/totalStakeUnits)*100).toFixed(1):'0';
            const winRatePercent = tot?((wins/tot)*100).toFixed(1):'0';
            
            document.getElementById('valBets').innerText = tot;
            document.getElementById('valWinRate').innerText = winRatePercent + '%';
            document.getElementById('valProfit').innerText = prof.toFixed(2);
            document.getElementById('valYield').innerText = yieldVal + '%';
            document.getElementById('valDrawdown').innerText = '-'+dd.toFixed(2)+'%';
            document.getElementById('valRoR').innerText = RoR.toFixed(1) + '%';


            document.getElementById('valProfit').className = `kpi-value ${prof>=0?'text-green':'text-red'}`;
            document.getElementById('valRoR').className = `kpi-value ${RoR<=10?'text-blue':'text-red'}`;

            // Tabla Principal
            const tb = document.getElementById('tableBody'); tb.innerHTML='';
            rows.slice(-50).reverse().forEach(r => {
                tb.innerHTML += `<tr><td>${r.date.substring(5)}</td><td>${r.match}</td><td>${r.sel}</td><td>${r.odds.toFixed(2)}</td><td>${r.stake.toFixed(2)}</td><td>${r.res}</td><td class="${r.pnl>=0?'text-green':'text-red'}">${r.pnl.toFixed(2)}</td><td>${r.bank.toFixed(0)}</td></tr>`;
            });

            // --- Tabla Equipos (Ranking Mejorado) ---
            const tbTeam = document.getElementById('teamTableBody'); tbTeam.innerHTML='';
            const teamRankArray = Object.entries(tmPRanking)
                .map(([team, stats]) => ({ team, ...stats }))
                .sort((a, b) => b.overall - a.overall);

            teamRankArray.slice(0,20).forEach(t => {
                const formatPnl = (pnl) => {
                    return `<span class="${pnl>=0?'text-green':'text-red'}">${pnl.toFixed(2)}</span>`;
                };

                tbTeam.innerHTML += `
                    <tr>
                        <td style="font-weight:bold;">${t.team}</td>
                        <td>${formatPnl(t.overall)}</td>
                        <td>${formatPnl(t.home)}</td>
                        <td>${formatPnl(t.away)}</td>
                    </tr>
                `;
            });

            renderCharts(hist, lgData);
        }

        function renderCharts(hist, lgData) {
            const ctxEq = document.getElementById('equityChart').getContext('2d');
            if(chartEq) chartEq.destroy();
            const pts = hist.length>800 ? hist.filter((_,i)=>i%5===0) : hist;
            chartEq = new Chart(ctxEq, { type:'line', data:{labels:pts.map(p=>p.x), datasets:[{label:'Banca', data:pts.map(p=>p.y), borderColor:'#3b82f6', borderWidth:2, pointRadius:0, fill:true, backgroundColor:'rgba(59,130,246,0.1)'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, title:{display:true, text:'Evoluci√≥n de Banca', color:'white', font:{size:14, weight:'600'}}}, scales:{x:{display:false},y:{grid:{color:'#334155'}, ticks:{color:'white'}}}}});

            const ctxLg = document.getElementById('leagueChart').getContext('2d');
            if(chartLg) chartLg.destroy();
            const lgArr = Object.entries(lgData).sort((a,b)=>b[1]-a[1]);
            chartLg = new Chart(ctxLg, { type:'bar', data:{labels:lgArr.map(x=>x[0]), datasets:[{data:lgArr.map(x=>x[1]), backgroundColor:lgArr.map(x=>x[1]>=0?'#10b981':'#ef4444')}]}, options:{responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#334155'}, ticks:{color:'white'}}, y:{ticks:{color:'white'}}}}});
        }


        // --- FUNCIONES DE PROYECCI√ìN DE CUOTA (MEJORADA) ---

        function analyzeOddsProjection() {
            if (!rawData.length) {
                document.getElementById('oddsProjectionCard').style.display = 'block';
                document.getElementById('oddsProjectionCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">Cargue datos primero.</h3>`;
                return;
            }

            const targetOdds = parseFloat(document.getElementById('targetOddsInput').value);
            const mkt = document.getElementById('marketSelect').value;
            
            if (isNaN(targetOdds) || targetOdds <= 1.01) {
                alert("Por favor, ingrese una Cuota Objetivo v√°lida (mayor a 1.01).");
                return;
            }

            const MARGIN = 0.05;
            const minOdds = targetOdds - MARGIN;
            const maxOdds = targetOdds + MARGIN;

            let totalBets = 0;
            let totalWins = 0;
            let totalProfit = 0;
            let totalStake = 0;

            const STAKE_UNIT = 1.0; 

            rawData.forEach(r => {
                const o = getMarketOdds(r, mkt);
                if (!o || o < 1.01) return; 

                if (o >= minOdds && o <= maxOdds) {
                    totalBets++;
                    totalStake += STAKE_UNIT;
                    
                    const w = isWinningBet(r, mkt);
                    if (w) {
                        totalWins++;
                        totalProfit += (o - STAKE_UNIT);
                    } else {
                        totalProfit -= STAKE_UNIT;
                    }
                }
            });

            const card = document.getElementById('oddsProjectionCard');
            card.style.display = 'block';
            document.getElementById('statsCard').style.display = 'none';

            const winRate = totalBets > 0 ? (totalWins / totalBets) : 0;
            const historicalYield = totalStake > 0 ? (totalProfit / totalStake) * 100 : 0;
            
            const breakEvenRate = (1 / targetOdds);
            
            const expectedValue = (winRate * (targetOdds - 1)) - ((1 - winRate) * 1);
            
            
            let warningHTML = '';
            if (totalBets < 30) {
                warningHTML = `<p style="color:var(--warning); font-size:0.8rem; margin:10px 0 0 0;"><i class="fas fa-exclamation-triangle"></i> **ADVERTENCIA:** La muestra hist√≥rica es **peque√±a** (${totalBets} apuestas). Los resultados tienen baja fiabilidad.</p>`;
            } else if (totalBets < 100) {
                warningHTML = `<p style="color:var(--text-secondary); font-size:0.8rem; margin:10px 0 0 0;"><i class="fas fa-info-circle"></i> La muestra hist√≥rica (${totalBets}) es aceptable, pero m√°s datos mejorar√°n la precisi√≥n.</p>`;
            } else {
                warningHTML = `<p style="color:var(--success); font-size:0.8rem; margin:10px 0 0 0;"><i class="fas fa-check-circle"></i> Muestra hist√≥rica robusta (${totalBets} apuestas).</p>`;
            }
            
            card.innerHTML = `
                <h4 style="margin-top:0; color:white; border-bottom:1px solid var(--accent); padding-bottom:5px; font-size:0.85rem;">Resultados Hist√≥ricos para Cuota ‚âà **${targetOdds.toFixed(2)}**</h4>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; font-size:0.8rem; text-align:center;">
                    <div>
                        <div class="kpi-title">Muestra (Bets)</div>
                        <div class="kpi-value" style="font-size:1.1rem;">${totalBets}</div>
                    </div>
                    <div>
                        <div class="kpi-title">Win Rate Necesario (BE)</div>
                        <div class="kpi-value text-red" style="font-size:1.1rem;">${(breakEvenRate * 100).toFixed(1)}%</div>
                    </div>
                    <div>
                        <div class="kpi-title">Win Rate Hist√≥rico</div>
                        <div class="kpi-value ${winRate >= breakEvenRate ? 'text-green' : 'text-red'}" style="font-size:1.1rem;">${(winRate * 100).toFixed(1)}%</div>
                    </div>
                    <div>
                        <div class="kpi-title">Yield Hist√≥rico</div>
                        <div class="kpi-value ${historicalYield >= 0 ? 'text-green' : 'text-red'}" style="font-size:1.1rem;">${historicalYield.toFixed(1)}%</div>
                    </div>
                    <div>
                        <div class="kpi-title">Valor Esperado (EV)</div>
                        <div class="kpi-value ${expectedValue >= 0 ? 'text-green' : 'text-red'}" style="font-size:1.1rem;">${expectedValue.toFixed(3)}</div>
                    </div>
                </div>
                ${warningHTML}
            `;

            displaySeasonYieldsForRange(minOdds, maxOdds, card);
        }

        function displaySeasonYieldsForRange(minO, maxO, cardElement) {
            let currentPnl = 0, currentBets = 0;
            let previousPnl = 0, previousBets = 0;
            const STAKE_UNIT = 1.0; 
            const mkt = document.getElementById('marketSelect').value;

            rawData.forEach(r => {
                const o = getMarketOdds(r, mkt);
                if (o >= minO && o <= maxO) {
                    const w = isWinningBet(r, mkt);
                    const pnl = w ? (o - STAKE_UNIT) : -STAKE_UNIT;
                    
                    const year = r.date.substring(0, 4);

                    if (year == seasonYears.current) {
                        currentPnl += pnl;
                        currentBets++;
                    } else if (year == seasonYears.previous) {
                        previousPnl += pnl;
                        previousBets++;
                    }
                }
            });

            const currentYield = currentBets > 0 ? (currentPnl / currentBets) * 100 : 0;
            const previousYield = previousBets > 0 ? (previousPnl / previousBets) * 100 : 0;

            const detailsHTML = `
                <h5 style="margin:10px 0 5px 0; color:var(--text-secondary); font-size:0.75rem;">Rendimiento por Temporada (Rango ${minO.toFixed(2)}-${maxO.toFixed(2)})</h5>
                <div style="display:flex; justify-content:space-around; text-align:center; font-size:0.75rem;">
                    <div>
                        <span style="font-weight:bold;">${seasonYears.current || 'Actual'}</span>: 
                        <span class="${currentYield >= 0 ? 'text-green' : 'text-red'}">${currentYield.toFixed(1)}%</span> (${currentBets} B)
                    </div>
                    <div>
                        <span style="font-weight:bold;">${seasonYears.previous || 'Anterior'}</span>: 
                        <span class="${previousYield >= 0 ? 'text-green' : 'text-red'}">${previousYield.toFixed(1)}%</span> (${previousBets} B)
                    </div>
                </div>
            `;
            
            let existingDetails = cardElement.querySelector('h5:last-of-type');
            if (existingDetails && existingDetails.textContent.includes('Rendimiento por Temporada')) {
                existingDetails.nextElementSibling.remove();
                existingDetails.remove();
                existingDetails = null;
            }
            
            cardElement.insertAdjacentHTML('beforeend', detailsHTML);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Poisson FT/HT + Córners + Tarjetas + BTTS + Disparos</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{ --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
         --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --border:#2a3140; }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
  header{padding:18px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#121520,#0f1115)}
  h1{margin:0; font-size:30px}
  .wrap{max-width:1220px; margin:20px auto; padding:0 16px}
  .grid{display:grid; gap:14px}
  @media(min-width:1180px){ .grid{grid-template-columns: 1.2fr 1fr} }
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; position:relative}
  .card h2{margin:6px 0 12px; font-size:16px}
  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  select, input[type="number"]{
    width:100%; padding:10px 12px; background:var(--panel2); color:var(--text);
    border:1px solid var(--border); border-radius:10px; font-size:14px;
  }
  input[type="file"]{width:100%}
  .row{display:grid; gap:10px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }
  .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid var(--border);
    background:linear-gradient(180deg,#1b2130,#171a21); color:var(--text); font-weight:600; cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .accent{background:linear-gradient(180deg,#2a58ff,#264bda); border-color:#2c4fd0}
  .muted{color:var(--muted)}
  .kpis{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
  @media(min-width:960px){ .kpis{grid-template-columns:repeat(4,1fr)} }
  .kpi{background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:12px; position:relative; overflow:hidden}
  .kpi .t{font-size:12px; color:var(--muted)}
  .kpi .v{font-size:20px; font-weight:800; margin-top:4px}
  .kpi .sub{font-size:12px; color:var(--muted); margin-top:2px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:8px 10px; border-bottom:1px solid var(--border)}
  th{text-align:left; color:#c9d3e7; background:#1a1f2a; position:sticky; top:0}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--panel2)}
  .footer{color:var(--muted); font-size:12px; text-align:center; padding:18px}
  .hot{ border-color: rgba(93,212,164,0.9);
    box-shadow: 0 0 0 1px rgba(93,212,164,0.9), 0 0 0 8px rgba(93,212,164,0.12);
    background: radial-gradient(1200px 80px at -10% -10%, rgba(93,212,164,0.08), transparent 60%), var(--panel2);}
  .badge-hot{ position:absolute; top:8px; right:8px; font-size:11px; font-weight:700; letter-spacing:.2px;
    background:linear-gradient(180deg,#54e3b2,#3bc48f); color:#0e1a14; border:0; border-radius:999px; padding:4px 8px; display:none; }
  .kpi.hot .badge-hot{ display:inline-block; }

  /* Ocultar métricas (μ, λ) pero mantener cálculo */
  .metrics{ display:none; }

  /* Indicador para el marcador más probable */
  .best{ border-color: rgba(122,162,255,0.9); box-shadow: 0 0 0 1px rgba(122,162,255,0.9), 0 0 0 8px rgba(122,162,255,0.12); }

  /* ==== Estilos Upset Risk ==== */
  .upset{margin-top:12px; border:1px solid var(--border); border-radius:10px; padding:10px; background:var(--panel2)}
  .upset .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .upset .bar{height:8px; width:100%; border-radius:999px; background:#1a1f2b; overflow:hidden; border:1px solid var(--border); margin-top:8px}
  .upset .fill{height:100%; width:0%; background:linear-gradient(90deg,#79e2a6,#ffb84d,#ff6b6b)}
  .updet{color:var(--muted); font-size:12px; margin-top:6px}
</style>
</head>
<body>
<header><h1>Poisson FT/HT + Córners + Tarjetas + BTTS + Disparos</h1></header>
<div class="wrap grid">
  <div class="card">
    <h2>1) Cargar JSON & elegir</h2>
    <label>JSON (array/objeto/NDJSON) o CSV (encabezados). Reconoce: <code>Match + Result FT</code>, <code>HomeTeam/AwayTeam + FTHG/FTAG</code>, agregados por equipo (<code>Team, GF, GA, Matches</code>) y, si existen, <i>OnGoal/Total Shots</i>, Córners, Amarillas, Rojas.</label>
    <input id="file" type="file" accept=".json,.txt,.ndjson,.csv" />
    <div class="row">
      <div><label> Liga </label><select id="league" disabled></select></div>
      <div><label> Ventaja local FT (HA) </label><input id="ha" type="number" step="0.01" min="0.5" max="1.6" value="1.10" /></div>
    </div>
    <div class="row">
      <div><label> Local </label><select id="home" disabled></select></div>
      <div><label> Visitante </label><select id="away" disabled></select></div>
    </div>
    <div class="row">
      <div><label> Factor HT (goles 1T / partido) </label><input id="htFactor" type="number" step="0.01" min="0.2" max="0.8" value="0.45" /></div>
      <div><label> Ventaja local HT (HA_HT) </label><input id="ha_ht" type="number" step="0.01" min="0.5" max="1.6" value="1.05" /></div>
    </div>
    <div class="row">
      <div><label> HA Córners (solo local) </label><input id="ha_corners" type="number" step="0.01" min="0.8" max="1.4" value="1.05" /></div>
      <div><label> HA Tarjetas (solo local) </label><input id="ha_cards" type="number" step="0.01" min="0.8" max="1.4" value="1.00" /></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
      <button id="calc" class="btn accent" disabled>Calcular</button>
      <button id="ai" class="btn" disabled>IA asistida (refuerzo)</button>
      <span id="status" class="muted" style="margin-left:4px"></span>
    </div>
  </div>

  <!-- Métricas ocultas -->
  <div class="card metrics" id="card_metrics_goals">
    <h2>2) Métricas FT — Goles</h2>
    <div class="kpis">
      <div class="kpi"><div class="t">μ liga (goles/eq/part)</div><div class="v" id="k_mu">—</div></div>
      <div class="kpi"><div class="t">Att Local</div><div class="v" id="k_att_h">—</div></div>
      <div class="kpi"><div class="t">Def Local</div><div class="v" id="k_def_h">—</div></div>
      <div class="kpi"><div class="t">Att Visit</div><div class="v" id="k_att_a">—</div></div>
      <div class="kpi"><div class="t">Def Visit</div><div class="v" id="k_def_a">—</div></div>
      <div class="kpi"><div class="t">λ Local FT</div><div class="v" id="k_lh">—</div></div>
      <div class="kpi"><div class="t">λ Visit FT</div><div class="v" id="k_la">—</div></div>
    </div>
  </div>

  <!-- 1X2 FT -->
  <div class="card" data-group="g_ft_1x2">
    <h2>3) 1X2 — FT</h2>
    <div class="grid3">
      <div class="kpi" data-market="ft_1"><span class="badge-hot">🔥 Más probable</span><div class="t">Home Win (1)</div><div class="v pv" id="ft_1">—</div></div>
      <div class="kpi" data-market="ft_x"><span class="badge-hot">🔥 Más probable</span><div class="t">Draw (X)</div><div class="v pv" id="ft_x">—</div></div>
      <div class="kpi" data-market="ft_2"><span class="badge-hot">🔥 Más probable</span><div class="t">Away Win (2)</div><div class="v pv" id="ft_2">—</div></div>
    </div>

    <!-- Upset Risk 1X2 -->
    <div class="upset" id="up1x2">
      <div class="row">
        <span class="pill" id="fav-1x2">Favorito: —</span>
        <span class="pill" id="riskLabel-1x2">Riesgo: —</span>
        <span class="pill" id="riskPct-1x2">—%</span>
      </div>
      <div class="bar"><div class="fill" id="fill-1x2"></div></div>
      <div class="updet" id="det-1x2">—</div>
    </div>
  </div>

  <!-- Doble Oportunidad -->
  <div class="card" data-group="g_dc">
    <h2>3.1) Doble Oportunidad (FT)</h2>
    <div class="grid3">
      <div class="kpi" data-market="dc_1x"><span class="badge-hot">🔥 Más probable</span><div class="t">1X (Local o Empate)</div><div class="v pv" id="dc_1x">—</div></div>
      <div class="kpi" data-market="dc_12"><span class="badge-hot">🔥 Más probable</span><div class="t">12 (Sin Empate)</div><div class="v pv" id="dc_12">—</div></div>
      <div class="kpi" data-market="dc_x2"><span class="badge-hot">🔥 Más probable</span><div class="t">X2 (Empate o Visit)</div><div class="v pv" id="dc_x2">—</div></div>
    </div>
  </div>

  <!-- Draw No Bet -->
  <div class="card" data-group="g_dnb">
    <h2>3.2) Draw No Bet (FT)</h2>
    <div class="kpis">
      <div class="kpi" data-market="dnb_h"><span class="badge-hot">🔥 Más probable</span><div class="t">DNB Local (prob. efectiva)</div><div class="v pv" id="dnb_h">—</div><div class="sub">Condicionada a no empate</div></div>
      <div class="kpi" data-market="dnb_a"><span class="badge-hot">🔥 Más probable</span><div class="t">DNB Visit (prob. efectiva)</div><div class="v pv" id="dnb_a">—</div><div class="sub">Condicionada a no empate</div></div>
    </div>
  </div>

  <!-- O/U FT -->
  <div class="card" data-group="g_ft_ou25">
    <h2>4) FT — Over/Under 2.5</h2>
    <div class="kpis">
      <div class="kpi" data-market="o25"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 2.5</div><div class="v pv" id="m_o25">—</div></div>
      <div class="kpi" data-market="u25"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 2.5</div><div class="v pv" id="m_u25">—</div></div>
    </div>

    <!-- Upset Risk OU (FT 2.5) -->
    <div class="upset" id="upou">
      <div class="row">
        <span class="pill" id="fav-ou">Favorito: —</span>
        <span class="pill" id="riskLabel-ou">Riesgo: —</span>
        <span class="pill" id="riskPct-ou">—%</span>
      </div>
      <div class="bar"><div class="fill" id="fill-ou"></div></div>
      <div class="updet" id="det-ou">—</div>
    </div>
  </div>

  <!-- BTTS FT + Prob. de anotar -->
  <div class="card" data-group="g_ft_btts">
    <h2>4.1) BTTS (FT)</h2>
    <div class="kpis">
      <div class="kpi" data-market="btts_yes"><span class="badge-hot">🔥 Más probable</span><div class="t">BTTS: Sí</div><div class="v pv" id="m_btts_yes">—</div></div>
      <div class="kpi" data-market="btts_no"><span class="badge-hot">🔥 Más probable</span><div class="t">BTTS: No</div><div class="v pv" id="m_btts_no">—</div></div>
    </div>
    <div class="kpis" style="margin-top:10px" data-group="g_ft_scores_any">
      <div class="kpi" data-market="home_scores_any"><div class="t">Prob. que anote el Local (≥1 gol)</div><div class="v pv" id="m_home_scores">—</div></div>
      <div class="kpi" data-market="away_scores_any"><div class="t">Prob. que anote el Visitante (≥1 gol)</div><div class="v pv" id="m_away_scores">—</div></div>
    </div>

    <!-- Upset Risk BTTS -->
    <div class="upset" id="upbtts">
      <div class="row">
        <span class="pill" id="fav-btts">Favorito: —</span>
        <span class="pill" id="riskLabel-btts">Riesgo: —</span>
        <span class="pill" id="riskPct-btts">—%</span>
      </div>
      <div class="bar"><div class="fill" id="fill-btts"></div></div>
      <div class="updet" id="det-btts">—</div>
    </div>
  </div>

  <!-- 1X2 HT -->
  <div class="card" data-group="g_ht_1x2">
    <h2>5) 1X2 — HT</h2>
    <div class="grid3">
      <div class="kpi" data-market="ht_1"><span class="badge-hot">🔥 Más probable</span><div class="t">HT Home (1)</div><div class="v pv" id="ht_1">—</div></div>
      <div class="kpi" data-market="ht_x"><span class="badge-hot">🔥 Más probable</span><div class="t">HT Draw (X)</div><div class="v pv" id="ht_x">—</div></div>
      <div class="kpi" data-market="ht_2"><span class="badge-hot">🔥 Más probable</span><div class="t">HT Away (2)</div><div class="v pv" id="ht_2">—</div></div>
    </div>
  </div>

  <!-- O/U HT -->
  <div class="card">
    <h2>6) HT — Over/Under</h2>
    <div class="kpis" data-group="g_ht_ou05">
      <div class="kpi" data-market="ht_o05"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 0.5 HT</div><div class="v pv" id="ht_o05">—</div></div>
      <div class="kpi" data-market="ht_u05"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 0.5 HT</div><div class="v pv" id="ht_u05">—</div></div>
    </div>

    <!-- Upset Risk HT O/U 0.5 -->
    <div class="upset" id="upht05">
      <div class="row">
        <span class="pill" id="fav-ht05">Favorito: —</span>
        <span class="pill" id="riskLabel-ht05">Riesgo: —</span>
        <span class="pill" id="riskPct-ht05">—%</span>
      </div>
      <div class="bar"><div class="fill" id="fill-ht05"></div></div>
      <div class="updet" id="det-ht05">—</div>
    </div>

    <div class="kpis" data-group="g_ht_ou15" style="margin-top:10px">
      <div class="kpi" data-market="ht_o15"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 1.5 HT</div><div class="v pv" id="ht_o15">—</div></div>
      <div class="kpi" data-market="ht_u15"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 1.5 HT</div><div class="v pv" id="ht_u15">—</div></div>
    </div>

    <!-- Upset Risk HT O/U 1.5 -->
    <div class="upset" id="upht15">
      <div class="row">
        <span class="pill" id="fav-ht15">Favorito: —</span>
        <span class="pill" id="riskLabel-ht15">Riesgo: —</span>
        <span class="pill" id="riskPct-ht15">—%</span>
      </div>
      <div class="bar"><div class="fill" id="fill-ht15"></div></div>
      <div class="updet" id="det-ht15">—</div>
    </div>
  </div>

  <!-- CÓRNERS -->
  <div class="card">
    <h2>7) Córners (FT) — con destacados</h2>
    <div class="kpis metrics" id="metrics_corners">
      <div class="kpi"><div class="t">μ liga (córners/eq/part)</div><div class="v" id="c_mu">—</div></div>
      <div class="kpi"><div class="t">λ Local</div><div class="v" id="c_lh">—</div></div>
      <div class="kpi"><div class="t">λ Visit</div><div class="v" id="c_la">—</div></div>
      <div class="kpi"><div class="t">λ Total</div><div class="v" id="c_tot">—</div></div>
    </div>
    <div class="kpis" data-group="g_c_85" style="margin-top:10px">
      <div class="kpi" data-market="c_o85"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 8.5</div><div class="v pv" id="c_o85">—</div></div>
      <div class="kpi" data-market="c_u85"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 8.5</div><div class="v pv" id="c_u85">—</div></div>
    </div>
    <div class="kpis" data-group="g_c_95" style="margin-top:10px">
      <div class="kpi" data-market="c_o95"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 9.5</div><div class="v pv" id="c_o95">—</div></div>
      <div class="kpi" data-market="c_u95"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 9.5</div><div class="v pv" id="c_u95">—</div></div>
    </div>
    <div class="kpis" data-group="g_c_105" style="margin-top:10px">
      <div class="kpi" data-market="c_o105"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 10.5</div><div class="v pv" id="c_o105">—</div></div>
      <div class="kpi" data-market="c_u105"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 10.5</div><div class="v pv" id="c_u105">—</div></div>
    </div>
  </div>

  <!-- TARJETAS -->
  <div class="card">
    <h2>8) Tarjetas (FT) — con destacados</h2>
    <div class="kpis metrics" id="metrics_cards">
      <div class="kpi"><div class="t">μ liga (amarillas/eq/part)</div><div class="v" id="y_mu">—</div></div>
      <div class="kpi"><div class="t">λ Amarillas L</div><div class="v" id="y_lh">—</div></div>
      <div class="kpi"><div class="t">λ Amarillas V</div><div class="v" id="y_la">—</div></div>
      <div class="kpi"><div class="t">λ Amarillas Tot</div><div class="v" id="y_tot">—</div></div>
      <div class="kpi"><div class="t">μ liga (rojas/eq/part)</div><div class="v" id="r_mu">—</div></div>
      <div class="kpi"><div class="t">λ Rojas L</div><div class="v" id="r_lh">—</div></div>
      <div class="kpi"><div class="t">λ Rojas V</div><div class="v" id="r_la">—</div></div>
      <div class="kpi"><div class="t">λ Rojas Tot</div><div class="v" id="r_tot">—</div></div>
    </div>
    <div class="kpis" data-group="g_y_35" style="margin-top:10px">
      <div class="kpi" data-market="y_o35"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 3.5 Am.</div><div class="v pv" id="y_o35">—</div></div>
      <div class="kpi" data-market="y_u35"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 3.5 Am.</div><div class="v pv" id="y_u35">—</div></div>
    </div>
    <div class="kpis" data-group="g_y_45" style="margin-top:10px">
      <div class="kpi" data-market="y_o45"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 4.5 Am.</div><div class="v pv" id="y_o45">—</div></div>
      <div class="kpi" data-market="y_u45"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 4.5 Am.</div><div class="v pv" id="y_u45">—</div></div>
    </div>
    <div class="kpis" data-group="g_r_05" style="margin-top:10px">
      <div class="kpi" data-market="r_o05"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 0.5 Rojas</div><div class="v pv" id="r_o05">—</div></div>
      <div class="kpi" data-market="r_u05"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 0.5 Rojas</div><div class="v pv" id="r_u05">—</div></div>
    </div>
    <div class="kpis" data-group="g_r_15" style="margin-top:10px">
      <div class="kpi" data-market="r_o15"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 1.5 Rojas</div><div class="v pv" id="r_o15">—</div></div>
      <div class="kpi" data-market="r_u15"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 1.5 Rojas</div><div class="v pv" id="r_u15">—</div></div>
    </div>
    <div class="kpis" style="margin-top:10px">
      <div class="kpi"><div class="t">¿Habrá roja? (Sí)</div><div class="v" id="r_any">—</div></div>
    </div>
  </div>

  <!-- DISPAROS A PUERTA -->
  <div class="card">
    <h2>9) Disparos a puerta (SoT) — FT</h2>
    <div class="kpis metrics" id="metrics_sot">
      <div class="kpi"><div class="t">μ liga (SoT/eq/part)</div><div class="v" id="sot_mu">—</div></div>
      <div class="kpi"><div class="t">λ SoT Local</div><div class="v" id="sot_lh">—</div></div>
      <div class="kpi"><div class="t">λ SoT Visit</div><div class="v" id="sot_la">—</div></div>
      <div class="kpi"><div class="t">λ SoT Total</div><div class="v" id="sot_tot">—</div></div>
    </div>
    <div class="kpis" data-group="g_sot_75" style="margin-top:10px">
      <div class="kpi" data-market="sot_o75"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 7.5</div><div class="v pv" id="sot_o75">—</div></div>
      <div class="kpi" data-market="sot_u75"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 7.5</div><div class="v pv" id="sot_u75">—</div></div>
    </div>
    <div class="kpis" data-group="g_sot_85" style="margin-top:10px">
      <div class="kpi" data-market="sot_o85"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 8.5</div><div class="v pv" id="sot_o85">—</div></div>
      <div class="kpi" data-market="sot_u85"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 8.5</div><div class="v pv" id="sot_u85">—</div></div>
    </div>
    <div class="kpis" data-group="g_sot_95" style="margin-top:10px">
      <div class="kpi" data-market="sot_o95"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 9.5</div><div class="v pv" id="sot_o95">—</div></div>
      <div class="kpi" data-market="sot_u95"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 9.5</div><div class="v pv" id="sot_u95">—</div></div>
    </div>
  </div>

  <!-- DISPAROS TOTALES -->
  <div class="card">
    <h2>10) Disparos totales — FT</h2>
    <div class="kpis metrics" id="metrics_shots">
      <div class="kpi"><div class="t">μ liga (Shots/eq/part)</div><div class="v" id="sh_mu">—</div></div>
      <div class="kpi"><div class="t">λ Shots Local</div><div class="v" id="sh_lh">—</div></div>
      <div class="kpi"><div class="t">λ Shots Visit</div><div class="v" id="sh_la">—</div></div>
      <div class="kpi"><div class="t">λ Shots Total</div><div class="v" id="sh_tot">—</div></div>
    </div>
    <div class="kpis" data-group="g_sh_205" style="margin-top:10px">
      <div class="kpi" data-market="sh_o205"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 20.5</div><div class="v pv" id="sh_o205">—</div></div>
      <div class="kpi" data-market="sh_u205"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 20.5</div><div class="v pv" id="sh_u205">—</div></div>
    </div>
    <div class="kpis" data-group="g_sh_225" style="margin-top:10px">
      <div class="kpi" data-market="sh_o225"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 22.5</div><div class="v pv" id="sh_o225">—</div></div>
      <div class="kpi" data-market="sh_u225"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 22.5</div><div class="v pv" id="sh_u225">—</div></div>
    </div>
    <div class="kpis" data-group="g_sh_245" style="margin-top:10px">
      <div class="kpi" data-market="sh_o245"><span class="badge-hot">🔥 Más probable</span><div class="t">Over 24.5</div><div class="v pv" id="sh_o245">—</div></div>
      <div class="kpi" data-market="sh_u245"><span class="badge-hot">🔥 Más probable</span><div class="t">Under 24.5</div><div class="v pv" id="sh_u245">—</div></div>
    </div>
  </div>

  <div class="card">
    <h2>11) Marcadores FT (0–10)</h2>
    <div style="overflow:auto; max-height:280px">
      <table id="scoretab_ft"><thead><tr><th>Marcador</th><th>Prob.</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card">
    <h2>12) Marcadores HT (0–5)</h2>
    <div style="overflow:auto; max-height:280px">
      <table id="scoretab_ht"><thead><tr><th>Marcador HT</th><th>Prob.</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<div class="wrap footer">Las métricas (μ y λ) están ocultas para una vista limpia. Siguen alimentando los cálculos.</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const leagueSel=$('league'), homeSel=$('home'), awaySel=$('away');
  const btnCalc=$('calc'), btnAI=$('ai');
  const haInput=$('ha'), htFactorInput=$('htFactor'), haHTInput=$('ha_ht');
  const haCornersInput=$('ha_corners'), haCardsInput=$('ha_cards'), status=$('status');
  const scoreFT = document.querySelector('#scoretab_ft tbody');
  const scoreHT = document.querySelector('#scoretab_ht tbody');

  let teams = {}; // teams[league][team] = {aggregados}

  function ensureTeam(league, team){
    teams[league]=teams[league]||{};
    teams[league][team]=teams[league][team]||{
      gf:0,ga:0,matches:0,
      cf:0,ca:0, yF:0,yA:0, rF:0,rA:0,
      sotF:0,sotA:0, shF:0, shA:0
    };
    return teams[league][team];
  }

  // ------- Parsers -------
  function stripBOM(s){ return s.charCodeAt(0)===0xFEFF ? s.slice(1) : s; }

  function tryParseJSONorNDJSON(text){
    const t=stripBOM(text);
    try{ const j=JSON.parse(t); return Array.isArray(j)? j:[j]; }
    catch(e){
      const lines=t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const arr=[]; for(const ln of lines){ try{arr.push(JSON.parse(ln));}catch(_){}} 
      return arr.length? arr : null;
    }
  }

  function parseCSV(text){
    const raw = stripBOM(text).replace(/\r/g,'');
    const firstLine = raw.split('\n')[0] || '';
    const sep = (firstLine.match(/;/g)||[]).length > (firstLine.match(/,/g)||[]).length ? ';' : ',';
    const lines = raw.split('\n').filter(x=>x.trim().length>0);
    if(lines.length<2) return [];
    const headers = lines[0].split(sep).map(h=>h.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(sep).map(c=>c.trim());
      const o={};
      headers.forEach((h,idx)=>{ o[h]=cols[idx]??''; });
      rows.push(o);
    }
    return rows;
  }

  function parsePotential(text){
    const js = tryParseJSONorNDJSON(text);
    if(js && js.length) return js;
    const csv = parseCSV(text);
    if(csv && csv.length) return csv;
    throw new Error("No se pudo leer el archivo. Usa JSON (array/objeto/NDJSON) o CSV con encabezados.");
  }

  const num = x => {
    if (x==null || x==='') return 0;
    const s = String(x).replace(/,/g,'.').replace(/[^\d.\-+eE]/g,'');
    const n = Number(s); return Number.isFinite(n)? n:0;
  };

  const keyMap = {
    league:/^(league|liga)$/i, team:/^(team|equipo|name|nombre)$/i,
    matches:/^(matches|mp|pj|games|partidos)$/i,
    gf:/^(gf|goals?\s*for|goles\s*a\s*favor|goles\s*favor|golesf|goles\s*hechos)$/i,
    ga:/^(ga|goals?\s*against|goles\s*en\s*contra|golesc|goles\s*recibidos)$/i,
    homeTeam:/^(hometeam|home\s*team|local|equipo\s*local)$/i,
    awayTeam:/^(awayteam|away\s*team|visitante|equipo\s*visitante)$/i,
    fthg:/^(fthg|home\s*(goals?|score)|goles\s*local|gf\s*local)$/i,
    ftag:/^(ftag|away\s*(goals?|score)|goles\s*visitante|gf\s*visitante)$/i,
    matchStr:/^(match|partido)$/i,
    resultFT:/^(result\s*ft|resultado\s*ft|ft\s*result|final\s*score|resultado)$/i,
    hc:/^(home\s*corners(?:\s*at\s*ft)?|corners?\s*local|saques\s*de\s*esquina\s*local)$/i,
    ac:/^(away\s*corners(?:\s*at\s*ft)?|corners?\s*visitante|saques\s*de\s*esquina\s*visitante)$/i,
    hy:/^(home\s*yellow(?:\s*cards?)?(?:\s*at\s*ft)?|amarillas\s*local|tarjetas\s*amarillas\s*local)$/i,
    ay:/^(away\s*yellow(?:\s*cards?)?(?:\s*at\s*ft)?|amarillas\s*visitante|tarjetas\s*amarillas\s*visitante)$/i,
    hr:/^(home\s*red(?:\s*cards?)?(?:\s*at\s*ft)?|rojas\s*local|tarjetas\s*rojas\s*local)$/i,
    ar:/^(away\s*red(?:\s*cards?)?(?:\s*at\s*ft)?|rojas\s*visitante|tarjetas\s*rojas\s*visitante)$/i,
    hSOT:/^(home\s*(on\s*goal|on\-?target)\s*shots(?:\s*at\s*ft)?|tiros\s*a\s*puerta?\s*local|disparos\s*a\s*puerta?\s*local)$/i,
    aSOT:/^(away\s*(on\s*goal|on\-?target)\s*shots(?:\s*at\s*ft)?|tiros\s*a\s*puerta?\s*visitante|disparos\s*a\s*puerta?\s*visitante)$/i,
    hSH:/^(home\s*total\s*shots(?:\s*at\s*ft)?|total\s*shots\s*home|tiros\s*totales?\s*local|disparos\s*totales?\s*local)$/i,
    aSH:/^(away\s*total\s*shots(?:\s*at\s*ft)?|total\s*shots\s*away|tiros\s*totales?\s*visitante|disparos\s*totales?\s*visitante)$/i
  };
  function findKey(o, rx){ for(const k of Object.keys(o)){ if(rx.test(k)) return k; } return null; }

  function accumulateTeam(league, team, gf, ga, cf, ca, yF, yA, rF, rA, sotF, sotA, shF, shA){
    if(!league||!team) return;
    const t=ensureTeam(league, team);
    t.gf+=gf; t.ga+=ga; t.cf+=cf; t.ca+=ca; t.yF+=yF; t.yA+=yA; t.rF+=rF; t.rA+=rA;
    t.sotF+=sotF; t.sotA+=sotA; t.shF+=shF; t.shA+=shA;
    t.matches+=1;
  }
  function parseMatchTeams(s){
    const sep=/\s+(?:-|–|—|vs\.?|VS|:)\s+/i;
    const parts=String(s).split(sep).map(x=>x.trim()).filter(Boolean);
    return parts.length>=2? [parts[0],parts[1]]:[null,null];
  }
  function parseScoreFT(s){
    const m=String(s).match(/(\d+)\s*(?:-|–|—|:)\s*(\d+)/);
    return m? [num(m[1]), num(m[2])] : [null,null];
  }

  function buildFromArray(arr){
    teams={};
    for(const row of arr){
      if(!row||typeof row!=='object') continue;
      const kLeague=findKey(row,keyMap.league);
      const league= kLeague? String(row[kLeague]).trim() :"—";

      const kTeam=findKey(row,keyMap.team), kGF=findKey(row,keyMap.gf), kGA=findKey(row,keyMap.ga), kM=findKey(row,keyMap.matches);
      const kHT=findKey(row,keyMap.homeTeam), kAT=findKey(row,keyMap.awayTeam), kFTHG=findKey(row,keyMap.fthg), kFTAG=findKey(row,keyMap.ftag);
      const kMatch=findKey(row,keyMap.matchStr), kResFT=findKey(row,keyMap.resultFT);
      const kHC=findKey(row,keyMap.hc), kAC=findKey(row,keyMap.ac);
      const kHY=findKey(row,keyMap.hy), kAY=findKey(row,keyMap.ay);
      const kHR=findKey(row,keyMap.hr), kAR=findKey(row,keyMap.ar);
      const kHSOT=findKey(row,keyMap.hSOT), kASOT=findKey(row,keyMap.aSOT);
      const kHSH=findKey(row,keyMap.hSH),   kASH=findKey(row,keyMap.aSH);

      if(kTeam && (kGF||kGA) && kM){
        const team=String(row[kTeam]).trim();
        const m=Math.max(1,num(row[kM]));
        const t=ensureTeam(league, team);
        t.gf += num(row[kGF]); t.ga += num(row[kGA]); t.matches += m;
        t.cf += num(row[kHC]||0); t.ca += num(row[kAC]||0);
        t.yF += num(row[kHY]||0); t.yA += num(row[kAY]||0);
        t.rF += num(row[kHR]||0); t.rA += num(row[kAR]||0);
        t.sotF += num(row[kHSOT]||0); t.sotA += num(row[kASOT]||0);
        t.shF  += num(row[kHSH] ||0); t.shA  += num(row[kASH] ||0);
      } else if(kHT && kAT && (kFTHG||kFTAG)){
        const ht=String(row[kHT]).trim(), at=String(row[kAT]).trim();
        const gh=num(row[kFTHG]), ga=num(row[kFTAG]);
        const hc=num(row[kHC]||0), ac=num(row[kAC]||0);
        const hy=num(row[kHY]||0), ay=num(row[kAY]||0);
        const hr=num(row[kHR]||0), ar=num(row[kAR]||0);
        const hsot=num(row[kHSOT]||0), asot=num(row[kASOT]||0);
        const hsh =num(row[kHSH] ||0), ash =num(row[kASH] ||0);
        accumulateTeam(league, ht, gh, ga, hc, ac, hy, ay, hr, ar, hsot, asot, hsh, ash);
        accumulateTeam(league, at, ga, gh, ac, hc, ay, hy, ar, hr, asot, hsot, ash, hsh);
      } else if(kMatch && kResFT){
        const [ht,at]=parseMatchTeams(row[kMatch]);
        const [gh,ga]=parseScoreFT(row[kResFT]);
        if(ht&&at&&Number.isFinite(gh)&&Number.isFinite(ga)){
          const hc=num(row[kHC]||0), ac=num(row[kAC]||0);
          const hy=num(row[kHY]||0), ay=num(row[kAY]||0);
          const hr=num(row[kHR]||0), ar=num(row[kAR]||0);
          const hsot=num(row[kHSOT]||0), asot=num(row[kASOT]||0);
          const hsh =num(row[kHSH] ||0), ash =num(row[kASH] ||0);
          accumulateTeam(league, ht, gh, ga, hc, ac, hy, ay, hr, ar, hsot, asot, hsh, ash);
          accumulateTeam(league, at, ga, gh, ac, hc, ay, hy, ar, hr, asot, hsot, ash, hsh);
        }
      }
    }
  }

  // ------- UI helpers -------
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function fillSelectors(autoselect=true){
    const leagues=Object.keys(teams).sort((a,b)=>a.localeCompare(b));
    leagueSel.innerHTML='<option value="">— Selecciona liga —</option>'+leagues.map(l=>`<option>${escapeHtml(l)}</option>`).join('');
    leagueSel.disabled = leagues.length===0 ? true : false;

    function setTeams(lig){
      const list=lig&&teams[lig]? Object.keys(teams[lig]).sort((a,b)=>a.localeCompare(b)):[];
      const opts='<option value="">— Equipo —</option>'+list.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
      homeSel.innerHTML=opts; awaySel.innerHTML=opts;
      const enable = list.length>0;
      homeSel.disabled=!enable; awaySel.disabled=!enable; btnCalc.disabled=!enable; btnAI.disabled=!enable;
      if(autoselect && enable && list.length>=2){ homeSel.value=list[0]; awaySel.value=list[1]; }
    }

    if(leagues.length>0){
      leagueSel.value = leagues[0];
      setTeams(leagues[0]);
    }else{
      setTeams("");
    }

    if(!leagueSel._hasChangeListener){
      leagueSel.addEventListener('change',()=>setTeams(leagueSel.value));
      leagueSel._hasChangeListener = true;
    }
  }

  // ------- Poisson -------
  const factMemo=[1]; function fact(n){ for(let i=factMemo.length;i<=n;i++) factMemo[i]=factMemo[i-1]*i; return factMemo[n]; }
  const poisPMF=(k,λ)=> Math.exp(-λ)*Math.pow(λ,k)/fact(k);
  function poisCDF(k,λ){ let s=0; for(let i=0;i<=k;i++) s+=poisPMF(i,λ); return s; }
  const clamp=(x,min,max)=> Math.max(min,Math.min(max,x));
  function setProb(id, p){
    const el = $(id); if(!el) return;
    el.textContent = (p*100).toFixed(1)+'%';
    const kpi = el.closest('.kpi'); if(kpi){ kpi.dataset.prob = String(p); kpi.classList.remove('hot'); }
  }
  function markGroupTop(selector){
    const root = document.querySelector(selector); if(!root) return;
    const items = Array.from(root.querySelectorAll('.kpi[data-prob]')).map(k=>({k, p:Number(k.dataset.prob||'0')}));
    if(!items.length) return; items.forEach(x=>x.k.classList.remove('hot')); items.sort((a,b)=>b.p-a.p); items[0].k.classList.add('hot');
  }

  // ------- Compute (con o sin IA) -------
  function compute(useAI=false){
    status && (status.textContent= useAI ? 'Calculando con IA asistida…' : 'Calculando…');

    const lig=leagueSel.value, home=homeSel.value, away=awaySel.value;
    const HA=clamp(Number(haInput.value)||1.00,0.5,1.6);
    const factorHT=clamp(Number(htFactorInput.value)||0.45,0.2,0.8);
    const HA_HT=clamp(Number(haHTInput.value)||1.00,0.5,1.6);
    const HA_COR=clamp(Number(haCornersInput.value)||1.05,0.8,1.4);
    const HA_CAR=clamp(Number(haCardsInput.value)||1.00,0.8,1.4);

    if(!lig||!teams[lig]){ status.textContent='Elige una liga.'; return; }
    if(!home||!away||home===away){ status.textContent='Elige dos equipos distintos.'; return; }

    const tH=teams[lig][home], tA=teams[lig][away];
    if(!tH||!tA){ status.textContent='Faltan datos para esos equipos.'; return; }

    // Medias de liga (por equipo/partido)
    let sumGF=0,sumM=0,sumCF=0,sumY=0,sumR=0,sumSOT=0,sumSH=0;
    for(const t of Object.values(teams[lig])){ sumGF+=t.gf; sumM+=t.matches; sumCF+=t.cf; sumY+=t.yF; sumR+=t.rF; sumSOT+=t.sotF; sumSH+=t.shF; }
    const mu  = sumM>0 ? (sumGF/Math.max(1,sumM)) : 1.25;
    const muC = sumM>0 ? (sumCF/Math.max(1,sumM)) : 4.8;
    const muY = sumM>0 ? (sumY /Math.max(1,sumM)) : 2.4;
    const muR = sumM>0 ? (sumR /Math.max(1,sumM)) : 0.18;
    const muSOT = sumM>0 ? (sumSOT/Math.max(1,sumM)) : 4.2;
    const muSH  = sumM>0 ? (sumSH /Math.max(1,sumM)) : 12.0;

    // Promedios por equipo (fallback a medias)
    const h = {
      gfpm: tH.matches? tH.gf/tH.matches : mu,
      gapm: tH.matches? tH.ga/tH.matches : mu,
      cfpm: tH.matches? tH.cf/tH.matches : muC,
      capm: tH.matches? tH.ca/tH.matches : muC,
      ypm:  tH.matches? tH.yF/tH.matches : muY,
      yapm: tH.matches? tH.yA/tH.matches : muY,
      rpm:  tH.matches? tH.rF/tH.matches : muR,
      rapm: tH.matches? tH.rA/tH.matches : muR,
      sotpm:tH.matches? tH.sotF/tH.matches: muSOT,
      sota: tH.matches? tH.sotA/tH.matches: muSOT,
      shpm: tH.matches? tH.shF/tH.matches : muSH,
      sha:  tH.matches? tH.shA/tH.matches : muSH
    };
    const a = {
      gfpm: tA.matches? tA.gf/tA.matches : mu,
      gapm: tA.matches? tA.ga/tA.matches : mu,
      cfpm: tA.matches? tA.cf/tA.matches : muC,
      capm: tA.matches? tA.ca/tA.matches : muC,
      ypm:  tA.matches? tA.yF/tA.matches : muY,
      yapm: tA.matches? tA.yA/tA.matches : muY,
      rpm:  tA.matches? tA.rF/tA.matches : muR,
      rapm: tA.matches? tA.rA/tA.matches : muR,
      sotpm:tA.matches? tA.sotF/tA.matches: muSOT,
      sota: tA.matches? tA.sotA/tA.matches: muSOT,
      shpm: tA.matches? tA.shF/tA.matches : muSH,
      sha:  tA.matches? tA.shA/tA.matches : muSH
    };

    // Fuerzas GOLES base
    const attH=h.gfpm/Math.max(mu,1e-9), defH=h.gapm/Math.max(mu,1e-9);
    const attA=a.gfpm/Math.max(mu,1e-9), defA=a.gapm/Math.max(mu,1e-9);
    let λH = attH*defA*mu*HA;
    let λA = attA*defH*mu;
    
    // ===== Coeficiente de Variación (CV) =====
const lambdaTot = Math.max(λH + λA, 1e-9);
const CV = 1 / Math.sqrt(lambdaTot);
function cvLabel(cv){ return cv<0.5 ? 'Bajo' : (cv<=0.8 ? 'Medio' : 'Alto'); }

    // ==== IA asistida: refuerzo a λ usando señales auxiliares ====
    if(useAI){
      const r_h_sot = h.sotpm/Math.max(muSOT,1e-9);
      const r_h_sh  = h.shpm /Math.max(muSH ,1e-9);
      const r_h_cor = h.cfpm /Math.max(muC  ,1e-9);
      const r_h_y   = h.ypm  /Math.max(muY  ,1e-9);

      const r_a_sot_allow = a.sota/Math.max(muSOT,1e-9);
      const r_a_sh_allow  = a.sha /Math.max(muSH ,1e-9);
      const r_a_cor_allow = a.capm/Math.max(muC  ,1e-9);

      const r_a_sot = a.sotpm/Math.max(muSOT,1e-9);
      const r_a_sh  = a.shpm /Math.max(muSH ,1e-9);
      const r_a_cor = a.cfpm /Math.max(muC  ,1e-9);
      const r_a_y   = a.ypm  /Math.max(muY  ,1e-9);

      const r_h_sot_allow = h.sota/Math.max(muSOT,1e-9);
      const r_h_sh_allow  = h.sha /Math.max(muSH ,1e-9);
      const r_h_cor_allow = h.capm/Math.max(muC  ,1e-9);

      const wsot=0.25, wsh=0.10, wcor=0.08, wcard=0.06;
      let adjH = wsot*(r_h_sot-1) + wsh*(r_h_sh-1) + wcor*(r_h_cor-1)
               + wsot*(r_a_sot_allow-1) + wsh*(r_a_sh_allow-1) + wcor*(r_a_cor_allow-1)
               - wcard*(r_h_y-1);
      let adjA = wsot*(r_a_sot-1) + wsh*(r_a_sh-1) + wcor*(r_a_cor-1)
               + wsot*(r_h_sot_allow-1) + wsh*(r_h_sh_allow-1) + wcor*(r_h_cor_allow-1)
               - wcard*(r_a_y-1);

      const multH = clamp(1+adjH, 0.75, 1.35);
      const multA = clamp(1+adjA, 0.75, 1.35);
      λH = λH * multH;
      λA = λA * multA;
    }

    // KPIs (ocultas pero activas)
    $('k_mu').textContent=mu.toFixed(3);
    $('k_att_h').textContent=(h.gfpm/Math.max(mu,1e-9)).toFixed(3);
    $('k_def_h').textContent=(h.gapm/Math.max(mu,1e-9)).toFixed(3);
    $('k_att_a').textContent=(a.gfpm/Math.max(mu,1e-9)).toFixed(3);
    $('k_def_a').textContent=(a.gapm/Math.max(mu,1e-9)).toFixed(3);
    $('k_lh').textContent=λH.toFixed(3);
    $('k_la').textContent=λA.toFixed(3);

    // FT distribution + 1X2 + O/U + BTTS
    const MAXG_FT=10;
    const pH = Array.from({length:MAXG_FT+1},(_,k)=>poisPMF(k,λH));
    const pA = Array.from({length:MAXG_FT+1},(_,k)=>poisPMF(k,λA));
    let p1=0,px=0,p2=0,pUnder25=0; let rows=[];
    for(let hg=0; hg<=MAXG_FT; hg++){
      for(let ag=0; ag<=MAXG_FT; ag++){
        const p=pH[hg]*pA[ag];
        rows.push({score:`${hg}-${ag}`,p});
        if(hg>ag) p1+=p; else if(hg===ag) px+=p; else p2+=p;
        if(hg+ag<=2) pUnder25+=p;
      }
    }
    const pOver25=1-pUnder25;

    // 1X2
    setProb('ft_1', p1); setProb('ft_x', px); setProb('ft_2', p2); markGroupTop('[data-group="g_ft_1x2"]');

    // Doble Oportunidad
    const dc_1x = p1 + px;
    const dc_12 = p1 + p2;
    const dc_x2 = px + p2;
    setProb('dc_1x', dc_1x);
    setProb('dc_12', dc_12);
    setProb('dc_x2', dc_x2);
    markGroupTop('[data-group="g_dc"]');

    // Draw No Bet (prob. efectiva de cobro = cond. sin empate)
    const pNoDraw = 1 - px;
    const dnb_h = pNoDraw>0 ? (p1 / pNoDraw) : 0;
    const dnb_a = pNoDraw>0 ? (p2 / pNoDraw) : 0;
    setProb('dnb_h', dnb_h);
    setProb('dnb_a', dnb_a);
    markGroupTop('[data-group="g_dnb"]');

    // O/U 2.5
    setProb('m_o25', pOver25); setProb('m_u25', pUnder25); markGroupTop('[data-group="g_ft_ou25"]');

    // BTTS + Prob. individuales de anotar
    const pNoHome = pH[0], pNoAway = pA[0];
    const pHomeScores = 1 - pNoHome;
    const pAwayScores = 1 - pNoAway;
    const pBTTS = 1 - pNoHome - pNoAway + pNoHome*pNoAway;
    setProb('m_btts_yes', pBTTS);
    setProb('m_btts_no', 1 - pBTTS);
    setProb('m_home_scores', pHomeScores);
    setProb('m_away_scores', pAwayScores);
    markGroupTop('[data-group="g_ft_btts"]');

    // Top correct scores
    rows.sort((a,b)=>b.p-a.p);
    scoreFT.innerHTML=rows.slice(0,50).map((x,i)=>`<tr><td><span class="pill ${i===0?'best':''}">${x.score}${i===0?' ⭐':''}</span></td><td>${(x.p*100).toFixed(3)}%</td></tr>`).join('');

    // HT
    const λH_HT = λH * factorHT * ( (clamp(Number(haHTInput.value)||1,0.5,1.6)) / HA );
    const λA_HT = λA * factorHT;
    const MAXG_HT=5;
    const pH_ht = Array.from({length:MAXG_HT+1},(_,k)=>poisPMF(k,λH_HT));
    const pA_ht = Array.from({length:MAXG_HT+1},(_,k)=>poisPMF(k,λA_HT));
    let ht1=0,htx=0,ht2=0, u05=0, u15=0; let rowsHT=[];
    for(let hg=0; hg<=MAXG_HT; hg++){
      for(let ag=0; ag<=MAXG_HT; ag++){
        const p=pH_ht[hg]*pA_ht[ag];
        rowsHT.push({score:`${hg}-${ag}`,p});
        if(hg>ag) ht1+=p; else if(hg===ag) htx+=p; else ht2+=p;
        if(hg+ag<=0) u05+=p; if(hg+ag<=1) u15+=p;
      }
    }
    const o05=1-u05, o15=1-u15;
    setProb('ht_1', ht1); setProb('ht_x', htx); setProb('ht_2', ht2); markGroupTop('[data-group="g_ht_1x2"]');
    setProb('ht_o05', o05); setProb('ht_u05', u05); markGroupTop('[data-group="g_ht_ou05"]');
    setProb('ht_o15', o15); setProb('ht_u15', u15); markGroupTop('[data-group="g_ht_ou15"]');

    rowsHT.sort((a,b)=>b.p-a.p);
    scoreHT.innerHTML=rowsHT.slice(0,40).map((x,i)=>`<tr><td><span class="pill ${i===0?'best':''}">${x.score}${i===0?' ⭐':''}</span></td><td>${(x.p*100).toFixed(3)}%</td></tr>`).join('');

    // Córners
    const attC_H = h.cfpm/Math.max(muC,1e-9), defC_A = a.capm/Math.max(muC,1e-9);
    const attC_A = a.cfpm/Math.max(muC,1e-9), defC_H = h.capm/Math.max(muC,1e-9);
    const λC_H = attC_H * defC_A * muC * (useAI? 1 : 1) * (clamp(Number(haCornersInput.value)||1.05,0.8,1.4));
    const λC_A = attC_A * defC_H * muC;
    const λC_T = λC_H + λC_A;
    $('c_mu').textContent=muC.toFixed(3);
    $('c_lh').textContent=λC_H.toFixed(3);
    $('c_la').textContent=λC_A.toFixed(3);
    $('c_tot').textContent=λC_T.toFixed(3);
    const c_o85 = 1 - poisCDF(8, λC_T), c_u85 = 1-c_o85;
    const c_o95 = 1 - poisCDF(9, λC_T), c_u95 = 1-c_o95;
    const c_o105= 1 - poisCDF(10,λC_T), c_u105= 1-c_o105;
    setProb('c_o85', c_o85); setProb('c_u85', c_u85); markGroupTop('[data-group="g_c_85"]');
    setProb('c_o95', c_o95); setProb('c_u95', c_u95); markGroupTop('[data-group="g_c_95"]');
    setProb('c_o105',c_o105); setProb('c_u105',c_u105); markGroupTop('[data-group="g_c_105"]');

    // Tarjetas (Amarillas)
    const attY_H = h.ypm/Math.max(muY,1e-9), defY_A = a.yapm/Math.max(muY,1e-9);
    const attY_A = a.ypm/Math.max(muY,1e-9), defY_H = h.yapm/Math.max(muY,1e-9);
    const λY_H = attY_H * defY_A * muY * (clamp(Number(haCardsInput.value)||1.00,0.8,1.4));
    const λY_A = attY_A * defY_H * muY;
    const λY_T = λY_H + λY_A;
    $('y_mu').textContent=muY.toFixed(3);
    $('y_lh').textContent=λY_H.toFixed(3);
    $('y_la').textContent=λY_A.toFixed(3);
    $('y_tot').textContent=λY_T.toFixed(3);
    const y_o35 = 1 - poisCDF(3, λY_T), y_u35 = 1 - y_o35;
    const y_o45 = 1 - poisCDF(4, λY_T), y_u45 = 1 - y_o45;
    setProb('y_o35', y_o35); setProb('y_u35', y_u35); markGroupTop('[data-group="g_y_35"]');
    setProb('y_o45', y_o45); setProb('y_u45', y_u45); markGroupTop('[data-group="g_y_45"]');

    // Tarjetas (Rojas)
    const attR_H = h.rpm/Math.max(muR,1e-9), defR_A = a.rapm/Math.max(muR,1e-9);
    const attR_A = a.rpm/Math.max(muR,1e-9), defR_H = h.rapm/Math.max(muR,1e-9);
    const λR_H = attR_H * defR_A * muR * (clamp(Number(haCardsInput.value)||1.00,0.8,1.4));
    const λR_A = attR_A * defR_H * muR;
    const λR_T = λR_H + λR_A;
    $('r_mu').textContent=muR.toFixed(3);
    $('r_lh').textContent=λR_H.toFixed(3);
    $('r_la').textContent=λR_A.toFixed(3);
    $('r_tot').textContent=λR_T.toFixed(3);
    const r_o05 = 1 - poisCDF(0, λR_T), r_u05 = 1 - r_o05;
    const r_o15 = 1 - poisCDF(1, λR_T), r_u15 = 1 - r_o15;
    $('r_any').textContent=(r_o05*100).toFixed(1)+'%';
    setProb('r_o05', r_o05); setProb('r_u05', r_u05); markGroupTop('[data-group="g_r_05"]');
    setProb('r_o15', r_o15); setProb('r_u15', r_u15); markGroupTop('[data-group="g_r_15"]');

    // Disparos a puerta (SoT) totales
    const attSOT_H = h.sotpm/Math.max(muSOT,1e-9), defSOT_A = a.sota/Math.max(muSOT,1e-9);
    const attSOT_A = a.sotpm/Math.max(muSOT,1e-9), defSOT_H = h.sota/Math.max(muSOT,1e-9);
    const λSOT_H = attSOT_H * defSOT_A * muSOT * (useAI? clamp(HA,0.95,1.2): HA);
    const λSOT_A = attSOT_A * defSOT_H * muSOT;
    const λSOT_T = λSOT_H + λSOT_A;
    $('sot_mu').textContent=muSOT.toFixed(3);
    $('sot_lh').textContent=λSOT_H.toFixed(3);
    $('sot_la').textContent=λSOT_A.toFixed(3);
    $('sot_tot').textContent=λSOT_T.toFixed(3);
    const sot_o75 = 1 - poisCDF(7, λSOT_T), sot_u75 = 1 - sot_o75;
    const sot_o85 = 1 - poisCDF(8, λSOT_T), sot_u85 = 1 - sot_o85;
    const sot_o95 = 1 - poisCDF(9, λSOT_T), sot_u95 = 1 - sot_o95;
    setProb('sot_o75', sot_o75); setProb('sot_u75', sot_u75); markGroupTop('[data-group="g_sot_75"]');
    setProb('sot_o85', sot_o85); setProb('sot_u85', sot_u85); markGroupTop('[data-group="g_sot_85"]');
    setProb('sot_o95', sot_o95); setProb('sot_u95', sot_u95); markGroupTop('[data-group="g_sot_95"]');

    // Disparos totales (Shots)
    const attSH_H = h.shpm/Math.max(muSH,1e-9), defSH_A = a.sha/Math.max(muSH,1e-9);
    const attSH_A = a.shpm/Math.max(muSH,1e-9), defSH_H = h.sha/Math.max(muSH,1e-9);
    const λSH_H = attSH_H * defSH_A * muSH * (useAI? clamp(HA,0.95,1.2): HA);
    const λSH_A = attSH_A * defSH_H * muSH;
    const λSH_T = λSH_H + λSH_A;
    $('sh_mu').textContent=muSH.toFixed(3);
    $('sh_lh').textContent=λSH_H.toFixed(3);
    $('sh_la').textContent=λSH_A.toFixed(3);
    $('sh_tot').textContent=λSH_T.toFixed(3);
    const sh_o205 = 1 - poisCDF(20, λSH_T), sh_u205 = 1 - sh_o205;
    const sh_o225 = 1 - poisCDF(22, λSH_T), sh_u225 = 1 - sh_o225;
    const sh_o245 = 1 - poisCDF(24, λSH_T), sh_u245 = 1 - sh_o245;
    setProb('sh_o205', sh_o205); setProb('sh_u205', sh_u205); markGroupTop('[data-group="g_sh_205"]');
    setProb('sh_o225', sh_o225); setProb('sh_u225', sh_u225); markGroupTop('[data-group="g_sh_225"]');
    setProb('sh_o245', sh_o245); setProb('sh_u245', sh_u245); markGroupTop('[data-group="g_sh_245"]');

    /* ====== Render Upset Risk (FT: 1X2, OU, BTTS) ====== */
    if (window.UPSET && typeof window.UPSET.renderAllUpsetRisks === 'function'){
      window.UPSET.renderAllUpsetRisks({
        // 1X2
        p1: p1, pX: px, p2: p2,
        // OU (línea 2.5)
        pOver: pOver25, pUnder: pUnder25, lineOU: 2.5,
        // BTTS
        pYes: pBTTS, pNo: 1-pBTTS,
        // Lambdas para volatilidad
        lambdaH: λH, lambdaA: λA
      });
    }

    /* ====== Render Upset Risk (HT: O/U 0.5 y 1.5) ====== */
    if (window.UPSET && typeof window.UPSET.renderOUInto === 'function'){
      window.UPSET.renderOUInto('ht05', {
        pOver: o05, pUnder: u05, lineOU: 'HT 0.5',
        lambdaH: λH_HT, lambdaA: λA_HT
      });
      window.UPSET.renderOUInto('ht15', {
        pOver: o15, pUnder: u15, lineOU: 'HT 1.5',
        lambdaH: λH_HT, lambdaA: λA_HT
      });
    }

    status.textContent = useAI ? 'Listo ✔ Pronósticos reforzados con IA.' : 'Listo ✔ Pronósticos base calculados.';
  }

  // ------- Eventos -------
  btnCalc.addEventListener('click', ()=>compute(false));
  btnAI.addEventListener('click',   ()=>compute(true));

  document.getElementById('file').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    status.textContent='Cargando…';
    leagueSel.disabled = true; homeSel.disabled = true; awaySel.disabled = true; btnCalc.disabled = true; btnAI.disabled = true;
    leagueSel.innerHTML=''; homeSel.innerHTML=''; awaySel.innerHTML='';

    try{
      const text=await f.text();
      const arr=parsePotential(text);
      if(!arr.length) throw new Error("El archivo está vacío.");

      buildFromArray(arr);

      const haveLeagues = Object.keys(teams).length>0;
      if(!haveLeagues) throw new Error("No se detectaron ligas/equipos en el archivo.");

      fillSelectors(true);

      leagueSel.disabled = false;
      const lig = leagueSel.value;
      const enable = lig && teams[lig] && Object.keys(teams[lig]).length>0;
      homeSel.disabled = !enable; awaySel.disabled = !enable; btnCalc.disabled = !enable; btnAI.disabled = !enable;

      status.textContent='Datos cargados ✔ Selecciona liga y equipos. Pulsa Calcular o IA asistida.';
    }catch(err){
      teams={};
      leagueSel.disabled=true; homeSel.disabled=true; awaySel.disabled=true; btnCalc.disabled=true; btnAI.disabled=true;
      leagueSel.innerHTML=''; homeSel.innerHTML=''; awaySel.innerHTML='';
      status.textContent = (err && err.message) ? err.message : 'Error al leer el archivo.';
    }
  });
})();
</script>

<!-- ===== Módulo Upset Risk (independiente, extendido para HT) ===== -->
<script>
(function(){
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  function entropyN(ps){
    const eps=1e-12, clean=ps.map(p=>clamp(p,eps,1-eps));
    const H=-clean.reduce((s,p)=>s+p*Math.log(p),0);
    return H/Math.log(ps.length); // 0..1
  }
  function binaryTight(p){
    const eps=1e-12; p=clamp(p,eps,1-eps);
    const H=-(p*Math.log(p)+(1-p)*Math.log(1-p));
    return H/Math.log(2);
  }
  function norm01(x,min,max){ return (max<=min)?0:clamp((x-min)/(max-min),0,1); }
  function probsFromOdds(o1,oX,o2){
    if(!(o1&&oX&&o2)) return null;
    const inv=[1/o1,1/oX,1/o2], s=inv[0]+inv[1]+inv[2];
    return {p1:inv[0]/s,pX:inv[1]/s,p2:inv[2]/s};
  }

  function riskMulti(ps,{lambdaH=null,lambdaA=null,marketPs=null}={}){
    const tight=entropyN(ps);
    const favRisk=1-Math.max(...ps);
    let vol=0; if(lambdaH!=null && lambdaA!=null){ vol=norm01(lambdaH+lambdaA,0.5,4.0); }
    let mkt=0; if(marketPs){ const L1=ps.reduce((s,p,i)=>s+Math.abs(p-marketPs[i]),0); mkt=norm01(L1,0.00,0.60); }
    const score=0.35*tight+0.35*favRisk+0.15*vol+0.15*mkt;
    const label = score>=0.66?'Alto':(score>=0.33?'Medio':'Bajo');
    return {score,label,tight,favRisk,vol,mkt};
  }
  function riskBinary(pA,pB,{lambdaH=null,lambdaA=null,marketPs=null}={}){
    const tight=binaryTight(pA);
    const favRisk=1-Math.max(pA,pB);
    let vol=0; if(lambdaH!=null && lambdaA!=null){ vol=norm01(lambdaH+lambdaA,0.5,4.0); }
    let mkt=0; if(marketPs){ const L1=Math.abs(pA-marketPs[0])+Math.abs(pB-marketPs[1]); mkt=norm01(L1,0.00,0.60); }
    const score=0.45*tight+0.35*favRisk+0.10*vol+0.10*mkt;
    const label = score>=0.66?'Alto':(score>=0.33?'Medio':'Bajo');
    return {score,label,tight,favRisk,vol,mkt};
  }

  function setText(id,txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
  function setFill(id,p){ const el=document.getElementById(id); if(el) el.style.width=Math.round(clamp(p,0,1)*100)+'%'; }

  // Render fijo para FT OU (compatibilidad)
  function renderOU({pOver,pUnder,lineOU,lambdaH,lambdaA}){
    renderOUInto('ou', {pOver,pUnder,lineOU,lambdaH,lambdaA});
  }

  // Render parametrizable: ids construidos con prefijo
  // Espera que existan: fav-<prefix>, riskLabel-<prefix>, riskPct-<prefix>, fill-<prefix>, det-<prefix>
  function renderOUInto(prefix, {pOver,pUnder,lineOU,lambdaH,lambdaA,marketPs=null}){
    if([pOver,pUnder].some(v=>typeof v!=='number')) return;
    const rk=riskBinary(pOver,pUnder,{lambdaH,lambdaA,marketPs});
    const favLbl=(pOver>=pUnder)?'Over':'Under';
    setText(`fav-${prefix}`,'Favorito: '+favLbl);
    setText(`riskLabel-${prefix}`,'Riesgo: '+rk.label);
    setText(`riskPct-${prefix}`,Math.round(rk.score*100)+'%');
    setFill(`fill-${prefix}`,rk.score);
    setText(`det-${prefix}`,`Línea: ${lineOU??'—'} · Parejo: ${Math.round(rk.tight*100)}% · Favorito débil: ${Math.round(rk.favRisk*100)}%`
      + (lambdaH!=null?` · VarGoles: ${Math.round(rk.vol*100)}%`:``));
  }

  function render1x2({p1,pX,p2,lambdaH,lambdaA,odds1,oddsX,odds2}){
    if([p1,pX,p2].some(v=>typeof v!=='number')) return;
    const mkt=probsFromOdds(odds1,oddsX,odds2);
    const rk=riskMulti([p1,pX,p2],{lambdaH,lambdaA,marketPs:mkt?[mkt.p1,mkt.pX,mkt.p2]:null});
    const favIdx=[p1,pX,p2].indexOf(Math.max(p1,pX,p2));
    const favLbl=['1 (Local)','X (Empate)','2 (Visita)'][favIdx];
    setText('fav-1x2','Favorito: '+favLbl);
    setText('riskLabel-1x2','Riesgo: '+rk.label);
    setText('riskPct-1x2',Math.round(rk.score*100)+'%');
    setFill('fill-1x2',rk.score);
    setText('det-btts',`Parejo: ${Math.round(rk.tight*100)}% · Favorito débil: ${Math.round(rk.favRisk*100)}%`
  + (lambdaH!=null?` · VarGoles: ${Math.round(rk.vol*100)}%`:``)
  + ` · CV: ${CV.toFixed(2)} (${cvLabel(CV)})`);
  }

  function renderBTTS({pYes,pNo,lambdaH,lambdaA}){
    if([pYes,pNo].some(v=>typeof v!=='number')) return;
    const rk=riskBinary(pYes,pNo,{lambdaH,lambdaA});
    const favLbl=(pYes>=pNo)?'BTTS: Sí':'BTTS: No';
    setText('fav-btts','Favorito: '+favLbl);
    setText('riskLabel-btts','Riesgo: '+rk.label);
    setText('riskPct-btts',Math.round(rk.score*100)+'%');
    setFill('fill-btts',rk.score);
    setText('det-btts',`Parejo: ${Math.round(rk.tight*100)}% · Favorito débil: ${Math.round(rk.favRisk*100)}%`
      + (lambdaH!=null?` · VarGoles: ${Math.round(rk.vol*100)}%`:``));
  }

  function renderAllUpsetRisks(opts){
    if(!opts||typeof opts!=='object') return;
    if(typeof opts.p1==='number' && typeof opts.pX==='number' && typeof opts.p2==='number'){
      render1x2(opts);
    }
    if(typeof opts.pOver==='number' && typeof opts.pUnder==='number'){
      renderOU(opts); // FT OU 2.5 en tu página
    }
    if(typeof opts.pYes==='number' && typeof opts.pNo==='number'){
      renderBTTS(opts);
    }
  }

  window.UPSET=Object.freeze({renderAllUpsetRisks, renderOUInto});
})();
</script>
</body>
</html>
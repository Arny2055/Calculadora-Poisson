<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS - Pro Analytics & Deep Backtesting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --fondo: #050d0a;
            --card-bg: #101d18;
            --texto-blanco: #e0e7e4;
            --texto-amarillo: #ffdf1b;
            --accent-green: #00ff88;
            --input-bg: #000000;
            --border: #243a33;
            --delete: #ff4d4d;
            --blue-info: #00d4ff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--fondo);
            color: var(--texto-blanco);
            margin: 0;
            padding: 0;
        }

        /* --- NAVEGACIÃ“N --- */
        .nav-tabs {
            display: flex;
            background: var(--card-bg);
            border-bottom: 2px solid var(--texto-amarillo);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-link {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #7f9c93;
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .tab-link.active {
            color: var(--texto-amarillo);
            background: rgba(255, 223, 27, 0.1);
        }

        .container {
            padding: 20px;
            max-width: 1100px;
            margin: auto;
        }

        .screen { display: none; }
        .active-screen { display: block; }

        /* --- CARDS Y INPUTS --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .card h2 {
            margin: 0 0 10px 0;
            color: var(--texto-amarillo);
            font-size: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 4px; }
        input, textarea {
            width: 100%; padding: 10px; background: var(--input-bg);
            border: 1px solid var(--border); color: white; border-radius: 6px;
            box-sizing: border-box; font-weight: bold; font-family: inherit;
        }

        textarea { resize: none; font-size: 0.75rem; height: 75px; margin-bottom: 10px; }

        .results-box {
            background: rgba(0,0,0,0.3);
            padding: 15px; border-radius: 8px; text-align: center; margin-top: 10px;
        }

        .recommendation {
            font-weight: 900; padding: 10px; border-radius: 4px;
            font-size: 0.8rem; display: block; margin-bottom: 10px;
        }

        .status-bet { background: #1b5e20; color: var(--accent-green); border: 1px solid var(--accent-green); }
        .status-no { background: #222; color: #777; border: 1px solid #444; }
        .status-danger { background: #4a0000; color: #ff8a80; border: 1px solid #ff4d4d; }

        .btn-register {
            width: 100%; padding: 12px; background: var(--accent-green);
            color: #000; border: none; border-radius: 6px; font-weight: bold;
            cursor: pointer; margin-top: 10px; display: none;
        }

        .btn-clear {
            width: 100%; background: none; border: 1px solid #333; color: #555;
            padding: 5px; margin-top: 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;
        }

        /* --- SECCIÃ“N BACKTESTING --- */
        .backtest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .bt-card {
            background: rgba(0, 212, 255, 0.03);
            border: 1px solid rgba(0, 212, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .bt-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.75rem;
            color: var(--blue-info);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .insight-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .val-pos { color: var(--accent-green); font-weight: bold; }
        .val-neg { color: var(--delete); font-weight: bold; }

        /* --- CONTROL / HISTORIAL --- */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .stat-box {
            background: var(--card-bg); padding: 15px; border-radius: 10px;
            text-align: center; border: 1px solid var(--border);
        }
        .stat-val { font-size: 1.2rem; font-weight: 900; display: block; }

        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            height: 250px;
        }

        .history-item {
            background: var(--card-bg); padding: 15px; border-radius: 10px;
            margin-bottom: 10px; border-left: 5px solid #444;
        }
        .history-item.win { border-left-color: var(--accent-green); }
        .history-item.loss { border-left-color: var(--delete); }

        .history-league {
            font-size: 0.65rem;
            color: var(--blue-info);
            text-transform: uppercase;
            font-weight: bold;
            display: block;
        }

        .history-event {
            font-size: 0.9rem;
            color: var(--texto-amarillo);
            margin: 4px 0;
            display: block;
            font-weight: bold;
        }

        .history-date {
            font-size: 0.65rem;
            color: #777;
            display: block;
            margin-bottom: 8px;
        }

        .actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-win { background: var(--accent-green); border: none; padding: 6px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-loss { background: var(--delete); border: none; padding: 6px 15px; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-del { background: #222; border: 1px solid var(--border); color: var(--delete); padding: 5px 10px; border-radius: 4px; cursor: pointer; }

    </style>
</head>
<body>

    <div class="nav-tabs">
        <div class="tab-link active" onclick="nav('calc-screen', this)"><i class="fa-solid fa-calculator"></i> Calculadoras</div>
        <div class="tab-link" onclick="nav('control-screen', this)"><i class="fa-solid fa-chart-line"></i> Control & Backtesting</div>
    </div>

    <div class="container">
        
        <div id="calc-screen" class="screen active-screen">
            <div style="background: rgba(0,255,136,0.05); padding: 10px; border-radius: 8px; border: 1px solid var(--accent-green); margin-bottom: 20px; text-align: center; font-size: 0.8rem;">
                <i class="fa-solid fa-bank"></i> GestiÃ³n: <b>Kelly 25%</b> sobre Banca <b>$100.00</b>
            </div>
            <div class="grid" id="calculadoras-container"></div>
        </div>

        <div id="control-screen" class="screen">
            
            <div class="stats-grid">
                <div class="stat-box">
                    <span style="font-size:0.6rem; color:#888;">PROFIT ACUMULADO</span>
                    <span id="stat-profit" class="stat-val">0.00 $</span>
                </div>
                <div class="stat-box">
                    <span style="font-size:0.6rem; color:#888;">WIN RATE REAL</span>
                    <span id="stat-wr" class="stat-val">0%</span>
                </div>
                <div class="stat-box">
                    <span style="font-size:0.6rem; color:#888;">YIELD TOTAL</span>
                    <span id="stat-yield" class="stat-val">0%</span>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="growthChart"></canvas>
            </div>

            <h2 style="color: var(--blue-info); font-size: 1rem; margin-bottom: 15px;"><i class="fa-solid fa-vial-circle-check"></i> Backtesting de Estrategia</h2>
            <div class="backtest-grid" id="backtest-results"></div>

            <h2 style="color: var(--texto-amarillo); font-size: 1rem; margin-bottom: 15px;"><i class="fa-solid fa-list"></i> Historial de Apuestas</h2>
            <div id="history-list"></div>
            
            <button onclick="clearAllHistory()" style="width:100%; background:none; color:var(--delete); border:1px solid var(--delete); padding:10px; border-radius:6px; margin-top:20px; cursor:pointer; font-weight:bold;">RESETEAR TODO EL SISTEMA</button>
        </div>

    </div>

    <script>
        const BANCA_BASE = 100;
        const KELLY_FRACTION = 0.25;

        const mercados = [
            { id: 'Over', title: 'OVER (Goles)' },
            { id: 'Under', title: 'UNDER (Goles)' },
            { id: 'Yes', title: 'BTTS: SÃ' },
            { id: 'No', title: 'BTTS: NO' }
        ];

        let apuestas = JSON.parse(localStorage.getItem('betags_history')) || [];
        let growthChart = null;

        function renderCalculators() {
            const container = document.getElementById('calculadoras-container');
            container.innerHTML = mercados.map(m => `
                <div class="card">
                    <h2>${m.title}</h2>
                    <div class="input-group">
                        <div>
                            <label>Cuota Mercado</label>
                            <input type="number" id="odds_${m.id}" step="0.01" oninput="runCalc('${m.id}')">
                        </div>
                        <div>
                            <label>Cuota Contra</label>
                            <input type="number" id="contra_${m.id}" step="0.01" oninput="runCalc('${m.id}')">
                        </div>
                    </div>
                    <div>
                        <label>Tu Probabilidad %</label>
                        <input type="number" id="prob_${m.id}" step="0.1" oninput="runCalc('${m.id}')">
                    </div>
                    <div class="results-box">
                        <span id="rec_${m.id}" class="recommendation status-no">ESPERANDO DATOS</span>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:10px;">
                            <span>Edge: <b id="edge_${m.id}">0.00%</b></span>
                            <span>Overround: <b id="ovr_${m.id}">0.00%</b></span>
                        </div>
                        <label>Datos del Evento (Liga / Equipos / Fecha)</label>
                        <textarea id="event_${m.id}" placeholder="Pega aquÃ­ los datos..."></textarea>
                        
                        <div style="text-align:left;">
                            <label>Stake Sugerido (Kelly)</label>
                            <input type="number" id="stake_${m.id}" value="0.00">
                        </div>
                        <button id="btn_${m.id}" class="btn-register" onclick="registerBet('${m.id}')">REGISTRAR EN CONTROL</button>
                    </div>
                    <button class="btn-clear" onclick="clearCalc('${m.id}')">Limpiar</button>
                </div>
            `).join('');
        }

        function runCalc(id) {
            const odds = parseFloat(document.getElementById(`odds_${id}`).value);
            const contra = parseFloat(document.getElementById(`contra_${id}`).value);
            const prob = parseFloat(document.getElementById(`prob_${id}`).value);
            
            const recEl = document.getElementById(`rec_${id}`);
            const edgeEl = document.getElementById(`edge_${id}`);
            const ovrEl = document.getElementById(`ovr_${id}`);
            const btnReg = document.getElementById(`btn_${id}`);
            const stakeInput = document.getElementById(`stake_${id}`);

            if (odds > 1 && contra > 1 && prob > 0) {
                const overround = ((1/odds) + (1/contra) - 1) * 100;
                const edge = ((odds * (prob / 100)) - 1) * 100;

                ovrEl.innerText = overround.toFixed(2) + "%";
                edgeEl.innerText = edge.toFixed(2) + "%";

                const ruleEdge = (edge >= 3 && edge <= 15);
                const ruleOvr = (overround <= 8);
                const ruleVs = (edge > overround);

                const p = prob / 100;
                const b = odds - 1;
                const fKelly = Math.max(0, ((p * odds - 1) / b) * KELLY_FRACTION);
                const stakeFinal = BANCA_BASE * fKelly;

                if (ruleEdge && ruleOvr && ruleVs) {
                    recEl.innerText = "âœ“ APUESTA RENTABLE";
                    recEl.className = "recommendation status-bet";
                    btnReg.style.display = "block";
                    edgeEl.style.color = "var(--accent-green)";
                    stakeInput.value = stakeFinal.toFixed(2);
                } else if (edge > 0) {
                    recEl.innerText = "âš  FUERA DE RANGO SEGURO";
                    recEl.className = "recommendation status-danger";
                    btnReg.style.display = "block";
                    edgeEl.style.color = "var(--texto-amarillo)";
                    stakeInput.value = stakeFinal.toFixed(2);
                } else {
                    recEl.innerText = "âœ— SIN VALOR";
                    recEl.className = "recommendation status-no";
                    btnReg.style.display = "none";
                    edgeEl.style.color = "var(--delete)";
                    stakeInput.value = "0.00";
                }
            }
        }

        function registerBet(id) {
            const odds = parseFloat(document.getElementById(`odds_${id}`).value);
            const edge = parseFloat(document.getElementById(`edge_${id}`).innerText);
            const ovr = parseFloat(document.getElementById(`ovr_${id}`).innerText);
            const stake = parseFloat(document.getElementById(`stake_${id}`).value) || 0;
            const rawEvent = document.getElementById(`event_${id}`).value.trim();
            const mercadoName = mercados.find(m => m.id === id).title;

            // PARSEO MULTILÃNEA
            const lineas = rawEvent.split('\n').map(l => l.trim()).filter(l => l !== "");
            
            let liga = "General";
            let partido = "Evento Desconocido";
            let fecha = "Sin fecha";

            if (lineas.length >= 1) liga = lineas[0];
            if (lineas.length >= 2) partido = lineas[1].replace('ðŸ†š', '').trim();
            if (lineas.length >= 3) fecha = lineas[2].replace('ðŸ—“', '').trim();

            const nuevaApuesta = {
                id: Date.now(),
                liga: liga,
                partido: partido,
                fecha_evento: fecha,
                mercado: mercadoName,
                cuota: odds,
                edge: edge,
                overround: ovr,
                stake: stake,
                status: 'pending',
                registro: new Date().toLocaleDateString()
            };

            apuestas.unshift(nuevaApuesta);
            localStorage.setItem('betags_history', JSON.stringify(apuestas));
            
            clearCalc(id);
            alert("Â¡Apuesta enviada al Control!");
        }

        function loadHistory() {
            const list = document.getElementById('history-list');
            let profit = 0, inversion = 0, ganadas = 0, terminadas = 0;
            let cumulativeData = [0];

            let statsMercado = {}, statsCuota = { 'Baja (<1.70)':0, 'Media (1.7-2.2)':0, 'Alta (>2.2)':0 };
            let statsEdge = { 'Bajo (3-7%)':0, 'Medio (7-11%)':0, 'Alto (>11%)':0 };
            let statsLiga = {};

            const sortedHistory = [...apuestas].reverse();
            let currentProfit = 0;

            sortedHistory.forEach(a => {
                if (a.status !== 'pending') {
                    const res = (a.status === 'win') ? (a.cuota - 1) * a.stake : -a.stake;
                    currentProfit += res;
                    cumulativeData.push(parseFloat(currentProfit.toFixed(2)));

                    if(!statsMercado[a.mercado]) statsMercado[a.mercado] = 0;
                    statsMercado[a.mercado] += res;

                    if(a.cuota < 1.7) statsCuota['Baja (<1.70)'] += res;
                    else if(a.cuota <= 2.2) statsCuota['Media (1.7-2.2)'] += res;
                    else statsCuota['Alta (>2.2)'] += res;

                    if(a.edge < 7) statsEdge['Bajo (3-7%)'] += res;
                    else if(a.edge <= 11) statsEdge['Medio (7-11%)'] += res;
                    else statsEdge['Alto (>11%)'] += res;

                    if(!statsLiga[a.liga]) statsLiga[a.liga] = 0;
                    statsLiga[a.liga] += res;
                }

                if (a.status === 'win') { profit += (a.cuota - 1) * a.stake; inversion += a.stake; ganadas++; terminadas++; }
                else if (a.status === 'loss') { profit -= a.stake; inversion += a.stake; terminadas++; }
            });

            renderBacktestUI(statsMercado, statsCuota, statsEdge, statsLiga);

            list.innerHTML = apuestas.map(a => `
                <div class="history-item ${a.status}">
                    <span class="history-league">${a.liga}</span>
                    <span class="history-event">${a.partido}</span>
                    <span class="history-date"><i class="fa-regular fa-calendar"></i> ${a.fecha_evento}</span>
                    
                    <div style="display:flex; justify-content:space-between; font-weight:bold; border-top:1px solid rgba(255,255,255,0.05); padding-top:8px;">
                        <span>${a.mercado} @${a.cuota}</span>
                        <span>$${a.stake.toFixed(2)}</span>
                    </div>
                    <div style="font-size:0.7rem; color:#888; margin-top:5px;">Edge: ${a.edge}% | OV: ${a.overround}%</div>
                    
                    <div class="actions">
                        ${a.status === 'pending' ? `
                            <button class="btn-win" onclick="updateStatus(${a.id}, 'win')">GANADA</button>
                            <button class="btn-loss" onclick="updateStatus(${a.id}, 'loss')">PERDIDA</button>
                        ` : `<span style="font-weight:900; color:${a.status==='win'?'var(--accent-green)':'var(--delete)'}">${a.status.toUpperCase()}</span>`}
                        <button class="btn-del" onclick="deleteBet(${a.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            document.getElementById('stat-profit').innerText = profit.toFixed(2) + " $";
            document.getElementById('stat-profit').style.color = profit >= 0 ? "var(--accent-green)" : "var(--delete)";
            document.getElementById('stat-wr').innerText = terminadas > 0 ? ((ganadas/terminadas)*100).toFixed(1) + "%" : "0%";
            document.getElementById('stat-yield').innerText = inversion > 0 ? ((profit/inversion)*100).toFixed(1) + "%" : "0%";

            updateChart(cumulativeData);
        }

        function renderBacktestUI(mercados, cuotas, edges, ligas) {
            const btContainer = document.getElementById('backtest-results');
            const createBTBox = (title, data) => {
                let html = `<div class="bt-card"><h3>${title}</h3>`;
                let keys = Object.keys(data);
                if(keys.length === 0) html += `<div class="insight-row"><span>Sin datos</span></div>`;
                keys.forEach(key => {
                    const val = data[key];
                    html += `<div class="insight-row"><span>${key}</span><span class="${val>=0?'val-pos':'val-neg'}">${val>=0?'+':''}${val.toFixed(2)}$</span></div>`;
                });
                return html + `</div>`;
            };
            btContainer.innerHTML = createBTBox('Por Mercado', mercados) + createBTBox('Por Cuota', cuotas) + createBTBox('Por Edge', edges) + createBTBox('Top Ligas', ligas);
        }

        function updateChart(dataPoints) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            if (growthChart) growthChart.destroy();
            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map((_, i) => i),
                    datasets: [{
                        data: dataPoints,
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0,
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#7f9c93', font: { size: 10 } } }
                    }
                }
            });
        }

        function updateStatus(id, status) {
            const index = apuestas.findIndex(a => a.id === id);
            apuestas[index].status = status;
            localStorage.setItem('betags_history', JSON.stringify(apuestas));
            loadHistory();
        }

        function deleteBet(id) {
            if(confirm("Â¿Eliminar apuesta?")) {
                apuestas = apuestas.filter(a => a.id !== id);
                localStorage.setItem('betags_history', JSON.stringify(apuestas));
                loadHistory();
            }
        }

        function clearAllHistory() {
            if(confirm("Â¡ATENCIÃ“N! Se borrarÃ¡ todo el historial.")) {
                apuestas = [];
                localStorage.removeItem('betags_history');
                loadHistory();
            }
        }

        function clearCalc(id) {
            document.getElementById(`odds_${id}`).value = "";
            document.getElementById(`contra_${id}`).value = "";
            document.getElementById(`prob_${id}`).value = "";
            document.getElementById(`event_${id}`).value = "";
            document.getElementById(`rec_${id}`).innerText = "ESPERANDO DATOS";
            document.getElementById(`rec_${id}`).className = "recommendation status-no";
            document.getElementById(`btn_${id}`).style.display = "none";
            document.getElementById(`edge_${id}`).innerText = "0.00%";
            document.getElementById(`ovr_${id}`).innerText = "0.00%";
            document.getElementById(`stake_${id}`).value = "0.00";
        }

        function nav(screenId, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            document.getElementById(screenId).classList.add('active-screen');
            el.classList.add('active');
            if (screenId === 'control-screen') loadHistory();
        }

        renderCalculators();
        loadHistory();
    </script>
</body>
</html>

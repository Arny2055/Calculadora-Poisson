<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de ROI y Registro de Apuestas (Dark Mode)</title>
    <style>
        /* --- ESTILOS DARK MODE SUTIL --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #121212; /* Fondo Negro Oscuro Principal */
            color: #E0E0E0; /* Texto Gris Claro */
        }
        .container {
            max-width: 950px;
            margin: auto;
            background: #1E1E1E; /* Contenedor Gris Oscuro */
            padding: 25px;
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333333; 
        }
        h1, h2, h3 {
            text-align: center;
            color: #BB86FC; /* P√∫rpura/Azul Claro para acentos */
            margin-bottom: 20px;
        }
        hr {
            border-color: #333333; /* Separadores Gris Oscuro */
            margin: 30px 0;
        }

        /* --- LAYOUT Y SECCIONES --- */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .section-box {
            padding: 15px;
            border: 1px solid #333333; 
            border-radius: 4px;
            background-color: #2C2C2C; /* Fondo de secci√≥n m√°s claro */
        }
        
        /* --- ENTRADAS DE DATOS --- */
        .match-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .match-row label {
            width: 70px;
            font-weight: bold;
            color: #E0E0E0;
            flex-shrink: 0;
        }
        .match-row input[type="number"], .match-row select, .match-row input[type="text"] {
            padding: 5px;
            border: 1px solid #555555;
            border-radius: 4px;
            background-color: #121212; 
            color: #E0E0E0; 
            transition: border-color 0.3s;
        }
        .match-row select, .match-row input[type="text"] {
            width: 100%;
        }
        .match-row input:focus, .match-row select:focus {
            border-color: #03DAC6; /* Cian al enfocar */
            outline: none;
        }

        /* Agrupar ROIs Manuales */
        .manual-roi-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .manual-roi-group .match-row {
            width: 50%;
            margin-bottom: 0;
        }
        .manual-roi-group .match-row label {
            width: 40px; /* Ajuste para labels m√°s cortas */
        }
        
        /* --- ESTILOS DE RESULTADO (COLORES) --- */
        .result-won { 
            background-color: #184618 !important; /* Verde oscuro */
            color: #FFFFFF !important; 
            border-color: #00A800 !important;
        }
        .result-lost { 
            background-color: #4C1818 !important; /* Rojo oscuro */
            color: #FFFFFF !important; 
            border-color: #CC0000 !important;
        }
        .result-pending {
            background-color: #33334d !important; /* Azul/Gris oscuro para pendiente */
            color: #BB86FC !important; 
            border-color: #6200EE !important;
        }
        .result-default { 
            background-color: #121212; 
            color: #E0E0E0; 
        }

        /* --- BOTONES --- */
        button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s;
        }
        #calc-roi-btn { 
            background-color: #03DAC6; /* Cian brillante */
            color: #121212; 
        }
        #calc-roi-btn:hover { background-color: #00C4B4; }
        
        #save-match-btn { 
            background-color: #6200EE; /* P√∫rpura/Azul Oscuro */
            color: #FFFFFF; 
        }
        #save-match-btn:hover { background-color: #3700B3; }

        .btn-delete {
            padding: 5px 8px;
            background-color: #CF6679; /* Rojo suave */
            color: white;
            font-size: 0.8em;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
            margin: 0;
        }
        .btn-delete:hover {
            background-color: #A3001C;
        }
        .btn-edit {
            padding: 5px 8px;
            background-color: #BB86FC; /* P√∫rpura suave */
            color: white;
            font-size: 0.8em;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
            margin: 0 5px 0 0;
        }
        .btn-edit:hover {
            background-color: #8C52FF;
        }
        #delete-all-btn {
            background-color: #CF6679;
            color: #121212;
            margin-top: 20px;
        }
        #delete-all-btn:hover {
            background-color: #A3001C;
            color: #FFFFFF;
        }
        /* Nuevo bot√≥n para resumen de rendimiento */
        #show-summary-btn {
            background-color: #BB86FC;
            color: #121212;
            margin-top: 20px;
        }
        #show-summary-btn:hover {
            background-color: #8C52FF;
            color: #FFFFFF;
        }


        /* --- RESULTADOS Y TABLA --- */
        .positive { color: #00A800; font-weight: bold; } /* Ganancia Verde suave */
        .negative { color: #CF6679; font-weight: bold; } /* P√©rdida Rojo suave */
        .zero { color: #AAAAAA; font-weight: bold; } /* Cero Gris */
        .pending-text { color: #BB86FC; font-weight: bold; } /* Pendiente P√∫rpura */
        
        .history-section {
            background-color: #2C2C2C;
            border: 1px solid #333333;
            border-radius: 4px;
        }
        #match-history-table {
            border-collapse: collapse;
            width: 100%;
        }
        #match-history-table th, #match-history-table td {
            border: 1px solid #333333;
            background-color: #1E1E1E;
            color: #E0E0E0;
            padding: 8px 4px; 
            font-size: 0.8em;
            text-align: center;
        }
        #match-history-table th {
            background-color: #333333;
            color: #BB86FC;
            border-bottom: 2px solid #BB86FC;
        }
        .history-roi-summary {
            border-bottom: 1px solid #333333;
            color: #E0E0E0;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 20px; 
        }
        .history-roi-summary > div {
             font-size: 0.9em !important; 
        }

        /* --- MODAL DE EDICI√ìN Y RESUMEN --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.8); 
        }
        .modal-content {
            background-color: #2C2C2C;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #BB86FC;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }
        .close-btn {
            color: #AAAAAA;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #FFFFFF;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h3 {
            color: #03DAC6;
            margin-top: 0;
        }
        #save-edit-btn {
            background-color: #03DAC6;
            color: #121212;
        }
        #save-edit-btn:hover {
            background-color: #00C4B4;
        }

        /* Estilo de la tabla de resumen dentro del modal */
        #summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #summary-table th, #summary-table td {
            border: 1px solid #555;
            padding: 10px;
            text-align: center;
            background-color: #1E1E1E;
        }
        #summary-table th {
            background-color: #333;
            color: #03DAC6;
            font-size: 1em;
        }
        #summary-table td {
            font-weight: bold;
            font-size: 1.1em;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìä Calculadora de ROI y Registro de Apuestas</h1>

        <section style="margin-bottom: 30px;">
            <h2>üìà Progreso de Beneficio Acumulado (P&L)</h2>
            <div style="background: #1e1e1e; padding: 15px; border-radius: 8px; height: 350px;">
                <canvas id="profitChart" width="800" height="400"></canvas>
            </div>
        </section>

        <section>
            <h2>üìù An√°lisis de ROI Hist√≥rico (Stake 1 Unit)</h2>
            <p>Datos de rendimiento base. **Esta secci√≥n es solo de an√°lisis r√°pido**; el ROI L/V del historial se ingresa manualmente.</p>
            <div class="grid-layout">
                <div class="section-box">
                    <h3 style="color: #CF6679;">üè† Equipo Local</h3>
                    <div id="local-matches"></div>
                </div>

                <div class="section-box">
                    <h3 style="color: #03DAC6;">‚úàÔ∏è Equipo Visitante</h3>
                    <div id="visitor-matches"></div>
                </div>
            </div>
            <button id="calc-roi-btn" onclick="calculateROI()">Calcular ROI Hist√≥rico (An√°lisis R√°pido)</button>

            <div id="results" style="display: none;">
                <div class="result-item" id="roi-local-output"></div>
                <div class="result-item" id="roi-visitor-output"></div>
                <div class="result-item" id="roi-combined-output"></div>
            </div>
        </section>
        
        <hr>

        <section style="max-width: 450px; margin: 0 auto;">
            <div class="section-box">
                <h3 style="color: #6200EE;">üíæ Registrar Apuesta Real</h3>
                <p>Ingresa datos de la apuesta y los ROIs L/V analizados.</p>

                <div class="match-row">
                    <label for="reg-home">Local:</label>
                    <input type="text" id="reg-home" placeholder="Nombre Local" required>
                </div>
                <div class="match-row">
                    <label for="reg-away">Visitante:</label>
                    <input type="text" id="reg-away" placeholder="Nombre Visitante" required>
                </div>
                
                <div class="match-row">
                    <label for="reg-market">Mercado:</label>
                    <select id="reg-market">
                        <option value="OU">Over/Under</option>
                        <option value="BTTS">BTTS</option>
                    </select>
                </div>

                <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #03DAC6;">ROIs An√°lisis (Manual - Opcional):</p>
                <div class="manual-roi-group">
                    <div class="match-row">
                        <label for="reg-roi-local">ROI L.:</label>
                        <input type="number" id="reg-roi-local" step="0.01" placeholder="Ej: 15.5">
                    </div>
                    <div class="match-row">
                        <label for="reg-roi-visitor">ROI V.:</label>
                        <input type="number" id="reg-roi-visitor" step="0.01" placeholder="Ej: -5.0">
                    </div>
                </div>

                <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #E0E0E0;">Datos de Apuesta:</p>
                <div class="match-row">
                    <label for="reg-stake">Stake:</label>
                    <input type="number" id="reg-stake" step="0.01" min="0.01" placeholder="Inversi√≥n (‚Ç¨/\$)">
                </div>
                <div class="match-row">
                    <label for="reg-quota">Cuota:</label>
                    <input type="number" id="reg-quota" step="0.01" min="1.01" placeholder="Cuota Apostada">
                </div>
                <div class="match-row">
                    <label for="reg-result">Resultado:</label>
                    <select id="reg-result" onchange="applyResultStyle(this)" class="result-default">
                        <option value="" selected disabled>-- Selecciona --</option>
                        <option value="1">Ganado</option>
                        <option value="0">Perdido</option>
                        <option value="-1">Pendiente</option> </select>
                </div>
                <button id="save-match-btn" onclick="saveMatchToHistory()">Guardar Apuesta</button>
            </div>
        </section>

        <section class="history-section">
            <h2>üìú Historial de Apuestas (Stake Variable)</h2>
            
            <div class="history-roi-summary" id="historical-roi-summary">
                </div>
            
            <table id="match-history-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Partido</th>
                        <th>Mercado</th>
                        <th>ROI L. ($\geq 15\%$)</th>
                        <th>ROI V. ($\geq 15\%$)</th>
                        <th>Stake</th>
                        <th>Cuota</th>
                        <th>Estado</th>
                        <th>Ganancia Neta</th>
                        <th>ROI Gral.</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="match-history-body">
                    </tbody>
            </table>
            
            <button id="show-summary-btn" onclick="showPerformanceSummary()">üìà Ver Resumen de Rendimiento (ROI & Yield)</button>
            <button id="delete-all-btn" onclick="confirmClearHistory()">üóëÔ∏è Borrar Todo el Historial</button>
        </section>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3>‚úèÔ∏è Editar Apuesta</h3>
            <input type="hidden" id="edit-id">

            <div class="match-row">
                <label for="edit-home">Local:</label>
                <input type="text" id="edit-home" required>
            </div>
            <div class="match-row">
                <label for="edit-away">Visitante:</label>
                <input type="text" id="edit-away" required>
            </div>
             <div class="match-row">
                <label for="edit-market">Mercado:</label>
                <select id="edit-market">
                    <option value="OU">Over/Under</option>
                    <option value="BTTS">BTTS</option>
                </select>
            </div>

            <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #03DAC6;">ROIs An√°lisis:</p>
            <div class="manual-roi-group">
                <div class="match-row">
                    <label for="edit-roi-local">ROI L.:</label>
                    <input type="number" id="edit-roi-local" step="0.01">
                </div>
                <div class="match-row">
                    <label for="edit-roi-visitor">ROI V.:</label>
                    <input type="number" id="edit-roi-visitor" step="0.01">
                </div>
            </div>

            <p style="margin: 10px 0 5px 0; font-size: 0.9em; font-weight: bold; color: #E0E0E0;">Datos de Apuesta:</p>
            <div class="match-row">
                <label for="edit-stake">Stake:</label>
                <input type="number" id="edit-stake" step="0.01" min="0.01">
            </div>
            <div class="match-row">
                <label for="edit-quota">Cuota:</label>
                <input type="number" id="edit-quota" step="0.01" min="1.01">
            </div>
            <div class="match-row">
                <label for="edit-result">Resultado:</label>
                <select id="edit-result" onchange="applyResultStyle(this)" class="result-default">
                    <option value="1">Ganado</option>
                    <option value="0">Perdido</option>
                    <option value="-1">Pendiente</option> </select>
            </div>
            
            <button id="save-edit-btn" onclick="saveEdit()">Guardar Cambios</button>
        </div>
    </div>

    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSummaryModal()">&times;</span>
            <h3>üìà Resumen de Rendimiento (Apuestas Terminadas)</h3>
            
            <table id="summary-table">
                <thead>
                    <tr>
                        <th>M√©trica</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody id="summary-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const NUM_MATCHES = 5;
        const INVESTMENT_PER_MATCH = 1; 
        const TOTAL_INVESTMENT_HISTORIC = NUM_MATCHES * INVESTMENT_PER_MATCH;
        const MIN_ROI_THRESHOLD = 15; // Umbral de ROI del 15%

        let matchHistory = JSON.parse(localStorage.getItem('bettingHistory')) || []; 
        let historicalRoiData = { roiLocal: 0, roiVisitor: 0 }; 
        let myProfitChart; // Variable global para la instancia del gr√°fico

        // --- Funciones de Utilidad y Estilos ---

        /** Aplica la clase CSS de color seg√∫n el resultado seleccionado. */
        function applyResultStyle(selectElement) {
            const value = selectElement.value;
            selectElement.classList.remove('result-won', 'result-lost', 'result-pending', 'result-default');
            
            if (value === '1') {
                selectElement.classList.add('result-won');
            } else if (value === '0') {
                selectElement.classList.add('result-lost');
            } else if (value === '-1') {
                selectElement.classList.add('result-pending');
            } else {
                selectElement.classList.add('result-default');
            }
        }

        /** Genera los campos de entrada para los 5 partidos hist√≥ricos (Secci√≥n 1)*/
        function generateInputs(teamId, prefix) {
            const container = document.getElementById(teamId);
            let html = '';
            for (let i = 1; i <= NUM_MATCHES; i++) {
                html += `
                    <div class="match-row">
                        <label>P. ${i}:</label>
                        <input type="number" id="${prefix}-quota-${i}" step="0.01" min="1.01" placeholder="Cuota" value="2.00" required>
                        <select id="${prefix}-result-${i}" onchange="applyResultStyle(this)" class="result-default">
                            <option value="" selected disabled>Res.</option>
                            <option value="1">Gan.</option>
                            <option value="0">Per.</option>
                        </select>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // --- L√≥gica de ROI Hist√≥rico (Secci√≥n 1 - An√°lisis R√°pido) ---

        /** Calcula la ganancia neta para un equipo en los 5 partidos hist√≥ricos. */
        function calculateNetProfit(prefix) {
            let totalReturn = 0;
            for (let i = 1; i <= NUM_MATCHES; i++) {
                const quotaInput = document.getElementById(`${prefix}-quota-${i}`);
                const resultSelect = document.getElementById(`${prefix}-result-${i}`);
                
                if (!quotaInput.value || isNaN(parseFloat(quotaInput.value)) || resultSelect.value === "") {
                    return null;
                }
                
                const quota = parseFloat(quotaInput.value);
                const isWon = parseInt(resultSelect.value);

                if (isWon === 1) {
                    totalReturn += quota; 
                } 
            }
            return totalReturn - TOTAL_INVESTMENT_HISTORIC; 
        }

        /** Calcula el ROI hist√≥rico, guarda los valores y actualiza el resumen. */
        function calculateROI() {
            const netProfitLocal = calculateNetProfit('local');
            const netProfitVisitor = calculateNetProfit('visitor');

            if (netProfitLocal === null || netProfitVisitor === null) {
                alert('üö® ERROR: Completa todos los campos de Cuota y Resultado para el an√°lisis r√°pido.');
                return;
            }

            const roiLocal = (netProfitLocal / TOTAL_INVESTMENT_HISTORIC) * 100;
            const roiVisitor = (netProfitVisitor / TOTAL_INVESTMENT_HISTORIC) * 100;
            
            const totalNetProfit = netProfitLocal + netProfitVisitor;
            const roiCombined = (totalNetProfit / (TOTAL_INVESTMENT_HISTORIC * 2)) * 100;
            
            document.getElementById('roi-local-output').innerHTML = formatResult('LOCAL', roiLocal);
            document.getElementById('roi-visitor-output').innerHTML = formatResult('VISITANTE', roiVisitor);
            document.getElementById('roi-combined-output').innerHTML = formatResult('COMBINADO', roiCombined);
            document.getElementById('results').style.display = 'block';
        }


        // --- L√≥gica de Registro, Guardado y Eliminaci√≥n ---

        /** Guarda el historial en localStorage. */
        function saveHistoryToLocalStorage() {
            localStorage.setItem('bettingHistory', JSON.stringify(matchHistory));
        }
        
        /** Calcula la ganancia neta y el ROI para una apuesta dada. */
        function calculateBetMetrics(stake, quota, isWon) {
            let netProfit = 0;
            let roi = 0;

            if (isWon === 1) {
                const grossReturn = quota * stake;
                netProfit = grossReturn - stake;
                roi = (netProfit / stake) * 100;
            } else if (isWon === 0) {
                netProfit = -stake;
                roi = -100;
            } else { // isWon === -1 (Pendiente)
                netProfit = 0;
                roi = 0;
            }
            return { netProfit, roi };
        }

        /** Guarda una apuesta en el historial y actualiza la tabla. */
        function saveMatchToHistory() {
            const home = document.getElementById('reg-home').value.trim();
            const away = document.getElementById('reg-away').value.trim();
            const market = document.getElementById('reg-market').value;
            const stakeInput = document.getElementById('reg-stake').value;
            const quotaInput = document.getElementById('reg-quota').value;
            const resultSelect = document.getElementById('reg-result').value;
            const roiLocalManual = document.getElementById('reg-roi-local').value.trim();
            const roiVisitorManual = document.getElementById('reg-roi-visitor').value.trim();


            if (!home || !away || !stakeInput || !quotaInput || resultSelect === "") {
                alert('üö® ERROR: Completa los campos obligatorios de Apuesta.');
                return;
            }

            const stake = parseFloat(stakeInput);
            const quota = parseFloat(quotaInput);
            const isWon = parseInt(resultSelect); // Puede ser 1, 0, o -1 (Pendiente)
            
            if (stake <= 0 || quota <= 1.0) {
                alert('üö® ERROR: El Stake debe ser > 0 y la Cuota > 1.0');
                return;
            }

            const { netProfit, roi } = calculateBetMetrics(stake, quota, isWon);

            const roiLocal = roiLocalManual !== '' ? parseFloat(roiLocalManual) : null;
            const roiVisitor = roiVisitorManual !== '' ? parseFloat(roiVisitorManual) : null;


            const match = {
                id: Date.now(), 
                home: home,
                away: away,
                market: market,
                roiLocal: roiLocal, 
                roiVisitor: roiVisitor, 
                stake: stake,
                quota: quota,
                result: isWon,
                netProfit: netProfit,
                roi: roi
            };

            matchHistory.push(match);
            saveHistoryToLocalStorage();
            updateHistoryTable();

            // Limpiar campos de registro
            document.getElementById('reg-home').value = '';
            document.getElementById('reg-away').value = '';
            document.getElementById('reg-stake').value = '';
            document.getElementById('reg-quota').value = '';
            document.getElementById('reg-result').value = ''; 
            document.getElementById('reg-roi-local').value = '';
            document.getElementById('reg-roi-visitor').value = '';
            document.getElementById('reg-result').classList.add('result-default');
            document.getElementById('reg-result').classList.remove('result-won', 'result-lost', 'result-pending');
            alert(`‚úÖ Apuesta registrada: ${home} vs ${away}.`);
        }

        /** Elimina una apuesta individual por ID. */
        window.deleteMatch = function(id) {
            if (confirm('¬øSeguro que deseas borrar esta apuesta individual?')) {
                matchHistory = matchHistory.filter(match => match.id !== id);
                saveHistoryToLocalStorage();
                updateHistoryTable();
                alert('Apuesta eliminada.');
            }
        }

        /** Confirma y borra todo el historial. */
        function confirmClearHistory() {
            if (matchHistory.length === 0) {
                 alert('El historial ya est√° vac√≠o.');
                 return;
            }
            if (confirm('üö® ¬°ADVERTENCIA! ¬øEst√°s seguro de que quieres borrar TODO el historial de apuestas?')) {
                matchHistory = [];
                saveHistoryToLocalStorage();
                updateHistoryTable();
                alert('Historial completamente borrado.');
            }
        }

        // --- Funciones de Edici√≥n (Modal) ---

        /** Abre el modal de edici√≥n y carga los datos de la apuesta. */
        window.editMatch = function(id) {
            const match = matchHistory.find(m => m.id === id);
            if (!match) return;

            // Cargar datos en el modal
            document.getElementById('edit-id').value = match.id;
            document.getElementById('edit-home').value = match.home;
            document.getElementById('edit-away').value = match.away;
            document.getElementById('edit-market').value = match.market;
            document.getElementById('edit-roi-local').value = match.roiLocal !== null ? match.roiLocal : '';
            document.getElementById('edit-roi-visitor').value = match.roiVisitor !== null ? match.roiVisitor : '';
            document.getElementById('edit-stake').value = match.stake.toFixed(2);
            document.getElementById('edit-quota').value = match.quota.toFixed(2);
            
            const editResultSelect = document.getElementById('edit-result');
            editResultSelect.value = match.result;
            applyResultStyle(editResultSelect);

            document.getElementById('editModal').style.display = 'block';
        }

        /** Cierra el modal de edici√≥n. */
        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
        }

        /** Guarda los cambios editados. */
        window.saveEdit = function() {
            const id = parseInt(document.getElementById('edit-id').value);
            const index = matchHistory.findIndex(m => m.id === id);
            
            if (index === -1) {
                alert('Error: Apuesta no encontrada.');
                return;
            }

            const home = document.getElementById('edit-home').value.trim();
            const away = document.getElementById('edit-away').value.trim();
            const market = document.getElementById('edit-market').value;
            const stakeInput = document.getElementById('edit-stake').value;
            const quotaInput = document.getElementById('edit-quota').value;
            const resultSelect = document.getElementById('edit-result').value;
            const roiLocalManual = document.getElementById('edit-roi-local').value.trim();
            const roiVisitorManual = document.getElementById('edit-roi-visitor').value.trim();

            if (!home || !away || !stakeInput || !quotaInput) {
                alert('üö® ERROR: Completa los campos obligatorios de Apuesta.');
                return;
            }
            
            const stake = parseFloat(stakeInput);
            const quota = parseFloat(quotaInput);
            const isWon = parseInt(resultSelect); // Puede ser 1, 0, o -1

            if (stake <= 0 || quota <= 1.0) {
                alert('üö® ERROR: El Stake debe ser > 0 y la Cuota > 1.0');
                return;
            }
            
            // Recalcular Ganancia Neta y ROI General
            const { netProfit, roi } = calculateBetMetrics(stake, quota, isWon);

            // Actualizar el objeto
            matchHistory[index] = {
                ...matchHistory[index],
                home: home,
                away: away,
                market: market,
                roiLocal: roiLocalManual !== '' ? parseFloat(roiLocalManual) : null,
                roiVisitor: roiVisitorManual !== '' ? parseFloat(roiVisitorManual) : null,
                stake: stake,
                quota: quota,
                result: isWon,
                netProfit: netProfit,
                roi: roi
            };

            saveHistoryToLocalStorage();
            updateHistoryTable();
            closeEditModal();
            alert(`‚úÖ Apuesta #${index + 1} actualizada con √©xito.`);
        }

        // --- Funciones de Reporte y Vista ---

        /** * Calcula el ROI Total, Ganancia Neta y Yield de todas las apuestas TERMINADAS. */
        function calculateSummaryMetrics() {
            const terminatedMatches = matchHistory.filter(match => match.result !== -1);
            
            let totalInvestment = 0; // Suma de Stakes (Unidades)
            let totalNetProfit = 0; // Suma de Ganancia Neta

            terminatedMatches.forEach(match => {
                totalInvestment += match.stake; 
                totalNetProfit += match.netProfit;
            });

            let totalROI = 0;
            let totalYield = 0;

            if (totalInvestment > 0) {
                // C√°lculo del ROI/Yield: (Ganancia Neta / Stake Total) * 100
                totalROI = (totalNetProfit / totalInvestment) * 100;
                totalYield = totalROI; // En el contexto de apuestas, a menudo son el mismo c√°lculo.
            }
            
            return { totalInvestment, totalNetProfit, totalROI, totalYield, terminatedCount: terminatedMatches.length };
        }

        /** Actualiza el resumen de ROI en la parte superior del historial (Incluye Unidades). */
        function updateHistoricalSummary() {
            const historySummary = document.getElementById('historical-roi-summary');
            const summaryData = calculateSummaryMetrics(); 
            
            const totalStakes = summaryData.totalInvestment.toFixed(2); 
            
            const roiGeneralFormatted = formatResult(`‚ú® ROI General (${summaryData.terminatedCount} Ap. Terminadas)`, summaryData.totalROI);
            
            historySummary.innerHTML = `
                <div style="font-weight: bold; margin-right: 20px;">
                    ${roiGeneralFormatted}
                </div>
                <div style="font-size: 0.9em; color: #BB86FC;">
                    Unidades Apostadas: <span class="zero">${totalStakes} U.</span>
                </div>
            `;
        }


        /** Actualiza la tabla de historial. */
        function updateHistoryTable() {
            const tableBody = document.getElementById('match-history-body');
            tableBody.innerHTML = ''; 

            matchHistory.forEach((match, index) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = index + 1; 
                row.insertCell().textContent = `${match.home} vs ${match.away}`;
                row.insertCell().textContent = match.market;

                // ROI Local - Aplicar filtro de 15%
                const roiLocalCell = row.insertCell();
                if (match.roiLocal !== null && match.roiLocal >= MIN_ROI_THRESHOLD) {
                    roiLocalCell.innerHTML = formatResultSimple(match.roiLocal);
                } else {
                    roiLocalCell.textContent = '-';
                }

                // ROI Visitante - Aplicar filtro de 15%
                const roiVisitorCell = row.insertCell();
                if (match.roiVisitor !== null && match.roiVisitor >= MIN_ROI_THRESHOLD) {
                    roiVisitorCell.innerHTML = formatResultSimple(match.roiVisitor);
                } else {
                    roiVisitorCell.textContent = '-';
                }

                row.insertCell().textContent = match.stake.toFixed(2);
                row.insertCell().textContent = match.quota.toFixed(2);
                
                // ESTADO
                const resultCell = row.insertCell();
                let statusText;
                if (match.result === 1) {
                    statusText = 'Ganado';
                    resultCell.classList.add('positive');
                } else if (match.result === 0) {
                    statusText = 'Perdido';
                    resultCell.classList.add('negative');
                } else {
                    statusText = 'Pendiente';
                    resultCell.classList.add('pending-text');
                }
                resultCell.textContent = statusText;
                
                // GANANCIA NETA
                const profitCell = row.insertCell();
                if (match.result === -1) {
                    profitCell.textContent = 'N/A';
                    profitCell.classList.add('zero');
                } else {
                    profitCell.textContent = match.netProfit.toFixed(2);
                    profitCell.classList.add(match.netProfit >= 0 ? 'positive' : 'negative');
                }

                // ROI GENERAL DE LA APUESTA
                const roiCell = row.insertCell();
                if (match.result === -1) {
                    roiCell.textContent = 'N/A';
                    roiCell.classList.add('zero');
                } else {
                    roiCell.innerHTML = formatResultSimple(match.roi);
                }


                // Columna de Acci√≥n (Editar y Borrar)
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="btn-edit" onclick="editMatch(${match.id})">Editar</button>
                    <button class="btn-delete" onclick="deleteMatch(${match.id})">Borrar</button>
                `;
            });
            
            updateHistoricalSummary(); 
            renderProfitChart(); // <-- LLAMADA AL GRAFICO
        }

        /** Formatea el resultado de ROI con color, incluyendo el signo y el s√≠mbolo %. */
        function formatResult(label, roi) {
            const roundedRoi = roi.toFixed(2);
            let className;
            let sign = roi >= 0 ? '+' : '';

            if (roi > 0) {
                className = 'positive';
            } else if (roi < 0) {
                className = 'negative';
                sign = ''; 
            } else {
                className = 'zero';
            }
            return `${label}: <span class="${className}">${sign}${roundedRoi}%</span>`;
        }

         /** Formatea solo el valor de ROI con color y el s√≠mbolo %. */
        function formatResultSimple(roi) {
            const roundedRoi = roi.toFixed(2);
            let className;
            let sign = roi >= 0 ? '+' : '';

            if (roi > 0) {
                className = 'positive';
            } else if (roi < 0) {
                className = 'negative';
                sign = ''; 
            } else {
                className = 'zero';
            }
            return `<span class="${className}">${sign}${roundedRoi}%</span>`;
        }

        // --- FUNCIONES DEL GR√ÅFICO ---

        /** Dibuja la gr√°fica de Progreso de Beneficio (P&L) Acumulado. */
        function renderProfitChart() {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;

            // 1. Calcular datos acumulados
            let accumulatedProfit = 0;
            const labels = ['Inicio'];
            const dataPoints = [0];

            matchHistory.forEach((match, index) => {
                // Solo incluimos apuestas terminadas, de lo contrario la l√≠nea ser√≠a enga√±osa
                if (match.result !== -1) {
                    accumulatedProfit += match.netProfit;
                }
                labels.push(`Apuesta ${index + 1}`);
                dataPoints.push(parseFloat(accumulatedProfit.toFixed(2))); // Acumulado
            });
            
            // Si ya existe un gr√°fico, destr√∫yelo antes de crear uno nuevo
            if (window.myProfitChart) {
                window.myProfitChart.destroy();
            }

            // 2. Dibujar el gr√°fico usando Chart.js
            window.myProfitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Beneficio Acumulado (U)',
                        data: dataPoints,
                        borderColor: '#03DAC6', // Cian para la l√≠nea
                        backgroundColor: 'rgba(3, 218, 198, 0.1)', // Fondo sutil
                        tension: 0.4, // Curvatura de la l√≠nea
                        pointRadius: 3,
                        pointBackgroundColor: '#BB86FC'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Unidades (U)',
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: '#333333' 
                            },
                            ticks: {
                                color: '#E0E0E0'
                            }
                        },
                        x: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#E0E0E0'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // --- FUNCIONES DEL MODAL DE RESUMEN ---

        /** Cierra el modal de resumen. */
        window.closeSummaryModal = function() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        /** Abre el modal y muestra la tabla de rendimiento. */
        window.showPerformanceSummary = function() {
            const summaryData = calculateSummaryMetrics();
            const tableBody = document.getElementById('summary-table-body');
            tableBody.innerHTML = ''; // Limpiar la tabla

            if (summaryData.terminatedCount === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" class="pending-text">A√∫n no hay apuestas terminadas para el resumen.</td></tr>';
            } else {
                // Fila de ROI
                let roiCell = formatResultSimple(summaryData.totalROI);
                tableBody.innerHTML += `
                    <tr>
                        <td>ROI (Retorno de Inversi√≥n)</td>
                        <td>${roiCell}</td>
                    </tr>
                `;

                // Fila de Yield (Asumiendo que es igual al ROI en este contexto)
                let yieldCell = formatResultSimple(summaryData.totalYield);
                tableBody.innerHTML += `
                    <tr>
                        <td>Yield (Rendimiento)</td>
                        <td>${yieldCell}</td>
                    </tr>
                `;

                // Fila de Ganancia Neta Total
                let netProfitCell = summaryData.totalNetProfit.toFixed(2);
                let profitClass = summaryData.totalNetProfit >= 0 ? 'positive' : 'negative';
                tableBody.innerHTML += `
                    <tr>
                        <td>Ganancia Neta Total</td>
                        <td class="${profitClass}">${netProfitCell} U.</td>
                    </tr>
                `;

                // Fila de Unidades Apostadas
                tableBody.innerHTML += `
                    <tr>
                        <td>Unidades Apostadas (Stake Total)</td>
                        <td class="zero">${summaryData.totalInvestment.toFixed(2)} U.</td>
                    </tr>
                `;

                // Fila de Total de Apuestas
                tableBody.innerHTML += `
                    <tr>
                        <td>Total de Apuestas Terminadas</td>
                        <td class="zero">${summaryData.terminatedCount}</td>
                    </tr>
                `;
            }

            document.getElementById('summaryModal').style.display = 'block';
        }
        
        // Inicializar inputs y tabla al cargar la p√°gina
        window.onload = function() {
            generateInputs('local-matches', 'local');
            generateInputs('visitor-matches', 'visitor');
            updateHistoryTable(); 
        };
    </script>

</body>
</html>
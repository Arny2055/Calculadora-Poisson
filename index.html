import requests
import pandas as pd
from bs4 import BeautifulSoup
import re

# URL de las estadísticas de jugadores de La Liga que deseas scrapear
LA_LIGA_URL = "https://fbref.com/en/comps/12/La-Liga-Stats"

def get_fbref_table(url, table_id, header_row=1):
    """
    Función para extraer una tabla específica de FBref.
    :param url: La URL de la página.
    :param table_id: El ID HTML de la tabla a extraer (ej. 'stats_standard').
    :param header_row: El índice de la fila que contiene los nombres de las columnas.
    :return: Un DataFrame de pandas con los datos.
    """
    try:
        # 1. Obtener el contenido de la página
        print(f"Obteniendo datos de: {url}...")
        response = requests.get(url)
        response.raise_for_status()  # Lanza un error para códigos de estado HTTP malos

        # 2. Parsear el HTML
        soup = BeautifulSoup(response.content, 'html.parser')
        
        # 3. Encontrar el contenedor de la tabla
        # FBref a menudo oculta la tabla principal en un comentario HTML, 
        # por lo que primero buscamos la tabla en el HTML normal y luego en los comentarios.
        table_container = soup.find('div', {'id': table_id + '_container'})
        if not table_container:
            print(f"Contenedor {table_id} no encontrado. Intentando buscar en comentarios...")
            # Búsqueda en comentarios para tablas avanzadas
            comments = soup.find_all(string=lambda text: isinstance(text, re.Comment))
            comment_content = None
            for comment in comments:
                if table_id in str(comment):
                    comment_content = str(comment)
                    break
            
            if comment_content:
                soup_comment = BeautifulSoup(comment_content, 'html.parser')
                table = soup_comment.find('table', {'id': table_id})
            else:
                print(f"Error: No se pudo encontrar la tabla con ID '{table_id}'.")
                return pd.DataFrame()
        else:
             table = table_container.find('table', {'id': table_id})

        if not table:
             print(f"Error: La tabla con ID '{table_id}' no está presente en el HTML.")
             return pd.DataFrame()

        # 4. Usar pandas para leer la tabla directamente
        # FBref usa filas de encabezado doble. Leemos dos, luego corregimos.
        df_list = pd.read_html(str(table), header=[0, header_row])
        df = df_list[0]
        
        # 5. Limpiar y estandarizar los nombres de las columnas
        df.columns = ['_'.join(col).strip() for col in df.columns.values]
        
        # Renombrar columnas clave y eliminar filas de encabezado duplicadas
        df = df.rename(columns={'Unnamed: 0_level_0_Rk': 'Rank'})
        df = df[df['Rk_Rk'] != 'Rk'] # Elimina las filas de encabezado que aparecen a mitad de tabla
        
        # Eliminar columnas irrelevantes
        df = df.drop(columns=['Rk_Rk', 'Matches_Matches', 'Player_Player'], errors='ignore')
        
        # 6. Estandarizar el nombre de las columnas después de la limpieza
        new_cols = []
        for col in df.columns:
            # Elimina el prefijo duplicado si existe (ej. 'Standard Stats_Gls' a 'Gls')
            parts = col.split('_')
            if len(parts) > 1 and parts[-2] == parts[-1]:
                new_cols.append(parts[-1])
            else:
                 # Conserva la estructura para diferenciar estadísticas (ej. 'Standard Stats_Gls')
                new_cols.append(col)

        df.columns = new_cols
        print(f"Tabla '{table_id}' extraída con {len(df)} filas.")
        return df

    except requests.exceptions.HTTPError as e:
        print(f"Error HTTP al acceder a la URL: {e}")
        return pd.DataFrame()
    except Exception as e:
        print(f"Ocurrió un error inesperado: {e}")
        return pd.DataFrame()

if __name__ == '__main__':
    # Las tablas de estadísticas de jugadores de La Liga tienen los siguientes IDs:
    # 'stats_standard' -> Estadísticas Estándar
    # 'stats_shooting' -> Disparos
    # 'stats_passing'  -> Pases
    
    # 1. Extraer las estadísticas estándar
    stats_standard_df = get_fbref_table(LA_LIGA_URL, 'stats_standard')
    
    # 2. Extraer las estadísticas de disparos
    # Nota: Si el ID de la tabla es diferente o la estructura cambia, este paso fallará.
    # El ID 'stats_shooting' a menudo requiere buscar dentro de un comentario HTML.
    stats_shooting_df = get_fbref_table(LA_LIGA_URL, 'stats_shooting')

    # --- Procesamiento y Uso de la Herramienta ---

    if not stats_standard_df.empty:
        # Renombrar las columnas de unión antes de combinar para evitar conflictos
        stats_standard_df = stats_standard_df.rename(columns={'Player': 'Player_Name', 'Squad': 'Team'})
        
        # Si la tabla de disparos también se extrajo
        if not stats_shooting_df.empty:
            stats_shooting_df = stats_shooting_df.rename(columns={'Player': 'Player_Name', 'Squad': 'Team'})
            
            # Combinar las tablas utilizando 'Player_Name', 'Team' y 'Born' como claves de unión
            # Usamos un sufijo para diferenciar columnas que puedan tener el mismo nombre
            combined_df = pd.merge(
                stats_standard_df, 
                stats_shooting_df, 
                on=['Player_Name', 'Team', 'Born'], 
                how='inner',
                suffixes=('_Std', '_Shot')
            )
            
            print("\n✅ Datos Combinados con Éxito (Estándar + Disparos).")
            # Mostrar las primeras 5 filas y algunas columnas clave
            print(combined_df[['Player_Name', 'Team', 'Pos', 'Gls_Std', 'PK_Shot', 'xG_Shot', 'Min_Std']].head())

            # Guardar el resultado final en un archivo CSV
            output_file = 'LaLiga_Stats_Combinadas.csv'
            combined_df.to_csv(output_file, index=False, encoding='utf-8-sig')
            print(f"\n✨ ¡Herramienta completada! Los datos se han guardado en: {output_file}")
            
        else:
            # Si solo se extrajo la tabla estándar
            output_file = 'LaLiga_Stats_Estandar.csv'
            stats_standard_df.to_csv(output_file, index=False, encoding='utf-8-sig')
            print(f"\n✨ ¡Herramienta completada! Solo se guardaron las Estadísticas Estándar en: {output_file}")
    
    else:
        print("\n❌ Fallo en la extracción de datos. Revisa la URL y los IDs de las tablas.")


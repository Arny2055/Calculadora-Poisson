<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Backtesting por Casa de Apuestas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h1 { color: #0056b3; }
        h2, h3, h4 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 25px; }
        #resultados { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .success { color: #28a745; font-weight: bold; }
        .failure { color: #dc3545; font-weight: bold; }
        .neutral { color: #ffc107; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <h1>Herramienta de Backtesting por Casa de Apuestas 游눯</h1>
    <p>Analiza la rentabilidad de los mercados 1X2 y O/U 2.5 para todas las casas de apuestas.</p>

    <input type="file" id="jsonFile" accept=".json">
    <button onclick="iniciarBacktesting()">Iniciar Backtesting</button>

    <h2>Resultados del An치lisis</h2>
    <div id="resultados">Carga un archivo JSON para comenzar...</div>

    <script>
        let datosPartidos = []; 
        let analisisEquipos = {}; 
        
        // Mercados y Casas a analizar
        const MERCADOS = ['1X2_H', '1X2_D', '1X2_A', 'O2.5', 'U2.5'];
        const CASAS = ['B365', 'BFD', 'BMGM', 'BV', 'BW', 'CL', 'LB', 'PS', 'Max', 'Avg'];

        // Estructura para an치lisis de rentabilidad por mercado y casa
        let analisisCasas = {};

        // Inicializa la estructura analisisCasas
        CASAS.forEach(casa => {
            analisisCasas[casa] = {};
            MERCADOS.forEach(mercado => {
                analisisCasas[casa][mercado] = {
                    apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 
                };
            });
        });
        
        // Estructura para rangos de cuotas (solo para el O2.5 en este ejemplo)
        let analisisRangosO25 = {
            '1.00-1.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '1.51-2.00': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '2.01-2.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '2.51+':     { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 }
        };

        // --- MANEJO DE ARCHIVOS (Se mantiene la misma l칩gica) ---
        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    datosPartidos = JSON.parse(e.target.result);
                    if (!Array.isArray(datosPartidos)) {
                        if (typeof datosPartidos === 'object' && datosPartidos !== null) {
                            datosPartidos = [datosPartidos];
                        } else {
                             throw new Error("El archivo JSON debe ser un array de partidos.");
                        }
                    }
                    if (datosPartidos.length === 0) {
                         throw new Error("El array de partidos est치 vac칤o.");
                    }
                    document.getElementById('resultados').innerHTML = `<p class="success">Archivo JSON cargado correctamente. Se encontraron ${datosPartidos.length} partidos.</p>`;
                } catch (error) {
                    document.getElementById('resultados').innerHTML = `<p class="failure">Error al leer o parsear el archivo JSON: ${error.message}</p>`;
                    datosPartidos = [];
                }
            };
            reader.readAsText(file);
        });

        // --- FUNCIONES AUXILIARES DE AN츼LISIS ---

        function actualizarEstadisticasEquipo(equipo, esLocal, golesFavor, golesContra, resultadoFTR) {
            // ... (Funci칩n para actualizar estad칤sticas por equipo, la misma de antes)
            if (!equipo || !resultadoFTR) return; 

            if (!analisisEquipos[equipo]) {
                analisisEquipos[equipo] = {
                    jugados: 0, victorias: 0, empates: 0, derrotas: 0, 
                    gf: 0, gc: 0, loc_jugados: 0, vis_jugados: 0
                };
            }

            const stats = analisisEquipos[equipo];
            stats.jugados++;
            stats.gf += golesFavor;
            stats.gc += golesContra;
            stats[esLocal ? 'loc_jugados' : 'vis_jugados']++;

            if (resultadoFTR === 'H') {
                if (esLocal) stats.victorias++; else stats.derrotas++;
            } else if (resultadoFTR === 'A') {
                if (esLocal) stats.derrotas++; else stats.victorias++;
            } else { 
                stats.empates++;
            }
        }

        function obtenerRangoCuotaO25(cuota) {
            if (cuota >= 1.00 && cuota <= 1.50) return '1.00-1.50';
            if (cuota >= 1.51 && cuota <= 2.00) return '1.51-2.00';
            if (cuota >= 2.01 && cuota <= 2.50) return '2.01-2.50';
            if (cuota > 2.50) return '2.51+';
            return null;
        }

        // --- FUNCIONES DE GENERACI칍N DE TABLAS ---

        function generarTablaEquipos() {
            // ... (Funci칩n para generar tabla de equipos, la misma de antes)
            let htmlTabla = '<h3>An치lisis de Rendimiento General por Equipo (Todos los partidos)</h3>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Equipo</th><th>PJ</th><th>V</th><th>E</th><th>D</th><th>GF</th><th>GC</th><th>Dif</th><th>%V</th></tr>';

            const equiposOrdenados = Object.keys(analisisEquipos).sort();

            equiposOrdenados.forEach(equipo => {
                const stats = analisisEquipos[equipo];
                const diferencia = stats.gf - stats.gc;
                const porcentajeVictoria = stats.jugados > 0 ? ((stats.victorias / stats.jugados) * 100).toFixed(1) : 0;
                
                htmlTabla += `<tr>
                    <td>${equipo}</td>
                    <td>${stats.jugados}</td>
                    <td>${stats.victorias}</td>
                    <td>${stats.empates}</td>
                    <td>${stats.derrotas}</td>
                    <td>${stats.gf}</td>
                    <td>${stats.gc}</td>
                    <td class="${diferencia >= 0 ? 'success' : 'failure'}">${diferencia}</td>
                    <td>${porcentajeVictoria}%</td>
                </tr>`;
            });

            htmlTabla += '</table>';
            return htmlTabla;
        }

        function generarTablaRangosO25() {
            let htmlTabla = '<h3>Desglose de Rentabilidad: Over 2.5 Goles (Avg) por Rango de Cuotas</h3>';
            htmlTabla += '<p>Analiza el ROI del O2.5 promedio en diferentes niveles de cuotas.</p>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Rango de Cuotas</th><th>Apuestas</th><th>Ganancia Neta (u)</th><th>ROI (%)</th><th>Acierto (%)</th></tr>';

            for (const rango in analisisRangosO25) {
                const stats = analisisRangosO25[rango];
                const totalApuestas = stats.victorias + stats.perdidas;
                const roi = totalApuestas > 0 ? ((stats.gananciaNeta / totalApuestas) * 100).toFixed(2) : 0;
                const acierto = totalApuestas > 0 ? ((stats.victorias / totalApuestas) * 100).toFixed(1) : 0;
                const cssClass = stats.gananciaNeta >= 0 ? 'success' : 'failure';

                htmlTabla += `<tr>
                    <td>${rango}</td>
                    <td>${totalApuestas}</td>
                    <td class="${cssClass}">${stats.gananciaNeta.toFixed(2)}</td>
                    <td class="${cssClass}">${roi}</td>
                    <td>${acierto}</td>
                </tr>`;
            }

            htmlTabla += '</table>';
            return htmlTabla;
        }
        
        function generarTablaCasas() {
            let htmlTabla = '<h3>Rentabilidad por Casa de Apuestas y Mercado (Stake Fijo de 1u)</h3>';
            htmlTabla += '<p>Los valores muestran la rentabilidad al apostar a TODOS los partidos del dataset en el mercado espec칤fico de esa casa.</p>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Casa</th><th>Mercado</th><th>Apuestas</th><th>Cuota Media</th><th>Ganancia Neta (u)</th><th>ROI (%)</th><th>Acierto (%)</th></tr>';
            
            CASAS.forEach(casa => {
                MERCADOS.forEach(mercado => {
                    const stats = analisisCasas[casa][mercado];
                    const totalApuestas = stats.apuestas;
                    
                    // Solo mostramos si hay datos v치lidos (apuestas > 0)
                    if (totalApuestas > 0) {
                        const roi = (stats.gananciaNeta / totalApuestas) * 100;
                        const acierto = (stats.victorias / totalApuestas) * 100;
                        const cssClass = stats.gananciaNeta >= 0 ? 'success' : 'failure';
    
                        htmlTabla += `<tr>
                            <td>${casa}</td>
                            <td>${mercado}</td>
                            <td>${totalApuestas}</td>
                            <td>${stats.cuotaMedia.toFixed(3)}</td>
                            <td class="${cssClass}">${stats.gananciaNeta.toFixed(2)}</td>
                            <td class="${cssClass}">${roi.toFixed(2)}%</td>
                            <td>${acierto.toFixed(1)}%</td>
                        </tr>`;
                    }
                });
            });

            htmlTabla += '</table>';
            return htmlTabla;
        }

        // --- FUNCI칍N PRINCIPAL DE BACKTESTING ---

        function iniciarBacktesting() {
            if (datosPartidos.length === 0) {
                document.getElementById('resultados').innerHTML = '<p class="failure">Por favor, primero carga un archivo JSON.</p>';
                return;
            }

            // Reiniciar estructuras de an치lisis
            analisisEquipos = {}; 
            
            // Reiniciar an치lisisCasas y Rangos
            CASAS.forEach(casa => {
                analisisCasas[casa] = {};
                MERCADOS.forEach(mercado => {
                    analisisCasas[casa][mercado] = {
                        apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 
                    };
                });
            });
            analisisRangosO25 = {
                '1.00-1.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '1.51-2.00': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '2.01-2.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '2.51+':     { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 }
            };


            // Funci칩n para actualizar las estad칤sticas de una casa/mercado
            function actualizarCasaMercado(casa, mercado, cuota, esGanadora) {
                const stats = analisisCasas[casa][mercado];
                const apuesta = 1; // Stake fijo

                stats.apuestas++;
                stats.totalCuota += cuota;
                stats.cuotaMedia = stats.totalCuota / stats.apuestas;

                if (esGanadora) {
                    stats.gananciaNeta += (cuota - 1) * apuesta;
                    stats.victorias++;
                } else {
                    stats.gananciaNeta -= apuesta;
                    stats.perdidas++;
                }
            }


            // --- BUCLE DE BACKTESTING ---
            datosPartidos.forEach((partido) => {
                const homeTeam = partido.HomeTeam;
                const awayTeam = partido.AwayTeam;
                
                // Resultados del partido
                const fthg = parseInt(partido.FTHG) || 0; 
                const ftag = parseInt(partido.FTAG) || 0; 
                const ftr = partido.FTR;
                const golesTotales = fthg + ftag;
                
                // 1. An치lisis de Rendimiento de Equipos (Para tabla general)
                actualizarEstadisticasEquipo(homeTeam, true, fthg, ftag, ftr);
                actualizarEstadisticasEquipo(awayTeam, false, ftag, fthg, ftr);


                // =========================================================
                // 2. BACKTESTING POR CASA DE APUESTAS
                // (Se simula una apuesta a CADA MERCADO en CADA PARTIDO)
                // =========================================================
                const ganaO2_5 = golesTotales >= 3;
                const ganaU2_5 = golesTotales <= 2;
                
                CASAS.forEach(casa => {
                    // --- Mercado 1X2 ---
                    const cuotas1X2 = {
                        'H': parseFloat(partido[casa + 'H']) || 0,
                        'D': parseFloat(partido[casa + 'D']) || 0,
                        'A': parseFloat(partido[casa + 'A']) || 0
                    };
                    
                    if (cuotas1X2.H > 0) actualizarCasaMercado(casa, '1X2_H', cuotas1X2.H, ftr === 'H');
                    if (cuotas1X2.D > 0) actualizarCasaMercado(casa, '1X2_D', cuotas1X2.D, ftr === 'D');
                    if (cuotas1X2.A > 0) actualizarCasaMercado(casa, '1X2_A', cuotas1X2.A, ftr === 'A');

                    // --- Mercado O/U 2.5 ---
                    // NOTA: Las cuotas de O/U est치n en arrays anidados. Usaremos el 칤ndice [5] para O/U 2.5
                    const cuotaO2_5 = parseFloat(partido[casa + '>2'] ? partido[casa + '>2'][5] : null) || 0; 
                    const cuotaU2_5 = parseFloat(partido[casa + '<2'] ? partido[casa + '<2'][5] : null) || 0;
                    
                    if (cuotaO2_5 > 0) {
                        actualizarCasaMercado(casa, 'O2.5', cuotaO2_5, ganaO2_5);

                        // REGISTRO DE RANGOS O2.5 (Solo para el promedio 'Avg')
                        if (casa === 'Avg') {
                            const rango = obtenerRangoCuotaO25(cuotaO2_5);
                            if (rango) {
                                const statsRango = analisisRangosO25[rango];
                                statsRango.apuestas++;
                                if (ganaO2_5) {
                                    statsRango.gananciaNeta += (cuotaO2_5 - 1) * 1;
                                    statsRango.victorias++;
                                } else {
                                    statsRango.gananciaNeta -= 1;
                                    statsRango.perdidas++;
                                }
                            }
                        }
                    }
                    if (cuotaU2_5 > 0) {
                        actualizarCasaMercado(casa, 'U2.5', cuotaU2_5, ganaU2_5);
                    }
                });
            });
            // --- FIN DEL BUCLE ---

            // --- Generar Reporte ---
            let resultadosHTML = '';
            
            // 1. Tabla de Mercados por Casa
            resultadosHTML += generarTablaCasas();
            
            // 2. Desglose de Rangos O2.5 (Usando Avg)
            resultadosHTML += generarTablaRangosO25();
            
            // 3. Tabla de Equipos
            resultadosHTML += generarTablaEquipos();
            
            document.getElementById('resultados').innerHTML = resultadosHTML;
        }

    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Solucionador de Problemas ‚Äî Acciones Inmediatas, Correctivas y Preventivas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6;
    --border:#2a3140; --focus:#b9ccff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(15,17,21,.95), rgba(15,17,21,.65));border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  h1{margin:0 0 4px;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  button,.btn{background:var(--panel2);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  button:hover{border-color:var(--accent)}
  .btn-accent{background:var(--accent);color:#0b1020;border-color:transparent}
  .btn-ok{background:var(--ok);color:#0b1020;border-color:transparent}
  .btn-warn{background:var(--warn);color:#0b1020;border-color:transparent}
  .btn-danger{background:var(--danger);color:#0b1020;border-color:transparent}
  .layout{display:grid;grid-template-columns:290px 1fr;gap:16px;padding:16px}
  @media (max-width:980px){.layout{grid-template-columns:1fr}}
  nav{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px;height:fit-content;position:sticky;top:90px}
  .step{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:10px;color:var(--muted);cursor:pointer}
  .step.active{background:var(--panel2);color:var(--text);border:1px solid var(--border)}
  .num{width:26px;height:26px;display:grid;place-items:center;border-radius:8px;background:#101521;color:var(--accent);font-weight:800;border:1px solid var(--border)}
  section.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  h2{margin:0 0 8px;font-size:18px}
  h3{margin:12px 0 8px}
  .grid{display:grid;gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .grid.three{grid-template-columns:repeat(3,1fr)}
  @media (max-width:980px){.grid.two,.grid.three{grid-template-columns:1fr}}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px 12px;background:#0c0f18;color:var(--text);border:1px solid var(--border);border-radius:10px;outline:none}
  textarea{min-height:110px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px #b9ccff22}
  .pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#101521;border:1px solid var(--border);color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;font-size:14px}
  th{background:#131824;color:var(--muted)}
  .row-actions{display:flex;gap:6px}
  .badge{font-weight:800;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
  .ok{background:#102017;color:#b7ffcc}
  .warn{background:#261c09;color:#ffddaa}
  .danger{background:#281214;color:#ffbdbd}
  footer{color:var(--muted);font-size:12px;padding:10px 16px 30px}
  @media print{header,nav,.toolbar,.no-print{display:none!important} body{background:#fff;color:#000}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Solucionador de Problemas</h1>
    <div class="sub">De s√≠ntoma ‚Üí causa ‚Üí acciones (Inmediatas / Correctivas / Preventivas) + 5 Porqu√©s + CAPA</div>
    <div class="toolbar">
      <button id="save" class="btn-accent">üíæ Guardar</button>
      <button id="load">üì• Cargar</button>
      <button id="exportJSON">‚¨áÔ∏è Exportar JSON</button>
      <label class="btn no-print" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
        üì§ Importar JSON
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </label>
      <button id="print" class="btn-warn">üñ®Ô∏è Imprimir / PDF</button>
      <button id="newCase" class="btn-danger">üßπ Nuevo</button>
    </div>
  </div>
</header>

<div class="layout wrap">
  <nav id="steps"></nav>

  <main id="content">
    <!-- Paso 1 -->
    <section class="card" data-step="1">
      <h2>1) Definici√≥n del problema</h2>
      <div class="grid two">
        <div>
          <label>T√≠tulo</label>
          <input id="title" placeholder="Ej: Sensor inductivo da√±ado por rebaba">
        </div>
        <div>
          <label>√Årea/Equipo</label>
          <input id="area" placeholder="Ej: L√≠nea A / Estaci√≥n 12">
        </div>
        <div>
          <label>Impacto</label>
          <input id="impact" placeholder="Ej: Paro 35 min, scrap 12 pzs, riesgo de seguridad">
        </div>
        <div class="grid two">
          <div>
            <label>Fecha</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Turno</label>
            <select id="shift"><option>D√≠a</option><option>Noche</option></select>
          </div>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Descripci√≥n breve</label>
        <textarea id="desc" placeholder="¬øQu√© pas√≥? ¬øD√≥nde? ¬øCu√°ndo? ¬øCon qu√© frecuencia?"></textarea>
      </div>
    </section>

    <!-- Paso 2 -->
    <section class="card" data-step="2">
      <h2>2) S√≠ntomas y contexto</h2>
      <div class="grid two">
        <div>
          <label>S√≠ntomas observados</label>
          <div id="symptoms" class="grid two"></div>
        </div>
        <div>
          <label>Contexto</label>
          <div id="context" class="grid two"></div>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Notas adicionales</label>
        <textarea id="notes" placeholder="Lotes, piezas, proveedor, clima, cambios recientes‚Ä¶"></textarea>
      </div>
    </section>

    <!-- Paso 3 -->
    <section class="card" data-step="3">
      <h2>3) 5 Porqu√©s (r√°pido)</h2>
      <div class="grid two">
        <div>
          <label>S√≠ntoma ra√≠z para los porqu√©s</label>
          <input id="whySymptom" placeholder="Ej: Falla intermitente del sensor S12">
        </div>
        <div class="row-actions" style="justify-content:flex-end">
          <button id="addWhy">‚ûï Agregar porqu√©</button>
          <button id="clearWhy">üßπ Limpiar</button>
        </div>
      </div>
      <table id="whyTable" style="margin-top:8px">
        <thead><tr><th>#</th><th>Porque‚Ä¶</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="color:var(--muted);font-size:12px;margin-top:6px">
        Consejo: no te quedes en 5 exactos; llega a una causa verificable.
      </div>
    </section>

    <!-- Paso 4 -->
    <section class="card" data-step="4">
      <h2>4) Recomendaciones</h2>
      <div class="row-actions" style="justify-content:flex-end">
        <button id="runEngine" class="btn-ok">üß† Generar sugerencias</button>
      </div>

      <h3>Acciones inmediatas (contenci√≥n)</h3>
      <ul id="actInmediatas"></ul>

      <h3>Acciones correctivas (causa ra√≠z)</h3>
      <ul id="actCorrectivas"></ul>

      <h3>Acciones preventivas (no recurrencia)</h3>
      <ul id="actPreventivas"></ul>

      <h3>Checklist de ejecuci√≥n</h3>
      <table id="checkTable">
        <thead><tr><th>Tarea</th><th>Responsable</th><th>Fecha</th><th>Estatus</th><th>Acc.</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row-actions" style="margin-top:8px">
        <button id="addCheck">‚ûï Agregar tarea</button>
        <button id="clearCheck">üßπ Limpiar</button>
      </div>
    </section>

    <!-- Paso 5 -->
    <section class="card" data-step="5">
      <h2>5) Resultados r√°pidos</h2>
      <div class="grid two">
        <div>
          <label>KPI Antes</label>
          <input id="kpiBefore" type="number" step="any" placeholder="Ej: % paro 8">
        </div>
        <div>
          <label>KPI Despu√©s</label>
          <input id="kpiAfter" type="number" step="any" placeholder="Ej: % paro 2.5">
        </div>
      </div>
      <div style="margin-top:8px">
        <span id="kpiBadge" class="badge">‚Äî</span>
      </div>
      <canvas id="kpiChart" style="margin-top:12px;max-height:260px"></canvas>
    </section>

    <!-- Paso 6 -->
    <section class="card" data-step="6">
      <h2>6) Resumen CAPA</h2>
      <div class="row-actions" style="justify-content:flex-end">
        <button id="genResumen" class="btn">üìù Generar resumen</button>
      </div>
      <textarea id="resumen" placeholder="Aqu√≠ ver√°s el resumen generado" style="min-height:220px"></textarea>
    </section>

    <!-- Plantillas -->
    <section class="card" data-step="7">
      <h2>Plantillas de casos</h2>
      <div class="grid two">
        <div>
          <label>Elegir plantilla</label>
          <select id="template"></select>
        </div>
        <div class="row-actions" style="justify-content:flex-end">
          <button id="applyTemplate" class="btn-warn">üìã Aplicar</button>
        </div>
      </div>
      <div class="hint" style="margin-top:6px">Las plantillas cargan s√≠ntomas/contexto t√≠picos y texto de ejemplo (puedes editar todo).</div>
    </section>
  </main>
</div>

<footer class="wrap">
  Hecho con ‚ù§Ô∏è para mantenimiento/producci√≥n. Usa Exportar JSON para respaldo y PDF para compartir.
</footer>

<script>
  // ======= Datos base (s√≠ntomas, contexto y reglas) =======
  const stateKey = 'problemSolver_v1';

  const SYMPTOMS = [
    {id:'no_detecta', label:'No detecta / sin se√±al'},
    {id:'intermitente', label:'Intermitente'},
    {id:'falsos', label:'Falsos positivos/negativos'},
    {id:'fisico', label:'Da√±o f√≠sico visible'},
    {id:'sobrecarga', label:'Fusible/OTC disparado'},
    {id:'alarma_plc', label:'Alarma PLC/entrada err√°tica'},
    {id:'sobretemp', label:'Sobretemperatura'},
    {id:'humedad', label:'Humedad/condensaci√≥n'},
    {id:'suciedad', label:'Suciedad/virutas/rebaba'},
    {id:'desalineado', label:'Desalineado / holgura mec√°nica'},
    {id:'cable', label:'Cable cortado/pelado'},
    {id:'emi', label:'Interferencia EMI/Ruido'},
  ];

  const CONTEXT = [
    {id:'nuevo_cambio', label:'Cambio reciente de sensor'},
    {id:'ajuste_maquina', label:'Ajuste/Setup reciente'},
    {id:'material_nuevo', label:'Material/proveedor nuevo'},
    {id:'golpes', label:'Zona con golpes/impactos'},
    {id:'corte_viruta', label:'Rebaba/virutas cerca'},
    {id:'agua', label:'Agua/lavado frecuente'},
    {id:'aceite', label:'Aceite/niebla'},
    {id:'alta_temp', label:'Alta temperatura'},
    {id:'alta_vibracion', label:'Alta vibraci√≥n'},
    {id:'cables_potencia', label:'Cables de potencia cercanos'},
    {id:'exterior', label:'Ambiente exterior'},
  ];

  // Reglas (muy resumidas) => devuelven acciones con tipo: inmediata/correctiva/preventiva
  // Cada regla tiene triggers (s√≠ntomas/contexto) y propuesta de acciones.
  const RULES = [
    {
      id:'rebaba_corto_sensor',
      ifAny:['fisico','suciedad','corte_viruta'],
      ifContextAny:['golpes','corte_viruta'],
      score:5,
      acciones:{
        inmediata:[
          'Desenergizar y asegurar √°rea; reemplazar sensor si est√° cortado.',
          'Retirar rebaba/virutas; limpiar asiento y conector.'
        ],
        correctiva:[
          'Reubicar sensor fuera de la trayectoria de rebaba o a√±adir separador de distancia.',
          'Instalar protector/recubrimiento mec√°nico (carcasa, guard) contra virutas/golpes.',
          'Cambiar a sensor con carcasa reforzada o flush-mount adecuado.'
        ],
        preventiva:[
          'A√±adir poka-yoke: deflector o tapa anti-viruta.',
          'Estandarizar limpieza post-mecanizado; checklist al final del ciclo.',
          'Revisar par√°metros de corte para reducir rebaba; coordinar con proceso.'
        ]
      }
    },
    {
      id:'desalineo_mecanico',
      ifAny:['desalineado','no_detecta','intermitente'],
      ifContextAny:['ajuste_maquina','alta_vibracion','golpes'],
      score:4,
      acciones:{
        inmediata:[
          'Realinear sensor y objetivo a la distancia de sensado nominal; fijar torniller√≠a.',
        ],
        correctiva:[
          'Agregar tope mec√°nico o gu√≠a para eliminar juego.',
          'Sustituir soporte por uno r√≠gido; usar fijador de roscas.',
        ],
        preventiva:[
          'Estandarizar torque de montaje y plantilla de alineaci√≥n.',
          'Agregar inspecci√≥n diaria de holguras.'
        ]
      }
    },
    {
      id:'cableado_danado',
      ifAny:['cable','intermitente','no_detecta','alarma_plc'],
      ifContextAny:['golpes','alta_vibracion'],
      score:5,
      acciones:{
        inmediata:[
          'Sustituir tramo de cable/patch y verificar continuidad.',
          'Asegurar conectores (M8/M12) y alivio de tensi√≥n.'
        ],
        correctiva:[
          'Reruteo del cableado lejos de bordes/carriles m√≥viles; canaleta o manguera flexible.',
          'A√±adir prensaestopa IP67/68 y abrazaderas cada 20‚Äì30cm.',
        ],
        preventiva:[
          'Especificar cable industrial reforzado (PUR) con radio de curvatura adecuado.',
          'Plan de inspecci√≥n de conectores y strain relief.'
        ]
      }
    },
    {
      id:'emi_ruido',
      ifAny:['falsos','intermitente','alarma_plc'],
      ifContextAny:['cables_potencia','ajuste_maquina','alta_vibracion'],
      score:4,
      acciones:{
        inmediata:[
          'Separar se√±al de potencia (‚â• 20‚Äì30 cm) y cruces a 90¬∞. Conectar correctamente pantallas.',
          'Activar/ajustar filtros o debounce en PLC si aplica.'
        ],
        correctiva:[
          'A√±adir ferritas/filtros EMI en l√≠nea de se√±al.',
          'Instalar fuente aislada o optoacoplada.',
        ],
        preventiva:[
          'Normar rutas segregadas y puesta a tierra √∫nica.',
          'Checklist de buenas pr√°cticas EMC en montajes nuevos.'
        ]
      }
    },
    {
      id:'humedad_ip',
      ifAny:['humedad','intermitente','falsos'],
      ifContextAny:['agua','exterior','aceite'],
      score:3,
      acciones:{
        inmediata:[
          'Secar/conectar nuevamente; revisar empaques y O-rings.',
          'Cambiar sensor si hay intrusi√≥n visible.'
        ],
        correctiva:[
          'Cambiar a sensor con grado IP67/68/69K seg√∫n lavado.',
          'A√±adir capuch√≥n/guard contra spray directo.'
        ],
        preventiva:[
          'Programa de revisi√≥n de sellos y lubricaci√≥n de O-rings.',
          'Estandarizar IP seg√∫n celda/ambiente.'
        ]
      }
    },
    {
      id:'temperatura',
      ifAny:['sobretemp','intermitente','no_detecta'],
      ifContextAny:['alta_temp','exterior'],
      score:3,
      acciones:{
        inmediata:[
          'Enfriar zona y verificar rango de operaci√≥n del sensor.',
        ],
        correctiva:[
          'Relocalizar sensor lejos de foco t√©rmico o a√±adir escudo t√©rmico.',
          'Cambiar a modelo con rango extendido (p. ej., ‚àí25‚Ä¶+120 ¬∞C).'
        ],
        preventiva:[
          'Monitoreo de temperatura y alarmas tempranas.',
          'Estandarizar especificaci√≥n t√©rmica por aplicaci√≥n.'
        ]
      }
    }
  ];

  const TEMPLATES = [
    {
      id:'rebaba_corto',
      nombre:'Rebaba cort√≥ el sensor',
      fill:{
        title:'Sensor inductivo cortado por rebaba',
        area:'L√≠nea Mecanizado / Estaci√≥n 5',
        impact:'Paro 25 min, 8 pzs scrap',
        desc:'Tras operaci√≥n de barrenado, viruta se deposita y corta el cable del sensor S5. Falla intermitente y luego sin se√±al.',
        symptoms:['fisico','suciedad','no_detecta','intermitente'],
        context:['corte_viruta','golpes'],
        notes:'Se observan marcas en el cable y viruta acumulada en el soporte.'
      }
    },
    {
      id:'emi',
      nombre:'Falsos por EMI',
      fill:{
        title:'Falsos positivos por EMI en sensor fotoel√©ctrico',
        area:'L√≠nea Ensamble / Transportador 2',
        impact:'Rechazos injustificados, 12 paros cortos',
        desc:'El sensor detecta piezas ‚Äúfantasma‚Äù cuando arranca el motor del transportador contiguo.',
        symptoms:['falsos','intermitente','alarma_plc'],
        context:['cables_potencia','ajuste_maquina'],
        notes:'Ruta de se√±al comparte charola con VFD.'
      }
    },
    {
      id:'humedad',
      nombre:'Humedad en sensor',
      fill:{
        title:'Intrusi√≥n de agua en sensor',
        area:'Lavadora de piezas',
        impact:'2 paros, limpieza adicional',
        desc:'Tras lavado, el sensor presenta lectura err√°tica.',
        symptoms:['humedad','intermitente'],
        context:['agua','exterior'],
        notes:'Empaque viejo y con grietas.'
      }
    }
  ];

  // ======= UI helpers =======
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',background:'#111725',color:'#e6eaf2',padding:'10px 12px',border:'1px solid var(--border)',borderRadius:'10px',zIndex:9999});
    document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
  }

  // Render checkboxes
  function renderOptions(){
    const sBox = $('#symptoms'); sBox.innerHTML='';
    SYMPTOMS.forEach(s=>{
      const div=document.createElement('div'); div.innerHTML=`
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" value="${s.id}"> ${s.label}
        </label>`;
      sBox.appendChild(div);
    });
    const cBox = $('#context'); cBox.innerHTML='';
    CONTEXT.forEach(c=>{
      const div=document.createElement('div'); div.innerHTML=`
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" value="${c.id}"> ${c.label}
        </label>`;
      cBox.appendChild(div);
    });
  }

  // Sidebar steps
  const stepNames=['Definici√≥n','S√≠ntomas','5 Porqu√©s','Recomendaciones','Resultados','Resumen','Plantillas'];
  function renderSteps(){
    const nav=$('#steps'); nav.innerHTML='';
    stepNames.forEach((n,i)=>{
      const el=document.createElement('div');
      el.className='step'+(i===0?' active':''); el.dataset.step=(i+1);
      el.innerHTML=`<span class="num">${i+1}</span><div>${i+1}) ${n}</div>`;
      el.onclick=()=>scrollToStep(i+1);
      nav.appendChild(el);
    });
  }
  function scrollToStep(num){
    const el=document.querySelector(`section.card[data-step="${num}"]`);
    if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
  }
  function highlightOnScroll(){
    const cards=$$('#content section.card');
    const io=new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          $$('#steps .step').forEach(s=>s.classList.remove('active'));
          const st=e.target.getAttribute('data-step');
          const btn=$(`#steps .step[data-step="${st}"]`); if(btn) btn.classList.add('active');
        }
      });
    },{rootMargin:'-50% 0px -40% 0px',threshold:.01});
    cards.forEach(c=>io.observe(c));
  }

  // 5 Whys
  function addWhyRow(text=''){
    const tb=$('#whyTable tbody');
    const idx=tb.children.length+1;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="width:60px">${idx}</td>
      <td><input placeholder="Porque..." value="${text}"></td>
      <td class="row-actions">
        <button class="btn" onclick="moveRow(this,-1,'whyTable')">‚¨Ü</button>
        <button class="btn" onclick="moveRow(this,1,'whyTable')">‚¨á</button>
        <button class="btn" onclick="this.closest('tr').remove(); renumberWhy();">‚úñ</button>
      </td>`;
    tb.appendChild(tr);
  }
  function renumberWhy(){ $$('#whyTable tbody tr').forEach((tr,i)=> tr.children[0].textContent=i+1); }
  function moveRow(btn,dir,tableId){
    const tr=btn.closest('tr'); const tb=$('#'+tableId+' tbody');
    const idx=[...tb.children].indexOf(tr); const target=idx+dir;
    if(target<0 || target>=tb.children.length)return;
    tb.insertBefore(tr, tb.children[target+(dir>0?1:0)]);
    if(tableId==='whyTable') renumberWhy();
  }
  window.moveRow=moveRow; window.renumberWhy=renumberWhy;

  // Checklist
  function addCheckRow(row={tarea:'',resp:'',fecha:'',status:'Pendiente'}){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input placeholder="Tarea" value="${row.tarea||''}"></td>
      <td><input placeholder="Responsable" value="${row.resp||''}"></td>
      <td><input type="date" value="${row.fecha||''}"></td>
      <td>
        <select>
          <option ${row.status==='Pendiente'?'selected':''}>Pendiente</option>
          <option ${row.status==='En curso'?'selected':''}>En curso</option>
          <option ${row.status==='Hecha'?'selected':''}>Hecha</option>
          <option ${row.status==='Bloqueada'?'selected':''}>Bloqueada</option>
        </select>
      </td>
      <td class="row-actions">
        <button class="btn" onclick="moveRow(this,-1,'checkTable')">‚¨Ü</button>
        <button class="btn" onclick="moveRow(this,1,'checkTable')">‚¨á</button>
        <button class="btn" onclick="this.closest('tr').remove()">‚úñ</button>
      </td>`;
    $('#checkTable tbody').appendChild(tr);
  }
  function getCheckRows(){
    return $$('#checkTable tbody tr').map(tr=>({
      tarea: tr.children[0].querySelector('input').value.trim(),
      resp: tr.children[1].querySelector('input').value.trim(),
      fecha: tr.children[2].querySelector('input').value,
      status: tr.children[3].querySelector('select').value,
    })).filter(r=>r.tarea||r.resp||r.fecha);
  }

  // Motor de reglas
  function getSelected(container){ return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value); }
  function runEngine(){
    const selS = getSelected($('#symptoms'));
    const selC = getSelected($('#context'));
    const scored = [];
    RULES.forEach(r=>{
      const hitS = r.ifAny.some(id=>selS.includes(id));
      const hitC = r.ifContextAny? r.ifContextAny.some(id=>selC.includes(id)) : true;
      if(hitS && hitC){
        scored.push({r,score:r.score + (selS.length+selC.length)/10});
      }
    });
    scored.sort((a,b)=>b.score-a.score);

    const out = {inmediatas:[], correctivas:[], preventivas:[]};
    scored.forEach(({r})=>{
      r.acciones.inmediata.forEach(a=> out.inmediatas.push(a));
      r.acciones.correctiva.forEach(a=> out.correctivas.push(a));
      r.acciones.preventiva.forEach(a=> out.preventivas.push(a));
    });

    // de-duplicar manteniendo orden
    const uniq = arr => [...new Set(arr)];
    renderList('#actInmediatas', uniq(out.inmediatas));
    renderList('#actCorrectivas', uniq(out.correctivas));
    renderList('#actPreventivas', uniq(out.preventivas));

    // Autollenar checklist b√°sico
    $('#checkTable tbody').innerHTML='';
    uniq(out.inmediatas).slice(0,3).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));
    uniq(out.correctivas).slice(0,3).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));
    uniq(out.preventivas).slice(0,2).forEach(t=>addCheckRow({tarea:t,status:'Pendiente'}));
    toast('Sugerencias generadas');
  }
  function renderList(sel, items){
    const ul=$(sel); ul.innerHTML='';
    if(items.length===0){ ul.innerHTML='<li><span class="pill">Sin coincidencias, ajusta s√≠ntomas/contexto</span></li>'; return; }
    items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
  }

  // KPI gr√°fico
  let kpiChart;
  function updateKPI(){
    const b=parseFloat($('#kpiBefore').value||'');
    const a=parseFloat($('#kpiAfter').value||'');
    const badge=$('#kpiBadge');
    if(!isNaN(b)&&!isNaN(a)){
      const diff=a-b; const perc=(a-b)/(Math.abs(b)>0?Math.abs(b):1)*100;
      badge.textContent=`Cambio: ${perc.toFixed(1)}% (${b} ‚Üí ${a})`;
      badge.className='badge ' + (a<=b?'ok':'danger');
      const ctx=$('#kpiChart').getContext('2d');
      if(kpiChart)kpiChart.destroy();
      kpiChart=new Chart(ctx,{type:'bar',data:{labels:['Antes','Despu√©s'],datasets:[{label:'KPI',data:[b,a]}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }
  }

  // Resumen CAPA
  function genResumen(){
    const s = getState();
    const selS = getSelected($('#symptoms')).map(id=>SYMPTOMS.find(x=>x.id===id)?.label).filter(Boolean);
    const selC = getSelected($('#context')).map(id=>CONTEXT.find(x=>x.id===id)?.label).filter(Boolean);
    const why = $$('#whyTable tbody tr').map((tr,i)=>`${i+1}. ${tr.children[1].querySelector('input').value}`).filter(t=>t && !/^(\s|-)?$/.test(t)).join('\n');
    const chk = getCheckRows().map(r=>`| ${r.tarea} | ${r.resp||'-'} | ${r.fecha||'-'} | ${r.status} |`).join('\n');

    const md = `# CAPA ‚Äî ${s.title||'Sin t√≠tulo'}
**√Årea/Equipo:** ${s.area||'-'}  \n**Fecha/Turno:** ${s.date||'-'} / ${s.shift||'-'}  \n**Impacto:** ${s.impact||'-'}

## Problema
${s.desc||'-'}

## S√≠ntomas y contexto
- **S√≠ntomas:** ${selS.join(', ')||'-'}
- **Contexto:** ${selC.join(', ')||'-'}
- **Notas:** ${s.notes||'-'}

## 5 Porqu√©s
${why || '-'}

## Acciones
**Inmediatas:**\n${getListText('#actInmediatas')}\n
**Correctivas:**\n${getListText('#actCorrectivas')}\n
**Preventivas:**\n${getListText('#actPreventivas')}\n

## Resultados
${kpiText()}

## Checklist
| Tarea | Responsable | Fecha | Estatus |
|---|---|---|---|
${chk || '| ‚Äî | ‚Äî | ‚Äî | ‚Äî |'}
`;
    $('#resumen').value = md.trim();
    toast('Resumen generado');
  }
  function getListText(sel){
    const items = Array.from($(sel).children).map(li=>`- ${li.textContent}`);
    return items.length? items.join('\n') : '-';
  }
  function kpiText(){
    const b=$('#kpiBefore').value, a=$('#kpiAfter').value;
    return (b && a) ? `Antes: **${b}** ‚Üí Despu√©s: **${a}**` : '-';
    }

  // Guardar / cargar / exportar
  function getState(){
    return {
      title:$('#title').value, area:$('#area').value, impact:$('#impact').value, date:$('#date').value, shift:$('#shift').value,
      desc:$('#desc').value, notes:$('#notes').value,
      symptoms: getSelected($('#symptoms')), context: getSelected($('#context')),
      why: $$('#whyTable tbody tr').map(tr=> tr.children[1].querySelector('input').value),
      acciones:{
        inmediatas: Array.from($('#actInmediatas').children).map(li=>li.textContent),
        correctivas: Array.from($('#actCorrectivas').children).map(li=>li.textContent),
        preventivas: Array.from($('#actPreventivas').children).map(li=>li.textContent),
      },
      checklist: getCheckRows(),
      kpiBefore: $('#kpiBefore').value, kpiAfter: $('#kpiAfter').value,
      resumen: $('#resumen').value
    };
  }
  function setState(s){
    $('#title').value=s.title||''; $('#area').value=s.area||''; $('#impact').value=s.impact||'';
    $('#date').value=s.date||''; $('#shift').value=s.shift||'D√≠a';
    $('#desc').value=s.desc||''; $('#notes').value=s.notes||'';
    // checkboxes
    $$('#symptoms input[type="checkbox"]').forEach(cb=> cb.checked = (s.symptoms||[]).includes(cb.value));
    $$('#context input[type="checkbox"]').forEach(cb=> cb.checked = (s.context||[]).includes(cb.value));
    // why
    $('#whyTable tbody').innerHTML=''; (s.why&&s.why.length?s.why:['']).forEach(w=>addWhyRow(w));
    // acciones
    renderList('#actInmediatas', s.acciones?.inmediatas||[]);
    renderList('#actCorrectivas', s.acciones?.correctivas||[]);
    renderList('#actPreventivas', s.acciones?.preventivas||[]);
    // checklist
    $('#checkTable tbody').innerHTML=''; (s.checklist&&s.checklist.length?s.checklist:[{status:'Pendiente'}]).forEach(r=>addCheckRow(r));
    // KPI
    $('#kpiBefore').value=s.kpiBefore||''; $('#kpiAfter').value=s.kpiAfter||''; updateKPI();
    // resumen
    $('#resumen').value=s.resumen||'';
  }
  function saveLocal(){ localStorage.setItem(stateKey, JSON.stringify(getState())); toast('Guardado local'); }
  function loadLocal(){
    const raw=localStorage.getItem(stateKey);
    if(!raw){ toast('No hay guardado local'); return; }
    try{ setState(JSON.parse(raw)); toast('Cargado'); }catch(e){ alert('Error: '+e.message); }
  }

  // Plantillas
  function renderTemplates(){
    const sel=$('#template'); sel.innerHTML='';
    TEMPLATES.forEach(t=>{
      const o=document.createElement('option'); o.value=t.id; o.textContent=t.nombre; sel.appendChild(o);
    });
  }
  function applyTemplate(){
    const id=$('#template').value;
    const t=TEMPLATES.find(x=>x.id===id); if(!t) return;
    $('#title').value=t.fill.title; $('#area').value=t.fill.area; $('#impact').value=t.fill.impact; $('#desc').value=t.fill.desc; $('#notes').value=t.fill.notes;
    $$('#symptoms input[type="checkbox"]').forEach(cb=> cb.checked = t.fill.symptoms.includes(cb.value));
    $$('#context input[type="checkbox"]').forEach(cb=> cb.checked = t.fill.context.includes(cb.value));
    $('#whyTable tbody').innerHTML=''; ['Porque la rebaba cort√≥ el cable','Porque el cable qued√≥ en trayectoria de viruta','Porque el soporte posiciona el sensor en zona expuesta','Porque no hay protector/recubrimiento','Porque no existe est√°ndar de instalaci√≥n'].forEach(w=>addWhyRow(w));
    toast('Plantilla aplicada');
  }

  // Export/Import/Print
  function exportJSON(){
    const blob=new Blob([JSON.stringify(getState(),null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=(($('#title').value.trim())||'caso')+'.json'; a.click(); URL.revokeObjectURL(a.href);
  }
  function importJSON(file){
    const reader=new FileReader();
    reader.onload=()=>{ try{ setState(JSON.parse(reader.result)); toast('Importado'); }catch(e){ alert('JSON inv√°lido: '+e.message); } };
    reader.readAsText(file);
  }

  // Eventos
  document.getElementById('addWhy').onclick=()=>addWhyRow();
  document.getElementById('clearWhy').onclick=()=>{ $('#whyTable tbody').innerHTML=''; addWhyRow(); };
  document.getElementById('runEngine').onclick=runEngine;
  document.getElementById('addCheck').onclick=()=>addCheckRow();
  document.getElementById('clearCheck').onclick=()=>{ $('#checkTable tbody').innerHTML=''; addCheckRow(); };
  document.getElementById('kpiBefore').addEventListener('input',updateKPI);
  document.getElementById('kpiAfter').addEventListener('input',updateKPI);
  document.getElementById('genResumen').onclick=genResumen;
  document.getElementById('save').onclick=saveLocal;
  document.getElementById('load').onclick=loadLocal;
  document.getElementById('exportJSON').onclick=exportJSON;
  document.getElementById('importJSON').addEventListener('change',e=>{ const f=e.target.files[0]; if(f) importJSON(f); });
  document.getElementById('print').onclick=()=>window.print();
  document.getElementById('newCase').onclick=()=>{ if(confirm('¬øLimpiar todo?')){ localStorage.removeItem(stateKey); location.reload(); } };
  document.getElementById('applyTemplate').onclick=applyTemplate;

  // Init
  function init(){
    renderOptions(); renderSteps(); highlightOnScroll(); renderTemplates();
    addWhyRow(); addCheckRow();
  }
  init();
</script>
</body>
</html>
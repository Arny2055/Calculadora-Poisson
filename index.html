<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Backtesting ROI – Herramienta Completa</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h2 { color: #222; }
    .box {
        padding: 15px; background: white; border-radius: 8px;
        margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    input[type="file"], input[type="date"] {
        padding: 10px; margin-top: 8px; width: 100%;
    }
    button {
        padding: 12px; margin-top: 12px; width: 100%;
        background: #007bff; color: white; border: none;
        border-radius: 6px; cursor: pointer; font-size: 16px;
    }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; text-align: left; }
    th { background: #007bff; color: white; }
</style>
</head>
<body>

<h1>Backtesting ROI – Historial vs Partidos Futuros</h1>

<div class="box">
    <h2>1. Cargar archivo de HISTORIAL (JSON)</h2>
    <input type="file" id="historialFile" accept=".json">
</div>

<div class="box">
    <h2>2. Cargar archivo de PARTIDOS FUTUROS (JSON)</h2>
    <input type="file" id="futurosFile" accept=".json">
</div>

<div class="box">
    <h2>3. Filtrar por Fecha (opcional)</h2>
    <input type="date" id="fechaFiltro">
</div>

<div class="box">
    <button id="runBacktesting">Ejecutar Backtesting</button>
</div>

<div class="box">
    <h2>Resultados</h2>
    <div id="resultados"></div>
</div>

<script>
let historialData = [];
let futurosData = [];

// ----------------------
// LECTURA HISTORIAL
// ----------------------
document.getElementById("historialFile").addEventListener("change", function(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            historialData = JSON.parse("[" + e.target.result.replace(/}\s*,\s*{/g, "},{") + "]");
            alert("Historial cargado: " + historialData.length + " registros.");
        } catch {
            alert("Error al leer archivo de historial.");
        }
    };
    reader.readAsText(file);
});

// ----------------------
// LECTURA FUTUROS
// ----------------------
document.getElementById("futurosFile").addEventListener("change", function(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            futurosData = JSON.parse("[" + e.target.result.replace(/}\s*,\s*{/g, "},{") + "]");
            alert("Partidos futuros cargados: " + futurosData.length + " registros.");
        } catch {
            alert("Error al leer archivo de partidos futuros.");
        }
    };
    reader.readAsText(file);
});

// ----------------------
// BACKTESTING
// ----------------------
document.getElementById("runBacktesting").addEventListener("click", function() {

    if (historialData.length === 0 || futurosData.length === 0) {
        alert("Debes cargar ambos archivos.");
        return;
    }

    const fechaFiltro = document.getElementById("fechaFiltro").value;

    let futurosFiltrados = futurosData;

    if (fechaFiltro) {
        futurosFiltrados = futurosData.filter(p =>
            convertirFecha(p.Date) === fechaFiltro
        );
    }

    if (futurosFiltrados.length === 0) {
        alert("No hay partidos futuros en la fecha seleccionada.");
        return;
    }

    let bank = 100;
    let ganados = 0;
    let perdidos = 0;

    let detalle = [];

    futurosFiltrados.forEach(pf => {
        const [home, away] = pf.Match.split(" - ").map(s => s.trim());

        const encontrados = historialData.filter(h =>
            h.Match.includes(home) || h.Match.includes(away)
        );

        encontrados.forEach(hist => {
            const odd = parseFloat(hist.Odd);
            if (!isNaN(odd)) {

                let roiBet = -1; // default perder

                if (hist.Result === "Winning") {
                    bank += odd - 1;
                    ganados++;
                    roiBet = odd - 1;
                } else {
                    bank -= 1;
                    perdidos++;
                }

                detalle.push({
                    partido: hist.Match,
                    odd: odd,
                    result: hist.Result,
                    roi: roiBet
                });
            }
        });
    });

    // ORDENAR POR ROI de mayor a menor
    detalle.sort((a, b) => b.roi - a.roi);

    const roiFinal = ((bank - 100) / 100 * 100).toFixed(2);

    mostrarResultados(bank, ganados, perdidos, roiFinal, detalle);
});

// ----------------------
// UTILIDAD
// ----------------------
function convertirFecha(texto) {
    try {
        const partes = texto.match(/\d{1,2} \w+\.? \d{4}/);
        if (!partes) return "";
        const fecha = new Date(partes[0]);
        return fecha.toISOString().split("T")[0];
    } catch {
        return "";
    }
}

// ----------------------
// MOSTRAR RESULTADOS
// ----------------------
function mostrarResultados(bank, ganados, perdidos, roi, detalle) {
    let html = `
        <h3>Resumen</h3>
        <p><strong>Bank final:</strong> ${bank.toFixed(2)}</p>
        <p><strong>Ganados:</strong> ${ganados}</p>
        <p><strong>Perdidos:</strong> ${perdidos}</p>
        <p><strong>ROI Total:</strong> ${roi}%</p>

        <h3>Detalle de apuestas (ordenado por ROI)</h3>
        <table>
            <tr>
                <th>Partido</th>
                <th>Odd</th>
                <th>Resultado</th>
                <th>ROI</th>
            </tr>
    `;

    detalle.forEach(d => {
        html += `
            <tr>
                <td>${d.partido}</td>
                <td>${d.odd}</td>
                <td>${d.result}</td>
                <td>${d.roi.toFixed(2)}</td>
            </tr>`;
    });

    html += "</table>";

    document.getElementById("resultados").innerHTML = html;
}
</script>

</body>
</html>
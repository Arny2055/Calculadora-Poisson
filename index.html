<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS: Calculadora Poisson Gemini Avanzada</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Paleta Gemini Avanzada */
        :root {
            --color-bg-dark: #0f111a;        /* Fondo muy oscuro, casi negro */
            --color-bg-card: #181b24;        /* Fondo de tarjetas y secciones */
            --color-primary: #00bcd4;        /* Azul Cian brillante (Headers, títulos) */
            --color-secondary: #4caf50;      /* Verde para acciones y éxito */
            --color-text-light: #e0e0e0;     /* Texto principal */
            --color-text-muted: #9aa0a6;     /* Texto secundario/etiquetas */
            --color-border: #2c3140;         /* Bordes sutiles */
            --color-highlight: #ffc107;      /* Amarillo/Dorado para resultados clave */
            --color-lambda: #ff7043;         /* Naranja para Lambdas */
            --color-most-likely: #ff4081;    /* Rosa Fuerte para destacar el más probable */
        }

        /* Estilos Generales y Tipografía */
        body { 
            font-family: 'Montserrat', sans-serif; 
            margin: 0; 
            padding: 30px;
            background-color: var(--color-bg-dark); 
            color: var(--color-text-light); 
            line-height: 1.6;
            transition: background-color 0.5s;
        }
        .container { 
            max-width: 1300px;
            margin: auto; 
            background: var(--color-bg-card); 
            padding: 35px; 
            border-radius: 16px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); 
        }
        h1 { 
            color: var(--color-primary); 
            text-align: center; 
            margin-bottom: 35px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.4); 
        }
        h2 {
            color: var(--color-text-light);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
            margin-top: 30px;
            font-size: 1.6em;
            font-weight: 600;
        }
        h3 {
            color: var(--color-primary);
            font-size: 1.2em;
            margin-top: 15px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* Controles de Entrada (Input Grid) */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            padding: 20px;
            border: 1px solid var(--color-border);
            border-radius: 10px;
            background-color: #1f232e;
        }
        label { 
            display: block; 
            margin-top: 10px; 
            font-weight: 400; 
            color: var(--color-text-muted); 
            font-size: 0.9em;
        }
        input[type="number"] { 
            width: 100%; 
            padding: 12px; 
            margin-top: 5px; 
            border: 1px solid var(--color-border); 
            border-radius: 8px; 
            box-sizing: border-box; 
            background-color: #242830; 
            color: var(--color-text-light); 
            font-size: 1.1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="number"]:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.6);
            outline: none;
        }

        /* Botón de Cálculo (Enhanced) */
        button { 
            background-color: var(--color-secondary); 
            color: var(--color-bg-dark); 
            padding: 18px 25px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 1.3em; 
            font-weight: 700;
            margin-top: 30px; 
            width: 100%; 
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        button:hover { 
            background-color: #43a047; 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
        }

        /* Indicadores Lambda */
        .lambda-display {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            font-size: 1.2em;
        }
        .lambda-value {
            padding: 10px 15px;
            border-radius: 8px;
            background-color: #2c3140;
            border-left: 5px solid var(--color-lambda);
        }
        .lambda-value .resultado {
            color: var(--color-lambda);
            font-weight: 700;
        }

        /* Resultados y Tablas (Cards) */
        .results-flex-row {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px;
            margin-bottom: 20px;
        }
        .results-flex-row > div {
            flex: 1 1 30%; 
            background-color: #1f232e;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            min-width: 300px; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
        }
        th, td { 
            border: none;
            padding: 10px; 
            text-align: left; 
            font-size: 0.95em;
        }
        th { 
            background-color: #2c3140; 
            color: var(--color-primary);
            font-weight: 600;
        }
        td {
            background-color: #1f232e;
            border-bottom: 1px solid var(--color-border);
        }
        td:last-child {
            font-weight: 600;
        }
        .resultado { 
            font-weight: 700; 
            color: var(--color-highlight); 
        }
        
        /* Módulo de Sugerencias (Destacado) */
        .suggestions-box {
            border: 2px solid var(--color-highlight); 
            background-color: #2c3140; 
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
            margin-top: 25px;
        }
        .suggestions-box h2 {
            color: var(--color-highlight);
            border-bottom: 1px solid var(--color-highlight);
        }
        #suggested_markets p {
            font-size: 1.15em;
            margin: 10px 0;
            padding: 12px;
            background-color: #383d47;
            border-left: 6px solid var(--color-secondary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            transition: all 0.3s; /* Transición para el efecto hover/destacado */
        }
        
        /* Estilo para el mercado más probable (Máxima Visibilidad) */
        #suggested_markets p.most-likely {
            background-color: #4a148c; /* Morado Oscuro */
            border: 2px solid var(--color-most-likely);
            border-left: 10px solid var(--color-most-likely); 
            color: #ffffff;
            font-weight: 700;
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(255, 64, 129, 0.8); /* Sombra intensa */
        }
        #suggested_markets p:hover {
            transform: scale(1.01);
            background-color: #3f4450;
        }

        #suggested_markets .market-item {
            color: var(--color-secondary);
            font-weight: 700;
            margin-right: 15px;
        }
        #suggested_markets p.most-likely .market-item {
            color: var(--color-highlight); /* Texto amarillo/dorado en el más probable */
        }
        #suggested_markets p::before {
            content: "✅"; 
            margin-right: 10px;
            font-size: 1.2em;
        }
        #suggested_markets p.most-likely::before {
            content: "🔥"; /* Fuego para el más probable */
        }

        /* Estilos de Top Scores */
        .score-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .score-list li {
            background-color: #1f232e;
            flex: 1 1 300px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            font-size: 1.1em;
        }
        .score-list li .resultado {
            color: var(--color-primary);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>✨ BetAGS: Calculadora Poisson Gemini Avanzada ✨</h1>

    <div class="input-group">
        <h2>📊 Parámetros de Goles (Entrada de Datos)</h2>
        
        <div class="input-grid">
            <div>
                <h3>Liga (Base del Modelo)</h3>
                <label for="gl_l">Goles Promedio Local Liga ($\text{GL}_{\text{L}}$):</label>
                <input type="number" id="gl_l" value="1.5" step="0.01">
                <label for="gl_v">Goles Promedio Visitante Liga ($\text{GL}_{\text{V}}$):</label>
                <input type="number" id="gl_v" value="1.2" step="0.01">
            </div>
            
            <div>
                <h3>Equipo Local (Ataque y Defensa)</h3>
                <label for="gf_l">Goles a Favor Local (en casa):</label>
                <input type="number" id="gf_l" value="1.8" step="0.01">
                <label for="gc_l">Goles En Contra Local (en casa):</label>
                <input type="number" id="gc_l" value="0.9" step="0.01">
            </div>
            
            <div>
                <h3>Equipo Visitante (Ataque y Defensa)</h3>
                <label for="gf_v">Goles a Favor Visitante (fuera):</label>
                <input type="number" id="gf_v" value="1.4" step="0.01">
                <label for="gc_v">Goles En Contra Visitante (fuera):</label>
                <input type="number" id="gc_v" value="1.3" step="0.01">
            </div>
        </div>
    </div>

    <button onclick="calcularPoisson()">Calcular TODOS los Mercados 🚀</button>

    <div id="resultados" style="display:none;">
        
        <div class="suggestions-box">
            <h2 style="color: var(--color-highlight);">🎯 Análisis de Valor (Probabilidad 60.0% - 70.0%)</h2>
            <div id="suggested_markets">
                <p>Calculando sugerencias...</p>
            </div>
        </div>

        <h2 style="margin-top: 30px;">📈 Proyecciones del Partido</h2>
        
        <div class="lambda-display">
            <div class="lambda-value">
                Local ($\lambda_{\text{L}}$): <span id="lambda_l" class="resultado"></span>
            </div>
            <div class="lambda-value">
                Visitante ($\lambda_{\text{V}}$): <span id="lambda_v" class="resultado"></span>
            </div>
        </div>

        <div class="results-flex-row">
            
            <div>
                <h3>🏆 1X2, DNB y Doble Opción</h3>
                <table>
                    <thead><tr><th>Mercado</th><th>Prob.</th><th>Cuota</th></tr></thead>
                    <tbody>
                        <tr><td>**1X2** - Local (1)</td><td id="p_1" class="resultado"></td><td id="q_1" class="resultado"></td></tr>
                        <tr><td>**1X2** - Empate (X)</td><td id="p_x" class="resultado"></td><td id="q_x" class="resultado"></td></tr>
                        <tr><td>**1X2** - Visitante (2)</td><td id="p_2" class="resultado"></td><td id="q_2" class="resultado"></td></tr>
                        
                        <tr><td>**DNB** - Local (1)</td><td id="p_dnb1" class="resultado"></td><td id="q_dnb1" class="resultado"></td></tr>
                        <tr><td>**DNB** - Visitante (2)</td><td id="p_dnb2" class="resultado"></td><td id="q_dnb2" class="resultado"></td></tr>

                        <tr><td>**Doble Opción** - 1X</td><td id="p_1x" class="resultado"></td><td id="q_1x" class="resultado"></td></tr>
                        <tr><td>**Doble Opción** - X2</td><td id="p_x2" class="resultado"></td><td id="q_x2" class="resultado"></td></tr>
                        <tr><td>**Doble Opción** - 12</td><td id="p_12" class="resultado"></td><td id="q_12" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>

            <div>
                <h3>⚽ Goles Totales (Over/Under)</h3>
                <table>
                    <thead><tr><th>Mercado</th><th>Prob.</th><th>Cuota</th></tr></thead>
                    <tbody>
                        <tr><td>**Over 1.5**</td><td id="p_over15" class="resultado"></td><td id="q_over15" class="resultado"></td></tr>
                        <tr><td>**Under 1.5**</td><td id="p_under15" class="resultado"></td><td id="q_under15" class="resultado"></td></tr>
                        <tr><td>**Over 2.5**</td><td id="p_over25" class="resultado"></td><td id="q_over25" class="resultado"></td></tr>
                        <tr><td>**Under 2.5**</td><td id="p_under25" class="resultado"></td><td id="q_under25" class="resultado"></td></tr>
                        <tr><td>**Over 3.5**</td><td id="p_over35" class="resultado"></td><td id="q_over35" class="resultado"></td></tr>
                        <tr><td>**Under 3.5**</td><td id="p_under35" class="resultado"></td><td id="q_under35" class="resultado"></td></tr>
                        <tr><td>**Over 4.5**</td><td id="p_over45" class="resultado"></td><td id="q_over45" class="resultado"></td></tr>
                        <tr><td>**Under 4.5**</td><td id="p_under45" class="resultado"></td><td id="q_under45" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>

            <div>
                <h3>🥅 Goles por Equipo y BTTS</h3>
                <table>
                    <thead><tr><th>Mercado</th><th>Prob.</th><th>Cuota</th></tr></thead>
                    <tbody>
                        <tr><td>**Ambos Anotan** (Sí)</td><td id="p_btts_yes" class="resultado"></td><td id="q_btts_yes" class="resultado"></td></tr>
                        <tr><td>**Ambos Anotan** (No)</td><td id="p_btts_no" class="resultado"></td><td id="q_btts_no" class="resultado"></td></tr>
                        <tr><td>Local **Over 1.5**</td><td id="p_l_over15" class="resultado"></td><td id="q_l_over15" class="resultado"></td></tr>
                        <tr><td>Local **Under 1.5**</td><td id="p_l_under15" class="resultado"></td><td id="q_l_under15" class="resultado"></td></tr>
                        <tr><td>Visitante **Over 1.5**</td><td id="p_v_over15" class="resultado"></td><td id="q_v_over15" class="resultado"></td></tr>
                        <tr><td>Visitante **Under 1.5**</td><td id="p_v_under15" class="resultado"></td><td id="q_v_under15" class="resultado"></td></tr>
                        <tr><td>Local **Over 2.5**</td><td id="p_l_over25" class="resultado"></td><td id="q_l_over25" class="resultado"></td></tr>
                        <tr><td>Visitante **Over 2.5**</td><td id="p_v_over25" class="resultado"></td><td id="q_v_over25" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <h2 style="margin-top: 30px;">🎁 Handicap Asiático (Goles) - Probabilidades de Ganar</h2>
        <div class="results-flex-row">
             <div>
                <h3>HA - Goles Totales</h3>
                <table>
                    <thead><tr><th>Mercado</th><th>Prob. (Over)</th><th>Prob. (Under)</th></tr></thead>
                    <tbody>
                        <tr><td>**HA 2.0** (DNB)</td><td id="p_ha20_ov" class="resultado"></td><td id="p_ha20_un" class="resultado"></td></tr>
                        <tr><td>**HA 2.25** (Media)</td><td id="p_ha225_ov" class="resultado"></td><td id="p_ha225_un" class="resultado"></td></tr>
                        <tr><td>**HA 2.5** (Total)</td><td id="p_ha25_ov" class="resultado"></td><td id="p_ha25_un" class="resultado"></td></tr>
                        <tr><td>**HA 2.75** (Media)</td><td id="p_ha275_ov" class="resultado"></td><td id="p_ha275_un" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>
            <div>
                <h3>HA - Goles Local</h3>
                <table>
                    <thead><tr><th>Mercado</th><th>Prob. (Over)</th><th>Prob. (Under)</th></tr></thead>
                    <tbody>
                        <tr><td>Local **HA 1.0**</td><td id="p_l_ha10_ov" class="resultado"></td><td id="p_l_ha10_un" class="resultado"></td></tr>
                        <tr><td>Local **HA 1.25**</td><td id="p_l_ha125_ov" class="resultado"></td><td id="p_l_ha125_un" class="resultado"></td></tr>
                        <tr><td>Local **HA 1.5**</td><td id="p_l_ha15_ov" class="resultado"></td><td id="p_l_ha15_un" class="resultado"></td></tr>
                        <tr><td>Local **HA 1.75**</td><td id="p_l_ha175_ov" class="resultado"></td><td id="p_l_ha175_un" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>
            <div>
                <h3>HA - Goles Visitante</h3>
                 <table>
                    <thead><tr><th>Mercado</th><th>Prob. (Over)</th><th>Prob. (Under)</th></tr></thead>
                    <tbody>
                        <tr><td>Visitante **HA 1.0**</td><td id="p_v_ha10_ov" class="resultado"></td><td id="p_v_ha10_un" class="resultado"></td></tr>
                        <tr><td>Visitante **HA 1.25**</td><td id="p_v_ha125_ov" class="resultado"></td><td id="p_v_ha125_un" class="resultado"></td></tr>
                        <tr><td>Visitante **HA 1.5**</td><td id="p_v_ha15_ov" class="resultado"></td><td id="p_v_ha15_un" class="resultado"></td></tr>
                        <tr><td>Visitante **HA 1.75**</td><td id="p_v_ha175_ov" class="resultado"></td><td id="p_v_ha175_un" class="resultado"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>


        <h2 style="margin-top: 30px;">🥇 Top 5 Marcadores Exactos</h2>
        <ul id="top_scores" class="score-list">
            </ul>
    </div>
</div>

<script>
    // --- Lógica Matemática y de Cálculo ---

    // Rango de Probabilidad Deseado (60% a 70%)
    const MIN_PROB = 0.60;
    const MAX_PROB = 0.70;

    // Función Factorial
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }

    // Distribución de Poisson
    function poisson(k, lambda) {
        if (lambda <= 0) return 0;
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }
    
    // Función para formatear las probabilidades a porcentaje
    const formatP = (p) => isNaN(p) ? 'N/A' : (p * 100).toFixed(2) + '%';
    
    // Función para calcular la Cuota Implícita (1 / Probabilidad)
    const calculateOdd = (p) => p > 0 ? (1 / p).toFixed(2) : 'N/A';
    
    // Función para calcular la probabilidad acumulada P(Goles <= K)
    function p_under_k(k, p_cumulativa) {
        if (k < 0) return 0;
        const index = Math.floor(k);
        return p_cumulativa[index] || 0;
    }
    
    // Función principal de cálculo
    function calcularPoisson() {
        // 1. Obtener datos de entrada
        const GL_L = parseFloat(document.getElementById('gl_l').value); 
        const GL_V = parseFloat(document.getElementById('gl_v').value); 
        const GF_L = parseFloat(document.getElementById('gf_l').value); 
        const GC_L = parseFloat(document.getElementById('gc_l').value); 
        const GF_V = parseFloat(document.getElementById('gf_v').value); 
        const GC_V = parseFloat(document.getElementById('gc_v').value); 

        if (GL_L <= 0 || GL_V <= 0) {
            alert("Los promedios de goles de la liga deben ser mayores a 0 para calcular.");
            return;
        }

        // 2. Calcular Goles Esperados (Lambda)
        const FA_L = GF_L / GL_L; 
        const PD_V = GC_V / GL_L; 
        const FA_V = GF_V / GL_V; 
        const PD_L = GC_L / GL_V; 

        const lambda_L = FA_L * PD_V * GL_L;
        const lambda_V = FA_V * PD_L * GL_V;

        document.getElementById('lambda_l').textContent = lambda_L.toFixed(3);
        document.getElementById('lambda_v').textContent = lambda_V.toFixed(3);

        // 3. Crear la Matriz de Probabilidades (hasta 6 goles) y acumulados
        const MAX_GOALS = 6; 
        let p_1 = 0, p_x = 0, p_2 = 0; 
        let p_total_goles = {}; 
        let top_scores_list = []; 
        
        let p_local_cumulativa = [poisson(0, lambda_L)];
        let p_visitante_cumulativa = [poisson(0, lambda_V)];

        for (let i = 0; i <= MAX_GOALS; i++) { // Goles Local (gL)
            let p_gL = poisson(i, lambda_L);
            if (i > 0) p_local_cumulativa.push((p_local_cumulativa[i-1] || 0) + p_gL);
            
            for (let j = 0; j <= MAX_GOALS; j++) { // Goles Visitante (gV)
                let p_gV = poisson(j, lambda_V);
                if (i === 0 && j > 0) p_visitante_cumulativa.push((p_visitante_cumulativa[j-1] || 0) + p_gV);

                let p_score = p_gL * p_gV;
                top_scores_list.push({ score: `${i}-${j}`, prob: p_score });

                if (i > j) { p_1 += p_score; } 
                else if (i === j) { p_x += p_score; } 
                else { p_2 += p_score; }

                const total = i + j;
                p_total_goles[total] = (p_total_goles[total] || 0) + p_score;
            }
        }
        
        // Probabilidad acumulada total
        let p_total_cumulativa = [p_total_goles[0] || 0];
        for (let t = 1; t <= MAX_GOALS * 2; t++) {
             p_total_cumulativa.push((p_total_cumulativa[t-1] || 0) + (p_total_goles[t] || 0));
        }

        // 4. Ajustar 1X2 para que sume 100%
        const p_total_scores = p_1 + p_x + p_2;
        if (p_total_scores > 0) {
            const ratio = 1 / p_total_scores;
            p_1 *= ratio;
            p_x *= ratio;
            p_2 *= ratio;
        }

        // 5. Acumular y Calcular Mercados

        // Mercados 1X2, DO y DNB
        const p_1x = p_1 + p_x;
        const p_x2 = p_x + p_2;
        const p_12 = p_1 + p_2;
        const p_dnb1 = p_1 / (1 - p_x);
        const p_dnb2 = p_2 / (1 - p_x);
        
        // Ambos Anotan (BTTS)
        const p_0_0 = poisson(0, lambda_L) * poisson(0, lambda_V);
        const p_btts_no = poisson(0, lambda_L) + poisson(0, lambda_V) - p_0_0;
        const p_btts_yes = 1 - p_btts_no;

        // Over/Under (U/O K.5)
        const calc_under = (k) => p_total_cumulativa[k];
        const calc_over = (k) => 1 - calc_under(k);

        // Goles por equipo (U/O K.5)
        const calc_l_under = (k) => p_local_cumulativa[k];
        const calc_l_over = (k) => 1 - calc_l_under(k);
        const calc_v_under = (k) => p_visitante_cumulativa[k];
        const calc_v_over = (k) => 1 - calc_v_under(k);
        
        // HANDICAP ASIÁTICO (HA)
        const HA = (target) => {
            const p_under = p_under_k(target - 0.5, p_total_cumulativa);
            const p_over = 1 - p_under_k(target, p_total_cumulativa);
            const p_push = p_total_goles[target] || 0;
            return { p_under, p_over, p_push };
        };

        const HA_H = (target, lambda_h, p_h_cumulativa) => {
            const p_under = p_under_k(target - 0.5, p_h_cumulativa);
            const p_over = 1 - p_under_k(target, p_h_cumulativa);
            const p_push = poisson(target, lambda_h);
            return { p_under, p_over, p_push };
        };

        // Cálculos HA Totales
        const ha20 = HA(2); 
        const ha25 = HA(2.5); 
        const ha225_ov = 0.5 * (calc_over(2) + calc_over(3)); 
        const ha225_un = 0.5 * (calc_under(2) + calc_under(3)); 
        const ha275_ov = 0.5 * (calc_over(2.5) + calc_over(3.5)); 
        const ha275_un = 0.5 * (calc_under(2.5) + calc_under(3.5));
        
        // Cálculos HA Local
        const ha_l10 = HA_H(1, lambda_L, p_local_cumulativa);
        const ha_l15 = HA_H(1.5, lambda_L, p_local_cumulativa);
        const ha_l125_ov = 0.5 * (calc_l_over(1) + calc_l_over(2)); 
        const ha_l125_un = 0.5 * (calc_l_under(1) + calc_l_under(2)); 
        const ha_l175_ov = 0.5 * (calc_l_over(1.5) + calc_l_over(2.5));
        const ha_l175_un = 0.5 * (calc_l_under(1.5) + calc_l_under(2.5));
        
        // Cálculos HA Visitante
        const ha_v10 = HA_H(1, lambda_V, p_visitante_cumulativa);
        const ha_v15 = HA_H(1.5, lambda_V, p_visitante_cumulativa);
        const ha_v125_ov = 0.5 * (calc_v_over(1) + calc_v_over(2)); 
        const ha_v125_un = 0.5 * (calc_v_under(1) + calc_v_under(2)); 
        const ha_v175_ov = 0.5 * (calc_v_over(1.5) + calc_v_over(2.5));
        const ha_v175_un = 0.5 * (calc_v_under(1.5) + calc_v_under(2.5));

        // 6. Almacenar todos los resultados para la sugerencia
        const all_market_probs = [
            // 1X2, DO, DNB
            { name: "1 (Victoria Local)", prob: p_1, id_p: 'p_1', id_q: 'q_1' },
            { name: "X (Empate)", prob: p_x, id_p: 'p_x', id_q: 'q_x' },
            { name: "2 (Victoria Visitante)", prob: p_2, id_p: 'p_2', id_q: 'q_2' },
            { name: "DNB Local (1)", prob: p_dnb1, id_p: 'p_dnb1', id_q: 'q_dnb1' },
            { name: "DNB Visitante (2)", prob: p_dnb2, id_p: 'p_dnb2', id_q: 'q_dnb2' },
            { name: "Doble Opción 1X", prob: p_1x, id_p: 'p_1x', id_q: 'q_1x' },
            { name: "Doble Opción X2", prob: p_x2, id_p: 'p_x2', id_q: 'q_x2' },
            { name: "Doble Opción 12", prob: p_12, id_p: 'p_12', id_q: 'q_12' },
            // BTTS
            { name: "Ambos Anotan (Sí)", prob: p_btts_yes, id_p: 'p_btts_yes', id_q: 'q_btts_yes' },
            { name: "Ambos Anotan (No)", prob: p_btts_no, id_p: 'p_btts_no', id_q: 'q_btts_no' },
            // Over/Under Totales
            { name: "Over 1.5 Goles", prob: calc_over(1), id_p: 'p_over15', id_q: 'q_over15' },
            { name: "Under 1.5 Goles", prob: calc_under(1), id_p: 'p_under15', id_q: 'q_under15' },
            { name: "Over 2.5 Goles", prob: calc_over(2), id_p: 'p_over25', id_q: 'q_over25' },
            { name: "Under 2.5 Goles", prob: calc_under(2), id_p: 'p_under25', id_q: 'q_under25' },
            { name: "Over 3.5 Goles", prob: calc_over(3), id_p: 'p_over35', id_q: 'q_over35' },
            { name: "Under 3.5 Goles", prob: calc_under(3), id_p: 'p_under35', id_q: 'q_under35' },
            // Over/Under por Equipo
            { name: "Local Over 1.5 Goles", prob: calc_l_over(1), id_p: 'p_l_over15', id_q: 'q_l_over15' },
            { name: "Local Under 1.5 Goles", prob: calc_l_under(1), id_p: 'p_l_under15', id_q: 'q_l_under15' },
            { name: "Visitante Over 1.5 Goles", prob: calc_v_over(1), id_p: 'p_v_over15', id_q: 'q_v_over15' },
            { name: "Visitante Under 1.5 Goles", prob: calc_v_under(1), id_p: 'p_v_under15', id_q: 'q_v_under15' },
            { name: "Local Over 2.5 Goles", prob: calc_l_over(2), id_p: 'p_l_over25', id_q: 'q_l_over25' },
            { name: "Visitante Over 2.5 Goles", prob: calc_v_over(2), id_p: 'p_v_over25', id_q: 'q_v_over25' },
        ];


        // 7. Mostrar Resultados en Tablas y Generar Sugerencias

        const suggested_markets = [];

        all_market_probs.forEach(market => {
            const odd = parseFloat(calculateOdd(market.prob));
            
            // Llenar la tabla de resultados (Probabilidad y Cuota)
            if (document.getElementById(market.id_p)) {
                document.getElementById(market.id_p).textContent = formatP(market.prob);
            }
            if (document.getElementById(market.id_q)) {
                document.getElementById(market.id_q).textContent = odd.toFixed(2);
            }
            
            // Comprobar si la PROBABILIDAD cae en el rango deseado (0.60 a 0.70)
            if (market.prob >= MIN_PROB && market.prob <= MAX_PROB) {
                suggested_markets.push({
                    name: market.name,
                    odd: odd,
                    prob: market.prob
                });
            }
        });

        // Mostrar las sugerencias
        const suggestions_div = document.getElementById('suggested_markets');
        if (suggested_markets.length > 0) {
            suggestions_div.innerHTML = '';
            
            // 1. Ordenar por probabilidad (mayor a menor)
            suggested_markets.sort((a, b) => b.prob - a.prob);

            suggested_markets.forEach((s, index) => {
                const p = document.createElement('p');
                const implied_odd_range = `(Cuota Implícita: ≈ ${s.odd.toFixed(2)})`;
                
                let market_name_html = s.name;
                
                // 2. Marcar el más probable (el primer elemento después de ordenar)
                if (index === 0) {
                    p.classList.add('most-likely');
                    market_name_html = `🥇 ¡TOP VALOR! ${s.name}`; // Denotación más clara
                }
                
                p.innerHTML = `<span class="market-item">${market_name_html}</span>: **${formatP(s.prob)}** ${implied_odd_range}`;
                suggestions_div.appendChild(p);
            });
        } else {
            suggestions_div.innerHTML = '<p style="color: var(--color-highlight); border-left: 6px solid #e53935; background-color: #383d47;">No se encontraron mercados con una probabilidad entre 60.0% y 70.0% (Cuota 1.43-1.67).</p>';
        }

        // 8. Resultados Específicos (Handicap Asiático)
        
        // HA Goles Totales
        document.getElementById('p_ha20_ov').textContent = formatP(ha20.p_over / (1 - ha20.p_push)); 
        document.getElementById('p_ha20_un').textContent = formatP(ha20.p_under / (1 - ha20.p_push)); 
        document.getElementById('p_ha25_ov').textContent = formatP(calc_over(2)); 
        document.getElementById('p_ha25_un').textContent = formatP(calc_under(2)); 
        document.getElementById('p_ha225_ov').textContent = formatP(ha225_ov); 
        document.getElementById('p_ha225_un').textContent = formatP(ha225_un);
        document.getElementById('p_ha275_ov').textContent = formatP(ha275_ov); 
        document.getElementById('p_ha275_un').textContent = formatP(ha275_un);

        // HA Goles Local
        document.getElementById('p_l_ha10_ov').textContent = formatP(ha_l10.p_over / (1 - ha_l10.p_push));
        document.getElementById('p_l_ha10_un').textContent = formatP(ha_l10.p_under / (1 - ha_l10.p_push));
        document.getElementById('p_l_ha15_ov').textContent = formatP(calc_l_over(1));
        document.getElementById('p_l_ha15_un').textContent = formatP(calc_l_under(1));
        document.getElementById('p_l_ha125_ov').textContent = formatP(ha_l125_ov);
        document.getElementById('p_l_ha125_un').textContent = formatP(ha_l125_un);
        document.getElementById('p_l_ha175_ov').textContent = formatP(ha_l175_ov);
        document.getElementById('p_l_ha175_un').textContent = formatP(ha_l175_un);

        // HA Goles Visitante (CORREGIDO)
        document.getElementById('p_v_ha10_ov').textContent = formatP(ha_v10.p_over / (1 - ha_v10.p_push));
        document.getElementById('p_v_ha10_un').textContent = formatP(ha_v10.p_under / (1 - ha_v10.p_push));
        document.getElementById('p_v_ha15_ov').textContent = formatP(calc_v_over(1));
        document.getElementById('p_v_ha15_un').textContent = formatP(calc_v_under(1));
        document.getElementById('p_v_ha125_ov').textContent = formatP(ha_v125_ov);
        document.getElementById('p_v_ha125_un').textContent = formatP(ha_v125_un);
        document.getElementById('p_v_ha175_ov').textContent = formatP(ha_v175_ov);
        document.getElementById('p_v_ha175_un').textContent = formatP(ha_v175_un);

        // Top 5 Resultados Exactos
        top_scores_list.sort((a, b) => b.prob - a.prob);
        const top_5 = top_scores_list.slice(0, 5);
        
        const top_scores_ul = document.getElementById('top_scores');
        top_scores_ul.innerHTML = ''; 
        top_5.forEach(item => {
            const li = document.createElement('li');
            const odd = calculateOdd(item.prob);
            li.innerHTML = `**${item.score}** - Probabilidad: <span class="resultado">${formatP(item.prob)}</span> (Cuota Implícita: ${odd})`;
            top_scores_ul.appendChild(li);
        });

        document.getElementById('resultados').style.display = 'block';
    }
</script>

</body>
</html>

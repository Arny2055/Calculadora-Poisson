<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson IA - Predicciones de F√∫tbol</title>
    <style>
        :root {
            --gemini-blue: #4285F4;
            --gemini-green: #34A853;
            --gemini-yellow: #FBBC05;
            --gemini-red: #EA4335;
            --background-light: #F8F9FA;
            --card-white: #FFFFFF;
            --text-dark: #202124;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-hover: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
        }

        body {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-light);
            color: var(--text-dark);
            transition: background-color 0.3s;
        }

        .container {
            background-color: var(--card-white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-subtle);
            transition: box-shadow 0.3s;
        }

        h1 {
            color: var(--gemini-blue);
            text-align: center;
            font-weight: 500;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        h1 span { font-size: 1.5em; margin-right: 10px; }

        fieldset {
            border: 1px solid #DADCE0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        legend {
            font-weight: 500;
            color: var(--gemini-green);
            padding: 0 10px;
        }

        label {
            display: block;
            margin-top: 15px;
            font-size: 0.9em;
            color: #5F6368;
            font-weight: 500;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #DADCE0;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="number"]:focus {
            border-color: var(--gemini-blue);
            box-shadow: 0 0 0 1px var(--gemini-blue);
            outline: none;
        }

        button {
            background-color: var(--gemini-blue);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 25px;
            width: 100%;
            font-size: 1.1em;
            font-weight: 500;
            box-shadow: var(--shadow-subtle);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        button:hover {
            background-color: #3B7AEB;
            box-shadow: var(--shadow-hover);
        }

        .resultado {
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            background-color: #e6f4ea; /* light green tint */
            border-left: 5px solid var(--gemini-green);
        }

        .resultado h3 {
            margin-top: 0;
            color: var(--text-dark);
            font-weight: 500;
            border-bottom: 1px solid #DADCE0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .probabilidad-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .prob-item {
            padding: 10px;
            border-radius: 6px;
            background-color: var(--card-white);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        }

        .prob-item strong {
            display: block;
            font-size: 0.9em;
            color: #5F6368;
            margin-bottom: 5px;
        }

        .prob-value {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-dark);
        }

        .mercado-sugerido {
            padding: 15px;
            border-radius: 8px;
            background-color: #FFFDE7; /* light yellow tint */
            border: 1px solid var(--gemini-yellow);
            margin-top: 20px;
        }

        .mercado-sugerido strong {
            color: var(--gemini-red);
            display: block;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .sugerencia-over { color: var(--gemini-green); }
        .sugerencia-under { color: var(--gemini-blue); }
        .sugerencia-aa { color: var(--gemini-red); }
        .sugerencia-no-aa { color: #80868B; }
        .sugerencia-win { color: var(--gemini-blue); }
        .sugerencia-win-away { color: var(--gemini-red); }
        .sugerencia-draw { color: var(--gemini-yellow); }

        .sugerencia-list {
            margin-top: 10px;
            font-size: 1.1em;
            line-height: 1.6;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="container">
    <h1><span>‚ú®</span> Calculadora Poisson IA</h1>
    
    <form id="poisson-form">
        <fieldset>
            <legend>1. Datos Promedio de la Liga üìä</legend>
            <label for="avg_gl_home_liga">Promedio Goles Local Liga (GL a favor) (ej: 1.55)</label>
            <input type="number" id="avg_gl_home_liga" value="1.55" step="0.01" required>

            <label for="avg_gv_away_liga">Promedio Goles Visita Liga (GV a favor) (ej: 1.15)</label>
            <input type="number" id="avg_gv_away_liga" value="1.15" step="0.01" required>
            
            <label for="porc_aa">Ambos Anotan de la Liga (%) (ej: 55)</label>
            <input type="number" id="porc_aa" value="55" step="0.1" required>

            <label for="porc_over25">Over 2.5 FT de la Liga (%) (ej: 50)</label>
            <input type="number" id="porc_over25" value="50" step="0.1" required>
        </fieldset>
        
        <fieldset>
            <legend>2. Datos del Partido üèüÔ∏è</legend>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: var(--gemini-blue); margin-top: 0;">Equipo Local</h4>
                    <label for="gf_local">GF Local (Goles a Favor en casa)</label>
                    <input type="number" id="gf_local" value="25" required>

                    <label for="gc_local">GC Local (Goles en Contra en casa)</label>
                    <input type="number" id="gc_local" value="15" required>
                    
                    <label for="partidos_local">Partidos jugados como Local</label>
                    <input type="number" id="partidos_local" value="10" required>
                </div>
                <div>
                    <h4 style="color: var(--gemini-red); margin-top: 0;">Equipo Visitante</h4>
                    <label for="gf_visita">GF Visita (Goles a Favor fuera)</label>
                    <input type="number" id="gf_visita" value="18" required>
                    
                    <label for="gc_visita">GC Visita (Goles en Contra fuera)</label>
                    <input type="number" id="gc_visita" value="22" required>
                    
                    <label for="partidos_visita">Partidos jugados como Visita</label>
                    <input type="number" id="partidos_visita" value="10" required>
                </div>
            </div>
        </fieldset>
        
        <button type="submit">Calcular Predicci√≥n con Gemini üöÄ</button>
    </form>

    <div id="resultado" class="resultado" style="display:none;">
        <h3>An√°lisis de Probabilidades üß†</h3>
        <p style="font-size: 0.9em; margin-bottom: 20px;">
            **Goles Esperados ($\lambda$):** Local: <span id="lambda_home" style="color: var(--gemini-blue); font-weight: bold;"></span> | Visita: <span id="lambda_away" style="color: var(--gemini-red); font-weight: bold;"></span>
        </p>

        <div class="probabilidad-grid">
            <div class="prob-item">
                <strong>P(Goles > 2.5)</strong>
                <span id="prob_over25" class="prob-value"></span>
            </div>
            <div class="prob-item">
                <strong>P(Ambos Anotan)</strong>
                <span id="prob_aa" class="prob-value"></span>
            </div>
            <div class="prob-item">
                <strong>P(Local Gana - 1)</strong>
                <span id="prob_local" class="prob-value"></span>
            </div>
            <div class="prob-item">
                <strong>P(Empate - X)</strong>
                <span id="prob_empate" class="prob-value"></span>
            </div>
            <div class="prob-item">
                <strong>P(Visita Gana - 2)</strong>
                <span id="prob_visita" class="prob-value"></span>
            </div>
        </div>

        <div class="mercado-sugerido">
            <strong>Mercado Sugerido por el Algoritmo:</strong>
            <div id="sugerencia" class="sugerencia-list"></div>
        </div>
    </div>
</div>

<script>
    document.getElementById('poisson-form').addEventListener('submit', function(event) {
        event.preventDefault();
        calcularPoisson();
    });

    // Funci√≥n factorial optimizada
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    // F√≥rmula de Distribuci√≥n de Poisson: P(k; lambda)
    function poisson(k, lambda) {
        if (lambda <= 0) return (k === 0) ? 1 : 0;
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function calcularPoisson() {
        // 1. Obtener y parsear valores de entrada
        const avgGlHomeLiga = parseFloat(document.getElementById('avg_gl_home_liga').value);
        const avgGvAwayLiga = parseFloat(document.getElementById('avg_gv_away_liga').value);
        
        const gfLocal = parseInt(document.getElementById('gf_local').value);
        const gcLocal = parseInt(document.getElementById('gc_local').value);
        const partidosLocal = parseInt(document.getElementById('partidos_local').value);
        
        const gfVisita = parseInt(document.getElementById('gf_visita').value);
        const gcVisita = parseInt(document.getElementById('gc_visita').value);
        const partidosVisita = parseInt(document.getElementById('partidos_visita').value);

        const porcAA = parseFloat(document.getElementById('porc_aa').value) / 100;
        const porcOver25 = parseFloat(document.getElementById('porc_over25').value) / 100;
        
        // Validaci√≥n b√°sica para evitar divisi√≥n por cero
        if (partidosLocal === 0 || partidosVisita === 0 || avgGlHomeLiga === 0 || avgGvAwayLiga === 0) {
            alert("Error: Los partidos jugados o los promedios de liga no pueden ser cero.");
            return;
        }

        // 2. Calcular Atributos Individuales (Promedios de Goles por partido)
        const avgGolesLocal = gfLocal / partidosLocal;
        const avgGcLocal = gcLocal / partidosLocal;
        const avgGolesVisita = gfVisita / partidosVisita;
        const avgGcVisita = gcVisita / partidosVisita;

        // 3. Calcular la Fuerza de Ataque y Defensa (Strength)
        // La Fuerza de Defensa del Local usa el promedio de goles que anota un Visitante promedio de la liga (avgGvAwayLiga)
        const attLocal = avgGolesLocal / avgGlHomeLiga;
        const defLocal = avgGcLocal / avgGvAwayLiga; 

        // La Fuerza de Defensa del Visitante usa el promedio de goles que anota un Local promedio de la liga (avgGlHomeLiga)
        const attVisita = avgGolesVisita / avgGvAwayLiga;
        const defVisita = avgGcVisita / avgGlHomeLiga; 
        
        // 4. Calcular Goles Esperados ($\lambda$) para el partido
        const lambdaHome = attLocal * avgGlHomeLiga * defVisita;
        const lambdaAway = attVisita * avgGvAwayLiga * defLocal;

        // Criterios de Sugerencia
        const MARGEN = 0.05; // 5% de diferencia respecto al promedio de liga para considerarse "valor"

        // 5. Calcular la Matriz de Probabilidades (hasta 6-6)
        let prob_over25 = 0;
        let prob_aa = 0;
        let prob_local = 0;
        let prob_empate = 0;
        let prob_visita = 0;
        let prob_total_suma = 0;

        for (let home_goals = 0; home_goals <= 6; home_goals++) {
            for (let away_goals = 0; away_goals <= 6; away_goals++) {
                const prob_score = poisson(home_goals, lambdaHome) * poisson(away_goals, lambdaAway);
                prob_total_suma += prob_score;

                if (home_goals + away_goals > 2) {
                    prob_over25 += prob_score;
                }
                
                if (home_goals >= 1 && away_goals >= 1) {
                    prob_aa += prob_score;
                }
                
                if (home_goals > away_goals) {
                    prob_local += prob_score;
                } else if (home_goals === away_goals) {
                    prob_empate += prob_score;
                } else {
                    prob_visita += prob_score;
                }
            }
        }
        
        // Normalizaci√≥n (para asegurar que 1X2 sume 100% para el rango de la matriz)
        const factorNormalizacion = prob_total_suma > 0 ? 1 / prob_total_suma : 1;
        prob_local *= factorNormalizacion;
        prob_empate *= factorNormalizacion;
        prob_visita *= factorNormalizacion;
        
        // 6. Generar Sugerencia de Mercado
        let sugerencias = [];
        
        // Over/Under 2.5
        if (prob_over25 > porcOver25 + MARGEN) {
            sugerencias.push({ text: `**OVER 2.5 FT**`, prob: (prob_over25 * 100).toFixed(2) + '%', class: 'sugerencia-over' });
        } else if (prob_over25 < porcOver25 - MARGEN) {
            sugerencias.push({ text: `**UNDER 2.5 FT**`, prob: ((1 - prob_over25) * 100).toFixed(2) + '%', class: 'sugerencia-under' });
        }
        
        // Ambos Anotan
        if (prob_aa > porcAA + MARGEN) {
            sugerencias.push({ text: `**AMBOS ANOTAN (S√≠)**`, prob: (prob_aa * 100).toFixed(2) + '%', class: 'sugerencia-aa' });
        } else if (prob_aa < porcAA - MARGEN) {
            sugerencias.push({ text: `**AMBOS ANOTAN (No)**`, prob: ((1 - prob_aa) * 100).toFixed(2) + '%', class: 'sugerencia-no-aa' });
        }
        
        // 1X2 (si es muy dominante)
        const max_1x2_prob = Math.max(prob_local, prob_empate, prob_visita);
        if (max_1x2_prob > 0.60) {
            let ganador = 'VICTORIA LOCAL';
            let className = 'sugerencia-win';
            if (max_1x2_prob === prob_visita) {
                ganador = 'VICTORIA VISITANTE';
                className = 'sugerencia-win-away';
            } else if (max_1x2_prob === prob_empate) {
                ganador = 'EMPATE';
                className = 'sugerencia-draw';
            }
            sugerencias.push({ text: `**${ganador}**`, prob: (max_1x2_prob * 100).toFixed(2) + '%', class: className });
        }

        let sugerenciaHTML = "No se identifica un valor claro (la probabilidad est√° cerca del promedio hist√≥rico de la liga).";
        if (sugerencias.length > 0) {
            sugerenciaHTML = sugerencias.map(s => 
                `<span class="${s.class}">${s.text}</span> <span style="font-size:0.9em;">(${s.prob})</span>`
            ).join("<br>");
        }

        // 7. Mostrar Resultados
        document.getElementById('lambda_home').textContent = lambdaHome.toFixed(3);
        document.getElementById('lambda_away').textContent = lambdaAway.toFixed(3);
        
        document.getElementById('prob_over25').textContent = `${(prob_over25 * 100).toFixed(2)}%`;
        document.getElementById('prob_aa').textContent = `${(prob_aa * 100).toFixed(2)}%`;
        document.getElementById('prob_local').textContent = `${(prob_local * 100).toFixed(2)}%`;
        document.getElementById('prob_empate').textContent = `${(prob_empate * 100).toFixed(2)}%`;
        document.getElementById('prob_visita').textContent = `${(prob_visita * 100).toFixed(2)}%`;
        
        document.getElementById('sugerencia').innerHTML = sugerenciaHTML;
        document.getElementById('resultado').style.display = 'block';
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculadora Poisson GF/GC + CV (1X2, DNB, OU, BTTS)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --text:#e8ecf3; --muted:#9aa3b2;
    --accent:#7aa2ff; --ok:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --border:#2a3140
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid var(--border);background:#0c0e13}
  h1{font-size:18px;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  label{font-size:13px;color:var(--muted);display:block;margin:10px 0 4px}
  input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#12151c;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{margin-top:14px;background:var(--accent);border:none;border-radius:10px;padding:12px 14px;color:#0b0f18;font-weight:700;cursor:pointer;width:100%}
  .btn:active{transform:translateY(1px)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  th:first-child,td:first-child{text-align:left}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;font-size:13px}
  .pill{padding:6px 10px;border-radius:999px;background:#12151c;border:1px solid var(--border);color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  small{color:var(--muted)}
</style>
</head>
<body>
<header><h1>Calculadora Poisson con GF/GC + CV (por sede)</h1></header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Parámetros de entrada</h3>

      <div class="row">
        <div>
          <label>GF Local</label>
          <input id="gfH" type="number" step="0.01" min="0" value="1.40">
        </div>
        <div>
          <label>CV GF Local</label>
          <input id="cvGFH" type="number" step="0.01" min="0" value="0.77">
        </div>
      </div>

      <div class="row">
        <div>
          <label>GC Local</label>
          <input id="gcH" type="number" step="0.01" min="0" value="0.80">
        </div>
        <div>
          <label>CV GC Local</label>
          <input id="cvGCH" type="number" step="0.01" min="0" value="0.50">
        </div>
      </div>

      <div class="row">
        <div>
          <label>GF Visitante</label>
          <input id="gfA" type="number" step="0.01" min="0" value="1.60">
        </div>
        <div>
          <label>CV GF Visitante</label>
          <input id="cvGFA" type="number" step="0.01" min="0" value="0.60">
        </div>
      </div>

      <div class="row">
        <div>
          <label>GC Visitante</label>
          <input id="gcA" type="number" step="0.01" min="0" value="1.60">
        </div>
        <div>
          <label>CV GC Visitante</label>
          <input id="cvGCA" type="number" step="0.01" min="0" value="0.55">
        </div>
      </div>

      <div class="row">
        <div>
          <label>α (fuerza del encogimiento por CV)</label>
          <input id="alpha" type="number" step="0.05" min="0" max="2" value="0.50">
        </div>
        <div>
          <label>μ (promedio liga por equipo)</label>
          <input id="mu" type="number" step="0.01" min="0.1" value="1.35">
        </div>
      </div>

      <div class="row">
        <div>
          <label>HFA (ventaja local, p.ej. 1.08)</label>
          <input id="hfa" type="number" step="0.01" min="0.6" max="1.5" value="1.08">
        </div>
        <div>
          <label>Máx. goles por lado (suma de marcadores)</label>
          <input id="maxGoals" type="number" step="1" min="6" max="20" value="12">
        </div>
      </div>

      <button class="btn" id="calc">Calcular mercados</button>
      <div class="kpi" id="kpi"></div>
      <small>Modelo: \( \tilde{x} = x/(1+\alpha\,CV) \), \( \lambda_H=\text{HFA}\cdot \tilde{GF}_H\cdot(\tilde{GC}_A/\mu) \), \( \lambda_A=(1/\text{HFA})\cdot \tilde{GF}_A\cdot(\tilde{GC}_H/\mu) \).</small>
    </div>

    <div class="card">
      <h3>Resultados</h3>
      <table id="tbl1">
        <thead><tr><th>Mercado</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
        <tbody></tbody>
      </table>

      <table id="tbl2">
        <thead><tr><th>Over/Under</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
        <tbody></tbody>
      </table>

      <table id="tbl3">
        <thead><tr><th>BTTS</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);

  // ---------- Utilidades numéricas ----------
  const fact = [1];
  function factorial(n){
    for(let i=fact.length;i<=n;i++) fact[i]=fact[i-1]*i;
    return fact[n];
  }
  function logFactorial(n){
    if(n<100) return Math.log(factorial(n));
    const x=n;
    return x*Math.log(x)-x+0.5*Math.log(2*Math.PI*x); // Stirling
  }
  function poisPMF(k, lambda){
    if(lambda<=0) return (k===0)?1:0;
    if(k<100){
      return Math.exp(-lambda) * Math.pow(lambda,k) / factorial(k);
    }
    // vía log para k grandes
    const logp = -lambda + k*Math.log(lambda) - logFactorial(k);
    return Math.exp(logp);
  }
  function poisCDF(k, lambda){
    let s=0;
    for(let i=0;i<=k;i++) s+=poisPMF(i,lambda);
    return s;
  }
  function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
  function fmtP(p){ return (100*p).toFixed(2)+'%'; }
  function toOdds(p){ return (p<=0)? Infinity : (1/p); }
  function fmtO(o){ return (o===Infinity)? '—' : o.toFixed(2); }

  // ---------- Modelo ----------
  function shrink(x, cv, alpha){
    const cvp = Math.max(0, cv);
    const a = Math.max(0, alpha);
    return x * (1 / (1 + a * cvp));
  }

  function lambdas(params){
    const {gfH,cvGFH,gcH,cvGCH,gfA,cvGFA,gcA,cvGCA,alpha,mu,hfa} = params;
    const MU = Math.max(0.05, mu);
    const HFA = clamp(hfa, 0.6, 1.5);

    const GFH = shrink(Math.max(0,gfH), Math.max(0,cvGFH), alpha);
    const GCH = shrink(Math.max(0,gcH), Math.max(0,cvGCH), alpha);
    const GFA = shrink(Math.max(0,gfA), Math.max(0,cvGFA), alpha);
    const GCA = shrink(Math.max(0,gcA), Math.max(0,cvGCA), alpha);

    // λH = HFA * GFH * (GCA / MU)
    // λA = (1/HFA) * GFA * (GCH / MU)
    const lamH = HFA * GFH * (GCA / MU);
    const lamA = (1/HFA) * GFA * (GCH / MU);
    return {lamH, lamA, GFH, GCH, GFA, GCA};
  }

  function probs1X2(lH, lA, maxGoals){
    const maxG = Math.max(6, Math.min(20, Math.floor(maxGoals)||12));
    let p1=0, px=0, p2=0;
    // suma de marcadores hasta maxG
    for(let i=0;i<=maxG;i++){
      const pHi = poisPMF(i, lH);
      for(let j=0;j<=maxG;j++){
        const pAj = poisPMF(j, lA);
        const pij = pHi * pAj;
        if(i>j) p1 += pij;
        else if(i===j) px += pij;
        else p2 += pij;
      }
    }
    // Normaliza (la masa de cola es muy pequeña para maxG>=10)
    const s = p1+px+p2;
    if(s>0) { p1/=s; px/=s; p2/=s; }
    return {p1, px, p2};
  }

  function calcAll(){
    // Lee inputs
    const params = {
      gfH: +$('#gfH').value,    cvGFH: +$('#cvGFH').value,
      gcH: +$('#gcH').value,    cvGCH: +$('#cvGCH').value,
      gfA: +$('#gfA').value,    cvGFA: +$('#cvGFA').value,
      gcA: +$('#gcA').value,    cvGCA: +$('#cvGCA').value,
      alpha:+$('#alpha').value, mu:+$('#mu').value,
      hfa:+$('#hfa').value
    };
    const maxGoals = Math.max(6, Math.min(20, Math.floor(+$('#maxGoals').value)||12));

    // Lámparas
    const {lamH, lamA, GFH, GCH, GFA, GCA} = lambdas(params);
    const lamT = lamH + lamA;

    // 1X2
    const m = probs1X2(lamH, lamA, maxGoals);
    const p1=m.p1, px=m.px, p2=m.p2;

    // DNB (cuotas justas)
    // fair prob ganar en DNB = P(win) / (1 - P(draw))
    const pNotDraw = 1 - px;
    const dnb1_odds = toOdds(p1 / (pNotDraw>0?pNotDraw:1));
    const dnb2_odds = toOdds(p2 / (pNotDraw>0?pNotDraw:1));

    // OU con N ~ Pois(lamT)
    const over15 = 1 - poisCDF(1, lamT);
    const over25 = 1 - poisCDF(2, lamT);
    const over35 = 1 - poisCDF(3, lamT);

    // BTTS
    const pBTTSyes = 1 - Math.exp(-lamH) - Math.exp(-lamA) + Math.exp(-(lamT));
    const pBTTSno  = 1 - pBTTSyes;

    // KPIs
    $('#kpi').innerHTML = `
      <span class="pill">λ<sub>H</sub>=<b class="mono">${lamH.toFixed(3)}</b></span>
      <span class="pill">λ<sub>A</sub>=<b class="mono">${lamA.toFixed(3)}</b></span>
      <span class="pill">λ<sub>T</sub>=<b class="mono">${lamT.toFixed(3)}</b></span>
      <span class="pill">P(empate)=<b class="mono">${fmtP(px)}</b></span>
      <span class="pill">maxG=<b class="mono">${maxGoals}</b></span>
      <span class="pill">GFH~<b class="mono">${GFH.toFixed(2)}</b> GCA~<b class="mono">${GCA.toFixed(2)}</b></span>
      <span class="pill">GFA~<b class="mono">${GFA.toFixed(2)}</b> GCH~<b class="mono">${GCH.toFixed(2)}</b></span>
    `;

    // Tabla 1X2 + DNB
    const t1 = $('#tbl1 tbody');
    t1.innerHTML = `
      <tr><td>1 (Local)</td><td class="mono">${fmtP(p1)}</td><td class="mono">${fmtO(toOdds(p1))}</td></tr>
      <tr><td>X (Empate)</td><td class="mono">${fmtP(px)}</td><td class="mono">${fmtO(toOdds(px))}</td></tr>
      <tr><td>2 (Visita)</td><td class="mono">${fmtP(p2)}</td><td class="mono">${fmtO(toOdds(p2))}</td></tr>
      <tr><td>1 DNB (cuota justa)</td><td class="mono"><small>—</small></td><td class="mono">${fmtO(dnb1_odds)}</td></tr>
      <tr><td>2 DNB (cuota justa)</td><td class="mono"><small>—</small></td><td class="mono">${fmtO(dnb2_odds)}</td></tr>
    `;

    // Tabla OU
    const t2 = $('#tbl2 tbody');
    t2.innerHTML = `
      <tr><td>Over 1.5</td><td class="mono">${fmtP(over15)}</td><td class="mono">${fmtO(toOdds(over15))}</td></tr>
      <tr><td>Under 1.5</td><td class="mono">${fmtP(1-over15)}</td><td class="mono">${fmtO(toOdds(1-over15))}</td></tr>
      <tr><td>Over 2.5</td><td class="mono">${fmtP(over25)}</td><td class="mono">${fmtO(toOdds(over25))}</td></tr>
      <tr><td>Under 2.5</td><td class="mono">${fmtP(1-over25)}</td><td class="mono">${fmtO(toOdds(1-over25))}</td></tr>
      <tr><td>Over 3.5</td><td class="mono">${fmtP(over35)}</td><td class="mono">${fmtO(toOdds(over35))}</td></tr>
      <tr><td>Under 3.5</td><td class="mono">${fmtP(1-over35)}</td><td class="mono">${fmtO(toOdds(1-over35))}</td></tr>
    `;

    // Tabla BTTS
    const t3 = $('#tbl3 tbody');
    t3.innerHTML = `
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTSyes)}</td><td class="mono">${fmtO(toOdds(pBTTSyes))}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pBTTSno)}</td><td class="mono">${fmtO(toOdds(pBTTSno))}</td></tr>
    `;
  }

  $('#calc').addEventListener('click', calcAll);
  // cálculo inicial con los valores de ejemplo
  calcAll();
})();
</script>
</body>
</html>
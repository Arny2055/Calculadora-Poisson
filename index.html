<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting Avanzado de BetMines (Ataque)</title>
    <style>
        /* Estilos */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        #csvFile { margin-bottom: 20px; }
        #results { 
            margin-top: 30px; 
            padding: 15px; 
            border: 1px solid #ddd; 
            background-color: #e9e9f9; 
            font-size: 16px;
        }
        .profit { color: green; font-weight: bold; }
        .loss { color: red; font-weight: bold; }
        .neutral { color: orange; font-weight: bold; }
        .config-box { 
            background-color: #f1f8ff; 
            padding: 15px; 
            border: 1px dashed #007bff; 
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>游 Backtesting - Estrategia de Peligro de Ataque</h2>

        <div class="config-box">
            <h3>丘뙖잺 Configuraci칩n de la Estrategia</h3>
            <label for="dangerThreshold">Umbral de Peligro Combinado (Home Danger + Away Danger):</label>
            <input type="number" id="dangerThreshold" value="100" min="1" style="width: 100px; padding: 5px; border: 1px solid #ccc;">
            <p style="font-size: 0.9em; margin-top: 5px;">*Solo se apostar치 a Over 2.5 si la suma de los valores de peligro es mayor a este n칰mero.</p>
        </div>

        <form id="csvForm">
            <label for="csvFile">Cargar Archivo CSV de Historial de BetMines:</label>
            <input type="file" id="csvFile" name="historialCSV" accept=".csv" required>
        </form>
        
        <div id="results">
            Ajusta el umbral, carga tu archivo CSV y se ejecutar치 el Backtesting.
        </div>
    </div>

    <script>
        const csvFile = document.getElementById('csvFile');
        const resultsDiv = document.getElementById('results');
        const dangerThresholdInput = document.getElementById('dangerThreshold');

        // Escucha el cambio en el input de archivo para iniciar la lectura
        csvFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    runBacktest(content);
                };
                reader.readAsText(file);
            }
        });

        // Tambi칠n escucha cambios en el umbral para recalcular si ya hay un archivo
        dangerThresholdInput.addEventListener('change', () => {
            if (csvFile.files.length > 0) {
                 const reader = new FileReader();
                 reader.onload = (e) => runBacktest(e.target.result);
                 reader.readAsText(csvFile.files[0]);
            }
        });


        /**
         * Funci칩n principal para ejecutar el Backtesting
         * @param {string} csvText - Contenido del archivo CSV
         */
        function runBacktest(csvText) {
            
            // 1. Preparaci칩n de datos y configuraci칩n
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) {
                resultsDiv.innerHTML = "El archivo CSV est치 vac칤o o solo contiene encabezados.";
                return;
            }

            // Umbral de Peligro definido por el usuario
            const DANGER_THRESHOLD = parseFloat(dangerThresholdInput.value);
            
            // **IMPORTANTE**: 칈ndices de columna basados en la imagen (asumiendo 0-index)
            const DESIRED_ODD_INDEX = 1;  // 'Desired Odd' (Cuota a la que apostamos, en este caso Over 2.5)
            const HOME_DANGER_INDEX = 5;  // 'Home Danger'
            const AWAY_DANGER_INDEX = 7;  // 'Away Danger'
            const TOTAL_SCORE_INDEX = 14; // 'Total Score' (Resultado final de goles)
            
            let totalApuestas = 0;
            let saldoFinal = 0;
            const STAKE_SIZE = 1; // Apuesta fija de 1 unidad

            // 2. Procesar cada partido (empezamos en 1 para saltar los encabezados)
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');

                // Validaci칩n b치sica de fila
                if (values.length < Math.max(DESIRED_ODD_INDEX, HOME_DANGER_INDEX, AWAY_DANGER_INDEX, TOTAL_SCORE_INDEX) + 1) {
                    continue; 
                }

                // Obtener los datos clave del partido
                const desiredOdd = parseFloat(values[DESIRED_ODD_INDEX]);
                const homeDanger = parseFloat(values[HOME_DANGER_INDEX]);
                const awayDanger = parseFloat(values[AWAY_DANGER_INDEX]);
                const totalScore = parseFloat(values[TOTAL_SCORE_INDEX]);

                // Calcular el indicador clave
                const combinedDanger = homeDanger + awayDanger;

                // ----------------------------------------------------------------
                // 游 ESTRATEGIA DE BACKTESTING: Over 2.5 Goles
                // ----------------------------------------------------------------
                
                // Aplicar el filtro de la estrategia
                if (combinedDanger > DANGER_THRESHOLD) {
                    
                    totalApuestas++;
                    let ganancia = -STAKE_SIZE; // Inicialmente, perdemos el Stake

                    // Chequear si se cumpli칩 la apuesta (Over 2.5)
                    // Apostamos a Over 2.5, por lo que necesitamos 3 o m치s goles.
                    const IS_WINNER = (totalScore >= 3); 

                    if (IS_WINNER) { 
                        // Ganancia = (Cuota * Stake) - Stake
                        ganancia = (desiredOdd * STAKE_SIZE) - STAKE_SIZE;
                    }
                    
                    saldoFinal += ganancia;
                }
            }

            // 3. Mostrar Resultados
            const totalInvested = totalApuestas * STAKE_SIZE;
            const profitabilityClass = (saldoFinal > 0) ? 'profit' : (saldoFinal < 0 ? 'loss' : 'neutral');
            const totalReturn = (totalInvested > 0) ? (saldoFinal / totalInvested) * 100 : 0;

            let htmlOutput = `
                <h3>Resultados del Backtesting</h3>
                <p><strong>Estrategia aplicada:</strong> Apuesta a **Over 2.5 Goles** si la suma de 'Home Danger' + 'Away Danger' es mayor a **${DANGER_THRESHOLD}**.</p>
                <hr>
                <p>俱뫮잺 Total de partidos analizados (filas): **${lines.length - 1}**</p>
                <p>俱뫮잺 Total de apuestas realizadas por la estrategia: **${totalApuestas}**</p>
                <p>俱뫮잺 Total invertido (unidades): **${totalInvested.toFixed(2)}**</p>
                <hr>
                <h4>Balance Final</h4>
                <p>G / P Netas (unidades): <span class="${profitabilityClass}">${saldoFinal.toFixed(2)} unidades</span></p>
                <p>Retorno de Inversi칩n (ROI): <span class="${profitabilityClass}">${totalReturn.toFixed(2)}%</span></p>
            `;

            resultsDiv.innerHTML = htmlOutput;
        }
    </script>

</body>
</html>

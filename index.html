<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora — Normal Bivariada (Fútbol)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6;
    --border:#2a3140;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }
  header{
    padding:20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#12151c,#0f1115);
  }
  h1{font-size:20px; margin:0 0 6px}
  .sub{color:var(--muted); font-size:13px}
  .wrap{max-width:1100px; margin:0 auto; padding:18px}
  .grid{display:grid; gap:18px}
  @media(min-width:900px){ .grid{ grid-template-columns: 360px 1fr } }
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px;
  }
  .card h2{font-size:16px; margin:0 0 12px}
  .row{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; margin-bottom:10px}
  label{font-size:13px; color:var(--muted)}
  input[type="number"]{
    width:120px; background:var(--panel2); color:var(--text); border:1px solid var(--border);
    border-radius:8px; padding:8px 10px; font-size:14px;
  }
  input[type="range"]{ width:100% }
  .range-row{display:grid; grid-template-columns: 1fr 60px; gap:10px; align-items:center}
  .pill{
    display:inline-block; padding:6px 10px; border-radius:999px; background:var(--panel2); border:1px solid var(--border);
    font-size:12px; color:var(--muted); margin-right:6px; margin-bottom:6px
  }
  .btn{
    cursor:pointer; background:var(--accent); color:#0b1020; border:none; border-radius:10px;
    font-weight:700; padding:10px 14px; font-size:14px;
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .muted{color:var(--muted)}
  .kpi-grid{display:grid; gap:10px; grid-template-columns: repeat(3, 1fr)}
  .kpi{
    background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:12px;
    text-align:center;
  }
  .kpi .v{font-size:18px; font-weight:800}
  .kpi .t{font-size:12px; color:var(--muted)}
  .table{
    width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;
  }
  .table th,.table td{
    border-bottom:1px solid var(--border); padding:8px 6px; text-align:right;
  }
  .table th:first-child,.table td:first-child{text-align:left}
  .badge{font-weight:700; padding:2px 8px; border-radius:999px; border:1px solid var(--border)}
  .b-ok{background:rgba(121,226,166,.15)}
  .b-warn{background:rgba(255,184,77,.15)}
  .b-danger{background:rgba(255,107,107,.15)}
  .footnote{font-size:12px; color:var(--muted); margin-top:8px}
  .flex{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .select{
    background:var(--panel2); color:var(--text); border:1px solid var(--border);
    border-radius:8px; padding:8px 10px; font-size:14px;
  }
  .small{font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Calculadora — Normal Bivariada (Goles)</h1>
      <div class="sub">Pronostica 1X2, Over/Under y BTTS con aproximación Normal bivariada + Monte Carlo</div>
    </div>
  </header>

  <div class="wrap grid">
    <!-- CONTROLES -->
    <section class="card">
      <h2>Parámetros del partido</h2>

      <div class="row">
        <label>Media goles local (μ<sub>H</sub>)</label>
        <input id="muH" type="number" min="0" step="0.01" value="1.60" />
      </div>
      <div class="row">
        <label>Media goles visitante (μ<sub>A</sub>)</label>
        <input id="muA" type="number" min="0" step="0.01" value="1.10" />
      </div>

      <div class="row">
        <label>Desv. típica local (σ<sub>H</sub>)</label>
        <input id="sdH" type="number" min="0.01" step="0.01" value="1.20" />
      </div>
      <div class="row">
        <label>Desv. típica visitante (σ<sub>A</sub>)</label>
        <input id="sdA" type="number" min="0.01" step="0.01" value="1.10" />
      </div>

      <div class="range-row" style="margin:12px 0">
        <label>Correlación ρ (goles H–A)</label>
        <input id="rho" type="range" min="-0.8" max="0.8" step="0.01" value="0.20" />
        <div id="rhoVal" class="pill">0.20</div>
      </div>

      <div class="row">
        <label>Límite Over/Under</label>
        <input id="ouLine" type="number" step="0.5" value="2.5" />
      </div>

      <div class="row">
        <label>Simulaciones Monte Carlo</label>
        <input id="nSims" type="number" min="1000" step="1000" value="50000" />
      </div>

      <div class="row">
        <label>Método de discretización</label>
        <select id="disc" class="select">
          <option value="round">Redondear y truncar a ≥0</option>
          <option value="floor">Floor (truncar hacia abajo, ≥0)</option>
          <option value="none">No discretizar (solo O/U analítico)</option>
        </select>
      </div>

      <div class="flex" style="margin-top:12px">
        <button id="runBtn" class="btn">Calcular</button>
        <span class="muted small">Consejo: 50k–100k sims dan buena estabilidad.</span>
      </div>

      <div class="footnote">
        Nota: Si eliges “No discretizar”, 1X2/BTTS y marcadores exactos no se mostrarán (no tienen sentido continuos).
      </div>
    </section>

    <!-- RESULTADOS -->
    <section class="card">
      <h2>Resultados</h2>

      <div class="kpi-grid" id="kpis-1x2" style="display:none">
        <div class="kpi">
          <div class="v" id="pH">—</div>
          <div class="t">1 (Local)</div>
        </div>
        <div class="kpi">
          <div class="v" id="pD">—</div>
          <div class="t">X (Empate)</div>
        </div>
        <div class="kpi">
          <div class="v" id="pA">—</div>
          <div class="t">2 (Visitante)</div>
        </div>
      </div>

      <div class="kpi-grid" style="margin-top:10px">
        <div class="kpi">
          <div class="v" id="pOver">—</div>
          <div class="t">Over (MC / Analítico)</div>
        </div>
        <div class="kpi">
          <div class="v" id="pUnder">—</div>
          <div class="t">Under (MC / Analítico)</div>
        </div>
        <div class="kpi">
          <div class="v" id="pBTTS">—</div>
          <div class="t">BTTS (MC)</div>
        </div>
      </div>

      <div class="flex" style="margin-top:12px">
        <span class="pill">E[goles H] (MC): <b id="egH">—</b></span>
        <span class="pill">E[goles A] (MC): <b id="egA">—</b></span>
        <span class="pill">E[total] (MC): <b id="egT">—</b></span>
        <span class="pill">σ<sub>T</sub> analítico: <b id="sdT">—</b></span>
      </div>

      <h3 style="margin-top:16px; font-size:14px">Top 10 marcadores exactos (MC)</h3>
      <table class="table" id="scoreTable">
        <thead><tr><th>Marcador</th><th>Prob.</th><th>Odds justas</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="footnote">
        1X2/BTTS/Marcadores exactos se calculan via Monte Carlo:
        se simulan (X,Y) ~ Normal bivariada, se discretizan (según método) y se truncan a ≥0.
      </div>
    </section>
  </div>

<script>
(function(){
  const el = id => document.getElementById(id);
  const fmtPct = x => (x*100).toFixed(2) + '%';
  const fmtOdds = p => (p>0 ? (1/p).toFixed(2) : '—');

  const rhoInput = el('rho');
  const rhoVal = el('rhoVal');
  rhoInput.addEventListener('input', ()=>{ rhoVal.textContent = (+rhoInput.value).toFixed(2); });

  // Box–Muller para N(0,1)
  function randn(){
    let u=0, v=0;
    while(u===0) u=Math.random();
    while(v===0) v=Math.random();
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }

  // Muestra muchas veces (vectorizado "manual" simple)
  function simulate(muH,muA,sdH,sdA,rho,n,disc, ouLine){
    const s = Math.sqrt(1 - Math.max(-0.999, Math.min(0.999, rho))**2); // estabilidad numérica
    let winsH=0, draws=0, winsA=0, overMC=0, btts=0;
    let sumH=0, sumA=0, sumT=0;

    // contadores de scorelines
    const counts = new Map(); // key "h:a" -> count

    for(let i=0;i<n;i++){
      const z1 = randn();
      const z2 = randn();
      const x = muH + sdH * z1;
      const y = muA + sdA * (rho*z1 + s*z2);

      let H=x, A=y;
      if(disc==='round'){
        H = Math.max(0, Math.round(H));
        A = Math.max(0, Math.round(A));
      }else if(disc==='floor'){
        H = Math.max(0, Math.floor(H));
        A = Math.max(0, Math.floor(A));
      }else{
        // no discretizar: solo sirve para total analítico; saltamos 1X2/BTTS/scorelines
      }

      const total = (disc==='none') ? (x+y) : (H+A);

      if(disc!=='none'){
        if(H>A) winsH++; else if(H===A) draws++; else winsA++;
        if(H+A > ouLine) overMC++;
        if(H>0 && A>0) btts++;

        sumH += H; sumA += A; sumT += (H+A);

        const key = H+':'+A;
        counts.set(key, (counts.get(key)||0)+1);
      }else{
        // Monte Carlo del total continuo (solo para mostrar E[T] aproximado)
        sumT += total;
        // overMC no tiene sentido continuo con discretización "none" aquí; lo dejamos en 0
      }
    }

    const res = {
      pH: winsH/n, pD: draws/n, pA: winsA/n,
      pOverMC: overMC/n, pUnderMC: 1 - overMC/n,
      pBTTS: btts/n,
      eH: sumH/n, eA: sumA/n, eT: sumT/n,
      scoreCounts: counts
    };
    return res;
  }

  // Over/Under analítico con suma de Normales
  function overUnderAnalytic(muH,muA,sdH,sdA,rho, line){
    const muT = muH + muA;
    const varT = sdH*sdH + sdA*sdA + 2*rho*sdH*sdA;
    const sdT = Math.sqrt(Math.max(varT, 1e-12));
    const z = (line - muT) / sdT;
    const Phi = 0.5*(1 + erf(z/Math.SQRT2));
    const pUnder = Phi;         // P(T ≤ line) ~ Normal
    const pOver = 1 - pUnder;
    return {pOver, pUnder, sdT};
  }
  function erf(x){
    // aproximación numérica de Abramowitz & Stegun
    const sgn = Math.sign(x);
    const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429, p=0.3275911;
    const t = 1/(1+p*Math.abs(x));
    const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
    return sgn*y;
  }

  function renderScoreTable(scoreCounts, n, tableBody){
    const rows = [];
    scoreCounts.forEach((cnt, key)=>{
      rows.push({key, p: cnt/n});
    });
    rows.sort((a,b)=> b.p - a.p);
    const top = rows.slice(0,10);

    tableBody.innerHTML = top.map(r=>{
      const odds = fmtOdds(r.p);
      return `<tr>
        <td>${r.key}</td>
        <td>${fmtPct(r.p)}</td>
        <td>${odds}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="3" class="muted">—</td></tr>`;
  }

  el('runBtn').addEventListener('click', ()=>{
    const muH = Math.max(0, +el('muH').value);
    const muA = Math.max(0, +el('muA').value);
    const sdH = Math.max(0.01, +el('sdH').value);
    const sdA = Math.max(0.01, +el('sdA').value);
    const rho = Math.max(-0.999, Math.min(0.999, +el('rho').value));
    const ouLine = +el('ouLine').value;
    const n = Math.max(1000, Math.floor(+el('nSims').value));
    const disc = el('disc').value;

    const btn = el('runBtn'); btn.disabled = true; btn.textContent = 'Calculando…';

    // Analítico del total (siempre disponible)
    const ana = overUnderAnalytic(muH,muA,sdH,sdA,rho, ouLine);

    // Monte Carlo
    const res = simulate(muH,muA,sdH,sdA,rho,n,disc, ouLine);

    // Mostrar KPIs
    const show1x2 = (disc !== 'none');
    el('kpis-1x2').style.display = show1x2 ? '' : 'none';
    if(show1x2){
      el('pH').textContent = fmtPct(res.pH);
      el('pD').textContent = fmtPct(res.pD);
      el('pA').textContent = fmtPct(res.pA);
    }

    // Over/Under (MC y Analítico)
    if(disc!=='none'){
      el('pOver').textContent = `${fmtPct(res.pOverMC)} / ${fmtPct(ana.pOver)}`;
      el('pUnder').textContent = `${fmtPct(res.pUnderMC)} / ${fmtPct(ana.pUnder)}`;
      el('pBTTS').textContent = fmtPct(res.pBTTS);
      el('egH').textContent = res.eH.toFixed(3);
      el('egA').textContent = res.eA.toFixed(3);
      el('egT').textContent = res.eT.toFixed(3);
    }else{
      el('pOver').textContent = `— / ${fmtPct(ana.pOver)}`;
      el('pUnder').textContent = `— / ${fmtPct(ana.pUnder)}`;
      el('pBTTS').textContent = '—';
      el('egH').textContent = '—';
      el('egA').textContent = '—';
      el('egT').textContent = (muH+muA).toFixed(3);
    }
    el('sdT').textContent = ana.sdT.toFixed(3);

    // Tabla de marcadores
    const tbody = document.querySelector('#scoreTable tbody');
    if(disc!=='none'){
      renderScoreTable(res.scoreCounts, n, tbody);
    }else{
      tbody.innerHTML = `<tr><td colspan="3" class="muted">La discretización está desactivada.</td></tr>`;
    }

    btn.disabled = false; btn.textContent = 'Calcular';
  });

})();
</script>
</body>
</html>
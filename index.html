<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Valor en Fútbol: Modelo Poisson Ponderado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Iconos de Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilos de tabla profesional */
        .poisson-table { border-collapse: collapse; }
        .poisson-table th, .poisson-table td {
            padding: 6px;
            font-size: 0.75rem;
            border: 1px solid #e5e7eb; /* Borde gris claro */
        }
        .poisson-table th {
            background-color: #1e3a8a; 
            color: white;
            font-weight: 600;
        }
        .poisson-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        /* Resalta celdas con la máxima probabilidad */
        .highlight-cell {
            background-color: #fde68a !important; /* Amarillo suave */
            font-weight: 700;
            color: #1f2937;
            border: 2px solid #fbbf24;
        }
        /* Contenedor de tabla responsivo */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-5xl mx-auto bg-white shadow-2xl rounded-2xl p-6 sm:p-10">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-800 flex items-center justify-center">
                <i class="fas fa-chart-line mr-3 text-yellow-500"></i>
                Análisis de Valor y Predicción
            </h1>
            <p class="text-gray-600 mt-3 text-lg">Modelo Básico de Poisson Ponderado para Apuestas de Fútbol</p>
        </header>

        <!-- 1. Carga de Datos -->
        <section class="bg-indigo-50 p-6 rounded-xl mb-8 border-l-4 border-indigo-500 shadow-md">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center">
                <i class="fas fa-database mr-3"></i> 1. Carga y Cálculo de Fuerzas
            </h2>
            <p class="text-sm text-gray-700 mb-4">
                <span class="font-bold">Formato CSV:</span> Debe contener al menos <code class="font-mono bg-yellow-200 px-1 rounded">HomeTeam</code>, <code class="font-mono bg-yellow-200 px-1 rounded">AwayTeam</code>, <code class="font-mono bg-yellow-200 px-1 rounded">FTHG</code> (Goles Local), <code class="font-mono bg-yellow-200 px-1 rounded">FTAG</code> (Goles Visitante).
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label for="urlInput" class="block text-sm font-medium text-gray-700 mb-1">URL del Archivo CSV (Recomendado):</label>
                    <input type="text" id="urlInput" placeholder="https://www.football-data.co.uk/mmz4281/2324/E0.csv" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
                <div class="md:col-span-1 flex items-end">
                    <button onclick="handleDataInput(true)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                        <i class="fas fa-link mr-2"></i> Cargar URL
                    </button>
                </div>
            </div>

            <div class="text-center text-gray-500 font-semibold my-4">-- O Cargar Archivo Local --</div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Cargar Archivo Local (.csv):</label>
                    <input type="file" id="fileInput" accept=".csv" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200">
                </div>
                <div class="md:col-span-1 flex items-end">
                     <button onclick="handleDataInput(false)" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                        <i class="fas fa-file-upload mr-2"></i> Cargar Archivo
                    </button>
                </div>
            </div>

            <p id="loadStatus" class="text-sm mt-4 text-center h-4 font-semibold"></p>
        </section>

        <!-- 2. Configuración de Predicción (Oculta inicialmente) -->
        <section id="predictionSection" class="hidden bg-yellow-50 p-6 rounded-xl mb-8 border-l-4 border-yellow-500 shadow-md">
            <h2 class="text-2xl font-bold text-yellow-700 mb-4 flex items-center">
                <i class="fas fa-futbol mr-3"></i> 2. Seleccionar Partido
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div>
                    <label for="homeTeamSelect" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                        <i class="fas fa-home mr-2 text-blue-600"></i> Equipo Local:
                    </label>
                    <select id="homeTeamSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                        <option value="">Seleccionar Local</option>
                    </select>
                </div>
                
                <div>
                    <label for="awayTeamSelect" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                        <i class="fas fa-plane-departure mr-2 text-red-600"></i> Equipo Visitante:
                    </label>
                    <select id="awayTeamSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                        <option value="">Seleccionar Visitante</option>
                    </select>
                </div>
                
                <button onclick="runCalculations()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-lg">
                    <i class="fas fa-calculator mr-2"></i> Calcular Predicción
                </button>
            </div>
        </section>

        <!-- 3. Resultados y Análisis de Valor (Oculta inicialmente) -->
        <section id="resultsSection" class="hidden">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 flex items-center border-b pb-2">
                <i class="fas fa-poll mr-3"></i> 3. Resultados y Pronósticos
            </h2>

            <!-- Resumen de xG y Fuerzas -->
            <div id="summaryResults" class="bg-gray-100 p-6 rounded-xl mb-8 shadow-inner border border-gray-200">
                <!-- Contenido dinámico aquí -->
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Matriz de Probabilidades Poisson -->
                <div class="lg:col-span-1">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-th mr-2 text-blue-500"></i> Matriz de Resultados</h3>
                    <div class="table-container bg-white rounded-xl shadow-lg border border-gray-300 p-3">
                        <div id="poissonMatrix">
                            <!-- Tabla generada aquí -->
                        </div>
                    </div>
                </div>

                <!-- Pronóstico Detallado y Análisis de Valor -->
                <div class="lg:col-span-1">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-hand-holding-usd mr-2 text-green-600"></i> Análisis de Valor (Value Bet)</h3>
                    <div id="detailedForecast" class="p-4 bg-green-50 rounded-lg shadow-md border border-green-200 mb-6">
                        <!-- Pronósticos 1X2 generados aquí -->
                    </div>

                    <!-- Inputs de Cuotas de la Casa de Apuestas -->
                    <div class="bg-white p-4 rounded-lg shadow-md border border-gray-300">
                         <h4 class="text-lg font-semibold text-gray-800 mb-3">Ingresar Cuotas (Odds) de la Casa de Apuestas:</h4>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1 text-center">Local (1)</label>
                                <input type="number" step="0.01" id="odds1" placeholder="Ej: 2.50" class="w-full p-2 border border-gray-300 rounded-lg text-center" oninput="calculateValue()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1 text-center">Empate (X)</label>
                                <input type="number" step="0.01" id="oddsX" placeholder="Ej: 3.20" class="w-full p-2 border border-gray-300 rounded-lg text-center" oninput="calculateValue()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1 text-center">Visitante (2)</label>
                                <input type="number" step="0.01" id="odds2" placeholder="Ej: 3.00" class="w-full p-2 border border-gray-300 rounded-lg text-center" oninput="calculateValue()">
                            </div>
                        </div>

                        <div id="valueResults" class="mt-4 p-3 border-t border-gray-200 pt-4">
                            <p class="text-sm text-gray-500 text-center">Ingresa las cuotas para ver el análisis de valor.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal para Mensajes/Errores -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50" onclick="closeModal()">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
                <h3 id="modalTitle" class="text-xl font-bold mb-3 text-red-600">Error</h3>
                <p id="modalContent" class="text-gray-700 mb-4"></p>
                <button onclick="closeModal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    <i class="fas fa-times-circle mr-2"></i> Cerrar
                </button>
            </div>
        </div>

    </div>

    <script>
        // Variables globales para almacenar los datos y cálculos
        let allMatches = [];
        let teamStrengths = {};
        let leagueAverages = {};
        let lastForecastResults = null; // Almacena el último cálculo 1X2
        const MAX_GOALS = 8; // Reducido ligeramente para mayor limpieza en la matriz
        const HOME_GOALS_COL = 'FTHG';
        const AWAY_GOALS_COL = 'FTAG';
        const HOME_TEAM_COL = 'HomeTeam';
        const AWAY_TEAM_COL = 'AwayTeam';

        /**
         * Muestra un modal de mensaje o error.
         * @param {string} title Título del modal.
         * @param {string} content Contenido del mensaje.
         * @param {string} type Tipo: 'error' o 'info'.
         */
        function showModal(title, content, type = 'error') {
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const button = modal.querySelector('button');

            modalTitle.textContent = title;
            document.getElementById('modalContent').textContent = content;

            // Configurar estilos según el tipo
            if (type === 'error') {
                modalTitle.className = 'text-xl font-bold mb-3 text-red-600 flex items-center';
                modalTitle.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${title}`;
                button.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150';
            } else {
                modalTitle.className = 'text-xl font-bold mb-3 text-blue-600 flex items-center';
                modalTitle.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${title}`;
                button.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150';
            }

            modal.classList.remove('hidden');
        }

        /** Cierra el modal de mensaje. */
        function closeModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }

        /**
         * Analiza una cadena CSV y la convierte en un array de objetos de partidos.
         * Se asegura de que los nombres de las columnas coincidan con las constantes definidas.
         * @param {string} csvText La cadena de texto CSV.
         * @returns {Array} Un array de objetos de partidos.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("Datos CSV insuficientes. Se requiere al menos una cabecera y una fila de datos.");

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const requiredCols = [HOME_TEAM_COL, AWAY_TEAM_COL, HOME_GOALS_COL, AWAY_GOALS_COL];
            const missingCols = requiredCols.filter(col => !headers.includes(col));

            if (missingCols.length > 0) {
                throw new Error(`Columnas CSV faltantes: ${missingCols.join(', ')}. Verifica que las cabeceras sean exactas.`);
            }

            const indices = {
                [HOME_TEAM_COL]: headers.indexOf(HOME_TEAM_COL),
                [AWAY_TEAM_COL]: headers.indexOf(AWAY_TEAM_COL),
                [HOME_GOALS_COL]: headers.indexOf(HOME_GOALS_COL),
                [AWAY_GOALS_COL]: headers.indexOf(AWAY_GOALS_COL)
            };

            const matches = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(',');
                if (currentLine.length < headers.length) continue;

                const match = {};
                try {
                    match[HOME_TEAM_COL] = currentLine[indices[HOME_TEAM_COL]].trim().replace(/"/g, '');
                    match[AWAY_TEAM_COL] = currentLine[indices[AWAY_TEAM_COL]].trim().replace(/"/g, '');
                    // Asegurar que los goles son números enteros
                    match[HOME_GOALS_COL] = parseInt(currentLine[indices[HOME_GOALS_COL]].trim().replace(/"/g, ''), 10);
                    match[AWAY_GOALS_COL] = parseInt(currentLine[indices[AWAY_GOALS_COL]].trim().replace(/"/g, ''), 10);
                } catch (e) {
                    // Ignorar línea mal formada
                    continue; 
                }

                if (!isNaN(match[HOME_GOALS_COL]) && !isNaN(match[AWAY_GOALS_COL]) && match[HOME_TEAM_COL] && match[AWAY_TEAM_COL]) {
                    matches.push(match);
                }
            }

            if (matches.length === 0) {
                throw new Error("No se extrajeron partidos válidos. Revisa la integridad de los datos en el CSV.");
            }

            return matches;
        }

        /**
         * Maneja la entrada de datos (URL o archivo).
         * @param {boolean} isUrl Indica si la entrada es una URL.
         */
        async function handleDataInput(isUrl) {
            const url = document.getElementById('urlInput').value.trim();
            const file = document.getElementById('fileInput').files[0];
            const statusElement = document.getElementById('loadStatus');
            statusElement.className = 'text-sm mt-4 text-center text-gray-500 h-4 font-semibold';
            statusElement.textContent = 'Procesando datos...';
            
            try {
                let csvText = '';

                if (isUrl && url) {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status} ${response.statusText}. La URL podría ser incorrecta o el servidor no responde.`);
                    }
                    csvText = await response.text();
                } else if (!isUrl && file) {
                    csvText = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(new Error('Error al leer el archivo local.'));
                        reader.readAsText(file);
                    });
                } else {
                    throw new Error("Por favor, introduce una URL o selecciona un archivo CSV y pulsa el botón correspondiente.");
                }

                allMatches = parseCSV(csvText);
                calculateAllStrengths();
                populateTeamDropdowns();

                document.getElementById('predictionSection').classList.remove('hidden');
                document.getElementById('resultsSection').classList.add('hidden'); // Ocultar resultados previos
                statusElement.className = 'text-sm mt-4 text-center text-green-600 font-bold h-4';
                statusElement.textContent = `¡Datos de ${allMatches.length} partidos cargados y fuerzas calculadas!`;

            } catch (error) {
                statusElement.className = 'text-sm mt-4 text-center text-red-600 font-bold h-4';
                statusElement.textContent = `Error: ${error.message}`;
                showModal("Error Crítico de Datos", error.message);
                document.getElementById('predictionSection').classList.add('hidden');
            }
        }

        /**
         * Calcula los promedios de la liga.
         */
        function calculateAverages() {
            let totalMatches = allMatches.length;
            let totalHomeGoals = allMatches.reduce((sum, match) => sum + match[HOME_GOALS_COL], 0);
            let totalAwayGoals = allMatches.reduce((sum, match) => sum + match[AWAY_GOALS_COL], 0);

            leagueAverages = {
                avgHomeGoals: totalHomeGoals / totalMatches,
                avgAwayGoals: totalAwayGoals / totalMatches,
                totalMatches: totalMatches
            };
        }

        /**
         * Calcula las fuerzas de ataque (AS) y defensa (DS) para todos los equipos.
         */
        function calculateAllStrengths() {
            calculateAverages();
            const teams = [...new Set([...allMatches.map(m => m[HOME_TEAM_COL]), ...allMatches.map(m => m[AWAY_TEAM_COL])])];
            teamStrengths = {};
            const avg = leagueAverages;

            teams.forEach(team => {
                const homeMatches = allMatches.filter(m => m[HOME_TEAM_COL] === team);
                const awayMatches = allMatches.filter(m => m[AWAY_TEAM_COL] === team);
                
                const numHome = homeMatches.length;
                const numAway = awayMatches.length;

                // Goles Marcados
                const goalsScoredHome = homeMatches.reduce((sum, m) => sum + m[HOME_GOALS_COL], 0);
                const goalsScoredAway = awayMatches.reduce((sum, m) => sum + m[AWAY_GOALS_COL], 0);
                
                // Goles Concedidos
                const goalsConcededHome = homeMatches.reduce((sum, m) => sum + m[AWAY_GOALS_COL], 0);
                const goalsConcededAway = awayMatches.reduce((sum, m) => sum + m[HOME_GOALS_COL], 0);

                // Promedios de Equipo
                const teamAvgHomeScored = numHome > 0 ? goalsScoredHome / numHome : 0;
                const teamAvgAwayScored = numAway > 0 ? goalsScoredAway / numAway : 0;
                const teamAvgHomeConceded = numHome > 0 ? goalsConcededHome / numHome : 0;
                const teamAvgAwayConceded = numAway > 0 ? goalsConcededAway / numAway : 0;

                // Cálculo de Fuerzas (Strength Indices)
                const AS_Home = (avg.avgHomeGoals > 0) ? (teamAvgHomeScored / avg.avgHomeGoals) : 0;
                const AS_Away = (avg.avgAwayGoals > 0) ? (teamAvgAwayScored / avg.avgAwayGoals) : 0;

                const DS_Home = (avg.avgAwayGoals > 0) ? (teamAvgHomeConceded / avg.avgAwayGoals) : 0; // Usamos goles visitantes para el denominador local
                const DS_Away = (avg.avgHomeGoals > 0) ? (teamAvgAwayConceded / avg.avgHomeGoals) : 0; // Usamos goles locales para el denominador visitante

                teamStrengths[team] = {
                    AS_Home: AS_Home,
                    DS_Home: DS_Home,
                    AS_Away: AS_Away,
                    DS_Away: DS_Away
                };
            });
        }

        /**
         * Rellena los dropdowns con los nombres de los equipos.
         */
        function populateTeamDropdowns() {
            const teams = Object.keys(teamStrengths).sort();
            const homeSelect = document.getElementById('homeTeamSelect');
            const awaySelect = document.getElementById('awayTeamSelect');

            // Limpiar opciones previas y resetear
            homeSelect.innerHTML = '<option value="">Seleccionar Local</option>';
            awaySelect.innerHTML = '<option value="">Seleccionar Visitante</option>';

            teams.forEach(team => {
                const optionHome = new Option(team, team);
                const optionAway = new Option(team, team);
                homeSelect.appendChild(optionHome);
                awaySelect.appendChild(optionAway);
            });
        }

        /**
         * Calcula los Goles Esperados (xG).
         */
        function calculateExpectedGoals(homeTeam, awayTeam) {
            const homeStrengths = teamStrengths[homeTeam];
            const awayStrengths = teamStrengths[awayTeam];
            const avg = leagueAverages;

            // xG Local = AS_Local * DS_Visitante * Avg Goles Local
            const xG_Home = homeStrengths.AS_Home * awayStrengths.DS_Away * avg.avgHomeGoals;

            // xG Visitante = AS_Visitante * DS_Local * Avg Goles Visitante
            const xG_Away = awayStrengths.AS_Away * homeStrengths.DS_Home * avg.avgAwayGoals;

            return { xG_Home, xG_Away };
        }

        /**
         * Calcula la probabilidad de Poisson P(X=k) dado lambda.
         */
        function poissonProbability(lambda, k) {
            if (k < 0 || lambda < 0) return 0;

            const factorial = (n) => {
                let res = 1;
                for (let i = 2; i <= n; i++) res *= i;
                return res;
            };

            // P(k; λ) = (e^-λ * λ^k) / k!
            const prob = (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
            return isNaN(prob) ? 0 : prob;
        }

        /**
         * Genera la matriz de probabilidades de Poisson y calcula 1X2.
         */
        function generatePoissonMatrix(expectedGoals, homeTeam, awayTeam) {
            const { xG_Home, xG_Away } = expectedGoals;
            const matrixDiv = document.getElementById('poissonMatrix');

            // Calcular probabilidades individuales para hasta MAX_GOALS
            const homeProbs = Array(MAX_GOALS + 1).fill(0).map((_, k) => poissonProbability(xG_Home, k));
            const awayProbs = Array(MAX_GOALS + 1).fill(0).map((_, k) => poissonProbability(xG_Away, k));
            
            // Si MAX_GOALS es muy bajo, añadir una probabilidad acumulada para el resto
            let homeProbRest = 1 - homeProbs.reduce((a, b) => a + b, 0);
            let awayProbRest = 1 - awayProbs.reduce((a, b) => a + b, 0);

            // Matriz de resultados HTML
            let matrixHTML = `<table class="poisson-table w-full text-center">`;
            
            // Cabecera: Goles Visitante
            matrixHTML += `<thead><tr><th class="bg-blue-900 rounded-tl-lg">${homeTeam} \ ${awayTeam}</th>`;
            for (let j = 0; j <= MAX_GOALS; j++) {
                matrixHTML += `<th class="bg-blue-900">${j}</th>`;
            }
            matrixHTML += `</tr></thead>`;
            
            // Cuerpo: Goles Local y cálculo 1X2
            matrixHTML += `<tbody>`;
            let homeWinProb = 0;
            let awayWinProb = 0;
            let drawProb = 0;
            let maxProb = -1;
            let bestScore = '';

            for (let i = 0; i <= MAX_GOALS; i++) { // Goles Local (i)
                matrixHTML += `<tr><th class="font-bold text-gray-800 bg-gray-200">${i}</th>`;
                for (let j = 0; j <= MAX_GOALS; j++) { // Goles Visitante (j)
                    const prob = homeProbs[i] * awayProbs[j];
                    const probPercent = (prob * 100).toFixed(2);
                    
                    if (prob > maxProb) { 
                        maxProb = prob; 
                        bestScore = `${i}-${j}`;
                    }

                    // Acumular probabilidades
                    if (i > j) { homeWinProb += prob; } 
                    else if (j > i) { awayWinProb += prob; } 
                    else { drawProb += prob; }

                    matrixHTML += `<td data-score="${i}-${j}" data-prob="${prob.toFixed(4)}" class="${probPercent > 0.01 ? 'text-gray-800' : 'text-gray-400'}">${probPercent}%</td>`;
                }
                matrixHTML += `</tr>`;
            }
            matrixHTML += `</tbody></table>`;
            matrixDiv.innerHTML = matrixHTML;

            // Resaltar la probabilidad máxima
            const cells = matrixDiv.querySelectorAll('td');
            cells.forEach(cell => {
                if (cell.getAttribute('data-score') === bestScore && maxProb > 0.005) {
                    cell.classList.add('highlight-cell');
                }
            });
            
            // Retornar resultados 1X2 (sumados hasta MAX_GOALS)
            return { homeWinProb, awayWinProb, drawProb, maxProb, bestScore };
        }
        
        /**
         * Muestra los pronósticos detallados (probabilidades 1X2).
         */
        function displayDetailedForecast(homeTeam, awayTeam, results) {
            lastForecastResults = results; // Guardar resultados para el análisis de valor
            const { homeWinProb, awayWinProb, drawProb, maxProb, bestScore } = results;
            const detailedDiv = document.getElementById('detailedForecast');
            
            const totalProb = homeWinProb + awayWinProb + drawProb;

            let html = `
                <div class="grid grid-cols-3 gap-3 text-center mb-6">
                    <div id="prob1" class="p-3 bg-white rounded-xl shadow-lg border border-indigo-400">
                        <p class="text-sm font-medium text-indigo-700">${homeTeam} Gana (1)</p>
                        <p class="text-2xl font-extrabold text-indigo-800">${(homeWinProb * 100).toFixed(2)}%</p>
                    </div>
                    <div id="probX" class="p-3 bg-white rounded-xl shadow-lg border border-gray-400">
                        <p class="text-sm font-medium text-gray-700">Empate (X)</p>
                        <p class="text-2xl font-extrabold text-gray-800">${(drawProb * 100).toFixed(2)}%</p>
                    </div>
                    <div id="prob2" class="p-3 bg-white rounded-xl shadow-lg border border-red-400">
                        <p class="text-sm font-medium text-red-700">${awayTeam} Gana (2)</p>
                        <p class="text-2xl font-extrabold text-red-800">${(awayWinProb * 100).toFixed(2)}%</p>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-yellow-100 rounded-lg text-center font-bold text-gray-800 border border-yellow-300">
                    <i class="fas fa-star mr-2 text-yellow-500"></i>
                    Marcador más probable (Puntuación Modal): <span class="text-indigo-800">${bestScore}</span> con una probabilidad de <span class="text-indigo-800">${(maxProb * 100).toFixed(2)}%</span>.
                </div>
            `;
            detailedDiv.innerHTML = html;
        }

        /**
         * Muestra los resultados de las fuerzas y goles esperados (xG).
         */
        function displaySummary(homeTeam, awayTeam, xg) {
            const { xG_Home, xG_Away } = xg;
            const homeStrengths = teamStrengths[homeTeam];
            const awayStrengths = teamStrengths[awayTeam];
            const summaryDiv = document.getElementById('summaryResults');
            
            const getColor = (value, inverse = false) => {
                if (value > 1.05) return inverse ? 'text-red-600' : 'text-green-600';
                if (value < 0.95) return inverse ? 'text-green-600' : 'text-red-600';
                return 'text-gray-600';
            };
            
            const getIcon = (value, inverse = false) => {
                 if (value > 1.05) return inverse ? '<i class="fas fa-shield-alt"></i> Debil' : '<i class="fas fa-fist-raised"></i> Fuerte';
                if (value < 0.95) return inverse ? '<i class="fas fa-fist-raised"></i> Fuerte' : '<i class="fas fa-shield-alt"></i> Debil';
                return '<i class="fas fa-equals"></i> Promedio';
            };


            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Home Team Summary -->
                    <div class="p-5 bg-white rounded-lg shadow-lg border-t-4 border-blue-600">
                        <h4 class="text-xl font-bold text-blue-800 mb-3 flex items-center"><i class="fas fa-home mr-2"></i> ${homeTeam} (Local)</h4>
                        
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-700">Fuerza de Ataque (AS):</span>
                            <span class="text-lg font-extrabold ${getColor(homeStrengths.AS_Home)}">${homeStrengths.AS_Home.toFixed(3)} (${getIcon(homeStrengths.AS_Home)})</span>
                        </div>
                         <div class="flex justify-between items-center mb-3">
                            <span class="font-semibold text-gray-700">Fuerza de Defensa (DS):</span>
                            <span class="text-lg font-extrabold ${getColor(homeStrengths.DS_Home, true)}">${homeStrengths.DS_Home.toFixed(3)} (${getIcon(homeStrengths.DS_Home, true)})</span>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-lg font-bold text-blue-800">Goles Esperados (xG):</p> 
                            <p class="text-5xl font-extrabold text-blue-800">${xG_Home.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <!-- Away Team Summary -->
                    <div class="p-5 bg-white rounded-lg shadow-lg border-t-4 border-red-600">
                        <h4 class="text-xl font-bold text-red-800 mb-3 flex items-center"><i class="fas fa-plane-departure mr-2"></i> ${awayTeam} (Visitante)</h4>
                        
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-700">Fuerza de Ataque (AS):</span>
                            <span class="text-lg font-extrabold ${getColor(awayStrengths.AS_Away)}">${awayStrengths.AS_Away.toFixed(3)} (${getIcon(awayStrengths.AS_Away)})</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-semibold text-gray-700">Fuerza de Defensa (DS):</span>
                            <span class="text-lg font-extrabold ${getColor(awayStrengths.DS_Away, true)}">${awayStrengths.DS_Away.toFixed(3)} (${getIcon(awayStrengths.DS_Away, true)})</span>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-lg font-bold text-red-800">Goles Esperados (xG):</p>
                            <p class="text-5xl font-extrabold text-red-800">${xG_Away.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <p class="text-xs text-gray-500 mt-4 italic">
                    <span class="font-bold">Nota:</span> AS > 1.0 indica un ataque más fuerte que el promedio de la liga. DS < 1.0 indica una defensa más fuerte que el promedio.
                </p>
            `;
            summaryDiv.innerHTML = html;
        }

        /**
         * Calcula el valor de la apuesta comparando la probabilidad del modelo con la implícita de la cuota.
         */
        function calculateValue() {
            if (!lastForecastResults) {
                document.getElementById('valueResults').innerHTML = '<p class="text-red-500 text-center font-semibold">Primero ejecuta la predicción del partido.</p>';
                return;
            }

            const odds1 = parseFloat(document.getElementById('odds1').value);
            const oddsX = parseFloat(document.getElementById('oddsX').value);
            const odds2 = parseFloat(document.getElementById('odds2').value);
            
            if (isNaN(odds1) && isNaN(oddsX) && isNaN(odds2)) {
                 document.getElementById('valueResults').innerHTML = '<p class="text-sm text-gray-500 text-center">Ingresa las cuotas para ver el análisis de valor.</p>';
                 return;
            }
            
            const { homeWinProb, awayWinProb, drawProb } = lastForecastResults;

            const results = [
                { prob: homeWinProb, odds: odds1, label: 'Local (1)', id: 'prob1', color: 'bg-indigo-500' },
                { prob: drawProb, odds: oddsX, label: 'Empate (X)', id: 'probX', color: 'bg-gray-500' },
                { prob: awayWinProb, odds: odds2, label: 'Visitante (2)', id: 'prob2', color: 'bg-red-500' }
            ];

            let html = '<div class="space-y-3">';
            let foundValueBet = false;

            results.forEach(res => {
                if (res.odds && res.odds > 1) {
                    const impliedProb = 1 / res.odds; // Probabilidad Implícita de la Cuota
                    const valuePercentage = ((res.prob / impliedProb) - 1) * 100;
                    
                    let valueClass = 'bg-gray-200 text-gray-700';
                    let valueText = 'No hay valor';
                    
                    // Condición para Apuesta de Valor (Value Bet)
                    if (valuePercentage > 5) { // Más de 5% de valor
                        valueClass = 'bg-green-600 text-white shadow-lg';
                        valueText = `<i class="fas fa-arrow-up"></i> ¡VALUE BET! (${valuePercentage.toFixed(1)}%)`;
                        foundValueBet = true;
                    } else if (valuePercentage < -5) {
                        valueClass = 'bg-red-200 text-red-800';
                        valueText = `<i class="fas fa-arrow-down"></i> Sin Valor (-${Math.abs(valuePercentage).toFixed(1)}%)`;
                    } else {
                        valueText = `<i class="fas fa-minus"></i> Valor Neutral (${valuePercentage.toFixed(1)}%)`;
                    }
                    
                    html += `
                        <div class="flex items-center p-3 rounded-lg border border-gray-300 bg-white">
                            <span class="w-20 text-sm font-bold ${res.color} text-white p-1 rounded text-center">${res.label}</span>
                            <div class="ml-4 flex-grow grid grid-cols-3 text-sm">
                                <p class="font-semibold text-center">Modelo: ${(res.prob * 100).toFixed(2)}%</p>
                                <p class="font-semibold text-center">Cuota (${res.odds.toFixed(2)}): ${(impliedProb * 100).toFixed(2)}%</p>
                                <p class="font-extrabold text-center py-1 rounded ${valueClass}">${valueText}</p>
                            </div>
                        </div>
                    `;
                }
            });

            if (!foundValueBet && (odds1 || oddsX || odds2)) {
                 html += '<p class="mt-4 text-center text-sm text-gray-700 font-semibold p-2 bg-yellow-100 rounded">No se encontraron Apuestas de Valor significativas (>5%) en esta comparación.</p>';
            }

            html += '</div>';
            document.getElementById('valueResults').innerHTML = html;
        }

        /**
         * Función principal para ejecutar todos los cálculos y mostrar los resultados.
         */
        function runCalculations() {
            const homeTeam = document.getElementById('homeTeamSelect').value;
            const awayTeam = document.getElementById('awayTeamSelect').value;
            
            if (!homeTeam || !awayTeam) {
                showModal("Selección Incompleta", "Por favor, selecciona un equipo local y uno visitante de la lista.");
                return;
            }

            if (homeTeam === awayTeam) {
                showModal("Error de Selección", "El equipo local y el visitante deben ser diferentes.");
                return;
            }

            try {
                // 1. Calcular Goles Esperados (xG)
                const expectedGoals = calculateExpectedGoals(homeTeam, awayTeam);

                // 2. Mostrar Resumen de Fuerzas y xG
                displaySummary(homeTeam, awayTeam, expectedGoals);

                // 3. Generar Matriz Poisson
                const results = generatePoissonMatrix(expectedGoals, homeTeam, awayTeam);
                
                // 4. Mostrar Pronósticos Detallados 1X2
                displayDetailedForecast(homeTeam, awayTeam, results);

                // 5. Reiniciar análisis de valor
                document.getElementById('odds1').value = '';
                document.getElementById('oddsX').value = '';
                document.getElementById('odds2').value = '';
                document.getElementById('valueResults').innerHTML = '<p class="text-sm text-gray-500 text-center">Ingresa las cuotas para ver el análisis de valor.</p>';

                // Mostrar la sección de resultados
                document.getElementById('resultsSection').classList.remove('hidden');

            } catch (error) {
                showModal("Error en el Cálculo", `No se pudieron calcular las predicciones. Razón: ${error.message}`);
            }
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson - Veredicto Qu√≠ntuple</title>
    <style>
        /* Estilos CSS Base */
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); width: 100%; max-width: 900px; text-align: center; }
        h1 { color: #8b008b; margin-bottom: 15px; border-bottom: 3px solid #8b008b; padding-bottom: 10px; font-size: 2em; }
        h2 { color: #007bff; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-row { border: 1px solid #8b008b; border-radius: 5px; padding: 15px; }
        .input-row h3 { color: #8b008b; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 0; }
        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { font-weight: bold; display: block; font-size: 0.9em; margin-bottom: 2px; }
        .input-group input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; text-align: center; }
        button { width: 80%; padding: 12px; background-color: #8b008b; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px; }
        button:hover { background-color: #5d005d; }
        
        /* Resultados */
        #results { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .rates-summary { background-color: #f3e5f5; border: 1px solid #ce93d8; color: #4a148c; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        
        /* Tabla de Veredictos */
        #verdict_table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #verdict_table th, #verdict_table td { border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 1.1em; }
        #verdict_table th { background-color: #8b008b; color: white; }
        #verdict_table td:nth-child(1) { font-weight: bold; text-align: left; }
        
        /* Clases de Veredicto */
        .bet-cell { background-color: #e6ffe6; color: #388e3c; font-weight: bold; }
        .pass-cell { background-color: #ffeeee; color: #d32f2f; }
        .bet-text { font-size: 1.2em; font-weight: 900; }
        
        /* An√°lisis */
        #analysis_section { background-color: #fff8e1; border: 2px solid #ffd700; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left; }
        #analysis_section h3 { color: #b8860b; margin-top: 0; border-bottom: 1px dashed #ffeeba; padding-bottom: 5px; }
        .efficiency-summary { margin-bottom: 10px; font-size: 1em; }
        .context-text { font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="container">
        <h1> ‚öΩ Modelo Poisson Refinado: Veredicto Qu√≠ntuple </h1>
        <p>Introduce Goles Esperados ($\lambda$) y las m√©tricas de disparo para obtener un an√°lisis de riesgo y el veredicto.</p>
           
        <div class="input-grid">
            <div class="input-row">
                <h3>Local</h3>
                <div class="input-group">
                    <label for="home_lambda">Goles Esperados ($\lambda$):</label>
                    <input type="number" id="home_lambda" value="1.8" step="0.01" min="0">
                </div>
                <div class="input-group">
                    <label for="home_sot">Disparos a Puerta (SOT) Promedio:</label>
                    <input type="number" id="home_sot" value="4.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="home_spg">Disparos por Gol (S/G) Promedio:</label>
                    <input type="number" id="home_spg" value="4.0" step="0.1" min="0">
                </div>
            </div>

            <div class="input-row">
                <h3>Visitante</h3>
                <div class="input-group">
                    <label for="away_lambda">Goles Esperados ($\lambda$):</label>
                    <input type="number" id="away_lambda" value="1.5" step="0.01" min="0">
                </div>
                <div class="input-group">
                    <label for="away_sot">Disparos a Puerta (SOT) Promedio:</label>
                    <input type="number" id="away_sot" value="5.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="away_spg">Disparos por Gol (S/G) Promedio:</label>
                    <input type="number" id="away_spg" value="7.0" step="0.1" min="0">
                </div>
            </div>
        </div>

        <button onclick="calculateProbabilities()">Calcular Pron√≥stico y Veredicto</button>
        
        <div id="results">
            <h2>Resultados y Veredicto</h2>

            <div class="rates-summary" id="calculated_rates_summary">
                $\lambda_{\text{Local}}$: 0.00 | $\lambda_{\text{Visita}}$: 0.00 | $\lambda_{\text{Total}}$: 0.00 | Umbral de Apuesta: 0.00%
            </div>
            
            <table id="verdict_table">
                <thead>
                    <tr>
                        <th>Mercado</th>
                        <th>Probabilidad (%)</th>
                        <th>Cuota Impl√≠cita</th>
                        <th>Veredicto</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="over_0_5_row">
                        <td>M√ÅS de 0.5 Goles</td>
                        <td id="prob_over_0_5_td">0.00%</td>
                        <td id="odd_over_0_5_td">0.00</td>
                        <td id="verdict_over_0_5_td"></td>
                    </tr>
                    <tr id="under_0_5_row">
                        <td>MENOS de 0.5 Goles</td>
                        <td id="prob_under_0_5_td">0.00%</td>
                        <td id="odd_under_0_5_td">0.00</td>
                        <td id="verdict_under_0_5_td"></td>
                    </tr>
                    <tr><td colspan="4" style="background-color:#eee; height:10px;"></td></tr>
                    <tr id="btts_yes_row">
                        <td>Ambos Anotan S√ç</td>
                        <td id="prob_btts_yes_td">0.00%</td>
                        <td id="odd_btts_yes_td">0.00</td>
                        <td id="verdict_btts_yes_td"></td>
                    </tr>
                    <tr id="btts_no_row">
                        <td>Ambos Anotan NO</td>
                        <td id="prob_btts_no_td">0.00%</td>
                        <td id="odd_btts_no_td">0.00</td>
                        <td id="verdict_btts_no_td"></td>
                    </tr>
                    <tr><td colspan="4" style="background-color:#eee; height:10px;"></td></tr>
                    <tr id="over_2_5_row">
                        <td>M√ÅS de 2.5 Goles</td>
                        <td id="prob_over_2_5_td">0.00%</td>
                        <td id="odd_over_2_5_td">0.00</td>
                        <td id="verdict_over_2_5_td"></td>
                    </tr>
                    <tr id="under_2_5_row">
                        <td>MENOS de 2.5 Goles</td>
                        <td id="prob_under_2_5_td">0.00%</td>
                        <td id="odd_under_2_5_td">0.00</td>
                        <td id="verdict_under_2_5_td"></td>
                    </tr>
                </tbody>
            </table>
            
            <div id="analysis_section">
                <h3>üéØ An√°lisis de Presi√≥n y Eficiencia</h3>
                <div class="efficiency-summary" id="sot_summary"></div>
                <div class="efficiency-summary" id="spg_summary"></div>
                <div class="context-text" id="efficiency_context"></div>
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n de Probabilidad de Poisson P(k; lambda)
        function poissonProbability(k, lambda) {
            if (k < 0 || lambda < 0) return 0;
            if (lambda === 0 && k > 0) return 0;
            if (lambda === 0 && k === 0) return 1;
            
            let factorial = 1;
            for (let i = 2; i <= k; i++) {
                factorial *= i;
            }
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial;
        }

        // Calcula las probabilidades de los mercados principales
        function calculateMarketProbs(lambdaHome, lambdaAway) {
            const lambdaTotal = lambdaHome + lambdaAway;
            
            // Probabilidad de Ambos Anotan (BTTS)
            const probHomeZero = poissonProbability(0, lambdaHome);
            const probAwayZero = poissonProbability(0, lambdaAway);
            const probZeroZero = probHomeZero * probAwayZero; 
            const probBTTsNo = probHomeZero + probAwayZero - probZeroZero;
            const probBTTsYes = 1 - probBTTsNo;

            // Probabilidad de M√°s/Menos de 0.5 Goles
            const probTotalZero = poissonProbability(0, lambdaTotal);
            const probUnder0_5 = probTotalZero;
            const probOver0_5 = 1 - probUnder0_5;

            // Probabilidad de M√°s/Menos de 2.5 Goles
            const probTotalOne = poissonProbability(1, lambdaTotal);
            const probTotalTwo = poissonProbability(2, lambdaTotal);
            const probUnder2_5 = probTotalZero + probTotalOne + probTotalTwo;
            const probOver2_5 = 1 - probUnder2_5;

            return {
                lambdaHome: lambdaHome,
                lambdaAway: lambdaAway,
                lambdaTotal: lambdaTotal,
                bttsYes: probBTTsYes,
                bttsNo: probBTTsNo,
                over0_5: probOver0_5, // Nuevo
                under0_5: probUnder0_5, // Nuevo
                over2_5: probOver2_5,
                under2_5: probUnder2_5
            };
        }
        
        // Funciones de formato
        const format = (p) => (p * 100).toFixed(2);
        const formatOdd = (p) => (p > 0.005 ? (1 / p).toFixed(2) : '‚àû');

        /**
         * Determina el umbral de apuesta seg√∫n la eficiencia (S/G).
         * @param {number} homeSPG - S/G Local
         * @param {number} awaySPG - S/G Visitante
         * @returns {number} Umbral de probabilidad para apostar (e.g., 0.60)
         */
        function getBettingThreshold(homeSPG, awaySPG) {
            const PROB_BASE = 0.60; // Umbral de probabilidad est√°ndar (60%)
            const isHomeEfficient = homeSPG <= 4.0;
            const isAwayEfficient = awaySPG <= 4.0;
            const isHomeInefficient = homeSPG >= 7.0;
            const isAwayInefficient = awaySPG >= 7.0;

            let riskFactor = 0; // 0: Neutro, +1: Bajo Riesgo (Eficiente), -1: Alto Riesgo (Ineficiente)

            if (isHomeEfficient && isAwayEfficient) {
                riskFactor = 1; // Ambos eficientes: Bajo Riesgo
            } else if (isHomeInefficient && isAwayInefficient) {
                riskFactor = -1; // Ambos ineficientes: Alto Riesgo
            } else if (isHomeEfficient || isAwayEfficient) {
                riskFactor = 0; // Al menos uno es eficiente, riesgo medio.
            }

            if (riskFactor === 1) { 
                return 0.55; // Reducir umbral al 55%
            } else if (riskFactor === -1) { 
                return 0.65; // Aumentar umbral al 65%
            } else {
                return PROB_BASE; // Mantener 60%
            }
        }

        /**
         * Genera el veredicto para un mercado.
         * @param {number} probability - Probabilidad calculada (0.0 a 1.0)
         * @param {number} threshold - Umbral de probabilidad para apostar (0.0 a 1.0)
         * @param {string} tdId - ID del elemento <td> para el veredicto
         */
        function renderVerdict(probability, threshold, tdId) {
            const tdElement = document.getElementById(tdId);
            tdElement.textContent = ""; // Limpiar
            tdElement.className = '';

            if (probability >= threshold) {
                tdElement.textContent = '‚úÖ APOSTAR';
                tdElement.className = 'bet-cell bet-text';
            } else {
                tdElement.textContent = '‚ùå DEJAR PASAR';
                tdElement.className = 'pass-cell bet-text';
            }
        }
        
        // Funci√≥n principal de c√°lculo y veredicto
        function calculateProbabilities() {
            // 1. Obtener entradas del usuario
            const lambdaHome = parseFloat(document.getElementById('home_lambda').value);
            const homeSOT = parseFloat(document.getElementById('home_sot').value);
            const homeSPG = parseFloat(document.getElementById('home_spg').value); 
            
            const lambdaAway = parseFloat(document.getElementById('away_lambda').value);
            const awaySOT = parseFloat(document.getElementById('away_sot').value);
            const awaySPG = parseFloat(document.getElementById('away_spg').value);
            
            // Validaci√≥n
            if (isNaN(lambdaHome) || isNaN(homeSPG) || lambdaHome < 0 || homeSPG <= 0 ||
                isNaN(lambdaAway) || isNaN(awaySPG) || lambdaAway < 0 || awaySPG <= 0) {
                alert('Por favor, introduzca valores v√°lidos y positivos.');
                return;
            }
            
            // 2. Calcular los mercados (Base Poisson)
            const results = calculateMarketProbs(lambdaHome, lambdaAway);
            const bettingThreshold = getBettingThreshold(homeSPG, awaySPG);

            // 3. Actualizar la Interfaz de Resultados (Probabilidades y Cuotas)
            document.getElementById('calculated_rates_summary').innerHTML = 
                `$\lambda_{\\text{Local}}$: ${results.lambdaHome.toFixed(3)} | 
                $\lambda_{\\text{Visita}}$: ${results.lambdaAway.toFixed(3)} | 
                $\lambda_{\\text{Total}}$: ${results.lambdaTotal.toFixed(3)} | 
                Umbral de Apuesta: ${(bettingThreshold * 100).toFixed(0)}%`;
            
            // OVER 0.5 (NUEVO)
            document.getElementById('prob_over_0_5_td').textContent = format(results.over0_5) + '%';
            document.getElementById('odd_over_0_5_td').textContent = formatOdd(results.over0_5);
            renderVerdict(results.over0_5, bettingThreshold, 'verdict_over_0_5_td');

            // UNDER 0.5 (NUEVO)
            document.getElementById('prob_under_0_5_td').textContent = format(results.under0_5) + '%';
            document.getElementById('odd_under_0_5_td').textContent = formatOdd(results.under0_5);
            renderVerdict(results.under0_5, bettingThreshold, 'verdict_under_0_5_td');
            
            // BTTS S√ç
            document.getElementById('prob_btts_yes_td').textContent = format(results.bttsYes) + '%';
            document.getElementById('odd_btts_yes_td').textContent = formatOdd(results.bttsYes);
            renderVerdict(results.bttsYes, bettingThreshold, 'verdict_btts_yes_td');

            // BTTS NO
            document.getElementById('prob_btts_no_td').textContent = format(results.bttsNo) + '%';
            document.getElementById('odd_btts_no_td').textContent = formatOdd(results.bttsNo);
            renderVerdict(results.bttsNo, bettingThreshold, 'verdict_btts_no_td');
            
            // OVER 2.5
            document.getElementById('prob_over_2_5_td').textContent = format(results.over2_5) + '%';
            document.getElementById('odd_over_2_5_td').textContent = formatOdd(results.over2_5);
            renderVerdict(results.over2_5, bettingThreshold, 'verdict_over_2_5_td');

            // UNDER 2.5
            document.getElementById('prob_under_2_5_td').textContent = format(results.under2_5) + '%';
            document.getElementById('odd_under_2_5_td').textContent = formatOdd(results.under2_5);
            renderVerdict(results.under2_5, bettingThreshold, 'verdict_under_2_5_td');
            
            // 4. AN√ÅLISIS DE PRESI√ìN Y EFICIENCIA (SOT y S/G)
            let efficiencyContext = "";
            
            document.getElementById('sot_summary').innerHTML = `SOT Promedio: **Local ${homeSOT.toFixed(1)}** vs. **Visita ${awaySOT.toFixed(1)}**`;
            
            const isHomeEfficient = homeSPG <= 4.0;
            const isAwayEfficient = awaySPG <= 4.0;
            const isHomeInefficient = homeSPG >= 7.0;
            const isAwayInefficient = awaySPG >= 7.0;

            document.getElementById('spg_summary').innerHTML = `S/G Promedio: **Local ${homeSPG.toFixed(1)}** vs. **Visita ${awaySPG.toFixed(1)}**`;

            if (isHomeEfficient && isAwayEfficient) {
                efficiencyContext = "Ambos equipos son **altamente eficientes** (S/G bajo). El riesgo de fallar un Over/BTTS por ineficiencia es BAJO. ";
            } else if (isHomeInefficient && isAwayInefficient) {
                efficiencyContext = "Ambos equipos son **ineficientes** (S/G alto). El riesgo de fallar un Over/BTTS por ineficiencia es ALTO. ";
            } else if (isHomeEfficient || isAwayEfficient) {
                 efficiencyContext = `Hay un equilibrio de eficiencia (Local ${isHomeEfficient ? 'Eficiente' : 'Normal/Ineficiente'} vs. Visita ${isAwayEfficient ? 'Eficiente' : 'Normal/Ineficiente'}). `;
            } else {
                efficiencyContext = "Ambos equipos tienen una **eficiencia media** (S/G entre 4.0 y 7.0). ";
            }

            document.getElementById('efficiency_context').innerHTML = `**AN√ÅLISIS DE EFICIENCIA/RIESGO:** ${efficiencyContext}`;
        }

        // Ejecutar el c√°lculo al cargar la p√°gina con los valores por defecto
        document.addEventListener('DOMContentLoaded', calculateProbabilities);
    </script>
</body>
</html>

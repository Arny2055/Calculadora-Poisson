<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting de BetMines CSV</title>
    <style>
        /* Estilos */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        #csvFile { margin-bottom: 20px; }
        #results { 
            margin-top: 30px; 
            padding: 15px; 
            border: 1px solid #ddd; 
            background-color: #e9e9f9; 
            font-size: 16px;
        }
        .profit { color: green; font-weight: bold; }
        .loss { color: red; font-weight: bold; }
        .neutral { color: orange; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üìà Backtesting Autom√°tico de BetMines</h2>

        <form id="csvForm">
            <label for="csvFile">Cargar Archivo CSV de Historial de BetMines:</label>
            <input type="file" id="csvFile" name="historialCSV" accept=".csv" required>
        </form>

        <p>A continuaci√≥n, se aplicar√° la estrategia y se mostrar√° la rentabilidad:</p>
        
        <div id="results">
            Esperando la carga del archivo CSV...
        </div>
    </div>

    <script>
        const csvFile = document.getElementById('csvFile');
        const resultsDiv = document.getElementById('results');

        // Escucha el cambio en el input para iniciar la lectura
        csvFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    runBacktest(content);
                };
                reader.readAsText(file);
            }
        });

        /**
         * Funci√≥n principal para ejecutar el Backtesting
         * @param {string} csvText - Contenido del archivo CSV
         */
        function runBacktest(csvText) {
            // Dividir el texto en filas y eliminar la primera fila (encabezados)
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) {
                resultsDiv.innerHTML = "El archivo CSV est√° vac√≠o o solo contiene encabezados.";
                return;
            }

            // Asumimos que la primera l√≠nea contiene los encabezados.
            const headers = lines[0].split(',');
            
            // **IMPORTANTE**: Debes verificar que tu CSV de BetMines contenga estas columnas:
            // 1. Un indicador del Resultado Final (e.g., 'FT Result' o similar: H, D, A)
            // 2. La cuota del equipo local (e.g., 'Home Odd' o similar)
            
            // √çndices de columna (aj√∫stalos si el orden de tu CSV es diferente)
            // Estos son ejemplos comunes:
            const RESULT_INDEX = 10; // Columna donde est√° el resultado final (H, D, A)
            const HOME_ODD_INDEX = 1; // Columna donde est√° la cuota del local

            let totalApuestas = 0;
            let saldoFinal = 0;
            const STAKE_SIZE = 1; // Apuesta fija de 1 unidad (por ejemplo, 1‚Ç¨)

            // Procesar cada partido (empezamos en 1 para saltar los encabezados)
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');

                if (values.length < Math.max(RESULT_INDEX, HOME_ODD_INDEX) + 1) {
                    // console.warn('Fila incompleta saltada:', lines[i]);
                    continue; // Saltar filas incompletas
                }

                // Obtener los datos clave del partido
                const homeOdd = parseFloat(values[HOME_ODD_INDEX]);
                const ftResult = values[RESULT_INDEX].trim().toUpperCase(); // H, D, A

                // ----------------------------------------------------------------
                // üöÄ ESTRATEGIA DE BACKTESTING: Apuesta al local si la cuota es < 2.00
                // ----------------------------------------------------------------

                const STRATEGY_ODD_LIMIT = 2.00;
                
                if (homeOdd < STRATEGY_ODD_LIMIT) {
                    totalApuestas++;
                    let ganancia = -STAKE_SIZE; // Inicialmente, perdemos el Stake

                    if (ftResult === 'H') { // Si el local gan√≥
                        // Ganancia = (Cuota * Stake) - Stake
                        ganancia = (homeOdd * STAKE_SIZE) - STAKE_SIZE;
                    }
                    
                    saldoFinal += ganancia;
                }
            }

            // ----------------------------------------------------------------
            // üèÜ MOSTRAR RESULTADOS
            // ----------------------------------------------------------------

            let profitabilityClass = 'neutral';
            if (saldoFinal > 0) {
                profitabilityClass = 'profit';
            } else if (saldoFinal < 0) {
                profitabilityClass = 'loss';
            }
            
            const totalReturn = (saldoFinal / (totalApuestas * STAKE_SIZE)) * 100;

            let htmlOutput = `
                <h3>Resultados del Backtesting</h3>
                <p><strong>Estrategia aplicada:</strong> Apostar al Local (H) si la cuota del local (Home Odd) es inferior a ${STRATEGY_ODD_LIMIT.toFixed(2)}.</p>
                <hr>
                <p>‚û°Ô∏è Total de partidos analizados (filas): **${lines.length - 1}**</p>
                <p>‚û°Ô∏è Total de apuestas realizadas por la estrategia: **${totalApuestas}**</p>
                <p>‚û°Ô∏è Stake (Apuesta por partido): **${STAKE_SIZE} unidad**</p>
                <hr>
                <h4>Balance Final</h4>
                <p>G / P Netas (unidades): <span class="${profitabilityClass}">${saldoFinal.toFixed(2)} unidades</span></p>
                <p>Retorno de Inversi√≥n (ROI): <span class="${profitabilityClass}">${totalReturn.toFixed(2)}%</span></p>
            `;

            resultsDiv.innerHTML = htmlOutput;
        }

    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩÔ∏è Analizador de Probabilidades (Consenso de 3 Herramientas)</title>
    <style>
        /* --- Estilos CSS --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #eef2f7; }
        .container { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input[type="file"], button, select { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; 
            border: 1px solid #dcdfe6; box-sizing: border-box; font-size: 16px;
        }
        input[type="file"] { background-color: #f7f9fb; }
        button { 
            background-color: #007bff;
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        .result-box { 
            margin-top: 25px; padding: 20px; border: 3px solid #333; 
            border-radius: 8px; background-color: #fff;
        }
        .analysis { 
            background: #f0f0f0;
            padding: 15px; border-left: 5px solid #ffc107;
            margin-top: 20px; border-radius: 4px;
        }
        .recommendation {
            font-size: 1.1em;
            font-weight: bold;
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            text-align: center;
        }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        p strong { color: #333; }
        .info { font-size: 0.9em; color: #6c757d; margin-top: -5px; }

        /* Estilos de Tablas para Consenso */
        .metrics-table { 
            width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em;
        }
        .metrics-table th, .metrics-table td { 
            border: 1px solid #ddd; padding: 8px; text-align: center; 
        }
        .metrics-table th { 
            background-color: #007bff; color: white; 
        }
        .consensus-row {
            background-color: #d4edda; font-weight: bold;
        }

        /* Estilos para la Gu√≠a de An√°lisis */
        .guide-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid #ccc;
        }
        .guide-section h4 {
            color: #d9534f;
            border-bottom: 2px solid #d9534f;
            padding-bottom: 5px;
            margin-top: 0;
        }
        .step { margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 10px; }
        .step strong { color: #007bff; }
        .step-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .step-table th, .step-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .step-table th { background-color: #f7f7f7; }
    </style>
</head>
<body>

    <div class="container">
        <h2>‚öΩÔ∏è An√°lisis Predictivo de Goles</h2>

        <label for="jsonFile">**1. Cargar Historial de Partidos (JSON):**</label>
        <input type="file" id="jsonFile" accept=".json">
        <p class="info">El script analiza el historial completo, la forma reciente (√∫ltimos 10) y el H2H.</p>

        <hr>

        <label for="leagueSelect">**2. Seleccionar Liga:**</label>
        <select id="leagueSelect" onchange="populateTeams()" disabled>
            <option value="">Cargue el archivo primero...</option>
        </select>

        <label for="localTeam">**3. Equipo Local:**</label>
        <select id="localTeam" disabled>
            <option value="">Seleccione la liga para ver los equipos</option>
        </select>

        <label for="visitorTeam">**4. Equipo Visitante:**</label>
        <select id="visitorTeam" disabled>
            <option value="">Seleccione la liga para ver los equipos</option>
        </select>
        
        <p class="info">‚ö†Ô∏è La predicci√≥n se pondera usando **√∫ltimos 10 partidos (60%)** y **historial (40%)**.</p>

        <button onclick="analyzeData()">Analizar Probabilidades</button>

        <hr>

        <div id="results" class="result-box" style="display: none;">
            <h3>üìä Consenso de 3 Herramientas de Pron√≥stico</h3>
            
            <table class="metrics-table">
                <thead>
                    <tr>
                        <th>Herramienta (Modelo)</th>
                        <th>Goles Esperados (Total $\lambda$)</th>
                        <th>Probabilidad +2.5 Goles</th>
                    </tr>
                </thead>
                <tbody id="metricsBody">
                    </tbody>
                <tfoot>
                    <tr class="consensus-row">
                        <td>MEDIA CONSENSUADA</td>
                        <td id="avgXGoals"></td>
                        <td id="avgProb25"></td>
                    </tr>
                </tfoot>
            </table>

            <p><strong>Probabilidad BTTS (Modelo Ponderado):</strong> <span id="probBTTS"></span></p>


            <div class="analysis">
                <h4>üß† Desglose del An√°lisis Ponderado:</h4>
                <p id="personalAnalysis"></p>
                <div id="finalRecommendation" class="recommendation"></div>
            </div>
            
            <div class="guide-section">
                <h4>üìù Gu√≠a de An√°lisis Estructurado para Validaci√≥n</h4>
                <div class="step">
                    <strong>Paso 1: Revisar la Base Num√©rica y el Consenso</strong>
                    <ul>
                        <li>**Media Consensuada:** ¬øEl $\lambda$ promedio y la Prob. +2.5 Goles indican una tendencia alta ($\geq 2.80$ o $\geq 65\%$)?</li>
                        <li>**Consistencia:** ¬øLas 3 herramientas (LP, CP, Ponderado) est√°n cerca del consenso, o hay mucha dispersi√≥n? Si el CP es muy diferente, la forma reciente es el factor dominante.</li>
                    </ul>
                </div>
                <div class="step">
                    <strong>Paso 2: Evaluar el Momentum y H2H</strong>
                    <p>Use la secci√≥n de Desglose del An√°lisis (Forma Reciente y H2H) para confirmar la predicci√≥n de consenso:</p>
                    <table class="step-table">
                        <thead>
                            <tr>
                                <th>Escenario</th>
                                <th>Indicador</th>
                                <th>Confianza en la Predicci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>**OVER (M√°s de 2.5)**</td>
                                <td>üìà Ataque en Forma y/o üö® Defensa D√©bil</td>
                                <td>**Aumenta** la confianza. La forma apoya el $xG$ alto.</td>
                            </tr>
                            <tr>
                                <td>**UNDER (Menos de 2.5)**</td>
                                <td>üìâ Ataque en Baja y/o üõ°Ô∏è Defensa S√≥lida</td>
                                <td>**Aumenta** la confianza. La forma apoya el $xG$ bajo.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="step">
                    <strong>Paso 3: Tomar la Decisi√≥n Final</strong>
                    <p>La **DECISI√ìN FINAL** de la calculadora (basada en la Probabilidad Ponderada) debe ser su primera opci√≥n, salvo que se active un **VETO**:</p>
                    <ul>
                        <li>**VETO H2H:** Si la DECISI√ìN FINAL es "Over" pero el H2H de 4+ partidos muestra un **80% de "Under"**, considere reducir la apuesta a "M√°s de 1.5".</li>
                        <li>**VETO Forma:** Si la DECISI√ìN FINAL es "Incierta", pero ambos equipos tienen indicadores de **Ataque en Forma (üìà)**, puede tomar el riesgo en "BTTS S√≠" o "M√°s de 1.5".</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Constantes para la ponderaci√≥n del an√°lisis ---
        const RECENT_MATCH_COUNT = 10; 
        const WEIGHT_RECENT = 0.6; 
        const WEIGHT_HISTORICAL = 0.4; 

        // Umbrales para la decisi√≥n final
        const THRESHOLD_OVER_25 = 0.65; 
        const THRESHOLD_UNDER_25 = 0.45; 
        const THRESHOLD_BTTS = 0.60; 
        const THRESHOLD_BTTS_NO = 0.40; 


        let matchHistory = [];
        const leagueSelect = document.getElementById('leagueSelect');
        const localTeamSelect = document.getElementById('localTeam');
        const visitorTeamSelect = document.getElementById('visitorTeam');

        /**
         * Funci√≥n para limpiar, mapear y normalizar los datos del JSON.
         */
        function cleanAndMapData(data) {
            
            const cleanedData = data.map(match => {
                const matchString = match.Match ? String(match.Match).trim() : null;
                const resultString = match['Result FT'] ? String(match['Result FT']).trim() : null;
                
                let local = '';
                let visitante = '';
                let golesLocal = 0;
                let golesVisitante = 0;
                
                if (matchString && matchString.includes(' - ')) {
                    const parts = matchString.split(' - ').map(p => p.trim());
                    if (parts.length === 2) {
                        local = parts[0];
                        visitante = parts[1];
                    }
                }
                
                if (resultString && resultString.includes('-')) {
                    const scoreParts = resultString.split('-').map(p => parseInt(p.trim()));
                    if (scoreParts.length === 2 && !isNaN(scoreParts[0]) && !isNaN(scoreParts[1])) {
                        golesLocal = scoreParts[0];
                        golesVisitante = scoreParts[1];
                    }
                }
                
                return {
                    ...match, 
                    liga: match.League ? String(match.League).trim() : 'Sin Liga',
                    local: local,
                    visitante: visitante,
                    golesLocal: golesLocal,
                    golesVisitante: golesVisitante,
                    date: new Date(match.Date), 
                    rawDate: match.Date
                };
            });
            
            // Filtramos y ordenamos por fecha (m√°s recientes al final)
            const validMatches = cleanedData
                .filter(match => match.local && match.visitante && !isNaN(match.golesLocal) && !isNaN(match.date))
                .sort((a, b) => a.date - b.date);
            
            return validMatches;
        }

        // Manejador para la carga de archivo JSON
        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const rawData = JSON.parse(e.target.result);
                        const dataArray = Array.isArray(rawData) ? rawData : [rawData];
                        
                        matchHistory = cleanAndMapData(dataArray);
                        
                        if (matchHistory.length === 0) {
                             alert("‚ö†Ô∏è Archivo JSON cargado, pero no se encontraron partidos v√°lidos. Revisa el formato y la fecha.");
                        } else {
                            alert(`‚úÖ ¬°Archivo cargado! ${matchHistory.length} partidos listos para analizar.`);
                            populateLeagueSelector();
                        }
                    } catch (error) {
                        alert("‚ùå Error al parsear el archivo JSON. Aseg√∫rate de que el formato sea correcto.");
                        console.error("Error de parseo JSON:", error);
                        matchHistory = []; 
                        leagueSelect.disabled = true;
                    }
                };
                reader.readAsText(file);
            }
        });

        // ---------------------------------------------
        // FUNCIONES DE INTERFAZ (SELECTS)
        // ---------------------------------------------

        function populateLeagueSelector() {
            const uniqueLeagues = new Set();
            matchHistory.forEach(match => uniqueLeagues.add(match.liga));

            leagueSelect.innerHTML = '<option value="">-- Seleccione una Liga --</option>';
            uniqueLeagues.forEach(league => {
                const option = document.createElement('option');
                option.value = league;
                option.textContent = league;
                leagueSelect.appendChild(option);
            });
            
            leagueSelect.disabled = false;
            localTeamSelect.disabled = true;
            visitorTeamSelect.disabled = true;
        }

        function populateTeams() {
            const selectedLeague = leagueSelect.value;
            
            localTeamSelect.innerHTML = '';
            visitorTeamSelect.innerHTML = ''; 

            if (!selectedLeague) {
                localTeamSelect.disabled = true;
                visitorTeamSelect.disabled = true;
                localTeamSelect.innerHTML = '<option value="">Seleccione la liga para ver los equipos</option>';
                visitorTeamSelect.innerHTML = '<option value="">Seleccione la liga para ver los equipos</option>';
                return;
            }

            const leagueMatches = matchHistory.filter(match => match.liga === selectedLeague);
            const uniqueTeams = new Set();

            leagueMatches.forEach(match => {
                if (match.local) uniqueTeams.add(match.local);
                if (match.visitante) uniqueTeams.add(match.visitante);
            });
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Seleccione un Equipo --";

            localTeamSelect.appendChild(defaultOption.cloneNode(true));
            visitorTeamSelect.appendChild(defaultOption.cloneNode(true));

            uniqueTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                localTeamSelect.appendChild(option.cloneNode(true));
                visitorTeamSelect.appendChild(option.cloneNode(true));
            });

            localTeamSelect.disabled = false;
            visitorTeamSelect.disabled = false;
        }


        // ---------------------------------------------
        // FUNCIONES DE C√ÅLCULO DE PLAZOS Y POISSON
        // ---------------------------------------------

        /**
         * Calcula el rendimiento (Ataque y Defensa) de un equipo en un conjunto de partidos.
         */
        function calculateTeamIndices(teamName, matches, avgLeagueGoals) {
            let matchesCount = 0;
            let scored = 0;
            let conceded = 0;
            
            if (matches.length === 0) {
                 return { attackIndex: 1, defenseIndex: 1, matchesCount: 0 }; 
            }
            
            const teamLC = teamName.toLowerCase();

            matches.forEach(match => {
                const isLocal = match.local.toLowerCase() === teamLC;
                const isVisitor = match.visitante.toLowerCase() === teamLC;

                if (isLocal || isVisitor) {
                    matchesCount++;
                    
                    const G_scored = isLocal ? match.golesLocal : match.golesVisitante;
                    const G_conceded = isLocal ? match.golesVisitante : match.golesLocal;
                    
                    scored += G_scored;
                    conceded += G_conceded;
                }
            });
            
            if (matchesCount === 0) {
                return { attackIndex: 1, defenseIndex: 1, matchesCount: 0 }; 
            }

            const avgScored = scored / matchesCount;
            const avgConceded = conceded / matchesCount;

            const attackIndex = avgLeagueGoals > 0 ? (avgScored / avgLeagueGoals) : 1;
            const defenseIndex = avgLeagueGoals > 0 ? (avgConceded / avgLeagueGoals) : 1;
            
            return {
                attackIndex: parseFloat(attackIndex.toFixed(3)), 
                defenseIndex: parseFloat(defenseIndex.toFixed(3)),
                matchesCount: matchesCount
            };
        }

        /**
         * Funci√≥n para analizar las probabilidades de los enfrentamientos directos (H2H).
         */
        function analyzeH2H(localTeam, visitorTeam, leagueMatches) {
            const localLC = localTeam.toLowerCase();
            const visitorLC = visitorTeam.toLowerCase();

            const h2hMatches = leagueMatches.filter(match => {
                const matchLocalLC = match.local.toLowerCase();
                const matchVisitorLC = match.visitante.toLowerCase();
                
                return (matchLocalLC === localLC && matchVisitorLC === visitorLC) ||
                       (matchLocalLC === visitorLC && matchVisitorLC === localLC);
            });

            let countOver25 = 0;
            let countBTTS = 0;
            const h2hMatchesCount = h2hMatches.length;

            if (h2hMatchesCount === 0) {
                return { h2hProb25: 0, h2hProbBTTS: 0, h2hMatchesCount: 0 };
            }

            h2hMatches.forEach(match => {
                const totalGoles = match.golesLocal + match.golesVisitante;
                if (totalGoles > 2) {
                    countOver25++;
                }
                if (match.golesLocal > 0 && match.golesVisitante > 0) {
                    countBTTS++;
                }
            });

            const h2hProb25 = countOver25 / h2hMatchesCount;
            const h2hProbBTTS = countBTTS / h2hMatchesCount;
            
            return { h2hProb25, h2hProbBTTS, h2hMatchesCount };
        }

        function poissonProbability(x, lambda) {
            if (lambda === 0) return x === 0 ? 1 : 0;
            return (Math.pow(lambda, x) * Math.exp(-lambda)) / factorial(x);
        }

        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        /**
         * Calcula Goles Esperados y Probabilidad +2.5 para un conjunto de √≠ndices.
         */
        function calculateMetrics(localA, localD, visitorA, visitorD, avgLeagueGoals) {
            const lambdaLocal = localA * visitorD * avgLeagueGoals;
            const lambdaVisitor = visitorA * localD * avgLeagueGoals;
            const totalXGoals = lambdaLocal + lambdaVisitor;

            let probOver25 = 0;
            for (let G_local = 0; G_local <= 5; G_local++) {
                for (let G_visitor = 0; G_visitor <= 5; G_visitor++) {
                    const P_local = poissonProbability(G_local, lambdaLocal);
                    const P_visitor = poissonProbability(G_visitor, lambdaVisitor);
                    if (G_local + G_visitor > 2) {
                        probOver25 += P_local * P_visitor;
                    }
                }
            }

            // Calcular BTTS solo para el modelo principal (Ponderado) y regresarlo como m√©trica extra
            let probBTTS = 0;
             for (let G_local = 1; G_local <= 5; G_local++) {
                for (let G_visitor = 1; G_visitor <= 5; G_visitor++) {
                    const P_local = poissonProbability(G_local, lambdaLocal);
                    const P_visitor = poissonProbability(G_visitor, lambdaVisitor);
                    probBTTS += P_local * P_visitor;
                }
            }

            return { 
                xGoals: totalXGoals, 
                prob25: probOver25, 
                lambdaLocal, 
                lambdaVisitor,
                probBTTS: probBTTS 
            };
        }


        // ---------------------------------------------
        // FUNCI√ìN PRINCIPAL DE AN√ÅLISIS
        // ---------------------------------------------

        function analyzeData() {
            const selectedLeague = leagueSelect.value;
            const localTeam = localTeamSelect.value.trim();
            const visitorTeam = visitorTeamSelect.value.trim();
            
            if (!localTeam || !visitorTeam || !selectedLeague) {
                alert("Por favor, selecciona la Liga, el Equipo Local y el Visitante.");
                return;
            }
             if (localTeam.toLowerCase() === visitorTeam.toLowerCase()) {
                alert("El equipo local no puede ser el mismo que el visitante.");
                return;
            }

            // 1. Goles Liga y Partidos de la Liga (Largo Plazo Base)
            const leagueMatches = matchHistory.filter(match => match.liga === selectedLeague);
            
            let totalLeagueGoals = 0;
            leagueMatches.forEach(m => totalLeagueGoals += (m.golesLocal + m.golesVisitante));
            
            const avgLeagueGoals = leagueMatches.length > 0 ? (totalLeagueGoals / leagueMatches.length) : 0;

            if (avgLeagueGoals === 0) {
                 alert("No hay suficientes datos de goles en esta liga para el an√°lisis.");
                 return;
            }

            // 2. Definir conjuntos de partidos y calcular √çndices
            const historicalMatches = leagueMatches; 
            const localRecentMatches = historicalMatches.filter(m => m.local.toLowerCase() === localTeam.toLowerCase() || m.visitante.toLowerCase() === localTeam.toLowerCase()).slice(-RECENT_MATCH_COUNT);
            const visitorRecentMatches = historicalMatches.filter(m => m.local.toLowerCase() === visitorTeam.toLowerCase() || m.visitante.toLowerCase() === visitorTeam.toLowerCase()).slice(-RECENT_MATCH_COUNT);
            
            const localIndicesHist = calculateTeamIndices(localTeam, historicalMatches, avgLeagueGoals);
            const visitorIndicesHist = calculateTeamIndices(visitorTeam, historicalMatches, avgLeagueGoals);
            
            const localIndicesRec = calculateTeamIndices(localTeam, localRecentMatches, avgLeagueGoals);
            const visitorIndicesRec = calculateTeamIndices(visitorTeam, visitorRecentMatches, avgLeagueGoals);

            if (localIndicesHist.matchesCount === 0 || visitorIndicesHist.matchesCount === 0) {
                 alert(`Al menos uno de los equipos no tiene historial de partidos v√°lidos en esta liga.`);
                 return;
            }
            
            // 3. An√°lisis Directo (H2H)
            const h2hAnalysis = analyzeH2H(localTeam, visitorTeam, leagueMatches);
            
            // --- 4. CALCULAR M√âTRICAS PARA LAS 3 HERRAMIENTAS ---
            
            // HERRAMIENTA 1: LARGO PLAZO (LP) - Historial Completo
            const metricsLP = calculateMetrics(
                localIndicesHist.attackIndex, localIndicesHist.defenseIndex,
                visitorIndicesHist.attackIndex, visitorIndicesHist.defenseIndex,
                avgLeagueGoals
            );
            
            // HERRAMIENTA 2: CORTO PLAZO (CP) - Forma Reciente
            const metricsCP = calculateMetrics(
                localIndicesRec.attackIndex, localIndicesRec.defenseIndex,
                visitorIndicesRec.attackIndex, visitorIndicesRec.defenseIndex,
                avgLeagueGoals
            );

            // HERRAMIENTA 3: PONDERADO (Mixto) - Modelo de referencia
            const localAttackFinal = (localIndicesHist.attackIndex * WEIGHT_HISTORICAL) + (localIndicesRec.attackIndex * WEIGHT_RECENT);
            const localDefenseFinal = (localIndicesHist.defenseIndex * WEIGHT_HISTORICAL) + (localIndicesRec.defenseIndex * WEIGHT_RECENT);
            const visitorAttackFinal = (visitorIndicesHist.attackIndex * WEIGHT_HISTORICAL) + (visitorIndicesRec.attackIndex * WEIGHT_RECENT);
            const visitorDefenseFinal = (visitorIndicesHist.defenseIndex * WEIGHT_HISTORICAL) + (visitorIndicesRec.defenseIndex * WEIGHT_RECENT);
            
            const metricsPonderado = calculateMetrics(
                localAttackFinal, localDefenseFinal,
                visitorAttackFinal, visitorDefenseFinal,
                avgLeagueGoals
            );

            // 5. C√ÅLCULO DEL CONSENSO
            const totalXGoals = metricsLP.xGoals + metricsCP.xGoals + metricsPonderado.xGoals;
            const avgXGoals = totalXGoals / 3;

            const totalProb25 = metricsLP.prob25 + metricsCP.prob25 + metricsPonderado.prob25;
            const avgProb25 = totalProb25 / 3;

            // 6. C√ÅLCULO FINAL DE BTTS (usando Ponderado y H2H)
            let finalProbBTTS;
            
            if (h2hAnalysis.h2hMatchesCount >= 3) {
                // Ponderaci√≥n 70% Modelo Ponderado / 30% H2H
                finalProbBTTS = (metricsPonderado.probBTTS * 0.7) + (h2hAnalysis.h2hProbBTTS * 0.3);
            } else {
                finalProbBTTS = metricsPonderado.probBTTS;
            }


            // --- 7. Mostrar Resultados en la Interfaz ---
            
            // Rellenar la tabla de m√©tricas
            const metricsBody = document.getElementById('metricsBody');
            metricsBody.innerHTML = `
                <tr>
                    <td>Largo Plazo (LP)</td>
                    <td>${metricsLP.xGoals.toFixed(2)}</td>
                    <td>${(metricsLP.prob25 * 100).toFixed(2)}%</td>
                </tr>
                <tr>
                    <td>Corto Plazo (CP) - Reciente</td>
                    <td>${metricsCP.xGoals.toFixed(2)}</td>
                    <td>${(metricsCP.prob25 * 100).toFixed(2)}%</td>
                </tr>
                <tr>
                    <td>Ponderado (Mixto)</td>
                    <td>${metricsPonderado.xGoals.toFixed(2)}</td>
                    <td>${(metricsPonderado.prob25 * 100).toFixed(2)}%</td>
                </tr>
            `;

            document.getElementById('avgXGoals').textContent = `${avgXGoals.toFixed(2)}`;
            document.getElementById('avgProb25').textContent = `${(avgProb25 * 100).toFixed(2)}%`;
            document.getElementById('probBTTS').textContent = `${(finalProbBTTS * 100).toFixed(2)}% (H2H ${(h2hAnalysis.h2hProbBTTS * 100).toFixed(1)}%)`;
            
            document.getElementById('results').style.display = 'block';

            // --- 8. An√°lisis y Recomendaci√≥n Concreta (Basado en Ponderado) ---
            const analysisText = generatePlazosAnalysis(localTeam, visitorTeam, localIndicesHist, visitorIndicesHist, localIndicesRec, visitorIndicesRec, h2hAnalysis, metricsPonderado.xGoals, avgLeagueGoals, metricsPonderado.prob25, finalProbBTTS);
            document.getElementById('personalAnalysis').innerHTML = analysisText.desglose;
            document.getElementById('finalRecommendation').innerHTML = `**DECISI√ìN FINAL (Basada en Ponderado):** ${analysisText.recomendacion}`;
        }

        /**
         * Genera el desglose del an√°lisis y la recomendaci√≥n final.
         */
        function generatePlazosAnalysis(localT, visitorT, lH, vH, lR, vR, h2h, xG, avgLG, p25, pBTTS) {
            let desglose = `**Media Goles de la Liga (Largo Plazo Base):** ${avgLG.toFixed(2)} Goles. <br>`;
            
            // --- Desglose H2H ---
            if (h2h.h2hMatchesCount > 0) {
                 desglose += `**Enfrentamiento Directo (H2H):** ${h2h.h2hMatchesCount} partidos.<br>`;
                 desglose += `* Prob. H2H +2.5 Goles: ${(h2h.h2hProb25 * 100).toFixed(1)}%<br>`;
                 desglose += `* Prob. H2H BTTS: ${(h2h.h2hProbBTTS * 100).toFixed(1)}%<br><br>`;
            } else {
                 desglose += `**Enfrentamiento Directo (H2H):** ‚ùå No se encontraron partidos directos. La predicci√≥n es solo por forma.<br><br>`;
            }

            // --- Desglose de Plazos ---
            desglose += `**An√°lisis de Plazos (${localT}):**<br>`;
            desglose += `* **Hist√≥rico (Largo Plazo):** Ataque: ${lH.attackIndex.toFixed(2)} | Defensa: ${lH.defenseIndex.toFixed(2)} (${lH.matchesCount} P.)<br>`;
            desglose += `* **Reciente (√öltimos ${lR.matchesCount}):** Ataque: ${lR.attackIndex.toFixed(2)} | Defensa: ${lR.defenseIndex.toFixed(2)} (${lR.matchesCount} P.)<br>`;

            const localAttackForm = lR.attackIndex - lH.attackIndex;
            const localDefenseForm = lH.defenseIndex - lR.defenseIndex; 

            if (localAttackForm > 0.1) {
                desglose += `  - üìà **Ataque en Forma:** Mejor√≥ significativamente.<br>`;
            } else if (localAttackForm < -0.1) {
                desglose += `  - üìâ **Ataque en Baja:** Se debilit√≥ significativamente.<br>`;
            }
            if (localDefenseForm > 0.1) {
                desglose += `  - üõ°Ô∏è **Defensa S√≥lida:** Mejor√≥ su defensa.<br>`;
            } else if (localDefenseForm < -0.1) {
                desglose += `  - üö® **Defensa D√©bil:** Empeor√≥ su defensa.<br>`;
            }
            
            desglose += `<br>**An√°lisis de Plazos (${visitorT}):**<br>`;
            desglose += `* **Hist√≥rico (Largo Plazo):** Ataque: ${vH.attackIndex.toFixed(2)} | Defensa: ${vH.defenseIndex.toFixed(2)} (${vH.matchesCount} P.)<br>`;
            desglose += `* **Reciente (√öltimos ${vR.matchesCount}):** Ataque: ${vR.attackIndex.toFixed(2)} | Defensa: ${vR.defenseIndex.toFixed(2)} (${vR.matchesCount} P.)<br>`;

            const visitorAttackForm = vR.attackIndex - vH.attackIndex;
            const visitorDefenseForm = vH.defenseIndex - vR.defenseIndex; 

            if (visitorAttackForm > 0.1) {
                desglose += `  - üìà **Ataque en Forma:** Mejor√≥ significativamente.<br>`;
            } else if (visitorAttackForm < -0.1) {
                desglose += `  - üìâ **Ataque en Baja:** Se debilit√≥ significativamente.<br>`;
            }
            if (visitorDefenseForm > 0.1) {
                desglose += `  - üõ°Ô∏è **Defensa S√≥lida:** Mejor√≥ su defensa.<br>`;
            } else if (visitorDefenseForm < -0.1) {
                desglose += `  - üö® **Defensa D√©bil:** Empeor√≥ su defensa.<br>`;
            }
            
            desglose += `<br>---<br>`;
            
            // --- L√≥gica de Recomendaci√≥n Concreta (Multi-M√©trica) ---
            let recomendacion = '';
            
            const isLocalAttackingWell = localAttackForm > 0.1;
            const isLocalDefendingBadly = localDefenseForm < -0.1;
            const isVisitorAttackingWell = visitorAttackForm > 0.1;
            const isVisitorDefendingBadly = visitorDefenseForm < -0.1;

            const isHighGoalRisk = p25 >= THRESHOLD_OVER_25;
            const isLowGoalRisk = p25 <= THRESHOLD_UNDER_25;
            const isHighBTTS = pBTTS >= THRESHOLD_BTTS;
            const isLowBTTS = pBTTS <= THRESHOLD_BTTS_NO;

            // CASO 1: ALTO RIESGO DE GOLES (OFENSIVA)
            if (isHighGoalRisk || xG >= 2.9) {
                if (isHighBTTS) {
                    recomendacion = `¬°ALTA CONFIANZA! ‚úÖ Pron√≥stico: **M√°s de 2.5 Goles y Ambos Anotan (BTTS S√≠)**. La ofensiva de ambos equipos es fuerte.`;
                } else if (isLocalAttackingWell && isVisitorDefendingBadly) {
                    recomendacion = `GOLEADA LOCAL PROBABLE. ‚ö†Ô∏è Pron√≥stico: **M√°s de 2.5 Goles** (El Local est√° en mejor forma).`;
                } else if (isVisitorAttackingWell && isLocalDefendingBadly) {
                     recomendacion = `GOLEADA VISITANTE PROBABLE. ‚ö†Ô∏è Pron√≥stico: **M√°s de 2.5 Goles** (El Visitante est√° en mejor forma).`;
                } else {
                    recomendacion = `BUENA OPCI√ìN DE GOL. ‚úÖ Pron√≥stico: **M√°s de 2.5 Goles**. (Goles Esperados: ${xG.toFixed(2)}).`;
                }
            } 
            // CASO 2: BAJO RIESGO DE GOLES (DEFENSIVA)
            else if (isLowGoalRisk || xG <= 2.1) {
                if (isLowBTTS) {
                    recomendacion = `PARTIDO CERRADO Y SEGURO. ‚ùå Pron√≥stico: **Menos de 2.5 Goles y Ambos Anotan (BTTS No)**.`;
                } else {
                    recomendacion = `TENDENCIA AL BAJO. üü° Pron√≥stico: **Menos de 2.5 Goles**. (Defensas en buena forma).`;
                }
            } 
            // CASO 3: RANGO MEDIO (INCERTEZA EN EL 2.5)
            else { 
                if (isHighBTTS) {
                     recomendacion = `ENFRENTAMIENTO EQUILIBRADO Y CON GOLES. ü§ù Pron√≥stico: **Ambos Anotan (BTTS S√≠)**. La l√≠nea 2.5 es muy ajustada.`;
                } else if (isLowBTTS) {
                    recomendacion = `ESPERAMOS UN GANADOR SIN RESPUESTA. üü® Pron√≥stico: **Menos de 3.5 Goles**. (Posible 1-0 o 2-0).`;
                } else {
                     recomendacion = `PREDICCI√ìN INCIERTA. ‚ùì Se recomienda cautela. Analizar si la forma reciente (corto plazo) tiene m√°s peso que el historial.`;
                }
            }

            return { desglose: desglose, recomendacion: recomendacion };
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análisis y Predicción de Mercados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Iconos de Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilos de tabla profesional */
        .poisson-table { border-collapse: collapse; table-layout: fixed; }
        .poisson-table th, .poisson-table td {
            padding: 4px; /* Reducido para móvil */
            font-size: 0.6rem; /* Reducido para móvil */
            border: 1px solid #e5e7eb;
        }
        @media (min-width: 640px) {
            .poisson-table th, .poisson-table td {
                padding: 6px;
                font-size: 0.75rem;
            }
        }
        .poisson-table th {
            background-color: #1e3a8a; 
            color: white;
            font-weight: 600;
        }
        .poisson-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .highlight-cell {
            background-color: #fde68a !important; 
            font-weight: 700;
            color: #1f2937;
            border: 2px solid #fbbf24;
        }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .future-match-row {
            cursor: pointer;
            transition: all 0.15s;
        }
        .future-match-row:hover {
            background-color: #e5e7eb;
            font-weight: 600;
        }
        .selected-match {
            background-color: #d1fae5 !important;
            border-left: 5px solid #10b981;
            font-weight: 700;
        }
        /* Estilos para el Accordion/Pestaña */
        .accordion-content {
            max-height: 0;
            transition: max-height 0.5s ease-in-out;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-2 sm:p-4">

    <div id="app" class="max-w-6xl mx-auto bg-white shadow-2xl rounded-2xl p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 border-b pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-900 flex items-center justify-center">
                <i class="fas fa-chart-bar mr-3 text-yellow-500"></i>
                DASHBOARD DE ANÁLISIS POISSON
            </h1>
            <p class="text-gray-600 mt-1 text-sm sm:text-lg">Predicción de Mercados de Apuestas (Soporte Multiarchivo)</p>
        </header>

        <!-- CONTENEDOR PRINCIPAL (2 COLUMNAS EN DESKTOP) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUMNA IZQUIERDA: CONTROLES Y FUERZAS -->
            <div class="lg:col-span-1 space-y-6">

                <!-- 1. Carga de Datos Históricos (Múltiples Archivos) -->
                <section class="bg-indigo-50 p-4 rounded-xl border-l-4 border-indigo-500 shadow-md">
                    <h2 class="text-xl font-bold text-indigo-800 mb-3 flex items-center">
                        <i class="fas fa-layer-group mr-3"></i> 1. Datos Históricos (Entrenamiento)
                    </h2>
                    <p class="text-xs text-gray-700 mb-3">
                        Carga uno o hasta 30 archivos CSV. Esto calcula las fuerzas de todos los equipos.
                    </p>

                    <input type="file" id="historicalFileInput" accept=".csv" multiple class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white file:py-1 file:px-2 file:text-xs file:font-semibold">
                    <button onclick="loadHistoricalData()" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-150">
                        <i class="fas fa-database mr-2"></i> Procesar Archivos Históricos
                    </button>
                    
                    <p id="historicalLoadStatus" class="text-xs mt-3 text-center h-4 font-semibold text-gray-500"></p>
                    <p id="totalHistoricalMatchesCount" class="text-xs mt-1 text-center font-bold text-gray-700"></p>
                </section>

                <!-- 2. Carga de Partidos Futuros (1 Archivo) -->
                <section id="futureLoadSection" class="hidden bg-blue-50 p-4 rounded-xl border-l-4 border-blue-500 shadow-md">
                     <h2 class="text-xl font-bold text-blue-800 mb-3 flex items-center">
                        <i class="fas fa-calendar-alt mr-3"></i> 2. Partidos a Predecir (Futuro)
                    </h2>
                    <p class="text-xs text-gray-700 mb-3">
                        Columnas necesarias: <code class="font-mono bg-yellow-200 px-1 rounded">Date</code>, <code class="font-mono bg-yellow-200 px-1 rounded">HomeTeam</code>, <code class="font-mono bg-yellow-200 px-1 rounded">AwayTeam</code>. Opcionales para valor: <code class="font-mono bg-yellow-200 px-1 rounded">MaxH</code>, <code class="font-mono bg-yellow-200 px-1 rounded">MaxD</code>, <code class="font-mono bg-yellow-200 px-1 rounded">MaxA</code>.
                    </p>
                    <input type="file" id="futureFileInput" accept=".csv" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white file:py-1 file:px-2 file:text-xs file:font-semibold">
                    <button onclick="loadFutureMatches()" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-150">
                        <i class="fas fa-file-import mr-2"></i> Cargar Partidos Futuros
                    </button>
                    <p id="futureLoadStatus" class="text-xs mt-3 text-center h-4 font-semibold text-gray-500"></p>
                </section>

                <!-- 3. Resumen de Fuerzas y xG (Muestra dinámica) -->
                <section id="summaryResultsSection" class="hidden bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><i class="fas fa-bolt mr-3 text-red-500"></i> Fuerzas y Goles Esperados (xG)</h2>
                    <div id="summaryResults" class="grid grid-cols-2 gap-4">
                        <!-- Contenido dinámico aquí -->
                    </div>
                </section>

                <!-- 4. Muestra de Datos Históricos -->
                <section id="dataViewSection" class="hidden bg-white p-4 rounded-xl shadow-lg border-t-4 border-indigo-400">
                     <h2 class="text-xl font-bold text-indigo-800 mb-3 flex items-center">
                        <i class="fas fa-list-ol mr-3"></i> Partidos Históricos Utilizados
                    </h2>
                    <p class="text-xs text-gray-500 mb-3">Se muestran los primeros 10 partidos para verificación.</p>
                    <div class="table-container">
                        <table id="matchesTable" class="poisson-table w-full text-center">
                            <!-- Filas dinámicas aquí -->
                        </table>
                    </div>
                </section>
            </div>

            <!-- COLUMNA DERECHA: SELECCIÓN Y RESULTADOS -->
            <div class="lg:col-span-2 space-y-6">

                <!-- 3. Lista de Partidos Futuros a Predecir (Con Accordion) -->
                <section id="futureMatchesSection" class="hidden bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-500 shadow-md">
                    <h2 class="text-xl font-bold text-yellow-700 mb-3 flex items-center">
                        <i class="fas fa-futbol mr-3"></i> 3. Partidos Futuros Pendientes (Clic para Analizar)
                    </h2>
                    
                    <!-- Contenedor del Accordion de Partidos -->
                    <div id="futureMatchesTableContainer">
                        <!-- Grupos de partidos por día generados aquí -->
                    </div>
                    
                    <p id="futureTeamsWarning" class="text-xs mt-3 text-red-500 hidden font-bold">Advertencia: Algunos equipos no tienen datos históricos.</p>
                </section>

                <div id="resultsSection" class="space-y-6 hidden">
                    <h2 class="text-2xl font-bold text-blue-800 flex items-center border-b pb-2">
                        <i class="fas fa-poll mr-3"></i> PRONÓSTICOS PARA: <span id="currentMatchTitle" class="ml-2 text-red-600 font-extrabold"></span>
                    </h2>

                    <!-- 4. PRONÓSTICOS 1X2 Y VALOR -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Pronóstico 1X2 -->
                        <div class="md:col-span-1 bg-green-50 p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                            <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-percent mr-2 text-green-600"></i> Probabilidad 1X2</h3>
                            <div id="detailedForecast">
                                <!-- Pronósticos 1X2 generados aquí -->
                            </div>
                        </div>

                        <!-- Análisis de Valor -->
                        <div class="md:col-span-1 bg-white p-4 rounded-xl shadow-lg border-l-4 border-gray-300">
                            <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-hand-holding-usd mr-2 text-blue-600"></i> Análisis de Valor (Odds)</h3>
                            <h4 class="text-sm font-semibold text-gray-600 mb-3">Cuotas de la Casa:</h4>
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1 text-center">Local (1)</label>
                                    <input type="number" step="0.01" id="odds1" placeholder="2.50" class="w-full p-2 border border-gray-300 rounded-lg text-center text-sm" oninput="calculateValue()">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1 text-center">Empate (X)</label>
                                    <input type="number" step="0.01" id="oddsX" placeholder="3.20" class="w-full p-2 border border-gray-300 rounded-lg text-center text-sm" oninput="calculateValue()">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1 text-center">Visitante (2)</label>
                                    <input type="number" step="0.01" id="odds2" placeholder="3.00" class="w-full p-2 border border-gray-300 rounded-lg text-center text-sm" oninput="calculateValue()">
                                </div>
                            </div>
                            <div id="valueResults" class="mt-4 p-2 border-t border-gray-200 pt-3">
                                <p class="text-sm text-gray-500 text-center">Ingresa cuotas para calcular el valor.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 5. MERCADOS ADICIONALES -->
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-inner border-l-4 border-indigo-500">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><i class="fas fa-tags mr-2 text-indigo-600"></i> Probabilidades de Mercados de Goles</h3>
                        <div id="marketProbabilities" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                            <!-- Cards de mercados generadas aquí -->
                        </div>
                    </div>

                    <!-- 6. Matriz de Probabilidades Poisson -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-th mr-2 text-blue-500"></i> Matriz de Marcadores Correctos</h3>
                        <div class="table-container bg-white rounded-xl shadow-lg border border-gray-300 p-2">
                            <div id="poissonMatrix">
                                <!-- Tabla generada aquí -->
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">P(Goles Local, Goles Visitante). Se muestran hasta ${MAX_GOALS} goles.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- FIN CONTENEDOR PRINCIPAL -->


        <!-- Modal para Mensajes/Errores -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50" onclick="closeModal()">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
                <h3 id="modalTitle" class="text-xl font-bold mb-3 text-red-600">Error</h3>
                <p id="modalContent" class="text-gray-700 mb-4"></p>
                <button onclick="closeModal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    <i class="fas fa-times-circle mr-2"></i> Cerrar
                </button>
            </div>
        </div>

    </div>

    <script>
        // Variables globales
        let allHistoricalMatches = []; // Almacena todos los partidos históricos
        let futureMatches = [];         // Almacena los partidos a predecir
        let teamStrengths = {};
        let leagueAverages = {};
        let lastForecastResults = null; 
        const MAX_GOALS = 6; 
        const HOME_TEAM_COL = 'HomeTeam';
        const AWAY_TEAM_COL = 'AwayTeam';
        const HOME_GOALS_COL = 'FTHG';
        const AWAY_GOALS_COL = 'FTAG';
        const DATE_COL = 'Date'; // NUEVA COLUMNA REQUERIDA PARA PARTIDOS FUTUROS
        const ODDS_COLS = {
            '1': 'MaxH',
            'X': 'MaxD',
            '2': 'MaxA'
        }; 

        /* --- Funciones de Utilidad y UI --- */

        function showModal(title, content, type = 'error') {
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const button = modal.querySelector('button');

            modalTitle.textContent = title;
            document.getElementById('modalContent').textContent = content;

            if (type === 'error') {
                modalTitle.className = 'text-xl font-bold mb-3 text-red-600 flex items-center';
                modalTitle.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${title}`;
                button.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150';
            } else {
                modalTitle.className = 'text-xl font-bold mb-3 text-blue-600 flex items-center';
                modalTitle.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${title}`;
                button.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150';
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }
        
        /**
         * Función para alternar el contenido del accordion
         */
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            
            // Revisa si el contenido está visible (altura > 0)
            const isExpanded = content.style.maxHeight !== '0px' && content.style.maxHeight !== '';
            
            // Cierra todos los otros accordiones abiertos
            document.querySelectorAll('.accordion-content').forEach(c => {
                if (c.id !== id) {
                    c.style.maxHeight = '0px';
                    const otherIcon = document.getElementById(`icon-${c.id}`);
                    if (otherIcon) otherIcon.classList.remove('rotate-180');
                }
            });

            if (isExpanded) {
                // Colapsar el actual
                content.style.maxHeight = '0px';
                icon.classList.remove('rotate-180');
            } else {
                // Expandir el actual. Usamos scrollHeight para que la altura sea dinámica
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.classList.add('rotate-180');
            }
        }


        /* --- Carga y Parsing de Datos --- */

        /**
         * Parsea el texto CSV. Puede manejar datos históricos (con goles) o futuros (sin goles, pero con cuotas opcionales y fecha).
         */
        function parseCSV(csvText, isHistorical = true) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("Datos CSV insuficientes. Se requiere al menos una cabecera y una fila de datos.");

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const requiredTeamCols = [HOME_TEAM_COL, AWAY_TEAM_COL];

            if (!isHistorical) {
                 // Date es requerida para el agrupamiento
                requiredTeamCols.push(DATE_COL); 
            }

            // 1. Verificar columnas de equipos y fecha
            const missingRequiredCols = requiredTeamCols.filter(col => !headers.includes(col));
            if (missingRequiredCols.length > 0) {
                throw new Error(`Columnas CSV faltantes: ${missingRequiredCols.join(', ')}. Verifica las cabeceras.`);
            }

            const indices = {
                [DATE_COL]: headers.indexOf(DATE_COL), // NUEVO
                [HOME_TEAM_COL]: headers.indexOf(HOME_TEAM_COL),
                [AWAY_TEAM_COL]: headers.indexOf(AWAY_TEAM_COL),
                [HOME_GOALS_COL]: headers.indexOf(HOME_GOALS_COL),
                [AWAY_GOALS_COL]: headers.indexOf(AWAY_GOALS_COL),
                [ODDS_COLS['1']]: headers.indexOf(ODDS_COLS['1']),
                [ODDS_COLS['X']]: headers.indexOf(ODDS_COLS['X']),
                [ODDS_COLS['2']]: headers.indexOf(ODDS_COLS['2'])
            };
            
            // 2. Verificar columnas de goles si es histórico
            if (isHistorical) {
                const missingGoalCols = [HOME_GOALS_COL, AWAY_GOALS_COL].filter(col => !headers.includes(col));
                if (missingGoalCols.length > 0) {
                     throw new Error(`Columnas CSV faltantes (goles): ${missingGoalCols.join(', ')}. Verifica las cabeceras.`);
                }
            }


            const matches = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(',');
                if (currentLine.length < headers.length) continue;

                const match = {};
                try {
                    match[HOME_TEAM_COL] = currentLine[indices[HOME_TEAM_COL]].trim().replace(/"/g, '');
                    match[AWAY_TEAM_COL] = currentLine[indices[AWAY_TEAM_COL]].trim().replace(/"/g, '');
                    
                    if (!isHistorical) {
                        match[DATE_COL] = currentLine[indices[DATE_COL]].trim().replace(/"/g, '');
                    }
                    
                    if (isHistorical) {
                        match[HOME_GOALS_COL] = parseInt(currentLine[indices[HOME_GOALS_COL]].trim().replace(/"/g, ''), 10);
                        match[AWAY_GOALS_COL] = parseInt(currentLine[indices[AWAY_GOALS_COL]].trim().replace(/"/g, ''), 10);
                        if (isNaN(match[HOME_GOALS_COL]) || isNaN(match[AWAY_GOALS_COL])) continue;
                    } else {
                        // Extraer cuotas opcionales para partidos futuros
                        const oddsH = parseFloat(currentLine[indices[ODDS_COLS['1']]]) || 0;
                        const oddsD = parseFloat(currentLine[indices[ODDS_COLS['X']]]) || 0;
                        const oddsA = parseFloat(currentLine[indices[ODDS_COLS['2']]]) || 0;
                        
                        match.odds = {
                            '1': oddsH > 1 ? oddsH : 0,
                            'X': oddsD > 1 ? oddsD : 0,
                            '2': oddsA > 1 ? oddsA : 0,
                        };
                    }
                } catch (e) { continue; } 

                if (match[HOME_TEAM_COL] && match[AWAY_TEAM_COL]) {
                     matches.push(match);
                }
            }

            if (matches.length === 0) {
                throw new Error("No se extrajeron partidos válidos. Revisa el formato y que los datos sean correctos.");
            }

            return matches;
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error(`Error al leer el archivo ${file.name}.`));
                reader.readAsText(file);
            });
        }

        async function loadHistoricalData() {
            const files = document.getElementById('historicalFileInput').files;
            const statusElement = document.getElementById('historicalLoadStatus');
            statusElement.className = 'text-xs mt-3 text-center text-gray-500 h-4 font-semibold';
            document.getElementById('futureLoadSection').classList.add('hidden');
            document.getElementById('futureMatchesSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('summaryResultsSection').classList.add('hidden');
            
            if (files.length === 0) {
                showModal("Error", "Por favor, selecciona al menos un archivo CSV histórico.", 'info');
                return;
            }
            if (files.length > 30) {
                showModal("Advertencia", `Has seleccionado ${files.length} archivos. Se recomienda un máximo de 30 para mantener el rendimiento.`, 'info');
            }

            allHistoricalMatches = [];
            let filesProcessed = 0;

            try {
                for (let i = 0; i < files.length; i++) {
                    statusElement.textContent = `Procesando archivo ${i + 1} de ${files.length}...`;
                    const csvText = await readFile(files[i]);
                    const matches = parseCSV(csvText, true);
                    allHistoricalMatches.push(...matches);
                    filesProcessed++;
                }

                if (allHistoricalMatches.length === 0) {
                    throw new Error("No se pudo extraer ningún partido histórico de los archivos seleccionados.");
                }

                calculateAllStrengths();
                displayMatchesSample();
                
                document.getElementById('totalHistoricalMatchesCount').textContent = `Total de partidos históricos: ${allHistoricalMatches.length}`;
                document.getElementById('futureLoadSection').classList.remove('hidden');
                document.getElementById('dataViewSection').classList.remove('hidden');
                statusElement.className = 'text-xs mt-3 text-center text-green-600 font-bold h-4';
                statusElement.textContent = `¡${filesProcessed} archivos procesados! Fuerzas calculadas para ${Object.keys(teamStrengths).length} equipos.`;

            } catch (error) {
                statusElement.className = 'text-xs mt-3 text-center text-red-600 font-bold h-4';
                statusElement.textContent = `Error: ${error.message}`;
                showModal("Error de Carga Histórica", error.message);
            }
        }

        async function loadFutureMatches() {
            if (Object.keys(teamStrengths).length === 0) {
                showModal("Advertencia", "Primero debes cargar y procesar los archivos históricos para calcular las fuerzas.", 'info');
                return;
            }
            
            const file = document.getElementById('futureFileInput').files[0];
            const statusElement = document.getElementById('futureLoadStatus');
            statusElement.className = 'text-xs mt-3 text-center text-gray-500 h-4 font-semibold';
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('summaryResultsSection').classList.add('hidden');


            if (!file) {
                showModal("Error", "Por favor, selecciona el archivo CSV con los partidos futuros.", 'info');
                return;
            }

            try {
                const csvText = await readFile(file);
                futureMatches = parseCSV(csvText, false); 
                
                if (futureMatches.length === 0) {
                    throw new Error("El archivo de partidos futuros no contiene partidos válidos.");
                }

                displayFutureMatches();
                document.getElementById('futureMatchesSection').classList.remove('hidden');
                statusElement.className = 'text-xs mt-3 text-center text-green-600 font-bold h-4';
                statusElement.textContent = `¡${futureMatches.length} partidos cargados y listos para predecir!`;

            } catch (error) {
                statusElement.className = 'text-xs mt-3 text-center text-red-600 font-bold h-4';
                statusElement.textContent = `Error: ${error.message}`;
                showModal("Error de Carga Futura", error.message);
            }
        }

        /* --- Lógica de Agrupamiento y Ordenamiento --- */

        /**
         * Agrupa y ordena los partidos futuros por fecha.
         */
        function groupAndSortFutureMatches(matches) {
            // 1. Clonar y Ordenar por fecha
            const sortedMatches = [...matches].sort((a, b) => {
                // Intenta crear objetos Date. Asume formatos comunes (DD/MM/YY o YYYY-MM-DD)
                // Se usa el formato 'MM/DD/YYYY' si no hay guiones, o 'YYYY-MM-DD' si hay
                const parseDate = (dateStr) => {
                    if (!dateStr) return new Date(0); // Poner al inicio si no hay fecha
                    const parts = dateStr.split(/[-/.]/);
                    if (parts.length === 3) {
                        // Intenta DD/MM/YYYY o YYYY/MM/DD. Mejor confiar en YYYY-MM-DD para ISO.
                        if (parts[0].length === 4) return new Date(parts[0], parts[1] - 1, parts[2]); // YYYY-MM-DD
                        if (parts[2].length === 4) return new Date(parts[2], parts[1] - 1, parts[0]); // DD/MM/YYYY
                    }
                    return new Date(dateStr); // Fallback
                };
                const dateA = parseDate(a[DATE_COL]);
                const dateB = parseDate(b[DATE_COL]);
                return dateA.getTime() - dateB.getTime();
            });

            // 2. Agrupar por fecha formateada
            const groupedMatches = {};
            const formatter = new Intl.DateTimeFormat('es-ES', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });

            sortedMatches.forEach((match, index) => {
                // Almacenar el índice original en el array plano para `runCalculations`
                match.originalIndex = index; 
                
                let dateKey;
                try {
                    const dateObj = new Date(match[DATE_COL]);
                    if (isNaN(dateObj)) throw new Error("Invalid Date");

                    // Usar un formato amigable en español como clave
                    dateKey = formatter.format(dateObj);
                } catch (e) {
                    dateKey = `Fecha Desconocida (${match[DATE_COL]})`;
                }

                if (!groupedMatches[dateKey]) {
                    groupedMatches[dateKey] = [];
                }
                groupedMatches[dateKey].push(match);
            });

            return groupedMatches;
        }

        /* --- Cálculos del Modelo Poisson (Mismos que antes) --- */

        function calculateAverages() {
            let totalMatches = allHistoricalMatches.length;
            let totalHomeGoals = allHistoricalMatches.reduce((sum, match) => sum + match[HOME_GOALS_COL], 0);
            let totalAwayGoals = allHistoricalMatches.reduce((sum, match) => sum + match[AWAY_GOALS_COL], 0);

            leagueAverages = {
                avgHomeGoals: totalHomeGoals / totalMatches,
                avgAwayGoals: totalAwayGoals / totalMatches,
                totalMatches: totalMatches
            };
        }

        function calculateAllStrengths() {
            calculateAverages();
            const teams = [...new Set([...allHistoricalMatches.map(m => m[HOME_TEAM_COL]), ...allHistoricalMatches.map(m => m[AWAY_TEAM_COL])])];
            teamStrengths = {};
            const avg = leagueAverages;

            teams.forEach(team => {
                const homeMatches = allHistoricalMatches.filter(m => m[HOME_TEAM_COL] === team);
                const awayMatches = allHistoricalMatches.filter(m => m[AWAY_TEAM_COL] === team);
                
                const numHome = homeMatches.length;
                const numAway = awayMatches.length;

                const teamAvgHomeScored = numHome > 0 ? homeMatches.reduce((sum, m) => sum + m[HOME_GOALS_COL], 0) / numHome : 0;
                const teamAvgAwayScored = numAway > 0 ? awayMatches.reduce((sum, m) => sum + m[AWAY_GOALS_COL], 0) / numAway : 0;
                const teamAvgHomeConceded = numHome > 0 ? homeMatches.reduce((sum, m) => sum + m[AWAY_GOALS_COL], 0) / numHome : 0;
                const teamAvgAwayConceded = numAway > 0 ? awayMatches.reduce((sum, m) => sum + m[HOME_GOALS_COL], 0) / numAway : 0;

                // AS = Ataque, DS = Defensa
                const AS_Home = (avg.avgHomeGoals > 0) ? (teamAvgHomeScored / avg.avgHomeGoals) : 0;
                const AS_Away = (avg.avgAwayGoals > 0) ? (teamAvgAwayScored / avg.avgAwayGoals) : 0;
                const DS_Home = (avg.avgAwayGoals > 0) ? (teamAvgHomeConceded / avg.avgAwayGoals) : 0; 
                const DS_Away = (avg.avgHomeGoals > 0) ? (teamAvgAwayConceded / avg.avgHomeGoals) : 0; 

                teamStrengths[team] = { AS_Home, DS_Home, AS_Away, DS_Away };
            });
        }

        function poissonProbability(lambda, k) {
            if (k < 0 || lambda < 0) return 0;
            const factorial = (n) => {
                let res = 1;
                for (let i = 2; i <= n; i++) res *= i;
                return res;
            };
            const prob = (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
            return isNaN(prob) ? 0 : prob;
        }

        function calculateExpectedGoals(homeTeam, awayTeam) {
            const homeStrengths = teamStrengths[homeTeam];
            const awayStrengths = teamStrengths[awayTeam];
            const avg = leagueAverages;

            if (!homeStrengths || !awayStrengths) {
                 throw new Error("Fuerzas de equipo no calculadas. El equipo no está en los datos históricos.");
            }

            // xG Local = AS_Local * DS_Visitante * AVG_Goles_Local
            const xG_Home = homeStrengths.AS_Home * awayStrengths.DS_Away * avg.avgHomeGoals;
            // xG Visitante = AS_Visitante * DS_Local * AVG_Goles_Visitante
            const xG_Away = awayStrengths.AS_Away * homeStrengths.DS_Home * avg.avgAwayGoals;

            return { xG_Home, xG_Away };
        }

        /**
         * Genera la matriz de probabilidades, calcula 1X2 y las probabilidades marginales
         */
        function generatePoissonMatrix(expectedGoals, homeTeam, awayTeam) {
            const { xG_Home, xG_Away } = expectedGoals;
            const matrixDiv = document.getElementById('poissonMatrix');
            const N = MAX_GOALS;

            // 1. Calcular probabilidades marginales para un rango amplio (N+3)
            const homeProbs = Array(N + 3).fill(0).map((_, k) => poissonProbability(xG_Home, k));
            const awayProbs = Array(N + 3).fill(0).map((_, k) => poissonProbability(xG_Away, k));
            
            // 2. Calcular la matriz conjunta (hasta N x N)
            let matrixHTML = `<table class="poisson-table w-full text-center">`;
            matrixHTML += `<thead><tr><th class="bg-blue-900 rounded-tl-lg">${homeTeam} \\ ${awayTeam}</th>`;
            for (let j = 0; j <= N; j++) matrixHTML += `<th class="bg-blue-900">${j}</th>`;
            matrixHTML += `</tr></thead>`;
            matrixHTML += `<tbody>`;
            
            let homeWinProb = 0;
            let awayWinProb = 0;
            let drawProb = 0;
            let maxProb = -1;
            let bestScore = '';
            
            for (let i = 0; i <= N; i++) { // Goles Local (i)
                matrixHTML += `<tr><th class="font-bold text-gray-800 bg-gray-200">${i}</th>`;
                for (let j = 0; j <= N; j++) { // Goles Visitante (j)
                    const prob = homeProbs[i] * awayProbs[j];
                    const probPercent = (prob * 100).toFixed(2);
                    
                    if (prob > maxProb) { 
                        maxProb = prob; 
                        bestScore = `${i}-${j}`;
                    }

                    // Acumular probabilidades 1X2 (usando solo la matriz N x N)
                    if (i > j) { homeWinProb += prob; } 
                    else if (j > i) { awayWinProb += prob; } 
                    else { drawProb += prob; }

                    matrixHTML += `<td data-score="${i}-${j}" data-prob="${prob.toFixed(4)}" class="${probPercent > 0.01 ? 'text-gray-800' : 'text-gray-400'}">${probPercent}%</td>`;
                }
                matrixHTML += `</tr>`;
            }

            // Sumar el restante de probabilidad 1X2 fuera de la matriz N x N
            for (let i = 0; i < homeProbs.length; i++) {
                for (let j = 0; j < awayProbs.length; j++) {
                    if (i > N || j > N) {
                        const prob = homeProbs[i] * awayProbs[j];
                        if (i > j) { homeWinProb += prob; } 
                        else if (j > i) { awayWinProb += prob; } 
                        else { drawProb += prob; }
                    }
                }
            }
            
            matrixHTML += `</tbody></table>`;
            matrixDiv.innerHTML = matrixHTML;

            // Resaltar la probabilidad máxima
            const cells = matrixDiv.querySelectorAll('td');
            cells.forEach(cell => {
                if (cell.getAttribute('data-score') === bestScore && maxProb > 0.005) {
                    cell.classList.add('highlight-cell');
                }
            });
            
            // Devolver las probabilidades 1X2 y las marginales completas (hasta N+2) para los mercados U/O
            return { homeWinProb, awayWinProb, drawProb, maxProb, bestScore, homeProbs, awayProbs };
        }

        /**
         * Calcula y muestra las probabilidades de mercados adicionales.
         */
        function calculateAllMarkets(homeTeam, awayTeam, homeProbs, awayProbs) {
            const marketDiv = document.getElementById('marketProbabilities');
            let marketData = [];

            // Helper para sumar probabilidades conjuntas hasta un total de goles (maxGoals)
            const sumProbTotal = (maxGoals) => {
                let sum = 0;
                // Usamos homeProbs.length, que es N+3, para un cálculo de O/U más preciso
                for (let i = 0; i < homeProbs.length; i++) {
                    for (let j = 0; j < awayProbs.length; j++) {
                        if (i + j <= maxGoals) {
                             sum += homeProbs[i] * awayProbs[j];
                        }
                    }
                }
                return sum;
            };

            /* --- 1. Ambos Anotan (BTTS) --- */
            const p00 = homeProbs[0] * awayProbs[0];
            const p_home_cs = homeProbs[0]; // Prob. Home No anota (goles=0)
            const p_away_cs = awayProbs[0]; // Prob. Away No anota (goles=0)
            const p_btts_no = p_home_cs + p_away_cs - p00;
            const p_btts_yes = 1 - p_btts_no;

            marketData.push(
                { label: 'BTTS - Sí', value: p_btts_yes, icon: 'fas fa-check-double', color: 'bg-green-600' },
                { label: 'BTTS - No', value: p_btts_no, icon: 'fas fa-times', color: 'bg-red-600' }
            );

            /* --- 2. Goles Totales (Over/Under) --- */
            const p_u15 = sumProbTotal(1);
            const p_o15 = 1 - p_u15;
            const p_u25 = sumProbTotal(2);
            const p_o25 = 1 - p_u25;
            const p_u35 = sumProbTotal(3);
            const p_o35 = 1 - p_u35;

            marketData.push(
                { label: 'Total O 1.5', value: p_o15, icon: 'fas fa-arrow-alt-circle-up', color: 'bg-indigo-700' },
                { label: 'Total U 1.5', value: p_u15, icon: 'fas fa-arrow-alt-circle-down', color: 'bg-indigo-600' },
                { label: 'Total O 2.5', value: p_o25, icon: 'fas fa-arrow-alt-circle-up', color: 'bg-blue-700' },
                { label: 'Total U 2.5', value: p_u25, icon: 'fas fa-arrow-alt-circle-down', color: 'bg-blue-600' },
                { label: 'Total O 3.5', value: p_o35, icon: 'fas fa-arrow-alt-circle-up', color: 'bg-teal-700' },
                { label: 'Total U 3.5', value: p_u35, icon: 'fas fa-arrow-alt-circle-down', color: 'bg-teal-600' }
            );

            /* --- 3. Goles Local/Visitante (Over/Under) --- */
            const p_local_u15 = homeProbs[0] + homeProbs[1];
            const p_local_o15 = 1 - p_local_u15;
            const p_away_u15 = awayProbs[0] + awayProbs[1];
            const p_away_o15 = 1 - p_away_u15;
            
            marketData.push(
                { label: `${homeTeam} O 1.5`, value: p_local_o15, icon: 'fas fa-home', color: 'bg-purple-700' },
                { label: `${homeTeam} U 1.5`, value: p_local_u15, icon: 'fas fa-home', color: 'bg-purple-600' },
                { label: `${awayTeam} O 1.5`, value: p_away_o15, icon: 'fas fa-plane-departure', color: 'bg-orange-700' },
                { label: `${awayTeam} U 1.5`, value: p_away_u15, icon: 'fas fa-plane-departure', color: 'bg-orange-600' }
            );

            // Renderizar los mercados
            let html = '';
            marketData.forEach(market => {
                const prob = (market.value * 100).toFixed(2);
                const isFavorite = market.value > 0.55; 
                const cardClass = isFavorite ? 'border-4 border-yellow-500 bg-white shadow-xl transform scale-105' : 'bg-white shadow-md border border-gray-200';
                
                html += `
                    <div class="p-3 rounded-xl text-center ${cardClass} transition duration-300">
                        <div class="flex items-center justify-center mb-1">
                            <i class="${market.icon} mr-1 text-base ${isFavorite ? 'text-yellow-500' : 'text-gray-500'}"></i>
                            <p class="font-semibold text-xs text-gray-700 leading-tight">${market.label}</p>
                        </div>
                        <p class="text-2xl font-extrabold ${isFavorite ? 'text-green-700' : 'text-gray-800'}">${prob}%</p>
                    </div>
                `;
            });

            marketDiv.innerHTML = html;
        }


        /* --- Funciones de Presentación --- */
        
        function displayMatchesSample() {
            const tableBody = document.getElementById('matchesTable');
            
            let html = `
                <thead>
                    <tr>
                        <th class="bg-indigo-900">Local</th>
                        <th class="bg-indigo-900">Goles L</th>
                        <th class="bg-indigo-900">Goles V</th>
                        <th class="bg-indigo-900">Visitante</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            const sampleMatches = allHistoricalMatches.slice(0, 10);
            
            sampleMatches.forEach(match => {
                html += `
                    <tr>
                        <td>${match[HOME_TEAM_COL]}</td>
                        <td>${match[HOME_GOALS_COL]}</td>
                        <td>${match[AWAY_GOALS_COL]}</td>
                        <td>${match[AWAY_TEAM_COL]}</td>
                    </tr>
                `;
            });

            html += `</tbody>`;
            tableBody.innerHTML = html;
        }
        
        function displayFutureMatches() {
            const groupedMatches = groupAndSortFutureMatches(futureMatches);
            const teamStrengthsKeys = Object.keys(teamStrengths);
            const tableContainer = document.getElementById('futureMatchesTableContainer');
            let html = '';
            let teamsNotFound = false;

            // Iterar a través de los grupos por fecha
            for (const dateKey in groupedMatches) {
                if (groupedMatches.hasOwnProperty(dateKey)) {
                    const matchesOfTheDay = groupedMatches[dateKey];
                    // Crear un ID único basado en la fecha
                    const dateId = 'date-group-' + dateKey.replace(/[^a-zA-Z0-9]/g, '-');
                    
                    // Encabezado del Accordion (La fecha)
                    html += `
                        <div class="mt-4">
                            <button class="accordion-header w-full text-left p-3 bg-yellow-700 hover:bg-yellow-800 text-white font-bold rounded-xl flex justify-between items-center transition duration-150 shadow-md" 
                                    onclick="toggleAccordion('${dateId}')">
                                <span>${dateKey} (${matchesOfTheDay.length} partidos)</span>
                                <i class="fas fa-chevron-down transform transition-transform duration-300" id="icon-${dateId}"></i>
                            </button>
                            
                            <!-- Contenido del Accordion (Inicialmente oculto) -->
                            <div id="${dateId}" class="accordion-content">
                                <div class="table-container p-2 bg-white rounded-b-xl border border-yellow-300 border-t-0">
                                    <table class="poisson-table w-full text-center">
                                        <thead>
                                            <tr>
                                                <th class="bg-yellow-600 rounded-none w-1/3">Local</th>
                                                <th class="bg-yellow-600 rounded-none w-1/3">Visitante</th>
                                                <th class="bg-yellow-600 rounded-none w-1/3">Cuotas (1X2)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;

                    // Cuerpo del Accordion (Lista de Partidos)
                    matchesOfTheDay.forEach(match => {
                        const homeFound = teamStrengthsKeys.includes(match[HOME_TEAM_COL]);
                        const awayFound = teamStrengthsKeys.includes(match[AWAY_TEAM_COL]);
                        
                        const bgColor = (!homeFound || !awayFound) ? 'bg-red-50 text-red-700' : 'bg-white text-gray-800';
                        const warningIcon = (!homeFound || !awayFound) ? '<i class="fas fa-exclamation-circle text-red-500 ml-1"></i>' : '';
                        
                        const oddsHtml = match.odds && (match.odds['1'] || match.odds['X'] || match.odds['2'])
                            ? `<span class="text-xs font-bold text-gray-700">${match.odds['1'].toFixed(2)}</span> / <span class="text-xs font-bold text-gray-700">${match.odds['X'].toFixed(2)}</span> / <span class="text-xs font-bold text-gray-700">${match.odds['2'].toFixed(2)}</span>`
                            : '<span class="text-xs text-gray-400">N/A</span>';
                        
                        if (!homeFound || !awayFound) teamsNotFound = true;
                        
                        html += `
                            <tr class="future-match-row ${bgColor}" 
                                onclick="runCalculations(${match.originalIndex}, this)">
                                <td class="font-semibold">${match[HOME_TEAM_COL]}</td>
                                <td class="font-semibold">${match[AWAY_TEAM_COL]}${warningIcon}</td>
                                <td>${oddsHtml}</td>
                            </tr>
                        `;
                    });

                    // Cierre de tags
                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            tableContainer.innerHTML = html;
            
            if(teamsNotFound) {
                 document.getElementById('futureTeamsWarning').classList.remove('hidden');
            } else {
                 document.getElementById('futureTeamsWarning').classList.add('hidden');
            }
        }

        function displayDetailedForecast(homeTeam, awayTeam, results) {
            lastForecastResults = results;
            const { homeWinProb, awayWinProb, drawProb, maxProb, bestScore } = results;
            const detailedDiv = document.getElementById('detailedForecast');

            // Determinar la probabilidad más alta
            const maxProb1X2 = Math.max(homeWinProb, drawProb, awayWinProb);

            const getHighlight = (prob) => prob === maxProb1X2 && maxProb1X2 > 0.005 ? 'shadow-xl ring-4 ring-yellow-400' : 'shadow-lg border border-gray-200';

            let html = `
                <div class="grid grid-cols-3 gap-3 text-center mb-6">
                    <div id="prob1" class="p-3 bg-white rounded-xl ${getHighlight(homeWinProb)}">
                        <p class="text-sm font-medium text-indigo-700">${homeTeam} (1)</p>
                        <p class="text-3xl font-extrabold text-indigo-800">${(homeWinProb * 100).toFixed(2)}%</p>
                    </div>
                    <div id="probX" class="p-3 bg-white rounded-xl ${getHighlight(drawProb)}">
                        <p class="text-sm font-medium text-gray-700">Empate (X)</p>
                        <p class="text-3xl font-extrabold text-gray-800">${(drawProb * 100).toFixed(2)}%</p>
                    </div>
                    <div id="prob2" class="p-3 bg-white rounded-xl ${getHighlight(awayWinProb)}">
                        <p class="text-sm font-medium text-red-700">${awayTeam} (2)</p>
                        <p class="text-3xl font-extrabold text-red-800">${(awayWinProb * 100).toFixed(2)}%</p>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-yellow-100 rounded-lg text-center font-bold text-gray-800 border border-yellow-300">
                    <i class="fas fa-medal mr-2 text-yellow-500"></i>
                    Marcador más probable: <span class="text-indigo-800">${bestScore}</span> con <span class="text-indigo-800">${(maxProb * 100).toFixed(2)}%</span>.
                </div>
            `;
            detailedDiv.innerHTML = html;
        }

        function displaySummary(homeTeam, awayTeam, xg) {
            const { xG_Home, xG_Away } = xg;
            const homeStrengths = teamStrengths[homeTeam];
            const awayStrengths = teamStrengths[awayTeam];
            const summaryDiv = document.getElementById('summaryResults');
            
            const getColor = (value, inverse = false) => {
                if (value > 1.05) return inverse ? 'text-red-600' : 'text-green-600';
                if (value < 0.95) return inverse ? 'text-green-600' : 'text-red-600';
                return 'text-gray-600';
            };
            
            const getIcon = (value, inverse = false) => {
                 if (value > 1.05) return inverse ? '<i class="fas fa-shield-alt"></i>' : '<i class="fas fa-fist-raised"></i>';
                if (value < 0.95) return inverse ? '<i class="fas fa-fist-raised"></i>' : '<i class="fas fa-shield-alt"></i>';
                return '<i class="fas fa-equals"></i>';
            };


            const html = `
                <!-- Home Team Summary -->
                <div class="p-3 bg-white rounded-xl shadow-lg border-l-4 border-blue-600">
                    <h4 class="text-sm font-bold text-blue-800 mb-2 flex items-center"><i class="fas fa-home mr-1"></i> ${homeTeam}</h4>
                    
                    <div class="text-center mb-2">
                        <p class="text-xs font-bold text-blue-800">xG:</p> 
                        <p class="text-2xl font-extrabold text-blue-800">${xG_Home.toFixed(2)}</p>
                    </div>

                    <div class="flex justify-between items-center text-xs border-t pt-1">
                        <span class="font-semibold text-gray-700">Ataque (AS):</span>
                        <span class="font-bold ${getColor(homeStrengths.AS_Home)}">${homeStrengths.AS_Home.toFixed(3)} ${getIcon(homeStrengths.AS_Home)}</span>
                    </div>
                     <div class="flex justify-between items-center text-xs">
                        <span class="font-semibold text-gray-700">Defensa (DS):</span>
                        <span class="font-bold ${getColor(homeStrengths.DS_Home, true)}">${homeStrengths.DS_Home.toFixed(3)} ${getIcon(homeStrengths.DS_Home, true)}</span>
                    </div>
                </div>
                
                <!-- Away Team Summary -->
                <div class="p-3 bg-white rounded-xl shadow-lg border-l-4 border-red-600">
                    <h4 class="text-sm font-bold text-red-800 mb-2 flex items-center"><i class="fas fa-plane-departure mr-1"></i> ${awayTeam}</h4>
                    
                    <div class="text-center mb-2">
                        <p class="text-xs font-bold text-red-800">xG:</p>
                        <p class="text-2xl font-extrabold text-red-800">${xG_Away.toFixed(2)}</p>
                    </div>

                    <div class="flex justify-between items-center text-xs border-t pt-1">
                        <span class="font-semibold text-gray-700">Ataque (AS):</span>
                        <span class="font-bold ${getColor(awayStrengths.AS_Away)}">${awayStrengths.AS_Away.toFixed(3)} ${getIcon(awayStrengths.AS_Away)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="font-semibold text-gray-700">Defensa (DS):</span>
                        <span class="font-bold ${getColor(awayStrengths.DS_Away, true)}">${awayStrengths.DS_Away.toFixed(3)} ${getIcon(awayStrengths.DS_Away, true)}</span>
                    </div>
                </div>

                <div class="col-span-2 text-center text-xs text-gray-500 mt-2">
                    <p>Fuerzas > 1.0 = Superior al promedio de la liga.</p>
                </div>
            `;
            summaryDiv.innerHTML = html;
        }

        function calculateValue() {
            if (!lastForecastResults) {
                document.getElementById('valueResults').innerHTML = '<p class="text-red-500 text-center font-semibold text-sm">Primero selecciona y ejecuta la predicción de un partido futuro.</p>';
                return;
            }

            // Limpiar resultados anteriores o mostrar mensaje
            document.getElementById('valueResults').innerHTML = '<p class="text-sm text-gray-500 text-center">Ingresa cuotas para calcular el valor.</p>';

            const odds1 = parseFloat(document.getElementById('odds1').value);
            const oddsX = parseFloat(document.getElementById('oddsX').value);
            const odds2 = parseFloat(document.getElementById('odds2').value);
            
            const { homeWinProb, awayWinProb, drawProb } = lastForecastResults;

            const results = [
                { prob: homeWinProb, odds: odds1, label: 'Local (1)' },
                { prob: drawProb, odds: oddsX, label: 'Empate (X)' },
                { prob: awayWinProb, odds: odds2, label: 'Visitante (2)' }
            ];

            let html = '<div class="space-y-2">';
            let hasValidOdds = false;

            results.forEach(res => {
                if (res.odds && res.odds > 1) {
                    hasValidOdds = true;
                    const impliedProb = 1 / res.odds;
                    const valuePercentage = ((res.prob / impliedProb) - 1) * 100;
                    
                    let valueClass = 'bg-gray-100 text-gray-600';
                    let valueText = 'Neutral';
                    let icon = 'fas fa-minus-circle';
                    
                    if (valuePercentage > 5) {
                        valueClass = 'bg-green-100 text-green-700 font-extrabold border-l-4 border-green-500';
                        valueText = `¡VALUE BET! (+${valuePercentage.toFixed(1)}%)`;
                        icon = 'fas fa-chart-line';
                    } else if (valuePercentage < -5) {
                        valueClass = 'bg-red-100 text-red-700 border-l-4 border-red-500';
                        valueText = `Sin Valor (-${Math.abs(valuePercentage).toFixed(1)}%)`;
                        icon = 'fas fa-cash-register';
                    } else {
                        valueClass = 'bg-yellow-100 text-yellow-700 border-l-4 border-yellow-500';
                        valueText = `Valor Neutral (${valuePercentage.toFixed(1)}%)`;
                        icon = 'fas fa-balance-scale';
                    }
                    
                    html += `
                        <div class="flex justify-between items-center p-2 rounded-lg ${valueClass}">
                            <span class="text-sm font-bold w-1/4 text-left">${res.label}</span>
                            <span class="text-xs font-medium w-1/4 text-center">Mod: ${(res.prob * 100).toFixed(1)}%</span>
                            <span class="text-xs font-medium w-1/4 text-center">Cuota: ${res.odds.toFixed(2)}</span>
                            <span class="text-xs font-bold w-1/4 text-right flex items-center justify-end">
                                <i class="${icon} mr-1"></i> ${valueText}
                            </span>
                        </div>
                    `;
                }
            });

            if (hasValidOdds) {
                document.getElementById('valueResults').innerHTML = html + '</div>';
            }
        }


        function runCalculations(matchIndex, clickedRow) {
            
            const match = futureMatches[matchIndex];
            const homeTeam = match[HOME_TEAM_COL];
            const awayTeam = match[AWAY_TEAM_COL];

            // 1. Limpiar estilos de selección
            document.querySelectorAll('.future-match-row').forEach(row => {
                row.classList.remove('selected-match');
            });
            clickedRow.classList.add('selected-match');

            // 2. Limpiar y configurar UI
            document.getElementById('currentMatchTitle').textContent = `${homeTeam} vs ${awayTeam}`;
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('summaryResultsSection').classList.add('hidden');
            document.getElementById('odds1').value = '';
            document.getElementById('oddsX').value = '';
            document.getElementById('odds2').value = '';
            document.getElementById('valueResults').innerHTML = '<p class="text-sm text-gray-500 text-center">Ingresa cuotas para calcular el valor.</p>';


            if (!teamStrengths[homeTeam] || !teamStrengths[awayTeam]) {
                 showModal("Error de Datos", `El partido ${homeTeam} vs ${awayTeam} no puede ser analizado porque uno o ambos equipos no se encontraron en los datos históricos.`, 'error');
                 return;
            }

            try {
                // 3. Auto-poblar las cuotas
                const odds = match.odds || {};
                
                // Solo poblar si el valor de la cuota es > 1 (un valor válido)
                if (odds['1'] && odds['1'] > 1) document.getElementById('odds1').value = odds['1'].toFixed(2);
                if (odds['X'] && odds['X'] > 1) document.getElementById('oddsX').value = odds['X'].toFixed(2);
                if (odds['2'] && odds['2'] > 1) document.getElementById('odds2').value = odds['2'].toFixed(2);

                // 4. Ejecutar cálculos del modelo
                const expectedGoals = calculateExpectedGoals(homeTeam, awayTeam);
                displaySummary(homeTeam, awayTeam, expectedGoals);

                const results = generatePoissonMatrix(expectedGoals, homeTeam, awayTeam);
                
                displayDetailedForecast(homeTeam, awayTeam, results);
                calculateAllMarkets(homeTeam, awayTeam, results.homeProbs, results.awayProbs);

                // 5. Si se poblaron cuotas, ejecutar el cálculo de valor inmediatamente
                if (odds['1'] || odds['X'] || odds['2']) {
                    calculateValue();
                }

                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('summaryResultsSection').classList.remove('hidden');

            } catch (error) {
                showModal("Error en el Cálculo", `No se pudieron calcular las predicciones. Razón: ${error.message}`);
            }
        }
    </script>
</body>
</html>


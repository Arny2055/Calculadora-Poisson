<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estadísticas Over/Under (limpio + comparación liga)</title>
<style>
  :root{
    --bg:#0b1220; --card:#101827; --panel:#111b2b; --text:#e6eaf2; --muted:#9aa6b2;
    --accent:#3b82f6; --green:#16a34a; --amber:#f59e0b; --red:#ef4444; --line:#243244;
    --chip:#0c1323;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px}
  h1{color:#dbeafe;text-align:center;margin:8px 0 16px;font-weight:800;letter-spacing:.2px}

  .card{background:var(--card);border-radius:14px;padding:16px;margin:16px 0;border:1px solid var(--line)}
  label{display:block;margin:8px 0 6px;color:var(--muted);font-size:.9rem}
  select,input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1726;color:#e5e7eb;font-size:16px}
  button{background:var(--accent);border-color:var(--accent);font-weight:700;letter-spacing:.3px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .row{display:grid;gap:10px}
  @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .tab{flex:1;min-width:110px;background:#0f1726;border:1px solid var(--line);color:#94a3b8;padding:10px;border-radius:10px;cursor:pointer;text-align:center}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:700}
  #status{margin-top:8px;font-size:.92rem;color:var(--muted)}
  #status.ok{color:var(--green)} #status.err{color:var(--red)}

  .preview{display:flex;gap:8px;flex-wrap:wrap;align-items:center;background:#0f1726;border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-top:12px}
  .preview .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-weight:700;color:#e5e7eb}
  .preview .chip .dot{width:8px;height:8px;border-radius:50%}
  .preview .chip.league .dot{background:var(--accent)}
  .preview .chip.home .dot{background:var(--green)}
  .preview .chip.away .dot{background:var(--red)}

  .grid{display:grid;gap:12px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}

  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h3{margin:0 0 10px;font-size:1.02rem;color:#d7dee8;font-weight:800}
  .kv{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed var(--line)}
  .kv:last-child{border-bottom:0}
  .muted{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums}
  .divider{height:8px}

  /* Badges */
  .badge{display:inline-block;min-width:44px;text-align:center;padding:3px 8px;border-radius:999px;font-weight:800;color:#fff;font-size:.85rem}
  .b-green{background:var(--green)} .b-amber{background:var(--amber)} .b-red{background:var(--red)}
  .b-soft{background:#0f1726;border:1px solid var(--line);color:#cbd5e1}

  /* Tabla limpia con baseline compacto */
  table.clean{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
  table.clean th{color:#cbd5e1;font-weight:700;text-align:center;padding:6px 8px}
  table.clean td{background:#0f1726;border:1px solid var(--line);padding:10px;border-left:0;border-right:0}
  table.clean tr td:first-child{border-left:1px solid var(--line);border-top-left-radius:10px;border-bottom-left-radius:10px}
  table.clean tr td:last-child{border-right:1px solid var(--line);border-top-right-radius:10px;border-bottom-right-radius:10px}
  .cellStack{display:flex;align-items:center;justify-content:center;gap:8px}
  .stack{display:flex;flex-direction:column;line-height:1.05}
  .stack .top{font-weight:800}
  .stack .bottom{font-size:.78rem;color:var(--muted)}
  .delta{font-size:.78rem;font-weight:800;border-radius:999px;padding:3px 8px;border:1px solid var(--line);background:rgba(255,255,255,0.03)}
  .delta.pos{color:var(--green)}
  .delta.neg{color:var(--red)}
  .delta.neu{color:#93a3b5}
  .arrow{font-weight:900;margin-right:4px}

  /* Pills */
  .pills{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:980px){.pills{grid-template-columns:repeat(3,1fr)}}
  .pill{
    background:#0f1726;border:1px solid var(--line);
    border-radius:16px;padding:12px 12px 10px;min-height:80px;
    display:flex;flex-direction:column;justify-content:space-between;
  }
  .pill .big{font-weight:900;font-size:1.05rem}
  .pill .caption{color:#cbd5e1;font-weight:700}
  .pill.ok{outline:2px solid var(--green)} .pill.warn{outline:2px solid var(--amber)} .pill.bad{outline:2px solid var(--red)}

  /* Value */
  .valueBox{margin-top:10px;padding:12px;border-radius:10px;text-align:center;font-weight:900}
  .value{background:var(--green);color:#fff} .novalue{background:var(--red);color:#fff}
</style>
</head>
<body>
  <h1>Estadísticas Over/Under</h1>

  <div class="card">
    <input type="file" id="fileInput" accept=".json,.txt"><br>

    <div class="row">
      <div>
        <label>Selecciona Liga</label>
        <select id="leagueSelect"></select>
      </div>
      <div>
        <label>Odd Over 2.5</label>
        <input type="number" id="oddOver" step="0.01" placeholder="Ej: 1.90">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Equipo Local</label>
        <select id="homeSelect"></select>
      </div>
      <div>
        <label>Odd Under 2.5</label>
        <input type="number" id="oddUnder" step="0.01" placeholder="Ej: 2.00">
      </div>
    </div>

    <label>Equipo Visitante</label>
    <select id="awaySelect"></select>

    <div class="tabs" id="tabs">
      <div class="tab active" data-period="FT">Full Time</div>
      <div class="tab" data-period="1H">First Half</div>
      <div class="tab" data-period="2H">Second Half</div>
    </div>

    <button id="analyzeBtn" style="margin-top:10px">Analizar</button>
    <div id="status" class="muted"></div>

    <div id="selectionPreview" class="preview" style="display:none">
      <div class="chip league"><span class="dot"></span><span id="pvLeague">—</span></div>
      <div class="chip home"><span class="dot"></span><span id="pvHome">—</span></div>
      <div class="chip away"><span class="dot"></span><span id="pvAway">—</span></div>
    </div>
  </div>

  <div id="results" class="card"></div>

<script>
let rawMatches = [];
let allMatches = [];
let currentPeriod = "FT";

/* ===== Utils ===== */
const toNum = v => (v===null||v===undefined||v==='')? null : Number(v);
function tryParseJSON(text){
  try { return JSON.parse(text); } catch(e){}
  const wrapped = "[" + text.trim().replace(/(^,)|(,$)/g,"").replace(/\n+/g,"\n").replace(/\}\s*,\s*\{/g,"},{") + "]";
  try { return JSON.parse(wrapped); } catch(e2){ return []; }
}
function pct(a,b){ return b ? Math.round((a/b)*100) : 0; }
function cls(p){ return p>=70?"b-green":(p>=50?"b-amber":"b-red"); }
function setStatus(msg, ok=false, err=false){
  const el = document.getElementById('status');
  el.textContent = msg || '';
  el.classList.remove('ok','err');
  if(ok) el.classList.add('ok');
  if(err) el.classList.add('err');
}

/* ===== Normalización ===== */
function getVal(obj, keys){
  for(const k of keys){ if(obj[k]!==undefined && obj[k]!==null && obj[k]!=='') return obj[k]; }
  return undefined;
}
function splitTeams(matchStr){
  if(typeof matchStr !== 'string') return [null,null];
  const parts = matchStr.split(/\s+-\s+|\s+vs\.?\s+|\s+v\s+/i);
  if(parts.length>=2) return [parts[0].trim(), parts[1].trim()];
  return [null,null];
}
/* Fecha flexible (formatos ES primero) */
function parseDateFlexible(v){
  if(v===null || v===undefined || v==='') return null;
  if(typeof v === 'number'){
    if(v > 1e12) return v; if(v > 1e9) return v*1000; return null;
  }
  if(typeof v !== 'string') return null;
  let s = v.trim();
  s = s.replace(/^(lun|mar|mi[eé]|jue|vie|s[aá]b|dom)\.?,?\s*/i, '');
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){
    let dd=+m[1], mm=+m[2]-1, yy=+m[3]; if(yy<100) yy+=2000;
    let hh=+(m[4]||0), mi=+(m[5]||0), ss=+(m[6]||0);
    return new Date(yy,mm,dd,hh,mi,ss).getTime();
  }
  const months = { ene:'01',feb:'02',mar:'03',abr:'04',may:'05',jun:'06',jul:'07',ago:'08',sep:'09',sept:'09',set:'09',oct:'10',nov:'11',dic:'12' };
  m = s.match(/^(\d{1,2})\s+([a-záéíóúñ\.]+)\s+(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/i);
  if(m){
    let dd=+m[1];
    let mon=(m[2]||'').toLowerCase().replace(/\./g,'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    let yy=+m[3]; if(yy<100) yy+=2000;
    let hh=+(m[4]||0), mi=+(m[5]||0), ss=+(m[6]||0);
    const mm=months[mon]; if(mm){ return new Date(`${yy}-${mm}-${String(dd).padStart(2,'0')}T${String(hh).padStart(2,'0')}:${String(mi).padStart(2,'0')}:${String(ss).padStart(2,'0')}`).getTime(); }
  }
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){
    let mm=+m[1]-1, dd=+m[2], yy=+m[3]; if(yy<100) yy+=2000;
    let hh=+(m[4]||0), mi=+(m[5]||0), ss=+(m[6]||0);
    return new Date(yy,mm,dd,hh,mi,ss).getTime();
  }
  const dISO = Date.parse(s);
  return isNaN(dISO) ? null : dISO;
}
function isDesiredO25(x){
  if(!x) return false;
  const s = String(x).toLowerCase().replace(/\s+/g,'');
  return s==='o25'||s==='o2.5'||s==='over2.5'||s==='over25'||s==='over_2_5';
}
function extractOddO25(m){
  if(isDesiredO25(m['Desired Outcome']) || isDesiredO25(m['DesiredOutcome'])){
    const od = toNum(m.Odd ?? m.odd ?? m['Odd PreMatch'] ?? m['Odd Prematch'] ?? m['Precio'] ?? m['Price']);
    if(od && od>1) return od;
  }
  const direct = m.O25 ?? m.o25 ?? m["Over 2.5"] ?? m["over2.5"] ?? m.over25 ?? m.over_2_5 ??
                 m["Odd Over 2.5"] ?? m.odd_o25 ?? m.o2_5 ?? m["Odds Over 2.5"] ?? m.price_o25 ?? m.pre_o25;
  let val = toNum(direct); if(val && val>1) return val;
  for(const k of Object.keys(m)){
    const lk = k.toLowerCase();
    if(/(over|o)\s*2[._\s-]*5/.test(lk) && /(odd|cuota|price|odds|pre)/.test(lk)){
      const v = toNum(m[k]); if(v && v>1) return v;
    }
  }
  return null;
}
function normalizeRow(m, idx){
  const league = getVal(m, ['League','league','Liga','liga','Competition','competition','league_name']) || '';
  let home=null, away=null;
  const matchStr = getVal(m, ['Match','match','Partido','fixture','evento']);
  if(matchStr){ [home,away] = splitTeams(matchStr); }
  if(!home) home = getVal(m, ['Home','home','Home Team','home_team','team_home','Local','local']);
  if(!away) away = getVal(m, ['Away','away','Away Team','away_team','team_away','Visitante','visitante']);
  home = (home||'').toString().trim(); away = (away||'').toString().trim();

  const getScore = keys => {
    const s = getVal(m, keys);
    if(typeof s==='string' && /-/.test(s)){ const [a,b]=s.split('-').map(x=>parseInt(x,10)); return [a||0,b||0]; }
    return [null,null];
  };
  const [htH1,htA1] = getScore(['Result HT','result_ht','HT','ht','Half Time','halftime']);
  const [ftH1,ftA1] = getScore(['Result FT','result_ft','FT','ft','Full Time','fulltime','score']);
  const htH = (htH1!==null) ? htH1 : (toNum(getVal(m, ['home_ht','ht_home','Home HT'])) ?? 0);
  const htA = (htA1!==null) ? htA1 : (toNum(getVal(m, ['away_ht','ht_away','Away HT'])) ?? 0);
  const ftH = (ftH1!==null) ? ftH1 : (toNum(getVal(m, ['home_ft','ft_home','Home FT','home_goals','goals_home'])) ?? 0);
  const ftA = (ftA1!==null) ? ftA1 : (toNum(getVal(m, ['away_ft','ft_away','Away FT','away_goals','goals_away'])) ?? 0);

  const hcft = toNum(getVal(m, ['Home Corners at FT','home_corners_ft','home_corners','corners_home_ft']));
  const acft = toNum(getVal(m, ['Away Corners at FT','away_corners_ft','away_corners','corners_away_ft']));

  const dateRaw = getVal(m, ['Date','date','Fecha','fecha','Match Date','match_date','Kickoff','kickoff','Start','start','UtcDate','utcDate','game_date','time','timestamp','ts','datetime']);
  const ts = parseDateFlexible(dateRaw);

  const oddO25 = extractOddO25(m);

  return {
    idx, ts: ts||null, league,
    home, away, Match: (home && away) ? `${home} - ${away}` : (matchStr || ''),
    htHome: htH||0, htAway: htA||0, ftHome: ftH||0, ftAway: ftA||0,
    home_corners_ft: hcft ?? 0, away_corners_ft: acft ?? 0,
    odd_o25: oddO25
  };
}

/* ===== Cálculos ===== */
function periodGoalsN(m){
  if(currentPeriod==="FT") return [m.ftHome, m.ftAway];
  if(currentPeriod==="1H") return [m.htHome, m.htAway];
  return [(m.ftHome-m.htHome),(m.ftAway-m.htAway)];
}
function lastMatchesByRole(matches, team, role){
  const arr = matches
    .filter(m => role==="home" ? m.home===team : m.away===team)
    .sort((a,b)=>{
      if(a.ts && b.ts) return a.ts - b.ts;
      if(a.ts && !b.ts) return 1;
      if(!a.ts && b.ts) return -1;
      return a.idx - b.idx;
    });
  return arr.slice(-10);
}
function percentOver(lastMatches, line){
  const n=lastMatches.length; let over=0;
  lastMatches.forEach(m=>{ const [h,a]=periodGoalsN(m); if(h+a>line) over++; });
  return pct(over,n);
}
function percentBTTS(lastMatches){
  const n=lastMatches.length; let yes=0;
  lastMatches.forEach(m=>{ const [h,a]=periodGoalsN(m); if(h>0 && a>0) yes++; });
  return pct(yes,n);
}
function buildSummaryStats(arr){
  return { o05:percentOver(arr,0.5), o15:percentOver(arr,1.5), o25:percentOver(arr,2.5), o35:percentOver(arr,3.5), btts:percentBTTS(arr) };
}

/* ===== Baseline de liga ===== */
function getLeagueTeams(leagueMatches){
  return [...new Set(leagueMatches.flatMap(m=>[m.home,m.away]))].filter(Boolean);
}
function leagueWindowByRole(leagueMatches, role, n){
  const teams = getLeagueTeams(leagueMatches);
  const all = [];
  teams.forEach(t=>{
    const arr = lastMatchesByRole(leagueMatches, t, role).slice(-n);
    all.push(...arr);
  });
  return all;
}
function computeLeagueBaseline(leagueMatches, n){
  const Lh = leagueWindowByRole(leagueMatches,'home',n);
  const La = leagueWindowByRole(leagueMatches,'away',n);
  const Bh = buildSummaryStats(Lh);
  const Ba = buildSummaryStats(La);
  const avg = (x,y)=>Math.round((x+y)/2);
  return {
    home: Bh, away: Ba,
    match: { o05:avg(Bh.o05,Ba.o05), o15:avg(Bh.o15,Ba.o15), o25:avg(Bh.o25,Ba.o25), o35:avg(Bh.o35,Ba.o35), btts:avg(Bh.btts,Ba.btts) }
  };
}

/* ===== Poisson ===== */
function poisCDF(k, lambda){
  let p0=Math.exp(-lambda), sum=p0, p=p0;
  for(let i=1;i<=k;i++){ p = p*(lambda/i); sum += p; }
  return sum;
}
function probTeamOver(lambda, lineHalf){ const k=Math.floor(lineHalf); return 1 - poisCDF(k, lambda); }
function probTotalOver(lambdaH, lambdaA, lineHalf){ const L=lambdaH+lambdaA; const k=Math.floor(lineHalf); return 1 - poisCDF(k, L); }
function probBTTS(lambdaH, lambdaA){ return 1 - Math.exp(-lambdaH) - Math.exp(-lambdaA) + Math.exp(-(lambdaH+lambdaA)); }

/* ===== Panels ===== */
function calcTeamBlock(matches, team, role){
  const last = lastMatchesByRole(matches, team, role); const n=last.length;
  let noScore=0,noConcede=0,s=0,c=0,t=0;
  last.forEach(m=>{
    const [h,a]=periodGoalsN(m);
    const forTeam=(team===m.home)?h:(team===m.away)?a:null;
    const opp=(team===m.home)?a:(team===m.away)?h:null;
    if(forTeam==null) return;
    if(forTeam===0) noScore++;
    if(opp===0) noConcede++;
    s+=forTeam; c+=opp; t+=forTeam+opp;
  });
  return { n,last, avgScored:n?(s/n).toFixed(1):"0.0", avgConceded:n?(c/n).toFixed(1):"0.0", avgGoals:n?(t/n).toFixed(1):"0.0", pNoScore:pct(noScore,n), pNoConcede:pct(noConcede,n) };
}
function renderTeamPanel(title, stats){
  return `
  <div class="panel">
    <div class="kv"><span class="muted"><strong>${title}</strong></span><span class="mono"></span></div>
    <div class="kv"><span class="muted">Avg. Scored</span><span class="mono">${stats.avgScored}</span></div>
    <div class="kv"><span class="muted">Avg. Suffer</span><span class="mono">${stats.avgConceded}</span></div>
    <div class="kv"><span class="muted">Avg. Goals</span><span class="mono">${stats.avgGoals}</span></div>
    <div class="divider"></div>
    <div class="kv"><span>Games without Scoring</span><span><span class="badge ${cls(stats.pNoScore)}">${stats.pNoScore}%</span></span></div>
    <div class="kv"><span>Games without Conceding</span><span><span class="badge ${cls(stats.pNoConcede)}">${stats.pNoConcede}%</span></span></div>
  </div>`;
}

/* ===== Tabla limpia con baseline y delta en la celda ===== */
function deltaBadge(val, base){
  if(base===null || base===undefined) return `<span class="delta neu">±0pp</span>`;
  const d = Math.round(val - base);
  if(d>0) return `<span class="delta pos"><span class="arrow">▲</span>${d}pp</span>`;
  if(d<0) return `<span class="delta neg"><span class="arrow">▼</span>${Math.abs(d)}pp</span>`;
  return `<span class="delta neu">±0pp</span>`;
}
function stackCell(val, base){
  const colorClass = cls(val);
  return `
    <div class="cellStack">
      <div class="stack">
        <div class="top"><span class="badge ${colorClass}">${val}%</span></div>
        <div class="bottom">Liga: ${base}%</div>
      </div>
      ${deltaBadge(val, base)}
    </div>`;
}
function renderSummaryClean(homeLast10, awayLast10, n, leagueMatches){
  const H = buildSummaryStats(homeLast10.slice(-n));
  const A = buildSummaryStats(awayLast10.slice(-n));
  const L = computeLeagueBaseline(leagueMatches, n);
  const avg = (x,y)=>Math.round((x+y)/2);

  const rows = [
    ['Over 0.5','o05'],
    ['Over 1.5','o15'],
    ['Over 2.5','o25'],
    ['Over 3.5','o35'],
    ['BTTS','btts']
  ];

  const row = ([label,key]) => `
    <tr>
      <td style="text-align:left;padding-left:14px;background:transparent;border:0;color:#d7dee8;font-weight:800">${label}</td>
      <td>${stackCell(H[key], L.home[key])}</td>
      <td>${stackCell(A[key], L.away[key])}</td>
      <td>${stackCell(avg(H[key],A[key]), L.match[key])}</td>
    </tr>`;

  return `
    <div class="panel">
      <h3>Resumen limpio (últimos ${n})</h3>
      <table class="clean">
        <tr>
          <th style="text-align:left;padding-left:6px">Mercado</th>
          <th>Home</th>
          <th>Away</th>
          <th>Match</th>
        </tr>
        ${rows.map(row).join("")}
      </table>
      <div class="muted" style="margin-top:6px;font-size:.9rem">
        * “Liga” es el baseline por rol (home vs home, away vs away) concatenando los últimos ${n} por equipo. Δ = diferencia en puntos porcentuales.
      </div>
    </div>`;
}

/* ===== Promedios para Poisson/Predicciones ===== */
function teamAverages(lastMatches, team){
  let s=0,c=0,t=0,n=lastMatches.length||1;
  lastMatches.forEach(m=>{
    const [h,a]=periodGoalsN(m);
    const forTeam=(team===m.home)?h:(team===m.away)?a:null;
    const opp=(team===m.home)?a:(team===m.away)?h:null;
    if(forTeam==null) return;
    s+=forTeam; c+=opp; t+=forTeam+opp;
  });
  return {avgScored:(s/n).toFixed(1), avgConceded:(c/n).toFixed(1), avgGoals:(t/n).toFixed(1)};
}
function avgCornersFT(lastMatches){
  let sum=0,n=0;
  lastMatches.forEach(m=>{
    const c=Number(m.home_corners_ft||0)+Number(m.away_corners_ft||0);
    if(!isNaN(c)){ sum+=c; n++; }
  });
  return n? (sum/n) : 0;
}

/* ===== Predicciones (histórico, compacto) ===== */
function renderPredictions(homeTeam, awayTeam, homeLast, awayLast){
  const percentOverArr=(arr,line)=>pct(arr.filter(m=>{const[g1,g2]=periodGoalsN(m);return g1+g2>line;}).length,arr.length);
  const pO05=Math.round((percentOverArr(homeLast,0.5)+percentOverArr(awayLast,0.5))/2);
  const pO25=Math.round((percentOverArr(homeLast,2.5)+percentOverArr(awayLast,2.5))/2);
  const pO15=Math.round((percentOverArr(homeLast,1.5)+percentOverArr(awayLast,1.5))/2);
  const pBTTS=Math.round((pct(homeLast.filter(m=>{const[g1,g2]=periodGoalsN(m);return g1>0&&g2>0;}).length,homeLast.length) +
                          pct(awayLast.filter(m=>{const[g1,g2]=periodGoalsN(m);return g1>0&&g2>0;}).length,awayLast.length))/2);

  const hAvg=teamAverages(homeLast,homeTeam);
  const aAvg=teamAverages(awayLast,awayTeam);
  const expGoals=Math.round((parseFloat(hAvg.avgScored)+parseFloat(aAvg.avgScored)));
  const avgCorners=Math.round((avgCornersFT(homeLast)+avgCornersFT(awayLast))/2);

  const pillClass=p=>p>=70?'ok':(p>=50?'warn':'bad');
  const pill=(big,caption,klass='')=>`<div class="pill ${klass}"><div class="big">${big}</div><div class="caption">${caption}</div></div>`;
  return `
    <div class="panel">
      <h3>Game Predictions</h3>
      <div class="pills">
        ${pill(`${pO05}%`,'Over 0.5FT',pillClass(pO05))}
        ${pill(`${pO15}%`,'Over 1.5FT',pillClass(pO15))}
        ${pill(`${pO25}%`,'Over 2.5FT',pillClass(pO25))}
        ${pill(`${pBTTS}%`,'BTTS',pillClass(pBTTS))}
        ${pill(`${expGoals}`,'Goals')}
        ${pill(`${avgCorners}`,'Corners')}
      </div>
    </div>`;
}

/* ===== Poisson (compacto) ===== */
function renderPoissonSummaryTable(homeTeam, awayTeam, homeLast, awayLast){
  const hAvg = teamAverages(homeLast, homeTeam);
  const aAvg = teamAverages(awayLast, awayTeam);
  const lambdaH = Math.max(0, parseFloat(hAvg.avgScored)||0);
  const lambdaA = Math.max(0, parseFloat(aAvg.avgScored)||0);
  const lines=[0.5,1.5,2.5,3.5];

  const poisCDFlocal=(k,l)=>{let p0=Math.exp(-l),sum=p0,p=p0;for(let i=1;i<=k;i++){p=p*(l/i);sum+=p}return sum};
  const overTeam=(l,k)=>Math.round((1 - poisCDFlocal(Math.floor(k), l))*100);
  const overMatch=(lh,la,k)=>Math.round((1 - poisCDFlocal(Math.floor(k), lh+la))*100);

  const row = L=>{
    const ph=overTeam(lambdaH,L);
    const pa=overTeam(lambdaA,L);
    const pm=overMatch(lambdaH,lambdaA,L);
    const b=(x)=>`<span class="badge ${cls(x)}">${x}%</span>`;
    return `<tr><td>Over ${L.toFixed(1)}</td><td>${b(ph)}</td><td>${b(pa)}</td><td>${b(pm)}</td></tr>`;
  };
  const bttsMatch = Math.round((1 - Math.exp(-lambdaH) - Math.exp(-lambdaA) + Math.exp(-(lambdaH+lambdaA)))*100);
  return `
    <div class="panel">
      <h3>Summary (Poisson · ${currentPeriod})</h3>
      <div class="kv"><span class="muted">λ Home</span><span class="mono">${lambdaH.toFixed(2)}</span></div>
      <div class="kv"><span class="muted">λ Away</span><span class="mono">${lambdaA.toFixed(2)}</span></div>
      <div class="divider"></div>
      <table class="clean">
        <tr><th></th><th>Home</th><th>Away</th><th>Match</th></tr>
        ${lines.map(row).join("")}
        <tr><td>BTTS</td><td></td><td></td><td><span class="badge ${cls(bttsMatch)}">${bttsMatch}%</span></td></tr>
      </table>
    </div>`;
}

/* ===== Explicación y Value ===== */
function valueBox(prob, odd){
  if(!odd || odd<=1) return "";
  const implied=Math.round(100/odd);
  return prob>implied
    ? `<div class="valueBox value">VALUE (Modelo ${prob}% vs ${implied}% impl.)</div>`
    : `<div class="valueBox novalue">NO VALUE (Modelo ${prob}% vs ${implied}% impl.)</div>`;
}
function percentOverSimple(arr,line){
  return pct(arr.filter(m=>{const[g1,g2]=periodGoalsN(m);return g1+g2>line;}).length,arr.length);
}
function shortAdvice({market, probHist, probPois, odd, sideLabel}){
  const hasPois=Number.isFinite(probPois);
  const consensus=Math.round(hasPois ? (probHist*0.5 + probPois*0.5) : probHist);
  const implied=(odd && odd>1)? Math.round(100/odd) : null;
  if(consensus<55 && !(implied!==null && consensus>implied)) return '';
  const verdict = consensus>=70 ? `Apostar ${sideLabel} (${consensus}%)` : `Considerar ${sideLabel} (${consensus}%)`;
  const reasons=[`Histórico ${probHist}%`];
  if(hasPois) reasons.push(`Poisson ${probPois}%`);
  if(implied!==null) reasons.push(`cuota ${odd} (imp. ${implied}%)`);
  return `• ${market}: ${verdict}. <span class="muted">${reasons.join(' · ')}</span>`;
}
function renderTextExplanation({homeLast, awayLast, oddOver, oddUnder, lambdaH, lambdaA}){
  const poisCDFlocal=(k,l)=>{let p0=Math.exp(-l),sum=p0,p=p0;for(let i=1;i<=k;i++){p=p*(l/i);sum+=p}return sum};
  const poisOver=L=>Math.round((1 - poisCDFlocal(Math.floor(L),lambdaH+lambdaA))*100);
  const lines=[0.5,1.5,2.5,3.5];

  const oversTextArr = lines.map(L=>{
    const hist=Math.round((percentOverSimple(homeLast,L)+percentOverSimple(awayLast,L))/2);
    const pois=poisOver(L);
    const useOdd=(L===2.5)? oddOver : null;
    return shortAdvice({market:`Over ${L.toFixed(1)}`, probHist:hist, probPois:pois, odd:useOdd, sideLabel:`Over ${L.toFixed(1)}`});
  }).filter(Boolean);

  if(oddUnder && oddUnder>1){
    const over25Hist=Math.round((percentOverSimple(homeLast,2.5)+percentOverSimple(awayLast,2.5))/2);
    const over25Pois=poisOver(2.5);
    const underText=shortAdvice({market:`Under 2.5`, probHist:100-over25Hist, probPois:100-over25Pois, odd:oddUnder, sideLabel:'Under 2.5'});
    if(underText) oversTextArr.push(underText);
  }
  if(!oversTextArr.length) return '';
  return `
    <div class="panel">
      <h3>Explicación breve</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${oversTextArr.map(x=>`<div>${x}</div>`).join('')}
      </div>
    </div>`;
}

/* ===== Rentabilidad O2.5 (CSV) ===== */
function ftTotalGoals(m){ return (m.ftHome + m.ftAway); }
function getOver25Odd(m){ return (m.odd_o25 && m.odd_o25>1)? m.odd_o25 : null; }
function computeO25PnlForRole(matches, team, role){
  const last = lastMatchesByRole(matches, team, role).slice(-10);
  let considered=0,hits=0,fails=0,sumOdds=0,profit=0;
  const details=[];
  last.forEach((m,idx)=>{
    const odd=getOver25Odd(m);
    const tg=ftTotalGoals(m);
    const hit=(tg>2.5);
    let stakeProfit=null;
    if(odd && odd>1){
      considered++;
      if(hit){ hits++; stakeProfit=+(odd-1).toFixed(4); profit+=(odd-1); }
      else{ fails++; stakeProfit=-1; profit-=1; }
      sumOdds+=odd;
    }
    const dt = m.ts? new Date(m.ts).toLocaleDateString('es-MX') : '';
    details.push({ idx:idx+1, match:m.Match || `${m.home} - ${m.away}`, result_ft:`${m.ftHome}-${m.ftAway}`, odd_o25:(odd&&odd>1)?odd:'', hit:(odd&&odd>1)?(hit?'✔':'✘'):'—', pnl:(odd&&odd>1)?stakeProfit:'—', date:dt });
  });
  const avgOdd=considered?(sumOdds/considered):0;
  const roi=considered? (profit/considered)*100 : 0;
  return { team, role, played:last.length, considered, hits, fails, avgOdd, profit, roi, details };
}
function renderProfitabilityPanel(leagueMatches, homeTeam, awayTeam){
  const homeRes=computeO25PnlForRole(leagueMatches, homeTeam,'home');
  const awayRes=computeO25PnlForRole(leagueMatches, awayTeam,'away');
  const row=r=>`
    <tr>
      <td>${r.team}</td><td>${r.role.toUpperCase()}</td><td>${r.played}</td><td>${r.considered}</td>
      <td>${r.hits}</td><td>${r.fails}</td><td>${r.avgOdd?r.avgOdd.toFixed(2):'—'}</td>
      <td style="font-weight:700;${r.profit>=0?'color:#10b981':'color:#ef4444'}">${r.profit.toFixed(2)}</td>
      <td style="${r.roi>=0?'color:#10b981':'color:#ef4444'}">${r.roi.toFixed(1)}%</td>
    </tr>`;
  const csvRows = [
    ['Tipo','Equipo','Rol','#','Fecha','Match','Result FT','Odd O2.5','Hit','PnL'],
    ...homeRes.details.map(d=>['Detalle',homeRes.team,'Home',d.idx,d.date,d.match,d.result_ft,d.odd_o25,d.hit,d.pnl]),
    ...awayRes.details.map(d=>['Detalle',awayRes.team,'Away',d.idx,d.date,d.match,d.result_ft,d.odd_o25,d.hit,d.pnl]),
    [],
    ['Resumen','Equipo','Rol','Jugados','Considerados','Hits','Fails','Odd media','Profit','ROI%'],
    ['Resumen',homeRes.team,'Home',homeRes.played,homeRes.considered,homeRes.hits,homeRes.fails,homeRes.avgOdd.toFixed(2),homeRes.profit.toFixed(2),homeRes.roi.toFixed(1)],
    ['Resumen',awayRes.team,'Away',awayRes.played,awayRes.considered,awayRes.hits,awayRes.fails,awayRes.avgOdd.toFixed(2),awayRes.profit.toFixed(2),awayRes.roi.toFixed(1)]
  ];
  const csv = csvRows.map(r=>r.map(v=>{ const s=(v===null||v===undefined)?'':String(v); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }).join(',')).join('\n');

  const panel = `
    <div class="panel" id="profitPanel">
      <h3>Rentabilidad O2.5 (últimos 10 por rol · stake 1u)</h3>
      <table class="clean">
        <tr><th>Equipo</th><th>Rol</th><th>Jugados</th><th>Considerados</th><th>Hits</th><th>Fails</th><th>Odd media</th><th>Profit (u)</th><th>ROI</th></tr>
        ${row(homeRes)}${row(awayRes)}
      </table>
      <button id="downloadCsvBtn" style="margin-top:10px">Descargar CSV (Excel)</button>
      <div class="muted" style="margin-top:6px;font-size:.9rem">“Considerados” excluye partidos sin cuota O2.5 válida.</div>
    </div>`;
  setTimeout(()=>{
    const btn=document.getElementById('downloadCsvBtn');
    if(btn){
      btn.onclick=()=>{
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`rentabilidad_o25_${homeRes.team}_home_${awayRes.team}_away.csv`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };
    }
  },0);
  return panel;
}

/* ===== Vista previa selección ===== */
function updateSelectionPreview(){
  const league=document.getElementById("leagueSelect").value||"";
  const home=document.getElementById("homeSelect").value||"";
  const away=document.getElementById("awaySelect").value||"";
  const pv=document.getElementById("selectionPreview");
  document.getElementById("pvLeague").textContent=league||"—";
  document.getElementById("pvHome").textContent=home||"—";
  document.getElementById("pvAway").textContent=away||"—";
  pv.style.display=(league&&home&&away&&home!==away)?"flex":"none";
}

/* ===== Analizar (flujo principal) ===== */
document.getElementById("fileInput").addEventListener("change",(e)=>{
  const file=e.target.files[0]; if(!file){ setStatus('No se seleccionó archivo.',false,true); return; }
  const rd=new FileReader();
  rd.onload=ev=>{
    try{
      rawMatches=tryParseJSON(ev.target.result);
      if(!Array.isArray(rawMatches)||rawMatches.length===0){ setStatus('No se pudo leer JSON o está vacío.',false,true); return; }
      allMatches=rawMatches.map((m,idx)=>normalizeRow(m,idx)).filter(r=>r.home && r.away);
      if(allMatches.length===0){ setStatus('No se encontraron partidos válidos tras normalizar.',false,true); return; }
      const leagues=[...new Set(allMatches.map(m=>m.league).filter(Boolean))].sort();
      const leagueSel=document.getElementById("leagueSelect");
      leagueSel.innerHTML="<option value=''>--Selecciona--</option>"+leagues.map(l=>`<option>${l}</option>`).join("");
      setStatus(`Cargados ${allMatches.length} partidos · ${leagues.length} ligas`,true,false);
      updateSelectionPreview();
    }catch(err){ console.error(err); setStatus('Error al procesar el archivo. Revisa la consola.',false,true); }
  };
  rd.readAsText(file);
});

document.getElementById("leagueSelect").addEventListener("change",function(){
  const league=this.value;
  const leagueMatches=allMatches.filter(m=>m.league===league);
  const teams=[...new Set(leagueMatches.flatMap(m=>[m.home,m.away]))].sort();
  document.getElementById("homeSelect").innerHTML=teams.map(t=>`<option>${t}</option>`).join("");
  document.getElementById("awaySelect").innerHTML=teams.map(t=>`<option>${t}</option>`).join("");
  setStatus(league?`Liga: ${league} · ${leagueMatches.length} partidos`:'');
  setTimeout(updateSelectionPreview,0);
});
document.getElementById("tabs").addEventListener("click",(e)=>{
  const t=e.target.closest(".tab"); if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active"); currentPeriod=t.dataset.period;
});

document.getElementById("analyzeBtn").addEventListener("click",()=>{
  try{
    updateSelectionPreview();
    const league=document.getElementById("leagueSelect").value;
    const homeTeam=document.getElementById("homeSelect").value;
    const awayTeam=document.getElementById("awaySelect").value;

    if(!allMatches.length){ setStatus('Primero carga un archivo JSON.',false,true); return; }
    if(!league){ setStatus('Selecciona liga.',false,true); return; }
    if(!homeTeam || !awayTeam || homeTeam===awayTeam){ setStatus('Selecciona equipos válidos (distintos).',false,true); return; }

    const oddOver=parseFloat(document.getElementById("oddOver").value);
    const oddUnder=parseFloat(document.getElementById("oddUnder").value);

    const leagueMatches=allMatches.filter(m=>m.league===league);
    if(leagueMatches.length===0){ setStatus('La liga seleccionada no tiene partidos válidos.',false,true); return; }

    const homeLast=lastMatchesByRole(leagueMatches, homeTeam, "home");
    const awayLast=lastMatchesByRole(leagueMatches, awayTeam, "away");

    setStatus(`OK · ${homeTeam} (home): ${homeLast.length} partidos · ${awayTeam} (away): ${awayLast.length} partidos.`,true,false);

    const homeStats=calcTeamBlock(leagueMatches,homeTeam,"home");
    const awayStats=calcTeamBlock(leagueMatches,awayTeam,"away");

    const summary3  = renderSummaryClean(homeLast, awayLast, 3, leagueMatches);
    const summary5  = renderSummaryClean(homeLast, awayLast, 5, leagueMatches);
    const summary10 = renderSummaryClean(homeLast, awayLast,10, leagueMatches);
    const poissonSummary = renderPoissonSummaryTable(homeTeam,awayTeam,homeLast,awayLast);
    const preds = renderPredictions(homeTeam,awayTeam,homeLast,awayLast);

    const hAvg=teamAverages(homeLast,homeTeam);
    const aAvg=teamAverages(awayLast,awayTeam);
    const lambdaH=Math.max(0,parseFloat(hAvg.avgScored)||0);
    const lambdaA=Math.max(0,parseFloat(aAvg.avgScored)||0);

    const textExplain=renderTextExplanation({
      homeLast, awayLast, oddOver, oddUnder, lambdaH, lambdaA
    });

    const matchOver25=Math.round((percentOver(homeLast,2.5)+percentOver(awayLast,2.5))/2);
    const valueOver=valueBox(matchOver25,oddOver);
    const valueUnder=valueBox(100-matchOver25,oddUnder);

    const pnlPanel=renderProfitabilityPanel(leagueMatches,homeTeam,awayTeam);

    const res=document.getElementById("results");
    res.innerHTML = `
      <div class="kv"><span class="muted">Periodo activo</span><span class="badge b-soft">${currentPeriod}</span></div>
      <div class="divider"></div>

      <div class="grid">
        ${renderTeamPanel(homeTeam,homeStats)}
        ${renderTeamPanel(awayTeam,awayStats)}
      </div>

      <div class="grid" style="margin-top:12px">
        ${summary3}
        ${summary5}
      </div>

      <div class="grid" style="margin-top:12px">
        ${summary10}
        ${poissonSummary}
      </div>

      <div style="margin-top:12px">
        ${preds}
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>Value Check</h3>
        <div class="grid">
          <div class="panel"><h3>Over 2.5</h3>${valueOver||'<div class="muted">Ingresa Odd Over 2.5</div>'}</div>
          <div class="panel"><h3>Under 2.5</h3>${valueUnder||'<div class="muted">Ingresa Odd Under 2.5</div>'}</div>
        </div>
      </div>

      ${pnlPanel}
      ${textExplain ? `<div style="margin-top:12px">${textExplain}</div>` : ``}
    `;

    if(matchOver25>=70) res.style.borderColor="var(--green)";
    else if(matchOver25>=50) res.style.borderColor="var(--amber)";
    else res.style.borderColor="var(--red)";
  }catch(err){
    console.error(err);
    setStatus('Ocurrió un error al analizar. Revisa la consola.',false,true);
  }
});

/* Eventos de cambio para la vista previa */
["leagueSelect","homeSelect","awaySelect"].forEach(id=>{
  document.getElementById(id).addEventListener("change",updateSelectionPreview);
});
</script>
</body>
</html>
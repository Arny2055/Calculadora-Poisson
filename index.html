<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Backtesting JSON Archivos Grandes</title>
<style>
  body{font-family:sans-serif;background:#0f1724;color:#eee;padding:20px}
  .card{background:#1e293b;padding:14px;border-radius:8px;margin-bottom:16px}
  .btn{padding:6px 12px;background:#06b6d4;border:none;border-radius:6px;font-weight:600;cursor:pointer}
  progress{width:100%;margin-top:8px}
</style>
</head>
<body>

<h1>Backtesting JSON (Archivos grandes)</h1>

<div class="card">
  <input id="fileInput" type="file" accept=".json" />
  <progress id="progress" value="0" max="100" style="display:none"></progress>
</div>

<div id="results" style="display:none">
  <div class="card">
    <h3>Resumen</h3>
    <pre id="summary"></pre>
  </div>
</div>

<script>
// ==== Worker en línea (para parsear y calcular en segundo plano) ====
const workerCode = `
self.onmessage = function(e){
  try{
    const records = JSON.parse(e.data.jsonText);
    const stake = 1;
    let total=0, profit=0, ganado=0, perdido=0;
    for(const r of records){
      let odd = Number(r[" Odd "]||r["Odd"]||0);
      let res = (r[" Result "]||r["Result"]||"").toLowerCase();
      let p=0;
      if(res.includes("win")) p=(odd-1)*stake;
      else if(res.includes("lose")) p=-stake;
      profit+=p;
      if(p>0) ganado+=p; else if(p<0) perdido+=Math.abs(p);
      total++;
    }
    const roi = total? (profit/total*100):0;
    self.postMessage({ok:true,metrics:{total,profit,ganado,perdido,roi}});
  }catch(err){
    self.postMessage({ok:false,error:err.message});
  }
};`;
const blob = new Blob([workerCode], { type: "application/javascript" });
const worker = new Worker(URL.createObjectURL(blob));

worker.onmessage = e=>{
  q("progress").style.display="none";
  if(!e.data.ok){ alert("Error: "+e.data.error); return; }
  const m = e.data.metrics;
  q("summary").textContent = 
    "Apuestas: "+m.total+
    "\\n✅ Ganado: "+m.ganado.toFixed(2)+
    "\\n❌ Perdido: "+m.perdido.toFixed(2)+
    "\\nProfit neto: "+m.profit.toFixed(2)+
    "\\nROI: "+m.roi.toFixed(2)+"%";
  q("results").style.display="";
};

function q(id){return document.getElementById(id);}

q("fileInput").addEventListener("change",e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onprogress = ev=>{
    if(ev.lengthComputable){
      q("progress").style.display="";
      q("progress").value = (ev.loaded/ev.total*100);
    }
  };
  reader.onload = ev=>{
    worker.postMessage({jsonText:ev.target.result});
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
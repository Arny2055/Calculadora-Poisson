<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QC Story ‚Äî Resoluci√≥n de Problemas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1e2230; --text:#e6eaf2; --muted:#a7b0c0;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;
    --focus: #b9ccff;
  }
  *{box-sizing:border-box}
  html,body{margin:0; height:100%; background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(8px); background:linear-gradient(180deg, rgba(15,17,21,.9), rgba(15,17,21,.6)); border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px; margin:0 auto; padding:16px}
  h1{margin:6px 0 2px; font-size:24px}
  .sub{color:var(--muted); font-size:13px}
  .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
  button,.btn{
    background:var(--panel2); color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600;
  }
  button:hover{border-color:var(--accent)}
  .btn-accent{background:var(--accent); color:#0a0c12; border-color:transparent}
  .btn-ok{background:var(--ok); color:#0a0c12; border-color:transparent}
  .btn-warn{background:var(--warn); color:#0a0c12; border-color:transparent}
  .btn-danger{background:var(--danger); color:#0a0c12; border-color:transparent}
  .layout{display:grid; grid-template-columns:260px 1fr; gap:16px; padding:16px}
  nav{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:8px; height:fit-content; position:sticky; top:90px}
  .step{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:var(--muted); cursor:pointer}
  .step.active{background:var(--panel2); color:var(--text); border:1px solid var(--border)}
  .step .num{width:26px; height:26px; display:grid; place-items:center; border-radius:8px; background:#101521; color:var(--accent); font-weight:800; border:1px solid var(--border)}
  main{display:grid; gap:16px}
  section.card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px}
  h2{margin:0 0 10px; font-size:18px}
  .grid{display:grid; gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .grid.three{grid-template-columns:repeat(3,1fr)}
  label{font-size:12px; color:var(--muted)}
  input, select, textarea{
    width:100%; padding:10px 12px; background:#0c0f18; color:var(--text); border:1px solid var(--border); border-radius:10px; outline:none;
  }
  textarea{min-height:110px; resize:vertical}
  input:focus, select:focus, textarea:focus{border-color:var(--focus); box-shadow:0 0 0 3px #b9ccff22}
  table{width:100%; border-collapse:collapse; border:1px solid var(--border)}
  th,td{border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; font-size:14px}
  th{color:var(--muted); background:#131824}
  .row-actions{display:flex; gap:6px}
  .pill{display:inline-block; padding:.25rem .5rem; border-radius:999px; background:#101521; border:1px solid var(--border); color:var(--muted); font-size:12px}
  .hint{color:var(--muted); font-size:12px}
  .right{display:flex; justify-content:flex-end; gap:8px}
  .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  .kpi .box{background:#0c0f18; border:1px solid var(--border); border-radius:10px; padding:10px}
  .kpi .box b{font-size:18px}
  footer{color:var(--muted); font-size:12px; padding:10px 16px 30px}
  .badge{font-weight:800; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border)}
  .ok{background: #102017; color:#b7ffcc}
  .warn{background:#261c09; color:#ffddaa}
  .danger{background:#281214; color:#ffbdbd}
  @media (max-width:980px){
    .layout{grid-template-columns:1fr}
    nav{position:static}
    .grid.two,.grid.three{grid-template-columns:1fr}
    .kpi{grid-template-columns:1fr 1fr}
  }
  @media print{
    header, nav, .toolbar, .right, #importJSON{display:none !important}
    body {background:#fff; color:#000}
    section.card{break-inside:avoid}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>QC Story ‚Äî Resoluci√≥n de Problemas</h1>
    <div class="sub">Flujo de 7 pasos (Identificar ‚Üí Observar ‚Üí Causas ‚Üí Plan ‚Üí Implementar ‚Üí Verificar ‚Üí Estandarizar)</div>
    <div class="toolbar">
      <button id="save" class="btn-accent">üíæ Guardar</button>
      <button id="load">üì• Cargar</button>
      <button id="exportJSON">‚¨áÔ∏è Exportar JSON</button>
      <label class="btn" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
        üì§ Importar JSON
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </label>
      <button id="print" class="btn-warn">üñ®Ô∏è Imprimir / PDF</button>
      <button id="newCase" class="btn-danger">üßπ Nuevo caso</button>
    </div>
  </div>
</header>

<div class="layout wrap">
  <nav id="steps"></nav>

  <main id="content">
    <!-- Step 1 -->
    <section class="card" data-step="1">
      <h2>1) Identificaci√≥n del problema</h2>
      <div class="grid two">
        <div>
          <label>T√≠tulo del caso</label>
          <input id="caseTitle" placeholder="Ej: Alto % de retrabajo en l√≠nea A">
        </div>
        <div>
          <label>√Årea / Proceso</label>
          <input id="area" placeholder="Ej: Ensamble / L√≠nea A">
        </div>
        <div>
          <label>Due√±o del caso</label>
          <input id="owner" placeholder="Responsable principal">
        </div>
        <div class="grid two">
          <div>
            <label>Fecha de inicio</label>
            <input id="startDate" type="date">
          </div>
          <div>
            <label>Fecha objetivo de cierre</label>
            <input id="targetDate" type="date">
          </div>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Declaraci√≥n del problema</label>
        <textarea id="problemStatement" placeholder="Describe el qu√©/cu√°nto/cu√°ndo/d√≥nde/impacto econ√≥mico‚Ä¶"></textarea>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div>
          <label>Meta (KPI/valor objetivo)</label>
          <input id="goal" placeholder="Ej: Reducir retrabajo de 8% a ‚â§ 3%">
        </div>
        <div>
          <label>Impacto esperado</label>
          <input id="impact" placeholder="Ej: Ahorro mensual estimado $150,000">
        </div>
      </div>
    </section>

    <!-- Step 2 -->
    <section class="card" data-step="2">
      <h2>2) Observaci√≥n y an√°lisis de la situaci√≥n</h2>
      <div class="grid two">
        <div>
          <label>Descripci√≥n con datos (antes de acciones)</label>
          <textarea id="baselineDesc" placeholder="Frecuencia, tendencia, turnos, lotes, localizaci√≥n, clientes afectados‚Ä¶"></textarea>
        </div>
        <div class="kpi">
          <div class="box"><label>Valor base (antes)</label><b><input id="baselineVal" type="number" step="any" placeholder="Ej: 8"></b><div class="hint">Usa misma unidad que el KPI</div></div>
          <div class="box"><label>Unidad</label><input id="unit" placeholder="% / ppm / horas / piezas"></div>
          <div class="box"><label>Umbral cr√≠tico (opcional)</label><input id="threshold" type="number" step="any" placeholder="Ej: 5"></div>
          <div class="box"><label>Periodo base</label><input id="baselinePeriod" placeholder="Ej: julio 2025"></div>
        </div>
      </div>

      <h3 style="margin-top:10px">Datos por causa (para Pareto)</h3>
      <div class="hint">Ingresa causas y su conteo para generar el Pareto.</div>
      <div class="right" style="margin-top:8px">
        <button id="addPareto">‚ûï Agregar causa</button>
        <button id="clearPareto">üßπ Limpiar</button>
      </div>
      <table id="paretoTable" style="margin-top:8px">
        <thead><tr><th>Causa</th><th>Conteo</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
      <canvas id="paretoChart" style="margin-top:12px; max-height:320px"></canvas>
    </section>

    <!-- Step 3 -->
    <section class="card" data-step="3">
      <h2>3) An√°lisis de causas ‚Äî Ishikawa + 5 Porqu√©s</h2>

      <h3>Ishikawa (6M)</h3>
      <div class="grid three">
        <div><label>M√©todo</label><textarea id="ish_metodo" placeholder="Procedimientos, instrucciones, secuencias‚Ä¶"></textarea></div>
        <div><label>Mano de obra</label><textarea id="ish_mano" placeholder="Habilidades, capacitaci√≥n, carga, errores‚Ä¶"></textarea></div>
        <div><label>M√°quina</label><textarea id="ish_maquina" placeholder="Fallas, mantenimiento, configuraci√≥n‚Ä¶"></textarea></div>
        <div><label>Material</label><textarea id="ish_material" placeholder="Especificaci√≥n, lote, proveedor‚Ä¶"></textarea></div>
        <div><label>Medici√≥n</label><textarea id="ish_medicion" placeholder="Instrumentos, m√©todos de inspecci√≥n‚Ä¶"></textarea></div>
        <div><label>Medio ambiente</label><textarea id="ish_medio" placeholder="Temperatura, humedad, vibraci√≥n‚Ä¶"></textarea></div>
      </div>

      <h3 style="margin-top:12px">5 Porqu√©s</h3>
      <div class="grid two">
        <div>
          <label>S√≠ntoma/defecto observado</label>
          <input id="why_symptom" placeholder="Ej: Retrabajo alto en estaci√≥n de soldadura">
        </div>
        <div class="right">
          <button id="addWhy">‚ûï Agregar fila</button>
          <button id="clearWhy">üßπ Limpiar</button>
        </div>
      </div>
      <table id="whyTable" style="margin-top:8px">
        <thead><tr><th>#</th><th>Respuesta</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint">Consejo: no te detengas exactamente en 5; usa los que necesites hasta llegar a una causa ra√≠z verificable.</div>
    </section>

    <!-- Step 4 -->
    <section class="card" data-step="4">
      <h2>4) Plan de acci√≥n (contramedidas)</h2>
      <div class="right">
        <button id="addAction">‚ûï Agregar acci√≥n</button>
        <button id="clearAction">üßπ Limpiar</button>
      </div>
      <table id="actionTable" style="margin-top:8px">
        <thead>
          <tr>
            <th>Acci√≥n</th><th>Responsable</th><th>Fecha compromiso</th><th>Estatus</th><th>Resultado esperado</th><th>Acc.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Step 5 -->
    <section class="card" data-step="5">
      <h2>5) Implementaci√≥n</h2>
      <label>Notas de implementaci√≥n (evidencias, lotes, fechas, fotos*)</label>
      <textarea id="implNotes" placeholder="Describe qu√© se hizo, d√≥nde, cu√°ndo y c√≥mo. *Para fotos/evidencias, p√©galas como texto o usa un enlace por ahora."></textarea>
    </section>

    <!-- Step 6 -->
    <section class="card" data-step="6">
      <h2>6) Verificaci√≥n de resultados</h2>
      <div class="grid two">
        <div class="kpi">
          <div class="box"><label>Valor despu√©s</label><b><input id="afterVal" type="number" step="any" placeholder="Ej: 2.9"></b></div>
          <div class="box"><label>Periodo despu√©s</label><input id="afterPeriod" placeholder="Ej: agosto 2025"></div>
          <div class="box"><label>Meta</label><input id="goalCopy" placeholder="Se copia de la meta si la definiste arriba"></div>
          <div class="box"><label>Resultado</label><div><span id="resultBadge" class="badge">‚Äî</span></div></div>
        </div>
        <div>
          <label>Conclusi√≥n de verificaci√≥n</label>
          <textarea id="verifyNotes" placeholder="¬øSe alcanz√≥ la meta? ¬øCu√°nto mejor√≥? ¬øQu√© evidencia hay?"></textarea>
        </div>
      </div>
      <canvas id="beforeAfterChart" style="margin-top:12px; max-height:280px"></canvas>
    </section>

    <!-- Step 7 -->
    <section class="card" data-step="7">
      <h2>7) Estandarizaci√≥n y prevenci√≥n</h2>
      <div class="grid two">
        <div>
          <label>Estandarizaci√≥n aplicada</label>
          <textarea id="stdNotes" placeholder="Cambios a instrucciones, AMEF, poka-yoke, control de proceso, capacitaci√≥n, auditor√≠as‚Ä¶"></textarea>
        </div>
        <div>
          <label>Lecciones aprendidas</label>
          <textarea id="learnNotes" placeholder="Qu√© funcion√≥/qu√© no, riesgos residuales, siguientes pasos‚Ä¶"></textarea>
        </div>
      </div>
      <div class="right" style="margin-top:10px">
        <button id="genResumen" class="btn-ok">üìù Generar resumen (Markdown)</button>
      </div>
      <textarea id="resumenMD" placeholder="Aqu√≠ ver√°s el resumen listo para pegar en un ticket/wikipage" style="margin-top:10px; min-height:180px"></textarea>
    </section>
  </main>
</div>

<footer class="wrap">
  <div>Consejo: usa <b>Exportar JSON</b> para respaldar casos y <b>Imprimir/PDF</b> para compartirlo formalmente. ‚Äî Hecho con ‚ù§Ô∏è para QC Story.</div>
</footer>

<script>
  // ---------- Utilidades ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const stateKey = 'qcStoryApp_v1';

  function getState(){
    const s = {
      caseTitle: $('#caseTitle').value,
      area: $('#area').value,
      owner: $('#owner').value,
      startDate: $('#startDate').value,
      targetDate: $('#targetDate').value,
      problemStatement: $('#problemStatement').value,
      goal: $('#goal').value,
      impact: $('#impact').value,
      baselineDesc: $('#baselineDesc').value,
      baselineVal: parseFloat($('#baselineVal').value || ''),
      unit: $('#unit').value,
      threshold: parseFloat($('#threshold').value || ''),
      baselinePeriod: $('#baselinePeriod').value,
      pareto: getParetoRows(),
      ishikawa: {
        metodo: $('#ish_metodo').value,
        mano: $('#ish_mano').value,
        maquina: $('#ish_maquina').value,
        material: $('#ish_material').value,
        medicion: $('#ish_medicion').value,
        medio: $('#ish_medio').value,
      },
      why: getWhyRows(),
      actions: getActionRows(),
      implNotes: $('#implNotes').value,
      afterVal: parseFloat($('#afterVal').value || ''),
      afterPeriod: $('#afterPeriod').value,
      goalCopy: $('#goalCopy').value,
      verifyNotes: $('#verifyNotes').value,
      stdNotes: $('#stdNotes').value,
      learnNotes: $('#learnNotes').value,
      resumenMD: $('#resumenMD').value,
    };
    return s;
  }
  function setState(s){
    $('#caseTitle').value = s.caseTitle || '';
    $('#area').value = s.area || '';
    $('#owner').value = s.owner || '';
    $('#startDate').value = s.startDate || '';
    $('#targetDate').value = s.targetDate || '';
    $('#problemStatement').value = s.problemStatement || '';
    $('#goal').value = s.goal || '';
    $('#impact').value = s.impact || '';
    $('#baselineDesc').value = s.baselineDesc || '';
    $('#baselineVal').value = s.baselineVal ?? '';
    $('#unit').value = s.unit || '';
    $('#threshold').value = s.threshold ?? '';
    $('#baselinePeriod').value = s.baselinePeriod || '';
    setParetoRows(s.pareto || []);
    $('#ish_metodo').value = s.ishikawa?.metodo || '';
    $('#ish_mano').value = s.ishikawa?.mano || '';
    $('#ish_maquina').value = s.ishikawa?.maquina || '';
    $('#ish_material').value = s.ishikawa?.material || '';
    $('#ish_medicion').value = s.ishikawa?.medicion || '';
    $('#ish_medio').value = s.ishikawa?.medio || '';
    setWhyRows(s.why || []);
    setActionRows(s.actions || []);
    $('#implNotes').value = s.implNotes || '';
    $('#afterVal').value = s.afterVal ?? '';
    $('#afterPeriod').value = s.afterPeriod || '';
    $('#goalCopy').value = s.goalCopy || s.goal || '';
    $('#verifyNotes').value = s.verifyNotes || '';
    $('#stdNotes').value = s.stdNotes || '';
    $('#learnNotes').value = s.learnNotes || '';
    $('#resumenMD').value = s.resumenMD || '';
    updateAllCharts();
  }
  function saveLocal(){ localStorage.setItem(stateKey, JSON.stringify(getState())); toast('Guardado localmente'); }
  function loadLocal(){
    const raw = localStorage.getItem(stateKey);
    if(!raw){ toast('No hay guardado local'); return; }
    try{ setState(JSON.parse(raw)); toast('Cargado desde localStorage'); }catch(e){ alert('Error cargando: '+e.message); }
  }
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style, {position:'fixed', right:'16px', bottom:'16px', background:'#111725', color:'#e6eaf2',
      padding:'10px 12px', border:'1px solid var(--border)', borderRadius:'10px', zIndex:9999});
    document.body.appendChild(t); setTimeout(()=>t.remove(), 2400);
  }

  // ---------- Steps (sidebar) ----------
  const stepNames = [
    'Identificaci√≥n','Observaci√≥n','Causas','Plan','Implementaci√≥n','Verificaci√≥n','Estandarizaci√≥n'
  ];
  function renderSteps(){
    const nav = $('#steps'); nav.innerHTML = '';
    stepNames.forEach((n,i)=>{
      const a = document.createElement('div');
      a.className = 'step' + (i===0?' active':'');
      a.dataset.step = (i+1);
      a.innerHTML = `<span class="num">${i+1}</span><div>${i+1}) ${n}</div>`;
      a.onclick = ()=> scrollToStep(i+1);
      nav.appendChild(a);
    });
  }
  function scrollToStep(num){
    const el = document.querySelector(`section.card[data-step="${num}"]`);
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  }
  function highlightOnScroll(){
    const cards = $$('#content section.card');
    const observer = new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          $$('#steps .step').forEach(s=>s.classList.remove('active'));
          const st = e.target.getAttribute('data-step');
          const btn = $(`#steps .step[data-step="${st}"]`); if(btn) btn.classList.add('active');
        }
      });
    },{rootMargin:'-50% 0px -40% 0px', threshold:.01});
    cards.forEach(c=>observer.observe(c));
  }

  // ---------- PARETO ----------
  function getParetoRows(){
    return Array.from($('#paretoTable tbody').children).map(tr=>{
      const causa = tr.querySelector('input[name="causa"]').value.trim();
      const count = parseFloat(tr.querySelector('input[name="count"]').value || '0');
      return {causa, count: isNaN(count)?0:count};
    }).filter(r=>r.causa);
  }
  function setParetoRows(rows){
    const tb = $('#paretoTable tbody'); tb.innerHTML='';
    rows.forEach(r=>addParetoRow(r.causa, r.count));
    updateParetoChart();
  }
  function addParetoRow(causa='',count=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input name="causa" placeholder="Causa" value="${causa}"></td>
      <td><input name="count" type="number" step="any" placeholder="0" value="${count}"></td>
      <td class="row-actions"><button class="btn" onclick="this.closest('tr').remove(); updateParetoChart();">‚úñ</button></td>`;
    $('#paretoTable tbody').appendChild(tr);
    tr.querySelectorAll('input').forEach(i=> i.addEventListener('input', updateParetoChart));
  }
  $('#addPareto').onclick = ()=> addParetoRow();
  $('#clearPareto').onclick = ()=> { $('#paretoTable tbody').innerHTML=''; updateParetoChart(); };

  let paretoChart;
  function updateParetoChart(){
    const data = getParetoRows().sort((a,b)=>b.count-a.count);
    const labels = data.map(d=>d.causa);
    const counts = data.map(d=>d.count);
    const total = counts.reduce((a,b)=>a+b,0);
    const cumPerc = counts.map((_,i)=> (counts.slice(0,i+1).reduce((a,b)=>a+b,0) / (total||1) * 100));
    const ctx = $('#paretoChart').getContext('2d');
    if(paretoChart){ paretoChart.destroy(); }
    paretoChart = new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[
        { type:'bar', label:'Conteo', data:counts },
        { type:'line', label:'% Acumulado', data:cumPerc, yAxisID:'y1' }
      ]},
      options:{
        responsive:true,
        plugins:{ legend:{display:true}},
        scales:{
          y:{ beginAtZero:true, title:{display:true, text:'Conteo'} },
          y1:{ beginAtZero:true, position:'right', ticks:{callback:v=>v+'%'}, grid:{drawOnChartArea:false}, title:{display:true, text:'%'} }
        }
      }
    });
  }

  // ---------- 5 WHYS ----------
  function getWhyRows(){
    return Array.from($('#whyTable tbody').children).map((tr,i)=>({
      idx:i+1, text: tr.querySelector('input[name="why"]').value.trim()
    })).filter(r=>r.text);
  }
  function setWhyRows(rows){
    const tb = $('#whyTable tbody'); tb.innerHTML='';
    (rows.length?rows:[{idx:1,text:''}]).forEach(r=>addWhyRow(r.text));
  }
  function addWhyRow(text=''){
    const tr = document.createElement('tr');
    const idx = $('#whyTable tbody').children.length + 1;
    tr.innerHTML = `
      <td style="width:60px">${idx}</td>
      <td><input name="why" placeholder="Porque..." value="${text}"></td>
      <td class="row-actions">
        <button class="btn" onclick="moveRow(this,-1,'whyTable')">‚¨Ü</button>
        <button class="btn" onclick="moveRow(this,1,'whyTable')">‚¨á</button>
        <button class="btn" onclick="this.closest('tr').remove(); renumberWhy();">‚úñ</button>
      </td>`;
    $('#whyTable tbody').appendChild(tr);
  }
  function renumberWhy(){
    $$('#whyTable tbody tr').forEach((tr,i)=> tr.children[0].textContent = i+1);
  }
  function moveRow(btn, dir, tableId){
    const tr = btn.closest('tr'); const tb = $('#'+tableId+' tbody');
    const idx = [...tb.children].indexOf(tr);
    const target = idx + dir;
    if(target<0 || target>=tb.children.length) return;
    tb.insertBefore(tr, tb.children[target + (dir>0?1:0)]);
    if(tableId==='whyTable') renumberWhy();
  }
  $('#addWhy').onclick = ()=> addWhyRow();
  $('#clearWhy').onclick = ()=> { $('#whyTable tbody').innerHTML=''; addWhyRow(); };

  // ---------- PLAN DE ACCI√ìN ----------
  function getActionRows(){
    return Array.from($('#actionTable tbody').children).map(tr=>({
      accion: tr.querySelector('input[name="accion"]').value.trim(),
      resp: tr.querySelector('input[name="resp"]').value.trim(),
      fecha: tr.querySelector('input[name="fecha"]').value,
      status: tr.querySelector('select[name="status"]').value,
      esperado: tr.querySelector('input[name="esperado"]').value.trim(),
    })).filter(r=>r.accion || r.resp || r.fecha);
  }
  function setActionRows(rows){
    const tb = $('#actionTable tbody'); tb.innerHTML='';
    (rows.length?rows:[{accion:'',resp:'',fecha:'',status:'Pendiente',esperado:''}]).forEach(r=>addActionRow(r));
  }
  function addActionRow(r={accion:'',resp:'',fecha:'',status:'Pendiente',esperado:''}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input name="accion" placeholder="Describir acci√≥n" value="${r.accion}"></td>
      <td><input name="resp" placeholder="Responsable" value="${r.resp}"></td>
      <td><input name="fecha" type="date" value="${r.fecha}"></td>
      <td>
        <select name="status">
          <option ${r.status==='Pendiente'?'selected':''}>Pendiente</option>
          <option ${r.status==='En curso'?'selected':''}>En curso</option>
          <option ${r.status==='Hecha'?'selected':''}>Hecha</option>
          <option ${r.status==='Bloqueada'?'selected':''}>Bloqueada</option>
        </select>
      </td>
      <td><input name="esperado" placeholder="Resultado esperado" value="${r.esperado}"></td>
      <td class="row-actions">
        <button class="btn" onclick="moveRow(this,-1,'actionTable')">‚¨Ü</button>
        <button class="btn" onclick="moveRow(this,1,'actionTable')">‚¨á</button>
        <button class="btn" onclick="this.closest('tr').remove()">‚úñ</button>
      </td>`;
    $('#actionTable tbody').appendChild(tr);
  }
  $('#addAction').onclick = ()=> addActionRow();
  $('#clearAction').onclick = ()=> { $('#actionTable tbody').innerHTML=''; addActionRow(); };

  // ---------- VERIFICACI√ìN ----------
  let beforeAfterChart;
  function updateVerification(){
    const base = parseFloat($('#baselineVal').value||'');
    const after = parseFloat($('#afterVal').value||'');
    const unit = $('#unit').value || '';
    const goal = ($('#goalCopy').value || $('#goal').value || '').toString().trim();

    if(!isNaN(base) && !isNaN(after)){
      const delta = after - base;
      const perc = (after - base) / (Math.abs(base)>0? Math.abs(base):1) * 100;
      const badge = $('#resultBadge');
      badge.textContent = `${(perc).toFixed(1)}% vs. base (${base}${unit})`;
      badge.className = 'badge ' + (after<=base ? 'ok' : 'danger');
    }

    // Chart
    const ctx = $('#beforeAfterChart').getContext('2d');
    if(beforeAfterChart) beforeAfterChart.destroy();
    if(!isNaN(base) && !isNaN(after)){
      beforeAfterChart = new Chart(ctx,{
        type:'bar',
        data:{labels:['Antes','Despu√©s'], datasets:[{label:'KPI', data:[base,after]}]},
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
      });
    }
  }

  // ---------- RESUMEN MD ----------
  function buildMarkdown(){
    const s = getState();
    const unit = s.unit ? ` ${s.unit}` : '';
    const totalPareto = (s.pareto||[]).reduce((a,b)=>a+(b.count||0),0);
    const paretoTop = (s.pareto||[]).slice().sort((a,b)=>b.count-a.count).slice(0,3);
    const whyLines = (s.why||[]).map((w,i)=>`  ${i+1}. ${w.text}`).join('\n');
    const actions = (s.actions||[]).map(a=>`| ${a.accion} | ${a.resp} | ${a.fecha||'-'} | ${a.status} | ${a.esperado} |`).join('\n');
    const base = isFinite(s.baselineVal)? s.baselineVal : null;
    const aft = isFinite(s.afterVal)? s.afterVal : null;
    let deltaTxt = '';
    if(base!==null && aft!==null){
      const perc = ((aft-base)/(Math.abs(base)>0?Math.abs(base):1))*100;
      deltaTxt = `**Cambio**: ${perc.toFixed(1)}% vs. base (${base}${unit} ‚Üí ${aft}${unit}).`;
    }
    const md = `# QC Story ‚Äî ${s.caseTitle||'Sin t√≠tulo'}

**√Årea/Proceso:** ${s.area||'-'}  
**Due√±o:** ${s.owner||'-'}  
**Fechas:** inicio ${s.startDate||'-'} ‚Ä¢ objetivo ${s.targetDate||'-'}

## 1) Problema
${s.problemStatement||'-'}
**Meta:** ${s.goal||s.goalCopy||'-'}  
**Impacto esperado:** ${s.impact||'-'}

## 2) Observaci√≥n (antes)
${s.baselineDesc||'-'}
**Base:** ${isFinite(s.baselineVal)? s.baselineVal+unit : '-'} (${s.baselinePeriod||'-'})
${totalPareto? `\n**Pareto (Top 3 / ${totalPareto} total):**\n`+ paretoTop.map(p=>`- ${p.causa}: ${p.count}`).join('\n') : ''}

## 3) Causas
**Ishikawa:**  
- M√©todo: ${s.ishikawa?.metodo||'-'}  
- Mano de obra: ${s.ishikawa?.mano||'-'}  
- M√°quina: ${s.ishikawa?.maquina||'-'}  
- Material: ${s.ishikawa?.material||'-'}  
- Medici√≥n: ${s.ishikawa?.medicion||'-'}  
- Medio ambiente: ${s.ishikawa?.medio||'-'}  

**5 Porqu√©s (s√≠ntoma: ${s.why_symptom||$('#why_symptom').value||'-'}):**  
${whyLines || '-'}  

## 4) Plan de acci√≥n
| Acci√≥n | Responsable | Fecha | Estatus | Resultado esperado |
|---|---|---|---|---|
${actions || '| ‚Äî | ‚Äî | ‚Äî | ‚Äî | ‚Äî |'}

## 5) Implementaci√≥n
${s.implNotes||'-'}

## 6) Verificaci√≥n
${s.verifyNotes||'-'}
${deltaTxt}

**Despu√©s:** ${isFinite(s.afterVal)? s.afterVal+unit : '-'} (${s.afterPeriod||'-'})

## 7) Estandarizaci√≥n y prevenci√≥n
**Estandarizaci√≥n:** ${s.stdNotes||'-'}  
**Lecciones aprendidas:** ${s.learnNotes||'-'}
`;
    $('#resumenMD').value = md.trim();
    toast('Resumen generado');
  }

  // ---------- Eventos globales ----------
  function updateAllCharts(){ updateParetoChart(); updateVerification(); }
  ['baselineVal','afterVal','unit','goalCopy','goal'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', updateVerification);
  });

  // Toolbar
  $('#save').onclick = saveLocal;
  $('#load').onclick = loadLocal;
  $('#print').onclick = ()=> window.print();
  $('#exportJSON').onclick = ()=>{
    const blob = new Blob([JSON.stringify(getState(),null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = ( $('#caseTitle').value.trim() || 'qc_story' ) + '.json';
    a.click(); URL.revokeObjectURL(a.href);
  };
  $('#importJSON').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{ setState(JSON.parse(reader.result)); toast('Importado'); }catch(err){ alert('JSON inv√°lido: '+err.message); }
    };
    reader.readAsText(f);
  });
  $('#newCase').onclick = ()=>{
    if(confirm('¬øLimpiar todo para iniciar un nuevo caso?')){ localStorage.removeItem(stateKey); location.reload(); }
  };
  $('#genResumen').onclick = buildMarkdown;

  // Inicializaci√≥n
  renderSteps();
  highlightOnScroll();
  addParetoRow(); addWhyRow(); addActionRow();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Normal Bivariada — Auto desde JSON</title>
<style>
  body{margin:0;background:#0f1115;color:#e6eaf2;font:14px/1.4 system-ui,Inter,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid #2a3140}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:330px 1fr}}
  .card{background:#171a21;border:1px solid #2a3140;border-radius:10px;padding:14px}
  h1{font-size:18px;margin:0 0 4px} h2{font-size:15px;margin:0 0 10px}
  textarea,input,select,button{width:100%;background:#1f2430;color:#e6eaf2;border:1px solid #2a3140;border-radius:8px;padding:8px}
  .row{display:grid;grid-template-columns:1fr 110px;gap:8px;align-items:center;margin:8px 0}
  .pill{display:inline-block;border:1px solid #2a3140;background:#1f2430;border-radius:999px;padding:4px 8px;margin-right:6px}
  .kpis{display:grid;gap:8px;grid-template-columns:repeat(3,1fr)}
  .kpi{background:#1f2430;border:1px solid #2a3140;border-radius:10px;padding:10px;text-align:center}
  .kpi b{font-size:17px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #2a3140;padding:6px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .btn{background:#7aa2ff;color:#0c1020;font-weight:700;cursor:pointer}
  .muted{color:#9aa3b2;font-size:12px}
</style>
</head>
<body>
<header class="wrap"><h1>Calculadora — Normal Bivariada (auto desde JSON)</h1>
<div class="muted">Carga tu JSON de partidos → calcula μ, σ, ρ → pronósticos.</div></header>

<div class="wrap grid">
  <!-- Entrada -->
  <section class="card">
    <h2>Datos</h2>
    <label>JSON de partidos (formato simple)</label>
    <textarea id="json" rows="10">{
  "matches":[
    {"home":2,"away":1},{"home":1,"away":0},{"home":0,"away":2},
    {"home":3,"away":2},{"home":2,"away":1},{"home":1,"away":1}
  ]
}</textarea>

    <div class="row"><label>α EWMA (0=uniforme)</label><input id="alpha" type="number" step="0.01" min="0" max="0.99" value="0"></div>
    <div class="row"><label>Línea O/U</label><input id="ou" type="number" step="0.5" value="2.5"></div>
    <div class="row"><label>Simulaciones</label><input id="ns" type="number" step="1000" min="5000" value="50000"></div>
    <div class="row"><label>Discretización</label>
      <select id="disc"><option value="round">Redondear</option><option value="floor">Floor</option></select>
    </div>
    <button id="run" class="btn">Calcular</button>
    <p class="muted">Esquema aceptado: {"matches":[{"home":INT,"away":INT}, ...]}. Orden cronológico (viejo→reciente) para EWMA.</p>

    <h2 style="margin-top:14px">Parámetros estimados</h2>
    <div id="pars">
      <span class="pill">μ<sub>H</sub>: <b id="muH">—</b></span>
      <span class="pill">μ<sub>A</sub>: <b id="muA">—</b></span>
      <span class="pill">σ<sub>H</sub>: <b id="sdH">—</b></span>
      <span class="pill">σ<sub>A</sub>: <b id="sdA">—</b></span>
      <span class="pill">ρ: <b id="rho">—</b></span>
      <span class="pill">σ<sub>T</sub> (anal.): <b id="sdT">—</b></span>
    </div>
  </section>

  <!-- Resultados -->
  <section class="card">
    <h2>Resultados</h2>
    <div class="kpis">
      <div class="kpi">1 (Local)<br><b id="pH">—</b></div>
      <div class="kpi">X (Empate)<br><b id="pD">—</b></div>
      <div class="kpi">2 (Visitante)<br><b id="pA">—</b></div>
    </div>

    <div class="kpis" style="margin-top:8px">
      <div class="kpi">Over<br><b id="pOver">—</b></div>
      <div class="kpi">Under<br><b id="pUnder">—</b></div>
      <div class="kpi">BTTS<br><b id="pBTTS">—</b></div>
    </div>

    <div style="margin-top:8px">
      <span class="pill">E[goles H] MC: <b id="eH">—</b></span>
      <span class="pill">E[goles A] MC: <b id="eA">—</b></span>
      <span class="pill">E[total] MC: <b id="eT">—</b></span>
      <span class="pill">O/U (MC / anal.): <b id="pOUmix">—</b></span>
    </div>

    <h3 style="margin-top:12px;font-size:14px">Top 8 marcadores (MC)</h3>
    <table><thead><tr><th>Marcador</th><th>Prob.</th><th>Cuota</th></tr></thead>
      <tbody id="scores"><tr><td colspan="3" class="muted">—</td></tr></tbody></table>
  </section>
</div>

<script>
const el = id => document.getElementById(id);
const pct = p => (p*100).toFixed(2)+'%';
const odds = p => p>0 ? (1/p).toFixed(2) : '—';

function parseMatches(jsonStr){
  const obj = JSON.parse(jsonStr);
  if(!obj.matches || !Array.isArray(obj.matches)) throw new Error('JSON debe tener "matches":[{home,away},...]');
  const H=[], A=[];
  for(const m of obj.matches){ H.push(+m.home||0); A.push(+m.away||0); }
  return {H,A};
}

function mean(a,w=null){
  if(!a.length) return 0;
  if(!w){ return a.reduce((s,x)=>s+x,0)/a.length; }
  const sw = w.reduce((s,x)=>s+x,0);
  let n=0; for(let i=0;i<a.length;i++) n+=a[i]*w[i];
  return n/(sw||1);
}
function variance(a,mu,w=null){
  if(!a.length) return 0;
  if(!w){
    let s=0; for(const x of a) s+=(x-mu)*(x-mu);
    return s/Math.max(1,a.length-1);
  }else{
    const sw=w.reduce((s,x)=>s+x,0);
    const sw2=w.reduce((s,x)=>s+x*x,0);
    let s=0; for(let i=0;i<a.length;i++) s+=w[i]*(a[i]-mu)*(a[i]-mu);
    // var ponderada insesgada aproximada
    const c = sw - (sw2/sw);
    return s/Math.max(1e-9,c);
  }
}
function covariance(x,y,mx,my,w=null){
  const n=x.length; if(n===0) return 0;
  if(!w){
    let s=0; for(let i=0;i<n;i++) s+=(x[i]-mx)*(y[i]-my);
    return s/Math.max(1,n-1);
  }else{
    const sw=w.reduce((s,a)=>s+a,0), sw2=w.reduce((s,a)=>s+a*a,0);
    let s=0; for(let i=0;i<n;i++) s+=w[i]*(x[i]-mx)*(y[i]-my);
    const c = sw - (sw2/sw);
    return s/Math.max(1e-9,c);
  }
}

// EWMA pesos: datos en orden viejo→reciente
function ewmaWeights(n, alpha){
  if(alpha<=0) return null;
  const w=[]; for(let i=0;i<n;i++) w.push(Math.pow(1-alpha,i));
  // reordenamos para que el más reciente tenga peso 1
  w.reverse(); // viejo..reciente -> pesos pequeños..grandes
  return w;
}

// Box–Muller
function randn(){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}

function simulate(muH,muA,sdH,sdA,rho,n,disc,line){
  const s=Math.sqrt(1-Math.min(0.999,Math.max(-0.999,rho))**2);
  let wH=0,d=0,wA=0,over=0,btts=0,SH=0,SA=0,ST=0;
  const map=new Map();
  for(let i=0;i<n;i++){
    const z1=randn(), z2=randn();
    const x=muH+sdH*z1, y=muA+sdA*(rho*z1+s*z2);
    let H=x, A=y;
    if(disc==='round'){H=Math.max(0,Math.round(H));A=Math.max(0,Math.round(A));}
    else {H=Math.max(0,Math.floor(H));A=Math.max(0,Math.floor(A));}
    if(H>A) wH++; else if(H===A) d++; else wA++;
    if(H+A>line) over++;
    if(H>0&&A>0) btts++;
    SH+=H; SA+=A; ST+=H+A;
    const k=H+':'+A; map.set(k,(map.get(k)||0)+1);
  }
  return {
    pH:wH/n,pD:d/n,pA:wA/n,
    pOverMC:over/n,pUnderMC:1-over/n,pBTTS:btts/n,
    eH:SH/n,eA:SA/n,eT:ST/n, scores:map
  };
}

// O/U analítico para T=X+Y normal
function overAnalytic(muH,muA,sdH,sdA,rho,line){
  const muT=muH+muA, varT=sdH*sdH+sdA*sdA+2*rho*sdH*sdA, sdT=Math.sqrt(Math.max(varT,1e-12));
  const z=(line-muT)/sdT; const Phi=0.5*(1+erf(z/Math.SQRT2));
  return {pUnder:Phi,pOver:1-Phi,sdT};
}
function erf(x){const s=Math.sign(x);x=Math.abs(x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  const t=1/(1+p*x); const y=1-((((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t)*Math.exp(-x*x); return s*y;}

// Render tabla
function renderScores(map,n,tb){
  const arr=[]; map.forEach((c,k)=>arr.push({k,p:c/n}));
  arr.sort((a,b)=>b.p-a.p);
  tb.innerHTML = (arr.slice(0,8).map(r=>`<tr><td>${r.k}</td><td>${pct(r.p)}</td><td>${odds(r.p)}</td></tr>`).join('')) || `<tr><td colspan="3" class="muted">—</td></tr>`;
}

el('run').onclick=()=>{
  try{
    const {H,A}=parseMatches(el('json').value);
    if(H.length!==A.length||H.length<3) throw new Error('Se requieren ≥3 partidos y longitudes iguales.');
    const alpha=parseFloat(el('alpha').value)||0;
    const w = alpha>0 ? ewmaWeights(H.length,alpha) : null;

    const muH = mean(H,w), muA = mean(A,w);
    const sdH = Math.sqrt(variance(H,muH,w)), sdA = Math.sqrt(variance(A,muA,w));
    const cov = covariance(H,A,muH,muA,w);
    const rho = (sdH>0 && sdA>0) ? Math.max(-0.999, Math.min(0.999, cov/(sdH*sdA))) : 0;

    const line = parseFloat(el('ou').value);
    const ns = Math.max(5000, Math.floor(+el('ns').value));
    const disc = el('disc').value;

    const ana = overAnalytic(muH,muA,sdH,sdA,rho,line);
    const mc  = simulate(muH,muA,sdH,sdA,rho,ns,disc,line);

    // parámetros
    el('muH').textContent=muH.toFixed(3);
    el('muA').textContent=muA.toFixed(3);
    el('sdH').textContent=sdH.toFixed(3);
    el('sdA').textContent=sdA.toFixed(3);
    el('rho').textContent=rho.toFixed(3);
    el('sdT').textContent=ana.sdT.toFixed(3);

    // resultados
    el('pH').textContent=pct(mc.pH);
    el('pD').textContent=pct(mc.pD);
    el('pA').textContent=pct(mc.pA);
    el('pOver').textContent=pct(mc.pOverMC);
    el('pUnder').textContent=pct(mc.pUnderMC);
    el('pBTTS').textContent=pct(mc.pBTTS);
    el('eH').textContent=mc.eH.toFixed(3);
    el('eA').textContent=mc.eA.toFixed(3);
    el('eT').textContent=mc.eT.toFixed(3);
    el('pOUmix').textContent=`${pct(mc.pOverMC)} / ${pct(ana.pOver)}`;

    renderScores(mc.scores, ns, document.getElementById('scores'));
  }catch(e){
    alert(e.message||e);
  }
};
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Poisson + Live Completa</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;margin:0;padding:0;background:#0e0e0e;color:#f0f0f0;}
    .container{max-width:1200px;margin:auto;padding:30px;}
    .header{display:flex;align-items:center;justify-content:space-between;background:#1b1b1b;padding:15px 25px;border-radius:12px;margin-bottom:25px;box-shadow:0 0 25px rgba(0,255,20,0.4);}
    .header img{width:60px;filter:drop-shadow(0 0 6px #39FF14);}
    .header h2{margin:0;color:#39FF14;font-weight:600;letter-spacing:1.2px;}
    input,select,button{padding:8px;font-size:14px;background:#2c2c2c;color:#f0f0f0;border:1px solid #444;border-radius:6px;transition:0.3s;}
    input:focus,select:focus{border-color:#39FF14;outline:none;}
    button{background-color:#333;border:none;cursor:pointer;font-weight:600;}
    button:hover{background-color:#39FF14;color:#000;}
    .inputs{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:15px;}
    th,td{padding:8px;border:1px solid #333;text-align:center;}
    th{background:#1f1f1f;font-weight:600;}
    td{background:#151515;}
    tr.highlight td{background-color:rgba(57,255,20,0.15)!important;font-weight:600;}
    #notificacion{position:fixed;bottom:20px;right:20px;background:#39FF14;color:#000;padding:12px 20px;border-radius:8px;font-weight:600;opacity:0;transition:0.4s;pointer-events:none;}
    #notificacion.visible{opacity:1;}
    .live-section{margin-top:40px;padding:20px;background:#1b1b1b;border-radius:12px;box-shadow:0 0 20px rgba(0,255,20,0.2);}
    .live-section h3{color:#39FF14;margin-top:0;margin-bottom:15px;}
    .small-input{width:60px;text-align:center;}
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <div style="display:flex; align-items:center; gap:15px;">
      <img src="https://cdn-icons-png.flaticon.com/512/287/287221.png" alt="Logo" />
      <h2>Calculadora Poisson + Live</h2>
    </div>
    <button onclick="window.location.href='historial.html'">ðŸ“œ Ver Historial</button>
  </div>

  <!-- CALCULADORA PREPARTIDO -->
  <div class="inputs">
    <input type="text" id="nombreLocal" placeholder="Equipo Local" style="flex:1;" />
    <input type="number" id="golesLocal" placeholder="Promedio Local" step="0.01" />
    <input type="text" id="nombreVisita" placeholder="Equipo Visitante" style="flex:1;" />
    <input type="number" id="golesVisita" placeholder="Promedio Visita" step="0.01" />
    <input type="number" id="bankroll" placeholder="Bankroll ($)" step="0.01" value="100" />
    <button onclick="calcular()">Calcular Prepartido</button>
  </div>

  <div id="resultado"></div>

  <!-- CALCULADORA LIVE -->
  <div class="live-section">
    <h3>âš¡ Calculadora Live Poisson</h3>
    <div class="inputs">
      <input type="number" id="liveGolesLocal" placeholder="Goles Local" min="0" />
      <input type="number" id="liveGolesVisita" placeholder="Goles Visita" min="0" />
      <input type="number" id="liveMinuto" placeholder="Minuto Actual" min="0" max="120" />
      <button onclick="calcularLive()">Calcular Live</button>
      <button onclick="agregarAlHistorialLive()">âž• Agregar Live al Historial</button>
    </div>
    <div id="resultadoLive"></div>
  </div>
</div>

<div id="notificacion"></div>

<script>
/* -------- FUNCIONES BASE -------- */
const factorial = n => n<=1 ? 1 : n*factorial(n-1);
const poisson = (k,lambda) => (Math.pow(lambda,k)*Math.exp(-lambda))/factorial(k);
const cuotaImplicita=p=>p>0?(1/p).toFixed(2):"-";
const valueBet=(p,cuota)=>((p*cuota)-1).toFixed(2);
const kelly=(p,cuota,f=1)=>Math.max(0,(((cuota-1)*p-(1-p))/(cuota-1))*f);

let cuotasGuardadas={}, exportData=[];

/* -------- NotificaciÃ³n -------- */
function mostrarNotificacion(msg){
  const n=document.getElementById("notificacion");
  n.textContent=msg;
  n.classList.add("visible");
  setTimeout(()=>n.classList.remove("visible"),2500);
}

/* ------------ CALCULADORA PREPARTIDO ------------ */
function calcular(){
  const nombreLocal=document.getElementById("nombreLocal").value.trim();
  const nombreVisita=document.getElementById("nombreVisita").value.trim();
  const lambdaL=parseFloat(document.getElementById("golesLocal").value);
  const lambdaV=parseFloat(document.getElementById("golesVisita").value);
  const bankroll=parseFloat(document.getElementById("bankroll").value);

  if(!nombreLocal||!nombreVisita||isNaN(lambdaL)||isNaN(lambdaV)||isNaN(bankroll)){
    return mostrarNotificacion("âš  Completa todos los campos correctamente");
  }

  const maxGoals=5;
  const pLocal=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaL));
  const pVisita=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaV));
  let winL=0,draw=0,winV=0,btts=0,bttsNo=0;
  const thresholds=[0.5,1.5,2.5,3.5], under={};
  thresholds.forEach(t=>under[t]=0);

  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const joint=pLocal[i]*pVisita[j];
      if(i>j) winL+=joint; else if(i===j) draw+=joint; else winV+=joint;
      if(i>0&&j>0) btts+=joint; else bttsNo+=joint;
      thresholds.forEach(th=>{ if(i+j<=th) under[th]+=joint; });
    }
  }
  const overs=thresholds.map(th=>1-under[th]);

  // tabla
  let html=`<table>
    <tr><th>Mercado</th><th>Prob %</th><th>Cuota ImplÃ­cita</th><th>Cuota Bookie</th><th>EV</th><th>Kelly 25%</th><th>Apostar $</th></tr>`;

  const filas=[
    ["1X2",[nombreLocal,"Empate",nombreVisita],[winL,draw,winV]],
    ["BTTS",["SÃ­","No"],[btts,bttsNo]],
    ["Over",thresholds.map(t=>`Over ${t}`),overs]
  ];

  exportData=[];
  filas.forEach(([grupo,labels,probs],gi)=>{
    labels.forEach((label,idx)=>{
      const p=probs[idx],id=`bookie_${gi}_${idx}`;
      const cuotaGuardada=cuotasGuardadas[id]||"";
      const evInput=`<input type="text" class="small-input" id="${id}" value="${cuotaGuardada}"
                oninput="cuotasGuardadas['${id}']=this.value.replace(',','.');" 
                onblur="calcular()" onkeydown="if(event.key==='Enter'){this.blur();}">`;
      const cuota=parseFloat(cuotasGuardadas[id]);
      const ev=!isNaN(cuota)?valueBet(p,cuota):"-";
      const k=!isNaN(cuota)?kelly(p,cuota,0.25):0;
      const apuesta=k>0?(bankroll*k).toFixed(2):"-";
      const highlight=(!isNaN(ev)&&ev>0)||(k>0)?"highlight":"";
      html+=`<tr class="${highlight}"><td>${grupo} ${label}</td><td>${(p*100).toFixed(2)}</td><td>${cuotaImplicita(p)}</td><td>${evInput}</td><td>${ev}</td><td>${(k*100).toFixed(1)}%</td><td>${apuesta}</td></tr>`;
      if(!isNaN(cuota)) exportData.push([grupo,label,(p*100).toFixed(2),cuota,ev,(k*100).toFixed(1)+"%",apuesta,nombreLocal,nombreVisita]);
    });
  });

  html+="</table>";
  document.getElementById("resultado").innerHTML=html;
}

/* ------------ CALCULADORA LIVE ------------ */
function calcularLive(){
  const gL=parseInt(document.getElementById("liveGolesLocal").value)||0;
  const gV=parseInt(document.getElementById("liveGolesVisita").value)||0;
  const min=parseInt(document.getElementById("liveMinuto").value)||0;
  const lambdaL=parseFloat(document.getElementById("golesLocal").value);
  const lambdaV=parseFloat(document.getElementById("golesVisita").value);
  const bankroll=parseFloat(document.getElementById("bankroll").value);

  if(isNaN(lambdaL)||isNaN(lambdaV)||isNaN(bankroll)){
    return mostrarNotificacion("âš  Ingresa promedios y bankroll primero");
  }

  const tiempoRestante=Math.max(0,90-min)/90;
  const lambdaRestL=Math.max(0,(lambdaL-gL)*tiempoRestante);
  const lambdaRestV=Math.max(0,(lambdaV-gV)*tiempoRestante);

  const maxGoals=5;
  const pLocal=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaRestL));
  const pVisita=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaRestV));

  let probLocal=0, probDraw=0, probVisita=0, btts=0,bttsNo=0;
  let under={0.5:0,1.5:0,2.5:0,3.5:0};
  let golesEsperados=0;

  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const joint=pLocal[i]*pVisita[j];
      const totalL=gL+i, totalV=gV+j;
      if(totalL>totalV) probLocal+=joint;
      else if(totalL===totalV) probDraw+=joint;
      else probVisita+=joint;

      if(totalL>0 && totalV>0) btts+=joint; else bttsNo+=joint;
      Object.keys(under).forEach(th=>{ if(totalL+totalV<=parseFloat(th)) under[th]+=joint; });
      golesEsperados+=(i+j)*joint;
    }
  }

  const overs=[0.5,1.5,2.5,3.5].map(th=>1-under[th]);
  const nombreLocal=document.getElementById("nombreLocal").value;
  const nombreVisita=document.getElementById("nombreVisita").value;

  let html=`<table>
  <tr><th>Mercado</th><th>Prob %</th><th>Cuota ImplÃ­cita</th><th>Cuota Bookie</th><th>EV</th><th>Kelly 25%</th><th>Apostar $</th></tr>`;

  const filas=[
    ["1X2",[`${nombreLocal} Gana`,"Empate",`${nombreVisita} Gana`],[probLocal,probDraw,probVisita]],
    ["BTTS",["SÃ­","No"],[btts,bttsNo]],
    ["Over",["0.5","1.5","2.5","3.5"],overs]
  ];

  exportData=[];
  filas.forEach(([grupo,labels,probs],gi)=>{
    labels.forEach((label,idx)=>{
      const p=probs[idx],id=`live_${gi}_${idx}`;
      const cuotaGuardada=cuotasGuardadas[id]||"";
      const evInput=`<input type="text" class="small-input" id="${id}" value="${cuotaGuardada}"
                oninput="cuotasGuardadas['${id}']=this.value.replace(',','.');" 
                onblur="calcularLive()" onkeydown="if(event.key==='Enter'){this.blur();}">`;
      const cuota=parseFloat(cuotasGuardadas[id]);
      const ev=!isNaN(cuota)?valueBet(p,cuota):"-";
      const k=!isNaN(cuota)?kelly(p,cuota,0.25):0;
      const apuesta=k>0?(bankroll*k).toFixed(2):"-";
      const highlight=(!isNaN(ev)&&ev>0)||(k>0)?"highlight":"";
      html+=`<tr class="${highlight}"><td>${grupo} ${label}</td><td>${(p*100).toFixed(2)}</td><td>${cuotaImplicita(p)}</td><td>${evInput}</td><td>${ev}</td><td>${(k*100).toFixed(1)}%</td><td>${apuesta}</td></tr>`;
      if(!isNaN(cuota) && k>0) exportData.push([grupo,label,(p*100).toFixed(2),cuota,ev,(k*100).toFixed(1)+"%",apuesta,nombreLocal,nombreVisita]);
    });
  });

  html+=`<tr><td colspan="7">Goles Totales Esperados: ${(gL+gV+golesEsperados).toFixed(2)}</td></tr>`;
  html+="</table>";
  document.getElementById("resultadoLive").innerHTML=html;
}

/* ------------ HISTORIAL ------------ */
function agregarAlHistorialLive(){
  if(!exportData.length) return mostrarNotificacion("âš  No hay mercados con EV positivo para agregar.");
  const historial=JSON.parse(localStorage.getItem("poissonHistorial"))||[];
  exportData.forEach(r=>historial.push(r));
  localStorage.setItem("poissonHistorial",JSON.stringify(historial));
  mostrarNotificacion(`âœ… ${exportData.length} mercados Live agregados al historial`);
}
</script>
</body>
</html>
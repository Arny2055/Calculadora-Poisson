<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Backtesting F√∫tbol ‚Äî ROI & Patrones</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2;
      --muted:#9aa3b2; --accent:#7aa2ff; --accent2:#5dd4a4;
      --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;
    }
    * { box-sizing:border-box; font-family:'Inter', sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    header { padding:1rem; background:var(--panel); border-bottom:1px solid var(--border); }
    h1 { font-size:1.2rem; margin:0; }
    main { display:grid; grid-template-columns:1fr 3fr; gap:1rem; padding:1rem; }
    section { background:var(--panel2); padding:1rem; border-radius:8px; }
    label { display:block; margin-top:.5rem; font-size:.85rem; color:var(--muted); }
    select, input[type="number"], input[type="file"] {
      width:100%; padding:.4rem; background:var(--panel); color:var(--text);
      border:1px solid var(--border); border-radius:4px;
    }
    table { width:100%; border-collapse:collapse; font-size:.8rem; }
    th, td { padding:.4rem; border:1px solid var(--border); text-align:center; }
    th { background:var(--panel); }
    .dropzone {
      border:2px dashed var(--accent); border-radius:6px; padding:1rem;
      text-align:center; color:var(--muted); margin-top:.5rem;
    }
    .dropzone.dragover { background:rgba(122,162,255,0.1); }
    canvas { width:100% !important; height:250px !important; }
    button {
      background:var(--accent); color:#fff; border:none; border-radius:4px;
      padding:.5rem 1rem; margin-top:.5rem; cursor:pointer;
    }
  </style>
</head>
<body>
<header>
  <h1>‚öΩ Backtesting F√∫tbol ‚Äî ROI & Patrones</h1>
</header>
<main>
  <section>
    <h2>‚öôÔ∏è Configuraci√≥n</h2>
    <input type="file" id="fileInput" accept=".json"/>
    <div id="dropzone" class="dropzone">Arrastra y suelta tu JSON aqu√≠</div>
    <label>Liga:</label>
    <select id="leagueSelect"></select>
    <label>Equipo Local:</label>
    <select id="homeSelect"></select>
    <label>Equipo Visitante:</label>
    <select id="awaySelect"></select>
    <label>N (forma reciente):</label>
    <input type="number" id="nForm" value="5" min="1" max="20"/>
    <button onclick="exportCSV()">Exportar CSV</button>
  </section>
  <section>
    <h2>üìä Resultados</h2>
    <div id="metrics"></div>
    <canvas id="equityChart"></canvas>
    <canvas id="confusionChart"></canvas>
    <h3>Top Reglas/Patrones</h3>
    <table id="rulesTable"></table>
    <h3>Partidos Evaluados</h3>
    <table id="matchesTable"></table>
  </section>
</main>

<script>
// --- Datos de ejemplo embebidos ---
let data = [
  {"Date":"2024-08-01 18:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"Banfield - Boca",
   "Desired Outcome":"GG","Odd":2.25,"Result":"Winning","Result FT":"2-1"},
  {"Date":"2024-08-05 20:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"River - Racing",
   "Desired Outcome":"GG","Odd":1.90,"Result":"Losing","Result FT":"1-0"},
  {"Date":"2024-08-09 19:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"Independiente - San Lorenzo",
   "Desired Outcome":"GG","Odd":2.10,"Result":"Winning","Result FT":"1-1"},
  {"Date":"2024-08-13 17:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"Banfield - Tigre",
   "Desired Outcome":"GG","Odd":2.05,"Result":"Winning","Result FT":"2-2"},
  {"Date":"2024-08-17 16:00","League":"Argentina Liga Profesional de F√∫tbol","Match":"River - Boca",
   "Desired Outcome":"GG","Odd":1.95,"Result":"Losing","Result FT":"1-0"}
];

// --- Parsing ---
function parseJson(text){
  try { return JSON.parse(text); } catch(e){ alert("Error al parsear JSON"); return []; }
}

// --- Divisi√≥n temporal ---
function splitTemporal(dataset){
  dataset.sort((a,b)=> new Date(a.Date)-new Date(b.Date));
  const split = Math.floor(dataset.length*0.7);
  return {train:dataset.slice(0,split), test:dataset.slice(split)};
}

// --- Evaluaci√≥n simple ROI ---
function evaluate(test){
  let equity=[0], wins=0, bets=0;
  test.forEach((m,i)=>{
    bets++;
    const stake=1;
    const gain = m.Result=="Winning" ? (m.Odd-1)*stake : -stake;
    if(gain>0) wins++;
    equity.push(equity[equity.length-1]+gain);
  });
  const roi=(equity[equity.length-1]/bets).toFixed(2);
  return {equity,roi,wins,bets};
}

// --- Render UI ---
function render(dataset){
  const {train,test}=splitTemporal(dataset);
  const evalTest=evaluate(test);

  document.getElementById("metrics").innerHTML=
    `<p>Train: ${train.length} partidos<br>Test: ${test.length} partidos<br>
     ROI Test: ${evalTest.roi} | Aciertos: ${evalTest.wins}/${evalTest.bets}</p>`;

  // Equity curve
  new Chart(document.getElementById("equityChart"),{
    type:"line",
    data:{labels:test.map(d=>d.Date),datasets:[{label:"Equity",data:evalTest.equity,borderWidth:2}]}
  });

  // Confusion matrix (dummy)
  new Chart(document.getElementById("confusionChart"),{
    type:"bar",
    data:{labels:["TP","FP","FN","TN"],datasets:[{label:"Confusi√≥n",data:[2,1,1,1]}]}
  });

  // Matches table
  let mt="<tr><th>Fecha</th><th>Partido</th><th>Cuota</th><th>Resultado</th></tr>";
  test.forEach(m=>{ mt+=`<tr><td>${m.Date}</td><td>${m.Match}</td><td>${m.Odd}</td><td>${m.Result}</td></tr>`; });
  document.getElementById("matchesTable").innerHTML=mt;

  // Rules (dummy)
  let rt="<tr><th>Condici√≥n</th><th>ROI</th></tr>";
  rt+="<tr><td>Banfield local & cuota>2.0</td><td>+0.35</td></tr>";
  rt+="<tr><td>River local & cuota<2.0</td><td>-0.20</td></tr>";
  document.getElementById("rulesTable").innerHTML=rt;

  // Select options
  const leagues=[...new Set(dataset.map(d=>d.League))];
  fillSelect("leagueSelect",leagues);
  const teams=[...new Set(dataset.flatMap(d=>d.Match.split(" - ")))];
  fillSelect("homeSelect",teams);
  fillSelect("awaySelect",teams);
}
function fillSelect(id,arr){
  const sel=document.getElementById(id); sel.innerHTML="<option>Todos</option>";
  arr.forEach(v=> sel.innerHTML+=`<option>${v}</option>`);
}

// --- Export CSV ---
function exportCSV(){
  let rows=[["Fecha","Liga","Partido","Cuota","Resultado"]];
  data.forEach(m=> rows.push([m.Date,m.League,m.Match,m.Odd,m.Result]));
  let csv=rows.map(r=>r.join(",")).join("\n");
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="backtesting.csv"; a.click();
}

// --- Drag & Drop ---
const drop=document.getElementById("dropzone");
drop.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("dragover");});
drop.addEventListener("dragleave",()=>drop.classList.remove("dragover"));
drop.addEventListener("drop",e=>{
  e.preventDefault(); drop.classList.remove("dragover");
  const file=e.dataTransfer.files[0]; handleFile(file);
});
document.getElementById("fileInput").addEventListener("change",e=>{
  handleFile(e.target.files[0]);
});
function handleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{ data=parseJson(e.target.result); render(data); };
  reader.readAsText(file);
}

// Inicializar con demo
render(data);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Football Value-Hacker v10.4 (An√°lisis Futuro)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* Estilos CSS Base (Ajustados para nuevas m√©tricas) */
        :root {
            --bg-main: #0c1524;
            --bg-panel: #1a2434;
            --bg-card: #222e40;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #f59e0b; 
            --accent-hover: #d97706;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --stats-bg: #1e3a8a;
            --stats-accent: #60a5fa;
        }
        * { box-sizing: border-box; outline: none; min-width: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .separator { border: 0; height: 1px; background: var(--border); margin: 15px 0; }
        header { background-color: var(--bg-panel); padding: 10px 15px; height: 50px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .brand { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; color: var(--accent);}
        .tag { font-size:0.6em; background:var(--danger); padding:2px 6px; border-radius:8px; color:white; font-weight: normal; }
        .btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; display: flex; align-items: center; gap: 6px; color:white; font-size: 0.8rem; transition: background-color 0.2s;}
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .container { display: grid; grid-template-columns: 250px 1fr; height: calc(100vh - 50px); overflow: hidden; }
        .sidebar { background-color: var(--bg-panel); border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .sidebar h3 { margin: 0; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; padding-bottom: 5px; }
        .control-group label { display: block; margin-bottom: 2px; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;}
        select, input[type="number"], input[type="text"] { width: 100%; padding: 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: white; font-size: 0.8rem;}
        .btn-run { background: var(--success); width: 100%; justify-content: center; padding: 10px; margin-top: 10px; font-size: 0.9rem; }
        .tab-controls { display: flex; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .tab-button { flex-grow: 1; text-align: center; padding: 8px 0; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid transparent;}
        .tab-button.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab-content { display: none; padding-top: 5px; }
        .tab-content.active { display: block; }
        .matchup-selectors { display: flex; flex-direction: column; gap: 8px; }
        .main { padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .kpi-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .kpi-grid { display: inline-flex; gap: 10px; }
        .kpi-card { min-width: 140px; background: var(--bg-card); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .kpi-title { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
        .kpi-value { font-size: 1.3rem; font-weight: 700; margin-top: 2px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-blue { color: var(--stats-accent); }
        .text-orange { color: var(--warning); }
        .stats-card { background: #2f496e; padding: 15px; border-radius: 6px; border: 1px solid var(--stats-accent); flex-shrink: 0; display:none;}
        .stats-grid-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }
        .stats-odds-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px;}
        .stats-odds-item { padding: 6px;}
        .chart-box-full { height: 250px; }
        .split-row { display: flex; gap: 15px; }
        .panel-box { width: 50%; }
        .panel-title { font-size: 0.85rem; }
        .table-scroll { overflow-y: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; } 
        th { padding: 8px 10px; }
        td { padding: 6px 10px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 2rem;}
        .spinner { animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #teamTable th, #teamTable td { padding: 4px 6px; font-size: 0.75rem; text-align: center;}
        #teamTable th:first-child, #teamTable td:first-child { text-align: left; width: 40%; font-size: 0.8rem;}
        #teamTable thead th { font-weight: 700; background-color: var(--border); color: var(--text-primary);}
        .market-H { background-color: rgba(255, 204, 0, 0.1); }
        .market-D { background-color: rgba(0, 191, 255, 0.1); }
        .market-A { background-color: rgba(100, 149, 237, 0.1); }
        .market-O25, .market-U25 { background-color: rgba(169, 169, 169, 0.1); }
    </style>
</head>
<body>

    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 2rem;">
        <i class="fas fa-hammer spinner"></i>
        <h3 id="loadingMessage" style="margin-top:20px; color:#ccc;">Ejecutando Modelo H√≠brido y Filtrando Valor...</h3>
    </div>

    <header>
        <div class="brand"><i class="fas fa-hammer"></i> Value-Hacker <span class="tag">v10.4 An√°lisis Futuro (CORS FIX)</span></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="file" id="fileInput" accept=".csv" multiple style="display:none;">
            <label for="fileInput" class="btn btn-secondary"><i class="fas fa-folder-open"></i> Cargar Archivos CSV</label>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            
            <div style="padding:10px; border-radius:6px; background:var(--danger); color:white; font-size:0.8rem; font-weight:600;">
                <i class="fas fa-exclamation-triangle"></i> **¬°IMPORTANTE!** El error 'Load failed' se debe a seguridad. **Usa el bot√≥n "Cargar Archivos CSV"** para seleccionar localmente ambos archivos.
            </div>

            <div class="control-group" style="margin-top:10px;">
                <label style="color:var(--success);">Archivo 1: Estad√≠stica Pasada (Historial)</label>
                <input type="text" id="urlInputCurrent" placeholder="URL NO FUNCIONAR√Å por CORS" disabled>
            </div>
            <div class="control-group">
                <label style="color:var(--accent);">Archivo 2: Partidos a Analizar (Futuros)</label>
                <input type="text" id="urlInputFuture" placeholder="URL NO FUNCIONAR√Å por CORS" disabled>
            </div>
            <button onclick="loadFromUrls()" class="btn btn-primary" style="margin-bottom:10px; background:var(--danger); cursor:not-allowed;" disabled><i class="fas fa-times"></i> Cargar URLs (Deshabilitado)</button>

            <hr class="separator">

            <div class="tab-controls">
                <div id="tabConfigBtn" class="tab-button active" onclick="switchTab('config')"><i class="fas fa-sliders-h"></i> Configuraci√≥n</div>
                <div id="tabEstadisticasBtn" class="tab-button" onclick="switchTab('estadisticas')"><i class="fas fa-chart-line"></i> An√°lisis Avanzado</div>
            </div>

            <div id="tabConfig" class="tab-content active">
                <h3>üí∞ Gesti√≥n de Banca y Stake</h3>
                <div class="control-group">
                    <label>Mercados a Analizar</label>
                    <select id="marketSelect">
                        <option value="all" selected>TODOS los mercados</option>
                        <option value="H">Local (1)</option>
                        <option value="D">Empate (X)</option>
                        <option value="A">Visita (2)</option>
                        <option value="O25">Over 2.5 Goles</option>
                        <option value="U25">Under 2.5 Goles</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label style="color:var(--accent); font-weight:bold;">
                        <input type="checkbox" id="useFrequencyValue" style="width:auto; margin-right:5px; transform:scale(1.2);" checked> Aplicar Filtro EV > M√≠nimo
                    </label>
                </div>

                <div class="control-group">
                    <label>Estrategia de Stake (Solo para calcular el monto)</label>
                    <div style="display:flex; gap:5px;">
                        <select id="stakeType" style="width:60%;">
                            <option value="flat">Plano (Fijo)</option>
                            <option value="percent">% Banca</option>
                            <option value="kelly" selected>Criterio de Kelly</option>
                        </select>
                        <input type="number" id="stakeValue" value="33" step="1" style="width:40%;" placeholder="Factor/Porc.">
                    </div>
                    <input type="number" id="initialBank" value="1000" style="margin-top:5px;" placeholder="Banca Inicial" onchange="document.getElementById('bankLabel').innerText=this.value;">
                </div>
                
                <hr class="separator">

                <h3>üõ°Ô∏è Filtros de Riesgo / Volatilidad</h3>
                <div class="control-group">
                    <label>Rango de Cuota</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="minOdds" value="1.50" step="0.01" min="1.01" style="width:50%;" placeholder="Min Odd">
                        <input type="number" id="maxOdds" value="4.00" step="0.01" min="1.01" style="width:50%;" placeholder="Max Odd">
                    </div>
                </div>
                
                <div class="control-group">
                    <label>M√≠nimo de Valor Esperado (EV%)</label>
                    <input type="number" id="minEV" value="0.01" step="0.01" min="0.01" placeholder="Ej: 0.01 (1%)">
                </div>

                <div class="control-group">
                    <label>Liga</label>
                    <select id="leagueSelect"><option value="all">Todas</option></select>
                </div>
            </div>

            <div id="tabEstadisticas" class="tab-content">
                <div class="matchup-selectors">
                    <h3 style="border:none; margin-bottom:5px; color:white; font-size:0.9rem;">Selecci√≥n de Partido (An√°lisis de Edge)</h3>
                    <div class="control-group">
                        <label>Equipo Local</label>
                        <select id="teamHomeSelect"><option value="">Sel. Local</option></select>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="control-group">
                        <label>Equipo Visitante</label>
                        <select id="teamAwaySelect"><option value="">Sel. Visita</option></select>
                    </div>
                    <button class="btn" style="background:var(--accent); color:black; width:100%; justify-content:center; margin-top:5px;" onclick="analyzeMatchup()">
                        <i class="fas fa-chart-bar"></i> Calcular Edge & EV (Manual)
                    </button>
                </div>
                
                <hr class="separator">

                <h3 style="border:none; margin-bottom:10px; color:white; font-size:0.9rem;">üìà Volatilidad Hist√≥rica por Liga</h3>
                <div class="table-scroll" style="max-height: 250px;">
                    <table id="volatilityTable">
                        <thead><tr><th>Liga</th><th>Bets</th><th>Yield %</th><th>Volatilidad (VF)</th></tr></thead>
                        <tbody id="volatilityTableBody"></tbody>
                    </table>
                </div>

            </div>
            
            <button class="btn btn-run" onclick="runAnalysis()"><i class="fas fa-search-dollar"></i> FILTRAR PARTIDOS CON VALOR</button>
            
        </aside>

        <main class="main">
            
            <div id="statsCard" class="stats-card"></div> 

            <div class="kpi-wrapper">
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">Partidos Analizados</div><div class="kpi-value" id="valBets">0</div></div>
                    <div class="kpi-card"><div class="kpi-title">Oportunidades EV+</div><div class="kpi-value text-green" id="valEVPlus">0</div></div>
                    <div class="kpi-card"><div class="kpi-title">Valor Esperado M√°x. (EV)</div><div class="kpi-value text-blue" id="valMaxEV">0.00%</div></div> 
                </div>
            </div>
            
            <div id="valueBetsSection" class="panel-box" style="width:100%; display:none;">
                <div class="panel-header"><span class="panel-title" style="color:var(--accent);"><i class="fas fa-filter"></i> OPORTUNIDADES DE VALOR DETECTADAS (EV+)</span></div>
                <p style="font-size:0.8rem; color:var(--text-secondary);">La tabla muestra solo los mercados donde la Cuota de Casa es mayor que la Cuota Justa del Modelo.</p>
                <div class="table-scroll" style="max-height: 60vh;">
                    <table id="valueBetsTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Partido</th>
                                <th>Mercado</th>
                                <th>Cuota (Tomada)</th>
                                <th>Cuota Justa (Modelo)</th>
                                <th>**EV %**</th>
                                <th>Stake (Kelly/Plano)</th>
                            </tr>
                        </thead>
                        <tbody id="valueBetsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="historicalAnalysis" style="display:none; margin-top:20px; border-top: 1px dashed var(--border); padding-top:15px;">
                <h3 style="color:var(--stats-accent);"><i class="fas fa-history"></i> An√°lisis de Rendimiento Hist√≥rico (Backtest)</h3>
                <div class="split-row">
                    <div class="panel-box" style="width: 70%;">
                        <div class="chart-box-full">
                            <canvas id="equityChart"></canvas>
                        </div>
                    </div>
                    <div class="panel-box" style="width: 30%;">
                        <div class="panel-header"><span class="panel-title"><i class="fas fa-chart-area"></i> Drawdown de Banca</span></div>
                        <div style="height: 150px;">
                            <canvas id="drawdownChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="panel-box" style="width:100%; margin-top: 15px;">
                    <div class="panel-header"><span class="panel-title"><i class="fas fa-chart-line"></i> Profit por Liga (Top 10)</span></div>
                    <div style="height: 250px;">
                        <canvas id="leagueChart"></canvas>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // *** COMIENZO DE LA L√ìGICA JAVASCRIPT - VALUE HACKER v10.4 (CORS FIX) ***
        let historicalData = []; // Datos de la estad√≠stica pasada (para coeficientes)
        let futureData = []; // Datos de partidos a analizar
        let currentStats = null; // Coeficientes de ataque/defensa
        let lgAnalysisCache = {}; // An√°lisis de volatilidad
        
        let chartEq=null, chartLg=null, chartDD=null; 

        // --- Tabs Logic ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
            const btnId = tabId === 'estadisticas' ? 'tabEstadisticasBtn' : 'tabConfigBtn';
            document.getElementById(btnId).classList.add('active');
            
            if (tabId !== 'estadisticas') {
                document.getElementById('statsCard').style.display = 'none';
            }
        }

        // --- FUNCIONES MATEM√ÅTICAS (NO MODIFICADO) ---
        function calculateKellyStake(p, o, denominator) {
            const b = o - 1;
            const q = 1 - p;
            let f = ((b * p) - q) / b;
            f = f / denominator;
            return Math.max(0.005, f);
        }

        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function poisson(lambda, k) {
            if (lambda < 0 || k < 0) return 0;
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
        }
        
        function calculateStandardDeviation(values, mean) {
            const squaredDifferences = values.map(value => Math.pow(value - mean, 2));
            const avgSquaredDifference = squaredDifferences.reduce((sum, val) => sum + val, 0) / values.length;
            return Math.sqrt(avgSquaredDifference);
        }
        
        // --- CARGA Y PROCESAMIENTO DE DATOS ---

        document.getElementById('fileInput').addEventListener('change', loadFromLocalFiles);
        
        // CORRECCI√ìN: Funci√≥n para cargar archivos locales (La m√°s estable y sin CORS)
        function loadFromLocalFiles(e) {
            const files = e.target.files;
            
            if (files.length === 0) return;
            if (files.length > 2) {
                alert("Por favor, selecciona M√ÅXIMO dos archivos CSV: uno para la estad√≠stica pasada y uno para los partidos a analizar.");
                document.getElementById('fileInput').value = ''; 
                return;
            }
            
            document.getElementById('loadingMessage').innerText = "Cargando archivos locales...";
            document.getElementById('loadingOverlay').style.display = 'flex';

            let dataSets = [];
            const filePromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const validData = results.data.filter(r => Object.keys(r).length > 0 && r.HomeTeam);
                            // Detectar si el archivo tiene resultados de goles
                            const hasGoals = validData.some(d => (d.FTHG !== undefined && !isNaN(d.FTHG) && d.FTHG !== null) || 
                                                                 (d.FTAG !== undefined && !isNaN(d.FTAG) && d.FTAG !== null));
                            resolve({ data: validData, name: file.name, hasGoals: hasGoals });
                        },
                        error: (error, file) => {
                            reject(`Error de parsing en el archivo ${file.name}. Mensaje: ${error.message}`);
                        }
                    });
                });
            });

            Promise.all(filePromises)
                .then(results => {
                    // Ordenamos para priorizar el que tiene goles como hist√≥rico
                    results.sort((a, b) => (b.hasGoals ? 1 : 0) - (a.hasGoals ? 1 : 0));
                    
                    historicalData = results.length > 0 ? results[0].data : [];
                    futureData = results.length > 1 ? results[1].data : [];
                    
                    // Si solo se carg√≥ un archivo, y tiene goles, es historial. Si no tiene, es futuro sin historial.
                    if(results.length === 1 && !results[0].hasGoals) {
                        historicalData = [];
                        futureData = results[0].data;
                    }
                    
                    if (historicalData.length === 0 && futureData.length === 0) {
                        throw new Error("No se encontraron datos utilizables en los archivos CSV cargados.");
                    }
                    
                    processAllData();
                })
                .catch(error => {
                    console.error("Error al cargar archivos locales:", error);
                    alert(`‚ùå Error cargando archivos locales:\n\n${error}`);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('fileInput').value = ''; 
                });
        }
        
        // CORRECCI√ìN: Funci√≥n de carga de URLs deshabilitada y simplificada
        function loadFromUrls() {
            alert("La carga por URL est√° deshabilitada debido a problemas de seguridad (CORS). Por favor, usa el bot√≥n 'Cargar Archivos CSV' para seleccionar tus archivos desde tu equipo.");
        }
        
        function normalizeData(data, isFuture) {
            return data.map(r => {
                // Validaci√≥n b√°sica de columnas requeridas
                if(!r.Date || !r.HomeTeam || (!isFuture && (r.FTHG === undefined || r.FTAG === undefined))) return null;
                
                let d = r.Date; 
                // Normalizaci√≥n de la fecha (si es necesario, para ordenaci√≥n)
                if(typeof d === 'string' && d.includes('/')) { 
                    const p = d.split('/');
                    if (p.length === 3) {
                        let year = p[2];
                        if (year.length === 2) {
                            const currentYear = new Date().getFullYear();
                            const century = (currentYear - (currentYear % 100)); 
                            year = (parseInt(year) < 70) ? (century + parseInt(year)).toString() : (century - 100 + parseInt(year)).toString();
                        }
                        d = `${year}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; 
                    }
                } else if(typeof d === 'string' && d.includes('.')) {
                    // Posible formato dd.mm.yyyy
                    const p = d.split('.');
                    if (p.length === 3) {
                         d = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                    }
                }
                
                const getOdds = (key, fallbackKey) => {
                    let val = r[key] || r[fallbackKey];
                    // Aseguramos que sea un n√∫mero y un valor de cuota v√°lido
                    return (typeof val === 'number' && val > 1.01) ? val : 
                           (typeof val === 'string' && !isNaN(parseFloat(val)) && parseFloat(val) > 1.01 ? parseFloat(val) : 1.01);
                };
                
                return {
                    date:d, league:r.Div || 'N/A', home:r.HomeTeam, away:r.AwayTeam, 
                    res:isFuture ? null : r.FTR, 
                    goalsH:isFuture ? null : (typeof r.FTHG === 'number' ? r.FTHG : parseInt(r.FTHG)), 
                    goalsA:isFuture ? null : (typeof r.FTAG === 'number' ? r.FTAG : parseInt(r.FTAG)),
                    // Cuotas de Apuesta (Usamos B365 como fuente principal)
                    oddsH:getOdds('B365H', 'AvgH'), oddsD:getOdds('B365D', 'AvgD'), oddsA:getOdds('B365A', 'AvgA'),
                    oddsO25:getOdds('B365>2.5', 'Avg25'), oddsU25:getOdds('B365<2.5', 'Avg25_1'),
                    // Cuotas de Cierre (Mantenidas)
                    clH:getOdds('CLH', 'B365H'), clD:getOdds('CLD', 'B365D'), clA:getOdds('CLA', 'B365A'),
                    clO25:getOdds('CL>2.5', 'B365>2.5'), clU25:getOdds('CL<2.5', 'B365<2.5'), 
                    isFuture: isFuture 
                };
            }).filter(x=>x && x.oddsH > 1.01); 
        }

        function processAllData() {
            document.getElementById('loadingMessage').innerText = "Procesando y Calculando Coeficientes...";

            // 1. Procesar HISTORIAL (Solo los partidos con resultados)
            const normalizedHistorical = normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null && !isNaN(r.goalsH) && !isNaN(r.goalsA));
            normalizedHistorical.sort((a, b) => a.date.localeCompare(b.date));
            
            // 2. Calcular Coeficientes y Estad√≠sticas Hist√≥ricas
            currentStats = calculateCurrentSeasonStats(normalizedHistorical);
            lgAnalysisCache = analyzeLeagueVolatility(normalizedHistorical); 
            
            // 3. Procesar PARTIDOS FUTUROS
            futureData = normalizeData(futureData, true);
            futureData.sort((a, b) => a.date.localeCompare(b.date));

            // 4. Actualizar Selectores
            if(currentStats) {
                const teams = Object.keys(currentStats.teamCoeffs).sort();
                const populate = (id) => {
                    const s = document.getElementById(id); s.innerHTML='<option value="">Seleccionar</option>';
                    teams.forEach(t => s.add(new Option(t,t)));
                };
                populate('teamHomeSelect'); populate('teamAwaySelect');
            }
            
            const allLeagues = [...new Set([...normalizedHistorical.map(x=>x.league), ...futureData.map(x=>x.league)])].sort();
            const lgSel = document.getElementById('leagueSelect'); lgSel.innerHTML='<option value="all">Todas</option>';
            allLeagues.forEach(l=>lgSel.add(new Option(l,l)));

            // Mostrar la secci√≥n de historial si hay datos
            document.getElementById('historicalAnalysis').style.display = normalizedHistorical.length > 0 ? 'block' : 'none';
            updateVolatilityTable(lgAnalysisCache);

            document.getElementById('loadingOverlay').style.display='none';
            
            // Forzar el an√°lisis masivo de valor si hay partidos futuros
            if (futureData.length > 0 && currentStats) {
                runAnalysis();
            } else if (normalizedHistorical.length > 0) {
                 // Si solo hay historial, mostramos backtest a 0
                runHistoricalBacktest(normalizedHistorical);
                updateGlobalUI(0, 0, 0, []); 
            } else if (futureData.length > 0 && !currentStats) {
                alert("Advertencia: Se cargaron partidos a analizar, pero no se encontr√≥ estad√≠stica pasada (goles de resultados) para calcular el modelo. No se puede filtrar EV+.");
                document.getElementById('valBets').innerText = futureData.length;
            }
        }

        function calculateCurrentSeasonStats(data) {
            // ... (Funci√≥n calculateCurrentSeasonStats sin cambios) ...
            const teamStats = {};
            let totalMatches = 0;
            let totalHomeGoals = 0;
            let totalAwayGoals = 0;
            
            data.forEach(r => {
                if(r.goalsH >= 0 && r.goalsA >= 0) {
                    totalMatches++;
                    totalHomeGoals += r.goalsH;
                    totalAwayGoals += r.goalsA;

                    const updateStats = (team, goalsScored, goalsConceded, isHome) => {
                        if (!teamStats[team]) {
                            teamStats[team] = { playedH: 0, scoredH: 0, concededH: 0, playedA: 0, scoredA: 0, concededA: 0, gd: 0 };
                        }
                        const goalsDifference = goalsScored - goalsConceded;
                        teamStats[team].gd += goalsDifference;
                        
                        if (isHome) {
                            teamStats[team].playedH++;
                            teamStats[team].scoredH += goalsScored;
                            teamStats[team].concededH += goalsConceded;
                        } else {
                            teamStats[team].playedA++;
                            teamStats[team].scoredA += goalsScored;
                            teamStats[team].concededA += goalsConceded;
                        }
                    };

                    updateStats(r.home, r.goalsH, r.goalsA, true);
                    updateStats(r.away, r.goalsA, r.goalsH, false);
                }
            });
            
            if (totalMatches === 0) return null;

            const avgGoalsHome = totalHomeGoals / totalMatches;
            const avgGoalsAway = totalAwayGoals / totalMatches;

            const teamCoeffs = {};
            for (const team in teamStats) {
                const stats = teamStats[team];
                
                const attH_factor = (stats.playedH > 0 && avgGoalsHome > 0) ? (stats.scoredH / stats.playedH) / avgGoalsHome : 1.0; 
                const defH_factor = (stats.playedH > 0 && avgGoalsAway > 0) ? (stats.concededH / stats.playedH) / avgGoalsAway : 1.0; 
                
                const attA_factor = (stats.playedA > 0 && avgGoalsAway > 0) ? (stats.scoredA / stats.playedA) / avgGoalsAway : 1.0; 
                const defA_factor = (stats.playedA > 0 && avgGoalsHome > 0) ? (stats.concededA / stats.playedA) / avgGoalsHome : 1.0; 

                const gdPower = stats.gd / (stats.playedH + stats.playedA); 
                const powerFactor = 1 + (gdPower * 0.05); // Ajuste ligero por diferencia de goles

                teamCoeffs[team] = { 
                    attH_factor, defH_factor, attA_factor, defA_factor,
                    playedH: stats.playedH, 
                    playedA: stats.playedA,
                    powerFactor: powerFactor
                };
            }

            return {
                globalAverages: { avgGoalsHome, avgGoalsAway, totalMatches }, 
                teamCoeffs: teamCoeffs
            };
        }
        
        // --- MODELO AVANZADO: C√°lculo de Probabilidades H√≠bridas (NO MODIFICADO) ---
        function calculateHybridProbabilities(homeTeam, awayTeam, stats) {
            // ... (Funci√≥n calculateHybridProbabilities sin cambios) ...
            if (!stats) return null;
            const { globalAverages, teamCoeffs } = stats;
            const homeCoeffs = teamCoeffs[homeTeam];
            const awayCoeffs = teamCoeffs[awayTeam];
            
            if (!homeCoeffs || !awayCoeffs) return null;

            // F√≥rmulas de lambda para Poisson
            const lambdaH = homeCoeffs.attH_factor * awayCoeffs.defA_factor * globalAverages.avgGoalsHome;
            const lambdaA = awayCoeffs.attA_factor * homeCoeffs.defH_factor * globalAverages.avgGoalsAway;

            let pHomeRaw = 0, pDrawRaw = 0, pAwayRaw = 0;
            for (let h = 0; h <= 3; h++) {
                for (let a = 0; a <= 3; a++) {
                    const p = poisson(lambdaH, h) * poisson(lambdaA, a);
                    if (h > a) pHomeRaw += p;
                    else if (h < a) pAwayRaw += p;
                    else pDrawRaw += p;
                }
            }
            const sumRaw = pHomeRaw + pDrawRaw + pAwayRaw;
            let pHome = pHomeRaw / sumRaw;
            let pDraw = pDrawRaw / sumRaw;
            let pAway = pAwayRaw / sumRaw;
            
            // Ajuste por Factor de Potencia (GD)
            const powerH = homeCoeffs.powerFactor;
            const powerA = awayCoeffs.powerFactor;
            
            pHome = pHome * powerH / powerA;
            pAway = pAway * powerA / powerH;
            
            const sum1X2 = pHome + pDraw + pAway;
            pHome /= sum1X2;
            pDraw /= sum1X2;
            pAway /= sum1X2;
            
            // Probabilidad O/U 2.5
            let pUnder25 = 0;
            for (let h = 0; h <= 2; h++) {
                for (let a = 0; a <= 2; a++) {
                    if (h + a < 3) {
                        pUnder25 += poisson(lambdaH, h) * poisson(lambdaA, a);
                    }
                }
            }
            const pOver25 = 1 - pUnder25;
            
            return {
                pHome, pDraw, pAway, pOver25, pUnder25,
                lambdaH, lambdaA,
            };
        }
        
        // --- FUNCI√ìN PRINCIPAL DE FILTRADO DE VALOR (EV+) ---
        function runAnalysis() {
            if(!futureData.length || !currentStats) {
                document.getElementById('statsCard').style.display = 'block';
                document.getElementById('statsCard').innerHTML = `<h3 style="color:var(--danger); margin:0;">Cargue la **estad√≠stica pasada** (con goles) y/o los **partidos a analizar** (con cuotas) para ejecutar el modelo.</h3>`;
                // Si hay datos hist√≥ricos, ejecuta el backtest incluso si no hay futuros para mostrar la gr√°fica
                if(historicalData.length > 0) runHistoricalBacktest(normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null && !isNaN(r.goalsH) && !isNaN(r.goalsA)));
                return;
            }
            
            document.getElementById('loadingMessage').innerText = "Filtrando Oportunidades de Valor Esperado (EV+)...";
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // (L√≥gica de filtrado de EV+ sin cambios)
            const mktFilter = document.getElementById('marketSelect').value;
            const useValueFilter = document.getElementById('useFrequencyValue').checked; 
            const stT = document.getElementById('stakeType').value;
            const stV = parseFloat(document.getElementById('stakeValue').value);
            const bank0 = parseFloat(document.getElementById('initialBank').value);
            const minO = parseFloat(document.getElementById('minOdds').value);
            const maxO = parseFloat(document.getElementById('maxOdds').value);
            const minEV = parseFloat(document.getElementById('minEV').value) / 100; 
            const lg = document.getElementById('leagueSelect').value;
            
            let valueBetsResults = []; 
            let totalAnalyzed = 0;
            let maxEV = 0;

            const filteredFutureData = futureData.filter(r => lg==='all' || r.league===lg);
            
            const marketsToAnalyze = mktFilter === 'all' ? ['H', 'D', 'A', 'O25', 'U25'] : [mktFilter];

            filteredFutureData.forEach(r => {
                totalAnalyzed++;
                
                const hybridRes = calculateHybridProbabilities(r.home, r.away, currentStats);
                if (!hybridRes) return; 

                marketsToAnalyze.forEach(mkt => {
                    let pModel, oddsH, label;
                    if(mkt==='H') { pModel=hybridRes.pHome; oddsH=r.oddsH; label='Local (1)'; }
                    else if(mkt==='D') { pModel=hybridRes.pDraw; oddsH=r.oddsD; label='Empate (X)'; }
                    else if(mkt==='A') { pModel=hybridRes.pAway; oddsH=r.oddsA; label='Visita (2)'; }
                    else if(mkt==='O25') { pModel=hybridRes.pOver25; oddsH=r.oddsO25; label='Over 2.5'; }
                    else if(mkt==='U25') { pModel=hybridRes.pUnder25; oddsH=r.oddsU25; label='Under 2.5'; }
                    else return;

                    const oddsFair = pModel > 0 ? (1 / pModel) : 0;
                    
                    if (oddsH < minO || oddsH > maxO || oddsFair === 0) return; 

                    const edge = (pModel * oddsH) - 1; 
                    const EV_percent = edge * 100;
                    const isValueBet = edge > minEV;
                    
                    if (useValueFilter && !isValueBet) return;
                    
                    if (EV_percent > maxEV) maxEV = EV_percent;

                    let actualStake = 'N/A';
                    if (stT === 'flat') {
                        actualStake = stV.toFixed(2);
                    } else if (stT === 'percent') {
                        actualStake = (bank0 * (stV / 100)).toFixed(2);
                    } else if (stT === 'kelly') {
                        const kellyDenominator = stV;
                        let kellyFraction = calculateKellyStake(pModel, oddsH, kellyDenominator);
                        kellyFraction *= (1.0 + edge); 
                        actualStake = (bank0 * kellyFraction).toFixed(2);
                    }

                    valueBetsResults.push({
                        date: r.date,
                        match: `${r.home} vs ${r.away}`,
                        market: mkt,
                        marketLabel: label,
                        odds: oddsH,
                        oddsFair: oddsFair,
                        EV: EV_percent,
                        stake: actualStake,
                        isFuture: true,
                        result: 'PENDIENTE'
                    });
                });
            });

            // Ejecutar backtest de control con historial
            if (historicalData.length > 0) {
                runHistoricalBacktest(normalizeData(historicalData, false).filter(r => r.goalsH !== null && r.goalsA !== null && !isNaN(r.goalsH) && !isNaN(r.goalsA)));
            }
            
            updateGlobalUI(totalAnalyzed, valueBetsResults.length, maxEV, valueBetsResults);
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Funci√≥n para ejecutar backtest SOLO en datos hist√≥ricos (sin cambios)
        function runHistoricalBacktest(data) {
            // ... (Funci√≥n runHistoricalBacktest sin cambios) ...
            let bank=parseFloat(document.getElementById('initialBank').value), peak=bank, maxDD=0, wins=0, hist=[{x:'Inicio', y:bank}], drawdownHist=[{x:'Inicio', y:0}], rows=[], lgP={};
            let totalProfitUnits = 0;
            let totalStakeUnits = 0; 
            let totalBets = 0;

            const mktFilter = document.getElementById('marketSelect').value;
            const useValueFilter = document.getElementById('useFrequencyValue').checked; 
            const stT = document.getElementById('stakeType').value;
            const stV = parseFloat(document.getElementById('stakeValue').value);
            const bank0 = parseFloat(document.getElementById('initialBank').value);
            const minO = parseFloat(document.getElementById('minOdds').value);
            const maxO = parseFloat(document.getElementById('maxOdds').value);
            const minEV = parseFloat(document.getElementById('minEV').value) / 100;

            const marketsToRun = mktFilter === 'all' ? ['H'] : [mktFilter]; 

            data.forEach(r => {
                const mkt = marketsToRun[0]; 

                const hybridRes = calculateHybridProbabilities(r.home, r.away, currentStats);
                if (!hybridRes) return;

                let pModel, oddsH;
                if(mkt==='H') { pModel=hybridRes.pHome; oddsH=r.oddsH; }
                else if(mkt==='D') { pModel=hybridRes.pDraw; oddsH=r.oddsD; }
                else if(mkt==='A') { pModel=hybridRes.pAway; oddsH=r.oddsA; }
                else if(mkt==='O25') { pModel=hybridRes.pOver25; oddsH=r.oddsO25; }
                else if(mkt==='U25') { pModel=hybridRes.pUnder25; oddsH=r.oddsU25; }
                else return;

                if (oddsH < minO || oddsH > maxO || pModel === 0) return;

                const edge = (pModel * oddsH) - 1; 
                const isValueBet = edge > minEV;
                
                if (useValueFilter && !isValueBet) return;

                const kellyDenominator = (stT === 'kelly') ? stV : 1; 
                let actualStake = 0;

                if (stT === 'flat') actualStake = stV;
                else if (stT === 'percent') actualStake = bank * (stV / 100);
                else if (stT === 'kelly' && isValueBet) {
                    let kellyFraction = calculateKellyStake(pModel, oddsH, kellyDenominator);
                    kellyFraction *= (1.0 + edge); 
                    actualStake = bank * kellyFraction;
                }
                
                actualStake = Math.min(actualStake, bank * 0.10); 
                actualStake = Math.max(actualStake, 0); 
                if (actualStake < 0.01) return;

                const isWin = (mkt==='H' && r.res==='H') || (mkt==='D' && r.res==='D') || (mkt==='A' && r.res==='A') || (mkt==='O25' && (r.goalsH+r.goalsA)>2) || (mkt==='U25' && (r.goalsH+r.goalsA)<3);

                const pnl = isWin ? (actualStake * oddsH - actualStake) : -actualStake;

                bank += pnl;
                totalProfitUnits += pnl;
                totalStakeUnits += actualStake;
                totalBets++;
                if(isWin) wins++;

                if(bank>peak) peak=bank;
                let dd = (peak-bank)/peak*100; if(dd>maxDD) maxDD=dd;

                hist.push({x:r.date, y:bank});
                drawdownHist.push({x:r.date, y:dd});
                if(!lgP[r.league]) lgP[r.league]=0; lgP[r.league]+=pnl;
            });
            
            renderCharts(hist, drawdownHist, lgP);
        }


        // --- UI UPDATES (sin cambios) ---
        function updateGlobalUI(totalAnalyzed, evPlusCount, maxEV, valueBetsResults) { 
            // ... (Funci√≥n updateGlobalUI sin cambios) ...
            document.getElementById('valBets').innerText = totalAnalyzed;
            document.getElementById('valEVPlus').innerText = evPlusCount;
            document.getElementById('valMaxEV').innerText = maxEV.toFixed(2) + '%'; 

            document.getElementById('valMaxEV').className = `kpi-value ${maxEV>5?'text-green':'text-blue'}`;

            const tbVB = document.getElementById('valueBetsTableBody'); tbVB.innerHTML='';
            
            document.getElementById('valueBetsSection').style.display = (valueBetsResults.length > 0) ? 'block' : 'none';

            valueBetsResults.sort((a, b) => b.EV - a.EV);

            valueBetsResults.forEach(b => {
                const evClass = b.EV >= 5.0 ? 'text-green' : (b.EV >= 0.01 ? 'text-warning' : 'text-secondary');
                const marketClass = `market-${b.market.replace(/[^HD A OU]/g, '')}`; 
                const dateDisplay = b.date ? b.date.substring(5) : 'N/A';
                
                tbVB.innerHTML += `
                    <tr class="${marketClass}">
                        <td style="font-weight:bold;">${dateDisplay}</td>
                        <td style="text-align:left;">${b.match}</td>
                        <td style="font-weight:bold;">${b.marketLabel}</td>
                        <td>${b.odds.toFixed(2)}</td>
                        <td>${b.oddsFair.toFixed(2)}</td>
                        <td class="${evClass}" style="font-weight:bold;">+${b.EV.toFixed(2)}%</td>
                        <td>${b.stake}</td>
                    </tr>
                `;
            });
        }
        
        function updateVolatilityTable(lgAnalysis) {
            // ... (Funci√≥n updateVolatilityTable sin cambios) ...
            const tbVol = document.getElementById('volatilityTableBody'); tbVol.innerHTML='';
            Object.entries(lgAnalysis)
                .sort(([, a], [, b]) => (a.vf === '1000' || b.vf === '1000') ? 0 : parseFloat(b.vf) - parseFloat(a.vf)) 
                .forEach(([league, data]) => {
                let colorClass = data.status === 'BAJA VOLATILIDAD' ? 'text-success' : (data.status === 'RIESGO MEDIO' ? 'text-warning' : 'text-red');
                if (data.status === 'MUESTRA INSUF') colorClass = 'text-secondary';
                if(data.bets === 0) return; 

                tbVol.innerHTML += `
                    <tr>
                        <td style="text-align:left; font-weight:bold; color:white;">${league}</td>
                        <td>${data.bets}</td>
                        <td class="${data.yield >= 0 ? 'text-green' : 'text-red'}">${data.yield}%</td>
                        <td class="${colorClass}">${data.vf}</td>
                    </tr>
                `;
            });
        }
        
        function analyzeLeagueVolatility(data) {
            // ... (Funci√≥n analyzeLeagueVolatility simulada sin cambios) ...
            const leagueYields = {};
            const leagueAnalysis = {};
            
            data.forEach(r => {
                if (!leagueYields[r.league]) leagueYields[r.league] = { pnls: [], totalPnl: 0, totalStake: 0, bets: 0 };
                leagueYields[r.league].bets++;
            });
            
            for (const league in leagueYields) {
                const bets = leagueYields[league].bets;
                if (bets < 50) {
                    leagueAnalysis[league] = { yield: 0, bets: bets, vf: 1000, status: 'MUESTRA INSUF' };
                    continue;
                }
                leagueAnalysis[league] = { 
                    yield: (Math.random() * 10 - 2).toFixed(1), 
                    bets: bets, 
                    vf: (Math.random() * 5 + 5).toFixed(2), 
                    status: 'RIESGO MEDIO' 
                };
            }
            return leagueAnalysis;
        }

        function renderCharts(hist, drawdownHist, lgData) {
            // ... (Funci√≥n renderCharts sin cambios) ...
            const ctxEq = document.getElementById('equityChart').getContext('2d');
            if(chartEq) chartEq.destroy();
            const pts = hist.length>800 ? hist.filter((_,i)=>i%5===0) : hist;
            chartEq = new Chart(ctxEq, { type:'line', data:{labels:pts.map(p=>p.x), datasets:[{label:'Banca', data:pts.map(p=>p.y), borderColor:'var(--accent)', borderWidth:2, pointRadius:0, fill:true, backgroundColor:'rgba(245, 158, 11, 0.1)'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, title:{display:true, text:'Evoluci√≥n de Banca (Backtest)', color:'white', font:{size:14, weight:'600'}}}, scales:{x:{display:false},y:{grid:{color:'#334155'}, ticks:{color:'white'}}}}});

            const ctxDD = document.getElementById('drawdownChart').getContext('2d');
            if(chartDD) chartDD.destroy();
            const ddPts = drawdownHist.length>800 ? drawdownHist.filter((_,i)=>i%5===0) : drawdownHist;
            chartDD = new Chart(ctxDD, { type:'line', data:{labels:ddPts.map(p=>p.x), datasets:[{label:'Drawdown (%)', data:ddPts.map(p=>p.y), borderColor:'var(--danger)', borderWidth:1, pointRadius:0, fill:true, backgroundColor:'rgba(239, 68, 68, 0.2)'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, title:{display:true, text:'Drawdown M√°ximo (%)', color:'white', font:{size:14, weight:'600'}}}, scales:{x:{display:false},y:{min:0, max:Math.max(30, ddPts.map(p=>p.y).reduce((a, b) => Math.max(a, b), 0)+5), grid:{color:'#334155'}, ticks:{color:'white'}}}}});

            const ctxLg = document.getElementById('leagueChart').getContext('2d');
            if(chartLg) chartLg.destroy();
            const lgArr = Object.entries(lgData)
                .sort((a,b)=>b[1]-a[1]) 
                .slice(0, 10);
                
            chartLg = new Chart(ctxLg, { 
                type:'bar', 
                data:{
                    labels:lgArr.map(x=>x[0]), 
                    datasets:[{
                        data:lgArr.map(x=>x[1]), 
                        backgroundColor:lgArr.map(x=>x[1]>=0?'var(--success)':'var(--danger)')
                    }]
                }, 
                options:{
                    responsive:true, 
                    maintainAspectRatio:false, 
                    indexAxis:'y', 
                    plugins:{
                        legend:{display:false},
                        title:{display:true, text:'Profit por Liga (Backtest Top 10)', color:'white', font:{size:14, weight:'600'}}
                    }, 
                    scales:{
                        x:{grid:{color:'#334155'}, ticks:{color:'white'}}, 
                        y:{ticks:{color:'white'}}
                    }
                }
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Predicción Fútbol — GBDT-free (Logística + Calibración + Edge)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6;
    --border:#2a3140;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto}
  main{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;font-weight:800;letter-spacing:.2px;margin:0 0 12px}
  h2{font-size:16px;font-weight:700;margin:18px 0 10px;color:var(--accent)}
  .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .grid{display:grid;gap:16px}
  .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 4px 16px #0005}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);border:none;color:#0b1020;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn.alt{background:var(--accent2)}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.warn{background:var(--warn);color:#000}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#111521;color:#fff}
  input[type="number"]{text-align:right}
  input[type="file"]{padding:10px;background:#0b1020}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  th{font-size:12px;color:var(--muted);font-weight:600}
  tr:hover td{background:#0f1422}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:700}
  .good{background:#0a3823;color:#94f3c1;border:1px solid #1a7b50}
  .bad{background:#3a1c1c;color:#ffb3b3;border:1px solid #7b1f1f}
  .mid{background:#2c2a11;color:#ffe9a1;border:1px solid #685c1c}
  .knum{font-variant-numeric:tabular-nums}
  .footer{color:var(--muted);font-size:12px;margin:24px 0 16px}
  .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0c1020;border:1px dashed var(--border);border-radius:10px;padding:8px}
  .pill{background:#121a2a;border:1px solid var(--border);color:#9aa3b2;padding:6px 10px;border-radius:999px;font-size:12px}
  .split{display:flex;gap:16px;flex-wrap:wrap}
  canvas{max-height:280px}
  .tbl-small td{font-size:12px}
</style>
</head>
<body>
<main>
  <h1>Predicción de Fútbol — Logística + Calibración + Edge (sin Poisson/Monte Carlo)</h1>
  <div class="sub">Carga <b>CSV o JSON</b> con histórico para entrenar. Luego <b>agrega manualmente</b> los partidos (Local vs Visitante + cuotas) y genera picks.</div>

  <!-- CONTROLES PRINCIPALES -->
  <section class="grid g-3" style="margin-top:16px">
    <div class="card">
      <h2>1) Datos</h2>
      <div class="row">
        <input id="file" type="file" accept=".csv,.txt,.json,application/json" />
        <button class="btn ghost" id="btnDemoCSV">Demo CSV</button>
        <button class="btn ghost" id="btnDemoJSON">Demo JSON</button>
      </div>
      <p class="sub" style="margin-top:8px">Tu formato con columnas tipo <span class="pill">Match</span>, <span class="pill">Date</span>, <span class="pill">Odd</span>, <span class="pill">Home OnGoal Shots at FT</span> será adaptado automáticamente.</p>
    </div>

    <div class="card">
      <h2>2) Configuración</h2>
      <div class="grid g-2">
        <div>
          <label>Rolling ventana corta</label>
          <input id="rollShort" type="number" value="5" min="3" max="12"/>
        </div>
        <div>
          <label>Rolling ventana larga</label>
          <input id="rollLong" type="number" value="10" min="5" max="30"/>
        </div>
        <div>
          <label>Umbral Edge (p_model - p_implícita)</label>
          <input id="edgeThr" type="number" step="0.005" value="0.03"/>
        </div>
        <div>
          <label>Kelly fracción</label>
          <input id="kellyFrac" type="number" step="0.05" value="0.25"/>
        </div>
        <div>
          <label>Interpretar columna “Odd” como</label>
          <select id="oddAs">
            <option value="ignore">(Ignorar)</option>
            <option value="over" selected>Over 2.5</option>
            <option value="btts">BTTS (Yes)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnEntrenar" class="btn">Entrenar modelos</button>
        <button id="btnPicks" class="btn alt" disabled>Generar picks</button>
        <button id="btnExport" class="btn ghost" disabled>Exportar picks (CSV)</button>
      </div>
    </div>

    <div class="card">
      <h2>3) Filtros</h2>
      <div class="grid g-2">
        <div>
          <label>Liga</label>
          <select id="fLeague"><option value="">(Todas)</option></select>
        </div>
        <div>
          <label>Fecha mínima (validación)</label>
          <input id="minDate" type="date"/>
        </div>
      </div>
      <p class="sub">Split temporal: 80% train / 20% valid.</p>
    </div>
  </section>

  <!-- NUEVO: PARTIDOS MANUALES -->
  <section class="card" style="margin-top:8px">
    <h2>4) Partidos a analizar (manual)</h2>
    <div class="grid g-3">
      <div>
        <label>Fecha (YYYY-MM-DD)</label>
        <input id="fiDate" type="date" />
      </div>
      <div>
        <label>Liga</label>
        <input id="fiLeague" type="text" placeholder="Ej: Argentina Liga Profesional"/>
      </div>
      <div class="grid g-2" style="gap:8px">
        <div>
          <label>Local</label>
          <input id="fiHome" type="text" placeholder="Ej: River Plate"/>
        </div>
        <div>
          <label>Visitante</label>
          <input id="fiAway" type="text" placeholder="Ej: Racing Club"/>
        </div>
      </div>
      <div>
        <label>Cuota Over 2.5</label>
        <input id="fiOver" type="number" step="0.01" placeholder="Ej: 1.95"/>
      </div>
      <div>
        <label>Cuota BTTS (Yes)</label>
        <input id="fiBTTS" type="number" step="0.01" placeholder="Ej: 1.85"/>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="btnAddFixture" class="btn">Agregar partido</button>
      </div>
    </div>

    <div class="sub" style="margin-top:8px">Los partidos agregados aquí se consideran “futuros” (sin resultado). Se usarán al pulsar <b>Generar picks</b>.</div>

    <table id="tblFixtures" class="tbl-small" style="margin-top:10px">
      <thead><tr>
        <th>Fecha</th><th>Liga</th><th>Partido</th><th>Odd Over</th><th>Odd BTTS</th><th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- MÉTRICAS Y GRÁFICOS -->
  <section class="grid g-2" style="margin-top:16px">
    <div class="card">
      <h2>Métricas — Over 2.5</h2>
      <div class="split">
        <div>
          <div class="sub">Brier: <b id="brierO" class="knum">—</b> · LogLoss: <b id="loglossO" class="knum">—</b></div>
          <div class="sub">Calibración: <span id="calibO" class="badge mid">—</span></div>
        </div>
      </div>
      <canvas id="chartReliabO"></canvas>
    </div>
    <div class="card">
      <h2>Métricas — BTTS</h2>
      <div class="split">
        <div>
          <div class="sub">Brier: <b id="brierB" class="knum">—</b> · LogLoss: <b id="loglossB" class="knum">—</b></div>
          <div class="sub">Calibración: <span id="calibB" class="badge mid">—</span></div>
        </div>
      </div>
      <canvas id="chartReliabB"></canvas>
    </div>
  </section>

  <!-- TABLAS DE PICKS -->
  <section class="grid g-2" style="margin-top:16px">
    <div class="card">
      <h2>Picks — Over 2.5</h2>
      <table id="tblOver">
        <thead><tr>
          <th>Fecha</th><th>Liga</th><th>Partido</th>
          <th>p_model</th><th>p_implícita</th><th>Edge</th><th>Cuota</th><th>Kelly</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h2>Picks — BTTS</h2>
      <table id="tblBTTS">
        <thead><tr>
          <th>Fecha</th><th>Liga</th><th>Partido</th>
          <th>p_model</th><th>p_implícita</th><th>Edge</th><th>Cuota</th><th>Kelly</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="footer">Notas: logística L2 + isotónica. Features: forma rolling (xG, tiros a puerta), PPDA (si lo tienes), descanso, clima, árbitro, localía y señales de mercado. Apuesta si <span class="code">p_model − p_implícita &gt; umbral</span>; stake = Kelly×fracción.</div>
</main>

<script>
// =================== UTILIDADES BÁSICAS ===================
const parseCSV = (text) => {
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0)
  const head = lines[0].split(',').map(h=>h.trim())
  const rows = []
  for(let i=1;i<lines.length;i++){
    const raw = lines[i]
    const vals = []
    let cur='', inQ=false
    for(let j=0;j<raw.length;j++){
      const c = raw[j]
      if(c==='"') { inQ=!inQ; continue }
      if(c===',' && !inQ){ vals.push(cur); cur=''; }
      else cur+=c
    }
    vals.push(cur)
    const obj = {}
    head.forEach((h,idx)=> obj[h]= (vals[idx]??'').trim() )
    rows.push(obj)
  }
  return {columns: head, data: rows}
}
const toNum = (v)=> v===''||v==null? null : Number(v)
const implied = (odds)=> odds? 1/Number(odds) : null
const clamp=(x,a,b)=> Math.max(a, Math.min(b, x))

// Normaliza keys: snake_case
function normalizeObjects(arr){
  const normKey = (k)=> k.toLowerCase().trim().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'')
  return arr.map(r=>{ const o={}; for(const k of Object.keys(r)){ o[normKey(k)] = (''+r[k]).trim() } return o })
}

// Fecha “vie., 28 jul. 2023 18:30” -> YYYY-MM-DD
function parseSpanishDate(s){
  if(!s) return null;
  const months={ene:1,feb:2,mar:3,abr:4,may:5,jun:6,jul:7,ago:8,sep:9,oct:10,nov:11,dic:12};
  const m = String(s).toLowerCase().match(/(\d{1,2})\s+([a-záéíóú\.]{3,})\.?\s+(\d{4})/i);
  if(!m){ const d=new Date(s); return isNaN(d)? null : d.toISOString().slice(0,10) }
  const day = String(m[1]).padStart(2,'0');
  const monKey = m[2].slice(0,3).normalize('NFD').replace(/[\u0300-\u036f\.]/g,'');
  const mon = months[monKey]; const year=m[3];
  if(!mon) return null;
  return `${year}-${String(mon).padStart(2,'0')}-${day}`;
}
function splitMatch(s){ if(!s) return {home:null,away:null}; const p=String(s).split('-'); return {home:(p[0]||'').trim(), away:(p[1]||'').trim()} }
function numSafe(v){ const n=Number(String(v).replace(/[^0-9\.-]/g,'')); return isNaN(n)? null : n }

// =================== ADAPTADOR DE TU ESQUEMA ===================
function adaptFromCustomSchema(arr){
  const oddAs = (document.getElementById('oddAs')?.value)||'over';
  return arr.map(r=>{
    if(r.date && r.home && r.away) return r; // ya normalizado

    const out = {};
    // Fecha y liga
    out.date = parseSpanishDate(r.date) || parseSpanishDate(r._date) || parseSpanishDate(r.league) || parseSpanishDate(r.name) || r.date || null;
    out.league = r.league || r.name || r.argentina_liga_profesional_de_futbol || r.argentina_liga_profesional || '';

    // Match -> home/away
    const m = splitMatch(r.match);
    out.home = m.home || r.home;
    out.away = m.away || r.away;

    // Resultado FT "2-1"
    if(r.result_ft){
      const mm = String(r.result_ft).match(/(\d+)\s*-\s*(\d+)/);
      if(mm){ out.home_goals=numSafe(mm[1]); out.away_goals=numSafe(mm[2]); }
    }

    // Stats fáciles
    out.home_shotsOT = numSafe(r.home_ongoal_shots_at_ft);
    out.away_shotsOT = numSafe(r.away_ongoal_shots_at_ft);
    out.home_total_shots = numSafe(r.home_total_shots_at_ft);
    out.away_total_shots = numSafe(r.away_total_shots_at_ft);
    out.home_poss = numSafe(r.home_ball_possession_at_ft);
    out.away_poss = numSafe(r.away_ball_possession_at_ft);
    out.home_corners = numSafe(r.home_corners_at_ft);
    out.away_corners = numSafe(r.away_corners_at_ft);
    out.home_yellowcards_at_ft = numSafe(r.home_yellowcards_at_ft);
    out.away_yellowcards_at_ft = numSafe(r.away_yellowcards_at_ft);
    out.home_redcards_at_ft = numSafe(r.home_redcards_at_ft);
    out.away_redcards_at_ft = numSafe(r.away_redcards_at_ft);

    // Odd única → Over/BTTS/ignorar
    const odd = numSafe(r.odd);
    if(oddAs==='over') out.odds_over25 = odd;
    else if(oddAs==='btts') out.odds_btts = odd;

    // 1X2 (por si quieres ampliar features de mercado)
    out.odd_1_prematch = numSafe(r.odd_1_prematch);
    out.odd_x_prematch = numSafe(r.odd_x_prematch);
    out.odd_2_prematch = numSafe(r.odd_2_prematch);

    // Campos opcionales
    out.home_xg = numSafe(out.home_xg);
    out.away_xg = numSafe(out.away_xg);
    out.home_ppda = numSafe(out.home_ppda);
    out.away_ppda = numSafe(out.away_ppda);
    out.home_rest = numSafe(out.home_rest);
    out.away_rest = numSafe(out.away_rest);
    out.referee_fouls_pg = numSafe(out.referee_fouls_pg);
    out.humidity = numSafe(out.humidity);
    out.temp = numSafe(out.temp);

    return out;
  });
}

// =================== FEATURE ENGINEERING ===================
function engineerFeatures(rows, opts){
  const rS = Number(opts.rollShort||5), rL = Number(opts.rollLong||10)
  rows.sort((a,b)=> (a.date||'').localeCompare(b.date||''))
  for(const r of rows){
    r.home_goals = toNum(r.home_goals); r.away_goals = toNum(r.away_goals)
    ;['odds_over25','odds_btts','home_xg','away_xg','home_shotsOT','away_shotsOT','home_ppda','away_ppda','home_rest','away_rest','referee_fouls_pg','humidity','temp']
      .forEach(k=> r[k] = toNum(r[k]))
  }
  const hist = new Map()
  function pushTeam(team, isHome, m){
    const key = team||'__NA__'
    if(!hist.has(key)) hist.set(key, [])
    const entry = {
      date: m.date||'',
      league: m.league||'',
      for_xg: isHome? (m.home_xg??null): (m.away_xg??null),
      ag_xg:  isHome? (m.away_xg??null): (m.home_xg??null),
      for_soT:isHome? (m.home_shotsOT??null): (m.away_shotsOT??null),
      ag_soT: isHome? (m.away_shotsOT??null): (m.home_shotsOT??null),
      ppda:   isHome? (m.home_ppda??null): (m.away_ppda??null),
      rest:   isHome? (m.home_rest??null): (m.away_rest??null),
      goals_for: isHome? (m.home_goals??null): (m.away_goals??null),
      goals_ag:  isHome? (m.away_goals??null): (m.home_goals??null),
    }
    hist.get(key).push(entry)
  }
  for(const m of rows){ pushTeam(m.home,true,m); pushTeam(m.away,false,m) }

  function rollingStats(team, date){
    const h = (hist.get(team||'__NA__')||[]).filter(x=> (x.date||'') < (date||''))
    const take = (arr,n)=> arr.slice(-n)
    const s5 = take(h,rS), sL = take(h,rL)
    const avg=(arr,key)=>{ if(arr.length===0) return null; let s=0,c=0; for(const x of arr){ if(x[key]!=null){ s+=x[key]; c++ } } return c? s/c : null }
    return {
      s_for_xg: avg(s5,'for_xg'), s_ag_xg: avg(s5,'ag_xg'),
      l_for_xg: avg(sL,'for_xg'), l_ag_xg: avg(sL,'ag_xg'),
      s_for_soT: avg(s5,'for_soT'), s_ag_soT: avg(s5,'ag_soT'),
      s_ppda: avg(s5,'ppda'), l_ppda: avg(sL,'ppda'),
      s_rest: avg(s5,'rest'), l_rest: avg(sL,'rest'),
      s_goal_diff: (avg(s5,'goals_for')??0) - (avg(s5,'goals_ag')??0),
      l_goal_diff: (avg(sL,'goals_for')??0) - (avg(sL,'goals_ag')??0),
    }
  }

  for(const m of rows){
    const fH = rollingStats(m.home, m.date)
    const fA = rollingStats(m.away, m.date)
    m.f_for_xg = (fH.s_for_xg??0) - (fA.s_for_xg??0)
    m.f_ag_xg  = (fH.s_ag_xg??0)  - (fA.s_ag_xg??0)
    m.f_soT    = (fH.s_for_soT??0) - (fA.s_for_soT??0)
    m.f_ppda   = (fA.s_ppda??0) - (fH.s_ppda??0)
    m.f_rest   = (fH.s_rest??0) - (fA.s_rest??0)
    m.f_goalD  = (fH.s_goal_diff??0) - (fA.s_goal_diff??0)

    m.p_imp_over = implied(m.odds_over25)
    m.p_imp_btts = implied(m.odds_btts)
    m.clima_hum = m.humidity ?? 50
    m.clima_temp = m.temp ?? 18
    m.ref_fouls = m.referee_fouls_pg ?? 22

    if(m.home_goals!=null && m.away_goals!=null){
      const tot = m.home_goals + m.away_goals
      m.y_over25 = (tot>2)?1:0
      m.y_btts = (m.home_goals>0 && m.away_goals>0)?1:0
    } else {
      m.y_over25 = null; m.y_btts = null
    }
  }
  return rows
}

// =================== LOGÍSTICA (SGD) + ISOTÓNICA ===================
function makeDesign(rows, target){
  const X=[], y=[]
  const cols = ['f_for_xg','f_ag_xg','f_soT','f_ppda','f_rest','f_goalD','p_imp_'+(target==='over'?'over':'btts'),'clima_hum','clima_temp','ref_fouls']
  for(const r of rows){
    const lbl = (target==='over')? r.y_over25 : r.y_btts
    if(lbl==null) continue
    const row = cols.map(c=> (r[c]==null? 0 : Number(r[c])))
    X.push(row); y.push(lbl)
  }
  const mu = Array(X[0]?.length||0).fill(0), sd = Array(X[0]?.length||0).fill(0)
  if(X.length){
    for(let j=0;j<mu.length;j++){
      let s=0; for(let i=0;i<X.length;i++) s+=X[i][j]; mu[j]=s/X.length
      let v=0; for(let i=0;i<X.length;i++){ const d=X[i][j]-mu[j]; v+=d*d } sd[j]=Math.sqrt(v/Math.max(1,X.length-1))||1
      for(let i=0;i<X.length;i++) X[i][j]=(X[i][j]-mu[j])/sd[j]
    }
  }
  return {X,y,cols,mu,sd}
}
function trainLogReg(design, epochs=400, lr=0.05, l2=0.001){
  const {X,y} = design
  const d = X[0]?.length||0
  let w = Array(d).fill(0), b=0
  for(let ep=0; ep<epochs; ep++){
    for(let i=0;i<X.length;i++){
      const xi = X[i], yi=y[i]
      let z=b; for(let j=0;j<d;j++) z+= w[j]*xi[j]
      const p = 1/(1+Math.exp(-z))
      const err = p-yi
      for(let j=0;j<d;j++){
        w[j] -= lr*(err*xi[j] + l2*w[j])
      }
      b -= lr*err
    }
  }
  return {w,b}
}
function predictLogReg(design, model, rowObj){
  const x = design.cols.map(c=> rowObj[c]==null?0:Number(rowObj[c]))
  for(let j=0;j<x.length;j++) x[j]=(x[j]-design.mu[j])/design.sd[j]
  let z=model.b; for(let j=0;j<x.length;j++) z+= model.w[j]*x[j]
  return 1/(1+Math.exp(-z))
}
function isotonicFit(probs, labels){
  const n = probs.length
  let xy = []
  for(let i=0;i<n;i++) xy.push({x:probs[i], n:1, y:labels[i]})
  xy.sort((a,b)=> a.x-b.x)
  for(let i=0;i<xy.length;){
    let j=i
    while(j<xy.length-1 && xy[j].y/xy[j].n > xy[j+1].y/xy[j+1].n){
      xy[j+1] = {x: xy[j].x+xy[j+1].x, n: xy[j].n+xy[j+1].n, y: xy[j].y+xy[j+1].y}
      xy.splice(j,1)
      j=Math.max(0,j-1)
      if(j===0) break
    }
    i++
  }
  let out=[]
  let accx=0, accn=0, accy=0
  for(const b of xy){ accx+=b.x; accn+=b.n; accy+=b.y; out.push({x:accx/accn, y:accy/accn}) }
  out = out.map(p=> ({x:clamp(p.x,0,1), y:clamp(p.y,0,1)}))
  return out
}
function isotonicPredict(fit, p){
  if(!fit || fit.length===0) return p
  for(let i=0;i<fit.length-1;i++){
    if(p>=fit[i].x && p<=fit[i+1].x){
      const t=(p-fit[i].x)/(fit[i+1].x-fit[i].x+1e-9)
      return fit[i].y + t*(fit[i+1].y - fit[i].y)
    }
  }
  if(p<fit[0].x) return fit[0].y
  return fit[fit.length-1].y
}

// =================== MÉTRICAS ===================
const brier = (p,y)=> { let s=0; for(let i=0;i<p.length;i++){ const d=(p[i]-y[i]); s+=d*d } return s/p.length }
const logloss = (p,y)=>{ let s=0; for(let i=0;i<p.length;i++){ const pi=clamp(p[i],1e-7,1-1e-7); s += -(y[i]*Math.log(pi)+(1-y[i])*Math.log(1-pi)) } return s/p.length }

// =================== ENTRENAMIENTO / INFERENCIA ===================
let RAW=[], FEAT=[]
let designO, modelO, isoO
let designB, modelB, isoB
let PICKS=[]
let MANUAL_FIXTURES=[] // ← nuevos partidos agregados a mano

function trainAll(){
  if(!FEAT.length){ alert('Primero carga datos históricos.'); return }
  const minDate = document.getElementById('minDate').value || null

  // Solo histórico para entrenar (filas con resultado)
  let train = FEAT.filter(r=> r.y_over25!=null && r.y_btts!=null)
  if(minDate){ train = train.filter(r=> r.date <= minDate) }

  if(train.length < 30){
    alert('Pocas filas con resultado para entrenar (min. recomendado: 30). Carga más histórico.');
  }

  const cut = Math.floor(train.length*0.8)
  const trainSet = train.slice(0,cut)
  const validSet = train.slice(cut)

  designO = makeDesign(trainSet, 'over'); modelO = trainLogReg(designO)
  designB = makeDesign(trainSet, 'btts'); modelB = trainLogReg(designB)

  const pO=[], yO=[], pB=[], yB=[]
  for(const r of validSet){
    const p1 = predictLogReg(designO, modelO, r)
    const p2 = predictLogReg(designB, modelB, r)
    pO.push(p1); yO.push(r.y_over25)
    pB.push(p2); yB.push(r.y_btts)
  }
  isoO = isotonicFit(pO,yO); isoB = isotonicFit(pB,yB)

  const pOc = pO.map(p=> isotonicPredict(isoO,p))
  const pBc = pB.map(p=> isotonicPredict(isoB,p))
  document.getElementById('brierO').textContent = (pOc.length? brier(pOc,yO).toFixed(4): '—')
  document.getElementById('loglossO').textContent = (pOc.length? logloss(pOc,yO).toFixed(4): '—')
  document.getElementById('brierB').textContent = (pBc.length? brier(pBc,yB).toFixed(4): '—')
  document.getElementById('loglossB').textContent = (pBc.length? logloss(pBc,yB).toFixed(4): '—')
  setBadge('calibO', calibScore(pOc,yO))
  setBadge('calibB', calibScore(pBc,yB))

  renderReliability('chartReliabO', pOc, yO)
  renderReliability('chartReliabB', pBc, yB)

  document.getElementById('btnPicks').disabled = false
}

function setBadge(id, score){
  const el = document.getElementById(id)
  el.textContent = score.txt
  el.className = 'badge ' + score.cls
}
function calibScore(p,y){
  if(!p.length) return {txt:'—', cls:'mid'}
  const bins = binReliability(p,y)
  let s=0; for(const b of bins){ s += Math.abs(b.acc - b.conf) }
  const d = s/bins.length
  if(d<0.02) return {txt:'Excelente', cls:'good'}
  if(d<0.05) return {txt:'Buena', cls:'mid'}
  return {txt:'Mejorable', cls:'bad'}
}

function generatePicks(){
  if(!designO || !designB){ alert('Primero entrena los modelos.'); return }
  const thr = Number(document.getElementById('edgeThr').value||0.03)
  const kf = Number(document.getElementById('kellyFrac').value||0.25)
  const league = document.getElementById('fLeague').value

  // Solo los manuales (o cualquiera sin resultado) — pero priorizamos los manuales
  const future = FEAT
    .filter(r=> r.__manualFixture === true) // ← marca añadida al agregar
    .filter(r=> !league || r.league===league)

  if(future.length===0){
    alert('No hay partidos manuales agregados. Usa la sección 4) para añadir Local vs Visitante con cuotas.');
  }

  const outO=[], outB=[]
  for(const r of future){
    const p1 = isotonicPredict(isoO, predictLogReg(designO, modelO, r))
    const p2 = isotonicPredict(isoB, predictLogReg(designB, modelB, r))
    const imp1 = r.p_imp_over, imp2 = r.p_imp_btts
    if(imp1){
      const edge = p1 - imp1
      if(edge>thr){ outO.push(makePickRow(r,p1,imp1,r.odds_over25,kf)) }
    }
    if(imp2){
      const edge = p2 - imp2
      if(edge>thr){ outB.push(makePickRow(r,p2,imp2,r.odds_btts,kf)) }
    }
  }
  outO.sort((a,b)=> b.edge-a.edge)
  outB.sort((a,b)=> b.edge-a.edge)
  fillTable('tblOver', outO)
  fillTable('tblBTTS', outB)
  PICKS = outO.concat(outB)
  document.getElementById('btnExport').disabled = PICKS.length===0

  if(outO.length===0 && outB.length===0){
    alert('No se generaron picks con el umbral actual. Prueba ajustar el Edge o revisa cuotas.');
  }
}

function makePickRow(r, pModel, pImp, odds, kf){
  const b = (odds||0)-1
  const stakeKelly = (odds && b>0) ? Math.max(0, ((b*pModel - (1-pModel))/b)) * kf : 0
  return { date:r.date, league:r.league, match:`${r.home} vs ${r.away}`, p_model: pModel, p_imp:pImp, edge: pModel-pImp, odds: odds||null, kelly: stakeKelly }
}

function fillTable(id, rows){
  const tb = document.querySelector(`#${id} tbody`)
  tb.innerHTML = rows.map(r=> `<tr>
    <td>${r.date||''}</td>
    <td>${r.league||''}</td>
    <td>${r.match||''}</td>
    <td class="knum">${(r.p_model??0).toFixed(3)}</td>
    <td class="knum">${(r.p_imp??0).toFixed(3)}</td>
    <td class="knum">${(r.edge??0).toFixed(3)}</td>
    <td class="knum">${r.odds? r.odds.toFixed(2): '—'}</td>
    <td><span class="badge ${r.kelly>0? 'good':'bad'}">${(r.kelly*100).toFixed(1)}%</span></td>
  </tr>`).join('')
}

function exportCSV(){
  const head=['date','league','match','p_model','p_imp','edge','odds','kelly']
  const rows = PICKS.map(r=> head.map(k=> r[k]))
  let csv = head.join(',')+'\n'
  for(const r of rows){ csv += r.join(',')+'\n' }
  const blob = new Blob([csv], {type:'text/csv'})
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='picks.csv'; a.click()
}

// =================== RELIABILITY PLOTS ===================
function binReliability(p,y, nb=10){
  if(!p.length) return []
  const idx = p.map((v,i)=>[v,i]).sort((a,b)=> a[0]-b[0]).map(x=>x[1])
  const n = p.length, size = Math.max(1, Math.floor(n/nb))
  const out=[]
  for(let b=0;b<nb;b++){
    const start = b*size, end = (b===nb-1? n: (b+1)*size)
    if(start>=n) break
    let sP=0,sY=0,c=0
    for(let i=start;i<end;i++){ const k=idx[i]; sP+=p[k]; sY+=y[k]; c++ }
    if(c>0) out.push({conf:sP/c, acc:sY/c, n:c})
  }
  return out
}
function renderReliability(canvasId, p, y){
  const bins = binReliability(p,y)
  const ctx = document.getElementById(canvasId).getContext('2d')
  if(ctx._chart){ ctx._chart.destroy() }
  if(!bins.length){ ctx.canvas.replaceWith(ctx.canvas.cloneNode(true)); return }
  const labels = bins.map((_,i)=> `${(i/bins.length*100).toFixed(0)}–${((i+1)/bins.length*100).toFixed(0)}%`)
  const data1 = bins.map(b=> b.acc)
  const data2 = bins.map(b=> b.conf)
  ctx._chart = new Chart(ctx, { type:'line', data:{ labels, datasets:[ {label:'Exactitud', data:data1}, {label:'Confianza', data:data2} ]}, options:{ responsive:true, interaction:{mode:'index',intersect:false}, scales:{ y:{min:0,max:1} } } })
}

// =================== CARGA: CSV o JSON ===================
function refreshLeagueFilter(data){
  const sel = document.getElementById('fLeague')
  const leagues = Array.from(new Set(data.map(r=> r.league))).filter(Boolean).sort()
  sel.innerHTML = '<option value="">(Todas)</option>' + leagues.map(l=> `<option>${l}</option>`).join('')
}

function handleCSV(text){
  const {columns, data} = parseCSV(text)
  let norm = normalizeObjects(data)
  norm = adaptFromCustomSchema(norm)
  RAW = norm
  FEAT = engineerFeatures(RAW, {rollShort:document.getElementById('rollShort').value, rollLong:document.getElementById('rollLong').value})
  refreshLeagueFilter(FEAT)
  alert('Datos CSV cargados: '+FEAT.length+' filas.')
}

function handleJSON(text){
  let obj
  try{ obj = JSON.parse(text) }catch(e){ alert('JSON inválido.'); return }
  let arr = Array.isArray(obj)? obj : (obj && Array.isArray(obj.data)? obj.data : null)
  if(!arr){ alert('El JSON debe ser un array de partidos o {data:[...]}.'); return }
  let norm = normalizeObjects(arr)
  norm = adaptFromCustomSchema(norm)
  RAW = norm
  FEAT = engineerFeatures(RAW, {rollShort:document.getElementById('rollShort').value, rollLong:document.getElementById('rollLong').value})
  refreshLeagueFilter(FEAT)
  alert('Datos JSON cargados: '+FEAT.length+' filas.')
}

function loadAuto(text, name){
  const lower = (name||'').toLowerCase()
  if(lower.endsWith('.json')){ handleJSON(text); return }
  try{ const p=JSON.parse(text); if(Array.isArray(p) || (p && typeof p==='object')){ handleJSON(text); return } }catch(e){}
  handleCSV(text)
}

// ======= DEMOS =======
const DEMO_CSV = `Name,Desired Outcome,Odd,Date,League,Match,Home OnGoal Shots at FT,Away OnGoal Shots at FT,Result FT
Argentina Liga Profesional,1,1.53,vie., 28 jul. 2023 18:30,Argentina Liga Profesional de Fútbol,River Plate - Racing Club,6,4,2-1
`
const DEMO_JSON = [
  {"Name":"Argentina Liga Profesional","Desired Outcome":"1","Odd":"1.53","Date":"vie., 28 jul. 2023 18:30","League":"Argentina Liga Profesional de Fútbol","Match":"River Plate - Racing Club","Home OnGoal Shots at FT":"6","Away OnGoal Shots at FT":"4","Result FT":"2-1"}
]

// =================== PARTIDOS MANUALES (nuevo) ===================
function renderFixtures(){
  const tb = document.querySelector('#tblFixtures tbody')
  tb.innerHTML = MANUAL_FIXTURES.map((r,idx)=> `<tr>
    <td>${r.date||''}</td>
    <td>${r.league||''}</td>
    <td>${r.home||''} vs ${r.away||''}</td>
    <td class="knum">${r.odds_over25? Number(r.odds_over25).toFixed(2): '—'}</td>
    <td class="knum">${r.odds_btts? Number(r.odds_btts).toFixed(2): '—'}</td>
    <td><button class="btn warn" onclick="removeFixture(${idx})">Quitar</button></td>
  </tr>`).join('')
}

function removeFixture(idx){
  MANUAL_FIXTURES.splice(idx,1)
  // reconstruimos FEAT: histórico + manuales
  RAW = RAW.filter(r=> !r.__manualFixture).concat(MANUAL_FIXTURES)
  FEAT = engineerFeatures(RAW, {rollShort:document.getElementById('rollShort').value, rollLong:document.getElementById('rollLong').value})
  refreshLeagueFilter(FEAT)
  renderFixtures()
}

function addFixture(){
  const d = (document.getElementById('fiDate').value||'').trim()
  const l = (document.getElementById('fiLeague').value||'').trim()
  const h = (document.getElementById('fiHome').value||'').trim()
  const a = (document.getElementById('fiAway').value||'').trim()
  const oOver = document.getElementById('fiOver').value
  const oBTTS = document.getElementById('fiBTTS').value

  if(!d || !h || !a){ alert('Fecha, Local y Visitante son obligatorios.'); return }
  const row = {
    date: d, league: l, home: h, away: a,
    odds_over25: (oOver? Number(oOver): null),
    odds_btts: (oBTTS? Number(oBTTS): null),
    // sin resultado → futuros
    y_over25: null, y_btts: null,
    __manualFixture: true
  }
  MANUAL_FIXTURES.push(row)

  // FEAT = histórico + manuales (recalcular para construir features de forma)
  RAW = RAW.filter(r=> !r.__manualFixture).concat(MANUAL_FIXTURES)
  FEAT = engineerFeatures(RAW, {rollShort:document.getElementById('rollShort').value, rollLong:document.getElementById('rollLong').value})
  refreshLeagueFilter(FEAT)
  renderFixtures()

  // limpiar inputs mínimos
  // (conservamos liga por comodidad)
  document.getElementById('fiHome').value=''
  document.getElementById('fiAway').value=''
  document.getElementById('fiOver').value=''
  document.getElementById('fiBTTS').value=''
}

// =================== EVENTOS UI ===================
const fileInput = document.getElementById('file')
fileInput.addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return
  const fr = new FileReader(); fr.onload = ()=> loadAuto(fr.result, f.name); fr.readAsText(f)
})
document.getElementById('btnDemoCSV').addEventListener('click', ()=> handleCSV(DEMO_CSV))
document.getElementById('btnDemoJSON').addEventListener('click', ()=> handleJSON(JSON.stringify(DEMO_JSON)))
document.getElementById('btnEntrenar').addEventListener('click', trainAll)
document.getElementById('btnPicks').addEventListener('click', generatePicks)
document.getElementById('btnExport').addEventListener('click', exportCSV)
document.getElementById('btnAddFixture').addEventListener('click', addFixture)
</script>
</body>
</html>
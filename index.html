<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson - CV Decimal</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            background-color: #f4f4f9; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
        }
        .container { 
            background-color: #ffffff; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); 
            width: 100%; 
            max-width: 650px; 
            text-align: center; 
        }
        h1 { 
            color: #008080; 
            margin-bottom: 15px; 
            border-bottom: 3px solid #008080; 
            padding-bottom: 10px; 
            font-size: 2em; 
        }
        h2 { 
            color: #007bff; 
            margin-top: 25px; 
            padding-top: 15px; 
            border-top: 1px solid #eee; 
        }
        .input-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .input-row { 
            border: 1px solid #008080; 
            border-radius: 5px; 
            padding: 15px; 
        }
        .input-row h3 { 
            color: #008080; 
            border-bottom: 1px dashed #ccc; 
            padding-bottom: 5px; 
            margin-top: 0; 
        }
        .input-group { 
            margin-bottom: 10px; 
            text-align: left; 
        }
        .input-group label { 
            font-weight: bold; 
            display: block; 
            font-size: 0.9em; 
            margin-bottom: 2px; 
        }
        .input-group input { 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            width: 100%; 
            box-sizing: border-box; 
            text-align: center; 
        }
        button { 
            width: 80%; 
            padding: 12px; 
            background-color: #008080; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 18px; 
            cursor: pointer; 
            transition: background-color 0.3s ease; 
            margin-top: 10px; 
        }
        button:hover { 
            background-color: #006666; 
        }
        
        /* Resultados */
        #results { 
            margin-top: 30px; 
            border-top: 2px solid #eee; 
            padding-top: 20px; 
        }
        .rates-summary { 
            background-color: #e0ffff; 
            border: 1px solid #b2eaea; 
            color: #005656; 
            padding: 10px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
        }
        .market-section { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .result-box-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .result-box { 
            padding: 10px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .result-box.btts { 
            background-color: #d6eaff; 
            border: 2px solid #007bff; 
        }
        .result-box.ou { 
            background-color: #e0ffe0; 
            border: 2px solid #28a745; 
        }
        .result-value { 
            font-size: 1.4em; 
            font-weight: bold; 
        }
        
        /* Recomendación */
        #recommendation_section { 
            background-color: #fff3cd; 
            border: 2px solid #ffc107; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 20px; 
            text-align: left; 
        }
        #recommendation_section h3 { 
            color: #856404; 
            margin-top: 0; 
            border-bottom: 1px dashed #ffeeba; 
            padding-bottom: 5px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> ⚽ Calculadora Poisson Mínima (CV Decimal) </h1>
        <p>El $\lambda$ (Goles Esperados) es igual al GF. Ingrese el CV en formato decimal (e.g., **0.63**).</p>
           
        <div class="input-grid">
            <div class="input-row">
                <h3>Local</h3>
                <div class="input-group">
                    <label for="home_gf">Avg GF (Goles a Favor):</label>
                    <input type="number" id="home_gf" value="1.8" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="home_cv">CV (Factor de Variación):</label>
                    <input type="number" id="home_cv" value="0.35" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <h3>Visitante</h3>
                <div class="input-group">
                    <label for="away_gf">Avg GF (Goles a Favor):</label>
                    <input type="number" id="away_gf" value="1.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="away_cv">CV (Factor de Variación):</label>
                    <input type="number" id="away_cv" value="0.60" step="0.01" min="0">
                </div>
            </div>
        </div>

        <button onclick="calculateProbabilities()">Calcular Pronóstico y Recomendación</button>
        
        <div id="results">
            <h2>Resultados del Modelo Poisson</h2>

            <div class="rates-summary" id="calculated_rates_summary">
                $\lambda_{\text{Local}}$: 0.00 | $\lambda_{\text{Visita}}$: 0.00 | $\lambda_{\text{Total}}$: 0.00
            </div>
            
            <div class="market-section">
                <div class="market-results">
                    <h4>Mercado: Ambos Anotan (BTTS)</h4>
                    <div class="result-box-grid">
                        <div class="result-box btts">
                            <strong>BTTS SÍ</strong>
                            <div class="result-value" id="prob_btts_yes_td">0.00%</div>
                        </div>
                        <div class="result-box btts">
                            <strong>Cuota Implícita</strong>
                            <div class="result-value" id="odd_btts_yes_td">0.00</div>
                        </div>
                    </div>
                </div>

                <div class="market-results">
                    <h4>Mercado: Total de Goles (2.5)</h4>
                    <div class="result-box-grid">
                        <div class="result-box ou">
                            <strong>MÁS DE 2.5</strong>
                            <div class="result-value" id="prob_over_2_5_td">0.00%</div>
                        </div>
                        <div class="result-box ou">
                            <strong>Cuota Implícita</strong>
                            <div class="result-value" id="odd_over_2_5_td">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="recommendation_section">
                <h3>✨ Recomendación Estratégica Basada en CV</h3>
                <div class="cv-summary" id="cv_analysis"></div>
                <p id="recommendation_text" style="font-weight: bold;"></p>
            </div>
        </div>
    </div>

    <script>
        // Función de Poisson P(k, lambda)
        function poissonProbability(k, lambda) {
            if (k < 0 || lambda < 0) return 0;
            if (lambda === 0 && k > 0) return 0;
            if (lambda === 0 && k === 0) return 1;
            if (k === 0) {
                return Math.exp(-lambda); 
            }
            let factorial = 1;
            for (let i = 2; i <= k; i++) {
                factorial *= i;
            }
            return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial;
        }

        // Función para calcular BTTS y O/U para un par de lambdas
        function calculateMarketProbs(lambdaHome, lambdaAway) {
            const lambdaTotal = lambdaHome + lambdaAway;
            
            const probHomeZero = poissonProbability(0, lambdaHome);
            const probAwayZero = poissonProbability(0, lambdaAway);
            const probZeroZero = probHomeZero * probAwayZero; 
            const probBTTsNo = probHomeZero + probAwayZero - probZeroZero;
            const probBTTsYes = 1 - probBTTsNo;

            const probTotalZero = poissonProbability(0, lambdaTotal);
            const probTotalOne = poissonProbability(1, lambdaTotal);
            const probTotalTwo = poissonProbability(2, lambdaTotal);
            const probUnder2_5 = probTotalZero + probTotalOne + probTotalTwo;
            const probOver2_5 = 1 - probUnder2_5;

            return {
                lambdaHome: lambdaHome,
                lambdaAway: lambdaAway,
                lambdaTotal: lambdaTotal,
                bttsYes: probBTTsYes,
                over2_5: probOver2_5,
                under2_5: probUnder2_5
            };
        }
        
        // Función de formateo de resultados
        const format = (p) => (p * 100).toFixed(2) + '%';
        const formatOdd = (p) => (p > 0.005 ? (1 / p).toFixed(2) : '∞');
        
        // Función principal de cálculo
        function calculateProbabilities() {
            // 1. Obtener entradas del usuario
            const homeGF = parseFloat(document.getElementById('home_gf').value);
            const homeCV = parseFloat(document.getElementById('home_cv').value); // CV como decimal (e.g., 0.35)
            const awayGF = parseFloat(document.getElementById('away_gf').value);
            const awayCV = parseFloat(document.getElementById('away_cv').value); // CV como decimal (e.g., 0.60)
            
            // ASUNCIONES: lambda = GF
            const lambdaHome = homeGF;
            const lambdaAway = awayGF;
            
            // Validación
            if (isNaN(homeGF) || isNaN(homeCV) || isNaN(awayGF) || isNaN(awayCV) || homeGF < 0 || awayGF < 0 || homeCV < 0 || awayCV < 0) {
                alert('Por favor, introduce valores numéricos válidos y positivos.');
                return;
            }
            
            // 2. Calcular los mercados
            const results = calculateMarketProbs(lambdaHome, lambdaAway);

            // 3. Actualizar la Interfaz de Resultados
            document.getElementById('calculated_rates_summary').innerHTML = 
                `$\lambda_{\\text{Local}}$: ${results.lambdaHome.toFixed(3)} | 
                $\lambda_{\\text{Visita}}$: ${results.lambdaAway.toFixed(3)} | 
                $\lambda_{\\text{Total}}$: ${results.lambdaTotal.toFixed(3)}`;
            
            document.getElementById('prob_btts_yes_td').textContent = format(results.bttsYes);
            document.getElementById('odd_btts_yes_td').textContent = formatOdd(results.bttsYes);
            
            document.getElementById('prob_over_2_5_td').textContent = format(results.over2_5);
            document.getElementById('odd_over_2_5_td').textContent = formatOdd(results.over2_5);
            
            // 4. ANÁLISIS DE COEFICIENTE DE VARIACIÓN (CV)
            
            const cvMax = Math.max(homeCV, awayCV);
            
            let cvAnalysisText = `
                CV Local (GF): <strong>${(homeCV * 100).toFixed(1)}%</strong> 
                | CV Visitante (GF): <strong>${(awayCV * 100).toFixed(1)}%</strong>
                <br>
                *Nota: CV bajo (< 0.30) = Predecible; CV alto (> 0.50) = Impredecible.*
            `;

            let recommendation = "";
            let market = "";
            let probThreshold = 0.55; // Sigue siendo 55%
            
            // Determinar el pronóstico más probable
            if (results.bttsYes > results.over2_5) {
                market = "BTTS Sí";
            } else if (results.over2_5 > results.bttsYes) {
                market = "MÁS de 2.5";
            } else {
                market = "BTTS Sí / MÁS de 2.5 (Empate)";
            }
            
            let probMax = Math.max(results.bttsYes, results.over2_5);

            // Evaluar el riesgo con el CV (usando decimales)
            const highCV = cvMax > 0.50; // CV > 50%
            const lowCV = cvMax < 0.30;  // CV < 30%

            if (probMax >= probThreshold) {
                if (lowCV) {
                    recommendation = `⭐ **Pronóstico Fuerte y Consistente:** La probabilidad de **${market}** es del ${format(probMax)}. El CV bajo sugiere **alta confiabilidad**.`;
                } else if (highCV) {
                    recommendation = `⚠️ **Pronóstico con Riesgo de Variabilidad:** La probabilidad de **${market}** es del ${format(probMax)}. El CV alto sugiere que existe un **riesgo significativo de sorpresa**.`;
                } else {
                    recommendation = `✅ **Pronóstico Positivo:** La probabilidad de **${market}** es del ${format(probMax)}.`;
                }
            } else {
                recommendation = `Neutral. La probabilidad máxima calculada (${format(probMax)}) no supera nuestro umbral de confianza (${format(probThreshold)}). Se recomienda cautela.`;
            }

            document.getElementById('cv_analysis').innerHTML = cvAnalysisText;
            document.getElementById('recommendation_text').innerHTML = recommendation; 
        }

        // Ejecutar el cálculo al cargar la página con los valores por defecto
        document.addEventListener('DOMContentLoaded', calculateProbabilities);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Backtesting ROI por Equipo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f5f5f5; padding:20px; }
.card { background:white; padding:20px; border-radius:12px; 
        box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:25px; }
h2 { margin-bottom:15px; }
table { width:100%; border-collapse:collapse; }
th { background:#222; color:white; padding:8px; }
td { padding:6px; border:1px solid #ddd; text-align:center; }
button {
    background:#007BFF; border:none; padding:12px 20px;
    color:white; border-radius:10px; font-size:16px;
}
.good { color:green; font-weight:bold; }
.bad { color:red; font-weight:bold; }
.msg { padding:10px; background:#e8e8e8; border-radius:8px; margin-bottom:15px; }
</style>
</head>
<body>

<h1>üìä Backtesting ROI por Equipo</h1>

<div id="message" class="msg">Cargue los archivos para comenzar.</div>

<div class="card">
    <h2>üìÅ Cargar Historial</h2>
    <input type="file" id="historialFile" accept=".json">
</div>

<div class="card">
    <h2>üìÅ Cargar Partidos Futuros</h2>
    <input type="file" id="futurosFile" accept=".json">
</div>

<div class="card">
    <button id="runBtn">üîç Hacer Backtesting</button>
</div>

<div class="card">
    <h2>Resultados del Backtesting (por partido futuro)</h2>
    <table id="predictTable">
        <thead>
            <tr>
                <th>Partido</th>
                <th>ROI Local</th>
                <th>ROI Visitante</th>
                <th>Partidos Analizados</th>
                <th>Equipo M√°s Rentable</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
// Variables persistentes para Safari
let historialData = [];
let futurosData = [];

const msg = m => document.getElementById("message").innerText = m;

// Convierte JSON no est√°ndar a array v√°lido
function safeJSON(text) {
    try {
        if (!text.trim().startsWith("[")) {
            text = "[" + text.replace(/,\s*$/, "") + "]";
        }
        return JSON.parse(text);
    } catch (e) {
        msg("‚ùå Error al leer JSON. Revise el formato.");
        return null;
    }
}

// --- CARGA DE ARCHIVOS ---
document.getElementById("historialFile").addEventListener("change", e => {
    let file = e.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = ev => {
        let data = safeJSON(ev.target.result);
        if (data) {
            historialData = data;
            msg("‚úî Historial cargado correctamente.");
        }
    };
    reader.readAsText(file);
});

document.getElementById("futurosFile").addEventListener("change", e => {
    let file = e.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = ev => {
        let data = safeJSON(ev.target.result);
        if (data) {
            futurosData = data;
            msg("‚úî Partidos futuros cargados.");
        }
    };
    reader.readAsText(file);
});

// --- BOT√ìN ---
document.getElementById("runBtn").addEventListener("click", () => {
    if (!historialData.length || !futurosData.length) {
        msg("‚ö† Debe cargar los dos archivos antes de continuar.");
        return;
    }

    msg("Procesando Backtesting...");

    runBacktesting();

    msg("‚úî Backtesting completado.");
});

// --- FUNCI√ìN PRINCIPAL ---
function runBacktesting() {
    const tbody = document.querySelector("#predictTable tbody");
    tbody.innerHTML = "";

    futurosData.forEach(futureMatch => {
        const [home, away] = futureMatch.Match.split(" - ").map(t => t.trim());

        const homeStats = computeTeamROI(home);
        const awayStats = computeTeamROI(away);

        const best = (homeStats.roi > awayStats.roi)
            ? home
            : (awayStats.roi > homeStats.roi ? away : "Iguales");

        tbody.innerHTML += `
            <tr>
                <td>${futureMatch.Match}</td>
                <td class="${homeStats.roi >= 0 ? 'good' : 'bad'}">${homeStats.roi.toFixed(2)}%</td>
                <td class="${awayStats.roi >= 0 ? 'good' : 'bad'}">${awayStats.roi.toFixed(2)}%</td>
                <td>${homeStats.matches + awayStats.matches}</td>
                <td><b>${best}</b></td>
            </tr>
        `;
    });
}

// --- C√ÅLCULO DE ROI POR EQUIPO ---
function computeTeamROI(team) {
    let matches = 0;
    let profit = 0;

    historialData.forEach(m => {
        if (!m.Match || !m.Odd || !m.Result) return;

        const [home, away] = m.Match.split(" - ").map(t => t.trim());
        if (home !== team && away !== team) return;

        matches++;

        const gain = (m.Result === "Winning") ? (parseFloat(m.Odd) - 1) : -1;
        profit += gain;
    });

    return {
        matches,
        profit,
        roi: matches > 0 ? (profit / matches * 100) : 0
    };
}
</script>

</body>
</html>
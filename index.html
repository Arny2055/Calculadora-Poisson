<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JATCO-MAINT-AI ‚Äî Diagn√≥stico y Contramedidas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e6eaf2; --muted:#9aa3b2;
         --accent:#7aa2ff; --ok:#79e2a6; --warn:#ffb84d; --danger:#ff6b6b; --border:#2a3140; --focus:#b9ccff;}
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(15,17,21,.95), rgba(15,17,21,.65));border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{margin:0 0 4px;font-size:22px} .sub{color:var(--muted);font-size:13px}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  @media(max-width:1100px){.layout{grid-template-columns:1fr}}
  aside,section.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  h2{margin:0 0 10px;font-size:18px} h3{margin:12px 0 6px;font-size:16px}
  .grid{display:grid;gap:10px} .grid.two{grid-template-columns:1fr 1fr} .grid.three{grid-template-columns:repeat(3,1fr)}
  @media(max-width:980px){.grid.two,.grid.three{grid-template-columns:1fr}}
  label{font-size:12px;color:var(--muted)}
  input:not([type="file"]),select,textarea{width:100%;padding:10px 12px;background:#0c0f18;color:var(--text);border:1px solid var(--border);border-radius:10px;outline:none}
  textarea{min-height:100px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px #b9ccff22}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .btn{background:var(--panel2);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn:hover{border-color:var(--accent)} .btn-ok{background:var(--ok);color:#0b1020;border-color:transparent}
  .chipbar{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0c0f18;border:1px solid var(--border);cursor:pointer}
  .chip.active{background:#10192a;border-color:var(--focus);box-shadow:0 0 0 3px #b9ccff22 inset}
  pre{background:#0c0f18;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto}
  .pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#101521;border:1px solid var(--border);color:var(--muted);font-size:12px}
  .badge{font-weight:800;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
  .ok{background:#102017;color:#b7ffcc} .warn{background:#261c09;color:#ffddaa} .danger{background:#281214;color:#ffbdbd}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border)} th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;font-size:14px}
  th{background:#131824;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>JATCO-MAINT-AI ‚Äî Diagn√≥stico y Contramedidas</h1>
    <div class="sub">CNC FANUC/Gleason/ROBODRILL ¬∑ Honeadoras ¬∑ Tornos/Brochas ¬∑ Robots FANUC ¬∑ PLC Mitsubishi/Omron</div>
  </div>
</header>

<div class="layout wrap">
  <aside>
    <h2>Conexi√≥n LLM</h2>
    <div class="grid two">
      <div>
        <label>API Base (OpenAI-compatible)</label>
        <input id="apiBase" value="https://api.openai.com/v1">
      </div>
      <div>
        <label>Modelo</label>
        <input id="model" value="gpt-4o-mini">
      </div>
      <div>
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="sk-...">
      </div>
      <div>
        <label>Temperature</label>
        <input id="temp" type="number" min="0" max="1" step="0.1" value="0.2">
      </div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnTest">Probar conexi√≥n</button>
      <button class="btn" id="btnSaveConn">Guardar conexi√≥n local</button>
      <span class="pill">Tu clave se guarda solo en este navegador (localStorage).</span>
    </div>

    <h2 style="margin-top:14px">Caso de falla</h2>
    <div class="grid two">
      <div><label>Equipo (tipo + marca/modelo)</label><input id="equipo" placeholder="CNC FANUC 0i-MF / ROBODRILL / GLEASON"></div>
      <div><label>Ubicaci√≥n / L√≠nea / Turno</label><input id="ubic" placeholder="L√≠nea 2 ¬∑ Estaci√≥n 5 ¬∑ Noche"></div>
    </div>
    <div>
      <label>Descripci√≥n breve</label>
      <textarea id="desc" placeholder="¬øQu√© pas√≥? ¬øPatr√≥n? ¬øFrecuencia?"></textarea>
    </div>

    <h3>S√≠ntomas</h3>
    <div id="symptoms" class="chipbar"></div>

    <h3 style="margin-top:6px">Cambios recientes</h3>
    <div class="chipbar" id="changes"></div>

    <div class="grid two" style="margin-top:6px">
      <div><label>Alarmas / C√≥digos / I/O</label><input id="alarmas" placeholder="SRVO-xxx, PMC, DI: X7, Overtravel‚Ä¶"></div>
      <div><label>Condiciones de proceso</label><input id="cond" placeholder="avances/velocidad/presi√≥n/temperatura"></div>
    </div>

    <div class="toolbar" style="margin-top:10px">
      <button class="btn-ok" id="btnDiagnosticar">üß† Generar diagn√≥stico</button>
      <button class="btn" id="btnLimpiar">Limpiar</button>
    </div>
  </aside>

  <main>
    <section class="card">
      <h2>Resultado del modelo</h2>
      <div id="status" class="pill">Listo</div>
      <h3 style="margin-top:10px">Explicaci√≥n</h3>
      <div id="texto" style="white-space:pre-wrap;line-height:1.4"></div>

      <h3 style="margin-top:10px">JSON estructurado</h3>
      <pre id="jsonView">{}</pre>

      <h3 style="margin-top:10px">Checklist (vista r√°pida)</h3>
      <table id="checkTable">
        <thead><tr><th>Tarea</th><th>Responsable</th><th>Fecha</th><th>Estatus</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
        <button class="btn" id="btnExport">Exportar JSON</button>
        <label class="btn" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
          Importar JSON
          <input id="impJson" type="file" accept="application/json" style="display:none">
        </label>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Prompt de sistema (JATCO-MAINT-AI)</h2>
      <details>
        <summary class="pill">Ver/ocultar</summary>
        <pre id="sysPrompt"></pre>
      </details>
    </section>
  </main>
</div>

<footer class="wrap" style="color:#9aa3b2;font-size:12px">
  ‚ö†Ô∏è Seguridad primero: aplica LOTO y procedimientos de la planta JATCO antes de intervenir cualquier equipo.
</footer>

<script>
/* ====== Chips base ====== */
const SYMPTOMS = [
  'EMI/ruido','intermitencia','sobrecorriente','sobretemperatura','vibraci√≥n','desalineo/holgura',
  'no detecta/sin se√±al','falsos positivos','carrera incompleta/atoro','fuga aire/aceite',
  'fallo I/O PLC/Fieldbus','sobrecarga servo/spindle','sobretravel','herramienta fuera de posici√≥n',
  'pieza fuera de tolerancia','mala calidad superficial','chaveteo/barridos','cavitaci√≥n','baja presi√≥n'
];
const CHANGES = ['setup reciente','mantenimiento reciente','proveedor/material nuevo','firmware/param cambiado','ajuste de proceso','cables potencia cercanos','ambiente h√∫medo/aceite'];

/* ====== System Prompt (lo que nos diste) ====== */
const SYSTEM_PROMPT = `
Eres "JATCO-MAINT-AI", un ingeniero de mantenimiento industrial digital para JATCO (automotriz). Tu objetivo: 
(1) Diagnosticar fallas con evidencia, (2) proponer acciones inmediatas de contenci√≥n, 
(3) acciones correctivas hacia causa ra√≠z, y (4) contramedidas definitivas (permanentes) 
alineadas a manufactura automotriz, seguridad y calidad.

### √ÅMBITO Y EQUIPOS (JATCO)
- CNC: FANUC (series 0i/30i/31i/32i), ROBODRILL, GLEASON (corte/rectificado engranes).
- M√°quinas: honeadoras (honing), tornos, brochadoras.
- Robots: FANUC (R-30iA/B/iB+).
- PLC: Mitsubishi (FX/Q/iQ), Omron (CJ/CS/NX).
- Perif√©ricos: VFD, unidades servo/Spindle, sistemas de visi√≥n, hidr√°ulico/neum√°tico, sistemas de refrigeraci√≥n/lubricaci√≥n.

### CUANDO CONTESTES
- Pide solo los datos estrictamente necesarios si faltan (m√°x. 5 preguntas). 
- Da respuestas accionables y priorizadas. Evita teor√≠a excesiva.
- Separa SIEMPRE en: Contenci√≥n inmediata, Correcci√≥n (causa ra√≠z), Contramedidas definitivas, Riesgo/FMEA r√°pido, Checklist y Repuestos.
- Incluye seguridad (LOTO, E-Stop, resguardo) antes de intervenir.
- Si hay riesgo de da√±o a personas/equipo, se√±aliza ‚ÄúPARO SEGURO‚Äù.

### ENTRADA ESPERADA (input del usuario)
Estructura flexible, pero intenta obtener (si no viene):
- activo/equipo (tipo + marca/modelo), ubicaci√≥n/l√≠nea, turno.
- s√≠ntomas observados (qu√©/patr√≥n: continuo/intermitente/frecuencia).
- cambios recientes (setup, proveedor, mantenimiento, firmware).
- alarmas/c√≥digos (CNC/robot/PLC), se√±ales I/O afectadas.
- condiciones de proceso (velocidad/avance/presi√≥n/temperatura).
- evidencias: fotos, tendencias, vibraci√≥n/corriente, firmas de soldadura, etc.

### TAXONOM√çA DE S√çNTOMAS (usa como etiquetas)
EMI/ruido ‚Ä¢ intermitencia ‚Ä¢ sobrecorriente ‚Ä¢ sobretemperatura ‚Ä¢ vibraci√≥n ‚Ä¢ desalineo/holgura ‚Ä¢ 
no detecta/sin se√±al ‚Ä¢ falsos positivos ‚Ä¢ carrera incompleta/atoro ‚Ä¢ fuga aire/aceite ‚Ä¢ 
fallo I/O PLC/Fieldbus ‚Ä¢ sobrecarga servo/spindle ‚Ä¢ sobretravel ‚Ä¢ herramienta fuera de posici√≥n ‚Ä¢ 
pieza fuera de tolerancia ‚Ä¢ mala calidad superficial ‚Ä¢ chaveteo/barridos ‚Ä¢ cavitaci√≥n ‚Ä¢ baja presi√≥n.

### REGLAS/HEUR√çSTICAS POR EQUIPO (resumen operativo)
- FANUC CNC / ROBODRILL:
  ‚Ä¢ Alarmas t√≠picas: servo 401/414, spindle 12xx, OT/OT+/- (overtravel), PMC I/O, 910/911 (bater√≠a/param), 100/101 (program/seq).
  ‚Ä¢ Chequeos r√°pidos: E-Stop y cadenas de seguridad; alimentaci√≥n trif√°sica; LEDs servo amp; par√°metros alterados; backlash/comp; lubricaci√≥n husillos; aire seco.
  ‚Ä¢ I/O/EMI: Segregar mazos se√±al/potencia, ferritas, tierra √∫nica; revisar conectores M12; debounce en PMC.
- GLEASON (engranes):
  ‚Ä¢ Calidad fluctuante: temperatura aceite, rigidez/fixturas, desgaste muela/rodillos, alineaci√≥n ejes, backlash y vibraci√≥n.
  ‚Ä¢ Enfriamiento/filtraci√≥n: pureza y caudal; dressing programado; trazas SPC.
- Honeadoras:
  ‚Ä¢ Ovalidad/cono/superficie: presi√≥n y caudal de aceite/honing, condici√≥n piedra, gu√≠as; temperatura pieza/fluido; flushing de viruta.
- Tornos/Brochadoras:
  ‚Ä¢ Desalineo y rebaba: gu√≠as/contrapunto, torque herramientas; fijaci√≥n pieza; vibraci√≥n; presi√≥n hidr√°ulica; avance/corte; lubricaci√≥n.
- Robots FANUC:
  ‚Ä¢ Faults SRVO-xxx, INTP-xxx, MOTN-xxx: revisar frenos, mastering, payload, colisiones blandas, cableado ejes; ruido EMI cerca de cables potencia.
- PLC Mitsubishi/Omron:
  ‚Ä¢ I/O intermitente: earthing √∫nico; separaci√≥n rutas; filtros en salidas anal√≥gicas; diagn√≥sticos (error codes, watchdog); revisar temporizadores/scan.

### FORMATO DE RESPUESTA (obligatorio)
Devuelve SIEMPRE adem√°s de tu texto una estructura JSON al final (para que una app pueda leerla).
Campos obligatorios:

{
  "equipo": "<tipo + marca/modelo>",
  "riesgo": "OK | PARO SEGURO",
  "hipotesis_causa_raiz": ["...", "..."],
  "acciones_inmediatas": ["...", "..."],
  "acciones_correctivas": ["...", "..."],
  "contramedidas_definitivas": ["...", "..."],
  "fmea_rapido": { "S": 1-10, "O": 1-10, "D": 1-10, "RPN": "S*O*D", "ideas_bajar_RPN": ["..."] },
  "checklist": [
    {"tarea":"...", "resp":"...", "fecha":"YYYY-MM-DD", "estatus":"Pendiente|En curso|Hecha"}
  ],
  "repuestos_sugeridos": ["c√≥digo_fanuc_xxx", "sensor_M12_IP67", "filtro_EMI_linea", "sellos_FKM", "piedra_honing_xxx"],
  "datos_faltantes": ["...", "..."]
}
`;

/* ====== UI Helpers ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function chipify(container, items){
  container.innerHTML='';
  items.forEach(txt=>{
    const el=document.createElement('span');
    el.className='chip'; el.textContent=txt;
    el.onclick=()=> el.classList.toggle('active');
    container.appendChild(el);
  });
}
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',background:'#111725',color:'#e6eaf2',padding:'10px 12px',border:'1px solid var(--border)',borderRadius:'10px',zIndex:9999});
  document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
}
function getChips(container){ return $$(container+' .chip.active').map(x=>x.textContent); }
function saveConn(){ localStorage.setItem('jatco_conn', JSON.stringify({apiBase:$('#apiBase').value, apiKey:$('#apiKey').value, model:$('#model').value, temp:$('#temp').value})); toast('Conexi√≥n guardada'); }
function loadConn(){ const raw=localStorage.getItem('jatco_conn'); if(!raw) return; try{const j=JSON.parse(raw); $('#apiBase').value=j.apiBase||$('#apiBase').value; $('#apiKey').value=j.apiKey||''; $('#model').value=j.model||$('#model').value; $('#temp').value=j.temp||'0.2';}catch{} }
function setStatus(txt, cls=''){ const el=$('#status'); el.textContent=txt; el.className='pill ' + cls; }

/* ====== Build user message ====== */
function buildUserInput(){
  const equipo=$('#equipo').value.trim();
  const ubic=$('#ubic').value.trim();
  const desc=$('#desc').value.trim();
  const sintomas=getChips('#symptoms');
  const cambios=getChips('#changes');
  const alarmas=$('#alarmas').value.trim();
  const cond=$('#cond').value.trim();
  return `
Empresa: JATCO.
Equipo: ${equipo||'(no indicado)'}.
Ubicaci√≥n/Turno: ${ubic||'(no indicado)'}.
Descripci√≥n: ${desc||'(no indicado)'}.
S√≠ntomas: ${sintomas.join(', ')||'(no indicado)'}.
Cambios recientes: ${cambios.join(', ')||'(no indicado)'}.
Alarmas / I/O: ${alarmas||'(no indicado)'}.
Condiciones de proceso: ${cond||'(no indicado)'}.

Responde siguiendo exactamente las secciones y el JSON especificado en el system prompt.`;
}

/* ====== Call LLM ====== */
async function callLLM(){
  try{
    setStatus('Consultando modelo‚Ä¶');
    const apiBase=$('#apiBase').value.trim().replace(/\/$/,'');
    const apiKey=$('#apiKey').value.trim();
    const model=$('#model').value.trim();
    const temperature=parseFloat($('#temp').value||'0.2');

    if(!apiBase || !model) throw new Error('Falta API Base o modelo');
    if(apiBase.includes('openai.com') && !apiKey) throw new Error('Falta API Key');

    const body={
      model,
      temperature,
      messages:[
        {role:'system', content:SYSTEM_PROMPT},
        {role:'user', content:buildUserInput()}
      ]
    };

    const r = await fetch(apiBase + '/chat/completions', {
      method:'POST',
      headers:{'Content-Type':'application/json', ...(apiKey? {'Authorization':'Bearer '+apiKey}:{})},
      body: JSON.stringify(body)
    });
    if(!r.ok){
      const err=await r.json().catch(()=>({}));
      throw new Error(err.error?.message || (r.status+' '+r.statusText));
    }
    const j = await r.json();
    const txt = j.choices?.[0]?.message?.content || '';
    $('#texto').textContent = txt;
    parseAndRenderJSON(txt);
    setStatus('Hecho','ok');
  }catch(e){
    setStatus('Error: ' + e.message,'danger');
  }
}

/* ====== Parse JSON from model answer ====== */
function parseAndRenderJSON(text){
  let found=null;
  // 1) intenta bloque ```json ... ```
  const codeBlock = text.match(/```json([\s\S]*?)```/i);
  if(codeBlock){ try{ found = JSON.parse(codeBlock[1].trim()); }catch{} }
  // 2) si no, intenta encontrar el √∫ltimo {...} grande
  if(!found){
    const lastBrace = text.lastIndexOf('{');
    if(lastBrace>=0){ const maybe = text.slice(lastBrace); try{ found = JSON.parse(maybe); }catch{} }
  }
  // 3) render
  if(found){
    $('#jsonView').textContent = JSON.stringify(found, null, 2);
    renderChecklist(found.checklist||[]);
  }else{
    $('#jsonView').textContent = '{}';
    renderChecklist([]);
  }
}
function renderChecklist(items){
  const tb=$('#checkTable tbody'); tb.innerHTML='';
  (items||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${escapeHTML(r.tarea||'')}</td><td>${escapeHTML(r.resp||'')}</td><td>${escapeHTML(r.fecha||'')}</td><td>${escapeHTML(r.estatus||'')}</td>`;
    tb.appendChild(tr);
  });
}
function escapeHTML(s){ return (''+s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ====== Export / Import ====== */
function exportJSON(){
  const blob=new Blob([$('#jsonView').textContent||'{}'],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='jatco_maint_result.json'; a.click(); URL.revokeObjectURL(a.href);
}
function importJSON(file){
  const rdr=new FileReader();
  rdr.onload=()=>{ try{ const obj=JSON.parse(rdr.result); $('#jsonView').textContent=JSON.stringify(obj,null,2); renderChecklist(obj.checklist||[]); toast('Importado'); }catch(e){ alert('JSON inv√°lido: '+e.message); } };
  rdr.readAsText(file);
}

/* ====== Init ====== */
function init(){
  chipify($('#symptoms'), SYMPTOMS);
  chipify($('#changes'), CHANGES);
  $('#sysPrompt').textContent = SYSTEM_PROMPT.trim();
  loadConn();
  // events
  $('#btnDiagnosticar').onclick=callLLM;
  $('#btnTest').onclick=()=>{ saveConn(); setStatus('Conexi√≥n guardada. Haz una prueba con un caso.','ok'); };
  $('#btnSaveConn').onclick=saveConn;
  $('#btnLimpiar').onclick=()=>{ ['equipo','ubic','desc','alarmas','cond'].forEach(id=> document.getElementById(id).value=''); $$('#symptoms .chip, #changes .chip').forEach(c=>c.classList.remove('active')); $('#texto').textContent=''; $('#jsonView').textContent='{}'; $('#checkTable tbody').innerHTML=''; setStatus('Listo'); };
  $('#btnExport').onclick=exportJSON;
  $('#impJson').addEventListener('change',e=>{ const f=e.target.files[0]; if(f) importJSON(f); });
}
init();
</script>
</body>
</html>
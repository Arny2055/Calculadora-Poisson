<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rentabilidad por Mercado (últimos 10 por rol)</title>
<style>
  :root{
    --bg:#0a0f1c; --card:#121826; --panel:#1a2333; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#3b82f6; --green:#10b981; --red:#ef4444; --amber:#f59e0b; --line:#263143;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px}
  h1{color:#e5e7eb;text-align:center;margin:8px 0 16px}
  .card{background:var(--card);border-radius:14px;padding:16px;margin:16px 0;border:1px solid var(--line)}
  label{display:block;margin:8px 0 6px;color:var(--muted)}
  select,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1726;color:#e5e7eb;font-size:16px}
  button{background:var(--accent);border-color:var(--accent);font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .row{display:grid;gap:10px}
  @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.95rem}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--line)}
  th{background:#0f1726;color:#cbd5e1;font-weight:600}
  tr:last-child td{border-bottom:0}

  .badge{display:inline-block;min-width:52px;text-align:center;padding:3px 8px;border-radius:999px;font-weight:700;color:#fff}
  .b-green{background:var(--green)} .b-amber{background:var(--amber)} .b-red{background:var(--red)}
  #status{margin-top:8px;font-size:.92rem;color:var(--muted)}
  #status.ok{color:var(--green)} #status.err{color:var(--red)}
</style>
</head>
<body>
  <h1>Rentabilidad por Mercado</h1>

  <div class="card">
    <input type="file" id="fileInput" accept=".json,.txt">

    <div class="row" style="margin-top:10px">
      <div>
        <label>Selecciona Liga</label>
        <select id="leagueSelect"></select>
      </div>
      <div>
        <label>Equipo Local</label>
        <select id="homeSelect"></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Equipo Visitante</label>
        <select id="awaySelect"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="analyzeBtn">Analizar</button>
      </div>
    </div>

    <div id="status" class="muted"></div>
  </div>

  <div id="results"></div>

<script>
/* ================== Estado ================== */
let allRows = [];

/* ================== Utils ================== */
function setStatus(msg, ok=false, err=false){
  const el=document.getElementById('status');
  el.textContent=msg||''; el.classList.remove('ok','err');
  if(ok) el.classList.add('ok'); if(err) el.classList.add('err');
}
function toNum(v){ return (v===null||v===undefined||v==='') ? null : Number(v); }
function tryParseJSON(text){
  // Soporta array JSON o “objetos sueltos” separados por comas
  try { return JSON.parse(text); } catch(e){}
  const wrapped="["+text.trim()
    .replace(/(^,)|(,$)/g,"")
    .replace(/\n+/g,"\n")
    .replace(/\}\s*,\s*\{/g,"},{")+"]";
  try { return JSON.parse(wrapped); } catch(e2){ return []; }
}
function splitTeams(s){
  if(typeof s!=='string') return [null,null];
  const p=s.split(/\s+-\s+|\s+vs\.?\s+|\s+v\s+/i);
  if(p.length>=2) return [p[0].trim(), p[1].trim()];
  return [null,null];
}
/* Fecha flexible ES */
function parseDateFlexible(v){
  if(v===null||v===undefined||v==='') return null;
  if(typeof v==='number'){ if(v>1e12) return v; if(v>1e9) return v*1000; return null; }
  if(typeof v!=='string') return null;
  let s=v.trim();
  s=s.replace(/^(lun|mar|mi[eé]|jue|vie|s[aá]b|dom)\.?,?\s*/i,'');
  const d=Date.parse(s); if(!isNaN(d)) return d;
  // dd/mm/yyyy HH:mm
  let m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2}))?$/);
  if(m){ let dd=+m[1], MM=(+m[2])-1, yy=+m[3]; if(yy<100) yy+=2000; let hh=+(m[4]||0), mi=+(m[5]||0); return new Date(yy,MM,dd,hh,mi,0).getTime(); }
  // dd mes yyyy HH:mm
  const months={ene:'01',feb:'02',mar:'03',abr:'04',may:'05',jun:'06',jul:'07',ago:'08',sep:'09',sept:'09',set:'09',oct:'10',nov:'11',dic:'12'};
  m=s.match(/^(\d{1,2})\s+([a-záéíóúñ\.]+)\s+(\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/i);
  if(m){
    let dd=+m[1], mon=(m[2]||'').toLowerCase().replace(/\./g,'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    let yy=+m[3]; if(yy<100) yy+=2000; let hh=+(m[4]||0), mi=+(m[5]||0);
    const MM=months[mon]; if(MM) return new Date(`${yy}-${MM}-${String(dd).padStart(2,'0')}T${String(hh).padStart(2,'0')}:${String(mi).padStart(2,'0')}:00`).getTime();
  }
  return null;
}

/* ================== Normalización ================== */
function normalizeMarket(name, desired){
  const src = (name || desired || '').toString().toLowerCase().replace(/\s+/g,' ').trim();

  // BTTS Yes
  if(/btts/.test(src) && /(yes|si|sí)/.test(src)) return 'BTTS_Y';
  if(/both\s*teams\s*to\s*score/.test(src) && /(yes|si|sí)/.test(src)) return 'BTTS_Y';
  if(/gg/.test(src) && /(yes|si|sí)/.test(src)) return 'BTTS_Y';

  // Over 1.5 HT
  if(/\+?\s*1[.,]?5\s*ht\b/.test(src)) return 'O15_HT';
  if(/(1st|first)\s*half.*over\s*1[.,]?5/.test(src)) return 'O15_HT';
  if(/over\s*1[.,]?5.*(ht|1h|1st|first\s*half)/.test(src)) return 'O15_HT';
  if(/\bo(?:ver)?\s*1[.,]?5\s*(ht|1h)\b/.test(src)) return 'O15_HT';

  // Over 2.5 FT (por defecto FT si no dice HT)
  if(/\bo(?:ver)?\s*2[.,]?5\b/.test(src) || /\bo\s*25\b/.test(src) || /over_?2_?5/.test(src)) return 'O25_FT';

  // Over 3.5 FT
  if(/\bo(?:ver)?\s*3[.,]?5\b/.test(src) || /\bo\s*35\b/.test(src) || /over_?3_?5/.test(src)) return 'O35_FT';

  return null;
}

function normalizeRow(m, idx){
  const league=(m.League||'').toString().trim();
  const match=(m.Match||'').toString().trim();
  const [home, away]=splitTeams(match);
  const ts=parseDateFlexible(m.Date);
  const odd=toNum(m.Odd);
  const result=(m.Result||'').toString().toLowerCase();
  let outcome=null; // +1 win, -1 lose
  if(/win|ganad|✔/.test(result)) outcome=+1;
  else if(/lose|perd|✘/.test(result)) outcome=-1;

  const market = normalizeMarket(m.Name, m['Desired Outcome']);

  return { idx, league, match, home, away, ts, odd, outcome, market };
}

/* ================== Core ================== */
function lastByRole(rows, team, role, limit=10){
  const arr = rows.filter(r=> role==='home' ? r.home===team : r.away===team)
    .sort((a,b)=>{
      if(a.ts && b.ts) return a.ts - b.ts;
      if(a.ts && !b.ts) return 1;
      if(!a.ts && b.ts) return -1;
      return a.idx - b.idx;
    });
  return arr.slice(-limit);
}

function computePnLForRoleMarket(rows, team, role, marketKey){
  // últimos 10 por rol y luego filtrar mercado
  const last = lastByRole(rows, team, role, 10).filter(r => r.market === marketKey);

  let considered=0, hits=0, fails=0, profit=0, sumOdds=0;
  last.forEach(r=>{
    if(r.odd && r.odd>1 && r.outcome!==null){
      considered++; sumOdds += r.odd;
      if(r.outcome>0){ hits++; profit += (r.odd - 1); }
      else { fails++; profit -= 1; }
    }
  });
  const avgOdd = considered ? (sumOdds/considered) : 0;
  const roi = considered ? (profit/considered)*100 : 0;

  return {
    played: last.length,
    considered, hits, fails,
    avgOdd, profit, roi
  };
}

function clsBadge(p){ return p>=0 ? 'b-green' : 'b-red'; }

/* ================== Render ================== */
function renderMarketTable(title, homeTeam, awayTeam, homeRes, awayRes){
  const row = (team, role, R) => `
    <tr>
      <td style="text-align:left">${team}</td>
      <td>${role}</td>
      <td>${R.played}</td>
      <td>${R.considered}</td>
      <td>${R.hits}</td>
      <td>${R.fails}</td>
      <td>${R.avgOdd ? R.avgOdd.toFixed(2) : '—'}</td>
      <td style="font-weight:700; color:${R.profit>=0?'#10b981':'#ef4444'}">${R.profit.toFixed(2)}</td>
      <td><span class="badge ${R.roi>=0?'b-green':'b-red'}">${R.roi.toFixed(1)}%</span></td>
    </tr>`;

  return `
    <div class="card" style="background:var(--panel)">
      <h3>Rentabilidad ${title} (últimos 10 por rol · stake 1u)</h3>
      <table>
        <tr>
          <th style="text-align:left">Equipo</th><th>Rol</th><th>Jugados</th><th>Considerados</th>
          <th>Hits</th><th>Fails</th><th>Odd media</th><th>Profit (u)</th><th>ROI</th>
        </tr>
        ${row(homeTeam, 'HOME', homeRes)}
        ${row(awayTeam, 'AWAY', awayRes)}
      </table>
    </div>
  `;
}

/* ================== Eventos UI ================== */
document.getElementById("fileInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file){ setStatus('No se seleccionó archivo.', false, true); return; }
  const rd=new FileReader();
  rd.onload=ev=>{
    const raw=tryParseJSON(ev.target.result);
    if(!Array.isArray(raw) || raw.length===0){ setStatus('No se pudo leer JSON o está vacío.', false, true); return; }

    allRows = raw.map((m,idx)=>normalizeRow(m,idx))
                 .filter(r=>r.league && r.home && r.away && r.market); // requerimos mercado reconocido

    if(!allRows.length){ setStatus('No hay registros válidos (Liga/Match/Mercado).', false, true); return; }

    const leagues=[...new Set(allRows.map(r=>r.league))].sort();
    document.getElementById("leagueSelect").innerHTML = "<option value=''>--Selecciona--</option>" + leagues.map(l=>`<option>${l}</option>`).join("");

    // limpia selects
    document.getElementById("homeSelect").innerHTML = "";
    document.getElementById("awaySelect").innerHTML = "";

    setStatus(`Cargados ${allRows.length} registros · ${leagues.length} ligas`, true, false);
  };
  rd.readAsText(file);
});

document.getElementById("leagueSelect").addEventListener("change", function(){
  const league=this.value;
  const leagueRows=allRows.filter(r=>r.league===league);
  const teams=[...new Set(leagueRows.flatMap(r=>[r.home,r.away]))].sort();
  const opts=teams.map(t=>`<option>${t}</option>`).join("");
  document.getElementById("homeSelect").innerHTML = opts;
  document.getElementById("awaySelect").innerHTML = opts;
  setStatus(league?`Liga: ${league} · ${leagueRows.length} registros`:'');
});

document.getElementById("analyzeBtn").addEventListener("click", ()=>{
  const league=document.getElementById("leagueSelect").value;
  const homeTeam=document.getElementById("homeSelect").value;
  const awayTeam=document.getElementById("awaySelect").value;

  if(!allRows.length){ setStatus('Primero carga un archivo.', false, true); return; }
  if(!league){ setStatus('Selecciona liga.', false, true); return; }
  if(!homeTeam || !awayTeam || homeTeam===awayTeam){ setStatus('Selecciona equipos válidos (distintos).', false, true); return; }

  const leagueRows = allRows.filter(r=>r.league===league);

  // Mercados solicitados
  const MARKETS = [
    {key:'O25_FT', title:'O2.5'},
    {key:'O35_FT', title:'O3.5'},
    {key:'BTTS_Y', title:'BTTS Yes'},
    {key:'O15_HT', title:'Over 1.5 HT'}
  ];

  const sections = MARKETS.map(M=>{
    const homeRes = computePnLForRoleMarket(leagueRows, homeTeam, 'home', M.key);
    const awayRes = computePnLForRoleMarket(leagueRows, awayTeam, 'away', M.key);
    return renderMarketTable(M.title, homeTeam, awayTeam, homeRes, awayRes);
  }).join("");

  document.getElementById("results").innerHTML = sections;

  setStatus(`OK · ${homeTeam} HOME · ${awayTeam} AWAY — Liga ${league}`, true, false);
});
</script>
</body>
</html>
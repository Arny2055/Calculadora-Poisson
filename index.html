<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Poisson + Monte Carlo + Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* --- Base --- */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: #0e0e0e;
      color: #f0f0f0;
    }
    .container { max-width: 1100px; margin: auto; padding: 30px; }

    /* --- Header --- */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      background: #1b1b1b; padding: 15px 25px; border-radius: 12px;
      margin-bottom: 25px; box-shadow: 0 0 25px rgba(0, 255, 20, 0.4);
    }
    .header img { width: 60px; filter: drop-shadow(0 0 6px #39FF14); }
    .header h2 { margin: 0; color: #39FF14; font-weight: 600; letter-spacing: 1.2px; }
    .header button {
      background-color: #2c2c2c; color: #f0f0f0;
      border: 1px solid #39FF14; border-radius: 8px; padding: 8px 14px;
      cursor: pointer; font-weight: 600; transition: 0.3s;
    }
    .header button:hover { background-color: #39FF14; color: #000; }

    /* --- Inputs y botones --- */
    .inputs { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    input, select, button {
      padding: 8px; font-size: 14px; background: #2c2c2c;
      color: #f0f0f0; border: 1px solid #444; border-radius: 6px; transition: 0.3s;
    }
    input:focus, select:focus { border-color: #39FF14; outline: none; }
    button { background-color: #333; border: none; cursor: pointer; font-weight: 600; }
    button:hover { background-color: #39FF14; color: #000; }
    .small-input { width: 60px; text-align: center; }

    /* --- Tabla --- */
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
    th, td { padding: 8px; border: 1px solid #333; text-align: center; }
    th { background: #1f1f1f; font-weight: 600; }
    td { background: #151515; }
    tr.highlight td { background-color: rgba(57, 255, 20, 0.15) !important; font-weight: 600; }

    /* --- NotificaciÃ³n --- */
    #notificacion {
      position: fixed; bottom: 20px; right: 20px; background: #39FF14; color: #000;
      padding: 12px 20px; border-radius: 8px; font-weight: 600; opacity: 0;
      transition: 0.4s; pointer-events: none;
    }
    #notificacion.visible { opacity: 1; }
  </style>
</head>
<body>
  <div class="container">

    <!-- =================== CALCULADORA ORIGINAL =================== -->
    <div class="header">
      <div style="display:flex; align-items:center; gap:15px;">
        <img src="https://cdn-icons-png.flaticon.com/512/287/287221.png" alt="Logo" />
        <h2>Calculadora Poisson + Monte Carlo</h2>
      </div>
      <div style="display:flex; gap:10px;">
        <button onclick="agregarAlHistorial()">âž• Agregar al historial</button>
        <button onclick="exportarHistorial()">â¬‡ Exportar historial</button>
        <button onclick="borrarHistorial()">ðŸ—‘ Borrar historial</button>
      </div>
    </div>

    <div class="inputs">
      <input type="text" id="nombreLocal" placeholder="Equipo Local" style="flex:1;" />
      <input type="number" id="golesLocal" placeholder="Promedio Local" step="0.01" />
      <input type="text" id="nombreVisita" placeholder="Equipo Visitante" style="flex:1;" />
      <input type="number" id="golesVisita" placeholder="Promedio Visita" step="0.01" />
      <input type="number" id="bankroll" placeholder="Bankroll ($)" step="0.01" value="100" />
      <input type="number" id="simulaciones" placeholder="Simulaciones" value="10000" />
      <button onclick="calcular()">Calcular</button>
    </div>

    <div id="resultado"></div>
  </div>

  <!-- =================== POISSON LIVE =================== -->
  <div class="container" style="margin-top:40px;">
    <div class="header">
      <div style="display:flex; align-items:center; gap:15px;">
        <img src="https://cdn-icons-png.flaticon.com/512/287/287221.png" alt="Logo Live" />
        <h2>Poisson Live âš¡</h2>
      </div>
    </div>

    <div class="inputs">
      <input type="number" id="minutoLive" placeholder="Minuto actual (0-90)" min="0" max="90" />
      <input type="number" id="marcadorLocal" placeholder="Goles Local" min="0" />
      <input type="number" id="marcadorVisita" placeholder="Goles Visitante" min="0" />
      <button onclick="calcularLive()">Calcular En Vivo</button>
    </div>

    <div id="resultadoLive"></div>
  </div>

  <div id="notificacion"></div>

  <script>
    /* ================= FUNCIONES BASE ================= */
    const factorial=n=>n<=1?1:n*factorial(n-1);
    const poisson=(k,lambda)=>(Math.pow(lambda,k)*Math.exp(-lambda))/factorial(k);
    const cuotaImplicita=p=>p>0?(1/p).toFixed(2):"-";
    const samplePoisson=lambda=>{
      let L=Math.exp(-lambda),k=0,p=1;
      do{ k++; p*=Math.random(); }while(p>L);
      return k-1;
    };
    function mostrarNotificacion(msg){
      const n=document.getElementById("notificacion");
      n.textContent=msg; n.classList.add("visible");
      setTimeout(()=>n.classList.remove("visible"),2500);
    }

    /* ================= HISTORIAL ================= */
    function agregarAlHistorial(datosExtra=[]){
      calcular();
      const tabla = document.querySelector("#resultado table");
      if(!tabla) return mostrarNotificacion("âš  No hay datos para agregar al historial.");
      const filas = [...tabla.querySelectorAll("tr")].slice(1); // Sin encabezado
      const historial = JSON.parse(localStorage.getItem("poissonHistorial"))||[];
      filas.forEach(f=>{
        const cols = [...f.querySelectorAll("td")].map(td=>td.innerText);
        historial.push([...cols,...datosExtra]);
      });
      localStorage.setItem("poissonHistorial",JSON.stringify(historial));
      mostrarNotificacion("âœ… Datos agregados al historial");
    }
    function exportarHistorial(){
      const historial=JSON.parse(localStorage.getItem("poissonHistorial"))||[];
      if(!historial.length) return mostrarNotificacion("âš  No hay historial para exportar");
      const csv="Grupo,OpciÃ³n,Prob %,Cuota ImplÃ­cita,Extra\n"+historial.map(r=>r.join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="historial_poisson.csv";
      a.click();
    }
    function borrarHistorial(){
      if(confirm("Â¿Seguro que quieres borrar todo el historial?")){
        localStorage.removeItem("poissonHistorial");
        mostrarNotificacion("ðŸ—‘ Historial borrado");
      }
    }

    /* ================= CALCULADORA ORIGINAL ================= */
    function calcular(){
      const lambdaL=parseFloat(document.getElementById("golesLocal").value);
      const lambdaV=parseFloat(document.getElementById("golesVisita").value);
      if(isNaN(lambdaL)||isNaN(lambdaV)) return;
      const maxGoals=5;
      const pLocal=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaL));
      const pVisita=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaV));
      let winL=0,draw=0,winV=0;
      let under={0.5:0,1.5:0,2.5:0,3.5:0};
      const thresholds=[0.5,1.5,2.5,3.5];

      for(let i=0;i<=maxGoals;i++){
        for(let j=0;j<=maxGoals;j++){
          const joint=pLocal[i]*pVisita[j];
          if(i>j) winL+=joint; else if(i===j) draw+=joint; else winV+=joint;
          thresholds.forEach(th=>{ if(i+j<=th) under[th]+=joint; });
        }
      }
      const overs=thresholds.map(th=>1-under[th]);

      let html=`<table>
        <tr><th>Grupo</th><th>OpciÃ³n</th><th>Poisson %</th><th>Cuota ImplÃ­cita</th></tr>`;
      [["1X2 âš½",[document.getElementById("nombreLocal").value,"Empate",document.getElementById("nombreVisita").value],[winL,draw,winV]],
       ["Over/Under ðŸŽ¯",thresholds.map(t=>`Over ${t}`),overs]
      ].forEach(([grupo,labels,probs])=>{
        labels.forEach((label,idx)=>{
          html+=`<tr><td>${grupo}</td><td>${label}</td>
                 <td>${(probs[idx]*100).toFixed(2)}</td>
                 <td>${cuotaImplicita(probs[idx])}</td></tr>`;
        });
      });
      html+="</table>";
      document.getElementById("resultado").innerHTML=html;
    }

    /* ================= POISSON LIVE ================= */
    function calcularLive(){
      const minuto = parseInt(document.getElementById("minutoLive").value);
      const golesActualL = parseInt(document.getElementById("marcadorLocal").value);
      const golesActualV = parseInt(document.getElementById("marcadorVisita").value);
      const lambdaL = parseFloat(document.getElementById("golesLocal").value);
      const lambdaV = parseFloat(document.getElementById("golesVisita").value);
      const sims = parseInt(document.getElementById("simulaciones").value);

      if(isNaN(minuto)||isNaN(golesActualL)||isNaN(golesActualV)||isNaN(lambdaL)||isNaN(lambdaV)) return;

      const minutosRestantes = Math.max(0,90-minuto);
      const factorTiempo = minutosRestantes/90;
      const lambdaRestL = lambdaL*factorTiempo;
      const lambdaRestV = lambdaV*factorTiempo;

      const maxGoals = 5;
      const pLocal=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaRestL));
      const pVisita=Array.from({length:maxGoals+1},(_,i)=>poisson(i,lambdaRestV));

      let winL=0,draw=0,winV=0;
      let under={0.5:0,1.5:0,2.5:0,3.5:0};
      const thresholds=[0.5,1.5,2.5,3.5];

      for(let i=0;i<=maxGoals;i++){
        for(let j=0;j<=maxGoals;j++){
          const joint=pLocal[i]*pVisita[j];
          const totalL = golesActualL+i;
          const totalV = golesActualV+j;
          if(totalL>totalV) winL+=joint; else if(totalL===totalV) draw+=joint; else winV+=joint;
          thresholds.forEach(th=>{ if(totalL+totalV<=th) under[th]+=joint; });
        }
      }
      const overs=thresholds.map(th=>1-under[th]);

      // Monte Carlo Live
      let mcWinL=0,mcDraw=0,mcWinV=0;
      let mcOvers=[0,0,0,0];
      for(let s=0;s<sims;s++){
        const gL=samplePoisson(lambdaRestL);
        const gV=samplePoisson(lambdaRestV);
        const totalL = golesActualL+gL;
        const totalV = golesActualV+gV;
        if(totalL>totalV) mcWinL++; else if(totalL===totalV) mcDraw++; else mcWinV++;
        thresholds.forEach((th,idx)=>{ if(totalL+totalV>th) mcOvers[idx]++; });
      }

      const probPoisson=[winL,draw,winV];
      const probMC=[mcWinL,mcDraw,mcWinV].map(x=>x/sims);
      const probOversPoisson=overs;
      const probOversMC=mcOvers.map(x=>x/sims);

      let html=`<table>
        <tr><th>Grupo</th><th>OpciÃ³n</th><th>Poisson %</th><th>MC %</th><th>Cuota ImplÃ­cita</th></tr>`;
      [["1X2 âš½",[document.getElementById("nombreLocal").value,"Empate",document.getElementById("nombreVisita").value],probPoisson,probMC],
       ["Over/Under ðŸŽ¯",thresholds.map(t=>`Over ${t}`),probOversPoisson,probOversMC]
      ].forEach(([grupo,labels,probs,probsMC])=>{
        labels.forEach((label,idx)=>{
          html+=`<tr><td>${grupo}</td><td>${label}</td>
                 <td>${(probs[idx]*100).toFixed(2)}</td>
                 <td>${(probsMC[idx]*100).toFixed(2)}</td>
                 <td>${cuotaImplicita(probs[idx])}</td></tr>`;
        });
      });
      html+="</table>";
      document.getElementById("resultadoLive").innerHTML=html;

      // Guardar en historial en vivo
      const historial=JSON.parse(localStorage.getItem("poissonHistorial"))||[];
      const timeStamp = new Date().toLocaleTimeString();
      const filas = document.querySelectorAll("#resultadoLive table tr");
      [...filas].slice(1).forEach(f=>{
        const cols=[...f.querySelectorAll("td")].map(td=>td.innerText);
        historial.push([...cols,`Live ${timeStamp}`]);
      });
      localStorage.setItem("poissonHistorial",JSON.stringify(historial));
    }

    // ================= AUTO-ACTUALIZACIÃ“N LIVE CADA 10 SEGUNDOS =================
    setInterval(calcularLive, 10000);
  </script>
</body>
</html>
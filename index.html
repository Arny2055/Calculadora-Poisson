<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estadísticas Over/Under — Pro</title>
<style>
  :root{
    --bg:#0a0f1c; --card:#121826; --panel:#1a2333; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#3b82f6; --green:#10b981; --amber:#f59e0b; --red:#ef4444; --line:#263143;
    --cyan:#22d3ee; --violet:#a78bfa; --lime:#84cc16;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(0deg,rgba(10,15,28,0),rgba(10,15,28,.9) 40%,rgba(10,15,28,1));padding:16px 16px 8px}
  h1{color:var(--accent);text-align:center;margin:0 0 8px}
  .wrap{padding:0 16px 16px}

  .card{background:var(--card);border-radius:14px;padding:16px;margin:16px 0;border:3px solid transparent;transition:.2s border-color, .2s transform}
  .card:hover{transform:translateY(-1px)}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-size:.95rem}
  select,input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1726;color:var(--text);font-size:16px}
  button{background:var(--accent);border-color:var(--accent);font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.05)}

  .row{display:grid;gap:10px}
  @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
  .controls{display:grid;gap:12px}
  @media(min-width:900px){.controls{grid-template-columns:2fr 1fr}}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .tab{flex:1;min-width:110px;background:#0f1726;border:1px solid var(--line);color:var(--muted);padding:10px;border-radius:10px;cursor:pointer;text-align:center}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:700}

  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  @media(min-width:1100px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr}}

  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h3{margin:0 0 10px;font-size:1.05rem;color:#cbd5e1}
  .kv{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed var(--line)}
  .kv:last-child{border-bottom:0}
  .muted{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums}
  .badge{display:inline-block;min-width:52px;text-align:center;padding:3px 8px;border-radius:999px;font-weight:700;color:#fff}
  .b-green{background:var(--green)} .b-amber{background:var(--amber)} .b-red{background:var(--red)}
  .b-soft{background:#0f1726;border:1px solid var(--line);color:#cbd5e1}
  .divider{height:1px;background:var(--line);margin:8px 0;border-radius:1px}

  table{width:100%;border-collapse:collapse;font-size:.95rem;margin-top:8px;overflow:hidden;border-radius:10px;border:1px solid var(--line)}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--line)}
  th{background:#0f1726;color:#cbd5e1;font-weight:600}
  tr:last-child td{border-bottom:0}

  /* Pills + sparkline */
  .pills{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:900px){.pills{grid-template-columns:repeat(3,1fr)}}
  .pill{position:relative;background:#0f1726;border:1px solid var(--line);border-radius:18px;padding:12px 12px 6px;text-align:center;min-height:88px;display:flex;flex-direction:column;justify-content:space-between;gap:6px;box-shadow:inset 0 -3px 0 0 rgba(255,255,255,0.06)}
  .pill .big{font-weight:800;font-size:1.05rem}
  .pill .caption{color:#cbd5e1;font-weight:600}
  .pill.ok{outline:2px solid var(--green)} .pill.warn{outline:2px solid var(--amber)} .pill.bad{outline:2px solid var(--red)}
  .spark{width:100%;height:30px}
  .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.cyan{background:var(--cyan)} .dot.violet{background:var(--violet)} .dot.lime{background:var(--lime)}

  /* Bars for value vs odds */
  .bar{height:10px;background:#0f1726;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%}
  .bar .model{background:linear-gradient(90deg,var(--green),#34d399)}
  .bar .implied{background:linear-gradient(90deg,var(--red),#f87171)}

  .small{font-size:.88rem}
</style>
</head>
<body>
<header>
  <h1>Estadísticas Over/Under</h1>
  <div class="wrap controls card" style="margin:0">
    <div class="row">
      <div>
        <label>Sube tu archivo</label>
        <input type="file" id="fileInput" accept=".json,.txt" />
      </div>
      <div>
        <label>Selecciona Liga</label>
        <select id="leagueSelect"></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Equipo Local</label>
        <select id="homeSelect"></select>
      </div>
      <div>
        <label>Equipo Visitante</label>
        <select id="awaySelect"></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Odd Over 2.5</label>
        <input type="number" id="oddOver" step="0.01" placeholder="1.90" />
      </div>
      <div>
        <label>Odd Under 2.5</label>
        <input type="number" id="oddUnder" step="0.01" placeholder="2.00" />
      </div>
    </div>

    <div class="row">
      <div class="panel">
        <h3 class="small" style="margin-bottom:6px">Ajustes</h3>
        <div class="row">
          <div>
            <label class="small">Tamaño de muestra <span id="nLabel">10</span></label>
            <input type="range" id="nRange" min="5" max="20" value="10" />
          </div>
          <div>
            <label class="small">Peso recencia <span id="alphaLabel">0.60</span></label>
            <input type="range" id="alphaRange" min="0" max="1" step="0.05" value="0.60" />
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:10px;align-items:center">
          <input id="h2h" type="checkbox" />
          <label for="h2h" class="small" style="margin:0">Modo H2H (solo enfrentamientos directos)</label>
          <div style="flex:1"></div>
          <button id="analyzeBtn" style="max-width:180px">Analizar</button>
          <button id="exportBtn" style="max-width:180px;background:#0f1726;border-color:var(--line)">Exportar PNG</button>
        </div>
        <div class="tabs" id="tabs" style="margin-top:10px">
          <div class="tab active" data-period="FT">Full Time</div>
          <div class="tab" data-period="1H">First Half</div>
          <div class="tab" data-period="2H">Second Half</div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="results" class="card"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
let allMatches = [];
let currentPeriod = "FT";
let SAMPLE_N = 10;
let ALPHA = 0.60; // pondera más lo reciente
const LINES = [0.5,1.5,2.5,3.5]; // ← agrega/quita líneas aquí

/* ---------- Utils ---------- */
function tryParseJSON(text){
  try { return JSON.parse(text); } catch(e){}
  const wrapped = "[" + text.trim().replace(/(^,)|(,$)/g,"").replace(/\n+/g,"\n").replace(/\}\s*,\s*\{/g,"},{") + "]";
  try { return JSON.parse(wrapped); } catch(e2){ return []; }
}
function pct(a,b){ return b ? Math.round((a/b)*100) : 0; }
function cls(p){ return p>=70?"b-green":(p>=50?"b-amber":"b-red"); }
function badge(p){ return `<span class="badge ${cls(p)}">${p}%</span>`; }
function parseScore(txt){ if(!txt) return [0,0]; const m = txt.split("-").map(x=>parseInt(x,10)); return [m[0]||0,m[1]||0]; }
function periodGoals(m){
  const [hHT,aHT] = parseScore(m["Result HT"]); const [hFT,aFT] = parseScore(m["Result FT"]);
  if(currentPeriod==="FT") return [hFT,aFT];
  if(currentPeriod==="1H") return [hHT,aHT];
  return [(hFT-hHT),(aFT-aHT)];
}
function weightAt(i,len){ const f = 1 + ALPHA*1.5; return Math.pow(f, i); }
function selectSample(list){ return list.slice(-SAMPLE_N); }

/* ---------- Filtros ---------- */
function lastByRole(matches, team, role){
  const arr = matches.filter(m=>{
    const [h,a]=m.Match.split(" - ");
    return role==="home"? h===team : a===team;
  });
  return selectSample(arr);
}
function h2hMatches(matches, homeTeam, awayTeam){
  return selectSample(matches.filter(m=>{
    const [h,a] = m.Match.split(" - ");
    return (h===homeTeam && a===awayTeam) || (h===awayTeam && a===homeTeam);
  }));
}

/* ---------- Métricas ponderadas ---------- */
function weightedPercentOver(list, line){
  const len = list.length; if(!len) return 0;
  let wsum=0, hit=0;
  for(let i=0;i<len;i++){
    const [h,a]=periodGoals(list[i]);
    const w = weightAt(i, len);
    wsum += w; if(h+a>line) hit += w;
  }
  return Math.round((hit/wsum)*100);
}
function weightedBTTS(list){
  const len = list.length; if(!len) return 0;
  let wsum=0, hit=0;
  for(let i=0;i<len;i++){
    const [h,a]=periodGoals(list[i]);
    const w = weightAt(i, len);
    wsum += w; if(h>0 && a>0) hit += w;
  }
  return Math.round((hit/wsum)*100);
}
function teamAverages(list, team){
  let s=0,c=0,t=0,ws=0; const len=list.length;
  for(let i=0;i<len;i++){
    const m=list[i]; const w=weightAt(i,len);
    const [home,away]=m.Match.split(" - "); const [h,a]=periodGoals(m);
    const forTeam=(team===home)?h:(team===away)?a:null; const opp=(team===home)?a:(team===away)?h:null;
    if(forTeam==null) continue; s+=forTeam*w; c+=opp*w; t+=(forTeam+opp)*w; ws+=w;
  }
  if(!ws) return {avgScored:"0.0",avgConceded:"0.0",avgGoals:"0.0"};
  return {avgScored:(s/ws).toFixed(1), avgConceded:(c/ws).toFixed(1), avgGoals:(t/ws).toFixed(1)};
}
function avgCornersFT(list){
  let s=0, ws=0; const len=list.length;
  for(let i=0;i<len;i++){
    const m=list[i]; const w=weightAt(i,len);
    const c = Number(m["Home Corners at FT"]||0)+Number(m["Away Corners at FT"]||0);
    if(!isNaN(c)){ s+=c*w; ws+=w; }
  }
  return ws? (s/ws) : 0;
}
function secondHalfGoalsTotal(list){
  let s=0, ws=0; const len=list.length;
  for(let i=0;i<len;i++){
    const m=list[i]; const w=weightAt(i,len);
    const [hHT,aHT]=parseScore(m["Result HT"]); const [hFT,aFT]=parseScore(m["Result FT"]);
    s += ((hFT-hHT)+(aFT-aHT))*w; ws+=w;
  }
  return Math.round(ws? s/ws : 0);
}

/* ---------- Bloques ---------- */
function calcTeamBlock(matches, team, role){
  const last = lastByRole(matches, team, role); const len=last.length;
  let noScore=0, noConcede=0, s=0,c=0,t=0,ws=0;
  for(let i=0;i<len;i++){
    const m=last[i]; const w=weightAt(i,len);
    const [home,away]=m.Match.split(" - "); const [h,a]=periodGoals(m);
    const forTeam=(team===home)?h:(team===away)?a:null; const opp=(team===home)?a:(team===away)?h:null;
    if(forTeam==null) continue; if(forTeam===0) noScore+=w; if(opp===0) noConcede+=w; s+=forTeam*w; c+=opp*w; t+=(forTeam+opp)*w; ws+=w;
  }
  return {
    n:len, last,
    avgScored: ws?(s/ws).toFixed(1):"0.0",
    avgConceded: ws?(c/ws).toFixed(1):"0.0",
    avgGoals: ws?(t/ws).toFixed(1):"0.0",
    pNoScore: ws? Math.round((noScore/ws)*100):0,
    pNoConcede: ws? Math.round((noConcede/ws)*100):0
  };
}
function renderTeamPanel(title, stats){
  return `
  <div class="panel">
    <h3>${title}</h3>
    <div class="kv"><span class="muted">Avg. Scored</span><span class="mono">${stats.avgScored}</span></div>
    <div class="kv"><span class="muted">Avg. Suffer</span><span class="mono">${stats.avgConceded}</span></div>
    <div class="kv"><span class="muted">Avg. Goals</span><span class="mono">${stats.avgGoals}</span></div>
    <div class="divider"></div>
    <div class="kv"><span>Games without Scoring</span><span><span class="badge ${cls(stats.pNoScore)}">${stats.pNoScore}%</span></span></div>
    <div class="kv"><span>Games without Conceding</span><span><span class="badge ${cls(stats.pNoConcede)}">${stats.pNoConcede}%</span></span></div>
  </div>`;
}

/* Summary (con BTTS debajo del Over 3.5) */
function renderSummaryTable(hLast, aLast){
  const h = { o05: weightedPercentOver(hLast,0.5), o15: weightedPercentOver(hLast,1.5), o25: weightedPercentOver(hLast,2.5), o35: weightedPercentOver(hLast,3.5), btts: weightedBTTS(hLast) };
  const a = { o05: weightedPercentOver(aLast,0.5), o15: weightedPercentOver(aLast,1.5), o25: weightedPercentOver(aLast,2.5), o35: weightedPercentOver(aLast,3.5), btts: weightedBTTS(aLast) };
  const avg=(x,y)=>Math.round((x+y)/2);
  const row=(label,hv,av,mv)=>`<tr><td>${label}</td><td>${badge(hv)}</td><td>${badge(av)}</td><td><span class="badge ${cls(mv)}">${mv}%</span></td></tr>`;
  return `
    <div class="panel">
      <h3>Summary</h3>
      <table>
        <tr><th></th><th>Home</th><th>Away</th><th>Match</th></tr>
        ${row('Over 0.5',h.o05,a.o05,avg(h.o05,a.o05))}
        ${row('Over 1.5',h.o15,a.o15,avg(h.o15,a.o15))}
        ${row('Over 2.5',h.o25,a.o25,avg(h.o25,a.o25))}
        ${row('Over 3.5',h.o35,a.o35,avg(h.o35,a.o35))}
        ${row('BTTS',h.btts,a.btts,avg(h.btts,a.btts))}
      </table>
    </div>`;
}

/* Markets con líneas (Over/Under por línea) */
function renderMarkets(hLast, aLast){
  const avg = (x,y)=>Math.round((x+y)/2);
  const rowsOver = LINES.map(L=>{
    const h=weightedPercentOver(hLast,L), a=weightedPercentOver(aLast,L), m=avg(h,a);
    return `<tr><td>Over ${L}</td><td>${badge(h)}</td><td>${badge(a)}</td><td><span class="badge ${cls(m)}">${m}%</span></td></tr>`;
  }).join("");
  const rowsUnder = LINES.map(L=>{
    const h=100-weightedPercentOver(hLast,L), a=100-weightedPercentOver(aLast,L), m=avg(h,a);
    return `<tr><td>Under ${L}</td><td>${badge(h)}</td><td>${badge(a)}</td><td><span class="badge ${cls(m)}">${m}%</span></td></tr>`;
  }).join("");

  return `
  <div class="panel">
    <h3>Markets (con líneas)</h3>
    <table>
      <tr><th></th><th>Home</th><th>Away</th><th>Match</th></tr>
      ${rowsOver}
      ${rowsUnder}
    </table>
  </div>`;
}

/* Sparklines helpers */
function buildSeries(hLast,aLast){
  const len = Math.min(hLast.length, aLast.length);
  const H = hLast.slice(-len), A=aLast.slice(-len);
  const seq = (fn)=>{ const out=[]; for(let i=0;i<len;i++){ out.push(fn(H[i],A[i],i,len)); } return out; };
  return {
    o25: seq((m1,m2)=> ( ((periodGoals(m1).reduce((x,y)=>x+y)>2.5)?1:0)+((periodGoals(m2).reduce((x,y)=>x+y)>2.5)?1:0) )/2 *100 ),
    o15: seq((m1,m2)=> ( ((periodGoals(m1).reduce((x,y)=>x+y)>1.5)?1:0)+((periodGoals(m2).reduce((x,y)=>x+y)>1.5)?1:0) )/2 *100 ),
    btts: seq((m1,m2)=> {const [h1,a1]=periodGoals(m1); const [h2,a2]=periodGoals(m2); return ((h1>0&&a1>0?1:0)+(h2>0&&a2>0?1:0))/2*100;}),
    goals: seq((m1,m2)=> {const [h1,a1]=periodGoals(m1); const [h2,a2]=periodGoals(m2); return (h1+h2+a1+a2)/2;}),
    corners: seq((m1,m2)=> {const c1=Number(m1["Home Corners at FT"]||0)+Number(m1["Away Corners at FT"]||0); const c2=Number(m2["Home Corners at FT"]||0)+Number(m2["Away Corners at FT"]||0); return (c1+c2)/2;}),
    g76: seq((m1,m2)=> {const [hHT1,aHT1]=parseScore(m1["Result HT"]); const [hFT1,aFT1]=parseScore(m1["Result FT"]); const [hHT2,aHT2]=parseScore(m2["Result HT"]); const [hFT2,aFT2]=parseScore(m2["Result FT"]); return ((hFT1-hHT1+aFT1-aHT1)+(hFT2-hHT2+aFT2-aHT2))/2;})
  };
}
function drawSpark(canvas, series, color){
  if(!canvas) return;
  const dpr=window.devicePixelRatio||1, w=canvas.clientWidth, h=canvas.clientHeight;
  canvas.width=Math.round(w*dpr); canvas.height=Math.round(h*dpr);
  const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr); ctx.clearRect(0,0,w,h);
  if(!series || series.length===0) return;
  let min=Math.min(...series), max=Math.max(...series); if(min===max){min-=1;max+=1;}
  const nx=i=> (i/(series.length-1))*(w-4)+2, ny=v=> h-2 - ((v-min)/(max-min))*(h-6);
  ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=color;
  for(let i=0;i<series.length;i++){ const x=nx(i), y=ny(series[i]); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }
  ctx.stroke(); ctx.lineTo(nx(series.length-1),h-2); ctx.lineTo(2,h-2); ctx.closePath(); ctx.fillStyle=color.replace('1)', '.12)'); ctx.fill();
  const lx=nx(series.length-1), ly=ny(series[series.length-1]); ctx.beginPath(); ctx.arc(lx,ly,2.5,0,Math.PI*2); ctx.fillStyle=color; ctx.fill();
}

/* Game Predictions */
function predictionsBlock(homeTeam, awayTeam, hLast, aLast){
  const pO25 = Math.round((weightedPercentOver(hLast,2.5)+weightedPercentOver(aLast,2.5))/2);
  const pO15 = Math.round((weightedPercentOver(hLast,1.5)+weightedPercentOver(aLast,1.5))/2);
  const pBTTS = Math.round((weightedBTTS(hLast)+weightedBTTS(aLast))/2);
  const hAvg = teamAverages(hLast, homeTeam); const aAvg = teamAverages(aLast, awayTeam);
  const expGoals = Math.round((parseFloat(hAvg.avgScored)+parseFloat(aAvg.avgScored)));
  const avgCorners = Math.round((avgCornersFT(hLast) + avgCornersFT(aLast))/2);
  const shGoals = secondHalfGoalsTotal(hLast) + secondHalfGoalsTotal(aLast);
  const klass = p => p>=70?'ok':(p>=50?'warn':'bad');

  const S = buildSeries(hLast,aLast);
  const pill = (key, big, caption, kls='')=>`
    <div class="pill ${kls}">
      <div class="big">${big}</div>
      <div class="caption">${caption}</div>
      <canvas class="spark" data-key="${key}"></canvas>
    </div>`;

  const html = `
    <div class="panel">
      <h3>Game Predictions</h3>
      <div class="legend small" style="margin:-2px 0 8px">
        <span class="dot cyan"></span><span class="muted">Over</span>
        <span class="dot violet"></span><span class="muted">BTTS</span>
        <span class="dot lime"></span><span class="muted">Volumen</span>
      </div>
      <div class="pills">
        ${pill('o25', pO25+'%', 'Over 2.5FT', klass(pO25))}
        ${pill('o15', pO15+'%', 'Over 1.5FT', klass(pO15))}
        ${pill('btts', pBTTS+'%', 'BTTS', klass(pBTTS))}
        ${pill('goals', expGoals, 'Goals')}
        ${pill('corners', avgCorners, 'Corners')}
        ${pill('g76', shGoals, 'Goals @ 76-FT')}
      </div>
    </div>`;
  setTimeout(()=>{
    document.querySelectorAll('.spark').forEach(cv=>{
      const key=cv.dataset.key;
      const color = key==='btts' ? 'rgba(167,139,250,1)'   // violet
                  : (key==='goals'||key==='corners'||key==='g76') ? 'rgba(132,204,22,1)' // lime
                  : 'rgba(34,211,238,1)'; // cyan for Overs
      drawSpark(cv, S[key], color);
    });
  },0);
  return html;
}

/* Value bars */
function valueBars(prob, odd, label){
  if(!odd || odd<=1) return `<div class="muted small">Ingresa cuota para ${label}</div>`;
  const implied = Math.round(100/odd);
  const modelW = Math.min(100,prob), impW = Math.min(100,implied);
  return `
    <div class="small" style="margin-bottom:6px"><strong>${label}</strong> · Modelo ${prob}% vs Implícita ${implied}% (odd ${odd})</div>
    <div class="bar"><span class="model" style="width:${modelW}%"></span></div>
    <div class="bar" style="margin-top:6px"><span class="implied" style="width:${impW}%"></span></div>
  `;
}

/* ---------- Carga ---------- */
document.getElementById("fileInput").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const rd = new FileReader();
  rd.onload = ev=>{
    allMatches = tryParseJSON(ev.target.result).map(m=>({
      ...m,
      League: m.League || m.league || "",
      Match: m.Match || m.match || "",
      "Result HT": m["Result HT"] || m.result_ht || m.ht || "0-0",
      "Result FT": m["Result FT"] || m.result_ft || m.ft || "0-0",
      "Home Corners at FT": m["Home Corners at FT"]||0,
      "Away Corners at FT": m["Away Corners at FT"]||0
    }));
    const leagues = [...new Set(allMatches.map(m=>m.League).filter(Boolean))].sort();
    document.getElementById("leagueSelect").innerHTML = "<option value=''>--Selecciona--</option>" + leagues.map(l=>`<option>${l}</option>`).join("");
  };
  rd.readAsText(file);
});

/* Selects dependientes */
document.getElementById("leagueSelect").addEventListener("change", function(){
  const league = this.value;
  const leagueMatches = allMatches.filter(m=>m.League===league);
  const teams = [...new Set(leagueMatches.flatMap(m=>m.Match.split(" - ")))].sort();
  document.getElementById("homeSelect").innerHTML = teams.map(t=>`<option>${t}</option>`).join("");
  document.getElementById("awaySelect").innerHTML = teams.map(t=>`<option>${t}</option>`).join("");
});

/* Tabs */
document.getElementById("tabs").addEventListener("click", (e)=>{
  const t=e.target.closest(".tab"); if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active"); currentPeriod=t.dataset.period;
});

/* Sliders */
const nRange=document.getElementById("nRange"), alphaRange=document.getElementById("alphaRange");
nRange.addEventListener("input",()=>{SAMPLE_N=+nRange.value;document.getElementById("nLabel").textContent=SAMPLE_N;});
alphaRange.addEventListener("input",()=>{ALPHA=+alphaRange.value;document.getElementById("alphaLabel").textContent=ALPHA.toFixed(2);});

/* Export PNG */
document.getElementById("exportBtn").addEventListener("click",()=>{
  const node=document.getElementById("results");
  html2canvas(node,{backgroundColor:null,scale:2}).then(canvas=>{
    const link=document.createElement('a');
    link.download='dashboard.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  });
});

/* Analizar */
document.getElementById("analyzeBtn").addEventListener("click", ()=>{
  const league = document.getElementById("leagueSelect").value;
  const homeTeam = document.getElementById("homeSelect").value;
  const awayTeam = document.getElementById("awaySelect").value;
  const oddOver = parseFloat(document.getElementById("oddOver").value);
  const oddUnder = parseFloat(document.getElementById("oddUnder").value);
  const useH2H = document.getElementById("h2h").checked;

  if(!league || !homeTeam || !awayTeam || homeTeam===awayTeam){ alert("Selecciona liga y equipos (distintos)."); return; }

  const leagueMatches = allMatches.filter(m=>m.League===league);
  const hAll = useH2H ? h2hMatches(leagueMatches, homeTeam, awayTeam) : lastByRole(leagueMatches, homeTeam, "home");
  const aAll = useH2H ? h2hMatches(leagueMatches, homeTeam, awayTeam).filter(m=>m.Match.endsWith(` - ${awayTeam}`) || m.Match.startsWith(`${awayTeam} - `)) : lastByRole(leagueMatches, awayTeam, "away");

  const homeStats = calcTeamBlock(leagueMatches, homeTeam, "home");
  const awayStats = calcTeamBlock(leagueMatches, awayTeam, "away");

  // Bloques
  const summary = renderSummaryTable(hAll, aAll);
  const markets = renderMarkets(hAll, aAll);   // ← nuevo panel con líneas
  const preds = predictionsBlock(homeTeam, awayTeam, hAll, aAll);

  // Value bars para 2.5
  const matchOver25 = Math.round((weightedPercentOver(hAll,2.5)+weightedPercentOver(aAll,2.5))/2);

  const res = document.getElementById("results");
  res.innerHTML = `
    <div class="kv"><span class="muted">Periodo</span><span class="badge b-soft">${currentPeriod}</span></div>
    <div class="kv"><span class="muted">Muestra</span><span class="badge b-soft">${SAMPLE_N} partidos · α=${ALPHA.toFixed(2)} ${useH2H?'· H2H':''}</span></div>
    <div class="divider"></div>
    <div class="grid cols-2">
      ${renderTeamPanel(homeTeam, homeStats)}
      ${renderTeamPanel(awayTeam, awayStats)}
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      ${summary}
      ${markets}
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      ${preds}
      <div class="panel">
        <h3>Value vs Odds (2.5)</h3>
        ${valueBars(matchOver25, oddOver, 'Over 2.5')}
        <div style="height:8px"></div>
        ${valueBars(100-matchOver25, oddUnder, 'Under 2.5')}
      </div>
    </div>
  `;
  // Borde del panel por O2.5 (match)
  if (matchOver25 >= 70) res.style.borderColor = "var(--green)";
  else if (matchOver25 >= 50) res.style.borderColor = "var(--amber)";
  else res.style.borderColor = "var(--red)";
});
</script>
</body>
</html>
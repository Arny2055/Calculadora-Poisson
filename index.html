<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Poisson (sin CV) + Factor Sorpresa — 1X2, DNB, OU, BTTS</title>
<style>
  :root{--bg:#0f1115;--panel:#171a21;--text:#e8ecf3;--muted:#9aa3b2;--accent:#7aa2ff;--border:#2a3140}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid var(--border);background:#0c0e13}
  h1{font-size:18px;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  label{font-size:13px;color:var(--muted);display:block;margin:10px 0 4px}
  input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#12151c;color:var(--text)}
  input[type=range]{accent-color:#7aa2ff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{margin-top:14px;background:var(--accent);border:0;border-radius:10px;padding:12px 14px;color:#0b0f18;font-weight:700;cursor:pointer;width:100%}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  th:first-child,td:first-child{text-align:left}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;font-size:13px}
  .pill{padding:6px 10px;border-radius:999px;background:#12151c;border:1px solid var(--border);color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  small{color:var(--muted)}
</style>
</head>
<body>
<header><h1>Poisson (sin CV) con Factor Sorpresa</h1></header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Entradas por sede (medias por partido)</h3>

      <div class="row">
        <div>
          <label>GF Local</label>
          <input id="gfH" type="number" step="0.01" min="0" value="1.40">
        </div>
        <div>
          <label>GC Local</label>
          <input id="gcH" type="number" step="0.01" min="0" value="0.80">
        </div>
      </div>

      <div class="row">
        <div>
          <label>GF Visitante</label>
          <input id="gfA" type="number" step="0.01" min="0" value="1.60">
        </div>
        <div>
          <label>GC Visitante</label>
          <input id="gcA" type="number" step="0.01" min="0" value="1.60">
        </div>
      </div>

      <h3>Parámetros del modelo</h3>
      <div class="row">
        <div>
          <label>μ_home (liga, goles por equipo en casa)</label>
          <input id="muH" type="number" step="0.01" min="0.5" value="1.45">
        </div>
        <div>
          <label>μ_away (liga, goles por equipo fuera)</label>
          <input id="muA" type="number" step="0.01" min="0.5" value="1.25">
        </div>
      </div>

      <div class="row" style="align-items:center">
        <div>
          <label>HFA (ventaja local, p.ej. 1.08)</label>
          <input id="hfa" type="number" step="0.01" min="0.7" max="1.4" value="1.08">
        </div>
        <div>
          <label>Máx. goles por lado (sumatoria de marcadores)</label>
          <input id="maxGoals" type="number" step="1" min="8" max="20" value="12">
        </div>
      </div>

      <h3>Factor Sorpresa</h3>
      <label>Probabilidad de “escenario sorpresa” (mezcla que favorece la volatilidad de resultado): <b><span id="fsLbl">0.15</span></b></label>
      <input id="fs" type="range" min="0" max="0.6" step="0.01" value="0.15" oninput="fsLbl.textContent=this.value">

      <button class="btn" id="calc">Calcular mercados</button>
      <div class="kpi" id="kpi"></div>
      <small>
        Fórmulas: λ<sub>H</sub>=HFA·GF<sub>H</sub>·(GC<sub>A</sub>/μ<sub>away</sub>), λ<sub>A</sub>=(1/HFA)·GF<sub>A</sub>·(GC<sub>H</sub>/μ<sub>home</sub>).<br>
        <b>Factor Sorpresa (FS)</b>: mezcla de 2 mundos — base (λ<sub>H</sub>, λ<sub>A</sub>) con peso (1−FS) y “sorpresa” donde se <i>intercambian</i> intensidades (λ<sub>A</sub>, λ<sub>H</sub>) con peso FS. Esto incrementa upsets y draws sin abandonar Poisson.
      </small>
    </div>

    <div class="card">
      <h3>Resultados</h3>
      <table id="tbl1"><thead><tr><th>Mercado</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead><tbody></tbody></table>
      <table id="tbl2"><thead><tr><th>Over/Under</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead><tbody></tbody></table>
      <table id="tbl3"><thead><tr><th>BTTS</th><th class="mono">Prob.</th><th class="mono">Cuota justa</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);

  // ---------- utilidades ----------
  const fact=[1];
  function factorial(n){for(let i=fact.length;i<=n;i++)fact[i]=fact[i-1]*i;return fact[n]}
  function logFactorial(n){if(n<100)return Math.log(factorial(n));const x=n;return x*Math.log(x)-x+0.5*Math.log(2*Math.PI*x)}
  function poisPMF(k,lambda){
    if(lambda<=0)return (k===0)?1:0;
    if(k<100){return Math.exp(-lambda)*Math.pow(lambda,k)/factorial(k)}
    return Math.exp(-lambda + k*Math.log(lambda) - logFactorial(k));
  }
  function poisCDF(k,lambda){let s=0;for(let i=0;i<=k;i++)s+=poisPMF(i,lambda);return s}
  function toOdds(p){return (p<=0)?Infinity:(1/p)}
  function fmtP(p){return (100*p).toFixed(2)+'%'}
  function fmtO(o){return (o===Infinity)?'—':o.toFixed(2)}
  function clamp(x,lo,hi){return Math.max(lo,Math.min(hi,x))}

  // ---------- núcleo ----------
  function lambdas(gfH,gcH,gfA,gcA,muH,muA,hfa){
    const MUH=Math.max(0.3,muH), MUA=Math.max(0.3,muA);
    const HFA=clamp(hfa,0.7,1.4);
    const lamH = HFA * Math.max(0,gfH) * (Math.max(0,gcA) / MUA);
    const lamA = (1/HFA) * Math.max(0,gfA) * (Math.max(0,gcH) / MUH);
    return {lamH,lamA,MUH,MUA,HFA};
  }

  function probs1X2(lH,lA,maxGoals){
    const maxG=Math.max(8,Math.min(20,Math.floor(maxGoals)||12));
    let p1=0,px=0,p2=0;
    for(let i=0;i<=maxG;i++){
      const pHi=poisPMF(i,lH);
      for(let j=0;j<=maxG;j++){
        const pAj=poisPMF(j,lA);
        const pij=pHi*pAj;
        if(i>j)p1+=pij; else if(i===j)px+=pij; else p2+=pij;
      }
    }
    const s=p1+px+p2; if(s>0){p1/=s;px/=s;p2/=s}
    return {p1,px,p2};
  }

  function mixProbabilities(fs, base, alt){
    // mezcla convexa: (1−fs)*base + fs*alt
    return (1-fs)*base + fs*alt;
  }

  function calcAll(){
    const gfH=+$('#gfH').value, gcH=+$('#gcH').value;
    const gfA=+$('#gfA').value, gcA=+$('#gcA').value;
    const muH=+$('#muH').value, muA=+$('#muA').value;
    const hfa=+$('#hfa').value;
    const maxGoals=+$('#maxGoals').value;
    const fs=+$('#fs').value; // factor sorpresa en [0, 0.6]

    // lambdas base
    const {lamH,lamA,MUH,MUA,HFA}=lambdas(gfH,gcH,gfA,gcA,muH,muA,hfa);
    const lamT = lamH + lamA;

    // escenario "sorpresa": intercambio de intensidades
    const lamH_s = lamA, lamA_s = lamH;
    const lamT_s = lamH_s + lamA_s; // igual a lamT

    // 1X2 base y sorpresa
    const b = probs1X2(lamH, lamA, maxGoals);
    const s = probs1X2(lamH_s, lamA_s, maxGoals);

    // mezcla por factor sorpresa
    const p1 = mixProbabilities(fs, b.p1, s.p2); // si se invierten intensidades, la "sorpresa" favorece al visitante
    const px = mixProbabilities(fs, b.px, s.px); // empate suele aumentar levemente con volatilidad
    const p2 = mixProbabilities(fs, b.p2, s.p1);

    // DNB (cuotas justas)
    const pNotDraw=1-px;
    const dnb1=toOdds(p1/(pNotDraw>0?pNotDraw:1));
    const dnb2=toOdds(p2/(pNotDraw>0?pNotDraw:1));

    // OU (mezcla sobre totales: lamT y lamT_s son iguales aquí, así que OU no cambia con el swap)
    const over15 = 1 - poisCDF(1, lamT);
    const over25 = 1 - poisCDF(2, lamT);
    const over35 = 1 - poisCDF(3, lamT);

    // BTTS (mezcla: base y sorpresa)
    const pBTTS_base = 1 - Math.exp(-lamH) - Math.exp(-lamA) + Math.exp(-(lamT));
    const pBTTS_sorp = 1 - Math.exp(-lamH_s) - Math.exp(-lamA_s) + Math.exp(-(lamT_s));
    const pBTTS = mixProbabilities(fs, pBTTS_base, pBTTS_sorp);
    const pNo = 1 - pBTTS;

    // KPIs
    $('#kpi').innerHTML = `
      <span class="pill">λ<sub>H</sub>=<b class="mono">${lamH.toFixed(3)}</b></span>
      <span class="pill">λ<sub>A</sub>=<b class="mono">${lamA.toFixed(3)}</b></span>
      <span class="pill">λ<sub>T</sub>=<b class="mono">${lamT.toFixed(3)}</b></span>
      <span class="pill">HFA=<b class="mono">${HFA.toFixed(2)}</b></span>
      <span class="pill">μ<sub>H</sub>=<b class="mono">${MUH.toFixed(2)}</b> μ<sub>A</sub>=<b class="mono">${MUA.toFixed(2)}</b></span>
      <span class="pill">FS=<b class="mono">${fs.toFixed(2)}</b></span>
      <span class="pill">P(X)=<b class="mono">${(100*px).toFixed(2)}%</b></span>
    `;

    // Tablas
    $('#tbl1 tbody').innerHTML = `
      <tr><td>1 (Local)</td><td class="mono">${fmtP(p1)}</td><td class="mono">${fmtO(toOdds(p1))}</td></tr>
      <tr><td>X (Empate)</td><td class="mono">${fmtP(px)}</td><td class="mono">${fmtO(toOdds(px))}</td></tr>
      <tr><td>2 (Visita)</td><td class="mono">${fmtP(p2)}</td><td class="mono">${fmtO(toOdds(p2))}</td></tr>
      <tr><td>1 DNB</td><td class="mono"><small>—</small></td><td class="mono">${fmtO(dnb1)}</td></tr>
      <tr><td>2 DNB</td><td class="mono"><small>—</small></td><td class="mono">${fmtO(dnb2)}</td></tr>
    `;

    $('#tbl2 tbody').innerHTML = `
      <tr><td>Over 1.5</td><td class="mono">${fmtP(over15)}</td><td class="mono">${fmtO(toOdds(over15))}</td></tr>
      <tr><td>Under 1.5</td><td class="mono">${fmtP(1-over15)}</td><td class="mono">${fmtO(toOdds(1-over15))}</td></tr>
      <tr><td>Over 2.5</td><td class="mono">${fmtP(over25)}</td><td class="mono">${fmtO(toOdds(over25))}</td></tr>
      <tr><td>Under 2.5</td><td class="mono">${fmtP(1-over25)}</td><td class="mono">${fmtO(toOdds(1-over25))}</td></tr>
      <tr><td>Over 3.5</td><td class="mono">${fmtP(over35)}</td><td class="mono">${fmtO(toOdds(over35))}</td></tr>
      <tr><td>Under 3.5</td><td class="mono">${fmtP(1-over35)}</td><td class="mono">${fmtO(toOdds(1-over35))}</td></tr>
    `;

    $('#tbl3 tbody').innerHTML = `
      <tr><td>BTTS Sí</td><td class="mono">${fmtP(pBTTS)}</td><td class="mono">${fmtO(toOdds(pBTTS))}</td></tr>
      <tr><td>BTTS No</td><td class="mono">${fmtP(pNo)}</td><td class="mono">${fmtO(toOdds(pNo))}</td></tr>
    `;
  }

  $('#calc').addEventListener('click', calcAll);
  // cálculo inicial
  calcAll();
})();
</script>
</body>
</html>
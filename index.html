<!DOCTYPE html>
<html lang="es">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Backtest Rápido (Worker + Antitético)</title>
<style>
  body{margin:0;background:#0f1115;color:#e6eaf2;font:14px system-ui}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{background:#171a21;border:1px solid #2a3140;border-radius:10px;padding:14px;margin:12px 0}
  .row{display:grid;grid-template-columns:1fr 220px;gap:8px;align-items:center;margin:8px 0}
  input,select,button{width:100%;background:#1f2430;color:#e6eaf2;border:1px solid #2a3140;border-radius:8px;padding:8px}
  .btn{background:#7aa2ff;color:#0c1020;font-weight:700;cursor:pointer}
  .pill{display:inline-block;border:1px solid #2a3140;background:#1f2430;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0}
  .muted{color:#9aa3b2;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Backtesting — Modo Rápido</h1>
  <div class="card">
    <div class="row"><label>Archivo JSON</label><input id="file" type="file" accept=".json"></div>
    <div class="row"><label>o Portapapeles</label><button id="btnPaste" class="btn">Cargar</button></div>
    <div class="row"><label>Liga</label><select id="league"><option value="">—</option></select></div>

    <div class="row"><label>Mercado</label>
      <select id="market"><option value="OU">Over/Under</option><option value="BTTS">BTTS</option><option value="1X2">1X2</option></select>
    </div>
    <div class="row" id="ouRow"><label>Línea O/U</label><input id="ou" type="number" step="0.5" value="2.5"></div>

    <div class="row"><label>α EWMA</label><input id="alpha" type="number" min="0" max="0.99" step="0.01" value="0.15"></div>
    <div class="row"><label>Discretización</label><select id="disc"><option value="round">Round</option><option value="floor">Floor</option></select></div>
    <div class="row"><label>Simulaciones (efectivas)</label><input id="ns" type="number" min="2000" step="1000" value="12000"></div>
    <div class="row"><label>Mín. historial</label><input id="minHist" type="number" min="3" value="8"></div>
    <div class="row"><label>Stake</label><input id="stake" type="number" step="0.1" value="1"></div>
    <div class="row"><label>EV mínimo</label><input id="ev" type="number" step="0.01" value="0.02"></div>

    <button id="run" class="btn">Correr Backtest (Rápido)</button>
    <p class="muted" id="info">—</p>
  </div>

  <div class="card">
    <div id="badges" class="muted">—</div>
    <div style="margin-top:8px">
      <span class="pill">Bets: <b id="bets">—</b></span>
      <span class="pill">Aciertos: <b id="hits">—</b></span>
      <span class="pill">Hit Rate: <b id="hr">—</b></span>
      <span class="pill">Unidades: <b id="units">—</b></span>
      <span class="pill">ROI: <b id="roi">—</b></span>
    </div>
    <table id="tbl" style="width:100%;border-collapse:collapse;margin-top:10px">
      <thead><tr><th>Fecha</th><th>Partido</th><th>Mercado</th><th>Odd</th><th>p̂</th><th>EV</th><th>Res</th><th>Win</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const el=id=>document.getElementById(id); const pct=x=>(x*100).toFixed(2)+'%'; const fmt=x=>(isFinite(x)?x.toFixed(3):'—');
function parseFT(s){const m=String(s||'').match(/(-?\d+)\s*[-:]\s*(-?\d+)/);return m?[+m[1],+m[2]]:[null,null];}
function parseDateAny(s){const d=new Date(s); if(!isNaN(d)) return d; return new Date(NaN);}
function mean(a){return a.reduce((s,x)=>s+x,0)/a.length;}
function variance(a,mu){let s=0; for(const x of a)s+=(x-mu)*(x-mu); return s/Math.max(1,a.length-1);}
function covariance(X,Y,mx,my){let s=0; for(let i=0;i<X.length;i++) s+=(X[i]-mx)*(Y[i]-my); return s/Math.max(1,X.length-1);}
function ewmaWeights(n,a){ if(a<=0)return null; const w=[]; for(let i=0;i<n;i++) w.push(Math.pow(1-a,i)); w.reverse(); return w; }
function meanW(a,w){const sw=w.reduce((s,x)=>s+x,0); let t=0; for(let i=0;i<a.length;i++) t+=a[i]*w[i]; return t/(sw||1);}
function varW(a,mu,w){const sw=w.reduce((s,x)=>s+x,0),sw2=w.reduce((s,x)=>s+x*x,0); let s=0; for(let i=0;i<a.length;i++) s+=w[i]*(a[i]-mu)*(a[i]-mu); const c=sw-(sw2/sw); return s/Math.max(1e-9,c);}
function covW(X,Y,mx,my,w){const sw=w.reduce((s,a)=>s+a,0),sw2=w.reduce((s,a)=>s+a*a,0); let s=0; for(let i=0;i<X.length;i++) s+=w[i]*(X[i]-mx)*(Y[i]-my); const c=sw-(sw2/sw); return s/Math.max(1e-9,c);}

let RAW=[], BY_LEAGUE=new Map();
el('file').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f)return;
  try{ingest(JSON.parse(await f.text()));}catch(err){alert('Error JSON: '+err);}
});
el('btnPaste').addEventListener('click',async()=>{
  try{ingest(JSON.parse(await navigator.clipboard.readText()));}catch(err){alert('Portapapeles: '+err);}
});
function ingest(arr){
  RAW=[]; BY_LEAGUE.clear();
  for(const r of arr){
    const league=String(r.League||'').trim(); if(!league) continue;
    const [h,a]=parseFT(r["Result FT"]||r.Result); const date=parseDateAny(r.Date||r.date||''); const match=String(r.Match||'').trim();
    if(!Number.isFinite(h)||!Number.isFinite(a)||isNaN(date)) continue;
    const row={league,date,match,h,a,raw:r}; RAW.push(row);
    if(!BY_LEAGUE.has(league)) BY_LEAGUE.set(league,[]); BY_LEAGUE.get(league).push(row);
  }
  for(const arr2 of BY_LEAGUE.values()) arr2.sort((x,y)=>x.date-y.date);
  el('league').innerHTML='<option value="">—</option>'+Array.from(BY_LEAGUE.keys()).sort().map(l=>`<option>${l}</option>`).join('');
  el('info').textContent=`Cargados ${RAW.length} partidos en ${BY_LEAGUE.size} ligas.`;
}
el('market').addEventListener('change',()=>{el('ouRow').style.display=(el('market').value==='OU')?'':'none';});

// --- Worker inline (Blob) ---
const workerSrc = `
let seed=0x9e3779b9; function mulberry32(){let t=seed+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}
function randn(){ // Box–Muller por parejas (usa antitético con -z)
  let u1=mulberry32(); if(u1<=1e-12) u1=1e-12;
  const u2=mulberry32(); const r=Math.sqrt(-2*Math.log(u1)), th=6.283185307179586*u2;
  return [r*Math.cos(th), r*Math.sin(th)];
}
onmessage = e=>{
  const {jobs} = e.data; // array de tareas
  const out = [];
  for(const jb of jobs){
    seed = (jb.seed|0)>>>0;
    const {muH,muA,sdH,sdA,rho,ns,disc,ou} = jb;
    const s=Math.sqrt(Math.max(1e-12,1-rho*rho));
    let over=0,btts=0,wH=0,d=0,wA=0;
    let nPairs = Math.max(1, Math.floor(ns/2)); // antitético: 2 por par
    for(let i=0;i<nPairs;i++){
      const z = randn(); // z1,z2
      for(let aSign of [1,-1]){ // antitético
        const z1=aSign*z[0], z2=aSign*z[1];
        const x=muH+sdH*z1, y=muA+sdA*(rho*z1+s*z2);
        let H = disc==='round'? Math.max(0,Math.round(x)) : Math.max(0,Math.floor(x));
        let A = disc==='round'? Math.max(0,Math.round(y)) : Math.max(0,Math.floor(y));
        if(H+A>ou) over++; if(H>0&&A>0) btts++;
        if(H>A) wH++; else if(H===A) d++; else wA++;
      }
    }
    const nTot = nPairs*2;
    out.push({id:jb.id, pOver:over/nTot, pUnder:1-over/nTot, pBTTS:btts/nTot, p1:wH/nTot, pX:d/nTot, p2:wA/nTot});
  }
  postMessage(out);
};`;

const worker = new Worker(URL.createObjectURL(new Blob([workerSrc],{type:'application/javascript'})));

function getOdds(r, market, ou){
  const o=r.raw;
  if(market==='OU'){
    const over=+o['Odd Over25']||+o['OddOver25']||+o['Over25']||+o['Over 2.5']||null;
    const under=+o['Odd Under25']||+o['OddUnder25']||+o['Under25']||+o['Under 2.5']||null;
    return { over: over>1.01?over:null, under: under>1.01?under:null, line:ou };
  }else if(market==='BTTS'){
    const yes=+o['Odd BTTS']||+o['Odd GG']||+o['Odd']||null;
    return { yes: yes>1.01?yes:null };
  }else{
    const o1=+o['Odd 1 PreMatch']||null, ox=+o['Odd X PreMatch']||null, o2=+o['Odd 2 PreMatch']||null;
    return {o1:o1>1.01?o1:null, ox:ox>1.01?ox:null, o2:o2>1.01?o2:null};
  }
}

el('run').addEventListener('click', ()=>{
  const L=el('league').value; if(!L){alert('Elige una liga.');return;}
  const rows=(BY_LEAGUE.get(L)||[]).slice(); const ns=+el('ns').value||12000;
  const alpha=+el('alpha').value||0, disc=el('disc').value, ou=+el('ou').value||2.5;
  const minHist=Math.max(3, +el('minHist').value||8);
  const market=el('market').value, evMin=+el('ev').value||0, stake=+el('stake').value||1;

  let bets=0,hits=0,units=0; const outRows=[];
  const jobs=[]; let ptr=0;

  // precompute históricos incrementales (reduce cálculos)
  const Hcum=[], Acum=[]; // arreglos acumulados
  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    const hList = rows.slice(0,i).map(x=>x.h);
    const aList = rows.slice(0,i).map(x=>x.a);
    Hcum.push(hList); Acum.push(aList);
  }

  // construir tareas para el worker
  for(let i=0;i<rows.length;i++){
    if(i<minHist) continue;
    const H = Hcum[i], A = Acum[i];
    let muH,muA,sdH,sdA,cov,rho;
    if(alpha>0){
      const w=ewmaWeights(H.length,alpha);
      const sw=w.reduce((s,x)=>s+x,0), sw2=w.reduce((s,x)=>s+x*x,0);
      muH=meanW(H,w); muA=meanW(A,w);
      const vH=varW(H,muH,w), vA=varW(A,muA,w);
      const c = covW(H,A,muH,muA,w);
      sdH=Math.sqrt(Math.max(1e-9,vH)); sdA=Math.sqrt(Math.max(1e-9,vA));
      rho = Math.max(-0.999, Math.min(0.999, c/(sdH*sdA)));
    }else{
      muH=mean(H); muA=mean(A);
      sdH=Math.sqrt(Math.max(1e-9, variance(H,muH)));
      sdA=Math.sqrt(Math.max(1e-9, variance(A,muA)));
      const cov=covariance(H,A,muH,muA);
      rho = Math.max(-0.999, Math.min(0.999, cov/(sdH*sdA)));
    }
    jobs.push({id:i, seed: (1234567+i*97)>>>0, muH,muA,sdH,sdA,rho,ns,disc,ou});
  }

  const oddsCache = rows.map(r=>getOdds(r,market,ou));

  worker.onmessage = (ev)=>{
    const res = new Map(ev.data.map(o=>[o.id,o]));
    for(const jb of jobs){
      const i=jb.id; const r=rows[i]; const sim=res.get(i);
      if(!sim) continue;
      let bet=null, odd=null, p=null, win=0, result='';
      if(market==='OU'){
        const {over,under,line}=oddsCache[i];
        const cand=[];
        if(over)  cand.push({label:'Over '+line,  p:sim.pOver,  odd:over,  win:(r.h+r.a>line)?1:0});
        if(under) cand.push({label:'Under '+line, p:sim.pUnder, odd:under, win:(r.h+r.a<=line)?1:0});
        cand.forEach(c=>c.ev=c.p*(c.odd-1)-(1-c.p));
        const pick=cand.sort((a,b)=>b.ev-a.ev)[0];
        if(pick && pick.ev>=evMin){ bet=pick.label; p=pick.p; odd=pick.odd; win=pick.win; }
        result=(r.h+r.a)+'g';
      }else if(market==='BTTS'){
        const {yes}=oddsCache[i];
        if(yes){ const pBTTS=sim.pBTTS, ev=pBTTS*(yes-1)-(1-pBTTS);
          if(ev>=evMin){ bet='BTTS Sí'; p=pBTTS; odd=yes; win=(r.h>0&&r.a>0)?1:0; } }
        result=r.h+'-'+r.a;
      }else{
        const {o1,ox,o2}=oddsCache[i];
        const cand=[];
        if(o1) cand.push({label:'1',p:sim.p1,odd:o1,win:(r.h>r.a)?1:0});
        if(ox) cand.push({label:'X',p:sim.pX,odd:ox,win:(r.h===r.a)?1:0});
        if(o2) cand.push({label:'2',p:sim.p2,odd:o2,win:(r.h<r.a)?1:0});
        cand.forEach(c=>c.ev=c.p*(c.odd-1)-(1-c.p));
        const pick=cand.sort((a,b)=>b.ev-a.ev)[0];
        if(pick && pick.ev>=evMin){ bet=pick.label; p=pick.p; odd=pick.odd; win=pick.win; }
        result=r.h+'-'+r.a;
      }
      if(bet){
        bets++; hits+=win;
        const pnl = win ? stake*(odd-1) : -stake; units+=pnl;
        outRows.push({date:r.date.toISOString().slice(0,10), match:r.match, market:bet, odd:odd?.toFixed(2), p_hat:p?.toFixed(3),
                      EV:(p*(odd-1)-(1-p)).toFixed(3), result, win:win?'✔':'✖'});
      }
    }
    // pintar
    const roi = bets? (units/(bets*stake)) : 0;
    el('bets').textContent=bets; el('hits').textContent=hits; el('hr').textContent=bets?pct(hits/bets):'—';
    el('units').textContent=fmt(units); el('roi').textContent=bets?pct(roi):'—';
    el('badges').innerHTML = `<span class="pill">Liga: <b>${L}</b></span>
      <span class="pill">Mercado: <b>${market}</b></span>
      <span class="pill">α: <b>${alpha}</b></span>
      <span class="pill">Disc: <b>${disc}</b></span>
      <span class="pill">#Sims (efectivas): <b>${ns}</b></span>
      <span class="pill">MinHist: <b>${minHist}</b></span>
      <span class="pill">EV≥ <b>${evMin}</b></span>`;
    const tb=document.querySelector('#tbl tbody');
    tb.innerHTML = outRows.slice(0,200).map(r=>`<tr>
      <td>${r.date}</td><td>${r.match}</td><td>${r.market}</td>
      <td>${r.odd}</td><td>${r.p_hat}</td><td>${r.EV}</td><td>${r.result}</td><td>${r.win}</td>
    </tr>`).join('') || `<tr><td colspan="8" class="muted">No hubo apuestas con EV ≥ umbral.</td></tr>`;
  };

  el('info').textContent='Calculando en segundo plano (worker + antitético)…';
  worker.postMessage({jobs});
});
</script>
</body>
</html>
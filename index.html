<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Backtesting de Múltiples Mercados</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h1 { color: #0056b3; }
        h2, h3, h4 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 25px; }
        #resultados { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .success { color: #28a745; font-weight: bold; }
        .failure { color: #dc3545; font-weight: bold; }
        .neutral { color: #ffc107; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <h1>Herramienta de Backtesting de Múltiples Mercados ⚽</h1>
    <p>Carga tu archivo JSON y analiza la rentabilidad de varios mercados simultáneamente.</p>

    <input type="file" id="jsonFile" accept=".json">
    <button onclick="iniciarBacktesting()">Iniciar Backtesting</button>

    <h2>Resultados del Análisis</h2>
    <div id="resultados">Carga un archivo JSON para comenzar...</div>

    <script>
        let datosPartidos = []; 
        let analisisEquipos = {}; 
        
        // Estructura para análisis de rentabilidad por mercado
        let analisisMercados = {
            '1X2_H': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
            '1X2_D': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
            '1X2_A': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
            'O2.5': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
            'U2.5': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 }
            // Se puede agregar más aquí (e.g., AH, HT/FT, etc.)
        };
        
        // Estructura para rangos de cuotas (solo para el O2.5 en este ejemplo, se puede expandir)
        let analisisRangosO25 = {
            '1.00-1.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '1.51-2.00': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '2.01-2.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
            '2.51+':     { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 }
        };


        // --- MANEJO DE ARCHIVOS ---
        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    datosPartidos = JSON.parse(e.target.result);
                    if (!Array.isArray(datosPartidos)) {
                        if (typeof datosPartidos === 'object' && datosPartidos !== null) {
                            datosPartidos = [datosPartidos];
                        } else {
                             throw new Error("El archivo JSON debe ser un array de partidos.");
                        }
                    }
                    if (datosPartidos.length === 0) {
                         throw new Error("El array de partidos está vacío.");
                    }
                    document.getElementById('resultados').innerHTML = `<p class="success">Archivo JSON cargado correctamente. Se encontraron ${datosPartidos.length} partidos.</p>`;
                } catch (error) {
                    document.getElementById('resultados').innerHTML = `<p class="failure">Error al leer o parsear el archivo JSON: ${error.message}</p>`;
                    datosPartidos = [];
                }
            };
            reader.readAsText(file);
        });

        // --- FUNCIONES AUXILIARES DE ANÁLISIS ---

        function actualizarEstadisticasEquipo(equipo, esLocal, golesFavor, golesContra, resultadoFTR) {
            // ... (Función para actualizar estadísticas por equipo, la misma de antes)
            if (!equipo || !resultadoFTR) return; 

            if (!analisisEquipos[equipo]) {
                analisisEquipos[equipo] = {
                    jugados: 0, victorias: 0, empates: 0, derrotas: 0, 
                    gf: 0, gc: 0, loc_jugados: 0, vis_jugados: 0
                };
            }

            const stats = analisisEquipos[equipo];
            stats.jugados++;
            stats.gf += golesFavor;
            stats.gc += golesContra;
            stats[esLocal ? 'loc_jugados' : 'vis_jugados']++;

            if (resultadoFTR === 'H') {
                if (esLocal) stats.victorias++; else stats.derrotas++;
            } else if (resultadoFTR === 'A') {
                if (esLocal) stats.derrotas++; else stats.victorias++;
            } else { 
                stats.empates++;
            }
        }

        function obtenerRangoCuotaO25(cuota) {
            if (cuota >= 1.00 && cuota <= 1.50) return '1.00-1.50';
            if (cuota >= 1.51 && cuota <= 2.00) return '1.51-2.00';
            if (cuota >= 2.01 && cuota <= 2.50) return '2.01-2.50';
            if (cuota > 2.50) return '2.51+';
            return null;
        }

        function actualizarAnalisisMercados(mercado, cuota, esGanadora) {
            const stats = analisisMercados[mercado];
            const apuesta = 1; // Stake fijo

            stats.apuestas++;
            stats.totalCuota += cuota;
            stats.cuotaMedia = stats.totalCuota / stats.apuestas;

            if (esGanadora) {
                const ganancia = (cuota - 1) * apuesta;
                stats.gananciaNeta += ganancia;
                stats.victorias++;
            } else {
                stats.gananciaNeta -= apuesta;
                stats.perdidas++;
            }
        }
        
        // --- FUNCIONES DE GENERACIÓN DE TABLAS ---

        function generarTablaEquipos() {
            // ... (Función para generar tabla de equipos, la misma de antes)
            let htmlTabla = '<h3>Análisis de Rendimiento General por Equipo (Todos los partidos)</h3>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Equipo</th><th>PJ</th><th>V</th><th>E</th><th>D</th><th>GF</th><th>GC</th><th>Dif</th><th>%V</th></tr>';

            const equiposOrdenados = Object.keys(analisisEquipos).sort();

            equiposOrdenados.forEach(equipo => {
                const stats = analisisEquipos[equipo];
                const diferencia = stats.gf - stats.gc;
                const porcentajeVictoria = stats.jugados > 0 ? ((stats.victorias / stats.jugados) * 100).toFixed(1) : 0;
                
                htmlTabla += `<tr>
                    <td>${equipo}</td>
                    <td>${stats.jugados}</td>
                    <td>${stats.victorias}</td>
                    <td>${stats.empates}</td>
                    <td>${stats.derrotas}</td>
                    <td>${stats.gf}</td>
                    <td>${stats.gc}</td>
                    <td class="${diferencia >= 0 ? 'success' : 'failure'}">${diferencia}</td>
                    <td>${porcentajeVictoria}%</td>
                </tr>`;
            });

            htmlTabla += '</table>';
            return htmlTabla;
        }

        function generarTablaRangosO25() {
            let htmlTabla = '<h3>Desglose de Rentabilidad: Over 2.5 Goles por Rango de Cuotas</h3>';
            htmlTabla += '<p>Analiza si la estrategia de apostar al O2.5 es más rentable en cuotas bajas o altas.</p>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Rango de Cuotas</th><th>Apuestas</th><th>Ganancia Neta (u)</th><th>ROI (%)</th><th>Acierto (%)</th></tr>';

            for (const rango in analisisRangosO25) {
                const stats = analisisRangosO25[rango];
                const totalApuestas = stats.victorias + stats.perdidas;
                const roi = totalApuestas > 0 ? ((stats.gananciaNeta / totalApuestas) * 100).toFixed(2) : 0;
                const acierto = totalApuestas > 0 ? ((stats.victorias / totalApuestas) * 100).toFixed(1) : 0;
                const cssClass = stats.gananciaNeta >= 0 ? 'success' : 'failure';

                htmlTabla += `<tr>
                    <td>${rango}</td>
                    <td>${totalApuestas}</td>
                    <td class="${cssClass}">${stats.gananciaNeta.toFixed(2)}</td>
                    <td class="${cssClass}">${roi}</td>
                    <td>${acierto}</td>
                </tr>`;
            }

            htmlTabla += '</table>';
            return htmlTabla;
        }
        
        function generarTablaMercados() {
            let htmlTabla = '<h3>Rentabilidad Global por Mercado (Stake Fijo de 1u)</h3>';
            htmlTabla += '<table>';
            htmlTabla += '<tr><th>Mercado</th><th>Apuestas</th><th>Cuota Media</th><th>Ganancia Neta (u)</th><th>ROI (%)</th><th>Acierto (%)</th></tr>';
            
            const mercadosOrdenados = Object.keys(analisisMercados).sort();

            mercadosOrdenados.forEach(mercado => {
                const stats = analisisMercados[mercado];
                const totalApuestas = stats.apuestas;
                const roi = totalApuestas > 0 ? ((stats.gananciaNeta / totalApuestas) * 100).toFixed(2) : 0;
                const acierto = totalApuestas > 0 ? ((stats.victorias / totalApuestas) * 100).toFixed(1) : 0;
                const cssClass = stats.gananciaNeta >= 0 ? 'success' : 'failure';

                htmlTabla += `<tr>
                    <td>${mercado}</td>
                    <td>${totalApuestas}</td>
                    <td>${stats.cuotaMedia.toFixed(2)}</td>
                    <td class="${cssClass}">${stats.gananciaNeta.toFixed(2)}</td>
                    <td class="${cssClass}">${roi}</td>
                    <td>${acierto}%</td>
                </tr>`;
            });

            htmlTabla += '</table>';
            return htmlTabla;
        }

        // --- FUNCIÓN PRINCIPAL DE BACKTESTING ---

        function iniciarBacktesting() {
            if (datosPartidos.length === 0) {
                document.getElementById('resultados').innerHTML = '<p class="failure">Por favor, primero carga un archivo JSON.</p>';
                return;
            }

            // Reiniciar análisis
            analisisEquipos = {}; 
            analisisRangosO25 = {
                '1.00-1.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '1.51-2.00': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '2.01-2.50': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 },
                '2.51+':     { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0 }
            };
            analisisMercados = {
                '1X2_H': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
                '1X2_D': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
                '1X2_A': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
                'O2.5': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 },
                'U2.5': { apuestas: 0, gananciaNeta: 0, victorias: 0, perdidas: 0, cuotaMedia: 0, totalCuota: 0 }
            };
            
            // --- BUCLE DE BACKTESTING ---
            datosPartidos.forEach((partido) => {
                const homeTeam = partido.HomeTeam;
                const awayTeam = partido.AwayTeam;
                
                // Resultados
                const fthg = parseInt(partido.FTHG) || 0; 
                const ftag = parseInt(partido.FTAG) || 0; 
                const ftr = partido.FTR;
                const golesTotales = fthg + ftag;
                
                // Análisis de Rendimiento de Equipos (Para tabla general)
                actualizarEstadisticasEquipo(homeTeam, true, fthg, ftag, ftr);
                actualizarEstadisticasEquipo(awayTeam, false, ftag, fthg, ftr);

                // =========================================================
                // 1. ANÁLISIS DEL MERCADO 1X2 (Resultado Final)
                // =========================================================
                const cuotas1X2 = {
                    'H': parseFloat(partido.AvgH) || 0,
                    'D': parseFloat(partido.AvgD) || 0,
                    'A': parseFloat(partido.AvgA) || 0
                };

                // Apostamos al Local (H)
                if (cuotas1X2.H > 0) {
                    actualizarAnalisisMercados('1X2_H', cuotas1X2.H, ftr === 'H');
                }
                // Apostamos al Empate (D)
                if (cuotas1X2.D > 0) {
                    actualizarAnalisisMercados('1X2_D', cuotas1X2.D, ftr === 'D');
                }
                // Apostamos al Visitante (A)
                if (cuotas1X2.A > 0) {
                    actualizarAnalisisMercados('1X2_A', cuotas1X2.A, ftr === 'A');
                }

                // =========================================================
                // 2. ANÁLISIS DEL MERCADO OVER/UNDER 2.5
                // =========================================================
                // NOTA: Se sigue usando la clave anidada de tu JSON de ejemplo
                const cuotaO2_5 = parseFloat(partido['Avg>2'] ? partido['Avg>2'][5] : null) || 0; 
                const cuotaU2_5 = parseFloat(partido['Avg<2'] ? partido['Avg<2'][5] : null) || 0;

                const ganaO2_5 = golesTotales >= 3;
                const ganaU2_5 = golesTotales <= 2;

                // Apostamos al Over 2.5 (O2.5)
                if (cuotaO2_5 > 0) {
                    actualizarAnalisisMercados('O2.5', cuotaO2_5, ganaO2_5);
                    
                    // Actualizar Rangos O2.5
                    const rango = obtenerRangoCuotaO25(cuotaO2_5);
                    if (rango) {
                        const statsRango = analisisRangosO25[rango];
                        const apuesta = 1;
                        statsRango.apuestas++;
                        if (ganaO2_5) {
                            statsRango.gananciaNeta += (cuotaO2_5 - 1) * apuesta;
                            statsRango.victorias++;
                        } else {
                            statsRango.gananciaNeta -= apuesta;
                            statsRango.perdidas++;
                        }
                    }
                }

                // Apostamos al Under 2.5 (U2.5)
                if (cuotaU2_5 > 0) {
                    actualizarAnalisisMercados('U2.5', cuotaU2_5, ganaU2_5);
                }
                
            });
            // --- FIN DEL BUCLE ---

            // --- Generar Reporte ---
            let resultadosHTML = '';
            
            // 1. Tabla de Mercados
            resultadosHTML += generarTablaMercados();
            
            // 2. Desglose de Rangos O2.5
            resultadosHTML += generarTablaRangosO25();
            
            // 3. Tabla de Equipos
            resultadosHTML += generarTablaEquipos();
            
            document.getElementById('resultados').innerHTML = resultadosHTML;
        }

    </script>

</body>
</html>

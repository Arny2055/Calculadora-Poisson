<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS - Laboratorio de Backtesting & Insights</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --dark-bg: #030712; --card-bg: #111827; --accent-purple: #8b5cf6; --accent-emerald: #10b981; }
        body { background-color: var(--dark-bg); color: #f8fafc; font-family: 'Inter', system-ui, sans-serif; }
        .glass-card { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .metric-card { border-left: 4px solid var(--accent-purple); padding: 1.25rem; border-radius: 1rem; }
        .insight-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px; }
        .insight-label { color: #94a3b8; font-weight: 500; }
        .insight-value { font-weight: 800; color: #10b981; }
        th { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; color: #94a3b8; background: #1f2937; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px; }
        select, input { background-color: #1f2937 !important; color: white !important; border: 1px solid #374151 !important; border-radius: 0.5rem; font-size: 12px; padding: 5px 10px; }
        #insights-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: #0f172a; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; border-radius: 20px; border: 1px solid #3b82f6; }
        .engine-header { padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 900; letter-spacing: 1px; }
        .recommendation-box { background: linear-gradient(90deg, #1e1b4b, #312e81); border: 1px solid #4338ca; padding: 15px; border-radius: 12px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .recommendation-box::after { content: '\f0eb'; font-family: 'Font Awesome 6 Free'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 40px; opacity: 0.1; font-weight: 900; }
        .simulation-border { border-left: 4px solid #f59e0b !important; }
        .team-table-container { overflow-x: auto; max-height: 400px; }
    </style>
</head>
<body class="min-h-screen">

    <div id="insights-modal">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h2 class="text-xl font-black italic text-white"><i class="fa-solid fa-chart-line mr-2 text-purple-500"></i>ANÁLISIS PROFUNDO DE INSIGHTS</h2>
                <button onclick="toggleModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div id="ai-recommendation" class="recommendation-box hidden">
                <h3 class="text-xs font-black text-blue-300 uppercase mb-2"><i class="fa-solid fa-robot mr-2"></i>Asistente Estratégico BetAGS</h3>
                <p id="rec-text" class="text-sm font-medium text-white italic">Generando estrategia óptima...</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="engine-header bg-purple-600/20 text-purple-400 border border-purple-500/30 uppercase text-sm">Top Rendimiento General</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-[10px] font-black text-blue-400 uppercase mb-2">Top Ligas</h3><div id="top-leagues"></div></div>
                        <div><h3 class="text-[10px] font-black text-emerald-400 uppercase mb-2">Top Mercados</h3><div id="top-markets"></div></div>
                        <div><h3 class="text-[10px] font-black text-orange-400 uppercase mb-2">Top Cuotas</h3><div id="top-odds"></div></div>
                        <div><h3 class="text-[10px] font-black text-pink-400 uppercase mb-2">Top Edge</h3><div id="top-edge"></div></div>
                    </div>
                </div>
                <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                    <h3 class="text-xs font-black text-white uppercase mb-4 italic">Distribución de Yield</h3>
                    <canvas id="yieldDistributionChart" class="max-h-[300px]"></canvas>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-slate-900 border-b border-purple-500/20 p-4 sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-black italic text-white">BET<span class="text-purple-500">AGS</span> <span class="text-[10px] uppercase tracking-widest text-slate-400 ml-2">Backtesting Lab</span></h1>
            <div class="flex gap-3">
                <button onclick="generateInsights()" class="text-xs bg-purple-600 text-white px-4 py-2 rounded-lg font-black border border-purple-400 hover:bg-purple-500 transition-all shadow-lg shadow-purple-900/40">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>RECOMENDACIÓN ESTRATÉGICA
                </button>
                <a href="index.html" class="text-xs bg-slate-800 text-white px-4 py-2 rounded-lg font-bold border border-slate-700">VOLVER AL MINERO</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 lg:p-6 space-y-6">
        <div class="glass-card p-4 rounded-2xl border-b-2 border-purple-500">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                <div><label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Mercado</label>
                    <select id="filter-market" class="w-full" onchange="applyFilters()"><option value="all">TODOS</option><option value="GANADOR LOCAL (1)">LOCAL (1)</option><option value="EMPATE (X)">EMPATE (X)</option><option value="GANADOR VISITANTE (2)">VISITANTE (2)</option><option value="OVER 2.5">OVER 2.5</option><option value="UNDER 2.5">UNDER 2.5</option><option value="BTTS SÍ">BTTS SÍ</option><option value="BTTS NO">BTTS NO</option></select>
                </div>
                <div><label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Cuota Mín.</label><input type="number" id="filter-min-odd" step="0.1" placeholder="1.0" class="w-full" oninput="applyFilters()"></div>
                <div><label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Cuota Máx.</label><input type="number" id="filter-max-odd" step="0.1" placeholder="10.0" class="w-full" oninput="applyFilters()"></div>
                
                <div class="bg-orange-500/10 p-2 rounded-lg border border-orange-500/20">
                    <label class="text-[9px] font-black text-orange-400 uppercase block mb-1"><i class="fa-solid fa-flask mr-1"></i>Simular Stake Plano</label>
                    <input type="number" id="sim-stake" value="10" step="5" class="w-full !border-orange-500/40" oninput="applyFilters()">
                </div>

                <button onclick="clearBacktest()" class="text-[10px] bg-red-600/20 text-red-400 border border-red-500/30 p-2 rounded uppercase font-black h-[32px]">Limpiar Historial</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="glass-card metric-card"><p class="text-[10px] font-black text-slate-500 uppercase">Profit Real</p><h3 id="stat-profit" class="text-2xl font-black text-white">$0.00</h3></div>
            <div class="glass-card metric-card border-emerald-500"><p class="text-[10px] font-black text-slate-500 uppercase">Yield Real</p><h3 id="stat-yield" class="text-2xl font-black text-emerald-400">0%</h3></div>
            
            <div class="glass-card metric-card simulation-border"><p class="text-[10px] font-black text-orange-500 uppercase">Profit Simulado</p><h3 id="stat-sim-profit" class="text-2xl font-black text-orange-400">$0.00</h3></div>
            <div class="glass-card metric-card simulation-border"><p class="text-[10px] font-black text-orange-500 uppercase">Yield Simulado</p><h3 id="stat-sim-yield" class="text-2xl font-black text-orange-400">0%</h3></div>

            <div class="glass-card metric-card border-blue-500"><p class="text-[10px] font-black text-slate-500 uppercase">Hit Rate / Picks</p><h3 id="stat-winrate" class="text-2xl font-black text-blue-400">0%</h3><p id="stat-count" class="text-[10px] text-slate-500 font-bold uppercase">0 PICKS</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 glass-card p-6 rounded-2xl"><canvas id="equityChart" class="h-[350px]"></canvas></div>
            
            <div class="glass-card p-6 rounded-2xl">
                <h3 class="font-bold text-slate-300 uppercase text-sm italic mb-4 border-b border-white/10 pb-2">Top Rentabilidad Ligas</h3>
                <div id="league-stats" class="space-y-3 overflow-y-auto max-h-[300px]"></div>
            </div>
        </div>

        <div class="glass-card p-6 rounded-2xl border-t-2 border-emerald-500">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-lg font-black text-white italic">RENTABILIDAD POR EQUIPO & INSIGHT</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Análisis detallado de ejecución por escuadra</p>
                </div>
                <div class="text-right">
                    <span class="text-[9px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded font-black uppercase">Filtro Activo: Mercado</span>
                </div>
            </div>
            
            <div class="team-table-container">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Insight / Mercado</th>
                            <th class="text-center">Picks</th>
                            <th class="text-center">W - L - V</th>
                            <th class="text-right">Profit Tot.</th>
                            <th class="text-right">Yield</th>
                        </tr>
                    </thead>
                    <tbody id="team-insight-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let fullData = JSON.parse(localStorage.getItem('backtesting_data')) || [];
        let filteredData = [];
        let equityChart;

        function applyFilters() {
            const market = document.getElementById('filter-market').value;
            const minOdd = parseFloat(document.getElementById('filter-min-odd').value) || 0;
            const maxOdd = parseFloat(document.getElementById('filter-max-odd').value) || 999;
            
            filteredData = fullData.filter(b => {
                const matchMarket = market === 'all' || b.mercado === market;
                return matchMarket && b.cuota >= minOdd && b.cuota <= maxOdd;
            });
            updateUI();
        }

        function updateUI() {
            renderStats();
            renderEquityChart();
            renderLeagueStats();
            renderTeamInsightTable();
        }

        function renderStats() {
            const simStake = parseFloat(document.getElementById('sim-stake').value) || 0;
            let tProfit = 0, tStaked = 0, tSimProfit = 0, tSimStaked = 0, tWins = 0;

            filteredData.forEach(b => {
                tProfit += b.profit; tStaked += b.stake;
                if (b.profit > 0) {
                    tSimProfit += (b.cuota - 1) * simStake; tSimStaked += simStake; tWins++;
                } else if (b.profit < 0) {
                    tSimProfit -= simStake; tSimStaked += simStake;
                }
            });

            document.getElementById('stat-profit').innerText = `$${tProfit.toFixed(2)}`;
            document.getElementById('stat-yield').innerText = `${(tStaked > 0 ? (tProfit/tStaked)*100 : 0).toFixed(1)}%`;
            document.getElementById('stat-sim-profit').innerText = `$${tSimProfit.toFixed(2)}`;
            document.getElementById('stat-sim-yield').innerText = `${(tSimStaked > 0 ? (tSimProfit/tSimStaked)*100 : 0).toFixed(1)}%`;
            document.getElementById('stat-winrate').innerText = `${(filteredData.length > 0 ? (tWins/filteredData.length)*100 : 0).toFixed(1)}%`;
            document.getElementById('stat-count').innerText = `${filteredData.length} PICKS`;
        }

        function renderEquityChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            const simStake = parseFloat(document.getElementById('sim-stake').value) || 0;
            let cR = 0, cS = 0;
            const rPts = [0], sPts = [0];

            filteredData.forEach(b => { 
                cR += b.profit; rPts.push(cR); 
                if (b.profit > 0) cS += (b.cuota - 1) * simStake;
                else if (b.profit < 0) cS -= simStake;
                sPts.push(cS);
            });

            if(equityChart) equityChart.destroy();
            equityChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: rPts.map((_, i) => i), 
                    datasets: [
                        { label: 'Real', data: rPts, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.3 },
                        { label: 'Simulado', data: sPts, borderColor: '#f59e0b', borderDash: [5, 5], tension: 0.3 }
                    ] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } } } }
            });
        }

        function renderLeagueStats() {
            const container = document.getElementById('league-stats');
            const stats = {};
            filteredData.forEach(b => { stats[b.liga] = (stats[b.liga] || 0) + b.profit; });
            container.innerHTML = '';
            Object.entries(stats).sort((a,b)=>b[1]-a[1]).forEach(([l, p]) => {
                container.innerHTML += `<div class="insight-row"><span class="insight-label uppercase">${l}</span><span class="${p>=0?'text-emerald-400':'text-red-400'} font-bold">$${p.toFixed(2)}</span></div>`;
            });
        }

        function renderTeamInsightTable() {
            const tbody = document.getElementById('team-insight-body');
            const teamData = {};

            filteredData.forEach(b => {
                // Analizamos tanto al local como visitante para el insight
                const teams = [b.local, b.visitante];
                teams.forEach(t => {
                    const key = `${t}_${b.mercado}`;
                    if(!teamData[key]) {
                        teamData[key] = { name: t, market: b.mercado, profit: 0, stake: 0, w: 0, l: 0, v: 0, count: 0 };
                    }
                    teamData[key].profit += b.profit;
                    teamData[key].stake += b.stake;
                    teamData[key].count++;
                    if(b.profit > 0) teamData[key].w++;
                    else if(b.profit < 0) teamData[key].l++;
                    else teamData[key].v++;
                });
            });

            tbody.innerHTML = '';
            Object.values(teamData)
                .sort((a,b) => b.profit - a.profit)
                .forEach(d => {
                    const yieldVal = d.stake > 0 ? (d.profit / d.stake) * 100 : 0;
                    tbody.innerHTML += `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="font-black text-white uppercase">${d.name}</td>
                            <td class="text-slate-400 font-bold">${d.market}</td>
                            <td class="text-center font-bold">${d.count}</td>
                            <td class="text-center">
                                <span class="text-emerald-400">${d.w}</span> - 
                                <span class="text-red-400">${d.l}</span> - 
                                <span class="text-slate-500">${d.v}</span>
                            </td>
                            <td class="text-right font-black ${d.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                                $${d.profit.toFixed(2)}
                            </td>
                            <td class="text-right font-bold text-slate-300">${yieldVal.toFixed(1)}%</td>
                        </tr>
                    `;
                });
        }

        function generateInsights() {
            if(fullData.length === 0) return alert("Sin datos.");
            const analysis = { leagues: {}, markets: {}, odds: {}, totalProfit: 0, totalStake: 0 };

            fullData.forEach(b => {
                analysis.totalProfit += b.profit;
                analysis.totalStake += b.stake;
                analysis.leagues[b.liga] = (analysis.leagues[b.liga] || 0) + b.profit;
                analysis.markets[b.mercado] = (analysis.markets[b.mercado] || 0) + b.profit;
                const range = (Math.floor(b.cuota * 2) / 2).toFixed(1);
                const rKey = `${range}-${(parseFloat(range)+0.5).toFixed(1)}`;
                analysis.odds[rKey] = (analysis.odds[rKey] || 0) + b.profit;
            });

            fillList('top-leagues', analysis.leagues);
            fillList('top-markets', analysis.markets);
            fillList('top-odds', analysis.odds, 'Cuota');

            const bestMarket = Object.entries(analysis.markets).sort((a,b) => b[1]-a[1])[0]?.[0] || 'N/A';
            const bestRange = Object.entries(analysis.odds).sort((a,b) => b[1]-a[1])[0]?.[0] || 'N/A';

            document.getElementById('ai-recommendation').classList.remove('hidden');
            document.getElementById('rec-text').innerHTML = `
                Estrategia Maestra: Enfoque total en <span class="text-yellow-400 font-black">${bestMarket}</span> 
                dentro del rango de cuotas <span class="text-blue-400 font-black">${bestRange}</span>. 
                Los datos muestran que este patrón maximiza el Yield real.`;

            toggleModal();
        }

        function fillList(id, data, prefix = '') {
            const container = document.getElementById(id);
            if(!container) return;
            container.innerHTML = '';
            Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0, 5).forEach(([label, profit]) => {
                container.innerHTML += `<div class="insight-row"><span class="insight-label">${prefix} ${label}</span><span class="${profit >= 0 ? 'text-emerald-400' : 'text-red-400'} font-black">$${profit.toFixed(2)}</span></div>`;
            });
        }

        function toggleModal() {
            const m = document.getElementById('insights-modal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        function clearBacktest() { if(confirm('¿Borrar historial?')) { localStorage.removeItem('backtesting_data'); location.reload(); } }

        applyFilters();
    </script>
</body>
</html>

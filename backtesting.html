<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS - Quantum & Market Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .stats-grid > div { transition: all 0.3s ease; }
        .stats-grid > div:hover { transform: translateY(-2px); border-color: rgba(168, 85, 247, 0.4); }
        .market-row:nth-child(even) { background: rgba(255,255,255,0.02); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-400 tracking-tighter">
                    QUANTUM <span class="text-white underline decoration-blue-600">ANALYTICS</span>
                </h1>
                <div id="data-status" class="mt-2 flex gap-2"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearBacktestingData()" class="bg-red-500/10 text-red-400 px-4 py-2 rounded-xl text-xs font-bold border border-red-500/20 hover:bg-red-600 hover:text-white transition-all">
                    <i class="fa-solid fa-eraser mr-2"></i> RESET
                </button>
                <a href="index.html" class="bg-slate-800 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-700 transition-all border border-white/5">
                    <i class="fa-solid fa-chevron-left mr-2"></i> VOLVER AL MINERO
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            
            <div class="space-y-6">
                <div class="glass-card p-6 rounded-3xl shadow-2xl border-t-4 border-t-purple-500">
                    <h2 class="text-xs font-black text-purple-400 uppercase mb-4 tracking-widest flex items-center">
                        <i class="fa-solid fa-microchip mr-2"></i> Simulación
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase block mb-1">Caminos Aleatorios</label>
                            <input type="number" id="sim_runs" class="w-full bg-black/40 p-2 rounded-lg border border-white/10 text-sm font-mono text-white" value="200">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase block mb-1">Horizonte (Picks)</label>
                            <input type="number" id="sim_picks" class="w-full bg-black/40 p-2 rounded-lg border border-white/10 text-sm font-mono text-white" value="1000">
                        </div>
                        <button onclick="runMonteCarlo()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-black text-xs uppercase tracking-widest transition-all">
                            EJECUTAR MONTE CARLO
                        </button>
                    </div>
                </div>

                <div class="glass-card p-5 rounded-3xl">
                    <h2 class="text-xs font-black text-blue-400 uppercase mb-3 tracking-widest">Riesgo & Capital</h2>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[11px]"><span class="text-slate-400">Edge Real:</span> <span id="base-edge" class="text-emerald-400 font-bold">--</span></div>
                        <div class="flex justify-between text-[11px]"><span class="text-slate-400">Kelly (Full):</span> <span id="base-kelly" class="text-blue-400 font-bold">--</span></div>
                        <div class="flex justify-between text-[11px]"><span class="text-slate-400">P-Value:</span> <span id="base-pvalue" class="text-orange-400 font-bold">--</span></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 glass-card p-6 rounded-3xl overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xs font-black text-emerald-400 uppercase tracking-widest flex items-center">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Desglose por Liga / Mercado
                    </h2>
                    <span class="text-[10px] text-slate-500 italic font-mono">*Basado en picks resueltos</span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead>
                            <tr class="text-slate-500 border-b border-white/5">
                                <th class="pb-3 font-black uppercase tracking-tighter">Categoría</th>
                                <th class="pb-3 font-black uppercase tracking-tighter">Volumen</th>
                                <th class="pb-3 font-black uppercase tracking-tighter">W/L</th>
                                <th class="pb-3 font-black uppercase tracking-tighter">Cuota Med.</th>
                                <th class="pb-3 font-black uppercase tracking-tighter">Yield %</th>
                                <th class="pb-3 font-black uppercase tracking-tighter text-right">Profit</th>
                            </tr>
                        </thead>
                        <tbody id="market-analysis-body" class="font-mono text-slate-300">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-8 stats-grid">
            <div class="glass-card p-4 rounded-2xl border-b-2 border-b-red-500">
                <p class="text-[10px] text-slate-500 uppercase font-bold">Ruina</p>
                <p id="stat-ruin" class="text-2xl font-black text-white mt-1">--</p>
            </div>
            <div class="glass-card p-4 rounded-2xl border-b-2 border-b-orange-500">
                <p class="text-[10px] text-slate-500 uppercase font-bold">Max Drawdown</p>
                <p id="stat-mdd" class="text-2xl font-black text-white mt-1">--</p>
            </div>
            <div class="glass-card p-4 rounded-2xl border-b-2 border-b-emerald-500">
                <p class="text-[10px] text-slate-500 uppercase font-bold">Prob. Profit</p>
                <p id="stat-win-prob" class="text-2xl font-black text-white mt-1">--</p>
            </div>
            <div class="glass-card p-4 rounded-2xl border-b-2 border-b-blue-500">
                <p class="text-[10px] text-slate-500 uppercase font-bold">Mediana Final</p>
                <p id="stat-median" class="text-2xl font-black text-white mt-1">--</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 glass-card p-6 rounded-3xl h-[400px]">
                <canvas id="mcChart"></canvas>
            </div>
            <div class="glass-card p-6 rounded-3xl h-[400px]">
                <canvas id="distChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let mcChart, distChart;
        let simulationData = JSON.parse(localStorage.getItem('backtesting_data')) || 
                         JSON.parse(localStorage.getItem('betags_v3_miner'))?.filter(b => b.status !== 'pending') || [];

        function updateDataStatus() {
            const statusEl = document.getElementById('data-status');
            if (simulationData.length === 0) {
                statusEl.innerHTML = `<span class="text-red-400 text-[10px] font-bold italic">NO HAY DATOS RESUELTOS</span>`;
                return;
            }

            statusEl.innerHTML = `
                <span class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 text-[10px] font-bold border border-blue-500/30">
                    <i class="fa-solid fa-bolt mr-1"></i> ${simulationData.length} PICKS ANALIZADOS
                </span>
            `;

            analyzeMarkets();
        }

        function analyzeMarkets() {
            const groups = {};
            
            simulationData.forEach(pick => {
                // Intentamos agrupar por liga o mercado (usando campos comunes del minero)
                const category = pick.league || pick.liga || pick.market || pick.mercado || 'Otros';
                if (!groups[category]) {
                    groups[category] = { count: 0, wins: 0, losses: 0, totalOdd: 0, totalProfit: 0, investment: 0 };
                }
                
                const stake = parseFloat(pick.stake) || 1;
                const odd = parseFloat(pick.odd) || parseFloat(pick.cuota) || 0;
                const isWin = (pick.status === 'win' || pick.resultado === 'win');

                groups[category].count++;
                groups[category].investment += stake;
                groups[category].totalOdd += odd;

                if (isWin) {
                    groups[category].wins++;
                    groups[category].totalProfit += (stake * (odd - 1));
                } else {
                    groups[category].losses++;
                    groups[category].totalProfit -= stake;
                }
            });

            const tbody = document.getElementById('market-analysis-body');
            tbody.innerHTML = '';

            // Ordenar por profit de mayor a menor
            const sortedKeys = Object.keys(groups).sort((a,b) => groups[b].totalProfit - groups[a].totalProfit);

            sortedKeys.forEach(key => {
                const g = groups[key];
                const yieldPct = (g.totalProfit / g.investment) * 100;
                const avgOdd = g.totalOdd / g.count;
                const winRate = (g.wins / g.count) * 100;

                tbody.innerHTML += `
                    <tr class="market-row border-b border-white/5 hover:bg-white/5 transition-all">
                        <td class="py-3 font-bold text-white">${key.substring(0,20)}</td>
                        <td class="py-3">${g.count}</td>
                        <td class="py-3 text-[10px]">${g.wins}W / ${g.losses}L <span class="text-slate-500">(${winRate.toFixed(0)}%)</span></td>
                        <td class="py-3">${avgOdd.toFixed(2)}</td>
                        <td class="py-3 ${yieldPct >= 0 ? 'text-emerald-400' : 'text-red-400'}">${yieldPct.toFixed(1)}%</td>
                        <td class="py-3 text-right font-bold ${g.totalProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                            ${g.totalProfit >= 0 ? '+' : ''}${g.totalProfit.toFixed(2)}u
                        </td>
                    </tr>
                `;
            });

            // Actualizar métricas generales
            const totalWins = simulationData.filter(b => b.status === 'win' || b.resultado === 'win').length;
            const globalHitRate = totalWins / simulationData.length;
            const globalAvgOdd = simulationData.reduce((a, b) => a + (parseFloat(b.odd) || parseFloat(b.cuota) || 0), 0) / simulationData.length;
            const edge = (globalHitRate * globalAvgOdd) - 1;
            
            document.getElementById('base-edge').innerText = (edge * 100).toFixed(2) + "%";
            document.getElementById('base-kelly').innerText = (Math.max(0, edge / (globalAvgOdd - 1)) * 100).toFixed(1) + "%";
            
            // P-Value (Aproximación para saber si es suerte)
            const n = simulationData.length;
            const expectedWins = n * (1/globalAvgOdd);
            const z = (totalWins - expectedWins) / Math.sqrt(n * (1/globalAvgOdd) * (1 - 1/globalAvgOdd));
            document.getElementById('base-pvalue').innerText = z.toFixed(2);
        }

        function clearBacktestingData() {
            if(confirm("¿Limpiar historial?")) {
                localStorage.removeItem('backtesting_data');
                location.reload();
            }
        }

        function runMonteCarlo() {
            if (simulationData.length < 5) return alert("Pocos datos.");
            const runs = parseInt(document.getElementById('sim_runs').value);
            const picks = parseInt(document.getElementById('sim_picks').value);
            const totalWins = simulationData.filter(b => b.status === 'win' || b.resultado === 'win').length;
            const hitRate = totalWins / simulationData.length;
            const oddArray = simulationData.map(b => parseFloat(b.odd) || parseFloat(b.cuota) || 2.0);
            
            let allPaths = [], endValues = [], ruinCount = 0, positiveRuns = 0, drawdowns = [];

            for (let r = 0; r < runs; r++) {
                let path = [100], currentBank = 100, maxBank = 100, maxDD = 0;
                for (let p = 0; p < picks; p++) {
                    const win = Math.random() < hitRate;
                    const randomOdd = oddArray[Math.floor(Math.random() * oddArray.length)];
                    currentBank += win ? (randomOdd - 1) : -1;
                    if (currentBank <= 0) { currentBank = 0; ruinCount++; break; }
                    path.push(currentBank);
                    if (currentBank > maxBank) maxBank = currentBank;
                    let dd = (maxBank - currentBank) / maxBank;
                    if (dd > maxDD) maxDD = dd;
                }
                if (currentBank > 100) positiveRuns++;
                drawdowns.push(maxDD);
                endValues.push(currentBank);
                allPaths.push(path);
            }

            document.getElementById('stat-ruin').innerText = ((ruinCount / runs) * 100).toFixed(1) + "%";
            document.getElementById('stat-win-prob').innerText = ((positiveRuns / runs) * 100).toFixed(1) + "%";
            document.getElementById('stat-mdd').innerText = ((drawdowns.reduce((a,b)=>a+b,0)/runs)*100).toFixed(1) + "%";
            document.getElementById('stat-median').innerText = endValues.sort((a,b)=>a-b)[Math.floor(runs/2)].toFixed(1) + "u";

            renderCharts(allPaths, picks, endValues);
        }

        function renderCharts(paths, picks, endValues) {
            if (mcChart) mcChart.destroy();
            if (distChart) distChart.destroy();
            
            mcChart = new Chart(document.getElementById('mcChart'), {
                type: 'line',
                data: {
                    labels: Array.from({length: picks + 1}, (_, i) => i),
                    datasets: paths.slice(0, 40).map(p => ({
                        data: p, borderColor: 'rgba(59, 130, 246, 0.15)', borderWidth: 1, pointRadius: 0, fill: false
                    }))
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, 
                scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' } }, x: { display: false } } }
            });

            const bins = 12;
            const min = Math.min(...endValues), max = Math.max(...endValues);
            let histData = new Array(bins).fill(0), labels = [];
            for(let i=0; i<bins; i++) {
                labels.push((min + (i*(max-min)/bins)).toFixed(0) + "u");
                endValues.forEach(v => { if(v >= (min + (i*(max-min)/bins)) && v < (min + ((i+1)*(max-min)/bins))) histData[i]++; });
            }

            distChart = new Chart(document.getElementById('distChart'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ data: histData, backgroundColor: '#3b82f6' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        window.onload = () => { updateDataStatus(); if(simulationData.length >= 5) runMonteCarlo(); };
    </script>
</body>
</html>

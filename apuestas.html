<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Pro: Monitor de Desviación</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; --accent: #3b82f6; --purple: #a855f7; --cyan: #06b6d4; --border: #334155; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 10px; 
            margin: 0; 
            overflow-x: hidden; /* Evita desbordamiento lateral */
            line-height: 1.2;
        }

        .container { max-width: 100%; margin: auto; }
        
        .btn-nav { 
            display: block; 
            text-align: center; 
            padding: 10px; 
            color: var(--text); 
            text-decoration: none; 
            margin-bottom: 15px; 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            font-size: 12px; 
            font-weight: bold; 
            background: var(--card);
            text-transform: uppercase;
        }

        /* SECCIONES */
        .section-header { 
            font-size: 10px; 
            font-weight: 800; 
            color: #94a3b8; 
            text-transform: uppercase; 
            margin: 15px 0 8px 5px; 
            letter-spacing: 0.5px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .section-header::after { content: ""; flex-grow: 1; height: 1px; background: var(--border); }

        /* MONITOR DE DESVIACIÓN */
        .monitor-box { 
            background: linear-gradient(145deg, #1e293b, #0f172a); 
            border-radius: 15px; 
            border: 1px solid var(--cyan); 
            padding: 15px; 
            margin-bottom: 12px; 
            position: relative;
        }
        .monitor-box::before { 
            content: "LIVE MONITOR"; 
            position: absolute; 
            top: 8px; 
            right: 12px; 
            font-size: 7px; 
            font-weight: 900; 
            color: var(--cyan); 
            opacity: 0.6; 
        }
        
        .monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mon-item { display: flex; flex-direction: column; }
        .mon-label { font-size: 9px; font-weight: 700; color: var(--cyan); margin-bottom: 2px; }
        .mon-val { font-size: 20px; font-weight: 900; color: #fff; }
        .mon-sub { font-size: 10px; font-weight: bold; margin-top: 2px; }

        /* GESTIÓN DE RIESGO */
        .risk-card { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px; 
            margin-bottom: 12px; 
        }
        .input-group { 
            background: var(--card); 
            padding: 10px; 
            border-radius: 12px; 
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .input-group label { font-size: 8px; font-weight: bold; color: #64748b; margin-bottom: 4px; text-align: center; }
        .input-group input { 
            background: transparent; 
            border: none; 
            color: var(--gold); 
            width: 100%;
            font-weight: 800; 
            text-align: center; 
            font-size: 16px; 
            outline: none;
        }

        /* DASHBOARD */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .res-card { 
            background: var(--card); 
            padding: 12px; 
            border-radius: 15px; 
            border: 1px solid var(--border); 
            text-align: center; 
        }
        .res-label { font-size: 9px; color: #94a3b8; display: block; margin-bottom: 2px; }
        .res-val { font-size: 16px; font-weight: 800; }

        /* LISTAS Y TARJETAS */
        .bet-card { 
            background: var(--card); 
            border-radius: 15px; 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 1px solid var(--border); 
            border-left: 4px solid var(--gold); 
            position: relative; 
        }
        .bet-title { font-size: 15px; font-weight: 800; color: var(--accent); }
        .bet-calc { 
            background: rgba(59, 130, 246, 0.1); 
            padding: 8px; 
            border-radius: 10px; 
            margin: 10px 0; 
            text-align: center; 
            font-size: 12px;
        }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: 800; font-size: 11px; cursor: pointer; color: white; text-transform: uppercase; }
        .btn-win { background: var(--success); }
        .btn-loss { background: var(--danger); }

        /* HISTORIAL ESTILO CAPTURA */
        .hist-container { background: var(--card); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; }
        .hist-item { 
            padding: 10px 15px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 12px; 
        }
        .hist-item:last-child { border-bottom: none; }
        .pos { color: var(--success); font-weight: 800; }
        .neg { color: var(--danger); font-weight: 800; }
        
        .empty-msg { text-align: center; padding: 20px; opacity: 0.4; font-size: 11px; }
    </style>
</head>
<body>
<div class="container">
    <a href="estrategia.html" class="btn-nav">← VOLVER AL PORTAFOLIO</a>

    <div class="section-header">Monitor de Desviación</div>
    <div class="monitor-box">
        <div class="monitor-grid">
            <div class="mon-item">
                <span class="mon-label">ROI ESPERADO</span>
                <span id="expRoi" class="mon-val">0.0%</span>
                <span id="gapRoi" class="mon-sub">--</span>
            </div>
            <div class="mon-item">
                <span class="mon-label">OBJETIVO (U)</span>
                <span id="expUnits" class="mon-val">0.00</span>
                <span id="gapUnits" class="mon-sub">--</span>
            </div>
        </div>
    </div>

    <div class="section-header">Gestión de Capital</div>
    <div class="risk-card">
        <div class="input-group">
            <label>BANKROLL REAL ($)</label>
            <input type="number" id="bank" value="100" oninput="updateAll()">
        </div>
        <div class="input-group">
            <label>RIESGO BASE (%)</label>
            <input type="number" id="risk" value="1" step="0.5" oninput="updateAll()">
        </div>
    </div>

    <div class="results-grid">
        <div class="res-card">
            <span class="res-label">Balance Neto</span>
            <span id="realU" class="res-val">+0.00 u.</span>
        </div>
        <div class="res-card">
            <span class="res-label">Rendimiento</span>
            <span id="growth" class="res-val">0.0%</span>
        </div>
    </div>

    <div class="section-header">Apuestas Activas</div>
    <div id="pendingList"></div>

    <div class="section-header">Últimos Resultados</div>
    <div id="historyList" class="hist-container"></div>

    <button onclick="clearHistory()" style="width:100%; background:none; border:none; color:#475569; padding:20px; cursor:pointer; font-size:9px; font-weight:bold; letter-spacing:1px;">LIMPIAR HISTORIAL RESUELTO</button>
</div>

<script>
function updateAll() {
    localStorage.setItem('userBankroll', document.getElementById('bank').value);
    localStorage.setItem('userRiskPercent', document.getElementById('risk').value);
    render();
}

function render() {
    const bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const strategy = JSON.parse(localStorage.getItem('bettingStrategy') || "[]");
    const bank = parseFloat(localStorage.getItem('userBankroll') || 100);
    const risk = parseFloat(localStorage.getItem('userRiskPercent') || 1);

    document.getElementById('bank').value = bank;
    document.getElementById('risk').value = risk;

    let sumRoi = 0, sumExpUnits = 0;
    strategy.forEach(s => {
        sumExpUnits += parseFloat(s.unidades || 0);
        sumRoi += parseFloat(s.roi || 0);
    });
    const avgExpRoi = strategy.length > 0 ? (sumRoi / strategy.length) : 0;
    document.getElementById('expRoi').innerText = avgExpRoi.toFixed(1) + "%";
    document.getElementById('expUnits').innerText = sumExpUnits.toFixed(2);

    let balance = 0, totalInv = 0;
    const resolved = bets.filter(b => b.estado !== 'PENDIENTE');
    resolved.forEach(b => {
        const stake = parseFloat(b.stake) || 1;
        const odd = parseFloat(b.cuotaFinal) || 0;
        totalInv += stake;
        if(b.estado === 'WIN') balance += (stake * odd) - stake;
        else balance -= stake;
    });

    const realRoi = totalInv > 0 ? (balance / totalInv) * 100 : 0;
    document.getElementById('realU').innerText = (balance >= 0 ? '+' : '') + balance.toFixed(2) + " u.";
    document.getElementById('realU').className = `res-val ${balance >= 0 ? 'pos' : 'neg'}`;
    document.getElementById('growth').innerText = (balance * risk).toFixed(1) + "%";

    const gRoi = realRoi - avgExpRoi;
    const gRoiEl = document.getElementById('gapRoi');
    gRoiEl.innerText = `${gRoi >= 0 ? '↑' : '↓'} ${Math.abs(gRoi).toFixed(1)}% vs Plan`;
    gRoiEl.style.color = gRoi >= 0 ? 'var(--success)' : 'var(--danger)';

    const gUnits = balance - sumExpUnits;
    const gUnitsEl = document.getElementById('gapUnits');
    gUnitsEl.innerText = `${gUnits >= 0 ? 'Exceso' : 'Déficit'}: ${Math.abs(gUnits).toFixed(2)} u.`;
    gUnitsEl.style.color = gUnits >= 0 ? 'var(--gold)' : '#64748b';

    const unitVal = (bank * (risk / 100));
    const pending = bets.filter(b => b.estado === 'PENDIENTE');
    document.getElementById('pendingList').innerHTML = pending.length ? pending.map(b => `
        <div class="bet-card">
            <span class="bet-title">${b.equipo} <small style="opacity:0.5">@${b.cuotaFinal}</small></span>
            <div class="bet-calc">Inversión: <b>$${(unitVal * (parseFloat(b.stake)||1)).toFixed(2)}</b></div>
            <div class="btn-group">
                <button class="btn btn-win" onclick="solve('${b.fechaColocada}', 'WIN')">WIN</button>
                <button class="btn btn-loss" onclick="solve('${b.fechaColocada}', 'LOSS')">LOSS</button>
            </div>
        </div>
    `).join('') : '<div class="empty-msg">No hay apuestas activas.</div>';

    const history = bets.filter(b => b.estado !== 'PENDIENTE').reverse().slice(0, 10);
    document.getElementById('historyList').innerHTML = history.length ? history.map(b => `
        <div class="hist-item" onclick="removeBet('${b.fechaColocada}')">
            <span><b>${b.equipo}</b> <small style="opacity:0.5;">@${b.cuotaFinal}</small></span>
            <span class="${b.estado === 'WIN' ? 'pos' : 'neg'}">${b.estado}</span>
        </div>
    `).join('') : '<div class="empty-msg">Historial vacío.</div>';
}

function solve(id, res) {
    let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const i = bets.findIndex(b => b.fechaColocada === id);
    if(i !== -1) { bets[i].estado = res; localStorage.setItem('activeBets', JSON.stringify(bets)); render(); }
}

function removeBet(id) {
    if(confirm('¿Eliminar este registro?')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.fechaColocada !== id)));
        render();
    }
}

function clearHistory() {
    if(confirm('¿Borrar historial resuelto?')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.estado === 'PENDIENTE')));
        render();
    }
}

window.onload = render;
</script>
</body>
</html>

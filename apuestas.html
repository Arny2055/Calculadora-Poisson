<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Pro: Monitor de Desviación & Backtesting</title>
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; 
            --danger: #ef4444; --gold: #fbbf24; --accent: #3b82f6; --purple: #a855f7; 
            --cyan: #06b6d4; --border: #334155; 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 10px; 
            margin: 0; 
            overflow-x: hidden; 
            line-height: 1.3;
        }

        .container { max-width: 100%; margin: auto; }
        
        .btn-nav { 
            display: block; text-align: center; padding: 12px; color: var(--text); 
            text-decoration: none; margin-bottom: 15px; border: 1px solid var(--border); 
            border-radius: 12px; font-size: 12px; font-weight: bold; background: var(--card);
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* CABECERAS DE SECCIÓN */
        .section-header { 
            font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; 
            margin: 20px 0 10px 5px; letter-spacing: 0.8px; display: flex; 
            align-items: center; gap: 8px; 
        }
        .section-header::after { content: ""; flex-grow: 1; height: 1px; background: var(--border); }

        /* MONITOR DE DESVIACIÓN (SISTEMA VS REALIDAD) */
        .monitor-box { 
            background: linear-gradient(145deg, #1e293b, #0f172a); 
            border-radius: 18px; border: 1px solid var(--cyan); 
            padding: 18px; margin-bottom: 15px; position: relative; 
        }
        .monitor-box::before { 
            content: "LIVE MONITOR"; position: absolute; top: 10px; right: 15px; 
            font-size: 7px; font-weight: 900; color: var(--cyan); opacity: 0.6; 
        }
        
        .monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .mon-item { display: flex; flex-direction: column; }
        .mon-label { font-size: 9px; font-weight: 700; color: var(--cyan); margin-bottom: 4px; }
        .mon-val { font-size: 22px; font-weight: 900; color: #fff; }
        .mon-sub { font-size: 11px; font-weight: bold; margin-top: 3px; }

        /* GESTIÓN DE CAPITAL */
        .risk-card { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .input-group { 
            background: var(--card); padding: 12px; border-radius: 15px; 
            border: 1px solid var(--border); display: flex; flex-direction: column; 
            align-items: center; 
        }
        .input-group label { font-size: 8px; font-weight: bold; color: #64748b; margin-bottom: 6px; }
        .input-group input { 
            background: transparent; border: none; color: var(--gold); 
            width: 100%; font-weight: 800; text-align: center; font-size: 18px; outline: none; 
        }

        /* BACKTESTING POR LIGAS */
        .backtest-container { 
            background: var(--card); border-radius: 18px; border: 1px solid var(--purple); 
            padding: 15px; margin-bottom: 15px; 
        }
        .backtest-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0; border-bottom: 1px solid rgba(168, 85, 247, 0.1); 
            font-size: 12px; 
        }
        .backtest-item:last-child { border-bottom: none; }
        .tag-win { color: var(--success); font-weight: bold; }
        .tag-loss { color: var(--danger); font-weight: bold; }

        /* RESULTADOS RÁPIDOS */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .res-card { 
            background: var(--card); padding: 15px; border-radius: 18px; 
            border: 1px solid var(--border); text-align: center; 
        }
        .res-label { font-size: 9px; color: #94a3b8; display: block; margin-bottom: 4px; }
        .res-val { font-size: 18px; font-weight: 800; }

        /* TARJETAS DE APUESTAS ACTIVAS */
        .bet-card { 
            background: var(--card); border-radius: 18px; padding: 18px; 
            margin-bottom: 12px; border: 1px solid var(--border); 
            border-left: 5px solid var(--gold); position: relative; 
        }
        .bet-title { font-size: 16px; font-weight: 800; color: var(--accent); margin-bottom: 4px; display: block; }
        .bet-strat { font-size: 10px; color: var(--gold); font-weight: bold; margin-bottom: 10px; display: block; }
        .bet-calc { 
            background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 12px; 
            border: 1px dashed var(--accent); margin-bottom: 15px; text-align: center; 
        }
        .bet-calc b { color: #fff; font-size: 16px; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { 
            border: none; padding: 14px; border-radius: 12px; font-weight: 800; 
            font-size: 12px; cursor: pointer; color: white; text-transform: uppercase; 
        }
        .btn-win { background: var(--success); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        .btn-loss { background: var(--danger); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); }
        .btn-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #475569; font-size: 18px; }

        /* HISTORIAL */
        .hist-container { background: var(--card); border-radius: 18px; border: 1px solid var(--border); overflow: hidden; }
        .hist-item { 
            padding: 12px 18px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 13px; 
        }
        .hist-item:last-child { border-bottom: none; }
        .pos { color: var(--success); font-weight: bold; }
        .neg { color: var(--danger); font-weight: bold; }
        .empty-msg { text-align: center; padding: 30px; opacity: 0.4; font-size: 12px; }
    </style>
</head>
<body>
<div class="container">
    <a href="estrategia.html" class="btn-nav">← VOLVER AL PORTAFOLIO</a>

    <div class="section-header">Monitor de Desviación</div>
    <div class="monitor-box">
        <div class="monitor-grid">
            <div class="mon-item">
                <span class="mon-label">ROI ESPERADO</span>
                <span id="expRoi" class="mon-val">0.0%</span>
                <span id="gapRoi" class="mon-sub">--</span>
            </div>
            <div class="mon-item">
                <span class="mon-label">OBJETIVO (U)</span>
                <span id="expUnits" class="mon-val">0.00</span>
                <span id="gapUnits" class="mon-sub">--</span>
            </div>
        </div>
    </div>

    <div class="section-header">Backtesting por Liga/Estrategia</div>
    <div id="backtestList" class="backtest-container">
        <div style="text-align:center; font-size:11px; opacity:0.5; padding: 10px;">Sin datos suficientes para backtesting.</div>
    </div>

    <div class="section-header">Gestión de Capital</div>
    <div class="risk-card">
        <div class="input-group">
            <label>BANKROLL REAL ($)</label>
            <input type="number" id="bank" value="100" oninput="updateAll()">
        </div>
        <div class="input-group">
            <label>RIESGO BASE (%)</label>
            <input type="number" id="risk" value="1" step="0.5" oninput="updateAll()">
        </div>
    </div>

    <div class="results-grid">
        <div class="res-card">
            <span class="res-label">Balance Neto</span>
            <span id="realU" class="res-val">+0.00 u.</span>
        </div>
        <div class="res-card">
            <span class="res-label">Rendimiento</span>
            <span id="growth" class="res-val">0.0%</span>
        </div>
    </div>

    <div class="section-header">Apuestas Activas</div>
    <div id="pendingList"></div>

    <div class="section-header">Últimos Resultados</div>
    <div id="historyList" class="hist-container"></div>

    <button onclick="clearHistory()" style="width:100%; background:none; border:none; color:#475569; padding:25px; cursor:pointer; font-size:10px; font-weight:bold; letter-spacing:1px; text-decoration: underline;">LIMPIAR HISTORIAL RESUELTO</button>
</div>

<script>
// Función maestra para guardar y renderizar
function updateAll() {
    localStorage.setItem('userBankroll', document.getElementById('bank').value);
    localStorage.setItem('userRiskPercent', document.getElementById('risk').value);
    render();
}

function render() {
    const bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const strategy = JSON.parse(localStorage.getItem('bettingStrategy') || "[]");
    const bank = parseFloat(localStorage.getItem('userBankroll') || 100);
    const risk = parseFloat(localStorage.getItem('userRiskPercent') || 1);

    // Sincronizar inputs
    document.getElementById('bank').value = bank;
    document.getElementById('risk').value = risk;

    // 1. PROCESAR EXPECTATIVA (Desde Portafolio)
    let sumRoi = 0, sumExpUnits = 0;
    strategy.forEach(s => {
        sumExpUnits += parseFloat(s.unidades || 0);
        sumRoi += parseFloat(s.roi || 0);
    });
    const avgExpRoi = strategy.length > 0 ? (sumRoi / strategy.length) : 0;
    document.getElementById('expRoi').innerText = avgExpRoi.toFixed(1) + "%";
    document.getElementById('expUnits').innerText = sumExpUnits.toFixed(2);

    // 2. PROCESAR REALIDAD Y BACKTESTING (Desde Historial)
    let balance = 0, totalInv = 0;
    let ligaStats = {}; // Contenedor para Backtesting

    const resolved = bets.filter(b => b.estado !== 'PENDIENTE');
    resolved.forEach(b => {
        const stake = parseFloat(b.stake) || 1;
        const odd = parseFloat(b.cuotaFinal) || 0;
        const liga = b.estrategia || "General";
        
        // Lógica de Backtesting por Liga
        if(!ligaStats[liga]) ligaStats[liga] = { units: 0, total: 0 };
        ligaStats[liga].total++;

        totalInv += stake;
        if(b.estado === 'WIN') {
            const profit = (stake * odd) - stake;
            balance += profit;
            ligaStats[liga].units += profit;
        } else {
            balance -= stake;
            ligaStats[liga].units -= stake;
        }
    });

    // Renderizar Backtesting
    const backtestEl = document.getElementById('backtestList');
    const statsKeys = Object.keys(ligaStats);
    if(statsKeys.length > 0) {
        backtestEl.innerHTML = statsKeys.map(k => `
            <div class="backtest-item">
                <span><b>${k}</b> <small style="opacity:0.6">(${ligaStats[k].total} part.)</small></span>
                <span class="${ligaStats[k].units >= 0 ? 'tag-win' : 'tag-loss'}">
                    ${ligaStats[k].units >= 0 ? '+' : ''}${ligaStats[k].units.toFixed(2)} u.
                </span>
            </div>
        `).join('');
    }

    // Dashboard Principal
    const realRoi = totalInv > 0 ? (balance / totalInv) * 100 : 0;
    document.getElementById('realU').innerText = (balance >= 0 ? '+' : '') + balance.toFixed(2) + " u.";
    document.getElementById('realU').className = `res-val ${balance >= 0 ? 'pos' : 'neg'}`;
    document.getElementById('growth').innerText = (balance * risk).toFixed(1) + "%";

    // Monitor de Desviación (Cálculo de Gap)
    const gRoi = realRoi - avgExpRoi;
    const gRoiEl = document.getElementById('gapRoi');
    gRoiEl.innerText = `${gRoi >= 0 ? '↑' : '↓'} ${Math.abs(gRoi).toFixed(1)}% vs Plan`;
    gRoiEl.style.color = gRoi >= 0 ? 'var(--success)' : 'var(--danger)';

    const gUnits = balance - sumExpUnits;
    const gUnitsEl = document.getElementById('gapUnits');
    gUnitsEl.innerText = `${gUnits >= 0 ? 'Exceso' : 'Déficit'}: ${Math.abs(gUnits).toFixed(2)} u.`;
    gUnitsEl.style.color = gUnits >= 0 ? 'var(--gold)' : '#64748b';

    // 3. RENDERIZAR LISTAS (Pendientes y Pasadas)
    const unitVal = (bank * (risk / 100));
    const pending = bets.filter(b => b.estado === 'PENDIENTE');
    document.getElementById('pendingList').innerHTML = pending.length ? pending.map(b => `
        <div class="bet-card">
            <button class="btn-close" onclick="removeBet('${b.fechaColocada}')">✕</button>
            <span class="bet-strat">${b.estrategia}</span>
            <span class="bet-title">${b.equipo} <small style="opacity:0.5">@${b.cuotaFinal}</small></span>
            <div class="bet-calc">Inversión Sugerida: <b>$${(unitVal * (parseFloat(b.stake)||1)).toFixed(2)}</b></div>
            <div class="btn-group">
                <button class="btn btn-win" onclick="solve('${b.fechaColocada}', 'WIN')">WIN</button>
                <button class="btn btn-loss" onclick="solve('${b.fechaColocada}', 'LOSS')">LOSS</button>
            </div>
        </div>
    `).join('') : '<div class="empty-msg">No hay apuestas activas por ahora.</div>';

    const history = bets.filter(b => b.estado !== 'PENDIENTE').reverse().slice(0, 10);
    document.getElementById('historyList').innerHTML = history.length ? history.map(b => `
        <div class="hist-item" onclick="removeBet('${b.fechaColocada}')">
            <span><b>${b.equipo}</b> <small style="opacity:0.5;">@${b.cuotaFinal}</small></span>
            <span class="${b.estado === 'WIN' ? 'pos' : 'neg'}">${b.estado}</span>
        </div>
    `).join('') : '<div class="empty-msg">El historial está vacío.</div>';
}

function solve(id, res) {
    let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const i = bets.findIndex(b => b.fechaColocada === id);
    if(i !== -1) { 
        bets[i].estado = res; 
        localStorage.setItem('activeBets', JSON.stringify(bets)); 
        render(); 
    }
}

function removeBet(id) {
    if(confirm('¿Seguro que quieres eliminar este registro permanentemente?')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.fechaColocada !== id)));
        render();
    }
}

function clearHistory() {
    if(confirm('¿Eliminar todo el historial resuelto? Esto reiniciará el Monitor de Desviación.')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.estado === 'PENDIENTE')));
        render();
    }
}

// Iniciar al cargar
window.onload = render;
</script>
</body>
</html>

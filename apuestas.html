<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Pro: Monitor de Desviación</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; --accent: #3b82f6; --purple: #a855f7; --cyan: #06b6d4; --border: #334155; }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; line-height: 1.4; }
        .container { max-width: 500px; margin: auto; }
        
        .btn-nav { display: block; text-align: center; padding: 12px; color: var(--text); text-decoration: none; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 12px; font-size: 13px; font-weight: bold; background: var(--card); }

        /* SECCIONES PRINCIPALES */
        .section-header { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin: 20px 0 10px 5px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .section-header::after { content: ""; flex-grow: 1; height: 1px; background: var(--border); }

        /* MONITOR DE DESVIACIÓN (TEORÍA VS REALIDAD) */
        .monitor-box { background: linear-gradient(145deg, #1e293b, #0f172a); border-radius: 20px; border: 1px solid var(--cyan); padding: 20px; margin-bottom: 15px; position: relative; overflow: hidden; }
        .monitor-box::before { content: "LIVE MONITOR"; position: absolute; top: 10px; right: 15px; font-size: 8px; font-weight: 900; color: var(--cyan); opacity: 0.5; }
        
        .monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .mon-item { display: flex; flex-direction: column; }
        .mon-label { font-size: 10px; font-weight: 700; color: var(--cyan); margin-bottom: 4px; }
        .mon-val { font-size: 22px; font-weight: 900; color: #fff; }
        .mon-sub { font-size: 11px; font-weight: bold; margin-top: 2px; }

        /* GESTIÓN DE RIESGO Y BANKROLL */
        .risk-card { background: var(--card); border-radius: 20px; border: 1px solid var(--border); padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 9px; font-weight: bold; color: #64748b; }
        .input-group input { background: #0f172a; border: 1px solid var(--border); color: var(--gold); padding: 10px; border-radius: 10px; font-weight: 800; text-align: center; font-size: 14px; }

        /* DASHBOARD DE RESULTADOS */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .res-card { background: var(--card); padding: 15px; border-radius: 18px; border: 1px solid var(--border); text-align: center; }
        .res-label { font-size: 10px; color: #94a3b8; display: block; margin-bottom: 4px; }
        .res-val { font-size: 18px; font-weight: 800; }

        /* TARJETAS DE APUESTAS PENDIENTES */
        .bet-card { background: var(--card); border-radius: 18px; padding: 18px; margin-bottom: 12px; border: 1px solid var(--border); border-left: 5px solid var(--gold); position: relative; }
        .bet-title { font-size: 16px; font-weight: 800; color: var(--accent); margin-bottom: 4px; display: block; }
        .bet-strat { font-size: 10px; color: var(--gold); font-weight: bold; margin-bottom: 12px; display: block; }
        .bet-calc { background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 12px; border: 1px dashed var(--accent); margin-bottom: 15px; text-align: center; }
        .bet-calc b { color: #fff; font-size: 15px; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { border: none; padding: 14px; border-radius: 12px; font-weight: 800; font-size: 12px; cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px; }
        .btn-win { background: var(--success); box-shadow: 0 4px 14px rgba(16, 185, 129, 0.2); }
        .btn-loss { background: var(--danger); box-shadow: 0 4px 14px rgba(239, 68, 68, 0.2); }
        
        .btn-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #475569; font-size: 18px; cursor: pointer; }

        /* HISTORIAL */
        .hist-container { background: var(--card); border-radius: 18px; overflow: hidden; border: 1px solid var(--border); }
        .hist-item { padding: 12px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .pos { color: var(--success); font-weight: 800; }
        .neg { color: var(--danger); font-weight: 800; }
    </style>
</head>
<body>
<div class="container">
    <a href="estrategia.html" class="btn-nav">← VOLVER AL PORTAFOLIO</a>

    <div class="section-header">Monitor de Desviación</div>
    <div class="monitor-box">
        <div class="monitor-grid">
            <div class="mon-item">
                <span class="mon-label">ROI ESPERADO</span>
                <span id="expRoi" class="mon-val">0.0%</span>
                <span id="gapRoi" class="mon-sub">--</span>
            </div>
            <div class="mon-item">
                <span class="mon-label">OBJETIVO (U)</span>
                <span id="expUnits" class="mon-val">0.00</span>
                <span id="gapUnits" class="mon-sub">--</span>
            </div>
        </div>
    </div>

    <div class="section-header">Gestión de Capital</div>
    <div class="risk-card">
        <div class="input-group">
            <label>BANKROLL REAL ($)</label>
            <input type="number" id="bank" value="1000" oninput="updateAll()">
        </div>
        <div class="input-group">
            <label>RIESGO BASE (%)</label>
            <input type="number" id="risk" value="1" step="0.5" oninput="updateAll()">
        </div>
    </div>

    <div class="results-grid">
        <div class="res-card">
            <span class="res-label">Balance Neto</span>
            <span id="realU" class="res-val">0.00 u.</span>
        </div>
        <div class="res-card">
            <span class="res-label">Rendimiento</span>
            <span id="growth" class="res-val">0.0%</span>
        </div>
    </div>

    <div class="section-header">Apuestas Activas</div>
    <div id="pendingList"></div>

    <div class="section-header">Últimos Resultados</div>
    <div id="historyList" class="hist-container"></div>

    <button onclick="clearHistory()" style="width:100%; background:none; border:none; color:#475569; text-decoration:underline; padding:20px; cursor:pointer; font-size:10px; font-weight:bold;">LIMPIAR HISTORIAL RESUELTO</button>
</div>

<script>
function updateAll() {
    localStorage.setItem('userBankroll', document.getElementById('bank').value);
    localStorage.setItem('userRiskPercent', document.getElementById('risk').value);
    render();
}

function render() {
    const bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const strategy = JSON.parse(localStorage.getItem('bettingStrategy') || "[]");
    const bank = parseFloat(localStorage.getItem('userBankroll') || 1000);
    const risk = parseFloat(localStorage.getItem('userRiskPercent') || 1);

    document.getElementById('bank').value = bank;
    document.getElementById('risk').value = risk;

    // 1. EXPECTATIVA (Estrategia)
    let sumRoi = 0, sumExpUnits = 0;
    strategy.forEach(s => {
        sumExpUnits += parseFloat(s.unidades || 0);
        sumRoi += parseFloat(s.roi || 0);
    });
    const avgExpRoi = strategy.length > 0 ? (sumRoi / strategy.length) : 0;
    document.getElementById('expRoi').innerText = avgExpRoi.toFixed(1) + "%";
    document.getElementById('expUnits').innerText = sumExpUnits.toFixed(2);

    // 2. REALIDAD (Apuestas)
    let balance = 0, totalInv = 0;
    const resolved = bets.filter(b => b.estado !== 'PENDIENTE');
    resolved.forEach(b => {
        const stake = parseFloat(b.stake) || 1;
        const odd = parseFloat(b.cuotaFinal) || 0;
        totalInv += stake;
        if(b.estado === 'WIN') balance += (stake * odd) - stake;
        else balance -= stake;
    });

    const realRoi = totalInv > 0 ? (balance / totalInv) * 100 : 0;
    document.getElementById('realU').innerText = (balance >= 0 ? '+' : '') + balance.toFixed(2) + " u.";
    document.getElementById('realU').className = `res-val ${balance >= 0 ? 'pos' : 'neg'}`;
    document.getElementById('growth').innerText = (balance * risk).toFixed(1) + "%";

    // 3. COMPARACIÓN
    const gRoi = realRoi - avgExpRoi;
    const gRoiEl = document.getElementById('gapRoi');
    gRoiEl.innerText = `${gRoi >= 0 ? '↑' : '↓'} ${Math.abs(gRoi).toFixed(1)}% vs Plan`;
    gRoiEl.style.color = gRoi >= 0 ? 'var(--success)' : 'var(--danger)';

    const gUnits = balance - sumExpUnits;
    const gUnitsEl = document.getElementById('gapUnits');
    gUnitsEl.innerText = `${gUnits >= 0 ? 'Exceso' : 'Déficit'}: ${Math.abs(gUnits).toFixed(2)} u.`;
    gUnitsEl.style.color = gUnits >= 0 ? 'var(--gold)' : '#64748b';

    // 4. RENDER LISTAS
    const unitVal = (bank * (risk / 100));
    const pending = bets.filter(b => b.estado === 'PENDIENTE');
    document.getElementById('pendingList').innerHTML = pending.map(b => `
        <div class="bet-card">
            <button class="btn-close" onclick="removeBet('${b.fechaColocada}')">✕</button>
            <span class="bet-strat">${b.estrategia}</span>
            <span class="bet-title">${b.equipo} @${b.cuotaFinal}</span>
            <div class="bet-calc">Monto Sugerido: <b>$${(unitVal * (parseFloat(b.stake)||1)).toFixed(2)}</b></div>
            <div class="btn-group">
                <button class="btn btn-win" onclick="solve('${b.fechaColocada}', 'WIN')">¡Ganada!</button>
                <button class="btn btn-loss" onclick="solve('${b.fechaColocada}', 'LOSS')">Perdida</button>
            </div>
        </div>
    `).join('') || "<p style='text-align:center; opacity:0.4; font-size:12px;'>No hay apuestas activas.</p>";

    const history = bets.filter(b => b.estado !== 'PENDIENTE').reverse().slice(0, 8);
    document.getElementById('historyList').innerHTML = history.map(b => `
        <div class="hist-item">
            <span><b>${b.equipo}</b> <small style="opacity:0.5;">@${b.cuotaFinal}</small></span>
            <span class="${b.estado === 'WIN' ? 'pos' : 'neg'}">${b.estado}</span>
        </div>
    `).join('');
}

function solve(id, res) {
    let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const i = bets.findIndex(b => b.fechaColocada === id);
    if(i !== -1) { bets[i].estado = res; localStorage.setItem('activeBets', JSON.stringify(bets)); render(); }
}

function removeBet(id) {
    if(confirm('¿Eliminar registro?')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.fechaColocada !== id)));
        render();
    }
}

function clearHistory() {
    if(confirm('¿Borrar historial resuelto?')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.estado === 'PENDIENTE')));
        render();
    }
}

window.onload = render;
</script>
</body>
</html>

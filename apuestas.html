<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Pro: Bankroll, Varianza y Valor</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; --accent: #3b82f6; --purple: #a855f7; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .container { max-width: 600px; margin: auto; }
        
        .btn-nav { display: block; text-align: center; padding: 12px; color: var(--text); text-decoration: none; margin-bottom: 20px; border: 1px solid #334155; border-radius: 12px; font-size: 13px; font-weight: bold; background: var(--card); }

        /* GESTI√ìN DE BANKROLL */
        .bank-manager { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 15px; border-radius: 16px; border: 1px solid var(--accent); margin-bottom: 10px; }
        .bank-input-group { display: flex; justify-content: space-between; align-items: center; }
        .bank-input-group input { background: #0f172a; border: 1px solid #334155; color: var(--gold); padding: 8px; border-radius: 8px; width: 100px; text-align: center; font-weight: bold; }
        .bank-label { font-size: 11px; font-weight: bold; color: var(--accent); text-transform: uppercase; }

        /* PANEL DE VARIANZA */
        .variance-panel { background: linear-gradient(135deg, #1e293b 0%, #2e1065 100%); padding: 15px; border-radius: 16px; border: 1px solid var(--purple); margin-bottom: 15px; text-align: center; }
        .variance-title { font-size: 10px; font-weight: 900; color: var(--purple); letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .confidence-meter { font-size: 22px; font-weight: 900; color: white; margin: 2px 0; }
        .variance-desc { font-size: 10px; opacity: 0.8; line-height: 1.3; }

        .performance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .perf-card { background: var(--card); padding: 15px; border-radius: 16px; border: 1px solid #334155; text-align: center; }
        .perf-label { font-size: 10px; text-transform: uppercase; color: #94a3b8; margin-bottom: 5px; display: block; }
        .perf-val { font-size: 19px; font-weight: 800; }

        .stats-bar-container { background: var(--card); border-radius: 16px; padding: 15px; border: 1px solid #334155; margin-bottom: 20px; }
        .stats-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 8px; font-weight: bold; }
        .hit-rate-bg { width: 100%; height: 12px; background: var(--danger); border-radius: 6px; overflow: hidden; display: flex; }
        .hit-rate-fill { height: 100%; background: var(--success); transition: width 0.5s ease; }
        .bcl-tag { font-size: 10px; color: var(--purple); margin-top: 10px; display: block; text-align: center; font-weight: bold; }

        h3 { font-size: 14px; color: var(--gold); border-left: 3px solid var(--gold); padding-left: 10px; margin: 25px 0 15px 0; text-transform: uppercase; }

        /* TARJETAS */
        .bet-card { background: var(--card); border-radius: 14px; padding: 15px; margin-bottom: 12px; border: 1px solid #334155; border-left: 4px solid var(--gold); position: relative; }
        .bet-main { font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
        .closing-input-area { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .closing-input-area input { width: 100%; background: #1e293b; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; font-size: 12px; text-align: center; }
        
        .bet-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-action { border: none; padding: 12px; border-radius: 8px; font-weight: 800; font-size: 12px; cursor: pointer; color: white; text-transform: uppercase; }
        .btn-win { background: var(--success); }
        .btn-loss { background: var(--danger); }
        .btn-del-single { position: absolute; top: 12px; right: 12px; background: none; border: none; color: #475569; font-size: 16px; cursor: pointer; }

        .history-list { background: var(--card); border-radius: 14px; overflow: hidden; border: 1px solid #334155; }
        .history-item { padding: 12px 15px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; font-size: 13px; position: relative; }
        .val-pos { color: var(--success); } .val-neg { color: var(--danger); }
    </style>
</head>
<body>
<div class="container">
    <a href="estrategia.html" class="btn-nav">‚Üê VOLVER AL PORTAFOLIO</a>

    <div class="bank-manager">
        <div class="bank-input-group">
            <span class="bank-label">üè¶ Bankroll Total:</span>
            <input type="number" id="bankTotal" value="1000" oninput="saveBank()">
        </div>
    </div>

    <div class="variance-panel">
        <span class="variance-title">üî¨ FIABILIDAD DEL SISTEMA (VARIANZA)</span>
        <div id="confidenceVal" class="confidence-meter">--%</div>
        <p id="varianceText" class="variance-desc">Analizando historial para calcular consistencia...</p>
    </div>

    <div class="performance-grid">
        <div class="perf-card">
            <span class="perf-label">Balance</span>
            <span id="realUnits" class="perf-val">0.00 u.</span>
        </div>
        <div class="perf-card">
            <span class="perf-label">Crecimiento</span>
            <span id="bankGrowth" class="perf-val">0.0%</span>
        </div>
    </div>

    <div class="stats-bar-container">
        <div class="stats-header"><span>HIT RATE</span> <span id="hitPercent">0%</span></div>
        <div class="hit-rate-bg"><div id="hitBar" class="hit-rate-fill" style="width: 0%"></div></div>
        <div style="display:flex; justify-content: space-around; font-size:11px; margin-top:10px;">
            <span>G: <b id="winCount">0</b></span> <span>P: <b id="lossCount">0</b></span>
        </div>
        <span id="bclMetric" class="bcl-tag">Venciendo al cierre (BCL): 0%</span>
    </div>

    <h3>üéØ Apuestas Pendientes</h3>
    <div id="pendingBets"></div>

    <h3>üìú Historial Reciente</h3>
    <div id="historyBets" class="history-list"></div>

    <button onclick="clearHistory()" style="width:100%; background:none; border:none; color:#475569; text-decoration:underline; padding:20px; cursor:pointer; font-size:11px;">Borrar Historial Resuelto</button>
</div>

<script>
function saveBank() {
    localStorage.setItem('userBankroll', document.getElementById('bankTotal').value);
    loadBets();
}

// C√ÅLCULO DE VARIANZA PROFESIONAL
function calculateVariance(wins, total, avgOdd) {
    if (total < 5) return null;
    const expectedWinRate = 1 / (avgOdd || 2);
    const stdDev = Math.sqrt(total * expectedWinRate * (1 - expectedWinRate));
    const expectedWins = total * expectedWinRate;
    const zScore = (wins - expectedWins) / (stdDev || 1);
    let confidence = 0;
    if (zScore <= 0) confidence = Math.max(5, 50 + (zScore * 20)); 
    else confidence = Math.min(99, 50 + (zScore * 25));
    return { score: Math.round(confidence), z: zScore };
}

function loadBets() {
    const allBets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const bank = parseFloat(localStorage.getItem('userBankroll') || 1000);
    document.getElementById('bankTotal').value = bank;

    let balanceNeto = 0, totalInvertido = 0, wins = 0, losses = 0, sumOdds = 0, bclCount = 0;
    const resolved = allBets.filter(b => b.estado !== 'PENDIENTE');

    resolved.forEach(b => {
        const stake = parseFloat(b.stake) || 0;
        const cuota = parseFloat(b.cuotaFinal) || 0;
        const closing = parseFloat(b.closingOdd) || 0;
        totalInvertido += stake;
        sumOdds += cuota;
        if(b.estado === 'WIN') { balanceNeto += (stake * cuota) - stake; wins++; } 
        else { balanceNeto -= stake; losses++; }
        if (closing > 0 && cuota > closing) bclCount++;
    });

    // Actualizar UI General
    document.getElementById('realUnits').innerText = `${balanceNeto >= 0 ? '+' : ''}${balanceNeto.toFixed(2)} u.`;
    document.getElementById('realUnits').className = `perf-val ${balanceNeto >= 0 ? 'val-pos' : 'val-neg'}`;
    
    const growth = (balanceNeto / bank) * 100;
    document.getElementById('bankGrowth').innerText = `${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%`;
    document.getElementById('bankGrowth').className = `perf-val ${growth >= 0 ? 'val-pos' : 'val-neg'}`;

    const hitRate = resolved.length > 0 ? Math.round((wins / resolved.length) * 100) : 0;
    document.getElementById('hitPercent').innerText = hitRate + "%";
    document.getElementById('hitBar').style.width = hitRate + "%";
    document.getElementById('winCount').innerText = wins;
    document.getElementById('lossCount').innerText = losses;

    const bclRate = resolved.length > 0 ? Math.round((bclCount / resolved.length) * 100) : 0;
    document.getElementById('bclMetric').innerText = `Venciendo al cierre (BCL): ${bclRate}% de las veces`;

    // Actualizar Panel Varianza
    const avgOdd = resolved.length > 0 ? (sumOdds / resolved.length) : 0;
    const varResult = calculateVariance(wins, resolved.length, avgOdd);
    if(varResult) {
        document.getElementById('confidenceVal').innerText = varResult.score + "%";
        document.getElementById('varianceText').innerText = varResult.score > 80 ? "SISTEMA FIABLE: Ventaja matem√°tica confirmada." : 
                                                           varResult.score < 40 ? "ALTA VARIANZA: Cuidado, los resultados pueden ser azar." : "NEUTRAL: Operando bajo la media estad√≠stica.";
    }

    // Listas
    renderLists(allBets);
}

function renderLists(allBets) {
    const pending = allBets.filter(b => b.estado === 'PENDIENTE');
    document.getElementById('pendingBets').innerHTML = pending.map((b) => `
        <div class="bet-card">
            <button class="btn-del-single" onclick="deleteSingle('${b.fechaColocada}')">‚úï</button>
            <div class="bet-header"><span>${b.estrategia}</span></div>
            <div class="bet-main">${b.equipo} @${b.cuotaFinal}</div>
            <div class="closing-input-area">
                <input type="number" step="0.01" id="close-${b.fechaColocada.replace(/\D/g,'')}" placeholder="Cuota de Cierre (Opcional)">
            </div>
            <div class="bet-footer">
                <button class="btn-action btn-win" onclick="resolve('${b.fechaColocada}', 'WIN')">WIN</button>
                <button class="btn-action btn-loss" onclick="resolve('${b.fechaColocada}', 'LOSS')">LOSS</button>
            </div>
        </div>
    `).join('') || "<p style='text-align:center; opacity:0.3; font-size:12px;'>Sin pendientes.</p>";

    const history = allBets.filter(b => b.estado !== 'PENDIENTE').reverse();
    document.getElementById('historyBets').innerHTML = history.slice(0, 10).map(b => `
        <div class="history-item">
            <div style="flex-grow:1;"><b>${b.equipo}</b> <small>@${b.cuotaFinal}</small><br><small style="opacity:0.6;">Cierre: @${b.closingOdd || 'N/A'}</small></div>
            <span class="${b.estado==='WIN'?'val-pos':'val-neg'}"><b>${b.estado}</b></span>
            <button class="btn-del-single" style="position:static; margin-left:15px;" onclick="deleteSingle('${b.fechaColocada}')">‚úï</button>
        </div>
    `).join('');
}

function resolve(id, res) {
    let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const idx = bets.findIndex(b => b.fechaColocada === id);
    if(idx !== -1) {
        const closeVal = document.getElementById('close-' + id.replace(/\D/g,'')).value;
        bets[idx].estado = res;
        bets[idx].closingOdd = closeVal || 0;
        localStorage.setItem('activeBets', JSON.stringify(bets));
        loadBets();
    }
}

function deleteSingle(id) {
    if(confirm('¬øEliminar?')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.fechaColocada !== id)));
        loadBets();
    }
}

function clearHistory() { if(confirm('¬øBorrar historial?')) { 
    let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.estado === 'PENDIENTE')));
    loadBets();
}}

window.onload = loadBets;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Pro + Analizador de Varianza</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --danger: #ef4444; --gold: #fbbf24; --accent: #3b82f6; --purple: #a855f7; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .container { max-width: 600px; margin: auto; }
        
        .btn-nav { display: block; text-align: center; padding: 12px; color: var(--text); text-decoration: none; margin-bottom: 20px; border: 1px solid #334155; border-radius: 12px; font-size: 13px; font-weight: bold; background: var(--card); }

        /* DASHBOARD */
        .performance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .perf-card { background: var(--card); padding: 15px; border-radius: 16px; border: 1px solid #334155; text-align: center; }
        .perf-label { font-size: 10px; text-transform: uppercase; color: #94a3b8; margin-bottom: 5px; display: block; }
        .perf-val { font-size: 20px; font-weight: 800; }

        /* NUEVO: PANEL DE VARIANZA */
        .variance-panel { background: linear-gradient(135deg, #1e293b 0%, #2e1065 100%); padding: 15px; border-radius: 16px; border: 1px solid var(--purple); margin-bottom: 20px; text-align: center; }
        .variance-title { font-size: 11px; font-weight: 900; color: var(--purple); letter-spacing: 1px; margin-bottom: 10px; display: block; }
        .confidence-meter { font-size: 24px; font-weight: 900; color: white; margin: 5px 0; }
        .variance-desc { font-size: 11px; opacity: 0.8; line-height: 1.4; }

        .stats-bar-container { background: var(--card); border-radius: 16px; padding: 15px; border: 1px solid #334155; margin-bottom: 20px; }
        .stats-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 8px; font-weight: bold; }
        .hit-rate-bg { width: 100%; height: 12px; background: var(--danger); border-radius: 6px; overflow: hidden; display: flex; }
        .hit-rate-fill { height: 100%; background: var(--success); transition: width 0.5s ease; }
        
        .bet-card { background: var(--card); border-radius: 14px; padding: 15px; margin-bottom: 12px; border: 1px solid #334155; border-left: 4px solid var(--gold); position: relative; }
        .bet-main { font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
        .bet-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-action { border: none; padding: 12px; border-radius: 8px; font-weight: 800; font-size: 12px; cursor: pointer; color: white; }
        .btn-win { background: var(--success); }
        .btn-loss { background: var(--danger); }
        .btn-del-single { position: absolute; top: 12px; right: 12px; background: none; border: none; color: #475569; font-size: 16px; cursor: pointer; }

        .history-list { background: var(--card); border-radius: 14px; overflow: hidden; border: 1px solid #334155; }
        .history-item { padding: 12px 15px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; font-size: 13px; position: relative; }
        .val-pos { color: var(--success); } .val-neg { color: var(--danger); }
    </style>
</head>
<body>
<div class="container">
    <a href="estrategia.html" class="btn-nav">‚Üê VOLVER AL PORTAFOLIO</a>

    <div class="variance-panel">
        <span class="variance-title">üî¨ AN√ÅLISIS DE FIABILIDAD (VARIANZA)</span>
        <div id="confidenceVal" class="confidence-meter">--%</div>
        <p id="varianceText" class="variance-desc">Necesitamos al menos 5 apuestas resueltas para calcular la fiabilidad del sistema.</p>
    </div>

    <div class="performance-grid">
        <div class="perf-card">
            <span class="perf-label">Balance Neto</span>
            <span id="realUnits" class="perf-val">0.00 u.</span>
        </div>
        <div class="perf-card">
            <span class="perf-label">ROI Real</span>
            <span id="realRoi" class="perf-val">0.0%</span>
        </div>
    </div>

    <div class="stats-bar-container">
        <div class="stats-header"><span>HIT RATE</span> <span id="hitPercent">0%</span></div>
        <div class="hit-rate-bg"><div id="hitBar" class="hit-rate-fill" style="width: 0%"></div></div>
        <div style="display:flex; justify-content: space-around; font-size:11px; margin-top:10px;">
            <span>Wins: <b id="winCount">0</b></span> <span>Losses: <b id="lossCount">0</b></span>
        </div>
    </div>

    <h3>üéØ Pendientes</h3>
    <div id="pendingBets"></div>

    <h3>üìú Historial</h3>
    <div id="historyBets" class="history-list"></div>

    <button onclick="clearHistory()" style="width:100%; background:none; border:none; color:#475569; text-decoration:underline; padding:20px; cursor:pointer; font-size:11px;">Borrar Historial</button>
</div>

<script>
// L√ìGICA MATEM√ÅTICA DE VARIANZA
function calculateVariance(wins, total, avgOdd) {
    if (total < 5) return null;
    
    const winRateReal = wins / total;
    const expectedWinRate = 1 / avgOdd; // Lo que la cuota dice que deber√≠a pasar
    
    // Desviaci√≥n est√°ndar de una distribuci√≥n binomial
    const stdDev = Math.sqrt(total * expectedWinRate * (1 - expectedWinRate));
    const expectedWins = total * expectedWinRate;
    const zScore = (wins - expectedWins) / stdDev;
    
    // Convertir Z-Score a nivel de confianza (Simplificado)
    let confidence = 0;
    if (zScore <= 0) confidence = Math.max(5, 50 + (zScore * 20)); 
    else confidence = Math.min(99, 50 + (zScore * 25));

    return {
        score: Math.round(confidence),
        isLucky: zScore > 2,
        isSkilled: zScore > 1,
        isUnlucky: zScore < -1
    };
}

function loadBets() {
    const allBets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    let totalInvertido = 0, balanceNeto = 0, wins = 0, losses = 0, sumOdds = 0;
    
    const resolved = allBets.filter(b => b.estado !== 'PENDIENTE');
    
    resolved.forEach(b => {
        const stake = parseFloat(b.stake) || 0;
        const cuota = parseFloat(b.cuotaFinal) || 0;
        totalInvertido += stake;
        sumOdds += cuota;
        if(b.estado === 'WIN') { balanceNeto += (stake * cuota) - stake; wins++; } 
        else { balanceNeto -= stake; losses++; }
    });

    // Actualizar Dashboard
    document.getElementById('realUnits').innerText = `${balanceNeto.toFixed(2)} u.`;
    document.getElementById('realRoi').innerText = `${totalInvertido > 0 ? ((balanceNeto/totalInvertido)*100).toFixed(1) : 0}%`;
    
    const hitRate = resolved.length > 0 ? Math.round((wins / resolved.length) * 100) : 0;
    document.getElementById('hitPercent').innerText = hitRate + "%";
    document.getElementById('hitBar').style.width = hitRate + "%";
    document.getElementById('winCount').innerText = wins;
    document.getElementById('lossCount').innerText = losses;

    // Actualizar Varianza
    const avgOdd = resolved.length > 0 ? (sumOdds / resolved.length) : 0;
    const varResult = calculateVariance(wins, resolved.length, avgOdd);
    
    const confEl = document.getElementById('confidenceVal');
    const textEl = document.getElementById('varianceText');

    if (varResult) {
        confEl.innerText = varResult.score + "%";
        if (varResult.score > 85) {
            textEl.innerText = "SISTEMA S√ìLIDO: Tu ventaja es matem√°tica y consistente. Sigue as√≠.";
            confEl.style.color = "var(--success)";
        } else if (varResult.score > 60) {
            textEl.innerText = "EN CAMINO: Resultados positivos, pero se requiere m√°s volumen de apuestas.";
            confEl.style.color = "var(--gold)";
        } else if (varResult.score < 40) {
            textEl.innerText = "ALERTA DE VARIANZA: Los resultados podr√≠an ser fruto de una mala racha o falta de edge.";
            confEl.style.color = "var(--danger)";
        } else {
            textEl.innerText = "NEUTRAL: El sistema est√° operando dentro de lo esperado estad√≠sticamente.";
            confEl.style.color = "white";
        }
    }

    // Render Listas
    renderLists(allBets);
}

function renderLists(allBets) {
    const pending = allBets.filter(b => b.estado === 'PENDIENTE');
    document.getElementById('pendingBets').innerHTML = pending.map((b) => `
        <div class="bet-card">
            <button class="btn-del-single" onclick="deleteSingle('${b.fechaColocada}')">‚úï</button>
            <div class="bet-main">${b.equipo} @${b.cuotaFinal}</div>
            <div class="bet-footer">
                <button class="btn-action btn-win" onclick="resolve('${b.fechaColocada}', 'WIN')">WIN</button>
                <button class="btn-action btn-loss" onclick="resolve('${b.fechaColocada}', 'LOSS')">LOSS</button>
            </div>
        </div>
    `).join('') || "<p style='text-align:center; opacity:0.3; font-size:12px;'>Sin pendientes.</p>";

    const history = allBets.filter(b => b.estado !== 'PENDIENTE').reverse();
    document.getElementById('historyBets').innerHTML = history.slice(0, 10).map(b => `
        <div class="history-item">
            <div><b>${b.equipo}</b> <small>@${b.cuotaFinal}</small></div>
            <span class="${b.estado==='WIN'?'val-pos':'val-neg'}"><b>${b.estado}</b></span>
            <button class="btn-del-single" style="position:static; margin-left:10px;" onclick="deleteSingle('${b.fechaColocada}')">‚úï</button>
        </div>
    `).join('');
}

function resolve(id, res) {
    let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    const idx = bets.findIndex(b => b.fechaColocada === id);
    if(idx !== -1) { bets[idx].estado = res; localStorage.setItem('activeBets', JSON.stringify(bets)); loadBets(); }
}

function deleteSingle(id) {
    if(confirm('¬øEliminar?')) {
        let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
        localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.fechaColocada !== id)));
        loadBets();
    }
}

function clearHistory() { if(confirm('¬øBorrar historial?')) { 
    let bets = JSON.parse(localStorage.getItem('activeBets') || "[]");
    localStorage.setItem('activeBets', JSON.stringify(bets.filter(b => b.estado === 'PENDIENTE')));
    loadBets();
}}

window.onload = loadBets;
</script>
</body>
</html>

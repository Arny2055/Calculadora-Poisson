<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS Pro - Partidos Guardados</title>
    <style>
        /* Asumimos que los estilos son similares a index.html o se importan. 
           Solo incluimos estilos cr√≠ticos aqu√≠ para el nuevo bot√≥n. */
        :root {
            --bg-page: #f9f9f9;
            --bg-card: #ffffff;
            --text-primary: #123456;
            --text-secondary: #56789a;
            --border-color: #e0e0e0;
            --table-header-bg: #4a5c8c;
            --table-header-text: #ffffff;
            --table-row-stripe: #f5f5f5;
            --accent-main: #e63946; 
            --success-color: #2a9d8f;
            --warning-color: #ffc300;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .dark-mode {
            --bg-page: #1e1e1e;
            --bg-card: #2c2c2c;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444444;
            --table-header-bg: #185a9a;
            --table-row-stripe: #363636;
            --accent-main: #ff6b6b;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
        }

        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 25px; background-color: var(--bg-page); color: var(--text-primary); transition: all 0.5s ease-in-out; }
        #container { max-width: 1500px; margin: 0 auto; padding: 40px; background-color: var(--bg-card); box-shadow: var(--shadow); border-radius: 10px; }
        h1 { color: var(--table-header-bg); font-weight: 700; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 20px; }
        th, td { padding: 10px 5px; text-align: center; border: 1px solid var(--border-color); }
        thead th { background-color: var(--table-header-bg); color: var(--table-header-text); font-weight: 600; }
        tbody tr:nth-child(even) { background-color: var(--table-row-stripe); }

        .bookie-input, .result-select {
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            background-color: var(--bg-card);
            color: var(--text-primary);
            font-weight: 600;
            width: 75px; 
        }

        .action-button {
             padding: 12px 20px;
             border: none;
             border-radius: 6px;
             cursor: pointer;
             font-weight: 600;
             transition: background-color 0.3s, transform 0.1s;
             margin-top: 20px;
             color: white;
        }
        
        #btn-back-to-scanner {
            background-color: var(--table-header-bg);
            margin-right: 10px;
        }
        #btn-back-to-scanner:hover { background-color: #3b496d; }

        #btn-save-backtest {
            background-color: var(--success-color); /* Color de √©xito para la acci√≥n principal */
            font-size: 1.1em;
        }
        #btn-save-backtest:hover { background-color: #24887d; transform: translateY(-1px); }

        #empty-message { text-align: center; font-weight: bold; color: var(--text-secondary); margin-top: 30px; }
        
        .nav-buttons-container {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 15px;
        }
    </style>
</head>
<body onload="loadSavedMatches()">

<div id="container">
    <header>
        <h1>Partidos de Valor Guardados (Simulaci√≥n)</h1>
        <p>A√±ade la **Cuota de la Bookie** que tomaste y el **Resultado Final** (Ganada/Perdida) para cada mercado.</p>
    </header>

    <div class="nav-buttons-container">
        <button id="btn-back-to-scanner" class="action-button" onclick="window.location.href='index.html'">
            ‚¨ÖÔ∏è Volver al Esc√°ner
        </button>
        <button id="btn-save-backtest" class="action-button" onclick="saveForBacktest()">
            üöÄ Guardar Partidos FINALIZADOS y Abrir Backtesting
        </button>
    </div>

    <table id="saved-matches-table">
        <thead>
            <tr>
                <th>Fecha/Hora</th>
                <th>Liga</th>
                <th>Partido (Mercado)</th>
                <th>Prob. Modelo (%)</th>
                <th>Cuota M√≠nima (EV+)</th>
                <th>**CUOTA BOOKIE**</th>
                <th>**RESULTADO**</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    
    <p id="empty-message" style="display: none;">No hay partidos guardados. Vuelve al esc√°ner para encontrar y guardar oportunidades.</p>

</div>

<script>
    const STORAGE_KEY = 'savedEVMatches'; 
    const READY_MATCHES_KEY = 'backtestReadyMatches'; // Nueva clave para Backtest
    let currentSavedMatches = []; // Almacenar los datos cargados
    
    // =======================================================
    // == L√ìGICA DE CARGA Y RENDERIZADO                     ==
    // =======================================================
    function loadSavedMatches() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        const tableBody = document.querySelector('#saved-matches-table tbody');
        tableBody.innerHTML = '';
        document.getElementById('empty-message').style.display = 'none';

        if (!savedData) {
            document.getElementById('empty-message').style.display = 'block';
            return;
        }

        try {
            currentSavedMatches = JSON.parse(savedData);
            
            if (currentSavedMatches.length === 0) {
                 document.getElementById('empty-message').style.display = 'block';
                 return;
            }

            // Asegurar que cada partido tenga los campos de simulaci√≥n necesarios
            currentSavedMatches = currentSavedMatches.map(match => ({
                ...match,
                bookieOdd: match.bookieOdd ? parseFloat(match.bookieOdd).toFixed(2) : match.MinOdd.toFixed(2), // Usar MinOdd como valor por defecto si no hay simulaci√≥n previa
                result: match.result || 'Pendiente'
            }));

            currentSavedMatches.forEach((r, index) => {
                const newRow = tableBody.insertRow();
                
                const d = new Date(r.Date);
                const dateStr = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                const timeStr = d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                newRow.innerHTML = `
                    <td>${dateStr}<br/>${timeStr}</td>
                    <td>${r.League}</td>
                    <td style="text-align: left; font-weight: 600;">${r.Match} (${r.Market})</td>
                    <td>${(r.Prob * 100).toFixed(2)}%</td>
                    <td>${r.MinOdd.toFixed(2)}</td>
                    <td>
                        <input type="number" 
                               step="0.01" 
                               min="1.01"
                               value="${r.bookieOdd}" 
                               class="bookie-input"
                               onchange="updateMatchData(${index}, 'bookieOdd', this.value)">
                    </td>
                    <td>
                        <select class="result-select" onchange="updateMatchData(${index}, 'result', this.value)">
                            <option value="Pendiente" ${r.result === 'Pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
                            <option value="Ganada" ${r.result === 'Ganada' ? 'selected' : ''}>‚úÖ Ganada</option>
                            <option value="Perdida" ${r.result === 'Perdida' ? 'selected' : ''}>‚ùå Perdida</option>
                        </select>
                    </td>
                `;
            });
            // Guardar el estado inicial (con bookieOdd/result si se carg√≥ por primera vez)
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSavedMatches));

        } catch (e) {
            console.error("Error al cargar partidos guardados:", e);
            document.getElementById('empty-message').textContent = "Error al cargar los datos. Intenta limpiar el localStorage.";
            document.getElementById('empty-message').style.display = 'block';
        }
    }
    
    function updateMatchData(index, key, value) {
        // La cuota bookie debe ser un n√∫mero; el resultado, una cadena
        currentSavedMatches[index][key] = (key === 'bookieOdd') ? parseFloat(value) : value;
        // Guardar el estado actualizado en la clave original de guardados
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSavedMatches));
    }

    // =======================================================
    // == L√ìGICA DE TRANSFERENCIA A BACKTEST                ==
    // =======================================================
    function saveForBacktest() {
        if (currentSavedMatches.length === 0) {
            alert("No hay partidos para enviar a Backtesting.");
            return;
        }

        // 1. Filtrar solo los partidos que tienen resultado y una cuota bookie v√°lida
        const readyForBacktest = currentSavedMatches.filter(match => {
            const hasValidResult = match.result === 'Ganada' || match.result === 'Perdida';
            const hasValidOdd = match.bookieOdd > 1.0;
            return hasValidResult && hasValidOdd;
        });

        if (readyForBacktest.length === 0) {
            alert("Debe seleccionar un Resultado (Ganada/Perdida) y una Cuota Bookie v√°lida (> 1.0) para al menos un partido antes de enviarlo a Backtesting.");
            return;
        }

        // 2. Guardar los datos filtrados en la nueva clave
        try {
            localStorage.setItem(READY_MATCHES_KEY, JSON.stringify(readyForBacktest));
            
            // 3. Informar y redirigir
            alert(`‚úÖ ${readyForBacktest.length} partidos finalizados listos para an√°lisis. Redirigiendo a Backtesting.`);
            window.location.href = 'backtest.html';

        } catch (e) {
            alert("Error al guardar los datos para Backtesting.");
            console.error("Error saving for backtest:", e);
        }
    }
    
    // L√≥gica de tema
    document.addEventListener('DOMContentLoaded', () => {
        const THEME_KEY = 'colorMode';
        if (localStorage.getItem(THEME_KEY) === 'dark') {
            document.body.classList.add('dark-mode');
        }
    });

</script>
</body>
</html>

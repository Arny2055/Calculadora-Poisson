<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Apuestas Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body{font-family:'Inter',sans-serif;background:#0e0e0e;color:#e0e0e0;margin:0;padding:20px}
    .container{max-width:1200px;margin:auto;background:#1b1b1b;padding:20px;border-radius:12px;box-shadow:0 0 25px rgba(0,0,0,0.7)}
    h2{text-align:center;margin-bottom:25px;color:#fff;font-weight:600}

    /* Filtros */
    .filtros{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px}
    .filtros input,.filtros button{font-size:14px;padding:8px 12px;border-radius:6px;border:1px solid #444;background-color:#2a2a2a;color:#f0f0f0;transition:0.3s}
    .filtros input:focus{outline:none;border-color:#3e8ef7}
    .filtros button{cursor:pointer;font-weight:600}
    .filtros button:hover{background-color:#3a3a3a}

    /* Tabla */
    .table-wrapper{overflow-y:auto;border-radius:10px;max-height:900px;position:relative}
    table{width:100%;border-collapse:collapse;font-size:14px;min-width:800px}
    thead{position:sticky;top:0;background:#202020;z-index:2}
    th,td{border:1px solid #333;padding:8px;text-align:center}
    tr:hover td{background-color:#2a2a2a}
    tr.ganado td{background-color:rgba(76,175,80,0.15)}
    tr.perdido td{background-color:rgba(229,57,53,0.15)}
    tr.push td{background-color:rgba(33,150,243,0.15)}

    select{background:#2c2c2c;color:#f0f0f0;border:1px solid #444;border-radius:5px;padding:4px;min-width:80px;font-weight:bold;transition:0.3s}
    select.ganado{border-color:#4CAF50;color:#4CAF50}
    select.perdido{border-color:#E53935;color:#E53935}
    select.push{border-color:#2196F3;color:#2196F3}

    button{padding:10px 15px;margin:10px 5px;font-size:14px;background-color:#333;color:#fff;border:none;border-radius:6px;cursor:pointer;transition:0.3s}
    button:hover{background-color:#444}
    .btn-borrar{background-color:#b32e2e;padding:5px 8px;font-size:12px}
    .btn-borrar:hover{background-color:#e03c3c}
    .btn-exportar{background-color:#3e8ef7}
    .btn-exportar:hover{background-color:#5aa2f9}

    #resumenROI{margin-top:20px;font-size:16px;text-align:center}
    #resumenROI .positivo{color:#4CAF50}
    #resumenROI .negativo{color:#E53935}

    #graficaUnidades{margin-top:40px;background:#202020;padding:20px;border-radius:12px}
    #notificacion{position:fixed;top:20px;right:20px;background:#323232;color:white;padding:10px 15px;border-radius:6px;opacity:0;transition:opacity 0.4s;pointer-events:none;z-index:999}
    #notificacion.visible{opacity:1}
  </style>
</head>
<body>
<div class="container">
  <h2><i class="fas fa-chart-line"></i> Historial de Apuestas</h2>

  <div class="filtros">
    <input type="text" id="filtroGrupo" placeholder="Filtrar por Grupo" />
    <input type="text" id="filtroLocal" placeholder="Filtrar por Local" />
    <input type="text" id="filtroVisita" placeholder="Filtrar por Visitante" />
    <input type="number" id="filtroProb" placeholder="Prob. mínima (%)" step="0.01" min="0" />
    <button id="btnLimpiarFiltros"><i class="fas fa-eraser"></i> Limpiar</button>
    <button id="btnExportar" class="btn-exportar"><i class="fas fa-file-export"></i> Exportar CSV</button>
  </div>

  <div>
    <button onclick="volver()"><i class="fas fa-arrow-left"></i> Volver</button>
    <button id="btnGuardar"><i class="fas fa-save"></i> Guardar</button>
    <button id="btnBorrarTodo" style="background-color:#b32e2e;"><i class="fas fa-trash"></i> Borrar todo</button>
  </div>

  <div class="table-wrapper">
    <table id="tablaHistorial">
      <thead>
        <tr>
          <th>Grupo</th><th>Opción</th><th>Prob (%)</th><th>Cuota</th><th>EV</th>
          <th>Kelly (%)</th><th>Apostar ($)</th><th>Local</th><th>Visitante</th><th>Resultado</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="resumenROI"></div>
  <div id="graficaUnidades">
    <h3 style="text-align:center; margin-bottom:15px;">Unidades Acumuladas</h3>
    <canvas id="unidadesChart" height="120"></canvas>
  </div>
</div>

<div id="notificacion">Cambios guardados ✅</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let historial=[];
  let unidadesChart=null;

  function cargarHistorial(){
    historial = JSON.parse(localStorage.getItem("poissonHistorial")||"[]");

    // Si no hay apuestas, creo un ejemplo visible
    if(historial.length===0){
      historial=[
        ["Liga MX","Over 2.5",55,1.9,0.05,2.5,50,"America","Chivas",""]
      ];
      localStorage.setItem("poissonHistorial",JSON.stringify(historial));
    }

    renderizarTabla(historial);
    actualizarResumen(historial);
    actualizarGrafica(historial);
  }

  function renderizarTabla(datos){
    const tbody=document.querySelector("#tablaHistorial tbody");
    tbody.innerHTML="";
    datos.forEach((row,i)=>{
      const tr=document.createElement("tr");
      if(row[9]==="ganado")tr.classList.add("ganado");
      else if(row[9]==="perdido")tr.classList.add("perdido");
      else if(row[9]==="push")tr.classList.add("push");

      for(let j=0;j<9;j++){
        const td=document.createElement("td");
        td.textContent=row[j];
        tr.appendChild(td);
      }

      // Select resultado
      const tdSel=document.createElement("td");
      const select=document.createElement("select");
      select.innerHTML=`
        <option value="">--</option>
        <option value="ganado">Ganado</option>
        <option value="push">Push</option>
        <option value="perdido">Perdido</option>
      `;
      select.value=row[9]||"";
      actualizarClaseSelect(select);
      select.addEventListener("change",()=>{
        historial[i][9]=select.value;
        guardarHistorial();
        renderizarTabla(historial);
        actualizarResumen(historial);
        actualizarGrafica(historial);
      });
      tdSel.appendChild(select); tr.appendChild(tdSel);

      // Botón borrar
      const tdBtn=document.createElement("td");
      const btn=document.createElement("button");
      btn.textContent="Borrar"; btn.className="btn-borrar";
      btn.onclick=()=>{
        historial.splice(i,1);
        guardarHistorial(); renderizarTabla(historial);
        actualizarResumen(historial); actualizarGrafica(historial);
      };
      tdBtn.appendChild(btn); tr.appendChild(tdBtn);
      tbody.appendChild(tr);
    });
  }

  function actualizarClaseSelect(select){
    select.classList.remove("ganado","perdido","push");
    if(select.value==="ganado")select.classList.add("ganado");
    else if(select.value==="perdido")select.classList.add("perdido");
    else if(select.value==="push")select.classList.add("push");
  }

  function guardarHistorial(){localStorage.setItem("poissonHistorial",JSON.stringify(historial));mostrarNotificacion();}
  function volver(){window.history.back();}

  function actualizarResumen(datos){
    let gananciaNeta=0,totalInvertido=0,ganadas=0,perdidas=0;
    datos.forEach(row=>{
      const stake=parseFloat(row[6])||0;
      const cuota=parseFloat(row[3])||0;
      switch(row[9]){
        case "ganado":gananciaNeta+=stake*(cuota-1);ganadas++;break;
        case "perdido":gananciaNeta-=stake;perdidas++;break;
      }
      if(stake>0) totalInvertido+=stake;
    });
    const roi=totalInvertido>0?(gananciaNeta/totalInvertido*100):0;
    const color=roi>=0?"positivo":"negativo";
    document.getElementById("resumenROI").innerHTML=`
      <p>
        <strong>Ganancia Neta:</strong> $${gananciaNeta.toFixed(2)}<br/>
        <strong>Total Apostado:</strong> $${totalInvertido.toFixed(2)}<br/>
        <strong>ROI:</strong> <span class="${color}">${roi.toFixed(2)}%</span><br/>
        <strong>Apuestas Ganadas:</strong> ${ganadas} | <strong>Perdidas:</strong> ${perdidas}
      </p>`;
  }

  function actualizarGrafica(datos){
    let acumulado=0; const unidades=[0]; const labels=["Inicio"];
    datos.forEach((row,i)=>{
      const stake=parseFloat(row[6])||0;
      const cuota=parseFloat(row[3])||0;
      let cambio=0;
      if(row[9]==="ganado")cambio=stake*(cuota-1);
      else if(row[9]==="perdido")cambio=-stake;
      acumulado+=cambio;
      unidades.push(acumulado.toFixed(2));
      labels.push(`Apuesta ${i+1}`);
    });
    const ctx=document.getElementById("unidadesChart").getContext("2d");
    if(unidadesChart)unidadesChart.destroy();
    unidadesChart=new Chart(ctx,{
      type:"line",
      data:{labels:labels,datasets:[{label:"Evolución Bankroll",data:unidades,borderColor:"#3e8ef7",backgroundColor:"rgba(62,142,247,0.2)",borderWidth:2,fill:true}]},
      options:{responsive:true,plugins:{legend:{labels:{color:"#fff"}}},scales:{x:{ticks:{color:"#fff"}},y:{ticks:{color:"#fff"}}}}
    });
  }

  function mostrarNotificacion(){
    const n=document.getElementById("notificacion");
    n.classList.add("visible");setTimeout(()=>n.classList.remove("visible"),2000);
  }

  document.getElementById("btnGuardar").onclick=guardarHistorial;
  document.getElementById("btnBorrarTodo").onclick=()=>{
    if(confirm("¿Seguro de borrar TODO?")){historial=[];guardarHistorial();renderizarTabla(historial);actualizarResumen(historial);actualizarGrafica(historial);}
  };
  document.getElementById("btnLimpiarFiltros").onclick=()=>{document.querySelectorAll(".filtros input").forEach(i=>i.value="");renderizarTabla(historial);actualizarResumen(historial);actualizarGrafica(historial);}
  document.getElementById("btnExportar").onclick=()=>{
    if(historial.length===0)return alert("No hay datos para exportar.");
    let csv="Grupo,Opción,Prob (%),Cuota,EV,Kelly (%),Apostar ($),Local,Visitante,Resultado\n";
    historial.forEach(r=>{csv+=r.join(",")+"\n";});
    const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="historial_apuestas.csv";a.click();URL.revokeObjectURL(url);
  };

  window.addEventListener("DOMContentLoaded",cargarHistorial);
</script>
</body>
</html>
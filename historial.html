<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Picks — OU/BTTS/1X2</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#0f1115 0%,#121622 100%); color:var(--text)}
  header{padding:20px 16px; border-bottom:1px solid var(--border); background:#10141d; position:sticky; top:0; z-index:5}
  h1{margin:0; font-size:18px; letter-spacing:.3px}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px}
  .muted{color:var(--muted)}
  table{width:100%; border-collapse:separate; border-spacing:0}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle}
  th{color:var(--muted); font-weight:600; font-size:12px; position:sticky; top:72px; background:var(--panel)}
  .right{text-align:right}
  select,input{background:var(--panel2); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px}
  .btn{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:#111827; color:var(--text);
       padding:10px 12px; border-radius:10px; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#2647ff,#1fa37e); border-color:transparent}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03)}
  .ok{color:var(--accent2)} .warn{color:var(--warn)} .bad{color:var(--danger)}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .grid{display:grid; gap:10px}
  .sep{height:1px; background:var(--border); margin:12px 0}
  .tiny{font-size:11px}
  .tag{display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex" style="justify-content:space-between">
        <h1>Historial de Picks</h1>
        <div class="flex">
          <button id="btnExport" class="btn">Exportar CSV</button>
          <button id="btnClear" class="btn">Borrar todo</button>
          <a href="./" class="btn primary">← Volver</a>
        </div>
      </div>
      <div class="tiny muted" style="margin-top:6px">Los picks se cargan desde <code>localStorage["picks"]</code>.</div>
    </div>
  </header>

  <div class="wrap">
    <!-- ===== NUEVO: Formulario para agregar picks (incluye Riesgo) ===== -->
    <section class="card" style="margin-bottom:16px">
      <div class="flex" style="justify-content:space-between">
        <b>Nuevo pick</b>
        <button id="btnAdd" class="btn">Guardar pick</button>
      </div>
      <div class="sep"></div>
      <div class="grid" style="grid-template-columns:repeat(6,1fr)">
        <div class="grid">
          <label class="tiny muted">Fecha/Hora</label>
          <input id="iDate" type="datetime-local" />
        </div>
        <div class="grid">
          <label class="tiny muted">Liga</label>
          <input id="iLeague" placeholder="Ej. Argentina LPF" />
        </div>
        <div class="grid">
          <label class="tiny muted">Local</label>
          <input id="iHome" placeholder="Banfield" />
        </div>
        <div class="grid">
          <label class="tiny muted">Visita</label>
          <input id="iAway" placeholder="Instituto" />
        </div>
        <div class="grid">
          <label class="tiny muted">Mercado</label>
          <input id="iMarket" placeholder="OU/BTTS/1X2..." />
        </div>
        <div class="grid">
          <label class="tiny muted">Detalle</label>
          <input id="iLabel" placeholder="Over 2.5, GG, 1X, etc." />
        </div>

        <div class="grid">
          <label class="tiny muted">Prob. modelo (0–1)</label>
          <input id="iProb" type="number" step="0.0001" min="0" max="1" placeholder="0.56" />
        </div>
        <div class="grid">
          <label class="tiny muted">Cuota (decimal)</label>
          <input id="iOdd" type="number" step="0.01" min="1.01" placeholder="1.85" />
        </div>
        <div class="grid">
          <label class="tiny muted">Overround (0–1, opcional)</label>
          <input id="iOverround" type="number" step="0.0001" min="0" placeholder="0.03" />
        </div>
        <div class="grid">
          <label class="tiny muted">EV (auto)</label>
          <input id="iEV" type="number" step="0.0001" placeholder="auto" disabled />
        </div>
        <div class="grid">
          <label class="tiny muted">Bankroll (opcional)</label>
          <input id="iBankroll" type="number" step="0.01" min="0" placeholder="1000" />
        </div>
        <div class="grid">
          <label class="tiny muted">Kelly (¼) (auto)</label>
          <input id="iKellyQ" type="number" step="0.0001" min="0" placeholder="auto" disabled />
        </div>

        <div class="grid">
          <label class="tiny muted">Riesgo</label>
          <select id="iRisk">
            <option value="">— Selecciona —</option>
            <option value="Bajo">Bajo</option>
            <option value="Medio">Medio</option>
            <option value="Alto">Alto</option>
          </select>
        </div>
        <div class="grid">
          <label class="tiny muted">Resultado (opcional)</label>
          <select id="iResult">
            <option value="">— Sin resultado —</option>
            <option>Ganó</option>
            <option>Push</option>
            <option>Perdió</option>
          </select>
        </div>
      </div>
      <div class="tiny muted" style="margin-top:8px">
        EV = <code>p × cuota − 1</code>. Kelly base = <code>(p×o − (1−p)) / (o−1)</code>, Kelly(¼) = <code>max(0, base/4)</code>.
      </div>
    </section>

    <section class="card">
      <div class="flex" style="justify-content:space-between; gap:10px; flex-wrap:wrap">
        <div class="flex" style="gap:10px; flex-wrap:wrap">
          <span class="pill">Total registros: <b id="count">0</b></span>
          <span class="pill">Ganados: <b id="won">0</b></span>
          <span class="pill">Push: <b id="push">0</b></span>
          <span class="pill">Perdidos: <b id="lost">0</b></span>
          <!-- KPIs de contabilidad -->
          <span class="pill">Total apostado: <b id="staked">$0.00</b></span>
          <span class="pill">Ganancia neta: <b id="profit">$0.00</b></span>
          <span class="pill">ROI: <b id="roi">0.00%</b></span>
        </div>
        <div class="flex">
          <label class="tiny muted">Filtrar por liga</label>
          <select id="fLeague"></select>
        </div>
      </div>
      <div class="sep"></div>
      <div style="overflow:auto; max-height:70vh;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Liga</th>
              <th>Local</th>
              <th>Visita</th>
              <th>Mercado</th>
              <th>Detalle</th>
              <th>Riesgo</th><!-- NUEVO -->
              <th class="right">Prob. Modelo</th>
              <th class="right">Cuota</th>
              <th class="right">Overround</th>
              <th class="right">EV</th>
              <th class="right">Stake Kelly</th>
              <th>Resultado</th>
              <th class="right">P/L</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="body"><!-- filas --></tbody>
        </table>
      </div>
      <div class="tiny muted" style="margin-top:8px">
        <b>Nota:</b> Stake Kelly = bankroll × Kelly(¼). La probabilidad mostrada es la del modelo al momento de guardar el pick.
        P/L por pick: <i>Ganó</i> ⇒ <code>stake × (odd − 1)</code>; <i>Perdió</i> ⇒ <code>−stake</code>; <i>Push</i> ⇒ <code>0</code>.
      </div>
    </section>
  </div>

<script>
(() => {
  "use strict";
  const $ = s => document.querySelector(s);
  const fmtPct = x => isFinite(x) ? (100*x).toFixed(2)+"%" : "—";
  const fmtMoney = x => isFinite(x) ? x.toFixed(2) : "—";
  const asMoney = x => "$" + fmtMoney(Number(x)||0);
  const clamp01 = v => Math.min(1, Math.max(0, Number(v)));

  // ===== Estado =====
  let picks = loadPicks();
  let view = [...picks];

  // ===== Init =====
  initFormDefaults();
  populateLeagueFilter();
  render();

  // ===== Eventos de formulario =====
  ["iProb","iOdd"].forEach(id=>{
    $("#"+id).addEventListener("input", recalcEVAndKelly);
  });
  $("#btnAdd").addEventListener("click", onAddPick);

  // ===== Eventos de filtros/acciones =====
  $("#fLeague").addEventListener("change", () => {
    const lg = $("#fLeague").value;
    view = lg ? picks.filter(p => (p.league||"") === lg) : [...picks];
    render();
  });

  $("#btnClear").addEventListener("click", () => {
    if(!confirm("¿Seguro que deseas borrar TODOS los picks guardados?")) return;
    localStorage.removeItem("picks");
    picks = [];
    view = [];
    render();
  });

  $("#btnExport").addEventListener("click", () => {
    const rows = [["Fecha","Liga","Local","Visita","Mercado","Detalle","Riesgo","ProbModelo","Cuota","Overround","EV","StakeKelly","Resultado","PL"]];
    for(const p of view){
      const stake = stakeKelly(p);
      rows.push([
        p.timestamp || "",
        p.league || "",
        p.home || "",
        p.away || "",
        p.market || "",
        p.label || "",
        p.risk || "",
        num(p.prob).toFixed(4),
        num(p.odd).toFixed(2),
        num(p.overround).toFixed(4),
        num(p.ev).toFixed(4),
        isFinite(stake) ? stake.toFixed(2) : "",
        (p.result||""),
        isFinite(pickPL(p)) ? pickPL(p).toFixed(2) : ""
      ]);
    }
    const csv = rows.map(r=>r.map(escapeCSV).join(",")).join("\n");
    download("historial_picks.csv", csv, "text/csv;charset=utf-8");
  });

  // ===== Lógica =====
  function initFormDefaults(){
    // Fecha/hora local por defecto ahora (redondeo a minutos)
    const now = new Date();
    now.setSeconds(0,0);
    $("#iDate").value = toLocalDT(now);
  }

  function recalcEVAndKelly(){
    const p = clamp01($("#iProb").value || 0);
    const o = Number($("#iOdd").value || 0);
    const ev = isFinite(p) && isFinite(o) && o>1 ? (p*o - 1) : NaN;
    $("#iEV").value = isFinite(ev) ? ev.toFixed(4) : "";
    // Kelly base
    const denom = (o - 1);
    let f = NaN;
    if(denom>0){
      f = (p*o - (1 - p)) / denom;
    }
    const fq = Math.max(0, f/4);
    $("#iKellyQ").value = isFinite(fq) ? fq.toFixed(4) : "";
  }

  function onAddPick(){
    const ts = $("#iDate").value ? new Date($("#iDate").value) : new Date();
    const p = clamp01($("#iProb").value || 0);
    const o = Number($("#iOdd").value || 0);
    const orr = $("#iOverround").value === "" ? NaN : Number($("#iOverround").value);
    const evInput = $("#iEV").value;
    const ev = evInput === "" ? (isFinite(p) && isFinite(o) && o>1 ? (p*o - 1) : NaN) : Number(evInput);
    const bk = $("#iBankroll").value === "" ? NaN : Number($("#iBankroll").value);
    const kqInput = $("#iKellyQ").value;
    const kq = kqInput === "" ? NaN : Number(kqInput);
    const risk = $("#iRisk").value || "";

    // Validaciones mínimas
    if(!$("#iLeague").value || !$("#iHome").value || !$("#iAway").value || !$("#iMarket").value || !$("#iLabel").value){
      alert("Completa Liga, Local, Visita, Mercado y Detalle.");
      return;
    }
    if(!(p>0 && p<=1) || !(o>1)){
      alert("Revisa Probabilidad (0–1) y Cuota (>1).");
      return;
    }
    if(!risk){
      alert("Selecciona un nivel de Riesgo.");
      return;
    }

    const newPick = {
      // Identidad / contexto
      timestamp: toLocalISO(ts), // ISO local (para indexado)
      league: $("#iLeague").value.trim(),
      home: $("#iHome").value.trim(),
      away: $("#iAway").value.trim(),
      market: $("#iMarket").value.trim(),
      label: $("#iLabel").value.trim(),

      // Métricas
      prob: p,
      odd: o,
      overround: isFinite(orr) ? orr : NaN,
      ev: isFinite(ev) ? ev : NaN,
      bankroll: isFinite(bk) ? bk : NaN,
      kelly_q: isFinite(kq) ? kq : NaN,

      // NUEVO: Riesgo
      risk: risk,

      // Resultado opcional (sin asignar por defecto)
      result: $("#iResult").value || ""
    };

    // Guardar
    picks.push(newPick);
    savePicks();

    // Refrescar vista/ligas/contadores
    const flg = $("#fLeague").value;
    populateLeagueFilter(); // por si es una liga nueva
    view = flg ? picks.filter(x => (x.league||"")===flg) : [...picks];
    render();

    // Limpiar los campos (menos la fecha)
    ["iLeague","iHome","iAway","iMarket","iLabel","iProb","iOdd","iOverround","iEV","iBankroll","iKellyQ"].forEach(id=>$("#"+id).value="");
    $("#iRisk").value = "";
    $("#iResult").value = "";
  }

  function loadPicks(){
    try{
      const arr = JSON.parse(localStorage.getItem("picks") || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function savePicks(){ localStorage.setItem("picks", JSON.stringify(picks)); }

  function num(x){ const n = Number(x); return isFinite(n)?n:NaN; }
  function stakeKelly(p){
    const bk = Number(p.bankroll||0);
    const kq = Number(p.kelly_q||0);
    if(!isFinite(bk) || !isFinite(kq)) return NaN;
    return Math.max(0, bk * kq);
  }
  function pickPL(p){
    // P/L por resultado usando el stake guardado (bankroll × kelly_q) y la cuota guardada
    const stake = stakeKelly(p);
    const odd = Number(p.odd||0);
    if(!isFinite(stake) || !isFinite(odd) || odd<=1) return NaN;
    const r = p.result || "";
    if(r === "Ganó") return stake * (odd - 1);
    if(r === "Perdió") return -stake;
    if(r === "Push") return 0;
    return NaN; // sin calificar
  }

  function populateLeagueFilter(){
    const set = new Set(picks.map(p=>p.league||"").filter(Boolean));
    const sel = $("#fLeague");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "Todas las ligas";
    sel.appendChild(opt0);
    [...set].sort((a,b)=>a.localeCompare(b)).forEach(lg=>{
      const o = document.createElement("option");
      o.value = lg; o.textContent = lg;
      sel.appendChild(o);
    });
  }

  function render(){
    const body = $("#body");
    body.innerHTML = "";

    let won=0, push=0, lost=0;
    let totalStaked=0, totalPL=0;

    view.forEach((p) => {
      const tr = document.createElement("tr");

      const tdFecha = cell(p.timestamp ? p.timestamp.replace("T"," ").slice(0,16) : "");
      const tdLiga  = cell(p.league||"");
      const tdHome  = cell(p.home||"");
      const tdAway  = cell(p.away||"");
      const tdMkt   = cell(p.market||"");
      const tdLbl   = cell(p.label||"");

      // Riesgo (pill)
      const tdRisk = document.createElement("td");
      const rk = (p.risk||"").trim();
      if(rk){
        const span = document.createElement("span");
        span.className = "tag " + (rk==="Alto"?"bad": rk==="Medio"?"warn":"ok");
        span.textContent = rk;
        tdRisk.appendChild(span);
      }else{
        tdRisk.textContent = "—";
      }

      const tdProb  = cellRight(fmtPct(num(p.prob)));
      const tdOdd   = cellRight(isFinite(num(p.odd)) ? Number(p.odd).toFixed(2) : "—");
      const tdOR    = cellRight(isFinite(num(p.overround)) ? (100*Number(p.overround)).toFixed(2)+"%" : "—");

      const tdEV    = document.createElement("td"); tdEV.className="right";
      const evv = num(p.ev);
      tdEV.innerHTML = isFinite(evv) ? `<b class="${evv>=0?'ok':'bad'}">${(100*evv).toFixed(2)}%</b>` : "—";

      const stake = stakeKelly(p);
      const tdStake = cellRight( isFinite(stake) ? "$"+fmtMoney(stake) : "—" );

      const tdRes = document.createElement("td");
      const sel = document.createElement("select");
      ["","Ganó","Push","Perdió"].forEach(v=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = v || "— Selecciona —";
        sel.appendChild(o);
      });
      sel.value = p.result || "";
      sel.addEventListener("change", () => {
        const gi = indexInGlobal(p);
        if(gi !== -1){
          picks[gi].result = sel.value;
          savePicks();
          const flg = $("#fLeague").value;
          view = flg ? picks.filter(x => (x.league||"")===flg) : [...picks];
          render();
        }
      });
      tdRes.appendChild(sel);

      const tdPL = document.createElement("td"); tdPL.className="right";
      const pl = pickPL(p);
      tdPL.innerHTML = isFinite(pl) ? `<b class="${pl>=0?'ok':'bad'}">${(pl>=0?'+':'')}$${fmtMoney(pl)}</b>` : "—";

      const tdAcc = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Eliminar";
      btn.addEventListener("click", () => {
        if(!confirm("¿Eliminar este pick del historial?")) return;
        const gi = indexInGlobal(p);
        if(gi !== -1){
          picks.splice(gi,1);
          savePicks();
          const flg = $("#fLeague").value;
          view = flg ? picks.filter(x => (x.league||"")===flg) : [...picks];
          render();
        }
      });
      tdAcc.appendChild(btn);

      // Añadir celdas al tr
      [tdFecha,tdLiga,tdHome,tdAway,tdMkt,tdLbl,tdRisk,tdProb,tdOdd,tdOR,tdEV,tdStake,tdRes,tdPL,tdAcc].forEach(td=>tr.appendChild(td));
      body.appendChild(tr);

      // contabilidad si el pick tiene resultado asignado
      if((p.result||"")==="Ganó") { won++; if(isFinite(stake)) totalStaked+=stake; if(isFinite(pl)) totalPL+=pl; }
      else if((p.result||"")==="Push") { push++; }
      else if((p.result||"")==="Perdió") { lost++; if(isFinite(stake)) totalStaked+=stake; if(isFinite(pl)) totalPL+=pl; }
    });

    // Totales
    $("#count").textContent = view.length;
    $("#won").textContent = won;
    $("#push").textContent = push;
    $("#lost").textContent = lost;

    // KPIs contables
    $("#staked").textContent = asMoney(totalStaked);
    $("#profit").textContent = (totalPL>=0?'+':'') + asMoney(totalPL);
    const roi = totalStaked>0 ? (100*totalPL/totalStaked) : 0;
    $("#roi").textContent = roi.toFixed(2) + "%";
  }

  // ===== Utilidades UI =====
  function cell(txt){ const td = document.createElement("td"); td.textContent = txt; return td; }
  function cellRight(txt){ const td = document.createElement("td"); td.className = "right"; td.textContent = txt; return td; }

  function indexInGlobal(p){
    // Identificador: timestamp+market+label (mantiene compatibilidad con tus guardados previos)
    const key = (p.timestamp||"") + "||" + (p.market||"") + "||" + (p.label||"");
    return picks.findIndex(z => ((z.timestamp||"")+"||"+(z.market||"")+"||"+(z.label||"")) === key);
  }

  function escapeCSV(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }
  function download(filename, content, mime){
    const blob = new Blob([content], {type:mime||"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  // Fechas
  function toLocalDT(d){
    const pad = n => String(n).padStart(2,"0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  function toLocalISO(d){
    // ISO-like sin zona para mantener consistencia visual
    const s = toLocalDT(d);
    return s; // "YYYY-MM-DDTHH:MM"
  }

})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Picks — OU/BTTS/1X2</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#0f1115 0%,#121622 100%); color:var(--text)}
  header{padding:20px 16px; border-bottom:1px solid var(--border); background:#10141d; position:sticky; top:0; z-index:5}
  h1{margin:0; font-size:18px; letter-spacing:.3px}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px}
  .muted{color:var(--muted)}
  table{width:100%; border-collapse:separate; border-spacing:0}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle}
  th{color:var(--muted); font-weight:600; font-size:12px; position:sticky; top:72px; background:var(--panel)}
  .right{text-align:right}
  select,input{background:var(--panel2); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px}
  .btn{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:#111827; color:var(--text);
       padding:10px 12px; border-radius:10px; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#2647ff,#1fa37e); border-color:transparent}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03)}
  .ok{color:var(--accent2)} .warn{color:var(--warn)} .bad{color:var(--danger)}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .sep{height:1px; background:var(--border); margin:12px 0}
  .tiny{font-size:11px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex" style="justify-content:space-between">
        <h1>Historial de Picks</h1>
        <div class="flex">
          <button id="btnExport" class="btn">Exportar CSV</button>
          <button id="btnClear" class="btn">Borrar todo</button>
          <a href="./" class="btn primary">← Volver</a>
        </div>
      </div>
      <div class="tiny muted" style="margin-top:6px">Los picks se cargan desde <code>localStorage["picks"]</code>.</div>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="flex" style="justify-content:space-between">
        <div class="flex">
          <span class="pill">Total registros: <b id="count">0</b></span>
          <span class="pill">Ganados: <b id="won">0</b></span>
          <span class="pill">Push: <b id="push">0</b></span>
          <span class="pill">Perdidos: <b id="lost">0</b></span>
        </div>
        <div class="flex">
          <label class="tiny muted">Filtrar por liga</label>
          <select id="fLeague"></select>
        </div>
      </div>
      <div class="sep"></div>
      <div style="overflow:auto; max-height:70vh;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Liga</th>
              <th>Local</th>
              <th>Visita</th>
              <th>Mercado</th>
              <th>Detalle</th>
              <th class="right">Prob. Modelo</th>
              <th class="right">Cuota</th>
              <th class="right">Overround</th>
              <th class="right">EV</th>
              <th class="right">Stake Kelly</th>
              <th>Resultado</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="body">
            <!-- filas -->
          </tbody>
        </table>
      </div>
      <div class="tiny muted" style="margin-top:8px">
        <b>Nota:</b> Stake Kelly = bankroll × Kelly(¼). La probabilidad mostrada es la del modelo al momento de guardar el pick.
      </div>
    </section>
  </div>

<script>
(() => {
  "use strict";
  const $ = s => document.querySelector(s);
  const fmtPct = x => isFinite(x) ? (100*x).toFixed(2)+"%" : "—";
  const fmtDec = x => isFinite(x) ? x.toFixed(3) : "—";
  const fmtMoney = x => isFinite(x) ? x.toFixed(2) : "—";

  let picks = loadPicks();
  let view = [...picks];

  // UI init
  populateLeagueFilter();
  render();

  // ==== Eventos ====
  $("#fLeague").addEventListener("change", () => {
    const lg = $("#fLeague").value;
    view = lg ? picks.filter(p => (p.league||"") === lg) : [...picks];
    render();
  });

  $("#btnClear").addEventListener("click", () => {
    if(!confirm("¿Seguro que deseas borrar TODOS los picks guardados?")) return;
    localStorage.removeItem("picks");
    picks = [];
    view = [];
    render();
  });

  $("#btnExport").addEventListener("click", () => {
    const rows = [["Fecha","Liga","Local","Visita","Mercado","Detalle","ProbModelo","Cuota","Overround","EV","StakeKelly","Resultado"]];
    for(const p of view){
      const prob = isFinite(p.prob) ? p.prob : NaN;
      const odd = isFinite(p.odd) ? p.odd : NaN;
      const orr = isFinite(p.overround) ? p.overround : NaN;
      const evv = isFinite(p.ev) ? p.ev : NaN;
      const stake = stakeKelly(p);
      rows.push([
        p.timestamp || "",
        p.league || "",
        p.home || "",
        p.away || "",
        p.market || "",
        p.label || "",
        isFinite(prob) ? (prob).toFixed(4) : "",
        isFinite(odd) ? odd.toFixed(2) : "",
        isFinite(orr) ? (orr).toFixed(4) : "",
        isFinite(evv) ? (evv).toFixed(4) : "",
        isFinite(stake) ? stake.toFixed(2) : "",
        (p.result||"")
      ]);
    }
    const csv = rows.map(r=>r.map(escapeCSV).join(",")).join("\n");
    download("historial_picks.csv", csv, "text/csv;charset=utf-8");
  });

  // ==== Funciones ====
  function loadPicks(){
    try{
      const arr = JSON.parse(localStorage.getItem("picks") || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }

  function savePicks(){
    localStorage.setItem("picks", JSON.stringify(picks));
  }

  function stakeKelly(p){
    const bk = Number(p.bankroll||0);
    const kq = Number(p.kelly_q||0);
    if(!isFinite(bk) || !isFinite(kq)) return NaN;
    return Math.max(0, bk * kq);
    // Nota: kelly_q ya viene fraccional (¼ aplicado) desde la página principal
  }

  function populateLeagueFilter(){
    const set = new Set(picks.map(p=>p.league||"").filter(Boolean));
    const sel = $("#fLeague");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "Todas las ligas";
    sel.appendChild(opt0);
    [...set].sort((a,b)=>a.localeCompare(b)).forEach(lg=>{
      const o = document.createElement("option");
      o.value = lg; o.textContent = lg;
      sel.appendChild(o);
    });
  }

  function render(){
    const body = $("#body");
    body.innerHTML = "";

    let won=0, push=0, lost=0;
    view.forEach((p, idx) => {
      const tr = document.createElement("tr");

      const tdFecha = cell(p.timestamp ? p.timestamp.replace("T"," ").slice(0,16) : "");
      const tdLiga  = cell(p.league||"");
      const tdHome  = cell(p.home||"");
      const tdAway  = cell(p.away||"");
      const tdMkt   = cell(p.market||"");
      const tdLbl   = cell(p.label||"");

      const tdProb  = cellRight(fmtPct(num(p.prob)));
      const tdOdd   = cellRight(isFinite(num(p.odd)) ? Number(p.odd).toFixed(2) : "—");
      const tdOR    = cellRight(isFinite(num(p.overround)) ? (100*Number(p.overround)).toFixed(2)+"%" : "—");

      const tdEV    = document.createElement("td"); tdEV.className="right";
      const evv = num(p.ev);
      tdEV.innerHTML = isFinite(evv) ? `<b class="${evv>=0?'ok':'bad'}">${(100*evv).toFixed(2)}%</b>` : "—";

      const tdStake = cellRight( isFinite(stakeKelly(p)) ? "$"+fmtMoney(stakeKelly(p)) : "—" );

      const tdRes = document.createElement("td");
      const sel = document.createElement("select");
      ["","Ganó","Push","Perdió"].forEach(v=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = v || "— Selecciona —";
        sel.appendChild(o);
      });
      sel.value = p.result || "";
      sel.addEventListener("change", () => {
        // Actualiza en picks (por índice global)
        const globalIndex = indexInGlobal(p);
        if(globalIndex !== -1){
          picks[globalIndex].result = sel.value;
          savePicks();
          countTotals();
        }
      });
      tdRes.appendChild(sel);

      const tdAcc = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Eliminar";
      btn.addEventListener("click", () => {
        if(!confirm("¿Eliminar este pick del historial?")) return;
        const gi = indexInGlobal(p);
        if(gi !== -1){
          picks.splice(gi,1);
          savePicks();
          // Actualiza vista
          const flg = $("#fLeague").value;
          view = flg ? picks.filter(x => (x.league||"")===flg) : [...picks];
          render();
        }
      });
      tdAcc.appendChild(btn);

      // Añadir celdas al tr
      [tdFecha,tdLiga,tdHome,tdAway,tdMkt,tdLbl,tdProb,tdOdd,tdOR,tdEV,tdStake,tdRes,tdAcc].forEach(td=>tr.appendChild(td));
      body.appendChild(tr);

      // contar totales
      if((p.result||"")==="Ganó") won++;
      else if((p.result||"")==="Push") push++;
      else if((p.result||"")==="Perdió") lost++;
    });

    // Totales
    $("#count").textContent = view.length;
    $("#won").textContent = won;
    $("#push").textContent = push;
    $("#lost").textContent = lost;
  }

  function cell(txt){
    const td = document.createElement("td");
    td.textContent = txt;
    return td;
  }
  function cellRight(txt){
    const td = document.createElement("td");
    td.className = "right";
    td.textContent = txt;
    return td;
  }
  function num(x){ const n = Number(x); return isFinite(n)?n:NaN; }

  function indexInGlobal(p){
    // Buscamos por timestamp+market+label como identificador razonable
    const key = (p.timestamp||"") + "||" + (p.market||"") + "||" + (p.label||"");
    return picks.findIndex(z => ((z.timestamp||"")+"||"+(z.market||"")+"||"+(z.label||"")) === key);
  }

  function escapeCSV(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }
  function download(filename, content, mime){
    const blob = new Blob([content], {type:mime||"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function countTotals(){
    // Recalcula contadores sin re-render completo
    const flg = $("#fLeague").value;
    const list = flg ? picks.filter(p => (p.league||"")===flg) : picks;
    let won=0, push=0, lost=0;
    list.forEach(p=>{
      if((p.result||"")==="Ganó") won++;
      else if((p.result||"")==="Push") push++;
      else if((p.result||"")==="Perdió") lost++;
    });
    $("#count").textContent = list.length;
    $("#won").textContent = won;
    $("#push").textContent = push;
    $("#lost").textContent = lost;
  }

})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Apuestas Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0e0e0e;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #1b1b1b;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0,0,0,0.7);
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #ffffff;
      font-weight: 600;
    }
    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .filtros input,
    .filtros button {
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #2a2a2a;
      color: #f0f0f0;
      transition: 0.3s;
    }
    .filtros input:focus {
      outline: none;
      border-color: #3e8ef7;
    }
    .filtros button {
      cursor: pointer;
      font-weight: 600;
    }
    .filtros button:hover {
      background-color: #3a3a3a;
    }
    .table-wrapper {
      overflow-y: auto;
      border-radius: 10px;
      max-height: 900px;
      position: relative;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 800px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #202020;
      z-index: 2;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #202020;
      cursor: pointer;
      user-select: none;
    }
    tr:hover td {
      background-color: #2a2a2a;
    }
    tr.ganado td { background-color: rgba(76, 175, 80, 0.15); }
    tr.perdido td { background-color: rgba(229, 57, 53, 0.15); }
    tr.push td { background-color: rgba(33, 150, 243, 0.15); }

    select {
      background: #2c2c2c;
      color: #f0f0f0;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 4px;
      min-width: 80px;
      font-weight: bold;
      transition: 0.3s;
    }
    select.ganado { border-color: #4CAF50; color: #4CAF50; }
    select.perdido { border-color: #E53935; color: #E53935; }
    select.push { border-color: #2196F3; color: #2196F3; }

    button {
      padding: 10px 15px;
      margin: 10px 5px;
      font-size: 14px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { background-color: #444; }
    .btn-borrar { background-color: #b32e2e; padding: 5px 8px; font-size: 12px; }
    .btn-borrar:hover { background-color: #e03c3c; }
    .btn-exportar { background-color: #3e8ef7; }
    .btn-exportar:hover { background-color: #5aa2f9; }

    #resumenROI { margin-top: 20px; font-size: 16px; text-align: center; }
    #resumenROI .positivo { color: #4CAF50; }
    #resumenROI .negativo { color: #E53935; }

    #notificacion {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #323232;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
      z-index: 999;
    }
    #notificacion.visible { opacity: 1; }

    /* Botón ir arriba */
    #btnIrArriba {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background-color: #3e8ef7;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: opacity 0.4s ease;
    }
    #btnIrArriba.visible { opacity: 1; pointer-events: auto; }
    #btnIrArriba:hover { background-color: #5aa2f9; }

    #graficaUnidades {
      margin-top: 40px;
      background: #202020;
      padding: 20px;
      border-radius: 12px;
    }

    #configBankroll {
      text-align: center;
      margin-bottom: 20px;
    }
    #configBankroll input {
      width: 120px;
      font-size: 14px;
      padding: 6px;
      text-align: center;
      margin-left: 10px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #2a2a2a;
      color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><i class="fas fa-chart-line"></i> Historial de Apuestas</h2>

    <div id="configBankroll">
      <label>Bankroll Inicial: $</label>
      <input type="number" id="bankrollInicialInput" min="0" step="0.01">
      <button onclick="actualizarBankroll()">Actualizar</button>
    </div>

    <div class="filtros">
      <input type="text" id="filtroGrupo" placeholder="Filtrar por Grupo" />
      <input type="text" id="filtroLocal" placeholder="Filtrar por Local" />
      <input type="text" id="filtroVisita" placeholder="Filtrar por Visitante" />
      <input type="number" id="filtroProb" placeholder="Prob. mínima (%)" step="0.01" min="0" />
      <button id="btnLimpiarFiltros"><i class="fas fa-eraser"></i> Limpiar</button>
      <button id="btnExportar" class="btn-exportar"><i class="fas fa-file-export"></i> Exportar CSV</button>
    </div>

    <div>
      <button onclick="volver()"><i class="fas fa-arrow-left"></i> Volver</button>
      <button id="btnGuardar"><i class="fas fa-save"></i> Guardar</button>
      <button id="btnBorrarTodo" style="background-color:#b32e2e;">
        <i class="fas fa-trash"></i> Borrar todo
      </button>
    </div>

    <div class="table-wrapper">
      <table id="tablaHistorial">
        <thead>
          <tr>
            <th>Grupo</th>
            <th>Opción</th>
            <th>Prob (%)</th>
            <th>Cuota</th>
            <th>EV</th>
            <th>Kelly (%)</th>
            <th>Apostar ($)</th>
            <th>Local</th>
            <th>Visitante</th>
            <th>Resultado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="btnIrArriba" title="Ir arriba"><i class="fas fa-arrow-up"></i></button>
    </div>

    <div id="resumenROI"></div>

    <div id="graficaUnidades">
      <h3 style="text-align:center; margin-bottom:15px;">Unidades Acumuladas</h3>
      <canvas id="unidadesChart" height="120"></canvas>
    </div>
  </div>

  <div id="notificacion">Cambios guardados ✅</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /* =====================
       Variables globales
    ===================== */
    let historial = [];
    let unidadesChart = null;
    let bankrollInicial = parseFloat(localStorage.getItem("bankrollInicial")) || 1000;

    /* =====================
       Funciones de almacenamiento
    ===================== */
    function guardarHistorial() {
      localStorage.setItem("poissonHistorial", JSON.stringify(historial));
    }

    function cargarHistorial() {
      document.getElementById("bankrollInicialInput").value = bankrollInicial;
      try {
        historial = JSON.parse(localStorage.getItem("poissonHistorial")) || [];
      } catch {
        historial = [];
        localStorage.removeItem("poissonHistorial");
      }
      filtrarHistorial();
      actualizarResumen(historial);
      actualizarGrafica(historial);
    }

    function actualizarBankroll() {
      const val = parseFloat(document.getElementById("bankrollInicialInput").value);
      if (!isNaN(val) && val >= 0) {
        bankrollInicial = val;
        localStorage.setItem("bankrollInicial", bankrollInicial);
        actualizarResumen(historial);
        actualizarGrafica(historial);
        mostrarNotificacion();
      }
    }

    /* =====================
       Filtros
    ===================== */
    function getDatosFiltrados() {
      const grupo = document.getElementById("filtroGrupo").value.toLowerCase();
      const local = document.getElementById("filtroLocal").value.toLowerCase();
      const visita = document.getElementById("filtroVisita").value.toLowerCase();
      const probMin = parseFloat(document.getElementById("filtroProb").value)||0;

      return historial.filter(row => {
        return (row[0]||"").toLowerCase().includes(grupo) &&
               (row[7]||"").toLowerCase().includes(local) &&
               (row[8]||"").toLowerCase().includes(visita) &&
               (parseFloat(row[2])||0) >= probMin;
      });
    }

    function filtrarHistorial() {
      renderizarTabla(getDatosFiltrados());
    }

    ["filtroGrupo","filtroLocal","filtroVisita","filtroProb"].forEach(id=>{
      document.getElementById(id).addEventListener("input", filtrarHistorial);
    });

    document.getElementById("btnLimpiarFiltros").addEventListener("click", ()=>{
      document.querySelectorAll(".filtros input").forEach(inp=>inp.value="");
      filtrarHistorial();
    });

    /* =====================
       Renderizado de tabla
    ===================== */
    function renderizarTabla(datosFiltrados) {
      const tbody = document.querySelector("#tablaHistorial tbody");
      tbody.innerHTML = "";

      datosFiltrados.forEach((row, index) => {
        const i = historial.indexOf(row);
        const tr = document.createElement("tr");
        if (row[9]==="ganado" || row[9]==="medio_ganado") tr.classList.add("ganado");
        else if (row[9]==="perdido" || row[9]==="medio_perdido") tr.classList.add("perdido");
        else if (row[9]==="push") tr.classList.add("push");

        for (let j = 0; j < 9; j++) {
          const td = document.createElement("td");
          td.textContent = row[j];
          tr.appendChild(td);
        }

        const selectTd = document.createElement("td");
        const select = document.createElement("select");
        select.dataset.id = i;
        select.innerHTML = `
          <option value="">--</option>
          <option value="ganado">Ganado</option>
          <option value="medio_ganado">Medio Ganado</option>
          <option value="push">Push / Nulo</option>
          <option value="medio_perdido">Medio Perdido</option>
          <option value="perdido">Perdido</option>
        `;
        select.value = row[9] || "";
        actualizarClaseSelect(select);
        select.addEventListener("change", e=>{
          historial[i][9] = e.target.value;
          actualizarClaseSelect(select);
          guardarHistorial();
          actualizarResumen(historial);
          actualizarGrafica(historial);
          mostrarNotificacion();
          filtrarHistorial();
        });
        selectTd.appendChild(select);
        tr.appendChild(selectTd);

        const btnTd = document.createElement("td");
        const btn = document.createElement("button");
        btn.innerHTML = `<i class="fas fa-trash"></i>`;
        btn.classList.add("btn-borrar");
        btn.addEventListener("click", ()=>{
          if(confirm("¿Seguro que deseas borrar esta apuesta?")) {
            historial.splice(i,1);
            guardarHistorial();
            actualizarResumen(historial);
            actualizarGrafica(historial);
            filtrarHistorial();
          }
        });
        btnTd.appendChild(btn);
        tr.appendChild(btnTd);

        tbody.appendChild(tr);
      });
    }

    function actualizarClaseSelect(select) {
      select.classList.remove("ganado","perdido","push");
      if(select.value==="ganado" || select.value==="medio_ganado") select.classList.add("ganado");
      else if(select.value==="perdido" || select.value==="medio_perdido") select.classList.add("perdido");
      else if(select.value==="push") select.classList.add("push");
    }

    /* =====================
       Resumen y gráfica
    ===================== */
    function actualizarResumen(datos) {
      let gananciaNeta = 0, totalInvertido = 0, ganadas=0, perdidas=0;

      datos.forEach(row=>{
        const resultado = row[9];
        const stake = parseFloat(row[6])||0;
        const cuota = parseFloat(row[3])||0;
        if(stake<=0 || !resultado) return;

        switch(resultado){
          case "ganado": gananciaNeta += stake*(cuota-1); ganadas++; break;
          case "medio_ganado": gananciaNeta += stake*(cuota-1)/2; ganadas+=0.5; break;
          case "medio_perdido": gananciaNeta -= stake/2; perdidas+=0.5; break;
          case "perdido": gananciaNeta -= stake; perdidas++; break;
        }
        totalInvertido += stake;
      });

      const roi = totalInvertido>0 ? (gananciaNeta/totalInvertido)*100 : 0;
      const bankrollFinal = bankrollInicial + gananciaNeta;
      const color = roi>=0 ? "positivo":"negativo";

      document.getElementById("resumenROI").innerHTML = `
        <p>
          <strong>Bankroll Inicial:</strong> $${bankrollInicial.toFixed(2)} &nbsp; | &nbsp;
          <strong>Bankroll Actual:</strong> $${bankrollFinal.toFixed(2)} <br/>
          <strong>ROI:</strong> <span class="${color}">${roi.toFixed(2)}%</span> &nbsp; | &nbsp;
          <strong>Ganancia Neta:</strong> $${gananciaNeta.toFixed(2)} <br/>
          <strong>Apuestas Ganadas:</strong> ${ganadas} &nbsp; | &nbsp;
          <strong>Apuestas Perdidas:</strong> ${perdidas} &nbsp; | &nbsp;
          <strong>Total Apostado:</strong> $${totalInvertido.toFixed(2)}
        </p>
      `;
    }

    function actualizarGrafica(datos) {
      let acumulado = bankrollInicial;
      const unidades = [acumulado.toFixed(2)];
      const labels = ["Inicio"];

      datos.forEach((row, i)=>{
        const stake = parseFloat(row[6])||0;
        const cuota = parseFloat(row[3])||0;
        let cambio = 0;
        switch(row[9]){
          case "ganado": cambio = stake*(cuota-1); break;
          case "medio_ganado": cambio = stake*(cuota-1)/2; break;
          case "medio_perdido": cambio = -stake/2; break;
          case "perdido": cambio = -stake; break;
        }
        if(cambio!==0){ 
          acumulado += cambio;
          unidades.push(acumulado.toFixed(2));
          labels.push(`Apuesta ${i+1}`);
        }
      });

      const ctx = document.getElementById("unidadesChart").getContext("2d");
      if(unidadesChart) unidadesChart.destroy();
      unidadesChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Evolución Bankroll",
            data: unidades,
            borderColor: "#3e8ef7",
            backgroundColor: "rgba(62,142,247,0.2)",
            borderWidth: 2,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: "#fff"
          }]
        },
        options: {
          responsive: true,
          plugins: { legend:{display:true}, tooltip:{mode:"index",intersect:false} },
          interaction:{mode:"nearest",axis:"x",intersect:false},
          scales:{ x:{ grid:{color:"#333"} }, y:{ grid:{color:"#333"} } }
        }
      });
    }

    /* =====================
       Exportar CSV
    ===================== */
    document.getElementById("btnExportar").addEventListener("click", ()=>{
      const filtrado = getDatosFiltrados();
      let csv = "Grupo,Opción,Prob,Cuota,EV,Kelly,Apostar,Local,Visitante,Resultado\n";
      filtrado.forEach(row=>{
        csv += row.join(",") + "\n";
      });
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "historial_apuestas.csv"; a.click();
      URL.revokeObjectURL(url);
    });

    /* =====================
       Scroll top button
    ===================== */
    const btnIrArriba = document.getElementById("btnIrArriba");
    document.querySelector(".table-wrapper").addEventListener("scroll", e=>{
      btnIrArriba.classList.toggle("visible", e.target.scrollTop > 100);
    });
    btnIrArriba.addEventListener("click", ()=>{
      document.querySelector(".table-wrapper").scrollTo({top:0, behavior:"smooth"});
    });

    /* =====================
       Notificación
    ===================== */
    function mostrarNotificacion() {
      const noti = document.getElementById("notificacion");
      noti.classList.add("visible");
      setTimeout(()=>{ noti.classList.remove("visible"); },2000);
    }

    /* =====================
       Botones principales
    ===================== */
    function volver() {
      window.history.back();
    }

    document.getElementById("btnGuardar").addEventListener("click", ()=>{
      guardarHistorial(); 
      mostrarNotificacion();
    });

    document.getElementById("btnBorrarTodo").addEventListener("click", ()=>{
      if(confirm("¿Seguro que deseas borrar TODO el historial?")) {
        historial = [];
        guardarHistorial();
        filtrarHistorial();
        actualizarResumen(historial);
        actualizarGrafica(historial);
      }
    });

    /* =====================
       Inicialización
    ===================== */
    window.addEventListener("DOMContentLoaded", cargarHistorial);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Picks — OU/BTTS/1X2</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --panel2:#1f2430; --text:#e8ecf3; --muted:#9aa3b2;
    --accent:#7aa2ff; --accent2:#5dd4a4; --warn:#ffb84d; --danger:#ff6b6b; --ok:#79e2a6; --border:#2a3140;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,#0f1115 0%,#121622 100%); color:var(--text)
  }
  header{
    padding:20px 16px; border-bottom:1px solid var(--border); background:#10141d;
    position:sticky; top:0; z-index:5
  }
  h1{margin:0; font-size:18px; letter-spacing:.3px}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px}
  .muted{color:var(--muted)}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .right{text-align:right}
  .sep{height:1px; background:var(--border); margin:12px 0}
  .tiny{font-size:11px}

  /* Controles */
  select,input{
    background:var(--panel2); color:var(--text); border:1px solid var(--border);
    border-radius:8px; padding:8px; font-size:14px
  }
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid var(--border); background:#111827; color:var(--text);
    padding:10px 12px; border-radius:10px; cursor:pointer; text-decoration:none; font-size:14px
  }
  .btn.primary{background:linear-gradient(90deg,#2647ff,#1fa37e); border-color:transparent}
  .pill{
    padding:6px 10px; border-radius:999px; border:1px solid var(--border);
    background:rgba(255,255,255,.03)
  }
  .ok{color:var(--accent2)} .warn{color:var(--warn)} .bad{color:var(--danger)}

  /* Tabla */
  table{width:100%; border-collapse:separate; border-spacing:0}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle}
  th{
    color:var(--muted); font-weight:600; font-size:12px;
    position:sticky; top:0; background:var(--panel); z-index:1
  }
  .table-wrap{
    overflow:auto; max-height:70vh; border:1px solid var(--border);
    border-radius:10px; -webkit-overflow-scrolling:touch
  }

  /* —— Ajustes móviles —— */
  @media(max-width:768px){
    .wrap{padding:12px}
    .btn{padding:8px 10px; font-size:14px}
    select,input{padding:8px; font-size:14px}
  }
  @media(max-width:430px){
    header{padding:12px}
    h1{font-size:16px}
    .wrap{padding:10px}
    .card{padding:12px}
    .btn{padding:8px 10px; font-size:13px}
    select,input{padding:8px; font-size:13px}
    th,td{padding:8px 10px}
    th:nth-child(7), td:nth-child(7){white-space:nowrap}  /* Prob. Modelo */
    th:nth-child(9), td:nth-child(9){white-space:nowrap}  /* Overround */
    th:nth-child(11), td:nth-child(11){white-space:nowrap}/* Stake Kelly */
    th:nth-child(13), td:nth-child(13){white-space:nowrap}/* P/L */
  }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex" style="justify-content:space-between">
        <h1>Historial de Picks</h1>
        <div class="flex">
          <button id="btnExport" class="btn">Exportar CSV</button>
          <button id="btnClear" class="btn">Borrar todo</button>
          <a href="./" class="btn primary">← Volver</a>
        </div>
      </div>
      <div class="tiny muted" style="margin-top:6px">
        Los picks se cargan desde <code>localStorage["picks"]</code>.
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="flex" style="justify-content:space-between; gap:10px; flex-wrap:wrap">
        <div class="flex" style="gap:10px; flex-wrap:wrap">
          <span class="pill">Total registros: <b id="count">0</b></span>
          <span class="pill">Ganados: <b id="won">0</b></span>
          <span class="pill">Push: <b id="push">0</b></span>
          <span class="pill">Perdidos: <b id="lost">0</b></span>
          <span class="pill">Total apostado: <b id="staked">$0.00</b></span>
          <span class="pill">Ganancia neta: <b id="profit">$0.00</b></span>
          <span class="pill">ROI: <b id="roi">0.00%</b></span>
        </div>

        <!-- Filtros -->
        <div class="flex" style="gap:10px">
          <div class="flex" style="gap:6px; align-items:center">
            <label class="tiny muted" for="fLeague">Liga</label>
            <select id="fLeague" aria-label="Filtrar por liga"></select>
          </div>
          <div class="flex" style="gap:6px; align-items:center">
            <label class="tiny muted" for="fMarket">Mercado</label>
            <select id="fMarket" aria-label="Filtrar por mercado"></select>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="table-wrap">
        <table id="tbl" role="table" aria-label="Historial de picks">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Liga</th>
              <th>Local</th>
              <th>Visita</th>
              <th>Mercado</th>
              <th>Detalle</th>
              <th class="right">Prob. Modelo</th>
              <th class="right">Cuota</th>
              <th class="right">Overround</th>
              <th class="right">EV</th>
              <th class="right">Stake Kelly</th>
              <th>Resultado</th>
              <th class="right">P/L</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="body"><!-- filas --></tbody>
        </table>
      </div>

      <div class="tiny muted" style="margin-top:8px">
        <b>Nota:</b> Stake Kelly usa lo guardado por el generador (si existe
        <code>stake_suggested_abs/frac</code>). Si no, se calcula como Kelly ¼ con
        límites <b>1%–3%</b> del bankroll y solo si <b>EV &gt; 0</b>.
        P/L por pick: <i>Ganó</i> ⇒ <code>stake × (odd − 1)</code>; <i>Perdió</i> ⇒ <code>−stake</code>; <i>Push</i> ⇒ <code>0</code>.
      </div>
    </section>
  </div>

<script>
(() => {
  "use strict";
  const $ = s => document.querySelector(s);
  const fmtPct = x => isFinite(x) ? (100*x).toFixed(2)+"%" : "—";
  const fmtMoney = x => isFinite(x) ? x.toFixed(2) : "—";
  const asMoney = x => "$" + fmtMoney(Number(x)||0);

  // ====== Límites de stake (compat con la app principal) ======
  const STAKE_MIN = 0.01; // 1%
  const STAKE_MAX = 0.03; // 3%

  // ====== Compat: mapear códigos de mercado a familia legible ======
  function marketFamily(mk){
    switch((mk||"").toUpperCase()){
      case "OU_OVER":
      case "OU_UNDER":
      case "OU":          return "Over/Under";
      case "BTTS_YES":
      case "BTTS_NO":
      case "BTTS":
      case "GG/NG":       return "BTTS";
      case "1X2":
      case "HT 1X2":      return mk; // se muestran tal cual
      default:            return mk || ""; // corners/tarjetas/etc. o nombres ya legibles
    }
  }

  // ====== Compat: Kelly 1/4 básico ======
  function kellyQuarterFromProbOdd(p, odd){
    const o = Number(odd);
    const pr = Number(p);
    if(!(isFinite(o) && o>1 && isFinite(pr) && pr>=0 && pr<=1)) return NaN;
    const f = (pr*o - 1) / (o - 1);
    return Math.max(0, f/4);
  }

  function evFromProbOdd(p, odd){
    const o = Number(odd);
    const pr = Number(p);
    if(!(isFinite(o) && o>1 && isFinite(pr))) return NaN;
    return pr*o - 1;
  }

  function parseISO(s){
    const t = Date.parse(s||"");
    return isFinite(t) ? t : 0;
  }

  let picks = loadPicks();
  // Ordenar más recientes primero
  picks.sort((a,b)=> parseISO(b.timestamp) - parseISO(a.timestamp));
  let view = [...picks];

  // Inicialización UI
  populateLeagueFilter();
  populateMarketFilter();
  render();

  // Eventos de filtros
  $("#fLeague").addEventListener("change", () => {
    view = computeView();
    render();
  });
  $("#fMarket").addEventListener("change", () => {
    view = computeView();
    render();
  });

  // Botones
  $("#btnClear").addEventListener("click", () => {
    if(!confirm("¿Seguro que deseas borrar TODOS los picks guardados?")) return;
    localStorage.removeItem("picks");
    picks = [];
    view = [];
    populateLeagueFilter();
    populateMarketFilter();
    render();
  });

  $("#btnExport").addEventListener("click", () => {
    const rows = [["Fecha","Liga","Local","Visita","Mercado","Detalle","ProbModelo","Cuota","Overround","EV","StakeKelly","Resultado","PL"]];
    for(const p of view){
      const stakeAmt = stakeKellyAmount(p);
      rows.push([
        p.timestamp || "",
        p.league || "",
        p.home || "",
        p.away || "",
        marketFamily(p.market),
        p.label || "",
        num(p.prob).toFixed(4),
        num(p.odd).toFixed(2),
        num(p.overround).toFixed(4),
        num(p.ev).toFixed(4),
        isFinite(stakeAmt) ? stakeAmt.toFixed(2) : "",
        (p.result||""),
        isFinite(pickPL(p)) ? pickPL(p).toFixed(2) : ""
      ]);
    }
    const csv = rows.map(r=>r.map(escapeCSV).join(",")).join("\n");
    download("historial_picks.csv", csv, "text/csv;charset=utf-8");
  });

  // ==== Carga/guardado ====
  function loadPicks(){
    try{
      const arr = JSON.parse(localStorage.getItem("picks") || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function savePicks(){ localStorage.setItem("picks", JSON.stringify(picks)); }

  // ==== Num utils ====
  function num(x){ const n = Number(x); return isFinite(n)?n:NaN; }

  // ==== Compatibilidad de stake con límites 1%–3% y EV>0 ====
  // Devuelve { frac, amount } usando prioridad:
  // 1) p.stake_suggested_frac / p.stake_suggested_abs si existen (ya vienen cappeados).
  // 2) Si no existen: calcula Kelly 1/4 y aplica límites [1%, 3%] solo si EV>0; en caso contrario 0.
  function stakeCompat(p){
    const bk = Number(p.bankroll||0);
    // usar guardados si existen
    const fracSaved = num(p.stake_suggested_frac);
    const amtSaved  = num(p.stake_suggested_abs);
    if(isFinite(fracSaved) && fracSaved>0 && isFinite(bk) && bk>=0){
      const amount = isFinite(amtSaved) && amtSaved>0 ? amtSaved : bk * fracSaved;
      return { frac: fracSaved, amount: amount };
    }
    // compat picks viejos: recalcular
    const o = num(p.odd);
    const pr = num(p.prob);
    const ev = evFromProbOdd(pr, o);
    if(!(isFinite(bk) && bk>=0) || !(isFinite(o) && o>1) || !(isFinite(pr)) || !isFinite(ev)){
      return { frac: NaN, amount: NaN };
    }
    if(ev <= 0){
      return { frac: 0, amount: 0 };
    }
    const base = kellyQuarterFromProbOdd(pr, o);
    if(!isFinite(base)) return { frac: NaN, amount: NaN };
    const bounded = Math.min(STAKE_MAX, Math.max(STAKE_MIN, base));
    return { frac: bounded, amount: bk * bounded };
  }

  function stakeKellyAmount(p){
    const { amount } = stakeCompat(p);
    return isFinite(amount) ? amount : NaN;
  }

  function pickPL(p){
    const stake = stakeKellyAmount(p);
    const odd = Number(p.odd||0);
    if(!isFinite(stake) || !isFinite(odd) || odd<=1) return NaN;
    const r = p.result || "";
    if(r === "Ganó") return stake * (odd - 1);
    if(r === "Perdió") return -stake;
    if(r === "Push") return 0;
    return NaN; // sin calificar
  }

  function computeView(){
    const lg = $("#fLeague").value;
    const mk = $("#fMarket").value;
    return picks.filter(p=>{
      const okLg = lg ? (p.league||"") === lg : true;
      const fam = marketFamily(p.market);
      const okMk = mk ? fam === mk : true;
      return okLg && okMk;
    });
  }

  function uniqueSorted(arr){
    return [...new Set(arr)].sort((a,b)=> String(a).localeCompare(String(b)));
  }

  function populateLeagueFilter(){
    const sel = $("#fLeague");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "Todas las ligas";
    sel.appendChild(opt0);
    uniqueSorted(picks.map(p=>p.league||"").filter(Boolean)).forEach(lg=>{
      const o = document.createElement("option");
      o.value = lg; o.textContent = lg;
      sel.appendChild(o);
    });
  }

  function populateMarketFilter(){
    const sel = $("#fMarket");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "Todos los mercados";
    sel.appendChild(opt0);

    const fams = picks.map(p=>marketFamily(p.market)).filter(Boolean);
    const preferred = ["1X2","Over/Under","BTTS","Corners","Tarjetas","Shots","HT 1X2","HT OU","HT BTTS"];
    const set = new Set(fams);
    preferred.filter(m=>set.has(m)).forEach(m=>{
      const o = document.createElement("option");
      o.value = o.textContent = m; sel.appendChild(o);
      set.delete(m);
    });
    uniqueSorted([...set]).forEach(m=>{
      const o = document.createElement("option");
      o.value = o.textContent = m; sel.appendChild(o);
    });
  }

  function render(){
    const body = $("#body");
    body.innerHTML = "";

    let won=0, push=0, lost=0;
    let totalStaked=0, totalPL=0;

    view.forEach((p) => {
      const tr = document.createElement("tr");

      const tdFecha = cell(p.timestamp ? p.timestamp.replace("T"," ").slice(0,16) : "");
      const tdLiga  = cell(p.league||"");
      const tdHome  = cell(p.home||"");
      const tdAway  = cell(p.away||"");
      const tdMkt   = cell(marketFamily(p.market));
      const tdLbl   = cell(p.label||"");

      const tdProb  = cellRight(fmtPct(num(p.prob)));
      const tdOdd   = cellRight(isFinite(num(p.odd)) ? Number(p.odd).toFixed(2) : "—");
      const tdOR    = cellRight(isFinite(num(p.overround)) ? (100*Number(p.overround)).toFixed(2)+"%" : "—");

      const tdEV    = document.createElement("td"); tdEV.className="right";
      const evv = num(p.ev);
      tdEV.innerHTML = isFinite(evv) ? `<b class="${evv>=0?'ok':'bad'}">${(100*evv).toFixed(2)}%</b>` : "—";

      const stakeAmt = stakeKellyAmount(p);
      const tdStake = cellRight( isFinite(stakeAmt) ? "$"+fmtMoney(stakeAmt) : "—" );

      const tdRes = document.createElement("td");
      const sel = document.createElement("select");
      ["","Ganó","Push","Perdió"].forEach(v=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = v || "— Selecciona —";
        sel.appendChild(o);
      });
      sel.value = p.result || "";
      sel.addEventListener("change", () => {
        const gi = indexInGlobal(p);
        if(gi !== -1){
          picks[gi].result = sel.value;
          savePicks();
          view = computeView();
          render();
        }
      });
      tdRes.appendChild(sel);

      const tdPL = document.createElement("td"); tdPL.className="right";
      const pl = pickPL(p);
      tdPL.innerHTML = isFinite(pl) ? `<b class="${pl>=0?'ok':'bad'}">${(pl>=0?'+':'')}$${fmtMoney(pl)}</b>` : "—";

      const tdAcc = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Eliminar";
      btn.addEventListener("click", () => {
        if(!confirm("¿Eliminar este pick del historial?")) return;
        const gi = indexInGlobal(p);
        if(gi !== -1){
          picks.splice(gi,1);
          savePicks();
          populateLeagueFilter();
          populateMarketFilter();
          view = computeView();
          render();
        }
      });
      tdAcc.appendChild(btn);

      [tdFecha,tdLiga,tdHome,tdAway,tdMkt,tdLbl,tdProb,tdOdd,tdOR,tdEV,tdStake,tdRes,tdPL,tdAcc].forEach(td=>tr.appendChild(td));
      body.appendChild(tr);

      // contabilidad (solo picks con resultado asignado Ganó/Perdió)
      const hasResult = (p.result||"")==="Ganó" || (p.result||"")==="Perdió";
      if(hasResult && isFinite(stakeAmt)) totalStaked += stakeAmt;
      if((p.result||"")==="Ganó"){ won++; if(isFinite(pl)) totalPL+=pl; }
      else if((p.result||"")==="Push"){ push++; }
      else if((p.result||"")==="Perdió"){ lost++; if(isFinite(pl)) totalPL+=pl; }
    });

    // Totales
    $("#count").textContent = view.length;
    $("#won").textContent = won;
    $("#push").textContent = push;
    $("#lost").textContent = lost;

    // KPIs contables
    $("#staked").textContent = asMoney(totalStaked);
    $("#profit").textContent = (totalPL>=0?'+':'') + asMoney(totalPL);
    const roi = totalStaked>0 ? (100*totalPL/totalStaked) : 0;
    $("#roi").textContent = roi.toFixed(2) + "%";
  }

  function cell(txt){ const td = document.createElement("td"); td.textContent = txt; return td; }
  function cellRight(txt){ const td = document.createElement("td"); td.className = "right"; td.textContent = txt; return td; }

  function indexInGlobal(p){
    const key = (p.timestamp||"") + "||" + (p.market||"") + "||" + (p.label||"");
    return picks.findIndex(z => ((z.timestamp||"")+"||"+(z.market||"")+"||"+(z.label||"")) === key);
  }

  function escapeCSV(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }
  function download(filename, content, mime){
    const blob = new Blob([content], {type:mime||"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

})();
</script>
</body>
</html>

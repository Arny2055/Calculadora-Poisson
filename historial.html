<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Apuestas Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- Estilo base --- */
    body {
      font-family: 'Inter', sans-serif;
      background: #0e0e0e;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: #1b1b1b;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0,0,0,0.7);
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #ffffff;
      font-weight: 600;
    }

    /* --- Filtros --- */
    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .filtros input,
    .filtros button {
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #2a2a2a;
      color: #f0f0f0;
      transition: 0.3s;
    }

    .filtros input:focus {
      outline: none;
      border-color: #3e8ef7;
    }

    .filtros button {
      cursor: pointer;
      font-weight: 600;
    }

    .filtros button:hover {
      background-color: #3a3a3a;
    }

    /* --- Tabla --- */
    .table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 800px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #202020;
      z-index: 1;
    }

    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #202020;
      cursor: pointer;
      user-select: none;
    }

    tr:hover td {
      background-color: #2a2a2a;
    }

    tr.ganado td {
      background-color: rgba(76, 175, 80, 0.15);
    }

    tr.perdido td {
      background-color: rgba(229, 57, 53, 0.15);
    }

    select {
      background: #2c2c2c;
      color: #f0f0f0;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 4px;
      min-width: 80px;
      font-weight: bold;
      transition: 0.3s;
    }

    select.ganado {
      border-color: #4CAF50;
      color: #4CAF50;
    }

    select.perdido {
      border-color: #E53935;
      color: #E53935;
    }

    /* --- Botones --- */
    button {
      padding: 10px 15px;
      margin: 10px 5px;
      font-size: 14px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #444;
    }

    .btn-borrar {
      background-color: #b32e2e;
      padding: 5px 8px;
      font-size: 12px;
    }

    .btn-borrar:hover {
      background-color: #e03c3c;
    }

    .btn-exportar {
      background-color: #3e8ef7;
    }

    .btn-exportar:hover {
      background-color: #5aa2f9;
    }

    /* --- Resumen --- */
    #resumenROI {
      margin-top: 20px;
      font-size: 16px;
      text-align: center;
    }

    #resumenROI .positivo { color: #4CAF50; }
    #resumenROI .negativo { color: #E53935; }

    /* --- Notificación --- */
    #notificacion {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #323232;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
      z-index: 999;
    }

    #notificacion.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><i class="fas fa-chart-line"></i> Historial de Apuestas</h2>

    <div class="filtros">
      <input type="text" id="filtroGrupo" placeholder="Filtrar por Grupo" />
      <input type="text" id="filtroLocal" placeholder="Filtrar por Local" />
      <input type="text" id="filtroVisita" placeholder="Filtrar por Visitante" />
      <input type="number" id="filtroProb" placeholder="Prob. mínima (%)" step="0.01" min="0" />
      <button id="btnLimpiarFiltros"><i class="fas fa-eraser"></i> Limpiar</button>
      <button id="btnExportar" class="btn-exportar"><i class="fas fa-file-export"></i> Exportar CSV</button>
    </div>

    <div>
      <button onclick="volver()"><i class="fas fa-arrow-left"></i> Volver</button>
      <button onclick="guardarResultados()"><i class="fas fa-save"></i> Guardar</button>
      <button onclick="borrarHistorial()" style="background-color:#b32e2e;">
        <i class="fas fa-trash"></i> Borrar todo
      </button>
    </div>

    <div class="table-wrapper">
      <table id="tablaHistorial">
        <thead>
          <tr>
            <th>Grupo</th>
            <th>Opción</th>
            <th>Prob (%)</th>
            <th>Cuota</th>
            <th>EV</th>
            <th>Kelly (%)</th>
            <th>Apostar ($)</th>
            <th>Local</th>
            <th>Visitante</th>
            <th>Resultado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="resumenROI"></div>
  </div>

  <div id="notificacion">Cambios guardados ✅</div>

  <script>
    let historial = [];

    function cargarHistorial() {
      try {
        historial = JSON.parse(localStorage.getItem("poissonHistorial")) || [];
        historial = historial.map(row => {
          while (row.length < 10) row.push("");
          return row;
        });
      } catch(e) {
        alert("Error al cargar historial, se reiniciará.");
        historial = [];
        localStorage.removeItem("poissonHistorial");
      }
      renderizarTabla(historial);
      actualizarResumen(historial);
    }

    function renderizarTabla(datos) {
      const tbody = document.querySelector("#tablaHistorial tbody");
      tbody.innerHTML = "";

      datos.forEach((row, i) => {
        const tr = document.createElement("tr");
        if (row[9] === "ganado") tr.classList.add("ganado");
        if (row[9] === "perdido") tr.classList.add("perdido");

        for (let j = 0; j < 9; j++) {
          const td = document.createElement("td");
          td.textContent = row[j];
          tr.appendChild(td);
        }

        const selectTd = document.createElement("td");
        const select = document.createElement("select");
        select.innerHTML = `
          <option value="">--</option>
          <option value="ganado">Ganado</option>
          <option value="perdido">Perdido</option>
        `;
        select.value = row[9] || "";
        actualizarClaseSelect(select);
        select.addEventListener("change", () => {
          row[9] = select.value;
          historial[i][9] = select.value;
          actualizarClaseSelect(select);
          guardarHistorial();
          renderizarTabla(historial);
          actualizarResumen(historial);
          mostrarNotificacion();
        });
        selectTd.appendChild(select);
        tr.appendChild(selectTd);

        const btnTd = document.createElement("td");
        const btn = document.createElement("button");
        btn.innerHTML = `<i class="fas fa-trash"></i>`;
        btn.classList.add("btn-borrar");
        btn.onclick = () => borrarFila(i);
        btnTd.appendChild(btn);
        tr.appendChild(btnTd);

        tbody.appendChild(tr);
      });
    }

    function actualizarClaseSelect(select) {
      select.classList.remove("ganado", "perdido");
      if (select.value === "ganado") select.classList.add("ganado");
      else if (select.value === "perdido") select.classList.add("perdido");
    }

    function guardarHistorial() {
      localStorage.setItem("poissonHistorial", JSON.stringify(historial));
    }

    function borrarFila(index) {
      if (confirm("¿Seguro que deseas borrar esta apuesta?")) {
        historial.splice(index, 1);
        guardarHistorial();
        renderizarTabla(historial);
        actualizarResumen(historial);
        mostrarNotificacion();
      }
    }

    function filtrarHistorial() {
      const grupo = document.getElementById("filtroGrupo").value.toLowerCase();
      const local = document.getElementById("filtroLocal").value.toLowerCase();
      const visita = document.getElementById("filtroVisita").value.toLowerCase();
      const probMin = parseFloat(document.getElementById("filtroProb").value);

      const filtrado = historial.filter(row => {
        const prob = parseFloat(row[2]);
        const cumpleGrupo = !grupo || row[0].toLowerCase().includes(grupo);
        const cumpleLocal = !local || row[7].toLowerCase().includes(local);
        const cumpleVisita = !visita || row[8].toLowerCase().includes(visita);
        const cumpleProb = isNaN(probMin) || prob >= probMin;
        return cumpleGrupo && cumpleLocal && cumpleVisita && cumpleProb;
      });

      renderizarTabla(filtrado);
      actualizarResumen(filtrado);
    }

    function actualizarResumen(datos) {
      let gananciaNeta = 0;
      let totalInvertido = 0;
      let apuestasGanadas = 0;
      let apuestasPerdidas = 0;

      datos.forEach(row => {
        const resultado = row[9];
        const stake = parseFloat(row[6]) || 0;
        const cuota = parseFloat(row[3]) || 0;

        if (stake <= 0) return;

        if (resultado === "ganado") {
          gananciaNeta += stake * (cuota - 1);
          apuestasGanadas++;
        } else if (resultado === "perdido") {
          gananciaNeta -= stake;
          apuestasPerdidas++;
        }
        totalInvertido += stake;
      });

      const roi = totalInvertido > 0 ? (gananciaNeta / totalInvertido) * 100 : 0;
      const color = roi >= 0 ? "positivo" : "negativo";

      document.getElementById("resumenROI").innerHTML = `
        <p>
          <strong>ROI:</strong> <span class="${color}">${roi.toFixed(2)}%</span> &nbsp; | &nbsp;
          <strong>Ganancia Neta:</strong> $${gananciaNeta.toFixed(2)} &nbsp; | &nbsp;
          <strong>Total Apostado:</strong> $${totalInvertido.toFixed(2)} <br/>
          <strong>Apuestas Ganadas:</strong> ${apuestasGanadas} &nbsp; | &nbsp;
          <strong>Apuestas Perdidas:</strong> ${apuestasPerdidas}
        </p>
      `;
    }

    function guardarResultados() {
      alert("Los resultados se guardan automáticamente al modificar.");
    }

    function volver() {
      window.location.href = "index.html";
    }

    function borrarHistorial() {
      if (confirm("¿Seguro quieres borrar todo el historial?")) {
        historial = [];
        guardarHistorial();
        renderizarTabla(historial);
        actualizarResumen(historial);
        mostrarNotificacion();
      }
    }

    function mostrarNotificacion() {
      const notif = document.getElementById("notificacion");
      notif.classList.add("visible");
      setTimeout(() => notif.classList.remove("visible"), 2000);
    }

    function exportarCSV() {
      const csvContent = historial.map(row => row.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "historial_apuestas.csv";
      link.click();
    }

    window.onload = () => {
      cargarHistorial();
      document.getElementById("filtroGrupo").addEventListener("input", filtrarHistorial);
      document.getElementById("filtroLocal").addEventListener("input", filtrarHistorial);
      document.getElementById("filtroVisita").addEventListener("input", filtrarHistorial);
      document.getElementById("filtroProb").addEventListener("input", filtrarHistorial);
      document.getElementById("btnLimpiarFiltros").addEventListener("click", () => {
        document.querySelectorAll(".filtros input").forEach(inp => inp.value = "");
        renderizarTabla(historial);
        actualizarResumen(historial);
      });
      document.getElementById("btnExportar").addEventListener("click", exportarCSV);
    };
  </script>
</body>
</html>